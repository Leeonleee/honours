{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 22863,
  "instance_id": "ClickHouse__ClickHouse-22863",
  "issue_numbers": [
    "22631"
  ],
  "base_commit": "480553b4a983c86bf1cadac6604e7bc9c37e20d7",
  "patch": "diff --git a/src/Processors/Formats/Impl/TabSeparatedRowInputFormat.cpp b/src/Processors/Formats/Impl/TabSeparatedRowInputFormat.cpp\nindex 41adb6fc612f..f89b76342a41 100644\n--- a/src/Processors/Formats/Impl/TabSeparatedRowInputFormat.cpp\n+++ b/src/Processors/Formats/Impl/TabSeparatedRowInputFormat.cpp\n@@ -7,6 +7,7 @@\n #include <Formats/verbosePrintString.h>\n #include <Formats/FormatFactory.h>\n #include <DataTypes/DataTypeNothing.h>\n+#include <DataTypes/DataTypeLowCardinality.h>\n #include <DataTypes/Serializations/SerializationNullable.h>\n \n namespace DB\n@@ -338,8 +339,10 @@ void TabSeparatedRowInputFormat::tryDeserializeField(const DataTypePtr & type, I\n     const auto & index = column_mapping->column_indexes_for_input_fields[file_column];\n     if (index)\n     {\n+        bool can_be_parsed_as_null = removeLowCardinality(type)->isNullable();\n+\n         // check null value for type is not nullable. don't cross buffer bound for simplicity, so maybe missing some case\n-        if (!type->isNullable() && !in.eof())\n+        if (!can_be_parsed_as_null && !in.eof())\n         {\n             if (*in.position() == '\\\\' && in.available() >= 2)\n             {\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01801_nullable_low_cardinality_tsv.reference b/tests/queries/0_stateless/01801_nullable_low_cardinality_tsv.reference\nnew file mode 100644\nindex 000000000000..573541ac9702\n--- /dev/null\n+++ b/tests/queries/0_stateless/01801_nullable_low_cardinality_tsv.reference\n@@ -0,0 +1,1 @@\n+0\ndiff --git a/tests/queries/0_stateless/01801_nullable_low_cardinality_tsv.sh b/tests/queries/0_stateless/01801_nullable_low_cardinality_tsv.sh\nnew file mode 100755\nindex 000000000000..935bfe18cfc5\n--- /dev/null\n+++ b/tests/queries/0_stateless/01801_nullable_low_cardinality_tsv.sh\n@@ -0,0 +1,22 @@\n+#!/usr/bin/env bash\n+\n+CUR_DIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CUR_DIR\"/../shell_config.sh\n+\n+$CLICKHOUSE_CLIENT --query=\"DROP TABLE IF EXISTS nullable_low_cardinality_tsv_test;\";\n+$CLICKHOUSE_CLIENT --multiquery --query=\"CREATE TABLE nullable_low_cardinality_tsv_test\n+(\n+    A Date,\n+    S LowCardinality(Nullable(String)),\n+    X Int32,\n+    S1 LowCardinality(Nullable(String)),\n+    S2 Array(String)\n+) ENGINE=TinyLog\";\n+\n+printf '2020-01-01\\t\\N\\t32\\t\\N\\n' | $CLICKHOUSE_CLIENT -q 'insert into nullable_low_cardinality_tsv_test format TSV' 2>&1 \\\n+    | grep -q \"Code: 27\"\n+\n+echo $?;\n+\n+$CLICKHOUSE_CLIENT --query=\"DROP TABLE nullable_low_cardinality_tsv_test\";\n",
  "problem_statement": "TSV parser reports the incorrect error.\n```\r\nCREATE TABLE testTSV\r\n(\r\n    A Date,\r\n    S LowCardinality(Nullable(String)),\r\n    X Int32,\r\n    S1 LowCardinality(Nullable(String)),\r\n    S2 Array(String)\r\n)\r\nENGINE = Memory;\r\n\r\nprintf '2020-01-01\\t\\N\\t32\\t\\N\\n'|clickhouse-client -q 'insert into testTSV format TSV'\r\n\r\n DB::Exception: Unexpected NULL value of not Nullable type LowCardinality(Nullable(String)) (version 20.12.8.5 (official build))\r\n```\r\n\r\nBut the real error is a missing column in the input stream, because I passed 4 columns instead of 5\r\n```\r\nprintf '2020-01-01\\t\\N\\t32\\t\\N\\t[]\\n'|clickhouse-client -q 'insert into testTSV format TSV'\r\nok\r\n```\n",
  "hints_text": "If I remove LowCardinality\r\n\r\n```\r\nCREATE TABLE testTSV\r\n(\r\n    A Date,\r\n    S Nullable(String),\r\n    X Int32,\r\n    S1 Nullable(String),\r\n    S2 Array(String)\r\n)\r\nENGINE = Memory;\r\n\r\n\r\nprintf '2020-01-01\\t\\N\\t32\\t\\N\\n'|clickhouse-client -q 'insert into testTSV format TSV'\r\n\r\nERROR: Line feed found where tab is expected. It's like your file has less columns than expected.\r\nAnd if your file have right number of columns, maybe it have unescaped backslash in value before tab, \r\nwhich cause tab has escaped.\r\n```",
  "created_at": "2021-04-08T17:13:27Z",
  "modified_files": [
    "src/Processors/Formats/Impl/TabSeparatedRowInputFormat.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01801_nullable_low_cardinality_tsv.reference",
    "b/tests/queries/0_stateless/01801_nullable_low_cardinality_tsv.sh"
  ]
}