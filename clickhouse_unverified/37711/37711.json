{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 37711,
  "instance_id": "ClickHouse__ClickHouse-37711",
  "issue_numbers": [
    "35897"
  ],
  "base_commit": "6c2db00f1f7d65cbe605a6edcf0a6271e32bc52e",
  "patch": "diff --git a/src/Interpreters/UserDefinedExecutableFunctionFactory.cpp b/src/Interpreters/UserDefinedExecutableFunctionFactory.cpp\nindex 5b5c7911735f..b67e9c16ed57 100644\n--- a/src/Interpreters/UserDefinedExecutableFunctionFactory.cpp\n+++ b/src/Interpreters/UserDefinedExecutableFunctionFactory.cpp\n@@ -43,7 +43,7 @@ class UserDefinedFunction final : public IFunction\n     size_t getNumberOfArguments() const override { return executable_function->getConfiguration().arguments.size(); }\n \n     bool useDefaultImplementationForConstants() const override { return true; }\n-    bool useDefaultImplementationForNulls() const override { return true; }\n+    bool useDefaultImplementationForNulls() const override { return false; }\n     bool isDeterministic() const override { return false; }\n     bool isDeterministicInScopeOfQuery() const override { return false; }\n \n",
  "test_patch": "diff --git a/tests/integration/test_executable_user_defined_function/functions/test_function_config.xml b/tests/integration/test_executable_user_defined_function/functions/test_function_config.xml\nindex b2b7db83fbcb..5da2e854da80 100644\n--- a/tests/integration/test_executable_user_defined_function/functions/test_function_config.xml\n+++ b/tests/integration/test_executable_user_defined_function/functions/test_function_config.xml\n@@ -289,4 +289,26 @@\n         <command>input_sum_json_named_args.py</command>\n     </function>\n \n+    <function>\n+        <type>executable</type>\n+        <name>test_function_nullable_python</name>\n+        <return_type>String</return_type>\n+        <argument>\n+            <type>Nullable(UInt64)</type>\n+        </argument>\n+        <format>TabSeparated</format>\n+        <command>input_nullable.py</command>\n+    </function>\n+\n+    <function>\n+        <type>executable_pool</type>\n+        <name>test_function_nullable_pool_python</name>\n+        <return_type>String</return_type>\n+        <argument>\n+            <type>Nullable(UInt64)</type>\n+        </argument>\n+        <format>TabSeparated</format>\n+        <command>input_nullable.py</command>\n+    </function>\n+\n </functions>\ndiff --git a/tests/integration/test_executable_user_defined_function/test.py b/tests/integration/test_executable_user_defined_function/test.py\nindex 10993e9c5ddd..f48547a14377 100644\n--- a/tests/integration/test_executable_user_defined_function/test.py\n+++ b/tests/integration/test_executable_user_defined_function/test.py\n@@ -228,3 +228,38 @@ def test_executable_function_sum_json_python(started_cluster):\n     )\n \n     node.query(\"DROP TABLE test_table;\")\n+\n+\n+def test_executable_function_input_nullable_python(started_cluster):\n+    skip_test_msan(node)\n+\n+    node.query(\n+        \"CREATE TABLE test_table_nullable (value Nullable(UInt64)) ENGINE=TinyLog;\"\n+    )\n+    node.query(\"INSERT INTO test_table_nullable VALUES (0), (NULL), (2);\")\n+\n+    assert (\n+        node.query(\n+            \"SELECT test_function_nullable_python(1), test_function_nullable_python(NULL)\"\n+        )\n+        == \"Key 1\\tKey Nullable\\n\"\n+    )\n+    assert (\n+        node.query(\n+            \"SELECT test_function_nullable_python(value) FROM test_table_nullable;\"\n+        )\n+        == \"Key 0\\nKey Nullable\\nKey 2\\n\"\n+    )\n+\n+    assert (\n+        node.query(\n+            \"SELECT test_function_nullable_pool_python(1), test_function_nullable_pool_python(NULL)\"\n+        )\n+        == \"Key 1\\tKey Nullable\\n\"\n+    )\n+    assert (\n+        node.query(\n+            \"SELECT test_function_nullable_pool_python(value) FROM test_table_nullable;\"\n+        )\n+        == \"Key 0\\nKey Nullable\\nKey 2\\n\"\n+    )\ndiff --git a/tests/integration/test_executable_user_defined_function/user_scripts/input_nullable.py b/tests/integration/test_executable_user_defined_function/user_scripts/input_nullable.py\nnew file mode 100755\nindex 000000000000..d1a825cf849d\n--- /dev/null\n+++ b/tests/integration/test_executable_user_defined_function/user_scripts/input_nullable.py\n@@ -0,0 +1,12 @@\n+#!/usr/bin/python3\n+\n+import sys\n+\n+if __name__ == \"__main__\":\n+    for line in sys.stdin:\n+        if line == \"\\\\N\\n\":\n+            print(\"Key Nullable\", end=\"\\n\")\n+        else:\n+            print(\"Key \" + line, end=\"\")\n+\n+        sys.stdout.flush()\n",
  "problem_statement": "user-defined-functions null value input\nWhen I'm executing a UDF function, a `null value` input to the script is received as `0`(for numbers) and `empty string` (for strings). \r\n\r\nThe UDF definition like this\r\n```\r\n<function>\r\n    <type>executable</type>\r\n    <name>some_function_name</name>\r\n    <return_name>result</return_name>\r\n    <return_type>String</return_type>\r\n    <argument>\r\n        <type>Nullable(Int32)</type>\r\n        <name>argument_1</name>\r\n    </argument>\r\n    <format>JSONEachRow</format>\r\n    <command>some_function.py</command>\r\n</function>\r\n```\r\nAnd the script file link this (Here whatever input I got I'm logging it to a file.)\r\n```\r\n#!/usr/bin/python3\r\n\r\nimport sys\r\nimport json\r\n\r\ndef write_to_file(line):\r\n\twith open(\"/tmp/input.log\",'a') as fw:\r\n\t\tfw.write(str(line))\r\n\r\nif __name__ == '__main__':\r\n    for line in sys.stdin:\r\n        # Writing log\r\n        write_to_file(line)\r\n\r\n        result = {\"result\":str(line)}\r\n        print(json.dumps(result))\r\n        sys.stdout.flush()\r\n```\r\n\r\nI got the below results \r\n```\r\nclickhouse-client --query=\"select value, some_function_name(value) from (SELECT 1 as value UNION ALL SELECT NULL UNION ALL SELECT 0) FORMAT Vertical\"  --input_format_tsv_empty_as_default=1\r\n\r\nRow 1:\r\n\u2500\u2500\u2500\u2500\u2500\u2500\r\nvalue:                     1\r\nsome_function_name(value): {\"argument_1\":1}\r\n\r\n\r\nRow 2:\r\n\u2500\u2500\u2500\u2500\u2500\u2500\r\nvalue:                     \u1d3a\u1d41\u1d38\u1d38\r\nsome_function_name(value): \u1d3a\u1d41\u1d38\u1d38\r\n\r\nRow 3:\r\n\u2500\u2500\u2500\u2500\u2500\u2500\r\nvalue:                     0\r\nsome_function_name(value): {\"argument_1\":0}\r\n\r\n```\r\nHere, the result for `Row 2` should be `{\"argument_1\":NULL}` but it's `NULL`.\r\n\r\nAnd the log I got  for inputs as below\r\n```\r\n{\"argument_1\":1}\r\n{\"argument_1\":0}\r\n{\"argument_1\":0}\r\n```\r\n\r\nSo, is there any option to get the `NULL` value as `NULL` to the input script?\r\n\n",
  "hints_text": "",
  "created_at": "2022-05-31T16:48:12Z"
}