{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 64638,
  "instance_id": "ClickHouse__ClickHouse-64638",
  "issue_numbers": [
    "64612"
  ],
  "base_commit": "2993be118606a27b4269fdc10b3f768970bb10d0",
  "patch": "diff --git a/src/Analyzer/Passes/RewriteAggregateFunctionWithIfPass.cpp b/src/Analyzer/Passes/RewriteAggregateFunctionWithIfPass.cpp\nindex a82ad3dced12..3500d8327ac6 100644\n--- a/src/Analyzer/Passes/RewriteAggregateFunctionWithIfPass.cpp\n+++ b/src/Analyzer/Passes/RewriteAggregateFunctionWithIfPass.cpp\n@@ -36,6 +36,10 @@ class RewriteAggregateFunctionWithIfVisitor : public InDepthQueryTreeVisitorWith\n         if (!function_node || !function_node->isAggregateFunction())\n             return;\n \n+        auto lower_name = Poco::toLower(function_node->getFunctionName());\n+        if (lower_name.ends_with(\"if\"))\n+            return;\n+\n         auto & function_arguments_nodes = function_node->getArguments().getNodes();\n         if (function_arguments_nodes.size() != 1)\n             return;\n@@ -44,7 +48,6 @@ class RewriteAggregateFunctionWithIfVisitor : public InDepthQueryTreeVisitorWith\n         if (!if_node || if_node->getFunctionName() != \"if\")\n             return;\n \n-        auto lower_name = Poco::toLower(function_node->getFunctionName());\n         auto if_arguments_nodes = if_node->getArguments().getNodes();\n         auto * first_const_node = if_arguments_nodes[1]->as<ConstantNode>();\n         auto * second_const_node = if_arguments_nodes[2]->as<ConstantNode>();\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03164_analyzer_rewrite_aggregate_function_with_if.reference b/tests/queries/0_stateless/03164_analyzer_rewrite_aggregate_function_with_if.reference\nnew file mode 100644\nindex 000000000000..d00491fd7e5b\n--- /dev/null\n+++ b/tests/queries/0_stateless/03164_analyzer_rewrite_aggregate_function_with_if.reference\n@@ -0,0 +1,1 @@\n+1\ndiff --git a/tests/queries/0_stateless/03164_analyzer_rewrite_aggregate_function_with_if.sql b/tests/queries/0_stateless/03164_analyzer_rewrite_aggregate_function_with_if.sql\nnew file mode 100644\nindex 000000000000..52f767d8aae8\n--- /dev/null\n+++ b/tests/queries/0_stateless/03164_analyzer_rewrite_aggregate_function_with_if.sql\n@@ -0,0 +1,1 @@\n+SELECT countIf(multiIf(number < 2, NULL, if(number = 4, 1, 0))) FROM numbers(5);\n",
  "problem_statement": "ClickHouse >= 24.4 rejects certain valid queries that were previously accepted\nClickHouse 24.4 and 24.5 raises an error for the following query:\r\n\r\n```sql\r\nSELECT countIf(multiIf(number < 2, NULL, if(number = 4, 1, 0)))\r\nFROM numbers(5)\r\n```\r\n\r\n```\r\nQuery id: 69c50dfa-be78-4edd-b59b-c4b4698a4d03\r\n\r\n\r\nElapsed: 0.004 sec.\r\n\r\nReceived exception from server (version 24.4.1):\r\nCode: 184. DB::Exception: Received from localhost:9000. DB::Exception: Nested identical combinator 'If' is not supported. (ILLEGAL_AGGREGATION)\r\n```\r\n\r\n24.3.1 accepted it as follows:\r\n\r\n```\r\nQuery id: cc1fccc2-ce07-48ec-b7fe-dfe8139bd121\r\n\r\n\u250c\u2500countIf(if(less(number, 2), NULL, if(equals(number, 4), 1, 0)))\u2500\u2510\r\n\u2502                                                               1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.005 sec.\r\n```\r\n\n",
  "hints_text": "Looks like related to analyzer. Disabling the analyzer runs the query as expected:\r\n\r\n```\r\n:) SELECT countIf(multiIf(number < 2, NULL, if(number = 4, 1, 0)))\r\nFROM numbers(5)\r\nSETTINGS allow_experimental_analyzer = 0\r\n\r\nQuery id: 11ed9eb2-c9f8-44aa-a830-e1a484dd50ef\r\n\r\n   \u250c\u2500countIf(if(less(number, 2), NULL, if(equals(number, 4), 1, 0)))\u2500\u2510\r\n1. \u2502                                                               1 \u2502\r\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.015 sec.\r\n```\r\n\r\nLink: https://fiddle.clickhouse.com/24c5f30a-3f37-43b0-8617-b62e32c35e69\nIt's because of `optimize_rewrite_aggregate_function_with_if = 1`, this optimization works only with the  analyzer enabled.",
  "created_at": "2024-05-30T13:43:20Z"
}