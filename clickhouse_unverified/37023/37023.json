{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 37023,
  "instance_id": "ClickHouse__ClickHouse-37023",
  "issue_numbers": [
    "5895"
  ],
  "base_commit": "897a0393b28fecf3c231a5494e848270a2965798",
  "patch": "diff --git a/src/Core/Settings.h b/src/Core/Settings.h\nindex 76d2dca117b1..30a64483800f 100644\n--- a/src/Core/Settings.h\n+++ b/src/Core/Settings.h\n@@ -447,6 +447,7 @@ static constexpr UInt64 operator\"\"_Gb(unsigned long long value)\n     M(Bool, optimize_normalize_count_variants, true, \"Rewrite aggregate functions that semantically equals to count() as count().\", 0) \\\n     M(Bool, optimize_injective_functions_inside_uniq, true, \"Delete injective functions of one argument inside uniq*() functions.\", 0) \\\n     M(Bool, convert_query_to_cnf, false, \"Convert SELECT query to CNF\", 0) \\\n+    M(Bool, optimize_or_like_chain, false, \"Optimize multiple OR LIKE into multiMatchAny. This optimization should not be enabled by default, because it defies index analysis in some cases.\", 0) \\\n     M(Bool, optimize_arithmetic_operations_in_aggregate_functions, true, \"Move arithmetic operations out of aggregation functions\", 0) \\\n     M(Bool, optimize_duplicate_order_by_and_distinct, true, \"Remove duplicate ORDER BY and DISTINCT if it's possible\", 0) \\\n     M(Bool, optimize_redundant_functions_in_order_by, true, \"Remove functions from ORDER BY if its argument is also in ORDER BY\", 0) \\\ndiff --git a/src/Interpreters/ConvertFunctionOrLikeVisitor.cpp b/src/Interpreters/ConvertFunctionOrLikeVisitor.cpp\nnew file mode 100644\nindex 000000000000..7cad19fbf744\n--- /dev/null\n+++ b/src/Interpreters/ConvertFunctionOrLikeVisitor.cpp\n@@ -0,0 +1,76 @@\n+#include <Functions/likePatternToRegexp.h>\n+#include <Interpreters/ConvertFunctionOrLikeVisitor.h>\n+#include <Parsers/ASTFunction.h>\n+#include <Parsers/ASTIdentifier.h>\n+#include <Parsers/ASTLiteral.h>\n+#include <Parsers/IAST.h>\n+#include <Common/typeid_cast.h>\n+\n+\n+namespace DB\n+{\n+\n+void ConvertFunctionOrLikeData::visit(ASTFunction & function, ASTPtr &)\n+{\n+    if (function.name != \"or\")\n+        return;\n+\n+    std::unordered_map<ASTPtr, std::shared_ptr<ASTLiteral>> identifier_to_literals;\n+    for (auto & child : function.children)\n+    {\n+        if (auto expr_list_fn = child->as<ASTExpressionList>())\n+        {\n+            ASTs unique_elems;\n+            for (const auto & child_expr_fn : expr_list_fn->children)\n+            {\n+                unique_elems.push_back(child_expr_fn);\n+                if (const auto * child_fn = child_expr_fn->as<ASTFunction>())\n+                {\n+                    const bool is_like = child_fn->name == \"like\";\n+                    const bool is_ilike = child_fn->name == \"ilike\";\n+\n+                    /// Not {i}like -> bail out.\n+                    if (!is_like && !is_ilike)\n+                        continue;\n+\n+                    const auto & arguments = child_fn->arguments->children;\n+\n+                    /// They should have 2 arguments.\n+                    if (arguments.size() != 2)\n+                        continue;\n+\n+                    /// Second one is string literal.\n+                    auto identifier = arguments[0];\n+                    auto literal = arguments[1]->as<ASTLiteral>();\n+                    if (!identifier || !literal || literal->value.getType() != Field::Types::String)\n+                        continue;\n+\n+                    String regexp = likePatternToRegexp(literal->value.get<String>());\n+                    /// Case insensitive. Works with UTF-8 as well.\n+                    if (is_ilike)\n+                        regexp = \"(?i)\" + regexp;\n+\n+                    unique_elems.pop_back();\n+                    auto it = identifier_to_literals.find(identifier);\n+                    if (it == identifier_to_literals.end())\n+                    {\n+                        it = identifier_to_literals.insert({identifier, std::make_shared<ASTLiteral>(Field{Array{}})}).first;\n+                        auto match = makeASTFunction(\"multiMatchAny\");\n+                        match->arguments->children.push_back(arguments[0]);\n+                        match->arguments->children.push_back(it->second);\n+                        unique_elems.push_back(std::move(match));\n+                    }\n+                    it->second->value.get<Array>().push_back(regexp);\n+                }\n+            }\n+\n+            /// OR must have at least two arguments.\n+            if (unique_elems.size() == 1)\n+                unique_elems.push_back(std::make_shared<ASTLiteral>(Field(false)));\n+\n+            expr_list_fn->children = std::move(unique_elems);\n+        }\n+    }\n+}\n+\n+}\ndiff --git a/src/Interpreters/ConvertFunctionOrLikeVisitor.h b/src/Interpreters/ConvertFunctionOrLikeVisitor.h\nnew file mode 100644\nindex 000000000000..ba4a00734481\n--- /dev/null\n+++ b/src/Interpreters/ConvertFunctionOrLikeVisitor.h\n@@ -0,0 +1,22 @@\n+#pragma once\n+\n+#include <Interpreters/InDepthNodeVisitor.h>\n+#include <Parsers/IAST_fwd.h>\n+\n+namespace DB\n+{\n+\n+class ASTFunction;\n+\n+/// Replaces all the \"or\"'s with {i}like to multiMatchAny\n+class ConvertFunctionOrLikeData\n+{\n+public:\n+    using TypeToVisit = ASTFunction;\n+\n+    void visit(ASTFunction & function, ASTPtr & ast);\n+};\n+\n+using ConvertFunctionOrLikeVisitor = InDepthNodeVisitor<OneTypeMatcher<ConvertFunctionOrLikeData>, true>;\n+\n+}\ndiff --git a/src/Interpreters/TreeOptimizer.cpp b/src/Interpreters/TreeOptimizer.cpp\nindex 19041a19aa48..94af126450c1 100644\n--- a/src/Interpreters/TreeOptimizer.cpp\n+++ b/src/Interpreters/TreeOptimizer.cpp\n@@ -17,6 +17,7 @@\n #include <Interpreters/RewriteCountVariantsVisitor.h>\n #include <Interpreters/MonotonicityCheckVisitor.h>\n #include <Interpreters/ConvertStringsToEnumVisitor.h>\n+#include <Interpreters/ConvertFunctionOrLikeVisitor.h>\n #include <Interpreters/RewriteFunctionToSubcolumnVisitor.h>\n #include <Interpreters/Context.h>\n #include <Interpreters/ExternalDictionariesLoader.h>\n@@ -729,6 +730,12 @@ void optimizeFuseQuantileFunctions(ASTPtr & query)\n     }\n }\n \n+void optimizeOrLikeChain(ASTPtr & query)\n+{\n+    ConvertFunctionOrLikeVisitor::Data data = {};\n+    ConvertFunctionOrLikeVisitor(data).visit(query);\n+}\n+\n }\n \n void TreeOptimizer::optimizeIf(ASTPtr & query, Aliases & aliases, bool if_chain_to_multiif)\n@@ -836,6 +843,14 @@ void TreeOptimizer::apply(ASTPtr & query, TreeRewriterResult & result,\n \n     if (settings.optimize_syntax_fuse_functions)\n         optimizeFuseQuantileFunctions(query);\n+\n+    if (settings.optimize_or_like_chain\n+        && settings.allow_hyperscan\n+        && settings.max_hyperscan_regexp_length == 0\n+        && settings.max_hyperscan_regexp_total_length == 0)\n+    {\n+        optimizeOrLikeChain(query);\n+    }\n }\n \n }\n",
  "test_patch": "diff --git a/tests/clickhouse-test b/tests/clickhouse-test\nindex cff6c2de7994..c4ad314ff9e7 100755\n--- a/tests/clickhouse-test\n+++ b/tests/clickhouse-test\n@@ -452,6 +452,7 @@ class SettingsRandomizer:\n         \"prefer_localhost_replica\": lambda: random.randint(0, 1),\n         \"max_block_size\": lambda: random.randint(8000, 100000),\n         \"max_threads\": lambda: random.randint(1, 64),\n+        \"optimize_or_like_chain\": lambda: random.randint(0, 1),\n     }\n \n     @staticmethod\ndiff --git a/tests/queries/0_stateless/00908_bloom_filter_index.sh b/tests/queries/0_stateless/00908_bloom_filter_index.sh\nindex 474a2b739e2c..59375794af0c 100755\n--- a/tests/queries/0_stateless/00908_bloom_filter_index.sh\n+++ b/tests/queries/0_stateless/00908_bloom_filter_index.sh\n@@ -58,50 +58,50 @@ $CLICKHOUSE_CLIENT --query=\"INSERT INTO bloom_filter_idx2 VALUES\n (13, 'abc')\"\n \n # EQUAL\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx2 WHERE lower(s) = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' OR s = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx2 WHERE lower(s) = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' OR s = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx2 WHERE lower(s) = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' OR s = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx2 WHERE lower(s) = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' OR s = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s = 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE lower(s) = 'abc' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE lower(s) = 'abc' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE lower(s) = 'abc' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE lower(s) = 'abc' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n # LIKE\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%database%' AND s LIKE '%ClickHouse%' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%database%' AND s LIKE '%ClickHouse%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%database%' AND s LIKE '%ClickHouse%' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%database%' AND s LIKE '%ClickHouse%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%database%' AND lower(s) LIKE '%clickhouse%' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%database%' AND lower(s) LIKE '%clickhouse%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%database%' AND lower(s) LIKE '%clickhouse%' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%database%' AND lower(s) LIKE '%clickhouse%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%\u0431\u0430\u0437\u0430\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u0445%' AND s LIKE '%ClickHouse%' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%\u0431\u0430\u0437\u0430\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u0445%' AND s LIKE '%ClickHouse%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%\u0431\u0430\u0437\u0430\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u0445%' AND s LIKE '%ClickHouse%' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%\u0431\u0430\u0437\u0430\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u0445%' AND s LIKE '%ClickHouse%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE (s LIKE '%\u0431\u0430\u0437\u0430\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u0445%' AND s LIKE '%ClickHouse%') OR s LIKE '____\u0441\u0442\u0440\u043e\u043a\u0430' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE (s LIKE '%\u0431\u0430\u0437\u0430\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u0445%' AND s LIKE '%ClickHouse%') OR s LIKE '____\u0441\u0442\u0440\u043e\u043a\u0430' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE (s LIKE '%\u0431\u0430\u0437\u0430\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u0445%' AND s LIKE '%ClickHouse%') OR s LIKE '____\u0441\u0442\u0440\u043e\u043a\u0430' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE (s LIKE '%\u0431\u0430\u0437\u0430\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u0445%' AND s LIKE '%ClickHouse%') OR s LIKE '____\u0441\u0442\u0440\u043e\u043a\u0430' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%%<div>_%_%_</div>%%' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%%<div>_%_%_</div>%%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%%<div>_%_%_</div>%%' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%%<div>_%_%_</div>%%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%2\\\\\\\\%2%' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%2\\\\\\\\%2%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%2\\\\\\\\%2%' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%2\\\\\\\\%2%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%_\\\\\\\\%2\\\\\\\\__\\\\\\\\' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%_\\\\\\\\%2\\\\\\\\__\\\\\\\\' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%_\\\\\\\\%2\\\\\\\\__\\\\\\\\' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '%_\\\\\\\\%2\\\\\\\\__\\\\\\\\' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '2\\\\\\\\_2\\\\\\\\%2_2\\\\\\\\' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '2\\\\\\\\_2\\\\\\\\%2_2\\\\\\\\' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '2\\\\\\\\_2\\\\\\\\%2_2\\\\\\\\' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '2\\\\\\\\_2\\\\\\\\%2_2\\\\\\\\' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '2\\\\\\\\_2\\\\\\\\%2_2_' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '2\\\\\\\\_2\\\\\\\\%2_2_' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '2\\\\\\\\_2\\\\\\\\%2_2_' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s LIKE '2\\\\\\\\_2\\\\\\\\%2_2_' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n # IN\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s IN ('a\u0431\u0432\u0433\u0434\u0435\u0451\u0436', 'abc') ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE s IN ('a\u0431\u0432\u0433\u0434\u0435\u0451\u0436', 'abc') ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s IN ('a\u0431\u0432\u0433\u0434\u0435\u0451\u0436', 'abc') ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE s IN ('a\u0431\u0432\u0433\u0434\u0435\u0451\u0436', 'abc') ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE (s, lower(s)) IN (('a\u0431\u0432\u0433\u0434\u0435\u0451\u0436', 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436'), ('abc', 'cba')) ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx WHERE (s, lower(s)) IN (('a\u0431\u0432\u0433\u0434\u0435\u0451\u0436', 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436'), ('abc', 'cba')) ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE (s, lower(s)) IN (('a\u0431\u0432\u0433\u0434\u0435\u0451\u0436', 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436'), ('abc', 'cba')) ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx WHERE (s, lower(s)) IN (('a\u0431\u0432\u0433\u0434\u0435\u0451\u0436', 'a\u0431\u0432\u0433\u0434\u0435\u0451\u0436'), ('abc', 'cba')) ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n \n # TOKEN BF\n@@ -125,18 +125,18 @@ $CLICKHOUSE_CLIENT --query=\"INSERT INTO bloom_filter_idx3 VALUES\n (13, 'abc')\"\n \n # EQUAL\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx3 WHERE lower(s) = 'column-oriented' OR s = 'column-oriented' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx3 WHERE lower(s) = 'column-oriented' OR s = 'column-oriented' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx3 WHERE lower(s) = 'column-oriented' OR s = 'column-oriented' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx3 WHERE lower(s) = 'column-oriented' OR s = 'column-oriented' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n # LIKE\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx3 WHERE lower(s) LIKE '%(dbms)%' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx3 WHERE lower(s) LIKE '%(dbms)%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx3 WHERE s LIKE 'column-%' AND s LIKE '%-oriented' ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx3 WHERE s LIKE 'column-%' AND s LIKE '%-oriented' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx3 WHERE lower(s) LIKE '%(dbms)%' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx3 WHERE lower(s) LIKE '%(dbms)%' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx3 WHERE s LIKE 'column-%' AND s LIKE '%-oriented' ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx3 WHERE s LIKE 'column-%' AND s LIKE '%-oriented' ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n # IN\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx3 WHERE s IN ('some string', 'abc') ORDER BY k\"\n-$CLICKHOUSE_CLIENT --query=\"SELECT * FROM bloom_filter_idx3 WHERE s IN ('some string', 'abc') ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx3 WHERE s IN ('some string', 'abc') ORDER BY k\"\n+$CLICKHOUSE_CLIENT --optimize_or_like_chain 0 --query=\"SELECT * FROM bloom_filter_idx3 WHERE s IN ('some string', 'abc') ORDER BY k FORMAT JSON\" | grep \"rows_read\"\n \n $CLICKHOUSE_CLIENT --query=\"DROP TABLE bloom_filter_idx\"\n $CLICKHOUSE_CLIENT --query=\"DROP TABLE bloom_filter_idx2\"\ndiff --git a/tests/queries/0_stateless/02226_or_like_combine.reference b/tests/queries/0_stateless/02226_or_like_combine.reference\nnew file mode 100644\nindex 000000000000..93465f606fee\n--- /dev/null\n+++ b/tests/queries/0_stateless/02226_or_like_combine.reference\n@@ -0,0 +1,40 @@\n+SELECT materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s\n+WHERE (s LIKE \\'hell%\\') OR (s ILIKE \\'%\u043f\u0440\u0438\u0432\u0435\u0442%\\') OR (s ILIKE \\'world%\\')\n+SETTINGS optimize_or_like_chain = 0\n+SELECT materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s\n+WHERE multiMatchAny(s, [\\'^hell\\', \\'(?i)\u043f\u0440\u0438\u0432\u0435\u0442\\', \\'(?i)^world\\']) OR false\n+SETTINGS optimize_or_like_chain = 1\n+SELECT\n+    materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s1,\n+    materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s2\n+WHERE multiMatchAny(s1, [\\'^hell\\', \\'(?i)^world\\']) OR multiMatchAny(s2, [\\'(?i)\u043f\u0440\u0438\u0432\u0435\u0442\\'])\n+SETTINGS optimize_or_like_chain = 1\n+SELECT\n+    materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s1,\n+    materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s2\n+WHERE (s1 LIKE \\'hell%\\') OR (s2 ILIKE \\'%\u043f\u0440\u0438\u0432\u0435\u0442%\\') OR (s1 ILIKE \\'world%\\')\n+SETTINGS optimize_or_like_chain = 1\n+SELECT\n+    materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s1,\n+    materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s2\n+WHERE (s1 LIKE \\'hell%\\') OR (s2 ILIKE \\'%\u043f\u0440\u0438\u0432\u0435\u0442%\\') OR (s1 ILIKE \\'world%\\')\n+SETTINGS optimize_or_like_chain = 1\n+SELECT\n+    materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s1,\n+    materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s2\n+WHERE (s1 LIKE \\'hell%\\') OR (s2 ILIKE \\'%\u043f\u0440\u0438\u0432\u0435\u0442%\\') OR (s1 ILIKE \\'world%\\')\n+SETTINGS optimize_or_like_chain = 1\n+SELECT\n+    materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s1,\n+    materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s2\n+WHERE multiMatchAny(s1, [\\'^hell\\', \\'(?i)^world\\']) OR multiMatchAny(s2, [\\'(?i)\u043f\u0440\u0438\u0432\u0435\u0442\\']) OR (s1 = \\'\u041f\u0440\u0438\u0432\u0435\u0442\\')\n+SETTINGS optimize_or_like_chain = 1\n+\u041f\u0440\u0438\u0432\u0435\u0442, optimized World\n+\u041f\u0440\u0438\u0432\u0435\u0442, World\n+\u041f\u0440\u0438\u0432\u0435\u0442, optimized World\n+\u041f\u0440\u0438\u0432\u0435\u0442, World\n+SELECT\n+    (materialize(\\'\u041f\u0440\u0438\u0432\u0435\u0442, World\\') AS s) LIKE \\'hell%\\' AS test,\n+    s\n+WHERE multiMatchAny(s, [\\'^hell\\', \\'(?i)\u043f\u0440\u0438\u0432\u0435\u0442\\', \\'(?i)^world\\']) OR false\n+SETTINGS optimize_or_like_chain = 1\ndiff --git a/tests/queries/0_stateless/02226_or_like_combine.sql b/tests/queries/0_stateless/02226_or_like_combine.sql\nnew file mode 100644\nindex 000000000000..ed91dda74691\n--- /dev/null\n+++ b/tests/queries/0_stateless/02226_or_like_combine.sql\n@@ -0,0 +1,19 @@\n+EXPLAIN SYNTAX SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s WHERE (s LIKE 'hell%') OR (s ILIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s ILIKE 'world%') SETTINGS optimize_or_like_chain = 0;\n+EXPLAIN SYNTAX SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s WHERE (s LIKE 'hell%') OR (s ILIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s ILIKE 'world%') SETTINGS optimize_or_like_chain = 1;\n+\n+\n+EXPLAIN SYNTAX SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s1, materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s2 WHERE (s1 LIKE 'hell%') OR (s2 ILIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s1 ILIKE 'world%') SETTINGS optimize_or_like_chain = 1;\n+EXPLAIN SYNTAX SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s1, materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s2 WHERE (s1 LIKE 'hell%') OR (s2 ILIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s1 ILIKE 'world%') SETTINGS optimize_or_like_chain = 1 SETTINGS allow_hyperscan = 0;\n+EXPLAIN SYNTAX SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s1, materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s2 WHERE (s1 LIKE 'hell%') OR (s2 ILIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s1 ILIKE 'world%') SETTINGS optimize_or_like_chain = 1 SETTINGS max_hyperscan_regexp_length = 10;\n+EXPLAIN SYNTAX SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s1, materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s2 WHERE (s1 LIKE 'hell%') OR (s2 ILIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s1 ILIKE 'world%') SETTINGS optimize_or_like_chain = 1 SETTINGS max_hyperscan_regexp_total_length = 10;\n+EXPLAIN SYNTAX SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s1, materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s2 WHERE (s1 LIKE 'hell%') OR (s2 ILIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s1 ILIKE 'world%') OR s1 == '\u041f\u0440\u0438\u0432\u0435\u0442' SETTINGS optimize_or_like_chain = 1;\n+\n+\n+SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, optimized World') AS s WHERE (s LIKE 'hell%') OR (s LIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s ILIKE '%world') SETTINGS optimize_or_like_chain = 1;\n+SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s WHERE (s LIKE 'hell%') OR (s LIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s ILIKE '%world') SETTINGS optimize_or_like_chain = 0;\n+SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, optimized World') AS s WHERE (s LIKE 'hell%') OR (s ILIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s LIKE 'world%') SETTINGS optimize_or_like_chain = 1;\n+SELECT materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s WHERE (s LIKE 'hell%') OR (s ILIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s LIKE 'world%') SETTINGS optimize_or_like_chain = 0;\n+\n+-- Aliases\n+\n+EXPLAIN SYNTAX SELECT test, materialize('\u041f\u0440\u0438\u0432\u0435\u0442, World') AS s WHERE ((s LIKE 'hell%') AS test) OR (s ILIKE '%\u043f\u0440\u0438\u0432\u0435\u0442%') OR (s ILIKE 'world%') SETTINGS optimize_or_like_chain = 1;\n",
  "problem_statement": "Transform OR LIKE chain to multiSearchAny or multiMatchAny.\n**Use case**\r\n`Params LIKE '%testid_145997%' OR Params LIKE '%testid_146118%' OR Params LIKE '%testid_146119%'`\r\n\n",
  "hints_text": "@kamalov-ruslan @xPoSx @demo-99",
  "created_at": "2022-05-08T21:41:45Z",
  "modified_files": [
    "src/Core/Settings.h",
    "b/src/Interpreters/ConvertFunctionOrLikeVisitor.cpp",
    "b/src/Interpreters/ConvertFunctionOrLikeVisitor.h",
    "src/Interpreters/TreeOptimizer.cpp"
  ],
  "modified_test_files": [
    "tests/clickhouse-test",
    "tests/queries/0_stateless/00908_bloom_filter_index.sh",
    "b/tests/queries/0_stateless/02226_or_like_combine.reference",
    "b/tests/queries/0_stateless/02226_or_like_combine.sql"
  ]
}