{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 39617,
  "instance_id": "ClickHouse__ClickHouse-39617",
  "issue_numbers": [
    "34755"
  ],
  "base_commit": "29622746ea6cf9e2c7674f575d438a1cf6970360",
  "patch": "diff --git a/docker/packager/binary/build.sh b/docker/packager/binary/build.sh\nindex fb2b08a26335..c2de0e33d82b 100755\n--- a/docker/packager/binary/build.sh\n+++ b/docker/packager/binary/build.sh\n@@ -104,6 +104,7 @@ if [ -n \"$MAKE_DEB\" ]; then\n fi\n \n mv ./programs/clickhouse* /output\n+[ -x ./programs/self-extracting/clickhouse ] && mv ./programs/self-extracting/clickhouse /output\n mv ./src/unit_tests_dbms /output ||: # may not exist for some binary builds\n find . -name '*.so' -print -exec mv '{}' /output \\;\n find . -name '*.so.*' -print -exec mv '{}' /output \\;\n",
  "test_patch": "diff --git a/docker/test/fuzzer/run-fuzzer.sh b/docker/test/fuzzer/run-fuzzer.sh\nindex f74760e33394..392d81105764 100755\n--- a/docker/test/fuzzer/run-fuzzer.sh\n+++ b/docker/test/fuzzer/run-fuzzer.sh\n@@ -69,6 +69,8 @@ function download\n     wget_with_retry \"$BINARY_URL_TO_DOWNLOAD\"\n \n     chmod +x clickhouse\n+    # clickhouse may be compressed - run once to decompress\n+    ./clickhouse ||:\n     ln -s ./clickhouse ./clickhouse-server\n     ln -s ./clickhouse ./clickhouse-client\n \ndiff --git a/docker/test/performance-comparison/compare.sh b/docker/test/performance-comparison/compare.sh\nindex 3b0b7a4d95ab..c5f68f166b56 100755\n--- a/docker/test/performance-comparison/compare.sh\n+++ b/docker/test/performance-comparison/compare.sh\n@@ -1338,6 +1338,8 @@ EOF\n     set -x\n }\n \n+# clickhouse may be compressed - run once to decompress\n+/workspace/right/clickhouse ||:\n # Check that local and client are in PATH\n clickhouse-local --version > /dev/null\n clickhouse-client --version > /dev/null\n",
  "problem_statement": "Make `clickhouse` binary a self extracting executable.\n**Use case**\r\n\r\n1. More quick downloads but without the need of unpacking or installing any separate tools.\r\n2. Include `odbc-bridge` and `library-bridge` in single-binary ClickHouse downloads despite the fact that they are separate binaries.\r\n3. Maybe the size will be ok to always include debug info, even in .deb/.rpm packages.\r\n4. It will also speed up cold start in the cloud.\r\n5. #29378\r\n\r\n**Describe the solution you'd like**\r\n\r\nCompile a tool that can compress and decompress with ZSTD. It can use the official zstd framing format but not necessarily. It should support compression by blocks of size around 10..100 MiB (to avoid too high memory usage) and checksums. It should not depend on glibc version, and even better if it will be statically linked. Maybe two tools - one for compression and another for decompression.\r\n\r\nPost-build rule will compress `clickhouse` (and possibly `clickhouse-odbc-bridge` and `clickhouse-jdbc-bridge`) binary into blob and then include it into the decompressor with `llvm-objcopy` as a custom ELF section (alternatively - maybe we can concatenate it after the decompressor binary).\r\n\r\nDecompressor should check the free space in the current directory, decompress the content into temporary file with a similar name (like `clickhouse.tmp`), perform `fsync`, rename the current binary to a file with similar name (like `.compressed`), rename the decompressed binary to the original name, delete the compressed binary and run the decompressed binary with the same arguments.\r\n\r\nIf `clickhouse-odbc-bridge` and `clickhouse-odbc-bridge` binaries are present, they should be extracted into current directory and `clickhouse install` script should check if they are present.\r\n\r\n**Describe alternatives you've considered**\r\n\r\nThere are existing specialized tools for compressing executables (like UPX). But zstd will do it better.\r\n\r\n**Additional context**\r\n\r\nA shortcut for `clickhouse install` in the decompressor can be implemented to avoid extra file copies (first into current directory then to the install destination like `/usr/bin`).\r\n\r\nIt makes sense to parallelize decompression.\n",
  "hints_text": "@yakov-olkhovskiy AFAICS this issue is still not resolved, since #38447 only generates such binary, but it is not used anywhere. Am I missing something? Or the initial plan had been changed?\n@azat \r\noh, missed PR was marked as closing this issue\r\nreopening\r\nI will change deployment script tomorrow since it will depend on having this executable ready\nnot finished yet",
  "created_at": "2022-07-26T12:45:16Z"
}