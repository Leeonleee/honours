{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 50291,
  "instance_id": "ClickHouse__ClickHouse-50291",
  "issue_numbers": [
    "47891"
  ],
  "base_commit": "0e2156c77693ba0cfdd3c62b113f7f3a57ca2ffa",
  "patch": "diff --git a/src/Interpreters/Aggregator.cpp b/src/Interpreters/Aggregator.cpp\nindex 7df36e8600ae..c7d4b87694be 100644\n--- a/src/Interpreters/Aggregator.cpp\n+++ b/src/Interpreters/Aggregator.cpp\n@@ -2041,7 +2041,7 @@ Aggregator::convertToBlockImplFinal(Method & method, Table & data, Arena * arena\n              */\n             if (data.hasNullKeyData())\n             {\n-                has_null_key_data = Method::one_key_nullable_optimization;\n+                has_null_key_data = true;\n                 out_cols->key_columns[0]->insertDefault();\n                 insertAggregatesIntoColumns(data.getNullKeyData(), out_cols->final_aggregate_columns, arena);\n                 data.hasNullKeyData() = false;\n@@ -2076,6 +2076,7 @@ Aggregator::convertToBlockImplFinal(Method & method, Table & data, Arena * arena\n                     res.emplace_back(insertResultsIntoColumns<use_compiled_functions>(places, std::move(out_cols.value()), arena, has_null_key_data));\n                     places.clear();\n                     out_cols.reset();\n+                    has_null_key_data = false;\n                 }\n             }\n         });\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02770_jit_aggregation_nullable_key_fix.reference b/tests/queries/0_stateless/02770_jit_aggregation_nullable_key_fix.reference\nnew file mode 100644\nindex 000000000000..7d604c076f4b\n--- /dev/null\n+++ b/tests/queries/0_stateless/02770_jit_aggregation_nullable_key_fix.reference\n@@ -0,0 +1,4 @@\n+1048576\n+65411\n+1048576\n+65411\ndiff --git a/tests/queries/0_stateless/02770_jit_aggregation_nullable_key_fix.sql b/tests/queries/0_stateless/02770_jit_aggregation_nullable_key_fix.sql\nnew file mode 100644\nindex 000000000000..e4ce789f4da2\n--- /dev/null\n+++ b/tests/queries/0_stateless/02770_jit_aggregation_nullable_key_fix.sql\n@@ -0,0 +1,39 @@\n+SET compile_aggregate_expressions = 1;\n+SET min_count_to_compile_aggregate_expression = 0;\n+SET group_by_use_nulls = 0;\n+\n+SELECT count() FROM\n+(\n+    SELECT\n+        count([NULL, NULL]),\n+        count([2147483646, -2147483647, 3, 3]),\n+        uniqExact(if(number >= 1048577, number, NULL), NULL)\n+    FROM numbers(1048577)\n+    GROUP BY if(number >= 2., number, NULL)\n+);\n+\n+SELECT count() FROM\n+(\n+    SELECT count()\n+    FROM numbers(65411)\n+    GROUP BY if(number < 1, NULL, number)\n+);\n+\n+SET group_by_use_nulls = 1;\n+\n+SELECT count() FROM\n+(\n+    SELECT\n+        count([NULL, NULL]),\n+        count([2147483646, -2147483647, 3, 3]),\n+        uniqExact(if(number >= 1048577, number, NULL), NULL)\n+    FROM numbers(1048577)\n+    GROUP BY if(number >= 2., number, NULL)\n+);\n+\n+SELECT count() FROM\n+(\n+    SELECT count()\n+    FROM numbers(65411)\n+    GROUP BY if(number < 1, NULL, number)\n+);\n",
  "problem_statement": "Logical error: Invalid number of rows in Chunk\nhttps://s3.amazonaws.com/clickhouse-test-reports/0/4dc5a629c349dd88cd7728621223a62e9ed87a4a/fuzzer_astfuzzerdebug/report.html\r\n\r\n```\r\ndell9510 :) set group_by_use_nulls=1\r\n\r\nSET group_by_use_nulls = 1\r\n\r\nQuery id: 2069b36a-fe74-48ff-a0ed-934b6a6dd57e\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.003 sec. \r\n\r\ndell9510 :) SELECT count([NULL, NULL]), count([2147483646, -2147483647, 3, 3]), uniqExact(if(number >= 1048577, number, NULL), NULL) FROM numbers(1048577) GROUP BY if(number >= 2., number, NULL) format Null\r\n\r\nSELECT\r\n    count([NULL, NULL]),\r\n    count([2147483646, -2147483647, 3, 3]),\r\n    uniqExact(if(number >= 1048577, number, NULL), NULL)\r\nFROM numbers(1048577)\r\nGROUP BY if(number >= 2., number, NULL)\r\nFORMAT `Null`\r\n\r\nQuery id: 749df7d1-2e9a-4ea8-a92b-295464433591\r\n\r\n[dell9510] 2023.03.22 14:23:52.856923 [ 246980 ] {749df7d1-2e9a-4ea8-a92b-295464433591} <Fatal> : Logical error: 'Invalid number of rows in Chunk column UInt64 position 1: expected 65409, got 65410'.\r\n[dell9510] 2023.03.22 14:23:52.858093 [ 246986 ] <Fatal> BaseDaemon: ########################################\r\n[dell9510] 2023.03.22 14:23:52.858298 [ 246986 ] <Fatal> BaseDaemon: (version 23.3.1.2537, build id: 3018790D95A6AA08FB81899667D886CA8AA05445) (from thread 246980) (query_id: 749df7d1-2e9a-4ea8-a92b-295464433591) (query: SELECT count([NULL, NULL]), count([2147483646, -2147483647, 3, 3]), uniqExact(if(number >= 1048577, number, NULL), NULL) FROM numbers(1048577) GROUP BY if(number >= 2., number, NULL) format Null) Received signal Aborted (6)\r\n[dell9510] 2023.03.22 14:23:52.858458 [ 246986 ] <Fatal> BaseDaemon: \r\n[dell9510] 2023.03.22 14:23:52.858626 [ 246986 ] <Fatal> BaseDaemon: Stack trace: 0x7efdba5928ec 0x7efdba543ea8 0x7efdba52d53d 0x22f756c3 0x22f75735 0x22f75b6c 0x19934d57 0x1a239a6e 0x2dda5f88 0x2dda5d5f 0x2e23e081 0x2e24d8b7 0x2e2498af 0x2ddfe250 0x2ddfdf40 0x2ddd967e 0x2ddd9a04 0x2dddb267 0x2dddb1b5 0x2dddb199 0x2dddb0fd 0x2dddaff0 0x2dddaf35 0x2dddaf15 0x2dddaef5 0x2dddaec0 0x22fcdcd6 0x22fcd115 0x230d23dc 0x230d9bd1 0x230d9b75 0x230d9a9d 0x230d954f 0x7efdba590bb5 0x7efdba612d90\r\n[dell9510] 2023.03.22 14:23:52.858820 [ 246986 ] <Fatal> BaseDaemon: 4. ? @ 0x7efdba5928ec in ?\r\n[dell9510] 2023.03.22 14:23:52.858944 [ 246986 ] <Fatal> BaseDaemon: 5. gsignal @ 0x7efdba543ea8 in ?\r\n[dell9510] 2023.03.22 14:23:52.859086 [ 246986 ] <Fatal> BaseDaemon: 6. abort @ 0x7efdba52d53d in ?\r\n[dell9510] 2023.03.22 14:23:52.925055 [ 246986 ] <Fatal> BaseDaemon: 7. /home/tavplubix/ch/ClickHouse/src/Common/Exception.cpp:41: DB::abortOnFailedAssertion(String const&) @ 0x22f756c3 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:52.989157 [ 246986 ] <Fatal> BaseDaemon: 8. /home/tavplubix/ch/ClickHouse/src/Common/Exception.cpp:64: DB::handle_error_code(String const&, int, bool, std::vector<void*, std::allocator<void*>> const&) @ 0x22f75735 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:53.047296 [ 246986 ] <Fatal> BaseDaemon: 9. /home/tavplubix/ch/ClickHouse/src/Common/Exception.cpp:92: DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x22f75b6c in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:53.113924 [ 246986 ] <Fatal> BaseDaemon: 10. /home/tavplubix/ch/ClickHouse/src/Common/Exception.h:55: DB::Exception::Exception(String&&, int, bool) @ 0x19934d57 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:53.259355 [ 246986 ] <Fatal> BaseDaemon: 11. /home/tavplubix/ch/ClickHouse/src/Common/Exception.h:82: DB::Exception::Exception<String, String, String>(int, FormatStringHelperImpl<std::type_identity<String>::type, std::type_identity<String>::type, std::type_identity<String>::type>, String&&, String&&, String&&) @ 0x1a239a6e in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:53.308614 [ 246986 ] <Fatal> BaseDaemon: 12. /home/tavplubix/ch/ClickHouse/src/Processors/Chunk.cpp:73: DB::Chunk::checkNumRowsIsConsistent() @ 0x2dda5f88 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:53.344894 [ 246986 ] <Fatal> BaseDaemon: 13. /home/tavplubix/ch/ClickHouse/src/Processors/Chunk.cpp:17: DB::Chunk::Chunk(std::vector<COW<DB::IColumn>::immutable_ptr<DB::IColumn>, std::allocator<COW<DB::IColumn>::immutable_ptr<DB::IColumn>>>, unsigned long) @ 0x2dda5d5f in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:53.574894 [ 246986 ] <Fatal> BaseDaemon: 14. /home/tavplubix/ch/ClickHouse/src/Processors/Transforms/AggregatingTransform.cpp:33: DB::convertToChunk(DB::Block const&) @ 0x2e23e081 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:53.747205 [ 246986 ] <Fatal> BaseDaemon: 15. /home/tavplubix/ch/ClickHouse/src/Processors/Transforms/AggregatingTransform.cpp:487: DB::ConvertingAggregatedToChunksTransform::mergeSingleLevel() @ 0x2e24d8b7 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:53.917161 [ 246986 ] <Fatal> BaseDaemon: 16. /home/tavplubix/ch/ClickHouse/src/Processors/Transforms/AggregatingTransform.cpp:307: DB::ConvertingAggregatedToChunksTransform::work() @ 0x2e2498af in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:53.946018 [ 246986 ] <Fatal> BaseDaemon: 17. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/ExecutionThreadContext.cpp:47: DB::executeJob(DB::ExecutingGraph::Node*, DB::ReadProgressCallback*) @ 0x2ddfe250 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:53.969305 [ 246986 ] <Fatal> BaseDaemon: 18. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/ExecutionThreadContext.cpp:92: DB::ExecutionThreadContext::executeTask() @ 0x2ddfdf40 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.056526 [ 246986 ] <Fatal> BaseDaemon: 19. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/PipelineExecutor.cpp:229: DB::PipelineExecutor::executeStepImpl(unsigned long, std::atomic<bool>*) @ 0x2ddd967e in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.131419 [ 246986 ] <Fatal> BaseDaemon: 20. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/PipelineExecutor.cpp:195: DB::PipelineExecutor::executeSingleThread(unsigned long) @ 0x2ddd9a04 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.200003 [ 246986 ] <Fatal> BaseDaemon: 21. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/PipelineExecutor.cpp:320: DB::PipelineExecutor::spawnThreads()::$_0::operator()() const @ 0x2dddb267 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.288523 [ 246986 ] <Fatal> BaseDaemon: 22. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:394: decltype(std::declval<DB::PipelineExecutor::spawnThreads()::$_0&>()()) std::__invoke[abi:v15000]<DB::PipelineExecutor::spawnThreads()::$_0&>(DB::PipelineExecutor::spawnThreads()::$_0&) @ 0x2dddb1b5 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.378734 [ 246986 ] <Fatal> BaseDaemon: 23. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/tuple:1789: decltype(auto) std::__apply_tuple_impl[abi:v15000]<DB::PipelineExecutor::spawnThreads()::$_0&, std::tuple<>&>(DB::PipelineExecutor::spawnThreads()::$_0&, std::tuple<>&, std::__tuple_indices<>) @ 0x2dddb199 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.473525 [ 246986 ] <Fatal> BaseDaemon: 24. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/tuple:1798: decltype(auto) std::apply[abi:v15000]<DB::PipelineExecutor::spawnThreads()::$_0&, std::tuple<>&>(DB::PipelineExecutor::spawnThreads()::$_0&, std::tuple<>&) @ 0x2dddb0fd in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.547306 [ 246986 ] <Fatal> BaseDaemon: 25. /home/tavplubix/ch/ClickHouse/src/Common/ThreadPool.h:210: ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PipelineExecutor::spawnThreads()::$_0>(DB::PipelineExecutor::spawnThreads()::$_0&&)::'lambda'()::operator()() @ 0x2dddaff0 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.654999 [ 246986 ] <Fatal> BaseDaemon: 26. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:394: decltype(std::declval<DB::PipelineExecutor::spawnThreads()::$_0>()()) std::__invoke[abi:v15000]<ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PipelineExecutor::spawnThreads()::$_0>(DB::PipelineExecutor::spawnThreads()::$_0&&)::'lambda'()&>(DB::PipelineExecutor::spawnThreads()::$_0&&) @ 0x2dddaf35 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.754550 [ 246986 ] <Fatal> BaseDaemon: 27. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:480: void std::__invoke_void_return_wrapper<void, true>::__call<ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PipelineExecutor::spawnThreads()::$_0>(DB::PipelineExecutor::spawnThreads()::$_0&&)::'lambda'()&>(ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PipelineExecutor::spawnThreads()::$_0>(DB::PipelineExecutor::spawnThreads()::$_0&&)::'lambda'()&) @ 0x2dddaf15 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.851812 [ 246986 ] <Fatal> BaseDaemon: 28. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:235: std::__function::__default_alloc_func<ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PipelineExecutor::spawnThreads()::$_0>(DB::PipelineExecutor::spawnThreads()::$_0&&)::'lambda'(), void ()>::operator()[abi:v15000]() @ 0x2dddaef5 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.948638 [ 246986 ] <Fatal> BaseDaemon: 29. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:716: void std::__function::__policy_invoker<void ()>::__call_impl<std::__function::__default_alloc_func<ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PipelineExecutor::spawnThreads()::$_0>(DB::PipelineExecutor::spawnThreads()::$_0&&)::'lambda'(), void ()>>(std::__function::__policy_storage const*) @ 0x2dddaec0 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:54.992659 [ 246986 ] <Fatal> BaseDaemon: 30. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:848: std::__function::__policy_func<void ()>::operator()[abi:v15000]() const @ 0x22fcdcd6 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:55.035135 [ 246986 ] <Fatal> BaseDaemon: 31. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:1187: std::function<void ()>::operator()() const @ 0x22fcd115 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:55.088978 [ 246986 ] <Fatal> BaseDaemon: 32. /home/tavplubix/ch/ClickHouse/src/Common/ThreadPool.cpp:315: ThreadPoolImpl<std::thread>::worker(std::__list_iterator<std::thread, void*>) @ 0x230d23dc in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:55.152437 [ 246986 ] <Fatal> BaseDaemon: 33. /home/tavplubix/ch/ClickHouse/src/Common/ThreadPool.cpp:145: void ThreadPoolImpl<std::thread>::scheduleImpl<void>(std::function<void ()>, long, std::optional<unsigned long>, bool)::'lambda0'()::operator()() const @ 0x230d9bd1 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:55.217272 [ 246986 ] <Fatal> BaseDaemon: 34. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:394: decltype(std::declval<void>()()) std::__invoke[abi:v15000]<void ThreadPoolImpl<std::thread>::scheduleImpl<void>(std::function<void ()>, long, std::optional<unsigned long>, bool)::'lambda0'()>(void&&) @ 0x230d9b75 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:55.280495 [ 246986 ] <Fatal> BaseDaemon: 35. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/thread:285: void std::__thread_execute[abi:v15000]<std::unique_ptr<std::__thread_struct, std::default_delete<std::__thread_struct>>, void ThreadPoolImpl<std::thread>::scheduleImpl<void>(std::function<void ()>, long, std::optional<unsigned long>, bool)::'lambda0'()>(std::tuple<void, void ThreadPoolImpl<std::thread>::scheduleImpl<void>(std::function<void ()>, long, std::optional<unsigned long>, bool)::'lambda0'()>&, std::__tuple_indices<>) @ 0x230d9a9d in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:55.344584 [ 246986 ] <Fatal> BaseDaemon: 36. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/thread:295: void* std::__thread_proxy[abi:v15000]<std::tuple<std::unique_ptr<std::__thread_struct, std::default_delete<std::__thread_struct>>, void ThreadPoolImpl<std::thread>::scheduleImpl<void>(std::function<void ()>, long, std::optional<unsigned long>, bool)::'lambda0'()>>(void*) @ 0x230d954f in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse\r\n[dell9510] 2023.03.22 14:23:55.344808 [ 246986 ] <Fatal> BaseDaemon: 37. ? @ 0x7efdba590bb5 in ?\r\n[dell9510] 2023.03.22 14:23:55.344941 [ 246986 ] <Fatal> BaseDaemon: 38. ? @ 0x7efdba612d90 in ?\r\n[dell9510] 2023.03.22 14:23:55.345093 [ 246986 ] <Fatal> BaseDaemon: Integrity check of the executable skipped because the reference checksum could not be read.\r\n\u2192 Progress: 1.11 million rows, 8.90 MB (203.62 thousand rows/s., 1.63 MB/s.)  99%Exception on client:\r\nCode: 32. DB::Exception: Attempt to read after eof: while receiving packet from localhost:9000. (ATTEMPT_TO_READ_AFTER_EOF)\r\n\r\n```\r\n\n",
  "hints_text": "It crashes also with `set group_by_use_nulls=0`. Completely unrelated to `group_by_use_nulls`.\nHm, sorry, I did not reproduce it with `group_by_use_nulls=0`, seems like it works non-deterministically\nSeems like it happens when I run the query four times\nLogs: https://pastila.nl/?01359e82/1316b6ad5fe36d33df0d4a33a829457e\r\nThe difference is: `Aggregator: Compile expression count()() 0`\nAs far as I know, @qoega has recently found some issues with JIT compilation.\nI don't think they are related https://github.com/ClickHouse/ClickHouse/issues/47787\nFigured out that the bug was introduced in https://github.com/ClickHouse/ClickHouse/pull/45772\r\nObservations ....\r\n\r\nThis query works\r\n<pre>\r\nSELECT count()\r\nFROM <b>numbers( <i>65410</i> )</b>\r\nGROUP BY if(number < 1, NULL, number)\r\nFORMAT `Null`\r\n</pre>\r\nbut fail with bigger argument for `numbers()`:\r\n<pre>\r\nSELECT count()\r\nFROM <b>numbers( <i>65411</i> )</b>\r\nGROUP BY if(number < 1, NULL, number)\r\nFORMAT `Null`\r\n\r\nReceived exception from server (version 23.3.1):\r\nCode: 49. DB::Exception: Received from localhost:9000. DB::Exception: Invalid number of rows in Chunk column UInt64 position 1: expected 1, got 2: While executing ConvertingAggregatedToChunksTransform. (LOGICAL_ERROR)\r\n</pre>\r\n\r\nMoreover, if we generate more `NULLs` by changing `if(number < 1, NULL,...` to `if(number < 2, NULL,...` then the query works.\r\nAnd increasing `numbers()` argument by `1` makes the query to fail again:\r\n<pre>\r\n-- works\r\nSELECT count()\r\nFROM <b>numbers( <i>65411</i> )</b>\r\nGROUP BY if(<b>number < <i>2</i></b>, NULL, number)\r\nFORMAT `Null`\r\n</pre>\r\n<pre>\r\n-- fail\r\nSELECT count()\r\nFROM <b>numbers( <i>65412</i> )</b>\r\nGROUP BY if(<b>number < <i>2</i></b>, NULL, number)\r\nFORMAT `Null`\r\n</pre>\r\n\r\nFYI @kitaisreal ",
  "created_at": "2023-05-28T18:06:45Z",
  "modified_files": [
    "src/Interpreters/Aggregator.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02770_jit_aggregation_nullable_key_fix.reference",
    "b/tests/queries/0_stateless/02770_jit_aggregation_nullable_key_fix.sql"
  ]
}