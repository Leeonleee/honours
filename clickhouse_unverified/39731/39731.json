{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 39731,
  "instance_id": "ClickHouse__ClickHouse-39731",
  "issue_numbers": [
    "39719"
  ],
  "base_commit": "6b2acf5957a0734622ed1f69aa9a33e632fe5242",
  "patch": "diff --git a/src/Client/ClientBase.cpp b/src/Client/ClientBase.cpp\nindex faef19fe1a31..977d2bca01f5 100644\n--- a/src/Client/ClientBase.cpp\n+++ b/src/Client/ClientBase.cpp\n@@ -583,9 +583,14 @@ try\n         if (has_vertical_output_suffix)\n             current_format = \"Vertical\";\n \n-        /// It is not clear how to write progress intermixed with data with parallel formatting.\n+        bool logs_into_stdout = server_logs_file == \"-\";\n+        bool extras_into_stdout = need_render_progress || logs_into_stdout;\n+        bool select_only_into_file = select_into_file && !select_into_file_and_stdout;\n+\n+        /// It is not clear how to write progress and logs\n+        /// intermixed with data with parallel formatting.\n         /// It may increase code complexity significantly.\n-        if (!need_render_progress || (select_into_file && !select_into_file_and_stdout))\n+        if (!extras_into_stdout || select_only_into_file)\n             output_format = global_context->getOutputFormatParallelIfPossible(\n                 current_format, out_file_buf ? *out_file_buf : *out_buf, block);\n         else\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02360_send_logs_level_colors.reference b/tests/queries/0_stateless/02360_send_logs_level_colors.reference\nindex 1c30d50f5c06..fe2824243c4e 100644\n--- a/tests/queries/0_stateless/02360_send_logs_level_colors.reference\n+++ b/tests/queries/0_stateless/02360_send_logs_level_colors.reference\n@@ -1,2 +1,3 @@\n ASCII text\n ASCII text\n+ASCII text\ndiff --git a/tests/queries/0_stateless/02360_send_logs_level_colors.sh b/tests/queries/0_stateless/02360_send_logs_level_colors.sh\nindex eaa294cebe4b..4e5ce0577027 100755\n--- a/tests/queries/0_stateless/02360_send_logs_level_colors.sh\n+++ b/tests/queries/0_stateless/02360_send_logs_level_colors.sh\n@@ -26,8 +26,6 @@ EOF\n \n run \"$CLICKHOUSE_CLIENT -q 'SELECT 1' 2>$file_name\"\n run \"$CLICKHOUSE_CLIENT -q 'SELECT 1' --server_logs_file=$file_name\"\n-\n-# This query may fail due to bug in clickhouse-client.\n-# run \"$CLICKHOUSE_CLIENT -q 'SELECT 1' --server_logs_file=- >$file_name\"\n+run \"$CLICKHOUSE_CLIENT -q 'SELECT 1' --server_logs_file=- >$file_name\"\n \n rm -f \"$file_name\"\n",
  "problem_statement": "`send_log_level` with redirect to stdout may fail\n**Describe what's wrong**\r\nQuery in clickhouse-client may fail with options `--send_logs_level=trace --server_logs_file=-` (`--server_logs_file=-` means write server logs to stdout).\r\n\r\n**How to reproduce**\r\n\r\n```\r\nwhile true; do clickhouse-client -q \"select 1\" --send_logs_level=trace --server_logs_file=- >log; done\r\nCode: 75. DB::ErrnoException: Cannot write to file (fd = 1), errno: 14, strerror: Bad address: (in query: select 1). (CANNOT_WRITE_TO_FILE_DESCRIPTOR)\r\n\r\nCode: 75. DB::ErrnoException: Cannot write to file (fd = 1), errno: 14, strerror: Bad address: (in query: select 1). (CANNOT_WRITE_TO_FILE_DESCRIPTOR)\r\n\r\nCode: 75. DB::ErrnoException: Cannot write to file (fd = 1), errno: 14, strerror: Bad address: (in query: select 1). (CANNOT_WRITE_TO_FILE_DESCRIPTOR)\r\n```\r\n\r\nSome queries will fail periodically.\r\n\r\n\n",
  "hints_text": "",
  "created_at": "2022-07-29T19:16:09Z",
  "modified_files": [
    "src/Client/ClientBase.cpp"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/02360_send_logs_level_colors.reference",
    "tests/queries/0_stateless/02360_send_logs_level_colors.sh"
  ]
}