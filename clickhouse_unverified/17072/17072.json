{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 17072,
  "instance_id": "ClickHouse__ClickHouse-17072",
  "issue_numbers": [
    "16944"
  ],
  "base_commit": "00de84fbe37470ca2e0cc5fc3a498d107cfe40bf",
  "patch": "diff --git a/src/Interpreters/InterpreterCreateQuery.cpp b/src/Interpreters/InterpreterCreateQuery.cpp\nindex ae73c62c5809..64c7979544ea 100644\n--- a/src/Interpreters/InterpreterCreateQuery.cpp\n+++ b/src/Interpreters/InterpreterCreateQuery.cpp\n@@ -75,6 +75,7 @@ namespace ErrorCodes\n     extern const int DICTIONARY_ALREADY_EXISTS;\n     extern const int ILLEGAL_SYNTAX_FOR_DATA_TYPE;\n     extern const int ILLEGAL_COLUMN;\n+    extern const int LOGICAL_ERROR;\n }\n \n namespace fs = std::filesystem;\n@@ -630,7 +631,12 @@ void InterpreterCreateQuery::setEngine(ASTCreateQuery & create) const\n                 \"Cannot CREATE a table AS \" + qualified_name + \", it is a Dictionary\",\n                 ErrorCodes::INCORRECT_QUERY);\n \n-        create.set(create.storage, as_create.storage->ptr());\n+        if (as_create.storage)\n+            create.set(create.storage, as_create.storage->ptr());\n+        else if (as_create.as_table_function)\n+            create.as_table_function = as_create.as_table_function->clone();\n+        else\n+            throw Exception(ErrorCodes::LOGICAL_ERROR, \"Cannot set engine, it's a bug.\");\n     }\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01189_create_as_table_as_table_function.reference b/tests/queries/0_stateless/01189_create_as_table_as_table_function.reference\nnew file mode 100644\nindex 000000000000..a6f6458a7772\n--- /dev/null\n+++ b/tests/queries/0_stateless/01189_create_as_table_as_table_function.reference\n@@ -0,0 +1,4 @@\n+CREATE TABLE default.table2\\n(\\n    `number` UInt64\\n) AS numbers(5)\n+CREATE TABLE default.table3\\n(\\n    `number` UInt64\\n) AS numbers(5)\n+5\t10\n+5\t10\ndiff --git a/tests/queries/0_stateless/01189_create_as_table_as_table_function.sql b/tests/queries/0_stateless/01189_create_as_table_as_table_function.sql\nnew file mode 100644\nindex 000000000000..011dcb931777\n--- /dev/null\n+++ b/tests/queries/0_stateless/01189_create_as_table_as_table_function.sql\n@@ -0,0 +1,14 @@\n+DROP TABLE IF EXISTS table2;\n+DROP TABLE IF EXISTS table3;\n+\n+CREATE TABLE table2 AS numbers(5);\n+CREATE TABLE table3 AS table2;\n+\n+SHOW CREATE table2;\n+SHOW CREATE table3;\n+\n+SELECT count(), sum(number) FROM table2;\n+SELECT count(), sum(number) FROM table3;\n+\n+DROP TABLE table2;\n+DROP TABLE table3;\n",
  "problem_statement": "Using CREATE TABLE AS on a table built using the numbers() table function causes crash.\n**Describe the bug**\r\nCreating a table as a table that was created using the numbers() causes an issue and disconnects the client.\r\n\r\n**How to reproduce**\r\n* ClickHouse server version\r\nversion 20.10.3.30\r\n\r\n* `CREATE TABLE` statements for all tables involved\r\n```\r\nCREATE TABLE table2 AS numbers(5)\r\nCREATE TABLE table3 AS table2\r\n```\r\n\r\n* Queries to run that lead to unexpected result\r\n```\r\n:) create table table2 as numbers(5)\r\n\r\nCREATE TABLE table2 AS numbers(5)\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.010 sec.\r\n\r\n:) create table table3 as table2\r\n\r\nCREATE TABLE table3 AS table2\r\n\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.258464 [ 179463 ] <Fatal> BaseDaemon: ########################################\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.258700 [ 179463 ] <Fatal> BaseDaemon: (version 20.10.3.30 (official build), build id: 4EAF0337F53BC2B4) (from thread 171354) (query_id: 0ac2afaa-12be-4a98-9767-5c8cd373f8d0) Received signal Segmentation fault (11)\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.258816 [ 179463 ] <Fatal> BaseDaemon: Address: 0x8 Access: read. Address not mapped to object.\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.258936 [ 179463 ] <Fatal> BaseDaemon: Stack trace: 0xdabc4e0 0xdabaa67 0xdabdf8a 0xdac0ff7 0xdec8f18 0xdec7dbd 0xe568ea6 0xe575ca7 0x10d4dd6f 0x10d4f77e 0x10e80a39 0x10e7c96a 0x7f25602076db 0x7f255fb2471f\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.259089 [ 179463 ] <Fatal> BaseDaemon: 2. DB::InterpreterCreateQuery::setEngine(DB::ASTCreateQuery&) const @ 0xdabc4e0 in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.259200 [ 179463 ] <Fatal> BaseDaemon: 3. DB::InterpreterCreateQuery::setProperties(DB::ASTCreateQuery&) const @ 0xdabaa67 in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.259295 [ 179463 ] <Fatal> BaseDaemon: 4. DB::InterpreterCreateQuery::createTable(DB::ASTCreateQuery&) @ 0xdabdf8a in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.259412 [ 179463 ] <Fatal> BaseDaemon: 5. DB::InterpreterCreateQuery::execute() @ 0xdac0ff7 in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.259517 [ 179463 ] <Fatal> BaseDaemon: 6. ? @ 0xdec8f18 in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.259632 [ 179463 ] <Fatal> BaseDaemon: 7. DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool) @ 0xdec7dbd in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.259776 [ 179463 ] <Fatal> BaseDaemon: 8. DB::TCPHandler::runImpl() @ 0xe568ea6 in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.259851 [ 179463 ] <Fatal> BaseDaemon: 9. DB::TCPHandler::run() @ 0xe575ca7 in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.259951 [ 179463 ] <Fatal> BaseDaemon: 10. Poco::Net::TCPServerConnection::start() @ 0x10d4dd6f in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.260053 [ 179463 ] <Fatal> BaseDaemon: 11. Poco::Net::TCPServerDispatcher::run() @ 0x10d4f77e in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.260168 [ 179463 ] <Fatal> BaseDaemon: 12. Poco::PooledThread::run() @ 0x10e80a39 in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.260272 [ 179463 ] <Fatal> BaseDaemon: 13. Poco::ThreadImpl::runnableEntry(void*) @ 0x10e7c96a in /usr/bin/clickhouse\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.260353 [ 179463 ] <Fatal> BaseDaemon: 14. start_thread @ 0x76db in /lib/x86_64-linux-gnu/libpthread-2.27.so\r\n[altinity-qa-cosmic2] 2020.11.12 19:01:54.260467 [ 179463 ] <Fatal> BaseDaemon: 15. __clone @ 0x12171f in /lib/x86_64-linux-gnu/libc-2.27.so\r\n\r\nException on client:\r\nCode: 32. DB::Exception: Attempt to read after eof: while receiving packet from localhost:9000\r\n\r\nConnecting to localhost:9000 as user default.\r\nCode: 210. DB::NetException: Connection refused (localhost:9000)\r\n\r\n```\n",
  "hints_text": "CREATE TABLE table2 AS select number from numbers(5)\r\nCREATE TABLE table3 AS select number from table2\n> CREATE TABLE table2 AS select number from numbers(5)\r\n> CREATE TABLE table3 AS select number from table2\r\n\r\nWhat do you mean? These queries fail with `Code: 119. DB::Exception: Received from localhost:9000. DB::Exception: Incorrect CREATE query: ENGINE required.`, as they should.\nCREATE TABLE table2 engine=Log AS select number from numbers(5)\nIt runs ok with version: 20.12.1.1.\r\n```\r\nClickHouse client version 20.12.1.1.\r\nConnecting to localhost:9000 as user default.\r\nConnected to ClickHouse server version 20.12.1 revision 54442.\r\n\r\ndell123 :) CREATE TABLE table2 engine=Log AS select number from numbers(5)\r\n\r\nCREATE TABLE table2\r\nENGINE = Log AS\r\nSELECT number\r\nFROM numbers(5)\r\n\r\nQuery id: c1459fe4-7839-4b7b-80e8-d3b154578a16\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.025 sec.\r\n\r\ndell123 :) select * from table2;\r\n\r\nSELECT *\r\nFROM table2\r\n\r\nQuery id: 786d6485-7ac3-4ab6-a514-19c1dfea80e1\r\n\r\n\u250c\u2500number\u2500\u2510\r\n\u2502      0 \u2502\r\n\u2502      1 \u2502\r\n\u2502      2 \u2502\r\n\u2502      3 \u2502\r\n\u2502      4 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n5 rows in set. Elapsed: 0.002 sec.\r\ndell123 :) CREATE TABLE table3 engine = Log AS select number from table2\r\n\r\nCREATE TABLE table3\r\nENGINE = Log AS\r\nSELECT number\r\nFROM table2\r\n\r\nQuery id: 7b808734-dfca-4908-ae6d-11c276178a16\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.032 sec.\r\n\r\ndell123 :)\r\n```",
  "created_at": "2020-11-16T10:17:47Z",
  "modified_files": [
    "src/Interpreters/InterpreterCreateQuery.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01189_create_as_table_as_table_function.reference",
    "b/tests/queries/0_stateless/01189_create_as_table_as_table_function.sql"
  ]
}