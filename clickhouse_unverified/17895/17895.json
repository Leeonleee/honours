{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 17895,
  "instance_id": "ClickHouse__ClickHouse-17895",
  "issue_numbers": [
    "13804"
  ],
  "base_commit": "7d77a7ba2491994531d15fa43cb25783fe22b9ef",
  "patch": "diff --git a/src/Functions/FunctionsComparison.h b/src/Functions/FunctionsComparison.h\nindex e674f8690ff4..957c7e0ab3e2 100644\n--- a/src/Functions/FunctionsComparison.h\n+++ b/src/Functions/FunctionsComparison.h\n@@ -1216,7 +1216,10 @@ class FunctionComparison : public IFunction\n         {\n             return res;\n         }\n-        else if (isColumnedAsDecimal(left_type) || isColumnedAsDecimal(right_type))\n+        else if ((isColumnedAsDecimal(left_type) || isColumnedAsDecimal(right_type))\n+                 // Comparing Date and DateTime64 requires implicit conversion,\n+                 // otherwise Date is treated as number.\n+                 && !(date_and_datetime && (isDate(left_type) || isDate(right_type))))\n         {\n             // compare\n             if (!allowDecimalComparison(left_type, right_type) && !date_and_datetime)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01560_DateTime_and_DateTime64_comparision.reference b/tests/queries/0_stateless/01560_DateTime_and_DateTime64_comparision.reference\nnew file mode 100644\nindex 000000000000..088030bbc280\n--- /dev/null\n+++ b/tests/queries/0_stateless/01560_DateTime_and_DateTime64_comparision.reference\n@@ -0,0 +1,3 @@\n+-1\tDateTime64(1, \\'UTC\\')\t<\t1\t1\t1\t<=\t1\t1\t1\t=\t0\t0\t0\t>=\t0\t0\t0\t>\t0\t0\t0\t!=\t1\t1\t1\n+0\tDateTime64(1, \\'UTC\\')\t<\t0\t0\t0\t<=\t1\t1\t1\t=\t1\t1\t1\t>=\t1\t1\t1\t>\t0\t0\t0\t!=\t0\t0\t0\n+1\tDateTime64(1, \\'UTC\\')\t<\t0\t0\t0\t<=\t0\t0\t0\t=\t0\t0\t0\t>=\t1\t1\t1\t>\t1\t1\t1\t!=\t1\t1\t1\ndiff --git a/tests/queries/0_stateless/01560_DateTime_and_DateTime64_comparision.sql b/tests/queries/0_stateless/01560_DateTime_and_DateTime64_comparision.sql\nnew file mode 100644\nindex 000000000000..afee0ebadaa9\n--- /dev/null\n+++ b/tests/queries/0_stateless/01560_DateTime_and_DateTime64_comparision.sql\n@@ -0,0 +1,42 @@\n+SELECT\n+    n,\n+    toTypeName(dt64) AS dt64_typename,\n+\n+    '<',\n+    dt64 < dt,\n+    toDateTime(dt64) < dt,\n+    dt64 < toDateTime64(dt, 1, 'UTC'),\n+    \n+    '<=',\n+    dt64 <= dt,\n+    toDateTime(dt64) <= dt,\n+    dt64 <= toDateTime64(dt, 1, 'UTC'),\n+\n+    '=',\n+    dt64 = dt,\n+    toDateTime(dt64) = dt,\n+    dt64 = toDateTime64(dt, 1, 'UTC'),\n+    \n+    '>=',\n+    dt64 >= dt,\n+    toDateTime(dt64) >= dt,\n+    dt64 >= toDateTime64(dt, 1, 'UTC'),\n+    \n+    '>',\n+    dt64 > dt,\n+    toDateTime(dt64) > dt,\n+    dt64 > toDateTime64(dt, 1, 'UTC'),\n+\n+    '!=',\n+    dt64 != dt,\n+    toDateTime(dt64) != dt,\n+    dt64 != toDateTime64(dt, 1, 'UTC')\n+FROM \n+(\n+    SELECT\n+        number - 1 as n,\n+        toDateTime64(toStartOfInterval(now(), toIntervalSecond(1), 'UTC'), 1, 'UTC') + n AS dt64,\n+        toStartOfInterval(now(), toIntervalSecond(1), 'UTC') AS dt\n+    FROM system.numbers\n+    LIMIT 3\n+)\ndiff --git a/tests/queries/0_stateless/01561_Date_and_DateTime64_comparision.reference b/tests/queries/0_stateless/01561_Date_and_DateTime64_comparision.reference\nnew file mode 100644\nindex 000000000000..e5183ec6a8a7\n--- /dev/null\n+++ b/tests/queries/0_stateless/01561_Date_and_DateTime64_comparision.reference\n@@ -0,0 +1,3 @@\n+-1\tDateTime64(1, \\'UTC\\')\t<\t1\t1\t1\t<=\t1\t1\t1\t=\t0\t0\t0\t>=\t0\t0\t0\t>\t0\t0\t0\t!=\t1\t1\t1\n+0\tDateTime64(1, \\'UTC\\')\t<\t0\t0\t0\t<=\t0\t1\t0\t=\t0\t1\t0\t>=\t1\t1\t1\t>\t1\t0\t1\t!=\t1\t0\t1\n+1\tDateTime64(1, \\'UTC\\')\t<\t0\t0\t0\t<=\t0\t0\t0\t=\t0\t0\t0\t>=\t1\t1\t1\t>\t1\t1\t1\t!=\t1\t1\t1\ndiff --git a/tests/queries/0_stateless/01561_Date_and_DateTime64_comparision.sql b/tests/queries/0_stateless/01561_Date_and_DateTime64_comparision.sql\nnew file mode 100644\nindex 000000000000..b780793a7774\n--- /dev/null\n+++ b/tests/queries/0_stateless/01561_Date_and_DateTime64_comparision.sql\n@@ -0,0 +1,43 @@\n+SELECT\n+    n,\n+    toTypeName(dt64) AS dt64_typename,\n+\n+    '<',\n+    dt64 < d,\n+    toDate(dt64) < d,\n+    dt64 < toDateTime64(d, 1, 'UTC'),\n+    \n+    '<=',\n+    dt64 <= d,\n+    toDate(dt64) <= d,\n+    dt64 <= toDateTime64(d, 1, 'UTC'),\n+\n+    '=',\n+    dt64 = d,\n+    toDate(dt64) = d,\n+    dt64 = toDateTime64(d, 1, 'UTC'),\n+    \n+    '>=',\n+    dt64 >= d,\n+    toDate(dt64) >= d,\n+    dt64 >= toDateTime64(d, 1, 'UTC'),\n+    \n+    '>',\n+    dt64 > d,\n+    toDate(dt64) > d,\n+    dt64 > toDateTime64(d, 1, 'UTC'),\n+\n+    '!=',\n+    dt64 != d,\n+    toDate(dt64) != d,\n+    dt64 != toDateTime64(d, 1, 'UTC')\n+FROM \n+(\n+    SELECT\n+        number - 1 as n,\n+        toDateTime64(toStartOfInterval(now(), toIntervalSecond(1), 'UTC'), 1, 'UTC') AS dt64,\n+        toDate(now(), 'UTC') - n as d\n+    FROM system.numbers\n+    LIMIT 3\n+)\n+FORMAT TabSeparated\n",
  "problem_statement": "Comparison DateTime64 to DateTime / Date\n**Use case**\r\n\r\nComparison between DateTime64 and DateTime / Date types is allowed but the behavior is confusing (it looks like used numerical comparison):\r\n\r\n* from one side for zero-precision it works as expected (values compared as datetime-based ones): \r\n\r\n```sql\r\nSELECT toTypeName(dt64) AS dt64_typename, dt64 = dt\r\nFROM \r\n(\r\n    SELECT \r\n        toDateTime64(toStartOfInterval(now(), toIntervalSecond(1), 'UTC'), 0, 'UTC') AS dt64,\r\n        toStartOfInterval(now(), toIntervalSecond(1), 'UTC') AS dt\r\n)\r\n\r\n/*\r\n\u250c\u2500dt64_typename\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500equals(dt64, dt)\u2500\u2510\r\n\u2502 DateTime64(0, 'UTC') \u2502                1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n*/\r\n```\r\n* from another side for non-zero-precision its behavior is unexpected if not used explicit type conversion:\r\n\r\n```sql\r\nSELECT \r\n    toTypeName(dt64) AS dt64_typename,\r\n    dt64 = dt,\r\n    toDateTime(dt64) = dt,\r\n    dt64 = toDateTime64(dt, 1, 'UTC')\r\nFROM \r\n(\r\n    SELECT \r\n        toDateTime64(toStartOfInterval(now(), toIntervalSecond(1), 'UTC'), 1, 'UTC') AS dt64,\r\n        toStartOfInterval(now(), toIntervalSecond(1), 'UTC') AS dt\r\n)\r\n/*\r\n\u250c\u2500dt64_typename\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500equals(dt64, dt)\u2500\u252c\u2500equals(toDateTime(dt64), dt)\u2500\u252c\u2500equals(dt64, toDateTime64(dt, 1, 'UTC'))\u2500\u2510\r\n\u2502 DateTime64(1, 'UTC') \u2502                0 \u2502                            1 \u2502                                        1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n*/\r\n```\r\n\r\n**Describe the solution you'd like**\r\nI think this comparison either:\r\n- should be not allowed and throw an exception to ask for user uses explicit conversion\r\n- or make valid implicit conversion relying on datetime/date essence of values\r\n\n",
  "hints_text": "related (duplicate?) https://github.com/ClickHouse/ClickHouse/issues/11222",
  "created_at": "2020-12-08T10:55:57Z"
}