{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 46232,
  "instance_id": "ClickHouse__ClickHouse-46232",
  "issue_numbers": [
    "45197"
  ],
  "base_commit": "b99706b736752e5faced166addc31c2c8e2143fe",
  "patch": "diff --git a/src/Parsers/ASTFunction.cpp b/src/Parsers/ASTFunction.cpp\nindex 7a19cba0f759..129d3d607447 100644\n--- a/src/Parsers/ASTFunction.cpp\n+++ b/src/Parsers/ASTFunction.cpp\n@@ -1019,7 +1019,8 @@ void ASTFunction::formatImplWithoutAlias(const FormatSettings & settings, Format\n \n         if (!written && arguments->children.size() >= 2 && name == \"tuple\"sv)\n         {\n-            settings.ostr << (settings.hilite ? hilite_operator : \"\") << '(' << (settings.hilite ? hilite_none : \"\");\n+            settings.ostr << (settings.hilite ? hilite_operator : \"\") << ((frame.need_parens && !alias.empty()) ? \"tuple\" : \"\") << '('\n+                          << (settings.hilite ? hilite_none : \"\");\n             for (size_t i = 0; i < arguments->children.size(); ++i)\n             {\n                 if (i != 0)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02560_tuple_format.reference b/tests/queries/0_stateless/02560_tuple_format.reference\nnew file mode 100644\nindex 000000000000..7582ad08d735\n--- /dev/null\n+++ b/tests/queries/0_stateless/02560_tuple_format.reference\n@@ -0,0 +1,4 @@\n+SELECT (1, 2, 3)\n+SELECT (1, 2, 3) AS x\n+SELECT (1, 2, 3).1\n+SELECT (tuple(1, 2, 3) AS x).1\ndiff --git a/tests/queries/0_stateless/02560_tuple_format.sh b/tests/queries/0_stateless/02560_tuple_format.sh\nnew file mode 100755\nindex 000000000000..8ef811c08d7f\n--- /dev/null\n+++ b/tests/queries/0_stateless/02560_tuple_format.sh\n@@ -0,0 +1,10 @@\n+#!/usr/bin/env bash\n+\n+CUR_DIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CUR_DIR\"/../shell_config.sh\n+\n+echo \"select (tuple(1, 2, 3));\" | \"$CLICKHOUSE_FORMAT\"\n+echo \"select (tuple(1, 2, 3) as x);\" | \"$CLICKHOUSE_FORMAT\"\n+echo \"select (tuple(1, 2, 3)).1;\" | \"$CLICKHOUSE_FORMAT\"\n+echo \"select (tuple(1, 2, 3) as x).1;\" | \"$CLICKHOUSE_FORMAT\"\n",
  "problem_statement": "tuple & constants\n```sql\r\nclickhouse :) select (tuple(1, 2, 3) AS x).1 AS a,  x.2 AS b,x.3 AS c;\r\n\r\nSELECT\r\n    ((1, 2, 3) AS x).1 AS a,\r\n    x.2 AS b,\r\n    x.3 AS c\r\n\r\nQuery id: d5f428d2-b14e-4d6a-9b26-5cec253907c0\r\n\r\n\u250c\u2500a\u2500\u252c\u2500b\u2500\u252c\u2500c\u2500\u2510\r\n\u2502 1 \u2502 2 \u2502 3 \u2502\r\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.001 sec.\r\n```\r\nThe result is correct.\r\n\r\nNow let's copy/paste the echo\r\n\r\n```sql\r\nclickhouse :) SELECT\r\n                  ((1, 2, 3) AS x).1 AS a,\r\n                  x.2 AS b,\r\n                  x.3 AS c;\r\n\r\nSELECT\r\n    tuple((1, 2, 3) AS x).1 AS a,\r\n    x.2 AS b,\r\n    x.3 AS c\r\n\r\nQuery id: 4f799baf-7534-48ed-8eb8-4da0a7dadd27\r\n\r\n\u250c\u2500a\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500b\u2500\u252c\u2500c\u2500\u2510\r\n\u2502 (1,2,3) \u2502 2 \u2502 3 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2518\r\n```\r\nresult is incorrect and Clickhouse rewrite the tuple incorrectly.\n",
  "hints_text": "I'd like this issue to be assigned to me.",
  "created_at": "2023-02-09T14:12:59Z",
  "modified_files": [
    "src/Parsers/ASTFunction.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02560_tuple_format.reference",
    "b/tests/queries/0_stateless/02560_tuple_format.sh"
  ]
}