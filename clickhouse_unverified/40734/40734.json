{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 40734,
  "instance_id": "ClickHouse__ClickHouse-40734",
  "issue_numbers": [
    "40706"
  ],
  "base_commit": "d4a1b71b184a06f515fb3d8bb23f4c315528d815",
  "patch": "diff --git a/src/Storages/StorageView.cpp b/src/Storages/StorageView.cpp\nindex 3377af685f0d..adaf1c4e4041 100644\n--- a/src/Storages/StorageView.cpp\n+++ b/src/Storages/StorageView.cpp\n@@ -179,12 +179,14 @@ void StorageView::replaceWithSubquery(ASTSelectQuery & outer_query, ASTPtr view_\n \n     if (!table_expression->database_and_table_name)\n     {\n-        // If it's a view table function, add a fake db.table name.\n+        // If it's a view or merge table function, add a fake db.table name.\n         if (table_expression->table_function)\n         {\n             auto table_function_name = table_expression->table_function->as<ASTFunction>()->name;\n-            if ((table_function_name == \"view\") || (table_function_name == \"viewIfPermitted\"))\n+            if (table_function_name == \"view\" || table_function_name == \"viewIfPermitted\")\n                 table_expression->database_and_table_name = std::make_shared<ASTTableIdentifier>(\"__view\");\n+            if (table_function_name == \"merge\")\n+                table_expression->database_and_table_name = std::make_shared<ASTTableIdentifier>(\"__merge\");\n         }\n         if (!table_expression->database_and_table_name)\n             throw Exception(\"Logical error: incorrect table expression\", ErrorCodes::LOGICAL_ERROR);\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02402_merge_engine_with_view.reference b/tests/queries/0_stateless/02402_merge_engine_with_view.reference\nindex 4a869286f827..6564c244b87c 100644\n--- a/tests/queries/0_stateless/02402_merge_engine_with_view.reference\n+++ b/tests/queries/0_stateless/02402_merge_engine_with_view.reference\n@@ -4,3 +4,4 @@\n 3\n 4\n 4\n+1\ndiff --git a/tests/queries/0_stateless/02402_merge_engine_with_view.sql b/tests/queries/0_stateless/02402_merge_engine_with_view.sql\nindex 613f76e24c91..648227848457 100644\n--- a/tests/queries/0_stateless/02402_merge_engine_with_view.sql\n+++ b/tests/queries/0_stateless/02402_merge_engine_with_view.sql\n@@ -1,4 +1,4 @@\n-\n+-- #40014\n CREATE TABLE m0 (id UInt64) ENGINE=MergeTree ORDER BY id SETTINGS index_granularity = 1;\n INSERT INTO m0 SELECT number FROM numbers(10);\n CREATE TABLE m1 (id UInt64, s String) ENGINE=MergeTree ORDER BY id SETTINGS index_granularity = 1;\n@@ -7,4 +7,8 @@ CREATE VIEW m1v AS SELECT id FROM m1;\n \n CREATE TABLE m2 (id UInt64) ENGINE=Merge(currentDatabase(),'m0|m1v');\n \n-SELECT * FROM m2 WHERE id > 1 AND id < 5 ORDER BY id SETTINGS force_primary_key=1, max_bytes_to_read=64;\n\\ No newline at end of file\n+SELECT * FROM m2 WHERE id > 1 AND id < 5 ORDER BY id SETTINGS force_primary_key=1, max_bytes_to_read=64;\n+\n+-- #40706\n+CREATE VIEW v AS SELECT 1;\n+SELECT 1 FROM merge(currentDatabase(), '^v$');\n\\ No newline at end of file\n",
  "problem_statement": "Logical error: invalid table expression\n**How to reproduce**\r\n\r\nclickhouse-local:\r\n```\r\nCREATE TABLE f (`s` String) ENGINE = File(TSV, '/dev/null');\r\nCREATE VIEW v AS SELECT * FROM f;\r\nSELECT '', NULL FROM merge('', '\\0');\r\n```\r\n\n",
  "hints_text": "```\r\nCREATE VIEW v AS SELECT 1;\r\nSELECT 1 FROM merge(currentDatabase(), '^v$');\r\n```",
  "created_at": "2022-08-29T01:53:10Z"
}