{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 42487,
  "instance_id": "ClickHouse__ClickHouse-42487",
  "issue_numbers": [
    "42439"
  ],
  "base_commit": "10b176fe197d5fde73f7254c64545bcf58655449",
  "patch": "diff --git a/src/AggregateFunctions/AggregateFunctionWelchTTest.cpp b/src/AggregateFunctions/AggregateFunctionWelchTTest.cpp\nindex 74000296a2dc..3a72e0e92bbe 100644\n--- a/src/AggregateFunctions/AggregateFunctionWelchTTest.cpp\n+++ b/src/AggregateFunctions/AggregateFunctionWelchTTest.cpp\n@@ -40,7 +40,15 @@ struct WelchTTestData : public TTestMoments<Float64>\n         Float64 denominator_x = sx2 * sx2 / (nx * nx * (nx - 1));\n         Float64 denominator_y = sy2 * sy2 / (ny * ny * (ny - 1));\n \n-        return numerator / (denominator_x + denominator_y);\n+        auto result = numerator / (denominator_x + denominator_y);\n+\n+        if (result <= 0 || std::isinf(result) || isNaN(result))\n+            throw Exception(\n+                ErrorCodes::BAD_ARGUMENTS,\n+                \"Cannot calculate p_value, because the t-distribution \\\n+                has inappropriate value of degrees of freedom (={}). It should be > 0\", result);\n+\n+        return result;\n     }\n \n     std::tuple<Float64, Float64> getResult() const\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02461_welch_t_test_fuzz.reference b/tests/queries/0_stateless/02461_welch_t_test_fuzz.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02461_welch_t_test_fuzz.sql b/tests/queries/0_stateless/02461_welch_t_test_fuzz.sql\nnew file mode 100644\nindex 000000000000..b22dc49dec39\n--- /dev/null\n+++ b/tests/queries/0_stateless/02461_welch_t_test_fuzz.sql\n@@ -0,0 +1,8 @@\n+\n+DROP TABLE IF EXISTS welch_ttest__fuzz_7;\n+CREATE TABLE welch_ttest__fuzz_7 (left UInt128, right UInt128) ENGINE = Memory;\n+\n+INSERT INTO welch_ttest__fuzz_7 VALUES (0.010268, 0), (0.000167, 0), (0.000167, 0), (0.159258, 1), (0.136278, 1), (0.122389, 1);\n+\n+SELECT roundBankers(welchTTest(left, right).2, 6) from welch_ttest__fuzz_7;  -- { serverError 36 }\n+SELECT roundBankers(studentTTest(left, right).2, 6) from welch_ttest__fuzz_7;  -- { serverError 36 }\n",
  "problem_statement": "Logical error in function `welchTTest`: Degrees of freedom argument is -nan, but must be > 0\n**Describe the bug**\r\n[A link to the report\r\n](https://s3.amazonaws.com/clickhouse-test-reports/42413/1a9d190788e4e9db7e1bb367d57b50719621e9a0/fuzzer_astfuzzerasan//report.html)\r\n\r\n**How to reproduce**\r\n```sql\r\nDROP TABLE IF EXISTS welch_ttest__fuzz_7;\r\nCREATE TABLE welch_ttest__fuzz_7 (left UInt128, right UInt128) ENGINE = Memory;\r\n\r\nINSERT INTO welch_ttest__fuzz_7 VALUES (0.010268, 0), (0.000167, 0), (0.000167, 0), (0.159258, 1), (0.136278, 1), (0.122389, 1);\r\n\r\nSET send_logs_level = 'error';\r\n\r\nSELECT roundBankers(welchTTest(left, right).2, 6) from welch_ttest__fuzz_7;\r\n\r\n```\r\n\r\n```\r\n2022.10.18 12:47:31.372017 [ 2770 ] {0542a2f4-9087-401d-bec6-d5818856f3c7} <Error> executeQuery: std::exception. Code: 1001, type: boost::wrapexcept<std::domain_error>, e.what() = Error in function boost::math::students_t_distribution<double>::students_t_distribution: Degrees of freedom argument is -nan, but must be > 0 ! (version 22.10.1.1) (from [::ffff:127.0.0.1]:41524) (in query: SELECT roundBankers(welchTTest(left, right).2, 6) from welch_ttest__fuzz_7;), Stack trace (when copying this message, always include the lines below):\r\n\r\n0. ./build_clang/./contrib/libcxx/include/exception:133: std::logic_error::logic_error(std::logic_error const&) @ 0x1a6576f0 in /usr/local/bin/clickhouse\r\n1. boost::wrapexcept<std::domain_error>::wrapexcept(std::domain_error const&) @ 0xe737654 in /usr/local/bin/clickhouse\r\n2. void boost::throw_exception<std::domain_error>(std::domain_error const&) @ 0xe7375ff in /usr/local/bin/clickhouse\r\n3. void boost::math::policies::detail::raise_error<std::domain_error, double>(char const*, char const*, double const&) @ 0xe739c7d in /usr/local/bin/clickhouse\r\n4. ./build_clang/./contrib/boost/boost/math/policies/error_handling.hpp:0: DB::AggregateFunctionTTest<DB::(anonymous namespace)::WelchTTestData>::insertResultInto(char*, DB::IColumn&, DB::Arena*) const @ 0x122fdee3 in /usr/local/bin/clickhouse\r\n5. ./build_clang/./src/Interpreters/Aggregator.cpp:1817: void DB::Aggregator::insertAggregatesIntoColumns<char*>(char*&, std::__1::vector<COW<DB::IColumn>::mutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::mutable_ptr<DB::IColumn> > >&, DB::Arena*) const @ 0x1487ca2d in /usr/local/bin/clickhouse\r\n6. ./build_clang/./src/Interpreters/Aggregator.cpp:2167: DB::Aggregator::prepareBlockAndFillWithoutKey(DB::AggregatedDataVariants&, bool, bool) const @ 0x147fa6cb in /usr/local/bin/clickhouse\r\n7. ./build_clang/./src/Processors/Transforms/AggregatingTransform.cpp:0: DB::ConvertingAggregatedToChunksTransform::initialize() @ 0x15f3ef87 in /usr/local/bin/clickhouse\r\n8. ./build_clang/./src/Processors/Executors/ExecutionThreadContext.cpp:47: DB::ExecutionThreadContext::executeTask() @ 0x15dc2e9d in /usr/local/bin/clickhouse\r\n9. ./build_clang/./src/Processors/Executors/PipelineExecutor.cpp:228: DB::PipelineExecutor::executeStepImpl(unsigned long, std::__1::atomic<bool>*) @ 0x15db9830 in /usr/local/bin/clickhouse\r\n10. ./build_clang/./src/Processors/Executors/PipelineExecutor.cpp:0: void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PipelineExecutor::spawnThreads()::$_0>(DB::PipelineExecutor::spawnThreads()::$_0&&)::'lambda'(), void ()> >(std::__1::__function::__policy_storage const*) @ 0x15dbaa71 in /usr/local/bin/clickhouse\r\n11. ./build_clang/./base/base/../base/wide_integer_impl.h:772: ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) @ 0x102a8e21 in /usr/local/bin/clickhouse\r\n12. ./build_clang/./contrib/libcxx/include/__memory/unique_ptr.h:312: void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>, bool)::'lambda0'()> >(void*) @ 0x102abe6e in /usr/local/bin/clickhouse\r\n13. ? @ 0x7f4febd6e609 in ?\r\n14. __clone @ 0x7f4febc93163 in ?\r\n\r\n\r\n0 rows in set. Elapsed: 0.003 sec. \r\n\r\nReceived exception from server (version 22.10.1):\r\nCode: 1001. DB::Exception: Received from localhost:9000. DB::Exception: boost::wrapexcept<std::domain_error>: Error in function boost::math::students_t_distribution<double>::students_t_distribution: Degrees of freedom argument is -nan, but must be > 0 !. (STD_EXCEPTION)\r\n```\r\n\n",
  "hints_text": "",
  "created_at": "2022-10-19T14:29:12Z",
  "modified_files": [
    "src/AggregateFunctions/AggregateFunctionWelchTTest.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02461_welch_t_test_fuzz.sql"
  ]
}