{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 73172,
  "instance_id": "ClickHouse__ClickHouse-73172",
  "issue_numbers": [
    "73143"
  ],
  "base_commit": "204fd5b54317ad310559805e6ebd7225cf014975",
  "patch": "diff --git a/src/AggregateFunctions/AggregateFunctionLargestTriangleThreeBuckets.cpp b/src/AggregateFunctions/AggregateFunctionLargestTriangleThreeBuckets.cpp\nindex 813b13b6f7bd..99425a27ef08 100644\n--- a/src/AggregateFunctions/AggregateFunctionLargestTriangleThreeBuckets.cpp\n+++ b/src/AggregateFunctions/AggregateFunctionLargestTriangleThreeBuckets.cpp\n@@ -329,7 +329,7 @@ class AggregateFunctionLargestTriangleThreeBuckets final : public IAggregateFunc\n                 return [](IColumn & column, Float64 value)\n                 {\n                     auto & col = assert_cast<ColumnDateTime64 &>(column);\n-                    col.getData().push_back(static_cast<UInt64>(value));\n+                    col.getData().push_back(static_cast<Int64>(value));\n                 };\n             default:\n                 return [](IColumn & column, Float64 value)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02842_largestTriangleThreeBuckets_aggregate_function.reference b/tests/queries/0_stateless/02842_largestTriangleThreeBuckets_aggregate_function.reference\nindex cf7f77642531..1e304d84612c 100644\n--- a/tests/queries/0_stateless/02842_largestTriangleThreeBuckets_aggregate_function.reference\n+++ b/tests/queries/0_stateless/02842_largestTriangleThreeBuckets_aggregate_function.reference\n@@ -15,3 +15,4 @@\n (9978,978)\t9978\t10\n (9988,988)\t9988\t10\n (9999,999)\t9999\t11\n+[(0,'1900-01-01 00:00:00.000')]\ndiff --git a/tests/queries/0_stateless/02842_largestTriangleThreeBuckets_aggregate_function.sql b/tests/queries/0_stateless/02842_largestTriangleThreeBuckets_aggregate_function.sql\nindex d5ef564469e0..438302dc1def 100644\n--- a/tests/queries/0_stateless/02842_largestTriangleThreeBuckets_aggregate_function.sql\n+++ b/tests/queries/0_stateless/02842_largestTriangleThreeBuckets_aggregate_function.sql\n@@ -61,4 +61,6 @@ SELECT\n   point_x - neighbor(point_x, -1) AS point_x_diff_with_previous_row\n FROM largestTriangleTreeBucketsBucketSizeTest LIMIT 990, 10;\n \n+SELECT largestTriangleThreeBuckets(1)(0, '1900-01-01 00:00:00'::DateTime64);\n+\n DROP TABLE largestTriangleTreeBucketsBucketSizeTest;\n",
  "problem_statement": "largestTriangleThreeBuckets UBSAN error\n**Describe the bug**\r\nRun the following query with UBSAN.\r\n\r\n**How to reproduce**\r\nRun:\r\n\r\n```sql\r\nSELECT largestTriangleThreeBuckets(1)(0, '1900-01-01 00:00:00'::DateTime64);\r\n```\r\nError output:\r\n```\r\nsrc/AggregateFunctions/AggregateFunctionLargestTriangleThreeBuckets.cpp:332:65:\r\nruntime error: -2.20899e+12 is outside the range of representable values of type 'unsigned long'\r\nSUMMARY: UndefinedBehaviorSanitizer:\r\nundefined-behavior src/AggregateFunctions/AggregateFunctionLargestTriangleThreeBuckets.cpp:332:65\r\n```\n",
  "hints_text": "",
  "created_at": "2024-12-12T11:33:20Z",
  "modified_files": [
    "src/AggregateFunctions/AggregateFunctionLargestTriangleThreeBuckets.cpp"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/02842_largestTriangleThreeBuckets_aggregate_function.reference",
    "tests/queries/0_stateless/02842_largestTriangleThreeBuckets_aggregate_function.sql"
  ]
}