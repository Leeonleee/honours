{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 5437,
  "instance_id": "ClickHouse__ClickHouse-5437",
  "issue_numbers": [
    "5432"
  ],
  "base_commit": "0c2aa460651a462f14efc7e995840a244531d373",
  "patch": "diff --git a/dbms/src/Storages/StorageJoin.h b/dbms/src/Storages/StorageJoin.h\nindex 177cdee98343..3f5341d28228 100644\n--- a/dbms/src/Storages/StorageJoin.h\n+++ b/dbms/src/Storages/StorageJoin.h\n@@ -43,7 +43,7 @@ class StorageJoin : public ext::shared_ptr_helper<StorageJoin>, public StorageSe\n \n private:\n     Block sample_block;\n-    const Names & key_names;\n+    const Names key_names;\n     bool use_nulls;\n     SizeLimits limits;\n     ASTTableJoin::Kind kind;                    /// LEFT | INNER ...\n",
  "test_patch": "diff --git a/dbms/tests/queries/0_stateless/00950_bad_alloc_when_truncate_join_storage.reference b/dbms/tests/queries/0_stateless/00950_bad_alloc_when_truncate_join_storage.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/dbms/tests/queries/0_stateless/00950_bad_alloc_when_truncate_join_storage.sql b/dbms/tests/queries/0_stateless/00950_bad_alloc_when_truncate_join_storage.sql\nnew file mode 100644\nindex 000000000000..a931a66aba27\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00950_bad_alloc_when_truncate_join_storage.sql\n@@ -0,0 +1,4 @@\n+DROP TABLE IF EXISTS test.join_test;\n+CREATE TABLE test.join_test (number UInt8, value Float32) Engine = Join(ANY, LEFT, number);\n+TRUNCATE TABLE test.join_test;\n+DROP TABLE IF EXISTS test.join_test;\n",
  "problem_statement": "std::bad_alloc when TRUNCATE table with Engine=JOIN\n```sql\r\nCREATE TABLE join_test (number UInt8, value Float32) Engine = Join(ANY, LEFT, number);\r\nTRUNCATE TABLE join_test;\r\n```\r\nResult:\r\n```\r\nReceived exception from server (version 19.6.2):\r\nCode: 1001. DB::Exception: Received from localhost:9000, 127.0.0.1. DB::Exception: std::bad_alloc. Stack trace:\r\n\r\n0. /usr/bin/clickhouse-server(StackTrace::StackTrace()+0x16) [0x767c3f6]\r\n1. /usr/bin/clickhouse-server(DB::Exception::Exception(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&, int)+0x22) [0x39294a2]\r\n2. /usr/bin/clickhouse-server() [0x35993f1]\r\n3. /usr/bin/clickhouse-server(DB::TCPHandler::run()+0x2b) [0x39372ab]\r\n4. /usr/bin/clickhouse-server(Poco::Net::TCPServerConnection::start()+0xf) [0x77879bf]\r\n5. /usr/bin/clickhouse-server(Poco::Net::TCPServerDispatcher::run()+0xe9) [0x77880f9]\r\n6. /usr/bin/clickhouse-server(Poco::PooledThread::run()+0x81) [0x783b231]\r\n7. /usr/bin/clickhouse-server(Poco::ThreadImpl::runnableEntry(void*)+0x38) [0x78373f8]\r\n8. /usr/bin/clickhouse-server() [0xb5488bf]\r\n9. /lib/x86_64-linux-gnu/libpthread.so.0(+0x76db) [0x7ff9019396db]\r\n10. /lib/x86_64-linux-gnu/libc.so.6(clone+0x3f) [0x7ff900eb888f]\r\n\r\n```\n",
  "hints_text": "",
  "created_at": "2019-05-28T06:25:46Z",
  "modified_files": [
    "dbms/src/Storages/StorageJoin.h"
  ],
  "modified_test_files": [
    "b/dbms/tests/queries/0_stateless/00950_bad_alloc_when_truncate_join_storage.sql"
  ]
}