{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 52160,
  "instance_id": "ClickHouse__ClickHouse-52160",
  "issue_numbers": [
    "52156"
  ],
  "base_commit": "f4e095b50237c891ade2f8dba332963419cde91d",
  "patch": "diff --git a/src/Functions/HasTokenImpl.h b/src/Functions/HasTokenImpl.h\nindex fdec5fcb0b7b..ab6b6399486b 100644\n--- a/src/Functions/HasTokenImpl.h\n+++ b/src/Functions/HasTokenImpl.h\n@@ -39,6 +39,9 @@ struct HasTokenImpl\n         if (start_pos != nullptr)\n             throw Exception(ErrorCodes::ILLEGAL_TYPE_OF_ARGUMENT, \"Function '{}' does not support start_pos argument\", name);\n \n+        if (pattern.empty())\n+            throw Exception(ErrorCodes::BAD_ARGUMENTS, \"Needle cannot be empty, because empty string isn't a token\");\n+\n         if (haystack_offsets.empty())\n             return;\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02816_has_token_empty.reference b/tests/queries/0_stateless/02816_has_token_empty.reference\nnew file mode 100644\nindex 000000000000..aa47d0d46d47\n--- /dev/null\n+++ b/tests/queries/0_stateless/02816_has_token_empty.reference\n@@ -0,0 +1,2 @@\n+0\n+0\ndiff --git a/tests/queries/0_stateless/02816_has_token_empty.sql b/tests/queries/0_stateless/02816_has_token_empty.sql\nnew file mode 100644\nindex 000000000000..e5d6156debdf\n--- /dev/null\n+++ b/tests/queries/0_stateless/02816_has_token_empty.sql\n@@ -0,0 +1,7 @@\n+SELECT hasTokenCaseInsensitive('K(G', ''); -- { serverError BAD_ARGUMENTS }\n+SELECT hasTokenCaseInsensitive('Hello', ''); -- { serverError BAD_ARGUMENTS }\n+SELECT hasTokenCaseInsensitive('', ''); -- { serverError BAD_ARGUMENTS }\n+SELECT hasTokenCaseInsensitive('', 'Hello');\n+SELECT hasToken('Hello', ''); -- { serverError BAD_ARGUMENTS }\n+SELECT hasToken('', 'Hello');\n+SELECT hasToken('', ''); -- { serverError BAD_ARGUMENTS }\n",
  "problem_statement": "hasTokenCaseInsensitive() can hang\nThe following query never finishes:\r\n\r\n```\r\nSELECT hasTokenCaseInsensitive('K(G', '')\r\n```\r\n\r\nThe stateless asan test [00746_sql_fuzzy.sh](https://s3.amazonaws.com/clickhouse-test-reports/51772/361c235d6e578f1d156c4b49726fcad813d37021/stateless_tests__asan__[1_4].html) found that.\n",
  "hints_text": "",
  "created_at": "2023-07-16T22:13:38Z",
  "modified_files": [
    "src/Functions/HasTokenImpl.h"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02816_has_token_empty.reference",
    "b/tests/queries/0_stateless/02816_has_token_empty.sql"
  ]
}