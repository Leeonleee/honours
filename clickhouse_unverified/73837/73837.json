{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 73837,
  "instance_id": "ClickHouse__ClickHouse-73837",
  "issue_numbers": [
    "73522"
  ],
  "base_commit": "bef1947e3da5e7197c28093f1eb73c78718dc0c4",
  "patch": "diff --git a/base/base/BFloat16.h b/base/base/BFloat16.h\nindex 00848038fe93..51cd4ee99907 100644\n--- a/base/base/BFloat16.h\n+++ b/base/base/BFloat16.h\n@@ -2,6 +2,7 @@\n \n #include <bit>\n #include <base/types.h>\n+#include <base/defines.h>\n \n \n /** BFloat16 is a 16-bit floating point type, which has the same number (8) of exponent bits as Float32.\n@@ -60,7 +61,7 @@ class BFloat16\n     }\n \n     template <typename T>\n-    explicit constexpr operator T() const\n+    explicit constexpr NO_SANITIZE_UNDEFINED operator T() const\n     {\n         return T(Float32(*this));\n     }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03296_bfloat16_ubsan.reference b/tests/queries/0_stateless/03296_bfloat16_ubsan.reference\nnew file mode 100644\nindex 000000000000..ff4401616211\n--- /dev/null\n+++ b/tests/queries/0_stateless/03296_bfloat16_ubsan.reference\n@@ -0,0 +1,1 @@\n+-256\ndiff --git a/tests/queries/0_stateless/03296_bfloat16_ubsan.sql b/tests/queries/0_stateless/03296_bfloat16_ubsan.sql\nnew file mode 100644\nindex 000000000000..d1cac3d8ea8e\n--- /dev/null\n+++ b/tests/queries/0_stateless/03296_bfloat16_ubsan.sql\n@@ -0,0 +1,2 @@\n+SET allow_experimental_bfloat16_type = 1;\n+SELECT (65535::BFloat16)::Int16; -- The result is implementation defined on overflow.\n",
  "problem_statement": "UBSAN bad BFloat16 cast\n**Describe the bug**\r\nConverting a `BFloat16` value into `Int16` is out of range.\r\n\r\n**How to reproduce**\r\nCompile ClickHouse with UBSAN and run:\r\n```sql\r\nSET allow_experimental_bfloat16_type = 1;\r\nSELECT (65535::BFloat16)::Int16;\r\n```\r\nUBSAN error:\r\n```\r\nbase/base/../base/BFloat16.h:65:18: runtime error: 65280 is outside the range of representable values of type 'short'\r\n```\n",
  "hints_text": "Seems the same https://s3.amazonaws.com/clickhouse-test-reports/73420/aa3027561be4e13613a10791e975de0f2c223ed4/ast_fuzzer__ubsan_.html\nPR #72355 has a prospective fix for BFloat16 type checks, worth trying to see if it catches this case",
  "created_at": "2024-12-25T16:52:30Z"
}