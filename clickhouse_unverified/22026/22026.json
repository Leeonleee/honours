{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 22026,
  "instance_id": "ClickHouse__ClickHouse-22026",
  "issue_numbers": [
    "20514"
  ],
  "base_commit": "36898bdc4a2df3ec38e0e6befa8589564a3cef9a",
  "patch": "diff --git a/src/Functions/FunctionsConversion.h b/src/Functions/FunctionsConversion.h\nindex 4889132eeb23..ba5f0fcedc98 100644\n--- a/src/Functions/FunctionsConversion.h\n+++ b/src/Functions/FunctionsConversion.h\n@@ -2774,12 +2774,16 @@ class FunctionCast final : public IFunctionBaseImpl\n                 auto & out_data = static_cast<typename EnumType::ColumnType &>(*res).getData();\n                 out_data.resize(size);\n \n+                auto default_enum_value = result_type.getValues().front().second;\n+\n                 if (nullable_col)\n                 {\n                     for (const auto i : ext::range(0, size))\n                     {\n                         if (!nullable_col->isNullAt(i))\n                             out_data[i] = result_type.getValue(col->getDataAt(i));\n+                        else\n+                            out_data[i] = default_enum_value;\n                     }\n                 }\n                 else\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01761_cast_to_enum_nullable.reference b/tests/queries/0_stateless/01761_cast_to_enum_nullable.reference\nnew file mode 100644\nindex 000000000000..d00491fd7e5b\n--- /dev/null\n+++ b/tests/queries/0_stateless/01761_cast_to_enum_nullable.reference\n@@ -0,0 +1,1 @@\n+1\ndiff --git a/tests/queries/0_stateless/01761_cast_to_enum_nullable.sql b/tests/queries/0_stateless/01761_cast_to_enum_nullable.sql\nnew file mode 100644\nindex 000000000000..42a51d2f7b9b\n--- /dev/null\n+++ b/tests/queries/0_stateless/01761_cast_to_enum_nullable.sql\n@@ -0,0 +1,1 @@\n+SELECT toUInt8(assumeNotNull(cast(cast(NULL, 'Nullable(String)'), 'Nullable(Enum8(\\'Hello\\' = 1))')));\n",
  "problem_statement": "Uninitialized memory read in CAST\nhttps://clickhouse-test-reports.s3.yandex.net/20492/c5b96a522e29b38eae3f6c2d945540dd234e3c34/fuzzer_msan/server.log\r\n\r\n```\r\nfor i in {1..100}; do clickhouse-client --query \"SELECT toUInt8(assumeNotNull(cast(cast(NULL, 'Nullable(String)'), 'Nullable(Enum8(\\'Hello\\' = 1))')))\"; done\r\n\r\n160\r\n224\r\n128\r\n192\r\n64\r\n64\r\n32\r\n160\r\n128\r\n192\r\n128\r\n224\r\n128\r\n160\r\n0\r\n96\r\n64\r\n32\r\n192\r\n224\r\n64\r\n96\r\n224\r\n96\r\n128\r\n192\r\n192\r\n128\r\n...\r\n```\n",
  "hints_text": "",
  "created_at": "2021-03-23T12:00:11Z"
}