{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 7703,
  "instance_id": "ClickHouse__ClickHouse-7703",
  "issue_numbers": [
    "4832"
  ],
  "base_commit": "1d910c50711623982802feed8a5e5e8632609da1",
  "patch": "diff --git a/dbms/src/Functions/substring.cpp b/dbms/src/Functions/substring.cpp\nindex 0106f6945d50..6c753fc49cd4 100644\n--- a/dbms/src/Functions/substring.cpp\n+++ b/dbms/src/Functions/substring.cpp\n@@ -138,15 +138,9 @@ class FunctionSubstring : public IFunction\n         Int64 length_value = 0;\n \n         if (column_start_const)\n-        {\n             start_value = column_start_const->getInt(0);\n-        }\n         if (column_length_const)\n-        {\n             length_value = column_length_const->getInt(0);\n-            if (length_value < 0)\n-                throw Exception(\"Third argument provided for function substring could not be negative.\", ErrorCodes::ARGUMENT_OUT_OF_BOUND);\n-        }\n \n         if constexpr (is_utf8)\n         {\n",
  "test_patch": "diff --git a/dbms/tests/queries/0_stateless/00970_substring_arg_validation.reference b/dbms/tests/queries/0_stateless/00970_substring_arg_validation.reference\nindex e69de29bb2d1..13e7564ea0c8 100644\n--- a/dbms/tests/queries/0_stateless/00970_substring_arg_validation.reference\n+++ b/dbms/tests/queries/0_stateless/00970_substring_arg_validation.reference\n@@ -0,0 +1,1 @@\n+o\ndiff --git a/dbms/tests/queries/0_stateless/00970_substring_arg_validation.sql b/dbms/tests/queries/0_stateless/00970_substring_arg_validation.sql\nindex 7d8320a1d648..43d73bc2cda3 100644\n--- a/dbms/tests/queries/0_stateless/00970_substring_arg_validation.sql\n+++ b/dbms/tests/queries/0_stateless/00970_substring_arg_validation.sql\n@@ -1,4 +1,4 @@\n SELECT substring('hello', []); -- { serverError 43 }\n SELECT substring('hello', 1, []); -- { serverError 43 }\n-SELECT substring(materialize('hello'), -1, -1); -- { serverError 69 }\n+SELECT substring(materialize('hello'), -1, -1);\n SELECT substring(materialize('hello'), 0); -- { serverError 135 }\n\\ No newline at end of file\ndiff --git a/dbms/tests/queries/0_stateless/01033_substr_negative_size_arg.reference b/dbms/tests/queries/0_stateless/01033_substr_negative_size_arg.reference\nnew file mode 100644\nindex 000000000000..98c075570349\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/01033_substr_negative_size_arg.reference\n@@ -0,0 +1,8 @@\n+lickhous\n+lickhous\n+lickhous\n+lickhous\n+lickhous\n+lickhous\n+lickhous\n+lickhous\ndiff --git a/dbms/tests/queries/0_stateless/01033_substr_negative_size_arg.sql b/dbms/tests/queries/0_stateless/01033_substr_negative_size_arg.sql\nnew file mode 100644\nindex 000000000000..a0fba1a6eee6\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/01033_substr_negative_size_arg.sql\n@@ -0,0 +1,8 @@\n+SELECT substr('clickhouse', 2, -2);\n+SELECT substr(materialize('clickhouse'), 2, -2);\n+SELECT substr('clickhouse', materialize(2), -2);\n+SELECT substr(materialize('clickhouse'), materialize(2), -2);\n+SELECT substr('clickhouse', 2, materialize(-2));\n+SELECT substr(materialize('clickhouse'), 2, materialize(-2));\n+SELECT substr('clickhouse', materialize(2), materialize(-2));\n+SELECT substr(materialize('clickhouse'), materialize(2), materialize(-2));\n",
  "problem_statement": "Third argument provided for function substring could not be negative\nThis query works:\r\n\r\n```sql\r\nSELECT substr('clickhouse', 1, -2)\r\n\r\n\u250c\u2500substr('clickhouse', 1, -2)\u2500\u2510\r\n\u2502 clickhous                   \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\nand this query works:\r\n\r\n```sql\r\nSELECT substr(a, 1, -2)\r\nFROM \r\n(\r\n    SELECT 'clickhouse' AS a\r\n) \r\n\r\n\u250c\u2500substr(a, 1, -2)\u2500\u2510\r\n\u2502 clickhous        \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\nHowever, this query doesn't work:\r\n\r\n```sql\r\nSELECT substr(a, 1, -2)\r\nFROM \r\n(\r\n    SELECT arrayJoin(['clickhouse']) AS a\r\n) \r\n\r\nReceived exception from server (version 19.1.6):\r\nCode: 69. DB::Exception: Received from clickhouse:9000, 172.18.0.8. DB::Exception: Third argument provided for function substring could not be negative.. \r\n```\r\n\r\nIt seems to have something to do with `arrayJoin`, but the error message is strange for that case.\r\n\r\nIt is ClickHouse server version 19.1.6 revision 54413.\n",
  "hints_text": "",
  "created_at": "2019-11-11T01:45:51Z"
}