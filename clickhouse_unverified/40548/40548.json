{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 40548,
  "instance_id": "ClickHouse__ClickHouse-40548",
  "issue_numbers": [
    "40330"
  ],
  "base_commit": "512a09049d30e58d663f63966f7fdec7b4e963ad",
  "patch": "diff --git a/src/Interpreters/Context.cpp b/src/Interpreters/Context.cpp\nindex 6335748cdcfa..fe2cce62133b 100644\n--- a/src/Interpreters/Context.cpp\n+++ b/src/Interpreters/Context.cpp\n@@ -93,6 +93,7 @@\n #include <Interpreters/ClusterDiscovery.h>\n #include <Interpreters/TransactionLog.h>\n #include <filesystem>\n+#include <re2/re2.h>\n \n #if USE_ROCKSDB\n #include <rocksdb/table.h>\n@@ -708,7 +709,10 @@ void Context::setUserDefinedPath(const String & path)\n void Context::addWarningMessage(const String & msg) const\n {\n     auto lock = getLock();\n-    shared->addWarningMessage(msg);\n+    auto suppress_re = getConfigRef().getString(\"warning_supress_regexp\", \"\");\n+    bool is_supressed = !suppress_re.empty() && re2::RE2::PartialMatch(msg, suppress_re);\n+    if (!is_supressed)\n+        shared->addWarningMessage(msg);\n }\n \n void Context::setConfig(const ConfigurationPtr & config)\n",
  "test_patch": "diff --git a/tests/integration/test_log_levels_update/configs/log.xml b/tests/integration/test_log_levels_update/configs/log.xml\nindex a85417d05b81..d97b8a1570c7 100644\n--- a/tests/integration/test_log_levels_update/configs/log.xml\n+++ b/tests/integration/test_log_levels_update/configs/log.xml\n@@ -3,4 +3,5 @@\n         <level>trace</level>\n         <log>/var/log/clickhouse-server/clickhouse-server.log</log>\n     </logger>\n-</clickhouse>\n\\ No newline at end of file\n+    <warning_supress_regexp>It will work slowly\\.$</warning_supress_regexp>\n+</clickhouse>\ndiff --git a/tests/integration/test_log_levels_update/test.py b/tests/integration/test_log_levels_update/test.py\nindex b0c003ea4404..176733cd7cb6 100644\n--- a/tests/integration/test_log_levels_update/test.py\n+++ b/tests/integration/test_log_levels_update/test.py\n@@ -4,7 +4,9 @@\n from helpers.cluster import ClickHouseCluster\n \n cluster = ClickHouseCluster(__file__)\n-node = cluster.add_instance(\"node\", with_zookeeper=False)\n+node = cluster.add_instance(\n+    \"node\", with_zookeeper=False, main_configs=[\"configs/log.xml\"]\n+)\n \n config = \"\"\"<clickhouse>\n     <logger>\n@@ -30,21 +32,33 @@ def get_log(node):\n     )\n \n \n+def check_it_will_work_slowly(node, log):\n+    it_will_work_slowly = \"It will work slowly\"\n+    if node.is_built_with_sanitizer() or node.is_debug_build():\n+        # message still in logs\n+        re.search(f\"<Warning>.*{it_will_work_slowly}\", log)\n+    # but not in system.warnings\n+    query = f\"SELECT count() FROM system.warnings WHERE message ILIKE '%{it_will_work_slowly}%'\"\n+    assert 0 == int(node.query(query).strip())\n+\n+\n def test_log_levels_update(start_cluster):\n     # Make sure that there are enough log messages for the test\n-    for i in range(5):\n+    for _ in range(5):\n         node.query(\"SELECT 1\")\n \n     log = get_log(node)\n     assert re.search(\"(<Trace>|<Debug>)\", log)\n \n+    check_it_will_work_slowly(node, log)\n+\n     node.replace_config(\"/etc/clickhouse-server/config.d/log.xml\", config)\n     node.query(\"SYSTEM RELOAD CONFIG;\")\n     node.exec_in_container(\n         [\"bash\", \"-c\", \"> /var/log/clickhouse-server/clickhouse-server.log\"]\n     )\n \n-    for i in range(5):\n+    for _ in range(5):\n         node.query(\"SELECT 1\")\n \n     log = get_log(node)\n",
  "problem_statement": "Warning suppression mechanism\nI have ClickHouse server running in virtual environment that reports the following warning:\r\n\r\n```\r\n# clickhouse-client\r\nClickHouse client version 22.7.2.15 (official build).\r\nConnecting to localhost:9000 as user default.\r\nConnected to ClickHouse server version 22.7.2 revision 54457.\r\n\r\nWarnings:\r\n * Linux is not using a fast TSC clock source. Performance can be degraded. Check /sys/devices/system/clocksource/clocksource0/current_clocksource\r\n\r\n# cat /sys/devices/system/clocksource/clocksource0/current_clocksource\r\nkvm-clock\r\n```\r\n\r\nIt looks like a false positive as kvm-clock is considered a preferable clock source for kvm-based VMs.\r\nhttps://opensource.com/article/17/6/timekeeping-linux-vms\r\n\r\nRegardless of whether it's a bug or not, I'd like to have some mechanism that allows to disable particular warnings. There are may be other questionable warnings in the future.\r\n\n",
  "hints_text": "I prefer to not have any questionable warnings at all.",
  "created_at": "2022-08-23T15:47:16Z"
}