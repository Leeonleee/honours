{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 60181,
  "instance_id": "ClickHouse__ClickHouse-60181",
  "issue_numbers": [
    "60163"
  ],
  "base_commit": "9abd28625f138feb663fc8ef479a3022c49a4cbf",
  "patch": "diff --git a/src/IO/S3/Client.cpp b/src/IO/S3/Client.cpp\nindex 7f0ede727408..182e7ad18cd2 100644\n--- a/src/IO/S3/Client.cpp\n+++ b/src/IO/S3/Client.cpp\n@@ -27,7 +27,6 @@\n \n #include <base/sleep.h>\n \n-#include <algorithm>\n \n namespace ProfileEvents\n {\n@@ -48,7 +47,6 @@ namespace ErrorCodes\n {\n     extern const int LOGICAL_ERROR;\n     extern const int TOO_MANY_REDIRECTS;\n-    extern const int BAD_ARGUMENTS;\n }\n \n namespace S3\n@@ -106,19 +104,6 @@ void verifyClientConfiguration(const Aws::Client::ClientConfiguration & client_c\n     assert_cast<const Client::RetryStrategy &>(*client_config.retryStrategy);\n }\n \n-void validateCredentials(const Aws::Auth::AWSCredentials& auth_credentials)\n-{\n-    if (auth_credentials.GetAWSAccessKeyId().empty())\n-    {\n-        return;\n-    }\n-    /// Follow https://docs.aws.amazon.com/IAM/latest/APIReference/API_AccessKey.html\n-    if (!std::all_of(auth_credentials.GetAWSAccessKeyId().begin(), auth_credentials.GetAWSAccessKeyId().end(), isWordCharASCII))\n-    {\n-        throw Exception(ErrorCodes::BAD_ARGUMENTS, \"Access key id has an invalid character\");\n-    }\n-}\n-\n void addAdditionalAMZHeadersToCanonicalHeadersList(\n     Aws::AmazonWebServiceRequest & request,\n     const HTTPHeaderEntries & extra_headers\n@@ -144,7 +129,6 @@ std::unique_ptr<Client> Client::create(\n     const ClientSettings & client_settings)\n {\n     verifyClientConfiguration(client_configuration);\n-    validateCredentials(credentials_provider->GetAWSCredentials());\n     return std::unique_ptr<Client>(\n         new Client(max_redirects_, std::move(sse_kms_config_), credentials_provider, client_configuration, sign_payloads, client_settings));\n }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02966_s3_access_key_id_restriction.reference b/tests/queries/0_stateless/02966_s3_access_key_id_restriction.reference\ndeleted file mode 100644\nindex e69de29bb2d1..000000000000\ndiff --git a/tests/queries/0_stateless/02966_s3_access_key_id_restriction.sql b/tests/queries/0_stateless/02966_s3_access_key_id_restriction.sql\ndeleted file mode 100644\nindex c1ca0b4bcd50..000000000000\n--- a/tests/queries/0_stateless/02966_s3_access_key_id_restriction.sql\n+++ /dev/null\n@@ -1,6 +0,0 @@\n--- Tags: no-fasttest\n-\n-select * from s3('http://localhost:11111/test/a.tsv', '\\ninjection\\n', 'admin'); -- { serverError 36 }\n-select * from deltaLake('http://localhost:11111/test/a.tsv', '\\ninjection\\n', 'admin'); -- { serverError 36 }\n-select * from hudi('http://localhost:11111/test/a.tsv', '\\ninjection\\n', 'admin'); -- { serverError 36 }\n-select * from iceberg('http://localhost:11111/test/a.tsv', '\\ninjection\\n', 'admin'); -- { serverError 36 }\n",
  "problem_statement": "S3 Error:  Access key id has an invalid character after Udating to 24.1 - clickhouse won't startup anymore\nAfter upgrading our intance of clickhouse version  23.7.5.30 to the current  24.1 release clickhouse hangs dureing startup and terminates his startup routine.\r\n\r\nSome investigation brought us to the the result, that something shoul be wrong with the S3 connection to our minio service\r\n\r\n`Code: 36. DB::Exception: Access key id has an invalid character: Cannot attach table `\r\n\r\nWe checked everthing but could not find any suspect thing in the set-up.   \r\nAt the end we have to roll-back the version to get clickhouse up and running again.\r\nWith the same S3 setup everthing works as expeted and as it has before\r\n\r\n**Expected behavior**\r\n1. if clickhouse finds a problem with one or a few tables whilst loading, this should not interrupt the startup of the whole service\r\n* ist the a server-setting to control this behaviour ? if e.g. in version 23.7.5.30 is a problem with a S3 table, this only matters whilst trying to access the data.\r\n2. S3 connections should work as it did before \r\n\r\n**Error message and/or stacktrace**\r\n```\r\n2024.02.19 17:30:26.471919 [ 9718 ] {} <Error> Application: Caught exception while loading metadata: Code: 695. DB::Exception: Load job 'load table p_DIZ_analytics.DIZ23_003_Triagedaten' failed: \r\nCode: 36. DB::Exception: Access key id has an invalid character: Cannot attach table `p_DIZ_analytics`.`DIZ23_003_Triagedaten` \r\nfrom metadata file /opt/data/clickhouse/store/146/146e3b77-35ba-4602-80fb-c4ea4261c8fe/DIZ23_003_Triagedaten.sql from query \r\nATTACH TABLE p_DIZ_analytics.DIZ23_003_Triagedaten UUID '6770ff97-436d-40f1-89c3-237e64c6690c' (`patient_id` String, `start_date` DateTime64(3), `ukf_ou_id` String, `modifier_cd` String, \r\n`value_char` Nullable(String), `Jahr` UInt16, `concept_cd` String, `deleted` UInt8) ENGINE = S3('https://xxxxxxx:9000/diz-dataprojects/DIZ23-003_Triagedaten.csv', 'CSV'). \r\n(BAD_ARGUMENTS), Stack trace (when copying this message, always include the lines below):\r\n\r\n0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000c7faf9b in /usr/bin/clickhouse\r\n1. DB::Exception::Exception<>(int, FormatStringHelperImpl<>) @ 0x0000000007214283 in /usr/bin/clickhouse\r\n3. DB::S3::ClientFactory::create(DB::S3::PocoHTTPClientConfiguration const&, DB::S3::ClientSettings, String const&, String const&, String const&, DB::S3::ServerSideEncryptionKMSConfig, std::vector<DB::HTTPHeaderEntry, std::allocator<DB::HTTPHeaderEntry>>, DB::S3::CredentialsConfiguration, String const&) @ 0x00000000101283f4 in /usr/bin/clickhouse\r\n4. DB::StorageS3::Configuration::connect(std::shared_ptr<DB::Context const>) @ 0x0000000011fe0307 in /usr/bin/clickhouse\r\n5. DB::StorageS3::Configuration::update(std::shared_ptr<DB::Context const>) @ 0x0000000011fdeb11 in /usr/bin/clickhouse\r\n6. DB::StorageS3::updateConfiguration(std::shared_ptr<DB::Context const>) @ 0x0000000011fded87 in /usr/bin/clickhouse\r\n7. DB::StorageS3::StorageS3(DB::StorageS3::Configuration const&, std::shared_ptr<DB::Context const>, DB::StorageID const&, DB::ColumnsDescription const&, DB::ConstraintsDescription const&, String const&, std::optional<DB::FormatSettings>, bool, std::shared_ptr<DB::IAST>) @ 0x0000000011fd2e21 in /usr/bin/clickhouse\r\n8. std::shared_ptr<DB::IStorage> std::__function::__policy_invoker<std::shared_ptr<DB::IStorage> (DB::StorageFactory::Arguments const&)>::__call_impl<std::__function::__default_alloc_func<DB::registerStorageS3Impl(String const&, DB::StorageFactory&)::$_0, std::shared_ptr<DB::IStorage> (DB::StorageFactory::Arguments const&)>>(std::__function::__policy_storage const*, DB::StorageFactory::Arguments const&) (.llvm.8425286739849586231) @ 0x0000000011ff4b1f in /usr/bin/clickhouse\r\n9. DB::StorageFactory::get(DB::ASTCreateQuery const&, String const&, std::shared_ptr<DB::Context>, std::shared_ptr<DB::Context>, DB::ColumnsDescription const&, DB::ConstraintsDescription const&, bool) const @ 0x0000000011d63c1b in /usr/bin/clickhouse\r\n10. DB::createTableFromAST(DB::ASTCreateQuery, String const&, String const&, std::shared_ptr<DB::Context>, bool) @ 0x00000000109308d3 in /usr/bin/clickhouse\r\n11. DB::DatabaseOrdinary::loadTableFromMetadata(std::shared_ptr<DB::Context>, String const&, DB::QualifiedTableName const&, std::shared_ptr<DB::IAST> const&, DB::LoadingStrictnessLevel) @ 0x00000000109519dc in /usr/bin/clickhouse\r\n12. void std::__function::__policy_invoker<void (DB::AsyncLoader&, std::shared_ptr<DB::LoadJob> const&)>::__call_impl<std::__function::__default_alloc_func<DB::DatabaseOrdinary::loadTableFromMetadataAsync(DB::AsyncLoader&, std::unordered_set<std::shared_ptr<DB::LoadJob>, std::hash<std::shared_ptr<DB::LoadJob>>, std::equal_to<std::shared_ptr<DB::LoadJob>>, std::allocator<std::shared_ptr<DB::LoadJob>>>, std::shared_ptr<DB::Context>, String const&, DB::QualifiedTableName const&, std::shared_ptr<DB::IAST> const&, DB::LoadingStrictnessLevel)::$_0, void (DB::AsyncLoader&, std::shared_ptr<DB::LoadJob> const&)>>(std::__function::__policy_storage const*, DB::AsyncLoader&, std::shared_ptr<DB::LoadJob> const&) @ 0x000000001095a2f3 in /usr/bin/clickhouse\r\n13. void std::__function::__policy_invoker<void ()>::__call_impl<std::__function::__default_alloc_func<DB::AsyncLoader::spawn(DB::AsyncLoader::Pool&, std::unique_lock<std::mutex>&)::$_0, void ()>>(std::__function::__policy_storage const*) @ 0x000000000c95f346 in /usr/bin/clickhouse\r\n```\r\n\r\n**S3 region not set - warning**\r\nFurther investigation found following warning in the log \r\n\r\n```\r\n2024.02.20 09:12:38.974104 [ 28468 ] {} <Information> AWSClient: If the signature check failed. This could be because of a time skew. Attempting to adjust the signer.\r\n2024.02.20 09:12:38.974117 [ 28468 ] {} <Information> AWSClient: Request failed, now waiting 0 ms before attempting again.\r\n2024.02.20 09:12:38.998374 [ 11583 ] {} <Information> AWSClient: Response status: 400, Bad Request\r\n2024.02.20 09:12:38.998523 [ 11583 ] {} <Information> AWSClient: AWSErrorMarshaller: Encountered Unknown AWSError 'AuthorizationHeaderMalformed': The authorization header is malformed; the region is wrong; expecting 'us-west-2'.\r\n2024.02.20 09:12:38.998593 [ 11583 ] {} <Information> AWSClient: AWSXmlClient: HTTP response code: 400\r\nResolved remote host IP address: xxxxxxxxx:9000\r\nRequest ID: 17B583FDA0510D59\r\nException name: AuthorizationHeaderMalformed\r\nError message: Unable to parse ExceptionName: AuthorizationHeaderMalformed Message: The authorization header is malformed; the region is wrong; expecting 'us-west-2'.\r\n```\r\neven version 23.7.5.30 reports this error, everthing works fine. Maybe 24.1 handles this more strict, and the  `Access key id has an invalid character` is a misleading error text\r\n\r\n\r\n\n",
  "hints_text": "",
  "created_at": "2024-02-20T11:32:40Z"
}