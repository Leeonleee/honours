{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 39747,
  "instance_id": "ClickHouse__ClickHouse-39747",
  "issue_numbers": [
    "39693"
  ],
  "base_commit": "2bdc9265728c2b176498a691dc1d966172c42dfc",
  "patch": "diff --git a/src/Formats/JSONUtils.cpp b/src/Formats/JSONUtils.cpp\nindex 1ac587605169..7c94b1220968 100644\n--- a/src/Formats/JSONUtils.cpp\n+++ b/src/Formats/JSONUtils.cpp\n@@ -529,7 +529,12 @@ namespace JSONUtils\n             writeObjectStart(out, 2);\n \n             writeTitle<true>(\"name\", out, 3);\n-            writeDoubleQuoted(fields[i].name, out);\n+\n+            /// The field names are pre-escaped to be put into JSON string literal.\n+            writeChar('\"', out);\n+            writeString(fields[i].name, out);\n+            writeChar('\"', out);\n+\n             writeFieldDelimiter(out);\n             writeTitle<true>(\"type\", out, 3);\n             writeJSONString(fields[i].type->getName(), out, settings);\ndiff --git a/src/Processors/Formats/Impl/JSONRowOutputFormat.h b/src/Processors/Formats/Impl/JSONRowOutputFormat.h\nindex 3459cc1b7a6c..66b8d0f682e4 100644\n--- a/src/Processors/Formats/Impl/JSONRowOutputFormat.h\n+++ b/src/Processors/Formats/Impl/JSONRowOutputFormat.h\n@@ -72,7 +72,7 @@ class JSONRowOutputFormat : public IRowOutputFormat\n \n     size_t field_number = 0;\n     size_t row_count = 0;\n-    NamesAndTypes fields;\n+    NamesAndTypes fields;   /// The field names are pre-escaped to be put into JSON string literal.\n \n     Statistics statistics;\n     FormatSettings settings;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02375_double_escaping_json.reference b/tests/queries/0_stateless/02375_double_escaping_json.reference\nnew file mode 100644\nindex 000000000000..23dbe1a59dfc\n--- /dev/null\n+++ b/tests/queries/0_stateless/02375_double_escaping_json.reference\n@@ -0,0 +1,18 @@\n+{\n+\t\"meta\":\n+\t[\n+\t\t{\n+\t\t\t\"name\": \"\\\"\",\n+\t\t\t\"type\": \"String\"\n+\t\t}\n+\t],\n+\n+\t\"data\":\n+\t[\n+\t\t{\n+\t\t\t\"\\\"\": \"\\\\\"\n+\t\t}\n+\t],\n+\n+\t\"rows\": 1\n+}\ndiff --git a/tests/queries/0_stateless/02375_double_escaping_json.sql b/tests/queries/0_stateless/02375_double_escaping_json.sql\nnew file mode 100644\nindex 000000000000..ecfb24fca2e5\n--- /dev/null\n+++ b/tests/queries/0_stateless/02375_double_escaping_json.sql\n@@ -0,0 +1,1 @@\n+SELECT '\\\\' AS `\"` FORMAT JSON SETTINGS output_format_write_statistics = 0;\n",
  "problem_statement": "Inconsistent behavior of back-slash escaping in json format for meta and data \nReproducible on 22.7.1 and 22.6.1\r\n**How to reproduce**\r\n\r\nSELECT 1 AS `\\\\\"ph\"`\r\nFORMAT JSON\r\n\r\nQuery id: 0159c301-b91e-4b59-b8e1-840056d18ffb\r\n\r\n```\r\n{\r\n\t\"meta\":\r\n\t[\r\n\t\t{\r\n\t\t\t\"name\": \"\\\\\\\\\\\\\\\"ph\\\\\\\"\",\r\n\t\t\t\"type\": \"UInt8\"\r\n\t\t}\r\n\t],\r\n\r\n\t\"data\":\r\n\t[\r\n\t\t{\r\n\t\t\t\"\\\\\\\"ph\\\"\": 1\r\n\t\t}\r\n\r\n\t],\r\n\r\n\t\"rows\": 1,\r\n\r\n\t\"statistics\":\r\n\t{\r\n\t\t\"elapsed\": 0.000840535,\r\n\t\t\"rows_read\": 1,\r\n\t\t\"bytes_read\": 1\r\n\t}\r\n}\r\n```\r\nExpected result: column name in meta and data should be the same.\r\nActual result: They are not.\r\n\r\nIt used to work on 22.3.15 - Even though it has another issue back then.\n",
  "hints_text": "@ywangtht They are identical in your example: \r\n`\"\\\\\\\"ph\\\"\"`\r\nand\r\n`\"\\\\\\\"ph\\\"\"`\n@alexey-milovidov \r\nSorry, I pasted wrong output.\r\nI updated the output again.\nHere is a simpler example. Where is the additional \\\\ from in meta/name?\r\n\r\nSELECT 1 AS `\"ph\"`\r\nFORMAT JSON\r\n\r\nQuery id: c2e3ee74-74fc-4dce-ac9d-61a0d960ff34\r\n```\r\n\r\n{\r\n\t\"meta\":\r\n\t[\r\n\t\t{\r\n\t\t\t\"name\": \"\\\\\\\"ph\\\\\\\"\",\r\n\t\t\t\"type\": \"UInt8\"\r\n\t\t}\r\n\t],\r\n\r\n\t\"data\":\r\n\t[\r\n\t\t{\r\n\t\t\t\"\\\"ph\\\"\": 1\r\n\t\t}\r\n\r\n\t],\r\n\r\n\t\"rows\": 1,\r\n\r\n\t\"statistics\":\r\n\t{\r\n\t\t\"elapsed\": 0.000580457,\r\n\t\t\"rows_read\": 1,\r\n\t\t\"bytes_read\": 1\r\n\t}\r\n}\r\n```\nNote that there are back-ticks ` ` around column alias, but somehow github does not display them.\nYes, the field is double-escaped by mistake.",
  "created_at": "2022-07-30T21:58:03Z",
  "modified_files": [
    "src/Formats/JSONUtils.cpp",
    "src/Processors/Formats/Impl/JSONRowOutputFormat.h"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02375_double_escaping_json.reference",
    "b/tests/queries/0_stateless/02375_double_escaping_json.sql"
  ]
}