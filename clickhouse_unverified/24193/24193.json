{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 24193,
  "instance_id": "ClickHouse__ClickHouse-24193",
  "issue_numbers": [
    "24192"
  ],
  "base_commit": "cce0030d3914fa66736b5b2e5dd801d8333ae97b",
  "patch": "diff --git a/src/Storages/StorageMemory.cpp b/src/Storages/StorageMemory.cpp\nindex 289a17366bba..13d5df866bce 100644\n--- a/src/Storages/StorageMemory.cpp\n+++ b/src/Storages/StorageMemory.cpp\n@@ -311,8 +311,8 @@ void StorageMemory::mutate(const MutationCommands & commands, ContextPtr context\n         rows += buffer.rows();\n         bytes += buffer.bytes();\n     }\n-    total_size_bytes.store(rows, std::memory_order_relaxed);\n-    total_size_rows.store(bytes, std::memory_order_relaxed);\n+    total_size_bytes.store(bytes, std::memory_order_relaxed);\n+    total_size_rows.store(rows, std::memory_order_relaxed);\n     data.set(std::move(new_data));\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01497_mutation_support_for_storage_memory.reference b/tests/queries/0_stateless/01497_mutation_support_for_storage_memory.reference\nindex 5aaf21f91370..29777b0c05c0 100644\n--- a/tests/queries/0_stateless/01497_mutation_support_for_storage_memory.reference\n+++ b/tests/queries/0_stateless/01497_mutation_support_for_storage_memory.reference\n@@ -8,7 +8,9 @@\n 3\t3\n 4\t4\n 5\t5\n+5\n 2\t2\n 3\t3\n 4\t4\n 5\t5\n+4\ndiff --git a/tests/queries/0_stateless/01497_mutation_support_for_storage_memory.sql b/tests/queries/0_stateless/01497_mutation_support_for_storage_memory.sql\nindex 408487ed205f..0e2861b8e940 100644\n--- a/tests/queries/0_stateless/01497_mutation_support_for_storage_memory.sql\n+++ b/tests/queries/0_stateless/01497_mutation_support_for_storage_memory.sql\n@@ -13,8 +13,12 @@ ALTER TABLE defaults UPDATE n = 100 WHERE s = '1';\n \n SELECT * FROM defaults;\n \n+SELECT count(*) FROM defaults;\n+\n ALTER TABLE defaults DELETE WHERE n = 100;\n \n SELECT * FROM defaults;\n \n+SELECT count(*) FROM defaults;\n+\n DROP TABLE defaults;\n",
  "problem_statement": "Got wrong result when executing mutation on Memory table engine\nClickhouse version: 21.2.5.5\r\n\r\nGot wrong result when excuting mutation on Memory table engine.\r\n\r\n```sql\r\nCREATE TABLE mem_test(id Int64) ENGINE=Memory();\r\nINSERT INTO mem_test VALUES (1), (2), (3);\r\nALTER TABLE mem_test UPDATE id=4 WHERE id=1;\r\nSELECT count(*) FROM mem_test;\r\n\r\n\u250c\u2500count()\u2500\u2510\r\n\u2502      24 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\nSELECT * FROM mem_test;\r\n\r\n\u250c\u2500id\u2500\u2510\r\n\u2502  4 \u2502\r\n\u2502  2 \u2502\r\n\u2502  3 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2518\r\n\r\n3 rows in set. Elapsed: 0.001 sec.\r\n```\r\n\n",
  "hints_text": "",
  "created_at": "2021-05-17T10:26:11Z",
  "modified_files": [
    "src/Storages/StorageMemory.cpp"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/01497_mutation_support_for_storage_memory.reference",
    "tests/queries/0_stateless/01497_mutation_support_for_storage_memory.sql"
  ]
}