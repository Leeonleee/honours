{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 58533,
  "instance_id": "ClickHouse__ClickHouse-58533",
  "issue_numbers": [
    "31264"
  ],
  "base_commit": "ffe1872e23723fc7221b9b1f89238aacdf016fb1",
  "patch": "diff --git a/docs/en/engines/table-engines/mergetree-family/mergetree.md b/docs/en/engines/table-engines/mergetree-family/mergetree.md\nindex f185c11bab37..228b2c8884f4 100644\n--- a/docs/en/engines/table-engines/mergetree-family/mergetree.md\n+++ b/docs/en/engines/table-engines/mergetree-family/mergetree.md\n@@ -870,6 +870,11 @@ Tags:\n - `load_balancing` - Policy for disk balancing, `round_robin` or `least_used`.\n - `least_used_ttl_ms` - Configure timeout (in milliseconds) for the updating available space on all disks (`0` - update always, `-1` - never update, default is `60000`). Note, if the disk can be used by ClickHouse only and is not subject to a online filesystem resize/shrink you can use `-1`, in all other cases it is not recommended, since eventually it will lead to incorrect space distribution.\n - `prefer_not_to_merge` \u2014 You should not use this setting. Disables merging of data parts on this volume (this is harmful and leads to performance degradation). When this setting is enabled (don't do it), merging data on this volume is not allowed (which is bad). This allows (but you don't need it) controlling (if you want to control something, you're making a mistake) how ClickHouse works with slow disks (but ClickHouse knows better, so please don't use this setting).\n+- `volume_priority` \u2014 Defines the priority (order) in which volumes are filled. Lower value means higher priority. The parameter values should be natural numbers and collectively cover the range from 1 to N (lowest priority given) without skipping any numbers.\n+  * If _all_ volumes are tagged, they are prioritized in given order.\n+  * If only _some_ volumes are tagged, those without the tag have the lowest priority, and they are prioritized in the order they are defined in config.\n+  * If _no_ volumes are tagged, their priority is set correspondingly to their order they are declared in configuration.\n+  * Two volumes cannot have the same priority value.\n \n Configuration examples:\n \n@@ -919,7 +924,8 @@ In given example, the `hdd_in_order` policy implements the [round-robin](https:/\n If there are different kinds of disks available in the system, `moving_from_ssd_to_hdd` policy can be used instead. The volume `hot` consists of an SSD disk (`fast_ssd`), and the maximum size of a part that can be stored on this volume is 1GB. All the parts with the size larger than 1GB will be stored directly on the `cold` volume, which contains an HDD disk `disk1`.\n Also, once the disk `fast_ssd` gets filled by more than 80%, data will be transferred to the `disk1` by a background process.\n \n-The order of volume enumeration within a storage policy is important. Once a volume is overfilled, data are moved to the next one. The order of disk enumeration is important as well because data are stored on them in turns.\n+The order of volume enumeration within a storage policy is important in case at least one of the volumes listed has no explicit `volume_priority` parameter.\n+Once a volume is overfilled, data are moved to the next one. The order of disk enumeration is important as well because data are stored on them in turns.\n \n When creating a table, one can apply one of the configured storage policies to it:\n \ndiff --git a/docs/ru/engines/table-engines/mergetree-family/mergetree.md b/docs/ru/engines/table-engines/mergetree-family/mergetree.md\nindex 9f223157ea77..faa492d4d85a 100644\n--- a/docs/ru/engines/table-engines/mergetree-family/mergetree.md\n+++ b/docs/ru/engines/table-engines/mergetree-family/mergetree.md\n@@ -679,11 +679,20 @@ TTL d + INTERVAL 1 MONTH GROUP BY k1, k2 SET x = max(x), y = min(y);\n \n \u0422\u044d\u0433\u0438:\n \n--   `policy_name_N` \u2014 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0438. \u041d\u0430\u0437\u0432\u0430\u043d\u0438\u044f \u043f\u043e\u043b\u0438\u0442\u0438\u043a \u0434\u043e\u043b\u0436\u043d\u044b \u0431\u044b\u0442\u044c \u0443\u043d\u0438\u043a\u0430\u043b\u044c\u043d\u044b.\n--   `volume_name_N` \u2014 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u0442\u043e\u043c\u0430. \u041d\u0430\u0437\u0432\u0430\u043d\u0438\u044f \u0442\u043e\u043c\u043e\u0432 \u0434\u043e\u043b\u0436\u043d\u044b \u0431\u044b\u0442\u044c \u0443\u043d\u0438\u043a\u0430\u043b\u044c\u043d\u044b.\n--   `disk` \u2014 \u0434\u0438\u0441\u043a, \u043d\u0430\u0445\u043e\u0434\u044f\u0449\u0438\u0439\u0441\u044f \u0432\u043d\u0443\u0442\u0440\u0438 \u0442\u043e\u043c\u0430.\n--   `max_data_part_size_bytes` \u2014 \u043c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u043a\u0443\u0441\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u043c\u043e\u0436\u0435\u0442 \u043d\u0430\u0445\u043e\u0434\u0438\u0442\u044c\u0441\u044f \u043d\u0430 \u043b\u044e\u0431\u043e\u043c \u0438\u0437 \u0434\u0438\u0441\u043a\u043e\u0432 \u044d\u0442\u043e\u0433\u043e \u0442\u043e\u043c\u0430. \u0415\u0441\u043b\u0438 \u0432 \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442\u0435 \u0441\u043b\u0438\u044f\u043d\u0438\u044f \u0440\u0430\u0437\u043c\u0435\u0440 \u043a\u0443\u0441\u043a\u0430 \u043e\u0436\u0438\u0434\u0430\u0435\u0442\u0441\u044f \u0431\u043e\u043b\u044c\u0448\u0435, \u0447\u0435\u043c max_data_part_size_bytes, \u0442\u043e \u044d\u0442\u043e\u0442 \u043a\u0443\u0441\u043e\u043a \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043f\u0438\u0441\u0430\u043d \u0432 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0439 \u0442\u043e\u043c. \u0412 \u043e\u0441\u043d\u043e\u0432\u043d\u043e\u043c \u044d\u0442\u0430 \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u0435\u0442 \u0445\u0440\u0430\u043d\u0438\u0442\u044c \u043d\u043e\u0432\u044b\u0435 / \u043c\u0435\u043b\u043a\u0438\u0435 \u043a\u0443\u0441\u043a\u0438 \u043d\u0430 \u0433\u043e\u0440\u044f\u0447\u0435\u043c (SSD) \u0442\u043e\u043c\u0435 \u0438 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0430\u0442\u044c \u0438\u0445 \u043d\u0430 \u0445\u043e\u043b\u043e\u0434\u043d\u044b\u0439 (HDD) \u0442\u043e\u043c, \u043a\u043e\u0433\u0434\u0430 \u043e\u043d\u0438 \u0434\u043e\u0441\u0442\u0438\u0433\u0430\u044e\u0442 \u0431\u043e\u043b\u044c\u0448\u043e\u0433\u043e \u0440\u0430\u0437\u043c\u0435\u0440\u0430. \u041d\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439\u0442\u0435 \u044d\u0442\u043e\u0442 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440, \u0435\u0441\u043b\u0438 \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0430 \u0438\u043c\u0435\u0435\u0442 \u0442\u043e\u043b\u044c\u043a\u043e \u043e\u0434\u0438\u043d \u0442\u043e\u043c.\n--   `move_factor` \u2014 \u0434\u043e\u043b\u044f \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e\u0433\u043e \u0441\u0432\u043e\u0431\u043e\u0434\u043d\u043e\u0433\u043e \u043c\u0435\u0441\u0442\u0430 \u043d\u0430 \u0442\u043e\u043c\u0435, \u0435\u0441\u043b\u0438 \u043c\u0435\u0441\u0442\u0430 \u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u0441\u044f \u043c\u0435\u043d\u044c\u0448\u0435, \u0442\u043e \u0434\u0430\u043d\u043d\u044b\u0435 \u043d\u0430\u0447\u043d\u0443\u0442 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u0438\u0435 \u043d\u0430 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0439 \u0442\u043e\u043c, \u0435\u0441\u043b\u0438 \u043e\u043d \u0435\u0441\u0442\u044c (\u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e 0.1). \u0414\u043b\u044f \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u0438\u044f \u043a\u0443\u0441\u043a\u0438 \u0441\u043e\u0440\u0442\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u043f\u043e \u0440\u0430\u0437\u043c\u0435\u0440\u0443 \u043e\u0442 \u0431\u043e\u043b\u044c\u0448\u0435\u0433\u043e \u043a \u043c\u0435\u043d\u044c\u0448\u0435\u043c\u0443 (\u043f\u043e \u0443\u0431\u044b\u0432\u0430\u043d\u0438\u044e) \u0438 \u0432\u044b\u0431\u0438\u0440\u0430\u044e\u0442\u0441\u044f \u043a\u0443\u0441\u043a\u0438, \u0441\u043e\u0432\u043e\u043a\u0443\u043f\u043d\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u043a\u043e\u0442\u043e\u0440\u044b\u0445 \u0434\u043e\u0441\u0442\u0430\u0442\u043e\u0447\u0435\u043d \u0434\u043b\u044f \u0441\u043e\u0431\u043b\u044e\u0434\u0435\u043d\u0438\u044f \u0443\u0441\u043b\u043e\u0432\u0438\u044f `move_factor`, \u0435\u0441\u043b\u0438 \u0441\u043e\u0432\u043e\u043a\u0443\u043f\u043d\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u0432\u0441\u0435\u0445 \u043f\u0430\u0440\u0442\u043e\u0432 \u043d\u0435\u0434\u043e\u0441\u0442\u0430\u0442\u043e\u0447\u0435\u043d, \u0431\u0443\u0434\u0443\u0442 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u044b \u0432\u0441\u0435 \u043f\u0430\u0440\u0442\u044b.\n+- `policy_name_N` \u2014 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0438. \u041d\u0430\u0437\u0432\u0430\u043d\u0438\u044f \u043f\u043e\u043b\u0438\u0442\u0438\u043a \u0434\u043e\u043b\u0436\u043d\u044b \u0431\u044b\u0442\u044c \u0443\u043d\u0438\u043a\u0430\u043b\u044c\u043d\u044b.\n+- `volume_name_N` \u2014 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u0442\u043e\u043c\u0430. \u041d\u0430\u0437\u0432\u0430\u043d\u0438\u044f \u0442\u043e\u043c\u043e\u0432 \u0434\u043e\u043b\u0436\u043d\u044b \u0431\u044b\u0442\u044c \u0443\u043d\u0438\u043a\u0430\u043b\u044c\u043d\u044b.\n+- `disk` \u2014 \u0434\u0438\u0441\u043a, \u043d\u0430\u0445\u043e\u0434\u044f\u0449\u0438\u0439\u0441\u044f \u0432\u043d\u0443\u0442\u0440\u0438 \u0442\u043e\u043c\u0430.\n+- `max_data_part_size_bytes` \u2014 \u043c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u043a\u0443\u0441\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u043c\u043e\u0436\u0435\u0442 \u043d\u0430\u0445\u043e\u0434\u0438\u0442\u044c\u0441\u044f \u043d\u0430 \u043b\u044e\u0431\u043e\u043c \u0438\u0437 \u0434\u0438\u0441\u043a\u043e\u0432 \u044d\u0442\u043e\u0433\u043e \u0442\u043e\u043c\u0430. \u0415\u0441\u043b\u0438 \u0432 \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442\u0435 \u0441\u043b\u0438\u044f\u043d\u0438\u044f \u0440\u0430\u0437\u043c\u0435\u0440 \u043a\u0443\u0441\u043a\u0430 \u043e\u0436\u0438\u0434\u0430\u0435\u0442\u0441\u044f \u0431\u043e\u043b\u044c\u0448\u0435, \u0447\u0435\u043c max_data_part_size_bytes, \u0442\u043e \u044d\u0442\u043e\u0442 \u043a\u0443\u0441\u043e\u043a \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043f\u0438\u0441\u0430\u043d \u0432 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0439 \u0442\u043e\u043c. \u0412 \u043e\u0441\u043d\u043e\u0432\u043d\u043e\u043c \u044d\u0442\u0430 \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u0435\u0442 \u0445\u0440\u0430\u043d\u0438\u0442\u044c \u043d\u043e\u0432\u044b\u0435 / \u043c\u0435\u043b\u043a\u0438\u0435 \u043a\u0443\u0441\u043a\u0438 \u043d\u0430 \u0433\u043e\u0440\u044f\u0447\u0435\u043c (SSD) \u0442\u043e\u043c\u0435 \u0438 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0430\u0442\u044c \u0438\u0445 \u043d\u0430 \u0445\u043e\u043b\u043e\u0434\u043d\u044b\u0439 (HDD) \u0442\u043e\u043c, \u043a\u043e\u0433\u0434\u0430 \u043e\u043d\u0438 \u0434\u043e\u0441\u0442\u0438\u0433\u0430\u044e\u0442 \u0431\u043e\u043b\u044c\u0448\u043e\u0433\u043e \u0440\u0430\u0437\u043c\u0435\u0440\u0430. \u041d\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439\u0442\u0435 \u044d\u0442\u043e\u0442 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440, \u0435\u0441\u043b\u0438 \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0430 \u0438\u043c\u0435\u0435\u0442 \u0442\u043e\u043b\u044c\u043a\u043e \u043e\u0434\u0438\u043d \u0442\u043e\u043c.\n+- `move_factor` \u2014 \u0434\u043e\u043b\u044f \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e\u0433\u043e \u0441\u0432\u043e\u0431\u043e\u0434\u043d\u043e\u0433\u043e \u043c\u0435\u0441\u0442\u0430 \u043d\u0430 \u0442\u043e\u043c\u0435, \u0435\u0441\u043b\u0438 \u043c\u0435\u0441\u0442\u0430 \u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u0441\u044f \u043c\u0435\u043d\u044c\u0448\u0435, \u0442\u043e \u0434\u0430\u043d\u043d\u044b\u0435 \u043d\u0430\u0447\u043d\u0443\u0442 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u0438\u0435 \u043d\u0430 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0439 \u0442\u043e\u043c, \u0435\u0441\u043b\u0438 \u043e\u043d \u0435\u0441\u0442\u044c (\u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e 0.1). \u0414\u043b\u044f \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u0438\u044f \u043a\u0443\u0441\u043a\u0438 \u0441\u043e\u0440\u0442\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u043f\u043e \u0440\u0430\u0437\u043c\u0435\u0440\u0443 \u043e\u0442 \u0431\u043e\u043b\u044c\u0448\u0435\u0433\u043e \u043a \u043c\u0435\u043d\u044c\u0448\u0435\u043c\u0443 (\u043f\u043e \u0443\u0431\u044b\u0432\u0430\u043d\u0438\u044e) \u0438 \u0432\u044b\u0431\u0438\u0440\u0430\u044e\u0442\u0441\u044f \u043a\u0443\u0441\u043a\u0438, \u0441\u043e\u0432\u043e\u043a\u0443\u043f\u043d\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u043a\u043e\u0442\u043e\u0440\u044b\u0445 \u0434\u043e\u0441\u0442\u0430\u0442\u043e\u0447\u0435\u043d \u0434\u043b\u044f \u0441\u043e\u0431\u043b\u044e\u0434\u0435\u043d\u0438\u044f \u0443\u0441\u043b\u043e\u0432\u0438\u044f `move_factor`, \u0435\u0441\u043b\u0438 \u0441\u043e\u0432\u043e\u043a\u0443\u043f\u043d\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u0432\u0441\u0435\u0445 \u043f\u0430\u0440\u0442\u043e\u0432 \u043d\u0435\u0434\u043e\u0441\u0442\u0430\u0442\u043e\u0447\u0435\u043d, \u0431\u0443\u0434\u0443\u0442 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u044b \u0432\u0441\u0435 \u043f\u0430\u0440\u0442\u044b.\n+- `perform_ttl_move_on_insert` \u2014 \u043e\u0442\u043a\u043b\u044e\u0447\u0430\u0435\u0442 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u0438\u0435 \u0434\u0430\u043d\u043d\u044b\u0445 \u0441 \u0438\u0441\u0442\u0435\u043a\u0448\u0438\u043c TTL \u043f\u0440\u0438 \u0432\u0441\u0442\u0430\u0432\u043a\u0435. \u041f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e (\u0435\u0441\u043b\u0438 \u0432\u043a\u043b\u044e\u0447\u0435\u043d\u043e), \u0435\u0441\u043b\u0438 \u043c\u044b \u0432\u0441\u0442\u0430\u0432\u043b\u044f\u0435\u043c \u0447\u0430\u0441\u0442\u044c \u0434\u0430\u043d\u043d\u044b\u0445, \u043a\u043e\u0442\u043e\u0440\u0430\u044f \u0443\u0436\u0435 \u043f\u0440\u043e\u0441\u0440\u043e\u0447\u0438\u043b\u0430\u0441\u044c \u043f\u043e \u043f\u0440\u0430\u0432\u0438\u043b\u0443 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u0438\u044f \u043f\u043e \u0441\u0440\u043e\u043a\u0443 \u0436\u0438\u0437\u043d\u0438, \u043e\u043d\u0430 \u043d\u0435\u043c\u0435\u0434\u043b\u0435\u043d\u043d\u043e \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0430\u0435\u0442\u0441\u044f \u043d\u0430 \u0442\u043e\u043c / \u0434\u0438\u0441\u043a, \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u044b\u0439 \u0432 \u043f\u0440\u0430\u0432\u0438\u043b\u0435 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u0438\u044f. \u042d\u0442\u043e \u043c\u043e\u0436\u0435\u0442 \u0437\u043d\u0430\u0447\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0437\u0430\u043c\u0435\u0434\u043b\u0438\u0442\u044c \u0432\u0441\u0442\u0430\u0432\u043a\u0443 \u0432 \u0441\u043b\u0443\u0447\u0430\u0435, \u0435\u0441\u043b\u0438 \u0446\u0435\u043b\u0435\u0432\u043e\u0439 \u0442\u043e\u043c / \u0434\u0438\u0441\u043a \u043c\u0435\u0434\u043b\u0435\u043d\u043d\u044b\u0439 (\u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440, S3). \u0415\u0441\u043b\u0438 \u043e\u0442\u043a\u043b\u044e\u0447\u0435\u043d\u043e, \u0442\u043e \u043f\u0440\u043e\u0441\u0440\u043e\u0447\u0435\u043d\u043d\u0430\u044f \u0447\u0430\u0441\u0442\u044c \u0434\u0430\u043d\u043d\u044b\u0445 \u0437\u0430\u043f\u0438\u0441\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043d\u0430 \u0442\u043e\u043c \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e, \u0430 \u0437\u0430\u0442\u0435\u043c \u0441\u0440\u0430\u0437\u0443 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0430\u0435\u0442\u0441\u044f \u043d\u0430 \u0442\u043e\u043c, \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u044b\u0439 \u0432 \u043f\u0440\u0430\u0432\u0438\u043b\u0435 \u0434\u043b\u044f \u0438\u0441\u0442\u0451\u043a\u0448\u0435\u0433\u043e TTL.\n+- `load_balancing` - \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0430 \u0431\u0430\u043b\u0430\u043d\u0441\u0438\u0440\u043e\u0432\u043a\u0438 \u0434\u0438\u0441\u043a\u043e\u0432, `round_robin` \u0438\u043b\u0438 `least_used`.\n+- `least_used_ttl_ms` - \u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442 \u0442\u0430\u0439\u043c\u0430\u0443\u0442 (\u0432 \u043c\u0438\u043b\u043b\u0438\u0441\u0435\u043a\u0443\u043d\u0434\u0430\u0445) \u0434\u043b\u044f \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u044f \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e\u0433\u043e \u043f\u0440\u043e\u0441\u0442\u0440\u0430\u043d\u0441\u0442\u0432\u0430 \u043d\u0430 \u0432\u0441\u0435\u0445 \u0434\u0438\u0441\u043a\u0430\u0445 (`0` - \u043e\u0431\u043d\u043e\u0432\u043b\u044f\u0442\u044c \u0432\u0441\u0435\u0433\u0434\u0430, `-1` - \u043d\u0438\u043a\u043e\u0433\u0434\u0430 \u043d\u0435 \u043e\u0431\u043d\u043e\u0432\u043b\u044f\u0442\u044c, \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e - `60000`). \u041e\u0431\u0440\u0430\u0442\u0438\u0442\u0435 \u0432\u043d\u0438\u043c\u0430\u043d\u0438\u0435, \u0435\u0441\u043b\u0438 \u0434\u0438\u0441\u043a \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0441\u044f \u0442\u043e\u043b\u044c\u043a\u043e ClickHouse \u0438 \u043d\u0435 \u0431\u0443\u0434\u0435\u0442 \u043f\u043e\u0434\u0432\u0435\u0440\u0433\u0430\u0442\u044c\u0441\u044f \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044e \u0440\u0430\u0437\u043c\u0435\u0440\u043e\u0432 \u0444\u0430\u0439\u043b\u043e\u0432\u043e\u0439 \u0441\u0438\u0441\u0442\u0435\u043c\u044b \u043d\u0430 \u043b\u0435\u0442\u0443, \u043c\u043e\u0436\u043d\u043e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 `-1`. \u0412\u043e \u0432\u0441\u0435\u0445 \u043e\u0441\u0442\u0430\u043b\u044c\u043d\u044b\u0445 \u0441\u043b\u0443\u0447\u0430\u044f\u0445 \u044d\u0442\u043e \u043d\u0435 \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0443\u0435\u0442\u0441\u044f, \u0442\u0430\u043a \u043a\u0430\u043a \u0432 \u043a\u043e\u043d\u0435\u0447\u043d\u043e\u043c \u0438\u0442\u043e\u0433\u0435 \u044d\u0442\u043e \u043f\u0440\u0438\u0432\u0435\u0434\u0435\u0442 \u043a \u043d\u0435\u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u043e\u043c\u0443 \u0440\u0430\u0441\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u044e \u043f\u0440\u043e\u0441\u0442\u0440\u0430\u043d\u0441\u0442\u0432\u0430.\n+- `prefer_not_to_merge` \u2014 \u044d\u0442\u0443 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0443 \u043b\u0443\u0447\u0448\u0435 \u043d\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c. \u041e\u043d\u0430 \u043e\u0442\u043a\u043b\u044e\u0447\u0430\u0435\u0442 \u0441\u043b\u0438\u044f\u043d\u0438\u0435 \u0447\u0430\u0441\u0442\u0435\u0439 \u0434\u0430\u043d\u043d\u044b\u0445 \u043d\u0430 \u044d\u0442\u043e\u043c \u0442\u043e\u043c\u0435 (\u0447\u0442\u043e \u043f\u043e\u0442\u0435\u043d\u0446\u0438\u0430\u043b\u044c\u043d\u043e \u0432\u0440\u0435\u0434\u043d\u043e \u0438 \u043c\u043e\u0436\u0435\u0442 \u043f\u0440\u0438\u0432\u0435\u0441\u0442\u0438 \u043a \u0437\u0430\u043c\u0435\u0434\u043b\u0435\u043d\u0438\u044e). \u041a\u043e\u0433\u0434\u0430 \u044d\u0442\u0430 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 \u0432\u043a\u043b\u044e\u0447\u0435\u043d\u0430 (\u043d\u0435 \u0434\u0435\u043b\u0430\u0439\u0442\u0435 \u044d\u0442\u043e\u0433\u043e), \u043e\u0431\u044a\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u0435 \u0434\u0430\u043d\u043d\u044b\u0445 \u043d\u0430 \u044d\u0442\u043e\u043c \u0442\u043e\u043c\u0435 \u0437\u0430\u043f\u0440\u0435\u0449\u0435\u043d\u043e (\u0447\u0442\u043e \u043f\u043b\u043e\u0445\u043e). \u042d\u0442\u043e \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u0435\u0442 (\u043d\u043e \u0432\u0430\u043c \u044d\u0442\u043e \u043d\u0435 \u043d\u0443\u0436\u043d\u043e) \u043a\u043e\u043d\u0442\u0440\u043e\u043b\u0438\u0440\u043e\u0432\u0430\u0442\u044c (\u0435\u0441\u043b\u0438 \u0432\u044b \u0445\u043e\u0442\u0438\u0442\u0435 \u0447\u0442\u043e-\u0442\u043e \u043a\u043e\u043d\u0442\u0440\u043e\u043b\u0438\u0440\u043e\u0432\u0430\u0442\u044c, \u0432\u044b \u0434\u0435\u043b\u0430\u0435\u0442\u0435 \u043e\u0448\u0438\u0431\u043a\u0443), \u043a\u0430\u043a ClickHouse \u0432\u0437\u0430\u0438\u043c\u043e\u0434\u0435\u0439\u0441\u0442\u0432\u0443\u0435\u0442 \u0441 \u043c\u0435\u0434\u043b\u0435\u043d\u043d\u044b\u043c\u0438 \u0434\u0438\u0441\u043a\u0430\u043c\u0438 (\u043d\u043e ClickHouse \u043b\u0443\u0447\u0448\u0435 \u0437\u043d\u0430\u0435\u0442, \u043f\u043e\u044d\u0442\u043e\u043c\u0443, \u043f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430, \u043d\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439\u0442\u0435 \u044d\u0442\u0443 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0443).\n+- `volume_priority` \u2014 \u041e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u0442 \u043f\u0440\u0438\u043e\u0440\u0438\u0442\u0435\u0442 (\u043f\u043e\u0440\u044f\u0434\u043e\u043a), \u0432 \u043a\u043e\u0442\u043e\u0440\u043e\u043c \u0437\u0430\u043f\u043e\u043b\u043d\u044f\u044e\u0442\u0441\u044f \u0442\u043e\u043c\u0430. \u0427\u0435\u043c \u043c\u0435\u043d\u044c\u0448\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 -- \u0442\u0435\u043c \u0432\u044b\u0448\u0435 \u043f\u0440\u0438\u043e\u0440\u0438\u0442\u0435\u0442. \u0417\u043d\u0430\u0447\u0435\u043d\u0438\u044f \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u0430 \u0434\u043e\u043b\u0436\u043d\u044b \u0431\u044b\u0442\u044c \u043d\u0430\u0442\u0443\u0440\u0430\u043b\u044c\u043d\u044b\u043c\u0438 \u0447\u0438\u0441\u043b\u0430\u043c\u0438 \u0438 \u043e\u0445\u0432\u0430\u0442\u044b\u0432\u0430\u0442\u044c \u0434\u0438\u0430\u043f\u0430\u0437\u043e\u043d \u043e\u0442 1 \u0434\u043e N (N - \u043d\u0430\u0438\u0431\u043e\u043b\u044c\u0448\u0435\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u0430 \u0438\u0437 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u044b\u0445) \u0431\u0435\u0437 \u043f\u0440\u043e\u043f\u0443\u0441\u043a\u043e\u0432.\n+  * \u0415\u0441\u043b\u0438 _\u0432\u0441\u0435_ \u0442\u043e\u043c\u0430 \u0438\u043c\u0435\u044e\u0442 \u044d\u0442\u043e\u0442 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440, \u043e\u043d\u0438 \u043f\u0440\u0438\u043e\u0440\u0438\u0442\u0438\u0437\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u0432 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u043c \u043f\u043e\u0440\u044f\u0434\u043a\u0435.\n+  * \u0415\u0441\u043b\u0438 \u0435\u0433\u043e \u0438\u043c\u0435\u044e\u0442 \u043b\u0438\u0448\u044c _\u043d\u0435\u043a\u043e\u0442\u043e\u0440\u044b\u0435_, \u0442\u043e \u043d\u0435 \u0438\u043c\u0435\u044e\u0449\u0438\u0435 \u044d\u0442\u043e\u0433\u043e \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u0430 \u0442\u043e\u043c\u0430 \u0438\u043c\u0435\u044e\u0442 \u0441\u0430\u043c\u044b\u0439 \u043d\u0438\u0437\u043a\u0438\u0439 \u043f\u0440\u0438\u043e\u0440\u0438\u0442\u0435\u0442. \u0422\u0435, \u0443 \u043a\u043e\u0442\u043e\u0440\u044b\u0445 \u043e\u043d \u0443\u043a\u0430\u0437\u0430\u043d, \u043f\u0440\u0438\u043e\u0440\u0438\u0442\u0438\u0437\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u0432 \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0438\u0438 \u0441\u043e \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435\u043c \u0442\u0435\u0433\u0430, \u043f\u0440\u0438\u043e\u0440\u0438\u0442\u0435\u0442 \u043e\u0441\u0442\u0430\u043b\u044c\u043d\u044b\u0445 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u0442\u0441\u044f \u043f\u043e\u0440\u044f\u0434\u043a\u043e\u043c \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f \u0432 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u043e\u043d\u043d\u043e\u043c \u0444\u0430\u0439\u043b\u0435 \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0434\u0440\u0443\u0433 \u0434\u0440\u0443\u0433\u0430.\n+  * \u0415\u0441\u043b\u0438 _\u043d\u0438 \u043e\u0434\u043d\u043e\u043c\u0443_ \u0442\u043e\u043c\u0443 \u043d\u0435 \u043f\u0440\u0438\u0441\u0432\u043e\u0435\u043d \u044d\u0442\u043e\u0442 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440, \u0438\u0445 \u043f\u043e\u0440\u044f\u0434\u043e\u043a \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u0442\u0441\u044f \u043f\u043e\u0440\u044f\u0434\u043a\u043e\u043c \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f \u0432 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u043e\u043d\u043d\u043e\u043c \u0444\u0430\u0439\u043b\u0435.\n+  * \u041f\u0440\u0438\u043e\u0440\u0438\u0442\u0435\u0442 \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u0438\u0445 \u0442\u043e\u043c\u043e\u0432 \u043d\u0435 \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u043e\u0434\u0438\u043d\u0430\u043a\u043e\u0432\u044b\u043c.\n \n \u041f\u0440\u0438\u043c\u0435\u0440\u044b \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0439:\n \n@@ -733,7 +742,7 @@ TTL d + INTERVAL 1 MONTH GROUP BY k1, k2 SET x = max(x), y = min(y);\n \n \u0415\u0441\u043b\u0438 \u0441\u0438\u0441\u0442\u0435\u043c\u0430 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 \u0434\u0438\u0441\u043a\u0438 \u0440\u0430\u0437\u043b\u0438\u0447\u043d\u044b\u0445 \u0442\u0438\u043f\u043e\u0432, \u0442\u043e \u043c\u043e\u0436\u0435\u0442 \u043f\u0440\u0438\u0433\u043e\u0434\u0438\u0442\u044c\u0441\u044f \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0430 `moving_from_ssd_to_hdd`. \u0412 \u0442\u043e\u043c\u0435 `hot` \u043d\u0430\u0445\u043e\u0434\u0438\u0442\u0441\u044f \u043e\u0434\u0438\u043d SSD-\u0434\u0438\u0441\u043a (`fast_ssd`), \u0430 \u0442\u0430\u043a\u0436\u0435 \u0437\u0430\u0434\u0430\u0435\u0442\u0441\u044f \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 \u043d\u0430 \u043c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u043a\u0443\u0441\u043a\u0430, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u043c\u043e\u0436\u0435\u0442 \u0445\u0440\u0430\u043d\u0438\u0442\u044c\u0441\u044f \u043d\u0430 \u044d\u0442\u043e\u043c \u0442\u043e\u043c\u0435 (1GB). \u0412\u0441\u0435 \u043a\u0443\u0441\u043a\u0438 \u0442\u0430\u043a\u043e\u0439 \u0442\u0430\u0431\u043b\u0438\u0446\u044b \u0431\u043e\u043b\u044c\u0448\u0435 1GB \u0431\u0443\u0434\u0443\u0442 \u0437\u0430\u043f\u0438\u0441\u044b\u0432\u0430\u0442\u044c\u0441\u044f \u0441\u0440\u0430\u0437\u0443 \u043d\u0430 \u0442\u043e\u043c `cold`, \u0432 \u043a\u043e\u0442\u043e\u0440\u043e\u043c \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442\u0441\u044f \u043e\u0434\u0438\u043d HDD-\u0434\u0438\u0441\u043a `disk1`. \u0422\u0430\u043a\u0436\u0435 \u043f\u0440\u0438 \u0437\u0430\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0438 \u0434\u0438\u0441\u043a\u0430 `fast_ssd` \u0431\u043e\u043b\u0435\u0435 \u0447\u0435\u043c \u043d\u0430 80% \u0434\u0430\u043d\u043d\u044b\u0435 \u0431\u0443\u0434\u0443\u0442 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0438\u0442\u044c\u0441\u044f \u043d\u0430 \u0434\u0438\u0441\u043a `disk1` \u0444\u043e\u043d\u043e\u0432\u044b\u043c \u043f\u0440\u043e\u0446\u0435\u0441\u0441\u043e\u043c.\n \n-\u041f\u043e\u0440\u044f\u0434\u043e\u043a \u0442\u043e\u043c\u043e\u0432 \u0432 \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0430\u0445 \u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f \u0432\u0430\u0436\u0435\u043d, \u043f\u0440\u0438 \u0434\u043e\u0441\u0442\u0438\u0436\u0435\u043d\u0438\u0438 \u0443\u0441\u043b\u043e\u0432\u0438\u0439 \u043d\u0430 \u043f\u0435\u0440\u0435\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0435 \u0442\u043e\u043c\u0430 \u0434\u0430\u043d\u043d\u044b\u0435 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u044f\u0442\u0441\u044f \u043d\u0430 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0439. \u041f\u043e\u0440\u044f\u0434\u043e\u043a \u0434\u0438\u0441\u043a\u043e\u0432 \u0432 \u0442\u043e\u043c\u0430\u0445 \u0442\u0430\u043a \u0436\u0435 \u0432\u0430\u0436\u0435\u043d, \u0434\u0430\u043d\u043d\u044b\u0435 \u043f\u0438\u0448\u0443\u0442\u0441\u044f \u043f\u043e \u043e\u0447\u0435\u0440\u0435\u0434\u0438 \u043d\u0430 \u043a\u0430\u0436\u0434\u044b\u0439 \u0438\u0437 \u043d\u0438\u0445.\n+\u041f\u043e\u0440\u044f\u0434\u043e\u043a \u0442\u043e\u043c\u043e\u0432 \u0432 \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0430\u0445 \u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f \u0432\u0430\u0436\u0435\u043d \u0432 \u0441\u043b\u0443\u0447\u0430\u0435, \u0435\u0441\u043b\u0438 \u043f\u0440\u0438\u043e\u0440\u0438\u0442\u0435\u0442\u044b \u0442\u043e\u043c\u043e\u0432 (`volume_priority`) \u043d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d\u044b \u044f\u0432\u043d\u043e: \u043f\u0440\u0438 \u0434\u043e\u0441\u0442\u0438\u0436\u0435\u043d\u0438\u0438 \u0443\u0441\u043b\u043e\u0432\u0438\u0439 \u043d\u0430 \u043f\u0435\u0440\u0435\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0435 \u0442\u043e\u043c\u0430 \u0434\u0430\u043d\u043d\u044b\u0435 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u044f\u0442\u0441\u044f \u043d\u0430 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0439. \u041f\u043e\u0440\u044f\u0434\u043e\u043a \u0434\u0438\u0441\u043a\u043e\u0432 \u0432 \u0442\u043e\u043c\u0430\u0445 \u0442\u0430\u043a \u0436\u0435 \u0432\u0430\u0436\u0435\u043d, \u0434\u0430\u043d\u043d\u044b\u0435 \u043f\u0438\u0448\u0443\u0442\u0441\u044f \u043f\u043e \u043e\u0447\u0435\u0440\u0435\u0434\u0438 \u043d\u0430 \u043a\u0430\u0436\u0434\u044b\u0439 \u0438\u0437 \u043d\u0438\u0445.\n \n \u041f\u043e\u0441\u043b\u0435 \u0437\u0430\u0434\u0430\u043d\u0438\u044f \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438 \u043f\u043e\u043b\u0438\u0442\u0438\u043a \u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f \u0438\u0445 \u043c\u043e\u0436\u043d\u043e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c, \u043a\u0430\u043a \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0443 \u043f\u0440\u0438 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u0438 \u0442\u0430\u0431\u043b\u0438\u0446:\n \ndiff --git a/src/Disks/IVolume.h b/src/Disks/IVolume.h\nindex f40d4dcba60f..bc6706a1829e 100644\n--- a/src/Disks/IVolume.h\n+++ b/src/Disks/IVolume.h\n@@ -92,6 +92,8 @@ class IVolume : public Space\n     const String name;\n \n public:\n+    /// Volume priority. Maximum UInt64 value by default (lowest possible priority)\n+    UInt64 volume_priority;\n     /// Max size of reservation, zero means unlimited size\n     UInt64 max_data_part_size = 0;\n     /// Should a new data part be synchronously moved to a volume according to ttl on insert\ndiff --git a/src/Disks/StoragePolicy.cpp b/src/Disks/StoragePolicy.cpp\nindex 13bd74ceaebc..390afb368f8e 100644\n--- a/src/Disks/StoragePolicy.cpp\n+++ b/src/Disks/StoragePolicy.cpp\n@@ -28,6 +28,7 @@ namespace ErrorCodes\n     extern const int BAD_ARGUMENTS;\n     extern const int EXCESSIVE_ELEMENT_IN_CONFIG;\n     extern const int NO_ELEMENTS_IN_CONFIG;\n+    extern const int INVALID_CONFIG_PARAMETER;\n     extern const int UNKNOWN_POLICY;\n     extern const int UNKNOWN_VOLUME;\n     extern const int LOGICAL_ERROR;\n@@ -56,6 +57,8 @@ StoragePolicy::StoragePolicy(\n         config.keys(volumes_prefix, keys);\n     }\n \n+    std::set<UInt64> volume_priorities;\n+\n     for (const auto & attr_name : keys)\n     {\n         if (!std::all_of(attr_name.begin(), attr_name.end(), isWordCharASCII))\n@@ -63,6 +66,27 @@ StoragePolicy::StoragePolicy(\n                             \"Volume name can contain only alphanumeric and '_' in storage policy {} ({})\",\n                             backQuote(name), attr_name);\n         volumes.emplace_back(createVolumeFromConfig(attr_name, config, volumes_prefix + \".\" + attr_name, disks));\n+\n+        UInt64 last_priority = volumes.back()->volume_priority;\n+        if (last_priority != std::numeric_limits<UInt64>::max() && !volume_priorities.insert(last_priority).second)\n+        {\n+            throw Exception(\n+                ErrorCodes::INVALID_CONFIG_PARAMETER,\n+                \"volume_priority values must be unique across the policy\");\n+        }\n+    }\n+\n+    if (!volume_priorities.empty())\n+    {\n+        /// Check that priority values cover the range from 1 to N (lowest explicit priority)\n+        if (*volume_priorities.begin() != 1 || *volume_priorities.rbegin() != volume_priorities.size())\n+            throw Exception(\n+                ErrorCodes::INVALID_CONFIG_PARAMETER,\n+                \"volume_priority values must cover the range from 1 to N (lowest priority specified) without gaps\");\n+\n+        std::stable_sort(\n+            volumes.begin(), volumes.end(),\n+            [](const VolumePtr a, const VolumePtr b) { return a->volume_priority < b->volume_priority; });\n     }\n \n     if (volumes.empty() && name == DEFAULT_STORAGE_POLICY_NAME)\ndiff --git a/src/Disks/VolumeJBOD.cpp b/src/Disks/VolumeJBOD.cpp\nindex ec9e5ea0d390..a0c71583a229 100644\n--- a/src/Disks/VolumeJBOD.cpp\n+++ b/src/Disks/VolumeJBOD.cpp\n@@ -23,6 +23,8 @@ VolumeJBOD::VolumeJBOD(\n {\n     LoggerPtr logger = getLogger(\"StorageConfiguration\");\n \n+    volume_priority = config.getUInt64(config_prefix + \".volume_priority\", std::numeric_limits<UInt64>::max());\n+\n     auto has_max_bytes = config.has(config_prefix + \".max_data_part_size_bytes\");\n     auto has_max_ratio = config.has(config_prefix + \".max_data_part_size_ratio\");\n     if (has_max_bytes && has_max_ratio)\n",
  "test_patch": "diff --git a/tests/config/config.d/storage_conf_02961.xml b/tests/config/config.d/storage_conf_02961.xml\nnew file mode 100644\nindex 000000000000..436a5628e518\n--- /dev/null\n+++ b/tests/config/config.d/storage_conf_02961.xml\n@@ -0,0 +1,43 @@\n+<clickhouse>\n+    <storage_configuration>\n+        <disks>\n+            <disk1_02961>\n+                <type>local</type>\n+                <path>disk1_02961/</path>\n+            </disk1_02961>\n+            <disk2_02961>\n+                <type>local</type>\n+                <path>disk2_02961/</path>\n+            </disk2_02961>\n+            <disk3_02961>\n+                <type>local</type>\n+                <path>disk3_02961/</path>\n+            </disk3_02961>\n+            <disk4_02961>\n+                <type>local</type>\n+                <path>disk4_02961/</path>\n+            </disk4_02961>\n+        </disks>\n+        <policies>\n+            <policy_02961>\n+                <volumes>\n+                    <vol1_02961>\n+                        <disk>disk1_02961</disk>\n+                        <volume_priority>2</volume_priority>\n+                    </vol1_02961>\n+                    <vol_untagged2_02961>\n+                        <disk>disk2_02961</disk>\n+                    </vol_untagged2_02961>\n+                    <vol2_02961>\n+                        <disk>disk3_02961</disk>\n+                        <volume_priority>1</volume_priority>\n+                    </vol2_02961>\n+                    <vol_untagged1_02961>\n+                        <disk>disk4_02961</disk>\n+                    </vol_untagged1_02961>\n+                </volumes>\n+                <move_factor>0.2</move_factor>\n+            </policy_02961>\n+        </policies>\n+    </storage_configuration>\n+</clickhouse>\ndiff --git a/tests/config/install.sh b/tests/config/install.sh\nindex 9d55529c1f3b..cac4e626594a 100755\n--- a/tests/config/install.sh\n+++ b/tests/config/install.sh\n@@ -185,6 +185,7 @@ if [[ -n \"$EXPORT_S3_STORAGE_POLICIES\" ]]; then\n     ln -sf $SRC_PATH/config.d/storage_conf.xml $DEST_SERVER_PATH/config.d/\n     ln -sf $SRC_PATH/config.d/storage_conf_02944.xml $DEST_SERVER_PATH/config.d/\n     ln -sf $SRC_PATH/config.d/storage_conf_02963.xml $DEST_SERVER_PATH/config.d/\n+    ln -sf $SRC_PATH/config.d/storage_conf_02961.xml $DEST_SERVER_PATH/config.d/\n     ln -sf $SRC_PATH/users.d/s3_cache.xml $DEST_SERVER_PATH/users.d/\n     ln -sf $SRC_PATH/users.d/s3_cache_new.xml $DEST_SERVER_PATH/users.d/\n fi\ndiff --git a/tests/queries/0_stateless/02961_storage_config_volume_priority.reference b/tests/queries/0_stateless/02961_storage_config_volume_priority.reference\nnew file mode 100644\nindex 000000000000..ba48e75ae259\n--- /dev/null\n+++ b/tests/queries/0_stateless/02961_storage_config_volume_priority.reference\n@@ -0,0 +1,9 @@\n+vol2_02961\t1\n+vol1_02961\t2\n+vol_untagged2_02961\t3\n+vol_untagged1_02961\t4\n+check non-unique values dont work\n+1\n+check no gaps in range allowed\n+1\n+restore valid config\ndiff --git a/tests/queries/0_stateless/02961_storage_config_volume_priority.sh b/tests/queries/0_stateless/02961_storage_config_volume_priority.sh\nnew file mode 100755\nindex 000000000000..4e085541a8d8\n--- /dev/null\n+++ b/tests/queries/0_stateless/02961_storage_config_volume_priority.sh\n@@ -0,0 +1,51 @@\n+#!/usr/bin/env bash\n+# Tags: no-fasttest, no-parallel, no-random-settings\n+\n+CUR_DIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CUR_DIR\"/../shell_config.sh\n+\n+\n+$CLICKHOUSE_CLIENT --query \"\n+SELECT\n+    volume_name,\n+    volume_priority\n+FROM system.storage_policies\n+WHERE policy_name = 'policy_02961'\n+ORDER BY volume_priority ASC;\n+\"\n+\n+config_path=/etc/clickhouse-server/config.d/storage_conf_02961.xml\n+config_path_tmp=$config_path.tmp\n+\n+echo 'check non-unique values dont work'\n+cat $config_path \\\n+| sed \"s|<volume_priority>2<\\/volume_priority>|<volume_priority>1<\\/volume_priority>|\" \\\n+> $config_path_tmp\n+mv $config_path_tmp $config_path\n+\n+$CLICKHOUSE_CLIENT -nm --query \"\n+set send_logs_level='error';\n+SYSTEM RELOAD CONFIG\" 2>&1 | grep -c 'volume_priority values must be unique across the policy'\n+\n+#first, restore original values\n+cat $config_path \\\n+| sed '0,/<volume_priority>1<\\/volume_priority>/s//<volume_priority>2<\\/volume_priority>/' \\\n+> $config_path_tmp\n+mv $config_path_tmp $config_path\n+\n+echo 'check no gaps in range allowed'\n+cat $config_path \\\n+| sed '0,/<volume_priority>1<\\/volume_priority>/s//<volume_priority>3<\\/volume_priority>/' \\\n+> $config_path_tmp\n+mv $config_path_tmp $config_path\n+\n+$CLICKHOUSE_CLIENT -nm --query \"\n+set send_logs_level='error';\n+SYSTEM RELOAD CONFIG\" 2>&1 | grep -c 'volume_priority values must cover the range from 1 to N (lowest priority specified) without gaps'\n+\n+echo 'restore valid config'\n+cat $config_path \\\n+| sed '0,/<volume_priority>3<\\/volume_priority>/s//<volume_priority>1<\\/volume_priority>/' \\\n+> $config_path_tmp\n+mv $config_path_tmp $config_path\n",
  "problem_statement": "Defining volume_priority expliclty in storage_configuration\nNow a volume_priority is defined by an order in XML. \r\nThis is unorthodox way because an order in XML should not have sense.\r\n\r\nSo please implement `volume_priority`\r\n\r\n```\r\n<storage_configuration>\r\n    ...\r\n    <policies>\r\n        <moving_from_ssd_to_hdd>\r\n            <volumes>\r\n                <hot>\r\n\r\n                    <volume_priority>1</volume_priority>\r\n\r\n                    <disk>fast_ssd1</disk>\r\n                    <disk>fast_ssd2</disk>\r\n                    <max_data_part_size_bytes>1073741824</max_data_part_size_bytes>\r\n                </hot>\r\n                <cold>\r\n\r\n                    <volume_priority>2</volume_priority>\r\n\r\n                    <disk>disk1</disk>\r\n                </cold>\r\n            </volumes>\r\n            <move_factor>0.2</move_factor>\r\n        </moving_from_ssd_to_hdd>\r\n...\r\n</storage_configuration>\r\n```\n",
  "hints_text": "This bit me pretty hard recently -- would be great to get this fixed.",
  "created_at": "2024-01-05T00:16:45Z"
}