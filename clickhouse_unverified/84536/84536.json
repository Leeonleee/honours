{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 84536,
  "instance_id": "ClickHouse__ClickHouse-84536",
  "issue_numbers": [
    "84442"
  ],
  "base_commit": "aadc4331baa6c8406c6cab5d1034e2d4cacab7fb",
  "patch": "diff --git a/src/Storages/MergeTree/MergeTreeData.cpp b/src/Storages/MergeTree/MergeTreeData.cpp\nindex 1bab00873aca..4ff0ab993d8e 100644\n--- a/src/Storages/MergeTree/MergeTreeData.cpp\n+++ b/src/Storages/MergeTree/MergeTreeData.cpp\n@@ -1222,6 +1222,7 @@ void MergeTreeData::checkTTLExpressions(const StorageInMemoryMetadata & new_meta\n     {\n         NameSet columns_ttl_forbidden;\n \n+        // Check old metadata keys\n         if (old_metadata.hasPartitionKey())\n             for (const auto & col : old_metadata.getColumnsRequiredForPartitionKey())\n                 columns_ttl_forbidden.insert(col);\n@@ -1230,6 +1231,15 @@ void MergeTreeData::checkTTLExpressions(const StorageInMemoryMetadata & new_meta\n             for (const auto & col : old_metadata.getColumnsRequiredForSortingKey())\n                 columns_ttl_forbidden.insert(col);\n \n+        // Check new metadata keys (fix for issue #84442)\n+        if (new_metadata.hasPartitionKey())\n+            for (const auto & col : new_metadata.getColumnsRequiredForPartitionKey())\n+                columns_ttl_forbidden.insert(col);\n+\n+        if (new_metadata.hasSortingKey())\n+            for (const auto & col : new_metadata.getColumnsRequiredForSortingKey())\n+                columns_ttl_forbidden.insert(col);\n+\n         for (const auto & [name, ttl_description] : new_column_ttls)\n         {\n             if (columns_ttl_forbidden.contains(name))\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03578_ttl_column_in_order_by_validation.reference b/tests/queries/0_stateless/03578_ttl_column_in_order_by_validation.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/03578_ttl_column_in_order_by_validation.sql b/tests/queries/0_stateless/03578_ttl_column_in_order_by_validation.sql\nnew file mode 100644\nindex 000000000000..360078b81967\n--- /dev/null\n+++ b/tests/queries/0_stateless/03578_ttl_column_in_order_by_validation.sql\n@@ -0,0 +1,20 @@\n+-- Test for issue #84442: ALTER MODIFY ORDER BY does not check if the new column has TTL\n+-- This test verifies that ALTER TABLE properly validates TTL columns in ORDER BY clauses\n+\n+CREATE TABLE IF NOT EXISTS test_break_ddl\n+(\n+    id String,\n+    event_date Date,\n+    event_time DateTime,\n+    message String\n+)\n+ENGINE = ReplacingMergeTree()\n+PARTITION BY event_date\n+ORDER BY (id, event_date, event_time);\n+\n+ALTER TABLE test_break_ddl\n+    ADD COLUMN `source_address` String TTL event_time + toIntervalDay(30) AFTER event_time,\n+    ADD COLUMN `destination_address` String TTL event_time + toIntervalDay(30) AFTER source_address,\n+    MODIFY ORDER BY (id, event_date, event_time, source_address, destination_address); -- { serverError ILLEGAL_COLUMN }\n+\n+DROP TABLE IF EXISTS test_break_ddl;\n",
  "problem_statement": "`ALTER MODIFY ORDER BY` does not check if the new column has TTL\n### Company or project name\n\nClickHouse Inc.\n\n### Describe what's wrong\n\n`ALTER TABLE ADD COLUMN` with_ttl `String TTL event_time + toIntervalDay(30), MODIFY ORDER BY (..., with_ttl)` works and breaks the `clickhouse-server` completely.\n\n### Does it reproduce on the most recent release?\n\nYes\n\n### How to reproduce\n\nhttps://fiddle.clickhouse.com/ad972e7d-aa00-450b-8fe5-79531f797031 - broken in 24.11\nhttps://fiddle.clickhouse.com/3f7adaa2-ee51-4173-9012-3f8028aec672 - broken in the latest release\nhttps://fiddle.clickhouse.com/6923a88d-1910-44bd-bb9c-4cd46ea369d2 - broken in master\n\n\n### Expected behavior\n\n`ALTER` shouldn't allow the wrong TTL\n\n### Error message and/or stacktrace\n\n```\nReceived exception from server (version 25.8.1):\nCode: 44. DB::Exception: Received from localhost:9000. DB::Exception: Trying to set TTL for key column destination_address. (ILLEGAL_COLUMN)\n(query: ATTACH TABLE test_break_ddl;)\n```\n\n### Additional context\n\n_No response_\n",
  "hints_text": "",
  "created_at": "2025-07-28T02:26:45Z",
  "modified_files": [
    "src/Storages/MergeTree/MergeTreeData.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/03578_ttl_column_in_order_by_validation.sql"
  ]
}