{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 15756,
  "instance_id": "ClickHouse__ClickHouse-15756",
  "issue_numbers": [
    "12298"
  ],
  "base_commit": "c00ca64655de62f912b8b016b748c8b7370ea81b",
  "patch": "diff --git a/src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp b/src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp\nindex 8cb24bb0cd6b..c852151f27d1 100644\n--- a/src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp\n+++ b/src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp\n@@ -330,9 +330,6 @@ void MergeTreeBaseSelectProcessor::executePrewhereActions(Block & block, const P\n             auto & ctn = block.getByName(prewhere_info->prewhere_column_name);\n             ctn.column = ctn.type->createColumnConst(block.rows(), 1u)->convertToFullColumnIfConst();\n         }\n-\n-        if (!block)\n-            block.insert({nullptr, std::make_shared<DataTypeNothing>(), \"_nothing\"});\n     }\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01511_prewhere_with_virtuals.reference b/tests/queries/0_stateless/01511_prewhere_with_virtuals.reference\nnew file mode 100644\nindex 000000000000..bd19df3c15d8\n--- /dev/null\n+++ b/tests/queries/0_stateless/01511_prewhere_with_virtuals.reference\n@@ -0,0 +1,3 @@\n+1_2_2_0\t4\n+2_3_3_0\t3\n+0_1_1_0\ndiff --git a/tests/queries/0_stateless/01511_prewhere_with_virtuals.sql b/tests/queries/0_stateless/01511_prewhere_with_virtuals.sql\nnew file mode 100644\nindex 000000000000..8b272c8cff12\n--- /dev/null\n+++ b/tests/queries/0_stateless/01511_prewhere_with_virtuals.sql\n@@ -0,0 +1,12 @@\n+DROP TABLE IF EXISTS  test_not_found_column_nothing;\n+\n+CREATE TABLE test_not_found_column_nothing \n+(\n+    col001 UInt8,\n+    col002 UInt8\n+) Engine=MergeTree ORDER BY tuple() PARTITION BY col001 % 3;\n+\n+INSERT INTO test_not_found_column_nothing(col001) SELECT number FROM numbers(11);\n+\n+SELECT _part, count() FROM test_not_found_column_nothing PREWHERE col001 % 3 != 0 GROUP BY _part ORDER BY _part;\n+SELECT _part FROM test_not_found_column_nothing PREWHERE col001 = 0;\n",
  "problem_statement": "group by _part: Not found column _nothing in block\nTest\r\n```\r\nDROP TABLE IF EXISTS  test_not_found_column_nothing;\r\n\r\nCREATE TABLE test_not_found_column_nothing \r\n(\r\n    col001 UInt8,\r\n    col002 UInt8\r\n) Engine=MergeTree ORDER BY tuple();\r\n\r\nINSERT INTO test_not_found_column_nothing(col001) VALUES (1);\r\n\r\nselect _part, count() from test_not_found_column_nothing where col001 = 1 group by _part;\r\n\r\nDROP TABLE IF EXIST test_not_found_column_nothing;\r\n```\r\n\r\nStacktrace\r\n```\r\nReceived exception from server (version 20.6.1):\r\nCode: 10. DB::Exception: Received from localhost:9000. DB::Exception: Not found column _nothing in block. There are only columns: : While executing MergeTreeThread. Stack trace:\r\n\r\n0. /contrib/libcxx/include/exception:129: std::exception::capture() @ 0x15bd11e8 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n1. /contrib/libcxx/include/exception:109: std::exception::exception() @ 0x15bd11b5 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n2. /contrib/poco/Foundation/src/Exception.cpp:27: Poco::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x214933f3 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n3. /src/Common/Exception.cpp:37: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x15bca4a3 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n4. /src/Core/Block.cpp:216: DB::Block::getPositionByName(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) const @ 0x1c4438e2 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n5. /src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp:181: DB::MergeTreeBaseSelectProcessor::readFromPartImpl() @ 0x1d6c916b in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n6. /src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp:194: DB::MergeTreeBaseSelectProcessor::readFromPart() @ 0x1d6c9549 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n7. /src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp:57: DB::MergeTreeBaseSelectProcessor::generate() @ 0x1d6c8451 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n8. /src/Processors/ISource.cpp:48: DB::ISource::work() @ 0x1d914eb7 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n9. /src/Processors/Sources/SourceWithProgress.cpp:30: DB::SourceWithProgress::work() @ 0x1dbc15cd in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n10. /src/Processors/Executors/PipelineExecutor.cpp:155: DB::executeJob(DB::IProcessor*) @ 0x1d96262c in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n11. /src/Processors/Executors/PipelineExecutor.cpp:172: DB::PipelineExecutor::addJob(DB::PipelineExecutor::ExecutionState*)::$_1::operator()() const @ 0x1d9625a0 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n12. /contrib/libcxx/include/type_traits:3519: decltype(std::__1::forward<DB::PipelineExecutor::addJob(DB::PipelineExecutor::ExecutionState*)::$_1&>(fp)()) std::__1::__invoke<DB::PipelineExecutor::addJob(DB::PipelineExecutor::ExecutionState*)::$_1&>(DB::PipelineExecutor::addJob(DB::PipelineExecutor::ExecutionState*)::$_1&) @ 0x1d96255d in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n13. /contrib/libcxx/include/__functional_base:349: void std::__1::__invoke_void_return_wrapper<void>::__call<DB::PipelineExecutor::addJob(DB::PipelineExecutor::ExecutionState*)::$_1&>(DB::PipelineExecutor::addJob(DB::PipelineExecutor::ExecutionState*)::$_1&) @ 0x1d96250d in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n14. /contrib/libcxx/include/functional:1540: std::__1::__function::__alloc_func<DB::PipelineExecutor::addJob(DB::PipelineExecutor::ExecutionState*)::$_1, std::__1::allocator<DB::PipelineExecutor::addJob(DB::PipelineExecutor::ExecutionState*)::$_1>, void ()>::operator()() @ 0x1d9624dd in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n15. /contrib/libcxx/include/functional:1714: std::__1::__function::__func<DB::PipelineExecutor::addJob(DB::PipelineExecutor::ExecutionState*)::$_1, std::__1::allocator<DB::PipelineExecutor::addJob(DB::PipelineExecutor::ExecutionState*)::$_1>, void ()>::operator()() @ 0x1d96163e in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n16. /contrib/libcxx/include/functional:1867: std::__1::__function::__value_func<void ()>::operator()() const @ 0x15bed2b5 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n17. /contrib/libcxx/include/functional:2473: std::__1::function<void ()>::operator()() const @ 0x15bec225 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n18. /src/Processors/Executors/PipelineExecutor.cpp:633: DB::PipelineExecutor::executeStepImpl(unsigned long, unsigned long, std::__1::atomic<bool>*) @ 0x1d95fdd5 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n19. /src/Processors/Executors/PipelineExecutor.cpp:546: DB::PipelineExecutor::executeSingleThread(unsigned long, unsigned long) @ 0x1d9605e7 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n20. /src/Processors/Executors/PipelineExecutor.cpp:803: DB::PipelineExecutor::executeImpl(unsigned long)::$_5::operator()() const @ 0x1d96488c in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n21. /contrib/libcxx/include/type_traits:3525: decltype(std::__1::forward<DB::PipelineExecutor::executeImpl(unsigned long)::$_5 const&>(fp)()) std::__1::__invoke_constexpr<DB::PipelineExecutor::executeImpl(unsigned long)::$_5 const&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5 const&) @ 0x1d9647ed in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n22. /contrib/libcxx/include/tuple:1415: decltype(auto) std::__1::__apply_tuple_impl<DB::PipelineExecutor::executeImpl(unsigned long)::$_5 const&, std::__1::tuple<> const&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5 const&, std::__1::tuple<> const&, std::__1::__tuple_indices<>) @ 0x1d9647b1 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n23. /contrib/libcxx/include/tuple:1424: decltype(auto) std::__1::apply<DB::PipelineExecutor::executeImpl(unsigned long)::$_5 const&, std::__1::tuple<> const&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5 const&, std::__1::tuple<> const&) @ 0x1d964782 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n24. /src/Common/ThreadPool.h:168: ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_5>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5&&)::'lambda'()::operator()() const @ 0x1d96467c in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n25. /contrib/libcxx/include/type_traits:3519: decltype(std::__1::forward<DB::PipelineExecutor::executeImpl(unsigned long)::$_5>(fp)()) std::__1::__invoke<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_5>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5&&)::'lambda'()&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5&&) @ 0x1d96460d in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n26. /contrib/libcxx/include/__functional_base:349: void std::__1::__invoke_void_return_wrapper<void>::__call<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_5>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5&&)::'lambda'()&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5&&...) @ 0x1d9645bd in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n27. /contrib/libcxx/include/functional:1540: std::__1::__function::__alloc_func<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_5>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5&&)::'lambda'(), std::__1::allocator<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_5>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5&&)::'lambda'()>, void ()>::operator()() @ 0x1d96458d in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n28. /contrib/libcxx/include/functional:1714: std::__1::__function::__func<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_5>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5&&)::'lambda'(), std::__1::allocator<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_5>(DB::PipelineExecutor::executeImpl(unsigned long)::$_5&&)::'lambda'()>, void ()>::operator()() @ 0x1d96373e in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n29. /contrib/libcxx/include/functional:1867: std::__1::__function::__value_func<void ()>::operator()() const @ 0x15bed2b5 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n30. /contrib/libcxx/include/functional:2473: std::__1::function<void ()>::operator()() const @ 0x15bec225 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n31. /src/Common/ThreadPool.cpp:227: ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) @ 0x15c0f520 in /home/mfilimonov/workspace/ClickHouse/build-vscode/clang_8_Debug/programs/clickhouse\r\n\r\n```\n",
  "hints_text": "19.16 - works, 19.17 and newer - broken",
  "created_at": "2020-10-08T13:00:43Z"
}