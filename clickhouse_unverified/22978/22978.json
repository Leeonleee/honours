{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 22978,
  "instance_id": "ClickHouse__ClickHouse-22978",
  "issue_numbers": [
    "20019"
  ],
  "base_commit": "b571656fd762f13afca4e5ad51b1c41930828ed7",
  "patch": "diff --git a/src/Storages/MergeTree/MergeTreeIndexSet.cpp b/src/Storages/MergeTree/MergeTreeIndexSet.cpp\nindex e7578027598e..53ee063486bb 100644\n--- a/src/Storages/MergeTree/MergeTreeIndexSet.cpp\n+++ b/src/Storages/MergeTree/MergeTreeIndexSet.cpp\n@@ -299,6 +299,10 @@ bool MergeTreeIndexConditionSet::mayBeTrueOnGranule(MergeTreeIndexGranulePtr idx\n \n     auto column\n         = result.getByName(expression_ast->getColumnName()).column->convertToFullColumnIfConst()->convertToFullColumnIfLowCardinality();\n+\n+    if (column->onlyNull())\n+        return false;\n+\n     const auto * col_uint8 = typeid_cast<const ColumnUInt8 *>(column.get());\n \n     const NullMap * null_map = nullptr;\ndiff --git a/src/Storages/MergeTree/MergeTreeRangeReader.cpp b/src/Storages/MergeTree/MergeTreeRangeReader.cpp\nindex e72039f7172a..d373c004d108 100644\n--- a/src/Storages/MergeTree/MergeTreeRangeReader.cpp\n+++ b/src/Storages/MergeTree/MergeTreeRangeReader.cpp\n@@ -486,9 +486,13 @@ void MergeTreeRangeReader::ReadResult::setFilter(const ColumnPtr & new_filter)\n \n     ConstantFilterDescription const_description(*new_filter);\n     if (const_description.always_true)\n+    {\n         setFilterConstTrue();\n+    }\n     else if (const_description.always_false)\n+    {\n         clear();\n+    }\n     else\n     {\n         FilterDescription filter_description(*new_filter);\ndiff --git a/src/Storages/VirtualColumnUtils.cpp b/src/Storages/VirtualColumnUtils.cpp\nindex c479c6d45b36..a6a68f598c76 100644\n--- a/src/Storages/VirtualColumnUtils.cpp\n+++ b/src/Storages/VirtualColumnUtils.cpp\n@@ -191,10 +191,15 @@ void filterBlockWithQuery(const ASTPtr & query, Block & block, ContextPtr contex\n     ConstantFilterDescription constant_filter(*filter_column);\n \n     if (constant_filter.always_true)\n+    {\n         return;\n+    }\n \n     if (constant_filter.always_false)\n+    {\n         block = block.cloneEmpty();\n+        return;\n+    }\n \n     FilterDescription filter(*filter_column);\n \n",
  "test_patch": "diff --git a/docker/test/fasttest/run.sh b/docker/test/fasttest/run.sh\nindex c21a115289dd..14c6ee0d3377 100755\n--- a/docker/test/fasttest/run.sh\n+++ b/docker/test/fasttest/run.sh\n@@ -300,6 +300,7 @@ function run_tests\n         01663_aes_msan                          # Depends on OpenSSL\n         01667_aes_args_check                    # Depends on OpenSSL\n         01776_decrypt_aead_size_check           # Depends on OpenSSL\n+        01811_filter_by_null                    # Depends on OpenSSL\n         01281_unsucceeded_insert_select_queries_counter\n         01292_create_user\n         01294_lazy_database_concurrent\ndiff --git a/tests/queries/0_stateless/01811_filter_by_null.reference b/tests/queries/0_stateless/01811_filter_by_null.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/01811_filter_by_null.sql b/tests/queries/0_stateless/01811_filter_by_null.sql\nnew file mode 100644\nindex 000000000000..496faf428abf\n--- /dev/null\n+++ b/tests/queries/0_stateless/01811_filter_by_null.sql\n@@ -0,0 +1,9 @@\n+DROP TABLE IF EXISTS test_01344;\n+\n+CREATE TABLE test_01344 (x String, INDEX idx (x) TYPE set(10) GRANULARITY 1) ENGINE = MergeTree ORDER BY tuple() SETTINGS min_bytes_for_wide_part = 0;\n+INSERT INTO test_01344 VALUES ('Hello, world');\n+SELECT NULL FROM test_01344 WHERE ignore(1) = NULL;\n+SELECT NULL FROM test_01344 WHERE encrypt(ignore(encrypt(NULL, '0.0001048577', lcm(2, 65537), NULL, inf, NULL), lcm(-2, 1048575)), '-0.0000000001', lcm(NULL, NULL)) = NULL;\n+SELECT NULL FROM test_01344 WHERE ignore(x, lcm(NULL, 1048576), -2) = NULL;\n+\n+DROP TABLE test_01344;\n",
  "problem_statement": "ColumnUInt8 expected as Set index condition result.\n```\r\nCREATE TABLE test_01344 (x String, INDEX idx (x) TYPE set(10) GRANULARITY 1) ENGINE = MergeTree ORDER BY tuple() SETTINGS min_bytes_for_wide_part = 0;\r\n\r\nINSERT INTO test_01344 VALUES ('Hello, world');\r\n\r\nSELECT NULL FROM test_01344 WHERE encrypt(ignore(encrypt(NULL, '0.0001048577', lcm(2, 65537), NULL, inf, NULL), lcm(-2, 1048575)), '-0.0000000001', lcm(NULL, NULL)) = NULL\r\n\r\n2021.02.02 21:42:58.265823 [ 93 ] {2faa3ab2-400f-46bf-999f-1706f3ad3bf7} <Debug> default.test_01344 (da350dfe-27ef-4993-bd7d-40d758f03dd5) (SelectExecutor): Key condition: unknown\r\n2021.02.02 21:42:58.271882 [ 93 ] {2faa3ab2-400f-46bf-999f-1706f3ad3bf7} <Fatal> : Logical error: 'ColumnUInt8 expected as Set index condition result.'.\r\n2021.02.02 21:42:58.272837 [ 87 ] {} <Trace> BaseDaemon: Received signal 6\r\n2021.02.02 21:42:58.273656 [ 166 ] {} <Fatal> BaseDaemon: ########################################\r\n2021.02.02 21:42:58.273944 [ 166 ] {} <Fatal> BaseDaemon: (version 21.3.1.5893, build id: 62B0DA6CEA883383385566853BF173D5BB8388EB) (from thread 93) (query_id: 2faa3ab2-400f-46bf-999f-1706f3ad3bf7) Received signal Aborted (6)\r\n2021.02.02 21:42:58.274156 [ 166 ] {} <Fatal> BaseDaemon: \r\n2021.02.02 21:42:58.274431 [ 166 ] {} <Fatal> BaseDaemon: Stack trace: 0x7f45e490f18b 0x7f45e48ee859 0x10c78456 0x10c78513 0x1a93eb2a 0x1a907ae4 0x1a900f05 0x1a8fe167 0x1a8f7c05 0x1a56ef33 0x19daafd8 0x19da3b29 0x19da3106 0x1a08050a 0x1a080c7d 0x1a295354 0x1a293b0a 0x1abc2442 0x1abcde78 0x1e44a34c 0x1e44ab50 0x1e587bc3 0x1e584a4d 0x1e5838d8 0x7f45e4ac4609 0x7f45e49eb293\r\n2021.02.02 21:42:58.274819 [ 166 ] {} <Fatal> BaseDaemon: 4. gsignal @ 0x4618b in /usr/lib/x86_64-linux-gnu/libc-2.31.so\r\n2021.02.02 21:42:58.275016 [ 166 ] {} <Fatal> BaseDaemon: 5. abort @ 0x25859 in /usr/lib/x86_64-linux-gnu/libc-2.31.so\r\n2021.02.02 21:42:58.275394 [ 166 ] {} <Fatal> BaseDaemon: 6. ./obj-x86_64-linux-gnu/../src/Common/Exception.cpp:50: DB::handle_error_code(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x10c78456 in /workspace/clickhouse\r\n2021.02.02 21:42:58.275838 [ 166 ] {} <Fatal> BaseDaemon: 7. ./obj-x86_64-linux-gnu/../src/Common/Exception.cpp:57: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int, bool) @ 0x10c78513 in /workspace/clickhouse\r\n2021.02.02 21:42:58.336714 [ 166 ] {} <Fatal> BaseDaemon: 8. ./obj-x86_64-linux-gnu/../src/Storages/MergeTree/MergeTreeIndexSet.cpp:307: DB::MergeTreeIndexConditionSet::mayBeTrueOnGranule(std::__1::shared_ptr<DB::IMergeTreeIndexGranule>) const @ 0x1a93eb2a in /workspace/clickhouse\r\n2021.02.02 21:42:58.398472 [ 166 ] {} <Fatal> BaseDaemon: 9. ./obj-x86_64-linux-gnu/../src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp:1832: DB::MergeTreeDataSelectExecutor::filterMarksUsingIndex(std::__1::shared_ptr<DB::IMergeTreeIndex const>, std::__1::shared_ptr<DB::IMergeTreeIndexCondition>, std::__1::shared_ptr<DB::IMergeTreeDataPart const>, std::__1::deque<DB::MarkRange, std::__1::allocator<DB::MarkRange> > const&, DB::Settings const&, DB::MergeTreeReaderSettings const&, Poco::Logger*) @ 0x1a907ae4 in /workspace/clickhouse\r\n2021.02.02 21:42:58.459549 [ 166 ] {} <Fatal> BaseDaemon: 10. ./obj-x86_64-linux-gnu/../src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp:641: DB::MergeTreeDataSelectExecutor::readFromParts(std::__1::vector<std::__1::shared_ptr<DB::IMergeTreeDataPart const>, std::__1::allocator<std::__1::shared_ptr<DB::IMergeTreeDataPart const> > >, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&, DB::SelectQueryInfo const&, DB::Context const&, unsigned long, unsigned int, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, long, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, long> > > const*) const::$_2::operator()(unsigned long) const @ 0x1a900f05 in /workspace/clickhouse\r\n2021.02.02 21:42:58.520336 [ 166 ] {} <Fatal> BaseDaemon: 11. ./obj-x86_64-linux-gnu/../src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp:665: DB::MergeTreeDataSelectExecutor::readFromParts(std::__1::vector<std::__1::shared_ptr<DB::IMergeTreeDataPart const>, std::__1::allocator<std::__1::shared_ptr<DB::IMergeTreeDataPart const> > >, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&, DB::SelectQueryInfo const&, DB::Context const&, unsigned long, unsigned int, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, long, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, long> > > const*) const @ 0x1a8fe167 in /workspace/clickhouse\r\n2021.02.02 21:42:58.580975 [ 166 ] {} <Fatal> BaseDaemon: 12. ./obj-x86_64-linux-gnu/../src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp:143: DB::MergeTreeDataSelectExecutor::read(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&, DB::SelectQueryInfo const&, DB::Context const&, unsigned long, unsigned int, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, long, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, long> > > const*) const @ 0x1a8f7c05 in /workspace/clickhouse\r\n2021.02.02 21:42:58.637650 [ 166 ] {} <Fatal> BaseDaemon: 13. ./obj-x86_64-linux-gnu/../src/Storages/StorageMergeTree.cpp:186: DB::StorageMergeTree::read(DB::QueryPlan&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&, DB::SelectQueryInfo&, DB::Context const&, DB::QueryProcessingStage::Enum, unsigned long, unsigned int) @ 0x1a56ef33 in /workspace/clickhouse\r\n2021.02.02 21:42:58.687447 [ 141 ] {} <Trace> system.trace_log (d7ef83db-c77c-4e4f-b966-a71d93fdc998): Found 6 old parts to remove.\r\n2021.02.02 21:42:58.687596 [ 141 ] {} <Debug> system.trace_log (d7ef83db-c77c-4e4f-b966-a71d93fdc998): Removing part from filesystem 202102_1_51_10\r\n2021.02.02 21:42:58.688212 [ 141 ] {} <Debug> system.trace_log (d7ef83db-c77c-4e4f-b966-a71d93fdc998): Removing part from filesystem 202102_52_52_0\r\n2021.02.02 21:42:58.688611 [ 166 ] {} <Fatal> BaseDaemon: 14. ./obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:1606: DB::InterpreterSelectQuery::executeFetchColumns(DB::QueryProcessingStage::Enum, DB::QueryPlan&, std::__1::shared_ptr<DB::PrewhereDAGInfo> const&, std::__1::unordered_set<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0x19daafd8 in /workspace/clickhouse\r\n2021.02.02 21:42:58.688762 [ 141 ] {} <Debug> system.trace_log (d7ef83db-c77c-4e4f-b966-a71d93fdc998): Removing part from filesystem 202102_53_53_0\r\n2021.02.02 21:42:58.689325 [ 141 ] {} <Debug> system.trace_log (d7ef83db-c77c-4e4f-b966-a71d93fdc998): Removing part from filesystem 202102_54_54_0\r\n2021.02.02 21:42:58.689945 [ 141 ] {} <Debug> system.trace_log (d7ef83db-c77c-4e4f-b966-a71d93fdc998): Removing part from filesystem 202102_55_55_0\r\n2021.02.02 21:42:58.690481 [ 141 ] {} <Debug> system.trace_log (d7ef83db-c77c-4e4f-b966-a71d93fdc998): Removing part from filesystem 202102_56_56_0\r\n2021.02.02 21:42:58.739121 [ 166 ] {} <Fatal> BaseDaemon: 15. ./obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:875: DB::InterpreterSelectQuery::executeImpl(DB::QueryPlan&, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>) @ 0x19da3b29 in /workspace/clickhouse\r\n2021.02.02 21:42:58.789877 [ 166 ] {} <Fatal> BaseDaemon: 16. ./obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:524: DB::InterpreterSelectQuery::buildQueryPlan(DB::QueryPlan&) @ 0x19da3106 in /workspace/clickhouse\r\n2021.02.02 21:42:58.841337 [ 166 ] {} <Fatal> BaseDaemon: 17. ./obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:356: DB::InterpreterSelectWithUnionQuery::buildQueryPlan(DB::QueryPlan&) @ 0x1a08050a in /workspace/clickhouse\r\n2021.02.02 21:42:58.892830 [ 166 ] {} <Fatal> BaseDaemon: 18. ./obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:410: DB::InterpreterSelectWithUnionQuery::execute() @ 0x1a080c7d in /workspace/clickhouse\r\n2021.02.02 21:42:58.947193 [ 166 ] {} <Fatal> BaseDaemon: 19. ./obj-x86_64-linux-gnu/../src/Interpreters/executeQuery.cpp:541: DB::executeQueryImpl(char const*, char const*, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool, DB::ReadBuffer*) @ 0x1a295354 in /workspace/clickhouse\r\n2021.02.02 21:42:59.001112 [ 166 ] {} <Fatal> BaseDaemon: 20. ./obj-x86_64-linux-gnu/../src/Interpreters/executeQuery.cpp:899: DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool) @ 0x1a293b0a in /workspace/clickhouse\r\n2021.02.02 21:42:59.064333 [ 166 ] {} <Fatal> BaseDaemon: 21. ./obj-x86_64-linux-gnu/../src/Server/TCPHandler.cpp:260: DB::TCPHandler::runImpl() @ 0x1abc2442 in /workspace/clickhouse\r\n2021.02.02 21:42:59.099040 [ 106 ] {} <Trace> SystemLog (system.metric_log): Flushing system log, 8 entries to flush\r\n2021.02.02 21:42:59.127897 [ 166 ] {} <Fatal> BaseDaemon: 22. ./obj-x86_64-linux-gnu/../src/Server/TCPHandler.cpp:1417: DB::TCPHandler::run() @ 0x1abcde78 in /workspace/clickhouse\r\n2021.02.02 21:42:59.200690 [ 166 ] {} <Fatal> BaseDaemon: 23. ./obj-x86_64-linux-gnu/../contrib/poco/Net/src/TCPServerConnection.cpp:43: Poco::Net::TCPServerConnection::start() @ 0x1e44a34c in /workspace/clickhouse\r\n2021.02.02 21:42:59.218935 [ 106 ] {} <Debug> DiskLocal: Reserving 1.00 MiB on disk `default`, having unreserved 141.11 GiB.\r\n2021.02.02 21:42:59.273575 [ 166 ] {} <Fatal> BaseDaemon: 24. ./obj-x86_64-linux-gnu/../contrib/poco/Net/src/TCPServerDispatcher.cpp:112: Poco::Net::TCPServerDispatcher::run() @ 0x1e44ab50 in /workspace/clickhouse\r\n2021.02.02 21:42:59.292439 [ 106 ] {} <Trace> system.metric_log (ecd616bc-744a-4bd5-97b9-cf4ffefcc544): Renaming temporary part tmp_insert_202102_117_117_0 to 202102_117_117_0.\r\n2021.02.02 21:42:59.312048 [ 106 ] {} <Trace> SystemLog (system.metric_log): Flushed system log\r\n2021.02.02 21:42:59.346795 [ 166 ] {} <Fatal> BaseDaemon: 25. ./obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/ThreadPool.cpp:199: Poco::PooledThread::run() @ 0x1e587bc3 in /workspace/clickhouse\r\n2021.02.02 21:42:59.420365 [ 166 ] {} <Fatal> BaseDaemon: 26. ./obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Thread.cpp:56: Poco::(anonymous namespace)::RunnableHolder::run() @ 0x1e584a4d in /workspace/clickhouse\r\n2021.02.02 21:42:59.493833 [ 166 ] {} <Fatal> BaseDaemon: 27. ./obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Thread_POSIX.cpp:345: Poco::ThreadImpl::runnableEntry(void*) @ 0x1e5838d8 in /workspace/clickhouse\r\n2021.02.02 21:42:59.494569 [ 166 ] {} <Fatal> BaseDaemon: 28. start_thread @ 0x9609 in /usr/lib/x86_64-linux-gnu/libpthread-2.31.so\r\n2021.02.02 21:42:59.495164 [ 166 ] {} <Fatal> BaseDaemon: 29. __clone @ 0x122293 in /usr/lib/x86_64-linux-gnu/libc-2.31.so\r\n2021.02.02 21:43:00.810615 [ 166 ] {} <Fatal> BaseDaemon: Calculated checksum of the binary: FD3D38968E4B5758B24042A02C10630B. There is no information about the reference checksum.\r\n```\n",
  "hints_text": "@akuzm I get different error:\r\n```\r\nIllegal type Nullable(Nothing) of column for filter. Must be UInt8 or Nullable(UInt8)..\r\n```\nIt looks very easy to fix.",
  "created_at": "2021-04-11T19:42:42Z"
}