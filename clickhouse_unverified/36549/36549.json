{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 36549,
  "instance_id": "ClickHouse__ClickHouse-36549",
  "issue_numbers": [
    "36530"
  ],
  "base_commit": "224f4dc620da606a7b5b52f855de607e43f0cc58",
  "patch": "diff --git a/src/Storages/MergeTree/MergeTreeData.cpp b/src/Storages/MergeTree/MergeTreeData.cpp\nindex 7770dff28dbf..3098d6b40581 100644\n--- a/src/Storages/MergeTree/MergeTreeData.cpp\n+++ b/src/Storages/MergeTree/MergeTreeData.cpp\n@@ -5220,6 +5220,10 @@ std::optional<ProjectionCandidate> MergeTreeData::getQueryProcessingStageWithAgg\n     if (select_query->join())\n         return std::nullopt;\n \n+    // INTERPOLATE expressions may include aliases, so aliases should be preserved\n+    if (select_query->interpolate() && !select_query->interpolate()->children.empty())\n+        return std::nullopt;\n+\n     auto query_options = SelectQueryOptions(\n         QueryProcessingStage::WithMergeableState,\n         /* depth */ 1,\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02233_interpolate_1.reference b/tests/queries/0_stateless/02233_interpolate_1.reference\nindex 64f5a8308bf3..8eadd1a8d4e4 100644\n--- a/tests/queries/0_stateless/02233_interpolate_1.reference\n+++ b/tests/queries/0_stateless/02233_interpolate_1.reference\n@@ -238,3 +238,9 @@ original\t7\n 10.5\t\t\\N\n 11\t\t\\N\n 11.5\t\t\\N\n+1\t1\n+2\t2\n+3\t2\n+4\t3\n+5\t4\n+6\t3\ndiff --git a/tests/queries/0_stateless/02233_interpolate_1.sql b/tests/queries/0_stateless/02233_interpolate_1.sql\nindex b11385e17b60..229c36e23fbc 100644\n--- a/tests/queries/0_stateless/02233_interpolate_1.sql\n+++ b/tests/queries/0_stateless/02233_interpolate_1.sql\n@@ -70,3 +70,10 @@ SELECT n, source, inter + NULL AS inter_p FROM (\n SELECT n, source, inter AS inter_p FROM (\n     SELECT toFloat32(number % 10) AS n, 'original' AS source, number + NULL AS inter FROM numbers(10) WHERE (number % 3) = 1\n ) ORDER BY n ASC WITH FILL FROM 0 TO 11.51 STEP 0.5 INTERPOLATE ( inter_p AS inter_p + 1 );\n+\n+# Test INTERPOLATE for MergeTree\n+DROP TABLE IF EXISTS t_inter_02233;\n+CREATE TABLE t_inter_02233 (n Int32) ENGINE = MergeTree ORDER BY n;\n+INSERT INTO t_inter_02233 VALUES (1),(3),(3),(6),(6),(6);\n+SELECT n, count() AS m FROM t_inter_02233 GROUP BY n ORDER BY n WITH FILL INTERPOLATE ( m AS m + 1 );\n+DROP TABLE IF EXISTS t_inter_02233;\n",
  "problem_statement": "INTERPOLATE doesn't work for MergeTree\n**Describe what's wrong**\r\nINTERPOLATE doesn't work for tables with ENGINE = MergeTree\r\n\r\n**Does it reproduce on recent release?**\r\nyes\r\n\r\n**How to reproduce**\r\n```\r\nCREATE TABLE t1 (n Int32) ENGINE = MergeTree ORDER BY n;\r\nINSERT INTO t1 VALUES (1),(3),(3),(6),(6),(6);\r\n\r\nSELECT\r\n    n,\r\n    count() AS m\r\nFROM t1\r\nGROUP BY n\r\nORDER BY n ASC WITH FILL\r\nINTERPOLATE ( m AS m + 1 );\r\n\r\nReceived exception from server (version 22.5.1):\r\nCode: 47. DB::Exception: Received from localhost:9000. DB::Exception: Missing columns: 'm' while processing query: 'SELECT n, count() FROM t1 GROUP BY n ORDER BY n ASC WITH FILL INTERPOLATE ( m AS m + 1 )', required columns: 'n' 'm', maybe you meant: ['n','n']. (UNKNOWN_IDENTIFIER)\r\n```\r\n\r\n**Expected behavior**\r\nsame as\r\n```\r\nCREATE TABLE t1 (n Int32) ENGINE = Memory;\r\nINSERT INTO t1 VALUES (1),(3),(3),(6),(6),(6);\r\n\r\nSELECT\r\n    n,\r\n    count() AS m\r\nFROM t1\r\nGROUP BY n\r\nORDER BY n ASC WITH FILL\r\nINTERPOLATE ( m AS m + 1 );\r\n\r\n\u250c\u2500n\u2500\u252c\u2500m\u2500\u2510\r\n\u2502 1 \u2502 1 \u2502\r\n\u2502 2 \u2502 2 \u2502\r\n\u2502 3 \u2502 2 \u2502\r\n\u2502 4 \u2502 3 \u2502\r\n\u2502 5 \u2502 4 \u2502\r\n\u2502 6 \u2502 3 \u2502\r\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2518\r\n```\r\n\r\n**Error message and/or stacktrace**\r\n```\r\nReceived exception from server (version 22.5.1):\r\nCode: 47. DB::Exception: Received from localhost:9000. DB::Exception: Missing columns: 'm' while processing query: 'SELECT n, count() FROM t1 GROUP BY n ORDER BY n ASC WITH FILL INTERPOLATE ( m AS m + 1 )', required columns: 'n' 'm', maybe you meant: ['n','n']. (UNKNOWN_IDENTIFIER)\r\n```\r\n\r\n**Additional context**\r\nINTERPOLATE is a new feature added in #35349\n",
  "hints_text": "",
  "created_at": "2022-04-22T13:54:51Z"
}