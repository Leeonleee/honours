diff --git a/dbms/src/Interpreters/tests/aggregate.cpp b/dbms/src/Interpreters/tests/aggregate.cpp
index 046dbf58d9e7..65db982dbd10 100644
--- a/dbms/src/Interpreters/tests/aggregate.cpp
+++ b/dbms/src/Interpreters/tests/aggregate.cpp
@@ -79,7 +79,7 @@ int main(int argc, char ** argv)
 
         Aggregator::Params params(
             stream->getHeader(), {0, 1}, aggregate_descriptions,
-            false, 0, OverflowMode::THROW, nullptr, 0, 0, 0, 0, "");
+            false, 0, OverflowMode::THROW, nullptr, 0, 0, 0, 0, false, "");
 
         Aggregator aggregator(params);
 
diff --git a/dbms/tests/queries/0_stateless/00017_in_subquery_with_empty_result.reference b/dbms/tests/queries/0_stateless/00017_in_subquery_with_empty_result.reference
index e25c5780b65e..d4d0e64e94c4 100644
--- a/dbms/tests/queries/0_stateless/00017_in_subquery_with_empty_result.reference
+++ b/dbms/tests/queries/0_stateless/00017_in_subquery_with_empty_result.reference
@@ -9,10 +9,12 @@
 
 	"data":
 	[
-
+		{
+			"count()": "0"
+		}
 	],
 
-	"rows": 0,
+	"rows": 1,
 
 	"rows_before_limit_at_least": 1000
 }
diff --git a/dbms/tests/queries/0_stateless/00181_aggregate_functions_statistics.reference b/dbms/tests/queries/0_stateless/00181_aggregate_functions_statistics.reference
index 80cedd761917..4338ddbb0436 100644
--- a/dbms/tests/queries/0_stateless/00181_aggregate_functions_statistics.reference
+++ b/dbms/tests/queries/0_stateless/00181_aggregate_functions_statistics.reference
@@ -1,14 +1,21 @@
 nan
+nan
 0
 nan
+nan
 0
+nan
 0
 0
+nan
 0
 0
 nan
+nan
 0
+nan
 0
 0
 nan
+nan
 0
diff --git a/dbms/tests/queries/0_stateless/00181_aggregate_functions_statistics_stable.reference b/dbms/tests/queries/0_stateless/00181_aggregate_functions_statistics_stable.reference
index ce706690f1ad..9e875346c026 100644
--- a/dbms/tests/queries/0_stateless/00181_aggregate_functions_statistics_stable.reference
+++ b/dbms/tests/queries/0_stateless/00181_aggregate_functions_statistics_stable.reference
@@ -1,14 +1,21 @@
 inf
+inf
 0
 inf
+inf
 0
+inf
 0
 0
+inf
 0
 0
 inf
+inf
 0
+inf
 0
 0
 inf
+inf
 0
diff --git a/dbms/tests/queries/0_stateless/00321_pk_set.reference b/dbms/tests/queries/0_stateless/00321_pk_set.reference
index d00491fd7e5b..2b0a5dc3946c 100644
--- a/dbms/tests/queries/0_stateless/00321_pk_set.reference
+++ b/dbms/tests/queries/0_stateless/00321_pk_set.reference
@@ -1,1 +1,7 @@
+0
+0
+0
+0
+0
+0
 1
diff --git a/dbms/tests/queries/0_stateless/00572_aggregation_by_empty_set.reference b/dbms/tests/queries/0_stateless/00572_aggregation_by_empty_set.reference
new file mode 100644
index 000000000000..5c89ff2983aa
--- /dev/null
+++ b/dbms/tests/queries/0_stateless/00572_aggregation_by_empty_set.reference
@@ -0,0 +1,6 @@
+0
+0
+1
+0	0	nan	\N	[]	[]
+0	0	nan	\N	[]	[]
+1
diff --git a/dbms/tests/queries/0_stateless/00572_aggregation_by_empty_set.sql b/dbms/tests/queries/0_stateless/00572_aggregation_by_empty_set.sql
new file mode 100644
index 000000000000..8058605a7155
--- /dev/null
+++ b/dbms/tests/queries/0_stateless/00572_aggregation_by_empty_set.sql
@@ -0,0 +1,21 @@
+CREATE TEMPORARY TABLE t (x UInt8);
+
+SET empty_result_for_aggregation_by_empty_set = 0;
+
+SELECT count() FROM system.one WHERE 0;
+SELECT count() FROM system.one WHERE rand() < 0;
+SELECT count() FROM system.one WHERE 1;
+
+SELECT count(), uniq(x), avg(x), avg(toNullable(x)), groupArray(x), groupUniqArray(x) FROM t;
+SELECT count(), uniq(x), avg(x), avg(toNullable(x)), groupArray(x), groupUniqArray(x) FROM (SELECT * FROM t UNION ALL SELECT * FROM t);
+SELECT x, count(), uniq(x), avg(x), avg(toNullable(x)), groupArray(x), groupUniqArray(x) FROM t GROUP BY x;
+
+SET empty_result_for_aggregation_by_empty_set = 1;
+
+SELECT count() FROM system.one WHERE 0;
+SELECT count() FROM system.one WHERE rand() < 0;
+SELECT count() FROM system.one WHERE 1;
+
+SELECT count(), uniq(x), avg(x), avg(toNullable(x)), groupArray(x), groupUniqArray(x) FROM t;
+SELECT count(), uniq(x), avg(x), avg(toNullable(x)), groupArray(x), groupUniqArray(x) FROM (SELECT * FROM t UNION ALL SELECT * FROM t);
+SELECT x, count(), uniq(x), avg(x), avg(toNullable(x)), groupArray(x), groupUniqArray(x) FROM t GROUP BY x;
diff --git a/dbms/tests/queries/0_stateless/00573_shard_aggregation_by_empty_set.reference b/dbms/tests/queries/0_stateless/00573_shard_aggregation_by_empty_set.reference
new file mode 100644
index 000000000000..dadb1e081703
--- /dev/null
+++ b/dbms/tests/queries/0_stateless/00573_shard_aggregation_by_empty_set.reference
@@ -0,0 +1,1 @@
+0	0	nan	\N	[]	[]
diff --git a/dbms/tests/queries/0_stateless/00573_shard_aggregation_by_empty_set.sql b/dbms/tests/queries/0_stateless/00573_shard_aggregation_by_empty_set.sql
new file mode 100644
index 000000000000..8270b1eef441
--- /dev/null
+++ b/dbms/tests/queries/0_stateless/00573_shard_aggregation_by_empty_set.sql
@@ -0,0 +1,9 @@
+CREATE TEMPORARY TABLE t (x UInt8);
+
+SET empty_result_for_aggregation_by_empty_set = 0;
+SELECT count(), uniq(x), avg(x), avg(toNullable(x)), groupArray(x), groupUniqArray(x) FROM remote('127.0.0.{1..10}', system.one) WHERE (rand() AS x) < 0;
+SELECT count(), uniq(x), avg(x), avg(toNullable(x)), groupArray(x), groupUniqArray(x) FROM remote('127.0.0.{1..10}', system.one) WHERE (rand() AS x) < 0 GROUP BY x;
+
+SET empty_result_for_aggregation_by_empty_set = 1;
+SELECT count(), uniq(x), avg(x), avg(toNullable(x)), groupArray(x), groupUniqArray(x) FROM remote('127.0.0.{1..10}', system.one) WHERE (rand() AS x) < 0;
+SELECT count(), uniq(x), avg(x), avg(toNullable(x)), groupArray(x), groupUniqArray(x) FROM remote('127.0.0.{1..10}', system.one) WHERE (rand() AS x) < 0 GROUP BY x;
