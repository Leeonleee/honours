{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 11689,
  "instance_id": "ClickHouse__ClickHouse-11689",
  "issue_numbers": [
    "8665"
  ],
  "base_commit": "1e73a56a778d2f2e864f8e932d18e1b44f2beba5",
  "patch": "diff --git a/src/Interpreters/InterpreterSelectQuery.cpp b/src/Interpreters/InterpreterSelectQuery.cpp\nindex ac17a3042d86..523e467261b6 100644\n--- a/src/Interpreters/InterpreterSelectQuery.cpp\n+++ b/src/Interpreters/InterpreterSelectQuery.cpp\n@@ -973,6 +973,14 @@ void InterpreterSelectQuery::executeImpl(QueryPipeline & pipeline, const BlockIn\n \n             executeWithFill(pipeline);\n \n+            /// If we have 'WITH TIES', we need execute limit before projection,\n+            /// because in that case columns from 'ORDER BY' are used.\n+            if (query.limit_with_ties)\n+            {\n+                executeLimit(pipeline);\n+                has_prelimit = true;\n+            }\n+\n             /** We must do projection after DISTINCT because projection may remove some columns.\n               */\n             executeProjection(pipeline, expressions.final_projection);\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01142_with_ties_and_aliases.reference b/tests/queries/0_stateless/01142_with_ties_and_aliases.reference\nnew file mode 100644\nindex 000000000000..1846e07a9082\n--- /dev/null\n+++ b/tests/queries/0_stateless/01142_with_ties_and_aliases.reference\n@@ -0,0 +1,25 @@\n+0\t0\n+1\t0\n+2\t0\n+3\t0\n+4\t0\n+1\n+1\n+1\n+1\n+1\n+0\n+1\n+2\n+3\n+4\n+0\t0\n+0\t1\n+0\t2\n+0\t3\n+0\t4\n+0\t0\n+0\t1\n+0\t2\n+0\t3\n+0\t4\ndiff --git a/tests/queries/0_stateless/01142_with_ties_and_aliases.sql b/tests/queries/0_stateless/01142_with_ties_and_aliases.sql\nnew file mode 100644\nindex 000000000000..f086cb9d907c\n--- /dev/null\n+++ b/tests/queries/0_stateless/01142_with_ties_and_aliases.sql\n@@ -0,0 +1,12 @@\n+select number, intDiv(number,5) value from numbers(20) order by value limit 3 with ties;\n+\n+drop table if exists wt;\n+create table wt (a Int, b Int) engine = Memory;\n+insert into wt select 0, number from numbers(5);\n+\n+select 1 from wt order by a limit 3 with ties;\n+select b from wt order by a limit 3 with ties;\n+with a * 2 as c select a, b from wt order by c limit 3 with ties;\n+select a * 2 as c, b from wt order by c limit 3 with ties;\n+\n+drop table if exists wt;\n",
  "problem_statement": " Not found column when 'WITH TIES' is used. \n```\r\nselect number, intDiv(number,5) value from numbers(20) order by value limit 3 with ties\r\n\r\nSELECT \r\n    number, \r\n    intDiv(number, 5) AS value\r\nFROM numbers(20)\r\nORDER BY value ASC\r\nLIMIT 3\r\n WITH TIES\r\n\r\n\u2199 Progress: 0.00 rows, 0.00 B (0.00 rows/s., 0.00 B/s.) Received exception from server (version 19.16.10):\r\nCode: 10. DB::Exception: Received from localhost:9000. DB::Exception: Not found column intDiv(number, 5) in block. There are only columns: number, value. \r\n\r\n0 rows in set. Elapsed: 0.005 sec. \r\n\r\n```\r\n\r\nworkaround:\r\n\r\n```\r\nselect * from (select number, intDiv(number,5) value from numbers(20)) order by value limit 3 with ties \r\n\r\nSELECT *\r\nFROM \r\n(\r\n    SELECT \r\n        number, \r\n        intDiv(number, 5) AS value\r\n    FROM numbers(20)\r\n)\r\nORDER BY value ASC\r\nLIMIT 3\r\n WITH TIES\r\n\r\n\u250c\u2500number\u2500\u252c\u2500value\u2500\u2510\r\n\u2502      0 \u2502     0 \u2502\r\n\u2502      1 \u2502     0 \u2502\r\n\u2502      2 \u2502     0 \u2502\r\n\u2502      3 \u2502     0 \u2502\r\n\u2502      4 \u2502     0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n5 rows in set. Elapsed: 0.003 sec. \r\n```\n",
  "hints_text": "Reproduced on master.",
  "created_at": "2020-06-15T22:27:35Z"
}