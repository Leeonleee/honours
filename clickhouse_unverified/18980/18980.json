{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 18980,
  "instance_id": "ClickHouse__ClickHouse-18980",
  "issue_numbers": [
    "18190"
  ],
  "base_commit": "8004b0446f257984b58d2c3eb2ed019671388fdd",
  "patch": "diff --git a/src/Interpreters/ActionsDAG.cpp b/src/Interpreters/ActionsDAG.cpp\nindex c7fc284d8bf5..fe0bba2bf3ef 100644\n--- a/src/Interpreters/ActionsDAG.cpp\n+++ b/src/Interpreters/ActionsDAG.cpp\n@@ -544,6 +544,11 @@ std::string ActionsDAG::dumpDAG() const\n         out << \"\\n\";\n     }\n \n+    out << \"Index:\";\n+    for (const auto * node : index)\n+        out << ' ' << map[node];\n+    out << '\\n';\n+\n     return out.str();\n }\n \n@@ -692,7 +697,8 @@ ActionsDAGPtr ActionsDAG::merge(ActionsDAG && first, ActionsDAG && second)\n     /// Will store merged result in `first`.\n \n     /// This map contains nodes which should be removed from `first` index, cause they are used as inputs for `second`.\n-    std::unordered_set<Node *> removed_first_result;\n+    /// The second element is the number of removes (cause one node may be repeated several times in result).\n+    std::unordered_map<Node *, size_t> removed_first_result;\n     /// Map inputs of `second` to nodes of `first`.\n     std::unordered_map<Node *, Node *> inputs_map;\n \n@@ -717,7 +723,7 @@ ActionsDAGPtr ActionsDAG::merge(ActionsDAG && first, ActionsDAG && second)\n             else\n             {\n                 inputs_map[node] = it->second.front();\n-                removed_first_result.emplace(it->second.front());\n+                removed_first_result[it->second.front()] += 1;\n                 it->second.pop_front();\n             }\n         }\n@@ -761,8 +767,12 @@ ActionsDAGPtr ActionsDAG::merge(ActionsDAG && first, ActionsDAG && second)\n             auto cur = it;\n             ++it;\n \n-            if (removed_first_result.count(*cur))\n+            auto jt = removed_first_result.find(*cur);\n+            if (jt != removed_first_result.end() && jt->second > 0)\n+            {\n                 first.index.remove(cur);\n+                --jt->second;\n+            }\n         }\n \n         for (auto * node : second.index)\ndiff --git a/src/Interpreters/ExpressionActions.h b/src/Interpreters/ExpressionActions.h\nindex 5104f1e8e723..cbd92eb57e3c 100644\n--- a/src/Interpreters/ExpressionActions.h\n+++ b/src/Interpreters/ExpressionActions.h\n@@ -87,6 +87,7 @@ class ExpressionActions\n     const Actions & getActions() const { return actions; }\n     const std::list<Node> & getNodes() const { return actions_dag->getNodes(); }\n     const ActionsDAG & getActionsDAG() const { return *actions_dag; }\n+    const ColumnNumbers & getResultPositions() const { return result_positions; }\n \n     /// Get a list of input columns.\n     Names getRequiredColumns() const;\ndiff --git a/src/Processors/QueryPlan/ExpressionStep.cpp b/src/Processors/QueryPlan/ExpressionStep.cpp\nindex f7ca0a972dca..e23954cc0632 100644\n--- a/src/Processors/QueryPlan/ExpressionStep.cpp\n+++ b/src/Processors/QueryPlan/ExpressionStep.cpp\n@@ -100,6 +100,11 @@ void ExpressionStep::describeActions(FormatSettings & settings) const\n         first = false;\n         settings.out << action.toString() << '\\n';\n     }\n+\n+    settings.out << prefix << \"Positions:\";\n+    for (const auto & pos : expression->getResultPositions())\n+        settings.out << ' ' << pos;\n+    settings.out << '\\n';\n }\n \n JoinStep::JoinStep(const DataStream & input_stream_, JoinPtr join_)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01650_expressions_merge_bug.reference b/tests/queries/0_stateless/01650_expressions_merge_bug.reference\nnew file mode 100644\nindex 000000000000..3a48788e7543\n--- /dev/null\n+++ b/tests/queries/0_stateless/01650_expressions_merge_bug.reference\n@@ -0,0 +1,1 @@\n+\\N\t\\N\ndiff --git a/tests/queries/0_stateless/01650_expressions_merge_bug.sql b/tests/queries/0_stateless/01650_expressions_merge_bug.sql\nnew file mode 100644\nindex 000000000000..f28f663b2d4d\n--- /dev/null\n+++ b/tests/queries/0_stateless/01650_expressions_merge_bug.sql\n@@ -0,0 +1,21 @@\n+\n+SELECT\n+    NULL IN \n+    (\n+        SELECT\n+            9223372036854775807,\n+            9223372036854775807\n+    ),\n+    NULL\n+FROM \n+(\n+    SELECT DISTINCT\n+        NULL,\n+        NULL,\n+        NULL IN \n+        (\n+            SELECT (NULL, '-1')\n+        ),\n+        NULL\n+    FROM numbers(1024)\n+)\n",
  "problem_statement": "Block structure mismatch in QueryPipeline stream: different number of columns\n```\r\nSELECT\r\n    NULL IN \r\n    (\r\n        SELECT\r\n            9223372036854775807,\r\n            9223372036854775807\r\n    ),\r\n    NULL\r\nFROM \r\n(\r\n    SELECT DISTINCT\r\n        NULL,\r\n        NULL,\r\n        NULL IN \r\n        (\r\n            SELECT (NULL, '-1')\r\n        ),\r\n        NULL\r\n    FROM numbers(1024)\r\n)\r\n\r\nQuery id: 90734124-e0bb-4e6e-8c3c-7eb0faeb180d\r\n\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.848802 [ 43485 ] {90734124-e0bb-4e6e-8c3c-7eb0faeb180d} <Fatal> : Logical error: 'Block structure mismatch in QueryPipeline stream: different number of columns:\r\nin(NULL, _subquery3) Nullable(Nothing) Const(size = 0, Nullable(size = 1, Nothing(size = 1), UInt8(size = 1))), NULL Nullable(Nothing) Const(size = 0, Nullable(size = 1, Nothing(size = 1), UInt8(size = 1)))\r\nNULL Nullable(Nothing) Const(size = 0, Nullable(size = 1, Nothing(size = 1), UInt8(size = 1))), NULL Nullable(Nothing) Const(size = 0, Nullable(size = 1, Nothing(size = 1), UInt8(size = 1))), in(NULL, _subquery3) Nullable(Nothing) Const(size = 0, Nullable(size = 1, Nothing(size = 1), UInt8(size = 1))), NULL Nullable(Nothing) Const(size = 0, Nullable(size = 1, Nothing(size = 1), UInt8(size = 1)))'.\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.850460 [ 1089 ] <Fatal> BaseDaemon: ########################################\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.851027 [ 1089 ] <Fatal> BaseDaemon: (version 20.13.1.1, build id: CAFCE24B8B3F01D0E242774F447E758106BCDFE3) (from thread 43485) (query_id: 90734124-e0bb-4e6e-8c3c-7eb0faeb180d) Received signal Aborted (6)\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.851539 [ 1089 ] <Fatal> BaseDaemon: \r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.852007 [ 1089 ] <Fatal> BaseDaemon: Stack trace: 0x7fa9e938e18b 0x7fa9e936d859 0x86e219c 0x86e2241 0x10dfc533 0x10df93c6 0x10df92b5 0x11fef631 0x122740c1 0x122b4a73 0x115af1ef 0x1172ce53 0x1172b89a 0x11f3a4fb 0x11f45a08 0x1679938c 0x16799b90 0x168cdd13 0x168cac3d 0x168c9ac8 0x7fa9e9543609 0x7fa9e946a103\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.857165 [ 1089 ] <Fatal> BaseDaemon: 4. /build/glibc-YYA7BZ/glibc-2.31/signal/../sysdeps/unix/sysv/linux/raise.c:51: raise @ 0x4618b in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.31.so\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.858544 [ 1089 ] <Fatal> BaseDaemon: 5. /build/glibc-YYA7BZ/glibc-2.31/stdlib/abort.c:81: __GI_abort @ 0x25859 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.31.so\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.859379 [ 1089 ] <Fatal> BaseDaemon: 6. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Common/Exception.cpp:50: DB::handle_error_code(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x86e219c in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.859954 [ 1089 ] <Fatal> BaseDaemon: 7. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Common/Exception.cpp:56: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x86e2241 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.897298 [ 1089 ] <Fatal> BaseDaemon: 8. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Core/Block.cpp:483: void DB::checkBlockStructure<void>(DB::Block const&, DB::Block const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&)::'lambda'(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int)::operator()(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) const @ 0x10dfc533 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.935117 [ 1089 ] <Fatal> BaseDaemon: 9. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Core/Block.cpp:490: void DB::checkBlockStructure<void>(DB::Block const&, DB::Block const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0x10df93c6 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:07.972457 [ 1089 ] <Fatal> BaseDaemon: 10. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Core/Block.cpp:538: DB::assertBlocksHaveEqualStructure(DB::Block const&, DB::Block const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0x10df92b5 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.020356 [ 1089 ] <Fatal> BaseDaemon: 11. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Processors/QueryPipeline.cpp:288: DB::QueryPipeline::addPipelineBefore(DB::QueryPipeline) @ 0x11fef631 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.069952 [ 1089 ] <Fatal> BaseDaemon: 12. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Processors/QueryPlan/CreatingSetsStep.cpp:98: DB::CreatingSetsStep::updatePipeline(std::__1::vector<std::__1::unique_ptr<DB::QueryPipeline, std::__1::default_delete<DB::QueryPipeline> >, std::__1::allocator<std::__1::unique_ptr<DB::QueryPipeline, std::__1::default_delete<DB::QueryPipeline> > > >) @ 0x122740c1 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.119295 [ 1089 ] <Fatal> BaseDaemon: 13. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Processors/QueryPlan/QueryPlan.cpp:171: DB::QueryPlan::buildQueryPipeline() @ 0x122b4a73 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.159126 [ 1089 ] <Fatal> BaseDaemon: 14. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:340: DB::InterpreterSelectWithUnionQuery::execute() @ 0x115af1ef in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.200966 [ 1089 ] <Fatal> BaseDaemon: 15. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Interpreters/executeQuery.cpp:507: DB::executeQueryImpl(char const*, char const*, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool, DB::ReadBuffer*) @ 0x1172ce53 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.242855 [ 1089 ] <Fatal> BaseDaemon: 16. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Interpreters/executeQuery.cpp:839: DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool) @ 0x1172b89a in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.289545 [ 1089 ] <Fatal> BaseDaemon: 17. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Server/TCPHandler.cpp:260: DB::TCPHandler::runImpl() @ 0x11f3a4fb in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.335832 [ 1089 ] <Fatal> BaseDaemon: 18. /home/avtokmakov/ch/ClickHouse/build_debug/../src/Server/TCPHandler.cpp:1414: DB::TCPHandler::run() @ 0x11f45a08 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.397075 [ 1089 ] <Fatal> BaseDaemon: 19. /home/avtokmakov/ch/ClickHouse/build_debug/../contrib/poco/Net/src/TCPServerConnection.cpp:43: Poco::Net::TCPServerConnection::start() @ 0x1679938c in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.457744 [ 1089 ] <Fatal> BaseDaemon: 20. /home/avtokmakov/ch/ClickHouse/build_debug/../contrib/poco/Net/src/TCPServerDispatcher.cpp:112: Poco::Net::TCPServerDispatcher::run() @ 0x16799b90 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.519713 [ 1089 ] <Fatal> BaseDaemon: 21. /home/avtokmakov/ch/ClickHouse/build_debug/../contrib/poco/Foundation/src/ThreadPool.cpp:199: Poco::PooledThread::run() @ 0x168cdd13 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.581243 [ 1089 ] <Fatal> BaseDaemon: 22. /home/avtokmakov/ch/ClickHouse/build_debug/../contrib/poco/Foundation/src/Thread.cpp:56: Poco::(anonymous namespace)::RunnableHolder::run() @ 0x168cac3d in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.643135 [ 1089 ] <Fatal> BaseDaemon: 23. /home/avtokmakov/ch/ClickHouse/build_debug/../contrib/poco/Foundation/src/Thread_POSIX.cpp:345: Poco::ThreadImpl::runnableEntry(void*) @ 0x168c9ac8 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.643897 [ 1089 ] <Fatal> BaseDaemon: 24. start_thread @ 0x9609 in /lib/x86_64-linux-gnu/libpthread-2.31.so\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2020.12.17 14:20:08.644319 [ 1089 ] <Fatal> BaseDaemon: 25. /build/glibc-YYA7BZ/glibc-2.31/misc/../sysdeps/unix/sysv/linux/x86_64/clone.S:97: clone @ 0x122103 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.31.so\r\n\r\n```\r\n\r\nhttps://clickhouse-test-reports.s3.yandex.net/17642/294e8bbb4e74532af994d0118217ee5c4e4e18f0/fuzzer/fuzzer.log\r\n\n",
  "hints_text": "https://clickhouse-test-reports.s3.yandex.net/18893/79a38c4c6ea5254f9e53a5cdd81600bd269b7d6b/fuzzer/report.html#fail1",
  "created_at": "2021-01-12T19:00:16Z"
}