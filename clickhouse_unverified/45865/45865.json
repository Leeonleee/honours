{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 45865,
  "instance_id": "ClickHouse__ClickHouse-45865",
  "issue_numbers": [
    "45797"
  ],
  "base_commit": "075dfe9005d44037f1f447e3b6c13050bb7dc051",
  "patch": "diff --git a/src/Functions/FunctionsConversion.h b/src/Functions/FunctionsConversion.h\nindex d1c0d80d3462..c34cd3ac8756 100644\n--- a/src/Functions/FunctionsConversion.h\n+++ b/src/Functions/FunctionsConversion.h\n@@ -216,7 +216,7 @@ struct ConvertImpl\n                 }\n                 else if constexpr (\n                     (std::is_same_v<FromDataType, DataTypeIPv4> != std::is_same_v<ToDataType, DataTypeIPv4>)\n-                    && !(is_any_of<FromDataType, DataTypeUInt8, DataTypeUInt16, DataTypeUInt32> || is_any_of<ToDataType, DataTypeUInt32, DataTypeUInt64, DataTypeUInt128, DataTypeUInt256>)\n+                    && !(is_any_of<FromDataType, DataTypeUInt8, DataTypeUInt16, DataTypeUInt32, DataTypeUInt64> || is_any_of<ToDataType, DataTypeUInt32, DataTypeUInt64, DataTypeUInt128, DataTypeUInt256>)\n                 )\n                 {\n                     throw Exception(ErrorCodes::NOT_IMPLEMENTED, \"Conversion from {} to {} is not supported\",\n@@ -303,7 +303,10 @@ struct ConvertImpl\n                         }\n                         else\n                         {\n-                            vec_to[i] = static_cast<ToFieldType>(vec_from[i]);\n+                            if constexpr (std::is_same_v<ToDataType, DataTypeIPv4> && std::is_same_v<FromDataType, DataTypeUInt64>)\n+                                vec_to[i] = static_cast<ToFieldType>(static_cast<IPv4::UnderlyingType>(vec_from[i]));\n+                            else\n+                                vec_to[i] = static_cast<ToFieldType>(vec_from[i]);\n                         }\n                     }\n                 }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02551_ipv4_implicit_uint64.reference b/tests/queries/0_stateless/02551_ipv4_implicit_uint64.reference\nnew file mode 100644\nindex 000000000000..ece1759ef649\n--- /dev/null\n+++ b/tests/queries/0_stateless/02551_ipv4_implicit_uint64.reference\n@@ -0,0 +1,2 @@\n+85.85.85.85\n+138.68.230.86\ndiff --git a/tests/queries/0_stateless/02551_ipv4_implicit_uint64.sql b/tests/queries/0_stateless/02551_ipv4_implicit_uint64.sql\nnew file mode 100644\nindex 000000000000..ff04f553851c\n--- /dev/null\n+++ b/tests/queries/0_stateless/02551_ipv4_implicit_uint64.sql\n@@ -0,0 +1,4 @@\n+CREATE TABLE ip4test (ip IPv4) ENGINE=Memory;\n+INSERT INTO ip4test VALUES (22906492245), (2319771222);\n+SELECT * FROM ip4test;\n+DROP TABLE ip4test;\n",
  "problem_statement": "Conversion from UInt64 to IPv4 is not supported\nNew IPv4 as native code causes inserting IPv4 as UInt32 broken with error \"Conversion from UInt64 to IPv4 is not supported\";\r\n\r\nCREATE TABLE users (ip IPv4) ENGINE=Memory;\r\nINSERT INTO users VALUES (2319771222);\r\nDB::Exception: Conversion from UInt64 to IPv4 is not supported:\n",
  "hints_text": "Related to https://github.com/ClickHouse/ClickHouse/pull/43221",
  "created_at": "2023-01-31T19:09:51Z"
}