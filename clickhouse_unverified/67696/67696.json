{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 67696,
  "instance_id": "ClickHouse__ClickHouse-67696",
  "issue_numbers": [
    "67695"
  ],
  "base_commit": "3dc73ad6771a86f7dd8867aeb06338edf0bf3304",
  "patch": "diff --git a/src/Databases/DatabaseOnDisk.cpp b/src/Databases/DatabaseOnDisk.cpp\nindex f419f5811a11..734f354d9a5a 100644\n--- a/src/Databases/DatabaseOnDisk.cpp\n+++ b/src/Databases/DatabaseOnDisk.cpp\n@@ -313,7 +313,7 @@ void DatabaseOnDisk::detachTablePermanently(ContextPtr query_context, const Stri\n         std::lock_guard lock(mutex);\n         if (const auto it = snapshot_detached_tables.find(table_name); it == snapshot_detached_tables.end())\n         {\n-            throw Exception(ErrorCodes::LOGICAL_ERROR, \"Snapshot doesn't contain info about detached table={}\", table_name);\n+            throw Exception(ErrorCodes::LOGICAL_ERROR, \"Snapshot doesn't contain info about detached table `{}`\", table_name);\n         }\n         else\n         {\n",
  "test_patch": "diff --git a/tests/ci/ci.py b/tests/ci/ci.py\nindex 935fe472e502..805296d2bb2e 100644\n--- a/tests/ci/ci.py\n+++ b/tests/ci/ci.py\n@@ -1019,7 +1019,9 @@ def _get_ext_check_name(check_name: str) -> str:\n     return check_name_with_group\n \n \n-def _cancel_pr_wf(s3: S3Helper, pr_number: int, cancel_sync: bool = False) -> None:\n+def _cancel_pr_workflow(\n+    s3: S3Helper, pr_number: int, cancel_sync: bool = False\n+) -> None:\n     wf_data = CiMetadata(s3, pr_number).fetch_meta()\n     if not cancel_sync:\n         if not wf_data.run_id:\n@@ -1368,12 +1370,12 @@ def main() -> int:\n         assert indata, \"Run config must be provided via --infile\"\n         _update_gh_statuses_action(indata=indata, s3=s3)\n \n-    ### CANCEL PREVIOUS WORKFLOW RUN\n+    ### CANCEL THE PREVIOUS WORKFLOW RUN\n     elif args.cancel_previous_run:\n         if pr_info.is_merge_queue:\n-            _cancel_pr_wf(s3, pr_info.merged_pr)\n+            _cancel_pr_workflow(s3, pr_info.merged_pr)\n         elif pr_info.is_pr:\n-            _cancel_pr_wf(s3, pr_info.number, cancel_sync=True)\n+            _cancel_pr_workflow(s3, pr_info.number, cancel_sync=True)\n         else:\n             assert False, \"BUG! Not supported scenario\"\n \ndiff --git a/tests/ci/clickhouse_helper.py b/tests/ci/clickhouse_helper.py\nindex 287970cce9a3..0725f7100d15 100644\n--- a/tests/ci/clickhouse_helper.py\n+++ b/tests/ci/clickhouse_helper.py\n@@ -3,6 +3,7 @@\n import json\n import logging\n import time\n+import os\n from pathlib import Path\n from typing import Any, Dict, List, Optional\n \n@@ -298,6 +299,11 @@ def create_ci_logs_credentials(self) -> None:\n     def get_docker_arguments(\n         self, pr_info: PRInfo, check_start_time: str, check_name: str\n     ) -> str:\n+        run_by_hash_total = int(os.getenv(\"RUN_BY_HASH_TOTAL\", \"0\"))\n+        if run_by_hash_total > 1:\n+            run_by_hash_num = int(os.getenv(\"RUN_BY_HASH_NUM\", \"0\"))\n+            check_name = f\"{check_name} [{run_by_hash_num + 1}/{run_by_hash_total}]\"\n+\n         self.create_ci_logs_credentials()\n         if not self.config_path.exists():\n             logging.info(\"Do not use external logs pushing\")\ndiff --git a/tests/ci/commit_status_helper.py b/tests/ci/commit_status_helper.py\nindex fdc9c002b66a..908ac4a7dcaf 100644\n--- a/tests/ci/commit_status_helper.py\n+++ b/tests/ci/commit_status_helper.py\n@@ -301,7 +301,7 @@ def get_worst_state(statuses: CommitStatuses) -> StatusType:\n \n \n def create_ci_report(pr_info: PRInfo, statuses: CommitStatuses) -> str:\n-    \"\"\"The function converst the statuses to TestResults and uploads the report\n+    \"\"\"The function converts the statuses to TestResults and uploads the report\n     to S3 tests bucket. Then it returns the URL\"\"\"\n     test_results = []  # type: TestResults\n     for status in statuses:\ndiff --git a/tests/ci/report.py b/tests/ci/report.py\nindex f50ed4c1f856..3f0fc596824f 100644\n--- a/tests/ci/report.py\n+++ b/tests/ci/report.py\n@@ -293,9 +293,9 @@ class JobReport:\n     start_time: str\n     duration: float\n     additional_files: Union[Sequence[str], Sequence[Path]]\n-    # clickhouse version, build job only\n+    # ClickHouse version, build job only\n     version: str = \"\"\n-    # checkname to set in commit status, set if differs from jjob name\n+    # check_name to be set in commit status, set it if it differs from the job name\n     check_name: str = \"\"\n     # directory with artifacts to upload on s3\n     build_dir_for_upload: Union[Path, str] = \"\"\n@@ -667,11 +667,7 @@ class ReportColor:\n def _format_header(\n     header: str, branch_name: str, branch_url: Optional[str] = None\n ) -> str:\n-    # Following line does not lower CI->Ci and SQLancer->Sqlancer. It only\n-    # capitalizes the first letter and doesn't touch the rest of the word\n-    result = \" \".join([w[0].upper() + w[1:] for w in header.split(\" \") if w])\n-    result = result.replace(\"Clickhouse\", \"ClickHouse\")\n-    result = result.replace(\"clickhouse\", \"ClickHouse\")\n+    result = header\n     if \"ClickHouse\" not in result:\n         result = f\"ClickHouse {result}\"\n     if branch_url:\n",
  "problem_statement": "Different check names in the CI database and in the report\nThe CI checks database has names like `Stateless tests (tsan) [1/4]`: https://play.clickhouse.com/play?user=play#U0VMRUNUIGNoZWNrX3N0YXJ0X3RpbWUsIGNoZWNrX25hbWUsIHRlc3RfbmFtZSwgcmVwb3J0X3VybApGUk9NIGNoZWNrcwpXSEVSRSBjaGVja19zdGFydF90aW1lID49IG5vdygpIC0gSU5URVJWQUwgMjQgSE9VUgogICAgQU5EIHB1bGxfcmVxdWVzdF9udW1iZXIgPSAwCiAgICBBTkQgdGVzdF9zdGF0dXMgIT0gJ1NLSVBQRUQnCiAgICBBTkQgKHRlc3Rfc3RhdHVzIExJS0UgJ0YlJyBPUiB0ZXN0X3N0YXR1cyBMSUtFICdFJScpIAogICAgQU5EIGNoZWNrX3N0YXR1cyAhPSAnc3VjY2VzcycKT1JERVIgQlkgY2hlY2tfc3RhcnRfdGltZQ==\r\n\r\nThe CI logs database has names like `Stateless tests (tsan)`.\r\n\r\nThe HTML report names it as `ClickHouse Stateless Tests (tsan) [1/4]`: https://s3.amazonaws.com/clickhouse-test-reports/67653/c50ef37a03438003c21076c5700d9c1f52c1c435/stateless_tests__tsan__[1_4].html\r\n\r\nI don't know why there is such a difference.\r\n\r\nAt least the CI logs database should have the suffix `[1/4]`.\r\n\n",
  "hints_text": "",
  "created_at": "2024-08-02T18:12:14Z",
  "modified_files": [
    "src/Databases/DatabaseOnDisk.cpp"
  ],
  "modified_test_files": [
    "tests/ci/ci.py",
    "tests/ci/clickhouse_helper.py",
    "tests/ci/commit_status_helper.py",
    "tests/ci/report.py"
  ]
}