{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 55529,
  "instance_id": "ClickHouse__ClickHouse-55529",
  "issue_numbers": [
    "55501"
  ],
  "base_commit": "749412bfebdc2ac7b6e44ce3ed2a6bac760a9911",
  "patch": "diff --git a/src/Storages/MergeTree/MergeTreeData.cpp b/src/Storages/MergeTree/MergeTreeData.cpp\nindex fd5d9f736cce..889dcfa537f2 100644\n--- a/src/Storages/MergeTree/MergeTreeData.cpp\n+++ b/src/Storages/MergeTree/MergeTreeData.cpp\n@@ -2893,12 +2893,12 @@ void MergeTreeData::checkAlterIsPossible(const AlterCommands & commands, Context\n                             queryToString(mutation_commands.ast()));\n     }\n \n+    commands.apply(new_metadata, getContext());\n+\n     if (commands.hasInvertedIndex(new_metadata) && !settings.allow_experimental_inverted_index)\n         throw Exception(ErrorCodes::SUPPORT_IS_DISABLED,\n                 \"Experimental Inverted Index feature is not enabled (turn on setting 'allow_experimental_inverted_index')\");\n \n-    commands.apply(new_metadata, getContext());\n-\n     /// Set of columns that shouldn't be altered.\n     NameSet columns_alter_type_forbidden;\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02895_forbid_create_inverted_index.reference b/tests/queries/0_stateless/02895_forbid_create_inverted_index.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02895_forbid_create_inverted_index.sql b/tests/queries/0_stateless/02895_forbid_create_inverted_index.sql\nnew file mode 100644\nindex 000000000000..dc92d9198fb8\n--- /dev/null\n+++ b/tests/queries/0_stateless/02895_forbid_create_inverted_index.sql\n@@ -0,0 +1,13 @@\n+SET allow_experimental_inverted_index = 0;\n+DROP TABLE IF EXISTS tab;\n+CREATE TABLE tab\n+(\n+    `key` UInt64,\n+    `str` String\n+)\n+ENGINE = MergeTree\n+ORDER BY key;\n+\n+ALTER TABLE tab ADD INDEX inv_idx(str) TYPE inverted(0); -- { serverError SUPPORT_IS_DISABLED }\n+\n+DROP TABLE tab;\n",
  "problem_statement": "Disallow `ADD INDEX TYPE inverted` unless `allow_experimental_inverted_index = 1`\n**Describe the unexpected behaviour**\r\n`ALTER TABLE ADD INDEX TYPE inverted` should require `allow_experimental_inverted_index = 1`. \r\n\r\n**How to reproduce**\r\n* Which ClickHouse server version to use - 23.8, 23.3\r\n\r\nCreating a table with `INDEX TYPE inverted` is not allowed unless we set `allow_experimental_inverted_index = 1`\r\n```\r\nCREATE OR REPLACE TABLE tab\r\n(\r\n    `key` UInt64,\r\n    `str` String,\r\n    INDEX inv_idx str TYPE inverted(0) GRANULARITY 1\r\n)\r\nENGINE = MergeTree\r\nORDER BY key\r\n\r\nReceived exception from server (version 23.8.2):\r\nCode: 344. DB::Exception: Received from localhost:9000. DB::Exception: Experimental Inverted Index feature is not enabled (the setting 'allow_experimental_inverted_index'). (SUPPORT_IS_DISABLED)\r\n```\r\n\r\nHowever, we are allowed to add index of type inverted after the table is created. \r\n```\r\na8346b53da63 :) select getSetting('allow_experimental_inverted_index')\r\n\r\nSELECT getSetting('allow_experimental_inverted_index')\r\n\r\nQuery id: a896c4bd-9c9c-4821-8d63-0b5f1a777778\r\n\r\n\u250c\u2500getSetting('allow_experimental_inverted_index')\u2500\u2510\r\n\u2502 false                                           \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.004 sec.\r\n\r\na8346b53da63 :) CREATE OR REPLACE TABLE tab\r\n(\r\n    `key` UInt64,\r\n    `str` String\r\n)\r\nENGINE = MergeTree\r\nORDER BY key;\r\n\r\nALTER TABLE tab ADD INDEX inv_idx(str) TYPE inverted(0);\r\n\r\n\r\nCREATE OR REPLACE TABLE tab\r\n(\r\n    `key` UInt64,\r\n    `str` String\r\n)\r\nENGINE = MergeTree\r\nORDER BY key\r\n\r\nQuery id: d052d090-e372-4b1c-8c73-04a28b2b2b05\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.017 sec.\r\n\r\n\r\nALTER TABLE tab\r\n    ADD INDEX inv_idx str TYPE inverted(0) GRANULARITY 1\r\n\r\nQuery id: 78335436-cc93-4c85-b1a0-99c4e9c97805\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.005 sec.\r\n```\r\n\r\n**Expected behavior**\r\nDisallow `ADD INDEX TYPE inverted` unless `allow_experimental_inverted_index = 1`\n",
  "hints_text": "",
  "created_at": "2023-10-12T03:52:00Z",
  "modified_files": [
    "src/Storages/MergeTree/MergeTreeData.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02895_forbid_create_inverted_index.sql"
  ]
}