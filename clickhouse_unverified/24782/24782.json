{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 24782,
  "instance_id": "ClickHouse__ClickHouse-24782",
  "issue_numbers": [
    "24780"
  ],
  "base_commit": "0b0c970128c2747a9896289694ea25bd5b826df1",
  "patch": "diff --git a/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp b/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp\nindex 20cadb530985..e2f179156240 100644\n--- a/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp\n+++ b/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp\n@@ -144,11 +144,7 @@ QueryPlanPtr MergeTreeDataSelectExecutor::read(\n     const auto & settings = context->getSettingsRef();\n     if (!query_info.projection)\n     {\n-        if (settings.allow_experimental_projection_optimization && settings.force_optimize_projection\n-            && !metadata_snapshot->projections.empty())\n-            throw Exception(\"No projection is used when allow_experimental_projection_optimization = 1\", ErrorCodes::PROJECTION_NOT_USED);\n-\n-        return readFromParts(\n+        auto plan = readFromParts(\n             data.getDataPartsVector(),\n             column_names_to_return,\n             metadata_snapshot,\n@@ -159,6 +155,14 @@ QueryPlanPtr MergeTreeDataSelectExecutor::read(\n             num_streams,\n             max_block_numbers_to_read,\n             query_info.merge_tree_data_select_cache.get());\n+\n+        if (plan->isInitialized() && settings.allow_experimental_projection_optimization && settings.force_optimize_projection\n+            && !metadata_snapshot->projections.empty())\n+            throw Exception(\n+                \"No projection is used when allow_experimental_projection_optimization = 1 and force_optimize_projection = 1\",\n+                ErrorCodes::PROJECTION_NOT_USED);\n+\n+        return plan;\n     }\n \n     LOG_DEBUG(\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01710_force_use_projection.reference b/tests/queries/0_stateless/01710_force_use_projection.reference\nnew file mode 100644\nindex 000000000000..f1ad7de51f0e\n--- /dev/null\n+++ b/tests/queries/0_stateless/01710_force_use_projection.reference\n@@ -0,0 +1,1 @@\n+3\t1\ndiff --git a/tests/queries/0_stateless/01710_force_use_projection.sql b/tests/queries/0_stateless/01710_force_use_projection.sql\nnew file mode 100644\nindex 000000000000..8931c65e34e3\n--- /dev/null\n+++ b/tests/queries/0_stateless/01710_force_use_projection.sql\n@@ -0,0 +1,17 @@\n+drop table if exists tp;\n+\n+create table tp (d1 Int32, d2 Int32, eventcnt Int64, projection p (select sum(eventcnt) group by d1)) engine = MergeTree order by (d1, d2);\n+\n+set allow_experimental_projection_optimization = 1, force_optimize_projection = 1;\n+\n+select sum(eventcnt) eventcnt, d1 from tp group by d1;\n+\n+select avg(eventcnt) eventcnt, d1 from tp group by d1;\n+\n+insert into tp values (1, 2, 3);\n+\n+select sum(eventcnt) eventcnt, d1 from tp group by d1;\n+\n+select avg(eventcnt) eventcnt, d1 from tp group by d1; -- { serverError 584 }\n+\n+drop table tp;\n",
  "problem_statement": "false exception \"No projection is used\" when all parts are eliminated (pruned)\n```sql\r\nDROP TABLE IF EXISTS tp;\r\n\r\ncreate table tp (d1 Int32, d2 Int32, eventcnt Int64,\r\nprojection p (select sum(eventcnt), d1 group by d1)) \r\nengine = SummingMergeTree order by (d1, d2);\r\n\r\nset allow_experimental_projection_optimization = 1, force_optimize_projection = 1;\r\n\r\nselect sum(eventcnt) eventcnt, d1\r\nfrom tp\r\ngroup by d1;\r\n\r\nDB::Exception: No projection is used when allow_experimental_projection_optimization = 1.\r\n\r\n```\r\n\r\nThe exception message is also incorrect, should be \"when force_optimize_projection = 1\".\r\n\n",
  "hints_text": "",
  "created_at": "2021-05-31T02:33:05Z",
  "modified_files": [
    "src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01710_force_use_projection.reference",
    "b/tests/queries/0_stateless/01710_force_use_projection.sql"
  ]
}