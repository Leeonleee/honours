{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 63694,
  "instance_id": "ClickHouse__ClickHouse-63694",
  "issue_numbers": [
    "63539"
  ],
  "base_commit": "6c0450f8ffd30d9d069e8dea1c78f05e6042135f",
  "patch": "diff --git a/src/Analyzer/Passes/QueryAnalysisPass.cpp b/src/Analyzer/Passes/QueryAnalysisPass.cpp\nindex 52efee03ae49..dea56de86731 100644\n--- a/src/Analyzer/Passes/QueryAnalysisPass.cpp\n+++ b/src/Analyzer/Passes/QueryAnalysisPass.cpp\n@@ -8009,7 +8009,12 @@ void QueryAnalyzer::resolveQuery(const QueryTreeNodePtr & query_node, Identifier\n             window_node_typed.setParentWindowName({});\n         }\n \n-        scope.window_name_to_window_node.emplace(window_node_typed.getAlias(), window_node);\n+        auto [_, inserted] = scope.window_name_to_window_node.emplace(window_node_typed.getAlias(), window_node);\n+        if (!inserted)\n+            throw Exception(ErrorCodes::BAD_ARGUMENTS,\n+                \"Window '{}' is already defined. In scope {}\",\n+                window_node_typed.getAlias(),\n+                scope.scope_node->formatASTForErrorMessage());\n     }\n \n     /** Disable identifier cache during JOIN TREE resolve.\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03149_analyzer_window_redefinition.reference b/tests/queries/0_stateless/03149_analyzer_window_redefinition.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/03149_analyzer_window_redefinition.sql b/tests/queries/0_stateless/03149_analyzer_window_redefinition.sql\nnew file mode 100644\nindex 000000000000..7bc5ec7579cf\n--- /dev/null\n+++ b/tests/queries/0_stateless/03149_analyzer_window_redefinition.sql\n@@ -0,0 +1,8 @@\n+CREATE TABLE users (uid Int16, name String, age Int16) ENGINE=MergeTree ORDER BY tuple();\n+\n+INSERT INTO users VALUES (1231, 'John', 33);\n+INSERT INTO users VALUES (6666, 'Ksenia', 48);\n+INSERT INTO users VALUES (8888, 'Alice', 50);\n+\n+SELECT count(*) OVER w \n+FROM users WINDOW w AS (ORDER BY uid), w AS(ORDER BY name); -- { serverError BAD_ARGUMENTS }\n",
  "problem_statement": "No exception when window is defined twice with experimental analyzer on\nhttps://fiddle.clickhouse.com/7c46c2a4-8936-4b00-a08e-5a6f6e8aa430\r\n\r\n```sql\r\nCREATE TABLE users (uid Int16, name String, age Int16) ENGINE=MergeTree ORDER BY tuple();\r\n\r\nINSERT INTO users VALUES (1231, 'John', 33);\r\nINSERT INTO users VALUES (6666, 'Ksenia', 48);\r\nINSERT INTO users VALUES (8888, 'Alice', 50);\r\n```\r\n```sql\r\nSELECT count(*) OVER w \r\nFROM users WINDOW w AS (ORDER BY uid), w AS(ORDER BY name) \r\n```\r\n```\r\nCode: 36. DB::Exception: Received from localhost:9000. DB::Exception: Window 'w' is defined twice in the WINDOW clause. (BAD_ARGUMENTS)\r\n```\r\nThe same query with analyzer:\r\n```sql\r\nSELECT count(*) OVER w \r\nFROM users WINDOW w AS (ORDER BY uid), w AS(ORDER BY name)  \r\nSETTINGS allow_experimental_analyzer=1\r\n```\r\n```\r\n1\r\n3\r\n2\r\n```\r\n\r\nIs this change intentional? \r\n\n",
  "hints_text": "",
  "created_at": "2024-05-13T13:17:42Z"
}