{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 31031,
  "instance_id": "ClickHouse__ClickHouse-31031",
  "issue_numbers": [
    "30942"
  ],
  "base_commit": "e3650b865a7a1fced1d630dc17e534d24cc864c0",
  "patch": "diff --git a/src/Common/ErrorCodes.cpp b/src/Common/ErrorCodes.cpp\nindex 13d6632037a9..26e0b7ad9fa0 100644\n--- a/src/Common/ErrorCodes.cpp\n+++ b/src/Common/ErrorCodes.cpp\n@@ -595,6 +595,7 @@\n     M(625, IO_SETUP_ERROR) \\\n     M(626, CANNOT_SKIP_UNKNOWN_FIELD) \\\n     M(627, BACKUP_ENGINE_NOT_FOUND) \\\n+    M(628, OFFSET_FETCH_WITHOUT_ORDER_BY) \\\n     \\\n     M(999, KEEPER_EXCEPTION) \\\n     M(1000, POCO_EXCEPTION) \\\ndiff --git a/src/Parsers/ParserSelectQuery.cpp b/src/Parsers/ParserSelectQuery.cpp\nindex b1f7570878fe..90ab5911d6bb 100644\n--- a/src/Parsers/ParserSelectQuery.cpp\n+++ b/src/Parsers/ParserSelectQuery.cpp\n@@ -23,6 +23,7 @@ namespace ErrorCodes\n     extern const int SYNTAX_ERROR;\n     extern const int TOP_AND_LIMIT_TOGETHER;\n     extern const int WITH_TIES_WITHOUT_ORDER_BY;\n+    extern const int OFFSET_FETCH_WITHOUT_ORDER_BY;\n }\n \n \n@@ -323,7 +324,7 @@ bool ParserSelectQuery::parseImpl(Pos & pos, ASTPtr & node, Expected & expected)\n         {\n             /// OFFSET FETCH clause must exists with \"ORDER BY\"\n             if (!order_expression_list)\n-                return false;\n+                throw Exception(\"Can not use OFFSET FETCH clause without ORDER BY\", ErrorCodes::OFFSET_FETCH_WITHOUT_ORDER_BY);\n \n             if (s_first.ignore(pos, expected))\n             {\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02114_offset_fetch_without_order_by.reference b/tests/queries/0_stateless/02114_offset_fetch_without_order_by.reference\nnew file mode 100644\nindex 000000000000..f3c09026c90c\n--- /dev/null\n+++ b/tests/queries/0_stateless/02114_offset_fetch_without_order_by.reference\n@@ -0,0 +1,1 @@\n+Code: 628\ndiff --git a/tests/queries/0_stateless/02114_offset_fetch_without_order_by.sh b/tests/queries/0_stateless/02114_offset_fetch_without_order_by.sh\nnew file mode 100755\nindex 000000000000..9c48a6b8f2a7\n--- /dev/null\n+++ b/tests/queries/0_stateless/02114_offset_fetch_without_order_by.sh\n@@ -0,0 +1,7 @@\n+#!/usr/bin/env bash\n+\n+CUR_DIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CUR_DIR\"/../shell_config.sh\n+\n+$CLICKHOUSE_CURL -sS \"$CLICKHOUSE_URL\" -d \"SELECT number from numbers(10) OFFSET 1 ROWS FETCH FIRST 1 ROWS ONLY;\" | grep -oF 'Code: 628'\n",
  "problem_statement": "Syntax error: failed at position xx ('FETCH'): Expected FETCH\n**Describe the unexpected behaviour**\r\nOFFSET can work without ORDER BY , but OFFSET FETCH cannot work without ORDER BY, and throw strange syntax error: `failed at 'FETCH' Expected FETCH`.\r\n\r\n**How to reproduce**\r\n* Clickhouse Version: `21.10.2.15`\r\n* `CREATE TABLE test_fetch (a INT, b INT) ENGINE=MergeTree ORDER BY b;`\r\n* `INSERT INTO test_fetch VALUES (1, 1), (2, 1), (3, 4), (1, 4), (5, 4), (0, 6), (5, 7);`\r\n* `OFFSET` without `ORDER BY` works: `SELECT * FROM test_fetch OFFSET 3 ROW;`\r\n* `OFFSET FETCH` with `ORDER BY` works: `SELECT * FROM test_fetch ORDER BY a OFFSET 3 ROWS FETCH FIRST 3 ROWS ONLY;`\r\n* `OFFSET FETCH` without `ORDER BY`  does ***NOT*** work: `SELECT * FROM test_fetch OFFSET 3 ROWS FETCH FIRST 3 ROWS ONLY;`\r\n\r\n**Expected behavior**\r\nSame behavior or correct error message.\r\n\r\n**Error message and/or stacktrace**\r\n![OFFSET-FETCH](https://user-images.githubusercontent.com/3500109/139619530-04433404-73ed-4fc6-a76a-68cb65a5bb31.png)\r\n\r\n\n",
  "hints_text": "",
  "created_at": "2021-11-03T06:01:29Z",
  "modified_files": [
    "src/Common/ErrorCodes.cpp",
    "src/Parsers/ParserSelectQuery.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02114_offset_fetch_without_order_by.reference",
    "b/tests/queries/0_stateless/02114_offset_fetch_without_order_by.sh"
  ]
}