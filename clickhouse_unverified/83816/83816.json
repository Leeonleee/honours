{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 83816,
  "instance_id": "ClickHouse__ClickHouse-83816",
  "issue_numbers": [
    "83514"
  ],
  "base_commit": "abbcdcea39da0629d56ade57984f9909673e0af6",
  "patch": "diff --git a/src/IO/WriteBufferValidUTF8.cpp b/src/IO/WriteBufferValidUTF8.cpp\nindex f245f8797674..9d11a444d1b8 100644\n--- a/src/IO/WriteBufferValidUTF8.cpp\n+++ b/src/IO/WriteBufferValidUTF8.cpp\n@@ -142,7 +142,16 @@ void WriteBufferValidUTF8::nextImpl()\n WriteBufferValidUTF8::~WriteBufferValidUTF8()\n {\n     if (!canceled)\n-        finalize();\n+    {\n+        try\n+        {\n+            finalize();\n+        }\n+        catch (...)\n+        {\n+            tryLogCurrentException(__PRETTY_FUNCTION__);\n+        }\n+    }\n }\n \n void WriteBufferValidUTF8::finalizeImpl()\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03567_finalize_write_buffer_valid_utf8.reference b/tests/queries/0_stateless/03567_finalize_write_buffer_valid_utf8.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/03567_finalize_write_buffer_valid_utf8.sql b/tests/queries/0_stateless/03567_finalize_write_buffer_valid_utf8.sql\nnew file mode 100644\nindex 000000000000..5f8c4cddabc4\n--- /dev/null\n+++ b/tests/queries/0_stateless/03567_finalize_write_buffer_valid_utf8.sql\n@@ -0,0 +1,1 @@\n+INSERT INTO TABLE FUNCTION file(currentDatabase(), 'JSONColumns', 'c0 Enum(x\\'e2\\' = 1)') SELECT -1 SETTINGS output_format_json_validate_utf8 = 1; -- { serverError UNKNOWN_ELEMENT_OF_ENUM }\n",
  "problem_statement": "JSONColumns with output_format_json_validate_utf8 crash\n### Describe the bug\n\nThis is a regression since v24.11\n\n### How to reproduce\n\nRun Fiddle: https://fiddle.clickhouse.com/a2009a79-96a1-4d5d-bc1f-1dc9f4f93522\n\n### Error message and/or stacktrace\n\nStack trace is long. It's a uncaught exception: https://pastila.nl/?000cba97/28f0daeb625771887bb3a20090b5a3dc#PDTzh0T+53FLdOfGpdjp+Q==\n",
  "hints_text": "Also triggers with `output_format_parallel_formatting = 0` https://fiddle.clickhouse.com/a292dd7b-f70e-4d4b-a83a-c2f63f4885fe",
  "created_at": "2025-07-15T23:59:17Z"
}