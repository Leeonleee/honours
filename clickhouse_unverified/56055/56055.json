{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 56055,
  "instance_id": "ClickHouse__ClickHouse-56055",
  "issue_numbers": [
    "53718"
  ],
  "base_commit": "ecafc77e0fc30b9892d2741b108e0af2c0720e16",
  "patch": "diff --git a/src/Analyzer/Passes/QueryAnalysisPass.cpp b/src/Analyzer/Passes/QueryAnalysisPass.cpp\nindex 5cdd18b4b2f9..c6fbd728b8f7 100644\n--- a/src/Analyzer/Passes/QueryAnalysisPass.cpp\n+++ b/src/Analyzer/Passes/QueryAnalysisPass.cpp\n@@ -970,6 +970,10 @@ class QueryExpressionsAliasVisitor : public InDepthQueryTreeVisitor<QueryExpress\n         if (!node->hasAlias())\n             return;\n \n+        // We should not resolve expressions to WindowNode\n+        if (node->getNodeType() == QueryTreeNodeType::WINDOW)\n+            return;\n+\n         const auto & alias = node->getAlias();\n \n         if (is_lambda_node)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02901_analyzer_recursive_window.reference b/tests/queries/0_stateless/02901_analyzer_recursive_window.reference\nnew file mode 100644\nindex 000000000000..e8183f05f5db\n--- /dev/null\n+++ b/tests/queries/0_stateless/02901_analyzer_recursive_window.reference\n@@ -0,0 +1,3 @@\n+1\n+1\n+1\ndiff --git a/tests/queries/0_stateless/02901_analyzer_recursive_window.sql b/tests/queries/0_stateless/02901_analyzer_recursive_window.sql\nnew file mode 100644\nindex 000000000000..49feb897b031\n--- /dev/null\n+++ b/tests/queries/0_stateless/02901_analyzer_recursive_window.sql\n@@ -0,0 +1,4 @@\n+SELECT 1 WINDOW x AS (PARTITION BY x); -- { serverError UNKNOWN_IDENTIFIER }\n+SELECT 1 WINDOW x AS (PARTITION BY dummy);\n+SELECT 1 WINDOW dummy AS (PARTITION BY dummy);\n+SELECT count() OVER dummy WINDOW dummy AS (PARTITION BY dummy);\n",
  "problem_statement": "ClickHouse Server v23.7.4.5 crashed by a SELECT statement with allow_experimental_analyzer enabled (\"SELECT 1 WINDOW ...\")\n**Describe the bug**\r\nClickHouse Server v23.7.4.5 crashed by a SELECT statement with allow_experimental_analyzer enabled.\r\nIt was found by an in-development fuzzer of WINGFUZZ.\r\n\r\n**How to reproduce**\r\nThe SQL statement to reproduce:\r\n```sql\r\nSELECT 1 WINDOW x AS ( PARTITION BY x )  SETTINGS allow_experimental_analyzer = 1 ;\r\n```\r\nIt can be reproduced on the official docker image. (`clickhouse/clickhouse-server:head` (version 23.8.1.2413) and `clickhouse/clickhouse-server:latest` (version 23.7.4.5)).\r\n\r\nThe log traced by ClickHouse Server:\r\n```\r\nSELECT 1\r\nWINDOW x AS (PARTITION BY x)\r\nSETTINGS allow_experimental_analyzer = 1\r\n\r\nQuery id: 840148ee-451f-4379-b5e3-ad4ce8678ed4\r\n\r\n[8af69c367457] 2023.08.23 07:54:07.366367 [ 347 ] <Fatal> BaseDaemon: ########################################\r\n[8af69c367457] 2023.08.23 07:54:07.366402 [ 347 ] <Fatal> BaseDaemon: (version 23.8.1.2413 (official build), build id: 4DCA66DD83B2161C82851B4655CD14334A08D535, git hash: 926533306c5969b77571e66163a6930cfce1cf86) (from thread 48) (query_id: 840148ee-451f-4379-b5e3-ad4ce8678ed4) (query: SELECT 1 WINDOW x AS ( PARTITION BY x )  SETTINGS allow_experimental_analyzer = 1 ;) Received signal Segmentation fault (11)\r\n[8af69c367457] 2023.08.23 07:54:07.366419 [ 347 ] <Fatal> BaseDaemon: Address: 0x7fffd2030fa8. Access: write. Attempted access has violated the permissions assigned to the memory area.\r\n[8af69c367457] 2023.08.23 07:54:07.366430 [ 347 ] <Fatal> BaseDaemon: Stack trace: 0x0000000011cadf40 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58 0x0000000011cadf58\r\n[8af69c367457] 2023.08.23 07:54:07.366503 [ 347 ] <Fatal> BaseDaemon: 2. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf40 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366532 [ 347 ] <Fatal> BaseDaemon: 3. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366564 [ 347 ] <Fatal> BaseDaemon: 4. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366596 [ 347 ] <Fatal> BaseDaemon: 5. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366628 [ 347 ] <Fatal> BaseDaemon: 6. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366655 [ 347 ] <Fatal> BaseDaemon: 7. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366686 [ 347 ] <Fatal> BaseDaemon: 8. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366709 [ 347 ] <Fatal> BaseDaemon: 9. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366739 [ 347 ] <Fatal> BaseDaemon: 10. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366775 [ 347 ] <Fatal> BaseDaemon: 11. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366820 [ 347 ] <Fatal> BaseDaemon: 12. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366851 [ 347 ] <Fatal> BaseDaemon: 13. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366874 [ 347 ] <Fatal> BaseDaemon: 14. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366900 [ 347 ] <Fatal> BaseDaemon: 15. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366927 [ 347 ] <Fatal> BaseDaemon: 16. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366955 [ 347 ] <Fatal> BaseDaemon: 17. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.366986 [ 347 ] <Fatal> BaseDaemon: 18. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367015 [ 347 ] <Fatal> BaseDaemon: 19. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367047 [ 347 ] <Fatal> BaseDaemon: 20. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367075 [ 347 ] <Fatal> BaseDaemon: 21. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367104 [ 347 ] <Fatal> BaseDaemon: 22. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367137 [ 347 ] <Fatal> BaseDaemon: 23. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367158 [ 347 ] <Fatal> BaseDaemon: 24. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367187 [ 347 ] <Fatal> BaseDaemon: 25. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367228 [ 347 ] <Fatal> BaseDaemon: 26. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367254 [ 347 ] <Fatal> BaseDaemon: 27. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367282 [ 347 ] <Fatal> BaseDaemon: 28. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367304 [ 347 ] <Fatal> BaseDaemon: 29. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367336 [ 347 ] <Fatal> BaseDaemon: 30. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367363 [ 347 ] <Fatal> BaseDaemon: 31. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367389 [ 347 ] <Fatal> BaseDaemon: 32. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367428 [ 347 ] <Fatal> BaseDaemon: 33. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367453 [ 347 ] <Fatal> BaseDaemon: 34. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367480 [ 347 ] <Fatal> BaseDaemon: 35. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367510 [ 347 ] <Fatal> BaseDaemon: 36. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367543 [ 347 ] <Fatal> BaseDaemon: 37. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367570 [ 347 ] <Fatal> BaseDaemon: 38. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367591 [ 347 ] <Fatal> BaseDaemon: 39. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367628 [ 347 ] <Fatal> BaseDaemon: 40. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367661 [ 347 ] <Fatal> BaseDaemon: 41. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367693 [ 347 ] <Fatal> BaseDaemon: 42. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367721 [ 347 ] <Fatal> BaseDaemon: 43. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.367742 [ 347 ] <Fatal> BaseDaemon: 44. DB::InDepthQueryTreeVisitor<DB::(anonymous namespace)::CollectWindowFunctionNodeVisitor, true>::visit(std::shared_ptr<DB::IQueryTreeNode> const&) (.llvm.17465951882029437719) @ 0x0000000011cadf58 in /usr/bin/clickhouse\r\n[8af69c367457] 2023.08.23 07:54:07.519317 [ 347 ] <Fatal> BaseDaemon: Integrity check of the executable successfully passed (checksum: F37F4F1F1F05354DFEECD70FAB61DC73)\r\n[8af69c367457] 2023.08.23 07:54:07.519650 [ 347 ] <Fatal> BaseDaemon: Report this error to https://github.com/ClickHouse/ClickHouse/issues\r\n[8af69c367457] 2023.08.23 07:54:07.519774 [ 347 ] <Fatal> BaseDaemon: Changed settings: allow_experimental_analyzer = true\r\n```\n",
  "hints_text": "",
  "created_at": "2023-10-26T17:10:11Z"
}