{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 23202,
  "instance_id": "ClickHouse__ClickHouse-23202",
  "issue_numbers": [
    "22406"
  ],
  "base_commit": "3f3f928c1fee6fb1a2d396a29d55563d10640414",
  "patch": "diff --git a/src/Processors/Formats/Impl/CSVRowInputFormat.cpp b/src/Processors/Formats/Impl/CSVRowInputFormat.cpp\nindex 00381ab96d09..4ccc0db4cfed 100644\n--- a/src/Processors/Formats/Impl/CSVRowInputFormat.cpp\n+++ b/src/Processors/Formats/Impl/CSVRowInputFormat.cpp\n@@ -201,7 +201,10 @@ void CSVRowInputFormat::readPrefix()\n             return;\n         }\n         else\n+        {\n             skipRow(in, format_settings.csv, num_columns);\n+            setupAllColumnsByTableSchema();\n+        }\n     }\n     else if (!column_mapping->is_set)\n         setupAllColumnsByTableSchema();\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01818_input_format_with_names_use_header.reference b/tests/queries/0_stateless/01818_input_format_with_names_use_header.reference\nnew file mode 100644\nindex 000000000000..b7b577c46851\n--- /dev/null\n+++ b/tests/queries/0_stateless/01818_input_format_with_names_use_header.reference\n@@ -0,0 +1,2 @@\n+testdata1\n+testdata2\ndiff --git a/tests/queries/0_stateless/01818_input_format_with_names_use_header.sh b/tests/queries/0_stateless/01818_input_format_with_names_use_header.sh\nnew file mode 100755\nindex 000000000000..953c39a40a2a\n--- /dev/null\n+++ b/tests/queries/0_stateless/01818_input_format_with_names_use_header.sh\n@@ -0,0 +1,15 @@\n+#!/usr/bin/env bash\n+\n+CUR_DIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CUR_DIR\"/../shell_config.sh\n+\n+${CLICKHOUSE_CLIENT} -q \"DROP TABLE IF EXISTS \\`01818_with_names\\`;\"\n+\n+${CLICKHOUSE_CLIENT} -q \"CREATE TABLE \\`01818_with_names\\` (t String) ENGINE = MergeTree ORDER BY t;\"\n+\n+echo -ne \"t\\ntestdata1\\ntestdata2\" | ${CLICKHOUSE_CLIENT} --input_format_with_names_use_header 0 --query \"INSERT INTO \\`01818_with_names\\` FORMAT CSVWithNames\"\n+\n+${CLICKHOUSE_CLIENT} -q \"SELECT * FROM \\`01818_with_names\\`;\"\n+\n+${CLICKHOUSE_CLIENT} -q \"DROP TABLE IF EXISTS \\`01818_with_names\\`;\"\n",
  "problem_statement": "Disabling `input_format_with_names_use_header` discards all the input\n**Describe the bug**\r\nWhen you set the setting `input_format_with_names_use_header` to `0`, `INSERT` does not actually insert rows.\r\n\r\n**How to reproduce**\r\n* Which ClickHouse server version to use: git master `a21fe0b492cbc8628126a3cd493b83e82abf9978`, checked out on 2021-03-31\r\n* Which interface to use: the native command-line client\r\n* Non-default settings, if any: `input_format_with_names_use_header` = `0`\r\n* `CREATE TABLE` statements for all tables involved:\r\n```sql\r\nCREATE TABLE csvtest\r\n(\r\n    `t` String\r\n)\r\nENGINE = MergeTree\r\nORDER BY t\r\n```\r\n* Sample data for all these tables\r\n`test.csv`:\r\n```csv\r\nt\r\ntestdata1\r\ntestdata2\r\n```\r\n* Queries to run that lead to unexpected result:\r\n```\r\n% clickhouse-client --input_format_with_names_use_header 0 --query \"INSERT INTO csvtest FORMAT CSVWithNames\" < test.csv\r\n```\r\n\r\n**Expected behavior**\r\nTwo rows `('testdata1'), ('testdata2')` will be inserted to the table `csvtest`.\r\n\r\n**Error message and/or stacktrace**\r\nNothing. It silently discards the input and inserts nothing to the table.\r\n\r\n**Additional context**\r\nIt works as expected if you set `input_format_with_names_use_header` to `1`.\r\n\n",
  "hints_text": "What will be if you set `input_format_parallel_parsing=0` ?\nI got the same result If I set both `input_format_parallel_parsing` and `input_format_with_names_use_header` to `0`. That is, rows were still not inserted.",
  "created_at": "2021-04-16T17:27:31Z",
  "modified_files": [
    "src/Processors/Formats/Impl/CSVRowInputFormat.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01818_input_format_with_names_use_header.reference",
    "b/tests/queries/0_stateless/01818_input_format_with_names_use_header.sh"
  ]
}