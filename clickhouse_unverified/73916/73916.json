{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 73916,
  "instance_id": "ClickHouse__ClickHouse-73916",
  "issue_numbers": [
    "73501"
  ],
  "base_commit": "ccfe44d16c56904df6fdcd2df165ea62714e0122",
  "patch": "diff --git a/src/Analyzer/Resolve/QueryAnalyzer.cpp b/src/Analyzer/Resolve/QueryAnalyzer.cpp\nindex 0aa6e10a08b4..8bf180c077b3 100644\n--- a/src/Analyzer/Resolve/QueryAnalyzer.cpp\n+++ b/src/Analyzer/Resolve/QueryAnalyzer.cpp\n@@ -950,7 +950,7 @@ std::pair<bool, UInt64> QueryAnalyzer::recursivelyCollectMaxOrdinaryExpressions(\n     if (!function)\n         return {false, 0};\n \n-    if (function->isAggregateFunction())\n+    if (function->isAggregateFunction() || function->isWindowFunction())\n         return {true, 0};\n \n     UInt64 pushed_children = 0;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03298_analyzer_group_by_all_fix.reference b/tests/queries/0_stateless/03298_analyzer_group_by_all_fix.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/03298_analyzer_group_by_all_fix.sql b/tests/queries/0_stateless/03298_analyzer_group_by_all_fix.sql\nnew file mode 100644\nindex 000000000000..f226c4905bdd\n--- /dev/null\n+++ b/tests/queries/0_stateless/03298_analyzer_group_by_all_fix.sql\n@@ -0,0 +1,7 @@\n+CREATE TABLE users (uid Int16, name String, age Int16) ENGINE=Memory;\n+\n+INSERT INTO users VALUES (1231, 'John', 33);\n+INSERT INTO users VALUES (6666, 'Ksenia', 48);\n+INSERT INTO users VALUES (8888, 'Alice', 50);\n+\n+SELECT uid, count(*) over () FROM users group by ALL FORMAT Null;\n",
  "problem_statement": "DB::Exception: Window function count() OVER ()  is found in GROUP BY in query. (ILLEGAL_AGGREGATION)\nIt does not work in version 24.11.1.2557 (official build)\r\n\r\n**Describe what's wrong**\r\n\r\n> count() over () with GROUP BY ALL does not work.\r\n> It works if changed to GROUP BY uid\r\n> It works in version 23.8\r\n\r\n> A link to reproducer in [https://fiddle.clickhouse.com/9fc65860-bc31-4509-a9b8-038b035fa5b3]\r\n\r\n**Does it reproduce on the most recent release?**\r\nyes\r\n\r\nCREATE TABLE users (uid Int16, name String, age Int16) ENGINE=Memory;\r\n\r\nINSERT INTO users VALUES (1231, 'John', 33);\r\nINSERT INTO users VALUES (6666, 'Ksenia', 48);\r\nINSERT INTO users VALUES (8888, 'Alice', 50);\r\n\r\nSELECT uid, count() over () FROM users group by ALL\r\n\r\nReceived exception from server (version 24.11.1):\r\nCode: 184. DB::Exception: Received from localhost:9000. DB::Exception: Window function count() OVER () is found in GROUP BY in query. (ILLEGAL_AGGREGATION)\r\n(query: SELECT uid, count() over () FROM users group by ALL)\r\n\r\n\n",
  "hints_text": "`SET enable_analyzer=0` makes it work.\r\nAlso, replacing `ALL` to `uid, name, age` makes it work too: https://fiddle.clickhouse.com/12e0bc52-cb06-47d7-8dfd-fdde5d53bad1",
  "created_at": "2024-12-27T16:47:11Z"
}