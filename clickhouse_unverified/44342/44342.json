{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 44342,
  "instance_id": "ClickHouse__ClickHouse-44342",
  "issue_numbers": [
    "29883"
  ],
  "base_commit": "34029d47f34977e4cd0deed46c67ec2ed6b3759e",
  "patch": "diff --git a/programs/server/config.d/graphite.xml b/programs/server/config.d/graphite.xml\nnew file mode 120000\nindex 000000000000..69a0411e243c\n--- /dev/null\n+++ b/programs/server/config.d/graphite.xml\n@@ -0,0 +1,1 @@\n+../../../tests/config/config.d/graphite.xml\n\\ No newline at end of file\ndiff --git a/src/Processors/Merges/Algorithms/Graphite.cpp b/src/Processors/Merges/Algorithms/Graphite.cpp\nindex c5c611366ff1..0616c4bd6e64 100644\n--- a/src/Processors/Merges/Algorithms/Graphite.cpp\n+++ b/src/Processors/Merges/Algorithms/Graphite.cpp\n@@ -332,8 +332,7 @@ std::string buildTaggedRegex(std::string regexp_str)\n   *     </default>\n   * </graphite_rollup>\n   */\n-static const Pattern &\n-appendGraphitePattern(\n+static const Pattern & appendGraphitePattern(\n     const Poco::Util::AbstractConfiguration & config,\n     const String & config_element, Patterns & patterns,\n     bool default_rule,\ndiff --git a/src/Processors/Merges/Algorithms/GraphiteRollupSortedAlgorithm.cpp b/src/Processors/Merges/Algorithms/GraphiteRollupSortedAlgorithm.cpp\nindex 467ded19f4d8..c5937fe0bc50 100644\n--- a/src/Processors/Merges/Algorithms/GraphiteRollupSortedAlgorithm.cpp\n+++ b/src/Processors/Merges/Algorithms/GraphiteRollupSortedAlgorithm.cpp\n@@ -9,6 +9,12 @@\n namespace DB\n {\n \n+namespace ErrorCodes\n+{\n+    extern const int BAD_ARGUMENTS;\n+}\n+\n+\n static GraphiteRollupSortedAlgorithm::ColumnsDefinition defineColumns(\n     const Block & header, const Graphite::Params & params)\n {\n@@ -26,6 +32,9 @@ static GraphiteRollupSortedAlgorithm::ColumnsDefinition defineColumns(\n         if (i != def.time_column_num && i != def.value_column_num && i != def.version_column_num)\n             def.unmodified_column_numbers.push_back(i);\n \n+    if (!WhichDataType(header.getByPosition(def.value_column_num).type).isFloat64())\n+        throw Exception(\"Only `Float64` data type is allowed for the value column of GraphiteMergeTree\", ErrorCodes::BAD_ARGUMENTS);\n+\n     return def;\n }\n \ndiff --git a/src/Storages/MergeTree/registerStorageMergeTree.cpp b/src/Storages/MergeTree/registerStorageMergeTree.cpp\nindex ae2abaf8ea5a..c34d7d4dacf0 100644\n--- a/src/Storages/MergeTree/registerStorageMergeTree.cpp\n+++ b/src/Storages/MergeTree/registerStorageMergeTree.cpp\n@@ -468,7 +468,7 @@ static StoragePtr create(const StorageFactory::Arguments & args)\n     {\n         String graphite_config_name;\n         String error_msg\n-            = \"Last parameter of GraphiteMergeTree must be name (in single quotes) of element in configuration file with Graphite options\";\n+            = \"Last parameter of GraphiteMergeTree must be the name (in single quotes) of the element in configuration file with the Graphite options\";\n         error_msg += getMergeTreeVerboseHelp(is_extended_storage_def);\n \n         if (const auto * ast = engine_args[arg_cnt - 1]->as<ASTLiteral>())\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02508_bad_graphite.reference b/tests/queries/0_stateless/02508_bad_graphite.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02508_bad_graphite.sql b/tests/queries/0_stateless/02508_bad_graphite.sql\nnew file mode 100644\nindex 000000000000..a0ca9dcf6908\n--- /dev/null\n+++ b/tests/queries/0_stateless/02508_bad_graphite.sql\n@@ -0,0 +1,6 @@\n+DROP TABLE IF EXISTS test_graphite;\n+create table test_graphite (key UInt32, Path String, Time DateTime('UTC'), Value UInt8, Version UInt32, col UInt64)\n+    engine = GraphiteMergeTree('graphite_rollup') order by key;\n+\n+INSERT INTO test_graphite (key) VALUES (0); -- { serverError BAD_ARGUMENTS }\n+DROP TABLE test_graphite;\n",
  "problem_statement": "If I'm holding a `GraphiteMergeTree` table in the wrong way, it complains\nWhen trying to populate a newly created GraphiteMergeTree table with some data, I catch an exception.\r\n\r\n```sql\r\nCREATE TABLE default.ttt\r\n(\r\n    `C1` Int8,\r\n    `Sign` Int8,\r\n    `Version` UInt8,\r\n    `Path` String,\r\n    `Time` DateTime,\r\n    `Value` Int8\r\n)\r\nENGINE = GraphiteMergeTree('graphite_rollup_params')\r\nORDER BY tuple()\r\n```\r\nTable is created and it shows up in `SHOW TABLES`. Then, I try to insert some data:\r\n\r\n```sql\r\ntietokone :) INSERT INTO ttt (*) VALUES (1, 1, 2, 'qwew', '2021-12-12 01:01:02', 2)\r\n\r\nINSERT INTO ttt (*) VALUES\r\n\r\nReceived exception from server (version 21.9.4):\r\nCode: 49. DB::Exception: Received from localhost:9000. DB::Exception: Invalid number of rows in Chunk column Int8 position 5: expected 1, got 8. (LOGICAL_ERROR)\r\n```\r\n\r\n`graphite_rollup_params`:\r\n```xml\r\n<yandex>\r\n    <graphite_rollup_params>\r\n        <version_column_name>Version</version_column_name>\r\n        <pattern>\r\n            <regexp>click_cost</regexp>\r\n            <function>any</function>\r\n            <retention>\r\n                <age>0</age>\r\n                <precision>5</precision>\r\n            </retention>\r\n            <retention>\r\n                <age>86400</age>\r\n                <precision>60</precision>\r\n            </retention>\r\n        </pattern>\r\n        <default>\r\n            <function>max</function>\r\n            <retention>\r\n                <age>0</age>\r\n                <precision>60</precision>\r\n            </retention>\r\n            <retention>\r\n                <age>3600</age>\r\n                <precision>300</precision>\r\n            </retention>\r\n            <retention>\r\n                <age>86400</age>\r\n                <precision>3600</precision>\r\n            </retention>\r\n        </default>\r\n    </graphite_rollup_params>\r\n</yandex>\r\n```\r\n\r\nThis happens on `21.3`, `21.8`, `21.9`\r\nHowever, `20.3`, `20.8` work as expected\n",
  "hints_text": "```sql\r\nset optimize_on_insert=0;\r\nINSERT INTO default.ttt (*) VALUES (1, 1, 2, 'qwew', '2021-12-12 01:01:02', 2)\u3000;\r\nINSERT INTO default.ttt (*) VALUES (1, 1, 2, 'qwew', '2021-12-12 01:01:02', 2)\u3000;\r\nINSERT INTO default.ttt (*) VALUES (1, 1, 2, 'qwew', '2021-12-12 01:01:02', 2)\u3000;\r\noptimize table default.ttt final;\r\nB::Exception: Invalid number of rows in Chunk column Int8 position 5: expected 1, got 8: While executing GraphiteRollupSortedTransform. (LOGICAL_ERROR)\r\n```\n```\r\nOPTIMIZE TABLE default.ttt FINAL\r\nReceived exception from server (version 20.8.19):\r\nCode: 49. DB::Exception: Received from localhost:9000. DB::Exception: Invalid number of rows in Chunk column Int8 position 5: expected 1, got 8: While executing GraphiteRollupSortedTransform.\r\n```\r\n\r\nSo, in reality it never worked. \r\n\nWhy is it `unexpected behavior`? The ability to work with this table type is declared in docs, with no mentions this doesn't work\n@zvonand because it seems it never worked with Int8, Int16, Float32, not sure\r\n\n@zvonand  what is `C1 Int8,` ?\n18.14.19 & Float32\r\n\r\n```sql\r\nCREATE TABLE ttt\r\n(\r\n    `Version` Int64,\r\n    `Path` String,\r\n    `Time` DateTime,\r\n    `Value` Float32\r\n)\r\nENGINE = GraphiteMergeTree('graphite_rollup_params')\r\nORDER BY (Path, Time);\r\n\r\nINSERT INTO ttt VALUES (2, 'qwew', '2021-12-12 01:01:02', 2);\r\n\r\nOPTIMIZE TABLE ttt FINAL\r\n\r\nReceived exception from server (version 18.14.19):\r\nCode: 9. DB::Exception: Received from localhost:9000, ::1. \r\nDB::Exception: Sizes of columns doesn't match: Version: 1, Value: 2.\r\n```\n> @zvonand  what is `C1 Int8,` ?\n\nJust a column\nIt seems only 64 bits types are supported for Value column.\n> It seems only 64 bits types are supported for Value column.\n\nWell, docs say:\n> Value of the metric. Data type: any numeric.\n\n\nThis is trash:\r\n\r\n![Screenshot_20221218_073815](https://user-images.githubusercontent.com/18581488/208285046-8b7f3214-569d-44f8-be74-bb3ff83e03bb.png)\r\n",
  "created_at": "2022-12-18T07:01:07Z",
  "modified_files": [
    "b/programs/server/config.d/graphite.xml",
    "src/Processors/Merges/Algorithms/Graphite.cpp",
    "src/Processors/Merges/Algorithms/GraphiteRollupSortedAlgorithm.cpp",
    "src/Storages/MergeTree/registerStorageMergeTree.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02508_bad_graphite.sql"
  ]
}