{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 30565,
  "instance_id": "ClickHouse__ClickHouse-30565",
  "issue_numbers": [
    "30397",
    "29997"
  ],
  "base_commit": "1c72421e53b9a1553f6c8eea070069a7212c8aac",
  "patch": "diff --git a/src/Storages/StorageBuffer.cpp b/src/Storages/StorageBuffer.cpp\nindex a74223054e9d..549f87c9f992 100644\n--- a/src/Storages/StorageBuffer.cpp\n+++ b/src/Storages/StorageBuffer.cpp\n@@ -446,7 +446,8 @@ static void appendBlock(const Block & from, Block & to)\n     if (!to)\n         throw Exception(\"Cannot append to empty block\", ErrorCodes::LOGICAL_ERROR);\n \n-    assertBlocksHaveEqualStructure(from, to, \"Buffer\");\n+    if (to.rows())\n+        assertBlocksHaveEqualStructure(from, to, \"Buffer\");\n \n     from.checkNumberOfRows();\n     to.checkNumberOfRows();\n@@ -464,14 +465,21 @@ static void appendBlock(const Block & from, Block & to)\n     {\n         MemoryTracker::BlockerInThread temporarily_disable_memory_tracker;\n \n-        for (size_t column_no = 0, columns = to.columns(); column_no < columns; ++column_no)\n+        if (to.rows() == 0)\n         {\n-            const IColumn & col_from = *from.getByPosition(column_no).column.get();\n-            last_col = IColumn::mutate(std::move(to.getByPosition(column_no).column));\n+            to = from;\n+        }\n+        else\n+        {\n+            for (size_t column_no = 0, columns = to.columns(); column_no < columns; ++column_no)\n+            {\n+                const IColumn & col_from = *from.getByPosition(column_no).column.get();\n+                last_col = IColumn::mutate(std::move(to.getByPosition(column_no).column));\n \n-            last_col->insertRangeFrom(col_from, 0, rows);\n+                last_col->insertRangeFrom(col_from, 0, rows);\n \n-            to.getByPosition(column_no).column = std::move(last_col);\n+                to.getByPosition(column_no).column = std::move(last_col);\n+            }\n         }\n     }\n     catch (...)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01506_buffer_table_alter_block_structure_2.reference b/tests/queries/0_stateless/01506_buffer_table_alter_block_structure_2.reference\nnew file mode 100644\nindex 000000000000..1f90610041b0\n--- /dev/null\n+++ b/tests/queries/0_stateless/01506_buffer_table_alter_block_structure_2.reference\n@@ -0,0 +1,3 @@\n+2020-01-01 00:05:00\t\n+2020-01-01 00:05:00\t\n+2020-01-01 00:06:00\thello\ndiff --git a/tests/queries/0_stateless/01506_buffer_table_alter_block_structure_2.sql b/tests/queries/0_stateless/01506_buffer_table_alter_block_structure_2.sql\nnew file mode 100644\nindex 000000000000..8862037c82bf\n--- /dev/null\n+++ b/tests/queries/0_stateless/01506_buffer_table_alter_block_structure_2.sql\n@@ -0,0 +1,25 @@\n+DROP TABLE IF EXISTS buf_dest;\n+DROP TABLE IF EXISTS buf;\n+\n+CREATE TABLE buf_dest (timestamp DateTime)\n+ENGINE = MergeTree PARTITION BY toYYYYMMDD(timestamp)\n+ORDER BY (timestamp);\n+\n+CREATE TABLE buf (timestamp DateTime) Engine = Buffer(currentDatabase(), buf_dest, 16, 0.1, 0.1, 2000000, 20000000, 100000000, 300000000);;\n+\n+INSERT INTO buf (timestamp) VALUES (toDateTime('2020-01-01 00:05:00'));\n+\n+--- wait for buffer to flush\n+SELECT sleep(1) from numbers(1) settings max_block_size=1 format Null;\n+\n+ALTER TABLE buf_dest ADD COLUMN s String;\n+ALTER TABLE buf ADD COLUMN s String;\n+\n+SELECT * FROM buf;\n+\n+INSERT INTO buf (timestamp, s) VALUES (toDateTime('2020-01-01 00:06:00'), 'hello');\n+\n+SELECT * FROM buf ORDER BY timestamp;\n+\n+DROP TABLE IF EXISTS buf;\n+DROP TABLE IF EXISTS buf_dest;\n",
  "problem_statement": "Logical error: 'Block structure mismatch in Buffer stream'\nhttps://clickhouse-test-reports.s3.yandex.net/0/9195e4e887e6f05cf41ce326d0de98e1ae1204f5/stress_test_(debug).html\r\n\r\nquery\r\n```\r\n2021.10.19 17:13:46.212969 [ 15981 ] {adfead4b-ed57-40ef-819a-9cb608aa1184} <Debug> executeQuery: (from [::1]:38756) (comment: 01506_buffer_table_alter_block_structure.sql) INSERT INTO buf (timestamp, s) VALUES\r\n```\r\n\r\n```\r\n2021.10.19 17:13:46.475436 [ 15981 ] {adfead4b-ed57-40ef-819a-9cb608aa1184} <Fatal> : Logical error: 'Block structure mismatch in Buffer stream: different number of columns:\r\ns String String(size = 1), timestamp DateTime UInt32(size = 1)\r\ntimestamp DateTime UInt32(size = 0)'.\r\n\r\n2021.10.19 17:15:10.275157 [ 17553 ] {} <Fatal> BaseDaemon: ########################################\r\n2021.10.19 17:15:10.388470 [ 17553 ] {} <Fatal> BaseDaemon: (version 21.11.1.8483 (official build), build id: 102D40AAC8B89424DB460221D6A9447CD6AAD6B4) (from thread 15981) (query_id: adfead4b-ed57-40ef-819a-9cb608aa1184) Received signal Aborted (6)\r\n2021.10.19 17:15:10.433208 [ 17553 ] {} <Fatal> BaseDaemon:\r\n2021.10.19 17:15:10.445788 [ 17553 ] {} <Fatal> BaseDaemon: Stack trace: 0x7f294831818b 0x7f29482f7859 0x14f43478 0x14f43582 0x20ccaab1 0x20cc901c 0x20cc8f07 0x223e9022 0x223ef103 0x223eed45 0x22eeaeb5 0x22e557e3 0x22e5577d 0x22e5573d 0x22e55715 0x22e556dd 0x14f900e6 0x14f8f175 0x22e54ece 0x22e54bae 0x22b11cb9 0x22b11c1f 0x22b11bbd 0x22b11b7d 0x22b11b55 0x22b11b1d 0x14f900e6 0x14f8f175 0x22b105c5 0x22b0f798 0x22b3747a 0x22a9525b 0x22a8f1f0 0x22a9e7a5 0x26ee4519 0x26ee4d28 0x27032c74 0x2702f75a 0x2702e53c 0x7f29484fa609 0x7f29483f4293\r\n2021.10.19 17:15:11.243067 [ 17553 ] {} <Fatal> BaseDaemon: 6. ./obj-x86_64-linux-gnu/../src/Common/Exception.cpp:53: DB::handle_error_code(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int, bool, std::__1::vector<void*, std::__1::allocator<void*> > const&) @ 0x14f43478 in /usr/bin/clickhouse\r\n2021.10.19 17:15:11.912051 [ 17553 ] {} <Fatal> BaseDaemon: 7. ./obj-x86_64-linux-gnu/../src/Common/Exception.cpp:60: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int, bool) @ 0x14f43582 in /usr/bin/clickhouse\r\n2021.10.19 17:15:20.051060 [ 17553 ] {} <Fatal> BaseDaemon: 8. ./obj-x86_64-linux-gnu/../src/Core/Block.cpp:32: void DB::onError<void>(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x20ccaab1 in /usr/bin/clickhouse\r\n2021.10.19 17:15:27.551150 [ 497 ] {} <Fatal> Application: Child process was terminated by signal 6.\r\n```\nLogical error: Block structure mismatch in Buffer stream: different number of columns\nhttps://clickhouse-test-reports.s3.yandex.net/0/a70249f8f70aae1c00b6324afe1509ccef8be617/stress_test_(debug).html#fail1\r\n\r\n```\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:32.738573 [ 2935 ] {d791e065-406e-49b7-86d4-587eb3f502c6} <Fatal> : Logical error: 'Block structure mismatch in Buffer stream: different number of columns:\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:32.779010 [ 20850 ] {} <Fatal> BaseDaemon: ########################################\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:32.792655 [ 20850 ] {} <Fatal> BaseDaemon: (version 21.11.1.8368 (official build), build id: 2C27DF78605FD3C86BCD90A72BF6E51B0666EB10) (from thread 2935) (query_id: d791e065-406e-49b7-86d4-587eb3f502c6) Received signal Aborted (6)\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:32.846872 [ 20850 ] {} <Fatal> BaseDaemon: \r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:32.857580 [ 20850 ] {} <Fatal> BaseDaemon: Stack trace: 0x7f9d0682e18b 0x7f9d0680d859 0x14e26bf8 0x14e26d02 0x20b58cd1 0x20b5743c 0x20b57327 0x2222d4c2 0x22233843 0x22233485 0x22d51415 0x22cc9783 0x22cc971d 0x22cc96dd 0x22cc96b5 0x22cc967d 0x14e73246 0x14e72335 0x22cc8e6e 0x22cc8b4e 0x229927b9 0x2299271f 0x229926bd 0x2299267d 0x22992655 0x2299261d 0x14e73246 0x14e72335 0x229910c5 0x22990298 0x229b7fba 0x228cc2fb 0x228c628b 0x228d3a85 0x26d438f9 0x26d44108 0x26e92034 0x26e8eb1a 0x26e8d8fc 0x7f9d069f4609 0x7f9d0690a293\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:32.892884 [ 20850 ] {} <Fatal> BaseDaemon: 4. raise @ 0x4618b in /usr/lib/x86_64-linux-gnu/libc-2.31.so\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:32.896289 [ 20850 ] {} <Fatal> BaseDaemon: 5. abort @ 0x25859 in /usr/lib/x86_64-linux-gnu/libc-2.31.so\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:33.239118 [ 20850 ] {} <Fatal> BaseDaemon: 6. ./obj-x86_64-linux-gnu/../src/Common/Exception.cpp:53: DB::handle_error_code(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int, bool, std::__1::vector<void*, std::__1::allocator<void*> > const&) @ 0x14e26bf8 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:33.398452 [ 20850 ] {} <Fatal> BaseDaemon: 7. ./obj-x86_64-linux-gnu/../src/Common/Exception.cpp:60: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int, bool) @ 0x14e26d02 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:34.219076 [ 20850 ] {} <Fatal> BaseDaemon: 8. ./obj-x86_64-linux-gnu/../src/Core/Block.cpp:32: void DB::onError<void>(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x20b58cd1 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:34.708525 [ 20850 ] {} <Fatal> BaseDaemon: 9. ./obj-x86_64-linux-gnu/../src/Core/Block.cpp:86: void DB::checkBlockStructure<void>(DB::Block const&, DB::Block const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, bool) @ 0x20b5743c in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:35.269648 [ 20850 ] {} <Fatal> BaseDaemon: 10. ./obj-x86_64-linux-gnu/../src/Core/Block.cpp:595: DB::assertBlocksHaveEqualStructure(DB::Block const&, DB::Block const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0x20b57327 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:37.547788 [ 20850 ] {} <Fatal> BaseDaemon: 11. ./obj-x86_64-linux-gnu/../src/Storages/StorageBuffer.cpp:447: DB::appendBlock(DB::Block const&, DB::Block&) @ 0x2222d4c2 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:39.047825 [ 20850 ] {} <Fatal> BaseDaemon: 12. ./obj-x86_64-linux-gnu/../src/Storages/StorageBuffer.cpp:634: DB::BufferSink::insertIntoBuffer(DB::Block const&, DB::StorageBuffer::Buffer&) @ 0x22233843 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:39.947747 [ 20850 ] {} <Fatal> BaseDaemon: 13. ./obj-x86_64-linux-gnu/../src/Storages/StorageBuffer.cpp:595: DB::BufferSink::consume(DB::Chunk) @ 0x22233485 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:40.411917 [ 20850 ] {} <Fatal> BaseDaemon: 14. ./obj-x86_64-linux-gnu/../src/Processors/Sinks/SinkToStorage.cpp:18: DB::SinkToStorage::transform(DB::Chunk&) @ 0x22d51415 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:40.958675 [ 20850 ] {} <Fatal> BaseDaemon: 15. ./obj-x86_64-linux-gnu/../src/Processors/Transforms/ExceptionKeepingTransform.cpp:135: DB::ExceptionKeepingTransform::work()::$_1::operator()() const @ 0x22cc9783 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:41.364164 [ 20850 ] {} <Fatal> BaseDaemon: 16. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:3676: decltype(std::__1::forward<DB::ExceptionKeepingTransform::work()::$_1&>(fp)()) std::__1::__invoke<DB::ExceptionKeepingTransform::work()::$_1&>(DB::ExceptionKeepingTransform::work()::$_1&) @ 0x22cc971d in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:41.849624 [ 20850 ] {} <Fatal> BaseDaemon: 17. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/__functional_base:349: void std::__1::__invoke_void_return_wrapper<void>::__call<DB::ExceptionKeepingTransform::work()::$_1&>(DB::ExceptionKeepingTransform::work()::$_1&) @ 0x22cc96dd in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:42.163365 [ 20850 ] {} <Fatal> BaseDaemon: 18. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1608: std::__1::__function::__default_alloc_func<DB::ExceptionKeepingTransform::work()::$_1, void ()>::operator()() @ 0x22cc96b5 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:42.569818 [ 20850 ] {} <Fatal> BaseDaemon: 19. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2089: void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<DB::ExceptionKeepingTransform::work()::$_1, void ()> >(std::__1::__function::__policy_storage const*) @ 0x22cc967d in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:42.671945 [ 20850 ] {} <Fatal> BaseDaemon: 20. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2221: std::__1::__function::__policy_func<void ()>::operator()() const @ 0x14e73246 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:42.948646 [ 20850 ] {} <Fatal> BaseDaemon: 21. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2560: std::__1::function<void ()>::operator()() const @ 0x14e72335 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:43.282898 [ 20850 ] {} <Fatal> BaseDaemon: 22. ./obj-x86_64-linux-gnu/../src/Processors/Transforms/ExceptionKeepingTransform.cpp:102: DB::runStep(std::__1::function<void ()>, DB::ThreadStatus*, std::__1::atomic<unsigned long>*) @ 0x22cc8e6e in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:43.752741 [ 20850 ] {} <Fatal> BaseDaemon: 23. ./obj-x86_64-linux-gnu/../src/Processors/Transforms/ExceptionKeepingTransform.cpp:135: DB::ExceptionKeepingTransform::work() @ 0x22cc8b4e in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:44.690876 [ 20850 ] {} <Fatal> BaseDaemon: 24. ./obj-x86_64-linux-gnu/../src/Processors/Executors/PipelineExecutor.cpp:88: DB::executeJob(DB::IProcessor*) @ 0x229927b9 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:45.532301 [ 20850 ] {} <Fatal> BaseDaemon: 25. ./obj-x86_64-linux-gnu/../src/Processors/Executors/PipelineExecutor.cpp:105: DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0::operator()() const @ 0x2299271f in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:48.400022 [ 20850 ] {} <Fatal> BaseDaemon: 26. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:3676: decltype(std::__1::forward<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&>(fp)()) std::__1::__invoke<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&>(DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&) @ 0x229926bd in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:49.354879 [ 20850 ] {} <Fatal> BaseDaemon: 27. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/__functional_base:349: void std::__1::__invoke_void_return_wrapper<void>::__call<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&>(DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&) @ 0x2299267d in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:50.302500 [ 20850 ] {} <Fatal> BaseDaemon: 28. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1608: std::__1::__function::__default_alloc_func<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0, void ()>::operator()() @ 0x22992655 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:51.052476 [ 20850 ] {} <Fatal> BaseDaemon: 29. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2089: void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0, void ()> >(std::__1::__function::__policy_storage const*) @ 0x2299261d in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:51.332390 [ 20850 ] {} <Fatal> BaseDaemon: 30. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2221: std::__1::__function::__policy_func<void ()>::operator()() const @ 0x14e73246 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:52.076876 [ 20850 ] {} <Fatal> BaseDaemon: 31. ./obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2560: std::__1::function<void ()>::operator()() const @ 0x14e72335 in /usr/bin/clickhouse\r\n/var/log/clickhouse-server/clickhouse-server.log.2:2021.10.11 01:44:55.401575 [ 498 ] {} <Fatal> Application: Child process was terminated by signal 6.\r\n```\r\n\r\ncc: @KochetovNicolai \n",
  "hints_text": "https://clickhouse-test-reports.s3.yandex.net/0/75c16b8f8924f3e397c5b2e8a4c8da8ddfd7c79e/stress_test_(debug).html\r\n\nhttps://clickhouse-test-reports.s3.yandex.net/0/75c16b8f8924f3e397c5b2e8a4c8da8ddfd7c79e/stress_test_(debug).html#fail1",
  "created_at": "2021-10-22T14:43:24Z"
}