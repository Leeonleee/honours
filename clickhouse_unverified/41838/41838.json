{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 41838,
  "instance_id": "ClickHouse__ClickHouse-41838",
  "issue_numbers": [
    "34798"
  ],
  "base_commit": "036d1c8cbc7ebb34c88d62d52e72ed4af61a8c1b",
  "patch": "diff --git a/src/Storages/MergeTree/MergeTreeData.cpp b/src/Storages/MergeTree/MergeTreeData.cpp\nindex ce4f1dc884d4..96328bb9e897 100644\n--- a/src/Storages/MergeTree/MergeTreeData.cpp\n+++ b/src/Storages/MergeTree/MergeTreeData.cpp\n@@ -6144,6 +6144,9 @@ MergeTreeData & MergeTreeData::checkStructureAndGetMergeTreeData(IStorage & sour\n     if (format_version != src_data->format_version)\n         throw Exception(\"Tables have different format_version\", ErrorCodes::BAD_ARGUMENTS);\n \n+    if (query_to_string(my_snapshot->getPrimaryKeyAST()) != query_to_string(src_snapshot->getPrimaryKeyAST()))\n+        throw Exception(\"Tables have different primary key\", ErrorCodes::BAD_ARGUMENTS);\n+\n     return *src_data;\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02455_improve_feedback_when_replacing_partition_with_different_primary_key.reference b/tests/queries/0_stateless/02455_improve_feedback_when_replacing_partition_with_different_primary_key.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02455_improve_feedback_when_replacing_partition_with_different_primary_key.sql b/tests/queries/0_stateless/02455_improve_feedback_when_replacing_partition_with_different_primary_key.sql\nnew file mode 100644\nindex 000000000000..d000fb4479c9\n--- /dev/null\n+++ b/tests/queries/0_stateless/02455_improve_feedback_when_replacing_partition_with_different_primary_key.sql\n@@ -0,0 +1,4 @@\n+CREATE TABLE test_a (id UInt32, company UInt32, total UInt64) ENGINE=SummingMergeTree() PARTITION BY company PRIMARY KEY (id) ORDER BY (id, company);\n+INSERT INTO test_a SELECT number%10 as id, number%2 as company, count() as total FROM numbers(100) GROUP BY id,company;\n+CREATE TABLE test_b (id UInt32, company UInt32, total UInt64) ENGINE=SummingMergeTree() PARTITION BY company ORDER BY (id, company);\n+ALTER TABLE test_b REPLACE PARTITION '0' FROM test_a; -- {serverError BAD_ARGUMENTS}\n",
  "problem_statement": "Improve feedback when replacing partition with diffent primary key\n**Describe the issue**\r\n\r\nImprove feedback when trying to replace a partition with a different index\r\n\r\n**Which ClickHouse server version to use**\r\n\r\n21.9.5\r\n\r\n\r\n**How to reproduce**\r\n\r\n```\r\nDROP DATABASE IF EXISTS test;\r\n\r\nCREATE DATABASE test;\r\n\r\nCREATE TABLE test.A (id UInt32, company UInt32, total UInt64) ENGINE=SummingMergeTree() PARTITION BY company PRIMARY KEY (id) ORDER BY (id, company);\r\n\r\nINSERT INTO test.A SELECT number%10 as id, number%2 as company, count() as total FROM numbers(100) GROUP BY id,company;\r\n\r\nCREATE TABLE test.B (id UInt32, company UInt32, total UInt64) ENGINE=SummingMergeTree() PARTITION BY company ORDER BY (id, company);\r\n\r\nALTER TABLE test.B REPLACE PARTITION '0' FROM test.A;\r\n\r\n```\r\n\r\n**Error message and/or stacktrace**\r\n\r\n```\r\nReceived exception from server (version 21.9.5):\r\nCode: 33. DB::Exception: Received from localhost:9000. DB::Exception: Cannot read all data. Bytes read: 0. Bytes expected: 4.. (CANNOT_READ_ALL_DATA)\r\n(query: ALTER TABLE test.B REPLACE PARTITION '0' FROM test.A;)\r\n````\r\n\r\n**Expected behavior**\r\n\r\n```\r\nCode: 33. DB::Exception: Received from localhost:9000. DB::Exception: Cannot replace partition different index (CANNOT_REPLACE_PARTITION)\r\n(query: ALTER TABLE test.B REPLACE PARTITION '0' FROM test.A;)\r\n```\r\n\n",
  "hints_text": "Same message for master (`22.3.1.1`):\r\n\r\n```\r\nALTER TABLE test.B\r\n    REPLACE PARTITION '0' FROM test.A\r\n\r\nQuery id: e5467c8d-c9ca-4fee-864e-cd9f603f67c1\r\n\r\n\r\n0 rows in set. Elapsed: 0.025 sec. \r\n\r\nReceived exception from server (version 22.3.1):\r\nCode: 33. DB::Exception: Received from localhost:9000. DB::Exception: Cannot read all data. Bytes read: 0. Bytes expected: 4.. (CANNOT_READ_ALL_DATA)\r\n```",
  "created_at": "2022-09-27T13:28:30Z"
}