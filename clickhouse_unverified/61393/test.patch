diff --git a/tests/queries/0_stateless/03009_consecutive_keys_nullable.reference b/tests/queries/0_stateless/03009_consecutive_keys_nullable.reference
new file mode 100644
index 000000000000..e1b9e0cba620
--- /dev/null
+++ b/tests/queries/0_stateless/03009_consecutive_keys_nullable.reference
@@ -0,0 +1,16 @@
+1	2	0
+\N	1	1
+1	2	0
+\N	1	1
+\N	3	3
+1	3	0
+1	2	0
+\N	1	1
+1	1	0
+\N	2	2
+t_nullable_keys_1	0
+t_nullable_keys_2	0
+t_nullable_keys_3	1
+t_nullable_keys_4	1
+t_nullable_keys_5	0
+t_nullable_keys_6	0
diff --git a/tests/queries/0_stateless/03009_consecutive_keys_nullable.sql b/tests/queries/0_stateless/03009_consecutive_keys_nullable.sql
new file mode 100644
index 000000000000..7650cf14a497
--- /dev/null
+++ b/tests/queries/0_stateless/03009_consecutive_keys_nullable.sql
@@ -0,0 +1,56 @@
+DROP TABLE IF EXISTS t_nullable_keys_1;
+
+CREATE TABLE t_nullable_keys_1 (x Nullable(Int64)) ENGINE = Memory;
+INSERT INTO t_nullable_keys_1 VALUES (1), (1), (NULL);
+SELECT x, count(), countIf(x IS NULL) FROM t_nullable_keys_1 GROUP BY x ORDER BY x;
+
+DROP TABLE t_nullable_keys_1;
+
+DROP TABLE IF EXISTS t_nullable_keys_2;
+
+CREATE TABLE t_nullable_keys_2 (x Nullable(Int64)) ENGINE = Memory;
+INSERT INTO t_nullable_keys_2 VALUES (NULL), (1), (1);
+SELECT x, count(), countIf(x IS NULL) FROM t_nullable_keys_2 GROUP BY x ORDER BY x;
+
+DROP TABLE t_nullable_keys_2;
+
+DROP TABLE IF EXISTS t_nullable_keys_3;
+
+CREATE TABLE t_nullable_keys_3 (x Nullable(Int64)) ENGINE = Memory;
+INSERT INTO t_nullable_keys_3 VALUES (NULL), (NULL), (NULL);
+SELECT x, count(), countIf(x IS NULL) FROM t_nullable_keys_3 GROUP BY x ORDER BY x;
+
+DROP TABLE t_nullable_keys_3;
+
+DROP TABLE IF EXISTS t_nullable_keys_4;
+
+CREATE TABLE t_nullable_keys_4 (x Nullable(Int64)) ENGINE = Memory;
+INSERT INTO t_nullable_keys_4 VALUES (1), (1), (1);
+SELECT x, count(), countIf(x IS NULL) FROM t_nullable_keys_4 GROUP BY x ORDER BY x;
+
+DROP TABLE t_nullable_keys_4;
+
+DROP TABLE IF EXISTS t_nullable_keys_5;
+
+CREATE TABLE t_nullable_keys_5 (x Nullable(Int64)) ENGINE = Memory;
+INSERT INTO t_nullable_keys_5 VALUES (1), (NULL), (1);
+SELECT x, count(), countIf(x IS NULL) FROM t_nullable_keys_5 GROUP BY x ORDER BY x;
+
+DROP TABLE t_nullable_keys_5;
+
+DROP TABLE IF EXISTS t_nullable_keys_6;
+
+CREATE TABLE t_nullable_keys_6 (x Nullable(Int64)) ENGINE = Memory;
+INSERT INTO t_nullable_keys_6 VALUES (NULL), (1), (NULL);
+SELECT x, count(), countIf(x IS NULL) FROM t_nullable_keys_6 GROUP BY x ORDER BY x;
+
+DROP TABLE t_nullable_keys_6;
+
+SYSTEM FLUSH LOGS;
+
+SELECT
+    splitByChar('.', tables[1])[2] AS table,
+    ProfileEvents['AggregationOptimizedEqualRangesOfKeys'] > 0
+FROM system.query_log
+WHERE type = 'QueryFinish' AND current_database = currentDatabase() AND query LIKE '%SELECT%FROM%t_nullable_keys_%'
+ORDER BY table;
