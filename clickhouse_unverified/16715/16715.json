{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 16715,
  "instance_id": "ClickHouse__ClickHouse-16715",
  "issue_numbers": [
    "16605"
  ],
  "base_commit": "1cdb447b77a34d32da67c5a94150d0c27a35da1b",
  "patch": "diff --git a/src/Server/MySQLHandler.cpp b/src/Server/MySQLHandler.cpp\nindex c88b9016e84b..957930ad43bb 100644\n--- a/src/Server/MySQLHandler.cpp\n+++ b/src/Server/MySQLHandler.cpp\n@@ -328,6 +328,16 @@ void MySQLHandler::comQuery(ReadBuffer & payload)\n \n         Context query_context = connection_context;\n \n+        std::atomic<size_t> affected_rows {0};\n+        auto prev = query_context.getProgressCallback();\n+        query_context.setProgressCallback([&, prev = prev](const Progress & progress)\n+        {\n+            if (prev)\n+                prev(progress);\n+\n+            affected_rows += progress.written_rows;\n+        });\n+\n         executeQuery(should_replace ? replacement : payload, *out, true, query_context,\n             [&with_output](const String &, const String &, const String &, const String &)\n             {\n@@ -336,7 +346,7 @@ void MySQLHandler::comQuery(ReadBuffer & payload)\n         );\n \n         if (!with_output)\n-            packet_endpoint->sendPacket(OKPacket(0x00, client_capability_flags, 0, 0, 0), true);\n+            packet_endpoint->sendPacket(OKPacket(0x00, client_capability_flags, affected_rows, 0, 0), true);\n     }\n }\n \n",
  "test_patch": "diff --git a/tests/integration/test_mysql_protocol/test.py b/tests/integration/test_mysql_protocol/test.py\nindex 04cbef59af7a..e2f787f9ee34 100644\n--- a/tests/integration/test_mysql_protocol/test.py\n+++ b/tests/integration/test_mysql_protocol/test.py\n@@ -154,6 +154,36 @@ def test_mysql_client_exception(mysql_client, server_address):\n                             \"ERROR 1000 (00000) at line 1: Poco::Exception. Code: 1000, e.code() = 2002, e.displayText() = mysqlxx::ConnectionFailed: Can't connect to MySQL server on '127.0.0.1' (115) ((nullptr):0)\"\n \n \n+def test_mysql_affected_rows(mysql_client, server_address):\n+    code, (stdout, stderr) = mysql_client.exec_run('''\n+        mysql --protocol tcp -h {host} -P {port} default -u default --password=123\n+        -e \"CREATE TABLE IF NOT EXISTS default.t1 (n UInt64) ENGINE MergeTree() ORDER BY tuple();\"\n+    '''.format(host=server_address, port=server_port), demux=True)\n+    assert code == 0\n+\n+    code, (stdout, stderr) = mysql_client.exec_run('''\n+        mysql -vvv --protocol tcp -h {host} -P {port} default -u default --password=123\n+        -e \"INSERT INTO default.t1(n) VALUES(1);\"\n+    '''.format(host=server_address, port=server_port), demux=True)\n+\n+    assert code == 0\n+    assert \"1 row affected\" in stdout.decode()\n+\n+    code, (stdout, stderr) = mysql_client.exec_run('''\n+        mysql -vvv --protocol tcp -h {host} -P {port} default -u default --password=123\n+        -e \"INSERT INTO default.t1(n) SELECT * FROM numbers(1000)\"\n+    '''.format(host=server_address, port=server_port), demux=True)\n+\n+    assert code == 0\n+    assert \"1000 rows affected\" in stdout.decode()\n+\n+    code, (stdout, stderr) = mysql_client.exec_run('''\n+        mysql --protocol tcp -h {host} -P {port} default -u default --password=123\n+        -e \"DROP TABLE default.t1;\"\n+    '''.format(host=server_address, port=server_port), demux=True)\n+    assert code == 0\n+\n+\n def test_mysql_replacement_query(mysql_client, server_address):\n     # SHOW TABLE STATUS LIKE.\n     code, (stdout, stderr) = mysql_client.exec_run('''\n",
  "problem_statement": "ClickHouse doesn't return affected rows via MySQL protocol for INSERT queries after 20.5+\n**Describe the bug**\r\nClickHouse doesn't return affected rows via MySQL protocol for INSERT queries after 20.5+\r\n\r\n**How to reproduce**\r\ni create clear docker-compose environment for reproduce behavior MySQL + clickhouse + php + python\r\nhttps://gist.github.com/Slach/aa67440ce856a3a53f64f92eeddfbc1b\r\n\r\n**Queries to run that lead to unexpected result**\r\n```\r\nINSERT INTO default.t1(n) SELECT * FROM numbers(1000)\r\n```\r\n\r\n**Expected behavior**\r\nMySQL protocol shall return affected rows field for INSERT queries (it works successful in 20.3 and 20.4)\r\n![image](https://user-images.githubusercontent.com/105560/97867431-aa22ae00-1d2f-11eb-8caf-05431ffd29b3.png)\r\n\r\n**Actual behavior**\r\n![image](https://user-images.githubusercontent.com/105560/97867401-9f681900-1d2f-11eb-93cc-5ae6f1f5981b.png)\n",
  "hints_text": "CH simply does not know this.\n@den-crane \r\nwhy CH knew it in 20.3, 20.4 but forget in 20.5+?\r\nand why it successfully save into `system.query_log` `result_rows` field?\r\nit will break MUCH cases for users which expect affected rows to ensure some data was inserted\nNot sure Why it was working before.\r\n```\r\n\r\ncreate table A ( A String) Engine=Memory;\r\ninsert into A values('a'),('b');\r\n2 rows in set.                  <<<<<<<-----------\r\n\r\ncreate table A1 as A\r\ninsert into A1 select * from A\r\n0 rows in set\r\n\r\ninsert into A1 SELECT toString(number) FROM numbers(1000)\r\n0 rows in set.\r\n```\n@Slach Check this in 20.3\r\n\r\nINSERT INTO default.t1(n) SELECT * FROM numbers(1000) where number%3\n@den-crane \r\ndone\r\nlook to https://gist.github.com/Slach/aa67440ce856a3a53f64f92eeddfbc1b/revisions?diff=split\r\n\r\n```\r\nstring(26) \"CLICKHOUSE #2 INSERT QUERY\"\r\nstring(70) \"INSERT INTO default.t1(n) SELECT * FROM numbers(1000) where number % 3\"\r\nstring(6) \"RESULT\"\r\nbool(true)\r\nstring(27) \"CLICKHOUSE #2 affected_rows\"\r\nint(666)\r\n```\nadd steps to reproduce for python in  https://gist.github.com/Slach/aa67440ce856a3a53f64f92eeddfbc1b\r\n\r\n@zhang2014 @BohuTANG could you help us resolve this issue? \nThe problem does exist, but it's not the MySQLHandler/MySQL problem.\r\nWhen we execute `INSERT INTO default.t1(n) SELECT * FROM numbers(1000) where number % 3`, the packet send to MySQL client is not through the MySQLOutputFormat.cpp:\r\nhttps://github.com/ClickHouse/ClickHouse/blob/64bd63ca4999297e041fe853c6e4b6a2fa5bd5f0/src/Processors/Formats/Impl/MySQLOutputFormat.cpp#L77-L82\r\n\r\nInstead it send  directly here:\r\nhttps://github.com/ClickHouse/ClickHouse/blob/64bd63ca4999297e041fe853c6e4b6a2fa5bd5f0/src/Server/MySQLHandler.cpp#L338-L339\r\n\r\nI am not sure why, maybe @alexey-milovidov could give some hints.\n@zhang2014 could you look to https://github.com/ClickHouse/ClickHouse/issues/16605#issuecomment-721468826\r\nand help us resolve this issue?",
  "created_at": "2020-11-05T16:15:12Z",
  "modified_files": [
    "src/Server/MySQLHandler.cpp"
  ],
  "modified_test_files": [
    "tests/integration/test_mysql_protocol/test.py"
  ]
}