{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 69400,
  "instance_id": "ClickHouse__ClickHouse-69400",
  "issue_numbers": [
    "67519"
  ],
  "base_commit": "2b2cd8e3e076827fa61f98c9d422e76acb81e864",
  "patch": "diff --git a/src/IO/S3/URI.cpp b/src/IO/S3/URI.cpp\nindex 9c80b377661b..73bbba055d04 100644\n--- a/src/IO/S3/URI.cpp\n+++ b/src/IO/S3/URI.cpp\n@@ -36,7 +36,7 @@ URI::URI(const std::string & uri_, bool allow_archive_path_syntax)\n     /// Case when bucket name represented in domain name of S3 URL.\n     /// E.g. (https://bucket-name.s3.region.amazonaws.com/key)\n     /// https://docs.aws.amazon.com/AmazonS3/latest/dev/VirtualHosting.html#virtual-hosted-style-access\n-    static const RE2 virtual_hosted_style_pattern(R\"((.+)\\.(s3express[\\-a-z0-9]+|s3|cos|obs|oss|eos)([.\\-][a-z0-9\\-.:]+))\");\n+    static const RE2 virtual_hosted_style_pattern(R\"(([^.]+)\\.(s3express[\\-a-z0-9]+|s3|cos|obs|.*oss[^\\/]*|eos)([.\\-][a-z0-9\\-.:]+))\");\n \n     /// Case when AWS Private Link Interface is being used\n     /// E.g. (bucket.vpce-07a1cd78f1bd55c5f-j3a3vg6w.s3.us-east-1.vpce.amazonaws.com/bucket-name/key)\n",
  "test_patch": "diff --git a/src/IO/tests/gtest_s3_uri.cpp b/src/IO/tests/gtest_s3_uri.cpp\nindex c0bf7fcb28a1..abe80db7ba59 100644\n--- a/src/IO/tests/gtest_s3_uri.cpp\n+++ b/src/IO/tests/gtest_s3_uri.cpp\n@@ -204,6 +204,14 @@ TEST(S3UriTest, validPatterns)\n         ASSERT_EQ(\"\", uri.version_id);\n         ASSERT_EQ(true, uri.is_virtual_hosted_style);\n     }\n+    {\n+        S3::URI uri(\"https://bucket-test.cn-beijing-internal.oss-data-acc.aliyuncs.com/cc-2zeh496zqm0g6e09g\");\n+        ASSERT_EQ(\"https://cn-beijing-internal.oss-data-acc.aliyuncs.com\", uri.endpoint);\n+        ASSERT_EQ(\"bucket-test\", uri.bucket);\n+        ASSERT_EQ(\"cc-2zeh496zqm0g6e09g\", uri.key);\n+        ASSERT_EQ(\"\", uri.version_id);\n+        ASSERT_EQ(true, uri.is_virtual_hosted_style);\n+    }\n }\n \n TEST(S3UriTest, versionIdChecks)\n",
  "problem_statement": "S3 URI does not handle endpoints not start with s3/oss\n(you don't have to strictly follow this form)\r\n\r\n**Company or project name**\r\nAlibaba cloud\r\nPut your company name or project description here\r\n\r\n**Describe the unexpected behaviour**\r\n\r\nFor example, with the endpoint like:\r\n`https://bucket-test.cn-beijing-internal.oss-data-acc.aliyuncs.com/cc-2zeh496zqm0g6e09g/`\r\n\r\nThe expected parsing result is:\r\nbucket \uff1a bucket-test\r\nurl: cn-beijing-internal.oss-data-acc.aliyuncs.com\r\npath: cc-2zeh496zqm0g6e09g\r\n\r\nHowever, the the bucket would be parsed into \"bucket-test.cn-beijing-internal\".\r\n\r\nThere are two problems here\r\n1.  The endpoint is split according to \".s3/.oss\" as the delimiter and is not compatible with situations that do not start with s3. The more appropriate approach would be to use the first '.' to do the split.\r\n\r\n2.  Unable to specify whether to use virtual host or path style.  Even we configured as second_path format. The endpoint still matches the virutal_host's regular rule. \r\n\r\nI can provide a PR if necessary. But before that, some input is needed on the direction of problem solving.\n",
  "hints_text": "I've submitted a pull request, please evaluate it. \r\nThe modification may not be complete yet. Please discuss if possible.",
  "created_at": "2024-09-09T18:48:53Z"
}