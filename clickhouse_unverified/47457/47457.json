{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 47457,
  "instance_id": "ClickHouse__ClickHouse-47457",
  "issue_numbers": [
    "47435"
  ],
  "base_commit": "4a847f25466b065d544f8a4d78597eca790f5c77",
  "patch": "diff --git a/src/Functions/URL/decodeURLComponent.cpp b/src/Functions/URL/decodeURLComponent.cpp\nindex 7d98ccd63a09..05e3fbea3fd9 100644\n--- a/src/Functions/URL/decodeURLComponent.cpp\n+++ b/src/Functions/URL/decodeURLComponent.cpp\n@@ -14,28 +14,33 @@ namespace ErrorCodes\n static size_t encodeURL(const char * __restrict src, size_t src_size, char * __restrict dst, bool space_as_plus)\n {\n     char * dst_pos = dst;\n-    for (size_t i = 0; i < src_size; i++)\n+    for (size_t i = 0; i < src_size; ++i)\n     {\n         if ((src[i] >= '0' && src[i] <= '9') || (src[i] >= 'a' && src[i] <= 'z') || (src[i] >= 'A' && src[i] <= 'Z')\n             || src[i] == '-' || src[i] == '_' || src[i] == '.' || src[i] == '~')\n         {\n-            *dst_pos++ = src[i];\n+            *dst_pos = src[i];\n+            ++dst_pos;\n         }\n         else if (src[i] == ' ' && space_as_plus)\n         {\n-            *dst_pos++ = '+';\n+            *dst_pos = '+';\n+            ++dst_pos;\n         }\n         else\n         {\n-            *dst_pos++ = '%';\n-            *dst_pos++ = hexDigitUppercase(src[i] >> 4);\n-            *dst_pos++ = hexDigitUppercase(src[i] & 0xf);\n+            dst_pos[0] = '%';\n+            ++dst_pos;\n+            writeHexByteUppercase(src[i], dst_pos);\n+            dst_pos += 2;\n         }\n     }\n-    *dst_pos++ = src[src_size];\n+    *dst_pos = 0;\n+    ++dst_pos;\n     return dst_pos - dst;\n }\n \n+\n /// We assume that size of the dst buf isn't less than src_size.\n static size_t decodeURL(const char * __restrict src, size_t src_size, char * __restrict dst, bool plus_as_space)\n {\n@@ -120,10 +125,14 @@ struct CodeURLComponentImpl\n         ColumnString::Chars & res_data, ColumnString::Offsets & res_offsets)\n     {\n         if (code_strategy == encode)\n-            //the destination(res_data) string is at most three times the length of the source string\n+        {\n+            /// the destination(res_data) string is at most three times the length of the source string\n             res_data.resize(data.size() * 3);\n+        }\n         else\n+        {\n             res_data.resize(data.size());\n+        }\n \n         size_t size = offsets.size();\n         res_offsets.resize(size);\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02677_decode_url_component.reference b/tests/queries/0_stateless/02677_decode_url_component.reference\nnew file mode 100644\nindex 000000000000..5f88856dc1cb\n--- /dev/null\n+++ b/tests/queries/0_stateless/02677_decode_url_component.reference\n@@ -0,0 +1,2 @@\n+%D0%BA%D0%BB%D0%B8%D0%BA%D1%85%D0%B0%D1%83%D1%81\t1\n+1\ndiff --git a/tests/queries/0_stateless/02677_decode_url_component.sql b/tests/queries/0_stateless/02677_decode_url_component.sql\nnew file mode 100644\nindex 000000000000..68345b5de16b\n--- /dev/null\n+++ b/tests/queries/0_stateless/02677_decode_url_component.sql\n@@ -0,0 +1,5 @@\n+SELECT\n+    encodeURLComponent('\u043a\u043b\u0438\u043a\u0445\u0430\u0443\u0441') AS encoded,\n+    decodeURLComponent(encoded) = '\u043a\u043b\u0438\u043a\u0445\u0430\u0443\u0441' AS expected_EQ;\n+\n+SELECT DISTINCT decodeURLComponent(encodeURLComponent(randomString(100) AS x)) = x FROM numbers(100000);\n",
  "problem_statement": "encodeURLComponent  makes incorrect results for cyrillic characters\n**How to reproduce**\r\n\r\n```SQL\r\nSELECT\r\n    encodeURLComponent('\u043a\u043b\u0438\u043a\u0445\u0430\u0443\u0441') AS encoded,\r\n    decodeURLComponent(encoded) = '\u043a\u043b\u0438\u043a\u0445\u0430\u0443\u0441' AS expected_EQ\r\n```\r\n\r\n**Actual result**\r\n```\r\n\u250c\u2500encoded\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500expected_EQ\u2500\u2510\r\n\u2502 %a0%A%a0%B%a0%8%a0%A%a1%g5%a0%0%a1%g3%a1%g1 \u2502           0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\n**Expected result**\r\n\r\n```\r\n\u250c\u2500encoded\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500expected_EQ\u2500\u2510\r\n\u2502 %D0%BA%D0%BB%D0%B8%D0%BA%D1%85%D0%B0%D1%83%D1%81 \u2502           1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n```\r\n\r\n\r\n\r\n**Additional context**\r\n\r\n```\r\nSELECT version()\r\n\r\n\r\n\u250c\u2500version()\u2500\u2510\r\n\u2502 23.2.3.17 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n```\n",
  "hints_text": "it seems it's fixed in master\r\n\r\n```sql\r\n23.3.1.252.\r\n\r\nSELECT\r\n    encodeURLComponent('\u043a\u043b\u0438\u043a\u0445\u0430\u0443\u0441' AS x) AS encoded,\r\n    decodeURLComponent(encoded) AS y,\r\n    x = y AS eq\r\n\r\n\u250c\u2500encoded\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500y\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500eq\u2500\u2510\r\n\u2502 %D0%BA%D0%BB%D0%B8%D0%BA%D1%85%D0%B0%D1%83%D1%81 \u2502 \u043a\u043b\u0438\u043a\u0445\u0430\u0443\u0441 \u2502  1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2518\r\n```\nhm,\r\n\r\n```\r\n./clickhouse local\r\nClickHouse local version 22.11.1.92 (official build).\r\n\r\nm1.local :) SELECT\r\n                encodeURLComponent('\u043a\u043b\u0438\u043a\u0445\u0430\u0443\u0441' AS x) AS encoded,\r\n                decodeURLComponent(encoded) AS y,\r\n                x = y AS eq;\r\n\r\nSELECT\r\n    encodeURLComponent('\u043a\u043b\u0438\u043a\u0445\u0430\u0443\u0441' AS x) AS encoded,\r\n    decodeURLComponent(encoded) AS y,\r\n    x = y AS eq\r\n\r\nQuery id: 216a1ea9-046b-4609-a658-c603c3234bd2\r\n\r\n\u250c\u2500encoded\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500y\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500eq\u2500\u2510\r\n\u2502 %i0%cA%i0%cB%i0%c8%i0%cA%i1%y5%i0%c0%i1%y3%i1%y1 \u2502 %i0\ufffd%i0\ufffd%i0\ufffd%i0\ufffd%i1%y5%i0\ufffd%i1%y3%i1%y1 \u2502  0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2518\r\n\r\n\r\n\r\n./clickhouse.0 local\r\nClickHouse local version 23.3.1.1147 (official build).\r\n\r\nm1.local :) SELECT\r\n                encodeURLComponent('\u043a\u043b\u0438\u043a\u0445\u0430\u0443\u0441' AS x) AS encoded,\r\n                decodeURLComponent(encoded) AS y,\r\n                x = y AS eq;\r\n\r\nSELECT\r\n    encodeURLComponent('\u043a\u043b\u0438\u043a\u0445\u0430\u0443\u0441' AS x) AS encoded,\r\n    decodeURLComponent(encoded) AS y,\r\n    x = y AS eq\r\n\r\nQuery id: 3bd0231b-6a8f-45ba-99a8-cbfd8d0e02cc\r\n\r\n\u250c\u2500encoded\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500y\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500eq\u2500\u2510\r\n\u2502 % 0%eA% 0%eB% 0%e8% 0%eA% 1%r5% 0%e0% 1%r3% 1%r1 \u2502 % 0\ufffd% 0\ufffd% 0\ufffd% 0\ufffd% 1%r5% 0\ufffd% 1%r3% 1%r1 \u2502  0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2518\r\n```\nI checked the code. It is obviously wrong.\n@kitaisreal the bug is introduced here: #34607",
  "created_at": "2023-03-11T01:26:16Z"
}