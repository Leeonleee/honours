{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 74948,
  "instance_id": "ClickHouse__ClickHouse-74948",
  "issue_numbers": [
    "74357"
  ],
  "base_commit": "8e98c39756540bc6ac388072f99b9a6fed186f7a",
  "patch": "diff --git a/src/Processors/Formats/Impl/PrettyBlockOutputFormat.cpp b/src/Processors/Formats/Impl/PrettyBlockOutputFormat.cpp\nindex f96cbb8daa84..a06838c0fc5c 100644\n--- a/src/Processors/Formats/Impl/PrettyBlockOutputFormat.cpp\n+++ b/src/Processors/Formats/Impl/PrettyBlockOutputFormat.cpp\n@@ -224,12 +224,17 @@ void PrettyBlockOutputFormat::writeChunk(const Chunk & chunk, PortKind port_kind\n         table_width += width;\n \n     /// Fallback to Vertical format if:\n-    /// enabled by the settings, this is the first chunk (or totals/extremes), the number of rows is small enough,\n+    /// enabled by the settings, this is the first chunk, the number of rows is small enough,\n     /// either the table width is larger than the max_value_width or any of the values contain a newline.\n     if (format_settings.pretty.fallback_to_vertical\n-        && (displayed_rows == 0 || port_kind != PortKind::Main)\n+        && displayed_rows == 0\n         && num_rows <= format_settings.pretty.fallback_to_vertical_max_rows_per_chunk\n         && (table_width >= format_settings.pretty.fallback_to_vertical_min_table_width || has_newlines))\n+    {\n+        use_vertical_format = true;\n+    }\n+\n+    if (use_vertical_format)\n     {\n         if (!vertical_format_fallback)\n         {\ndiff --git a/src/Processors/Formats/Impl/PrettyBlockOutputFormat.h b/src/Processors/Formats/Impl/PrettyBlockOutputFormat.h\nindex c3f05d55e549..47a2340be7ec 100644\n--- a/src/Processors/Formats/Impl/PrettyBlockOutputFormat.h\n+++ b/src/Processors/Formats/Impl/PrettyBlockOutputFormat.h\n@@ -66,6 +66,7 @@ class PrettyBlockOutputFormat : public IOutputFormat\n     {\n         total_rows = 0;\n         displayed_rows = 0;\n+        use_vertical_format = false;\n     }\n \n     static bool cutInTheMiddle(size_t row_num, size_t num_rows, size_t max_rows);\n@@ -79,6 +80,7 @@ class PrettyBlockOutputFormat : public IOutputFormat\n \n     /// Fallback to Vertical format for wide but short tables.\n     std::unique_ptr<IRowOutputFormat> vertical_format_fallback;\n+    bool use_vertical_format = false;\n \n     /// For mono_block == true only\n     Chunk mono_chunk;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03317_pretty_fallback_to_vertical_consistent.reference b/tests/queries/0_stateless/03317_pretty_fallback_to_vertical_consistent.reference\nnew file mode 100644\nindex 000000000000..aa03a1c64b52\n--- /dev/null\n+++ b/tests/queries/0_stateless/03317_pretty_fallback_to_vertical_consistent.reference\n@@ -0,0 +1,490 @@\n+Row 1:\n+\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 2:\n+\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 3:\n+\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 4:\n+\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 5:\n+\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 6:\n+\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 7:\n+\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 8:\n+\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 9:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 10:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+Row 11:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 12:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 13:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 14:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 15:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 16:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 17:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 18:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 19:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 20:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+Row 21:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 22:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 23:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 24:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 25:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 26:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 27:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 28:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 29:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 30:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+Row 31:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 32:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 33:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 34:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 35:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 36:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 37:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 38:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 39:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 40:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+Row 41:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 42:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 43:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 44:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 45:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 46:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 47:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 48:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 49:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 50:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+Row 51:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 52:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 53:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 54:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 55:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 56:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 57:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 58:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 59:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 60:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+Row 61:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 62:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 63:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 64:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 65:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 66:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 67:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 68:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 69:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 70:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+Row 71:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 72:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 73:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 74:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 75:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 76:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 77:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 78:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 79:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxxx\n+\n+Row 80:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxxx\n+Row 81:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxxx\n+\n+Row 82:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxxx\n+\n+Row 83:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxxx\n+\n+Row 84:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxxx\n+\n+Row 85:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxxx\n+\n+Row 86:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxxx\n+\n+Row 87:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxxx\n+y: xxxxxxxxxxxxxx\n+\n+Row 88:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxxx\n+y: xxxxxxxxxxxxx\n+\n+Row 89:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxxx\n+y: xxxxxxxxxxxx\n+\n+Row 90:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxxx\n+y: xxxxxxxxxxx\n+Row 91:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxxx\n+y: xxxxxxxxxx\n+\n+Row 92:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxxx\n+y: xxxxxxxxx\n+\n+Row 93:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxxx\n+y: xxxxxxxx\n+\n+Row 94:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxxx\n+y: xxxxxxx\n+\n+Row 95:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxxx\n+y: xxxxxx\n+\n+Row 96:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxxx\n+y: xxxxx\n+\n+Row 97:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxxx\n+y: xxxx\n+\n+Row 98:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xxx\n+y: xxx\n+\n+Row 99:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: xx\n+y: xx\n+\n+Row 100:\n+\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n+x: x\n+y: x\ndiff --git a/tests/queries/0_stateless/03317_pretty_fallback_to_vertical_consistent.sql b/tests/queries/0_stateless/03317_pretty_fallback_to_vertical_consistent.sql\nnew file mode 100644\nindex 000000000000..6ec67263cd99\n--- /dev/null\n+++ b/tests/queries/0_stateless/03317_pretty_fallback_to_vertical_consistent.sql\n@@ -0,0 +1,1 @@\n+SELECT repeat('x', 100 - number) AS x, repeat('x', 100 - number) AS y FROM numbers(100) SETTINGS max_block_size = 10, output_format_pretty_fallback_to_vertical_min_table_width = 100, output_format_pretty_squash_consecutive_ms = 0 FORMAT PrettyCompact;\n",
  "problem_statement": "Inconsistent Vertical/Pretty table formatting in the client\nHere is the example \r\nfirst block is rendered in **Vertical** format\r\nand following blocks with default **Pretty**\r\n![x](https://github.com/user-attachments/assets/c22ad743-3f29-4c63-9dc4-d7f18be19b8e)\r\n\r\nLocal repro (look at row 62):\r\nhttps://pastila.nl/?00012525/7b7bf99362d75a882d72e0d050ba41a1#ODTHbYIj+RBkRoywndXBYA==\r\n\r\nIt happened in the latest client version, possibly after these PRs\r\nhttps://github.com/ClickHouse/ClickHouse/pull/74032\r\nhttps://github.com/ClickHouse/ClickHouse/pull/73929\r\nhttps://github.com/ClickHouse/ClickHouse/pull/73852\r\n\r\nClient version: 25.1.1.1921\n",
  "hints_text": "",
  "created_at": "2025-01-23T02:20:06Z"
}