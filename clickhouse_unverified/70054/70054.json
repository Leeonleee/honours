{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 70054,
  "instance_id": "ClickHouse__ClickHouse-70054",
  "issue_numbers": [
    "66209"
  ],
  "base_commit": "c4cc1576eb89175ebc5cc10c73dd1c229b0074de",
  "patch": "diff --git a/src/Processors/QueryPlan/FilterStep.cpp b/src/Processors/QueryPlan/FilterStep.cpp\nindex 0c6b71387b72..ee770d1077c7 100644\n--- a/src/Processors/QueryPlan/FilterStep.cpp\n+++ b/src/Processors/QueryPlan/FilterStep.cpp\n@@ -51,6 +51,10 @@ FilterStep::FilterStep(\n     , remove_filter_column(remove_filter_column_)\n {\n     actions_dag.removeAliasesForFilter(filter_column_name);\n+    /// Removing aliases may result in unneeded ALIAS node in DAG.\n+    /// This should not be an issue by itself,\n+    /// but it might trigger an issue with duplicated names in Block after plan optimizations.\n+    actions_dag.removeUnusedActions(false, false);\n }\n \n void FilterStep::transformPipeline(QueryPipelineBuilder & pipeline, const BuildQueryPipelineSettings & settings)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03245_views_and_filter_push_down_bug.reference b/tests/queries/0_stateless/03245_views_and_filter_push_down_bug.reference\nnew file mode 100644\nindex 000000000000..12442cadf31c\n--- /dev/null\n+++ b/tests/queries/0_stateless/03245_views_and_filter_push_down_bug.reference\n@@ -0,0 +1,1 @@\n+1\t2024-05-02 00:00:00\ndiff --git a/tests/queries/0_stateless/03245_views_and_filter_push_down_bug.sql b/tests/queries/0_stateless/03245_views_and_filter_push_down_bug.sql\nnew file mode 100644\nindex 000000000000..be5f27b55dec\n--- /dev/null\n+++ b/tests/queries/0_stateless/03245_views_and_filter_push_down_bug.sql\n@@ -0,0 +1,1 @@\n+select * from view(select id, toDateTime(date) as date from view(select 1 as id, '2024-05-02' as date)) where date='2024-05-02';\n",
  "problem_statement": "Exception after upgrade to 24.6 (Block structure mismatch in ...)\nClickhouse v.24.6.2.17\r\n\r\nError occurs when selecting from a view that depends on another view with an updated column type (this functionality worked before version 24.6).\r\n\r\nHow to reproduce:\r\n```\r\ncreate or replace table test_table engine MergeTree() order by id as\r\nselect 1 as id, '2024-05-02' as date;\r\n\r\ncreate or replace view test_view_t as\r\nselect * from test_table;\r\n\r\ncreate or replace view test_view as\r\nselect id, toDateTime(date) as date from test_view_t;\r\n\r\nselect * from test_view where date='2024-05-02';\r\n```\r\n\r\nExpected behavior:\r\nReturn 1 row\r\n\r\nError message and/or stacktrace:\r\n` Block structure mismatch in (columns with identical name must have identical structure) stream: different types: materialize(date) String String(size = 0) materialize(date) DateTime UInt32(size = 0). (AMBIGUOUS_COLUMN_NAME) (version 24.6.2.17 (official build))`\r\n\n",
  "hints_text": "version 24.7.1.422 also sees this.\nworkaround:\r\n```\r\nselect id, toDateTime(date) as date_date from test_view_t;\r\n\r\nselect * from test_view where date_date='2024-05-02';\r\n```\r\n\r\nuse different names in test_view & test_view_t if the column types changes\r\n\r\n\nAlso have this issue and cant upgrade ch with it :(\nHi all, any news here? @nickitat @alexey-milovidov \nHi, @Algunenano should we expect a fix in 24.9\\10?\nVersion 24.8.3.59 is also affected\nBisected the issue to https://github.com/ClickHouse/ClickHouse/pull/64793. All versions after 24.6 are affected\nSimplified example\r\n```\r\nselect * from view(select id, toDateTime(date) as date from view(select 1 as id, '2024-05-02' as date)) where date='2024-05-02';\r\n\r\nCode: 352. DB::Exception: Received from localhost:9000. DB::Exception: Block structure mismatch in (columns with identical name must have identical structure) stream: different types:\r\nmaterialize(date) String String(size = 0)\r\nmaterialize(date) DateTime UInt32(size = 0). (AMBIGUOUS_COLUMN_NAME)\r\n```",
  "created_at": "2024-09-27T09:50:14Z",
  "modified_files": [
    "src/Processors/QueryPlan/FilterStep.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/03245_views_and_filter_push_down_bug.reference",
    "b/tests/queries/0_stateless/03245_views_and_filter_push_down_bug.sql"
  ]
}