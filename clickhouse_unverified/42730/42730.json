{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 42730,
  "instance_id": "ClickHouse__ClickHouse-42730",
  "issue_numbers": [
    "42245"
  ],
  "base_commit": "ce3496321422afb0bbdeb48bdeb9bf8747f7db4b",
  "patch": "diff --git a/.gitmodules b/.gitmodules\nindex 618cfe6e76b4..ebeef312ae81 100644\n--- a/.gitmodules\n+++ b/.gitmodules\n@@ -65,12 +65,6 @@\n [submodule \"contrib/libgsasl\"]\n \tpath = contrib/libgsasl\n \turl = https://github.com/ClickHouse/libgsasl.git\n-[submodule \"contrib/libcxx\"]\n-\tpath = contrib/libcxx\n-\turl = https://github.com/ClickHouse/libcxx.git\n-[submodule \"contrib/libcxxabi\"]\n-\tpath = contrib/libcxxabi\n-\turl = https://github.com/ClickHouse/libcxxabi.git\n [submodule \"contrib/snappy\"]\n \tpath = contrib/snappy\n \turl = https://github.com/ClickHouse/snappy.git\ndiff --git a/contrib/libcxx b/contrib/libcxx\ndeleted file mode 160000\nindex 4db7f838afd3..000000000000\n--- a/contrib/libcxx\n+++ /dev/null\n@@ -1,1 +0,0 @@\n-Subproject commit 4db7f838afd3139eb3761694b04d31275df45d2d\ndiff --git a/contrib/libcxx-cmake/CMakeLists.txt b/contrib/libcxx-cmake/CMakeLists.txt\nindex 8dc154e9d91a..21ed76f8b6fc 100644\n--- a/contrib/libcxx-cmake/CMakeLists.txt\n+++ b/contrib/libcxx-cmake/CMakeLists.txt\n@@ -1,6 +1,6 @@\n include(CheckCXXCompilerFlag)\n \n-set(LIBCXX_SOURCE_DIR \"${ClickHouse_SOURCE_DIR}/contrib/libcxx\")\n+set(LIBCXX_SOURCE_DIR \"${ClickHouse_SOURCE_DIR}/contrib/llvm-project/libcxx\")\n \n set(SRCS\n \"${LIBCXX_SOURCE_DIR}/src/algorithm.cpp\"\ndiff --git a/contrib/libcxxabi b/contrib/libcxxabi\ndeleted file mode 160000\nindex a736a6b3c6a7..000000000000\n--- a/contrib/libcxxabi\n+++ /dev/null\n@@ -1,1 +0,0 @@\n-Subproject commit a736a6b3c6a7b8aae2ebad629ca21b2c55b4820e\ndiff --git a/contrib/libcxxabi-cmake/CMakeLists.txt b/contrib/libcxxabi-cmake/CMakeLists.txt\nindex a59452eee9a1..0473527912ea 100644\n--- a/contrib/libcxxabi-cmake/CMakeLists.txt\n+++ b/contrib/libcxxabi-cmake/CMakeLists.txt\n@@ -1,4 +1,4 @@\n-set(LIBCXXABI_SOURCE_DIR \"${ClickHouse_SOURCE_DIR}/contrib/libcxxabi\")\n+set(LIBCXXABI_SOURCE_DIR \"${ClickHouse_SOURCE_DIR}/contrib/llvm-project/libcxxabi\")\n \n set(SRCS\n \"${LIBCXXABI_SOURCE_DIR}/src/abort_message.cpp\"\ndiff --git a/contrib/llvm-project b/contrib/llvm-project\nindex 3a39038345a4..e61a81aa6fc5 160000\n--- a/contrib/llvm-project\n+++ b/contrib/llvm-project\n@@ -1,1 +1,1 @@\n-Subproject commit 3a39038345a400e7e767811b142a94355d511215\n+Subproject commit e61a81aa6fc529b469e2a54b7ce788606e138b5d\n",
  "test_patch": "diff --git a/docker/test/fasttest/run.sh b/docker/test/fasttest/run.sh\nindex b4d3405bfd92..7359e0a9402e 100755\n--- a/docker/test/fasttest/run.sh\n+++ b/docker/test/fasttest/run.sh\n@@ -117,8 +117,7 @@ function clone_submodules\n             contrib/cctz\n             contrib/libcpuid\n             contrib/double-conversion\n-            contrib/libcxx\n-            contrib/libcxxabi\n+            contrib/llvm-project\n             contrib/lz4\n             contrib/zstd\n             contrib/fastops\n",
  "problem_statement": "Duplicated LLVM submodules\nWith the update to LLVM 15, which was great, CH now has multiple copies of the same LLVM submodules:\r\n\r\n* libunwind: Unwind fork. AFAICT heavily modified.\r\n* libcxx: Only minor differences with libc++ (LLVM 14)\r\n* libcxxabi: Only minor differences with libc++-abi (LLVM 14)\r\n* llvm-project: Has all the submodules (LLVM 15)\r\n\r\nI think it'd be way easier to keep things in sync and update properly if at least libcxx, libcxxabi were using the llvm-project submodule code instead. I'm not sure about libunwind since that seems to include lots of changes that might be harder to integrate and keep updated.\n",
  "hints_text": "Ok to integrate all the changes inside the single LLVM repository, but the following caveats exist:\r\n1. We need to carefully port every change as a separate commit, otherwise it will be difficult to support.\r\n2. Currently, we have an LLVM submodule optional, but all the rest is mandatory. If we integrate everything inside the LLVM submodule, the checkout will slow down the fast test.\r\n\r\nUp to @rschu1ze \nI have this on my TODO list and in fact yesterday checked how our libcxx(abi) differ from their upstream versions :-)\r\n\r\nA single LLVM repository would not save a lot of space compared to what we have now. The main improvement will be that we can use [sane branch management](https://clickhouse.com/docs/en/development/contrib#adding-third-party-libraries) instead of our current messy history. This will simplify future upgrades.\r\n\r\nThe comment about fast test is a valid one. LLVM checkout takes ca. 1 -2 min for me. Git provides some tricks to further speed that up (shallow, sparse and partial checkouts). Will check if these can be applied to submodules.\nJust noticed that fast test [checks out](https://github.com/ClickHouse/ClickHouse/blob/151137d6d5c182b752ffaff6c8cbb35e7f72874f/docker/test/fasttest/run.sh#L142) all submodules with `--depth=1`. This is a partial checkout, i.e. only blobs needed for the required Git hash are fetched. This reduces checkout time for llvm-project from ca. 2:03 min to 1:10 min. I also experimented with sparse checkouts but it removes just 5 more secs and is fiddly with submodules.",
  "created_at": "2022-10-27T09:19:47Z"
}