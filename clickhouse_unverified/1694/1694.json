{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 1694,
  "instance_id": "ClickHouse__ClickHouse-1694",
  "issue_numbers": [
    "1682"
  ],
  "base_commit": "aed35f16ca35392a67c5a04a161092241f2eb9d2",
  "patch": "diff --git a/dbms/src/Parsers/ParserInsertQuery.cpp b/dbms/src/Parsers/ParserInsertQuery.cpp\nindex b0fdda5765a3..0842c1fbd927 100644\n--- a/dbms/src/Parsers/ParserInsertQuery.cpp\n+++ b/dbms/src/Parsers/ParserInsertQuery.cpp\n@@ -33,6 +33,7 @@ bool ParserInsertQuery::parseImpl(Pos & pos, ASTPtr & node, Expected & expected)\n     ParserKeyword s_values(\"VALUES\");\n     ParserKeyword s_format(\"FORMAT\");\n     ParserKeyword s_select(\"SELECT\");\n+    ParserKeyword s_with(\"WITH\");\n     ParserToken s_lparen(TokenType::OpeningRoundBracket);\n     ParserToken s_rparen(TokenType::ClosingRoundBracket);\n     ParserIdentifier name_p;\n@@ -119,7 +120,7 @@ bool ParserInsertQuery::parseImpl(Pos & pos, ASTPtr & node, Expected & expected)\n         if (data < end && *data == '\\n')\n             ++data;\n     }\n-    else if (s_select.ignore(pos, expected))\n+    else if (s_select.ignore(pos, expected) || s_with.ignore(pos,expected))\n     {\n         pos = before_select;\n         ParserSelectQuery select_p;\n",
  "test_patch": "diff --git a/dbms/tests/queries/0_stateless/00544_insert_with_select.reference b/dbms/tests/queries/0_stateless/00544_insert_with_select.reference\nnew file mode 100644\nindex 000000000000..6cbacc59210b\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00544_insert_with_select.reference\n@@ -0,0 +1,3 @@\n+0\t0\n+1\t2\n+2\t4\ndiff --git a/dbms/tests/queries/0_stateless/00544_insert_with_select.sql b/dbms/tests/queries/0_stateless/00544_insert_with_select.sql\nnew file mode 100644\nindex 000000000000..63ff2b7fd932\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00544_insert_with_select.sql\n@@ -0,0 +1,9 @@\n+DROP TABLE IF EXISTS test.test;\n+\n+CREATE TABLE test.test(number UInt64, num2 UInt64) ENGINE = Log;\n+\n+INSERT INTO test.test WITH number * 2 AS num2 SELECT number, num2 FROM system.numbers LIMIT 3;\n+\n+SELECT * FROM test.test;\n+\n+DROP TABLE test.test;\n",
  "problem_statement": "Syntax error occurs when you try to insert a result of SELECT using WITH into a table\nSyntax error occurs when you try to insert a result of SELECT using WITH into a table.\r\n\r\n<pre>\r\n:) WITH number * 2 AS num2 SELECT number, num2 FROM system.numbers LIMIT 3;\r\n\r\nWITH number * 2 AS num2\r\nSELECT\r\n    number,\r\n    num2\r\nFROM system.numbers\r\nLIMIT 3\r\n\r\n\u250c\u2500number\u2500\u252c\u2500num2\u2500\u2510\r\n\u2502      0 \u2502    0 \u2502\r\n\u2502      1 \u2502    2 \u2502\r\n\u2502      2 \u2502    4 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n3 rows in set. Elapsed: 0.007 sec.\r\n\r\n:) CREATE TABLE test_number (number UInt64, num2 UInt64) ENGINE = Log;\r\n\r\nCREATE TABLE test_number\r\n(\r\n    number UInt64,\r\n    num2 UInt64\r\n)\r\nENGINE = Log\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.015 sec.\r\n\r\n:) INSERT INTO test_number WITH number * 2 AS num2 SELECT number, num2 FROM system.numbers LIMIT 3;\r\n\r\nSyntax error: failed at position 25:\r\n\r\nINSERT INTO test_number WITH number * 2 AS num2 SELECT number, num2 FROM system.numbers LIMIT 3;\r\n\r\nExpected one of: VALUES, FORMAT, OpeningRoundBracket, Dot, token, SELECT\r\n\r\n:) INSERT INTO test_number SELECT number, number * 2 AS num2 FROM system.numbers LIMIT 3;\r\n\r\nINSERT INTO test_number SELECT\r\n    number,\r\n    number * 2 AS num2\r\nFROM system.numbers\r\nLIMIT 3\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.012 sec.\r\n</pre>\r\n\n",
  "hints_text": "Also you can use subquery as a workaround:\r\n```SQL\r\nINSERT INTO test_number SELECT * FROM (WITH number * 2 AS num2 SELECT number, num2 FROM system.numbers LIMIT 3)\r\n```",
  "created_at": "2017-12-24T09:24:58Z"
}