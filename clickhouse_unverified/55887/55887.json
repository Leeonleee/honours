{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 55887,
  "instance_id": "ClickHouse__ClickHouse-55887",
  "issue_numbers": [
    "42077"
  ],
  "base_commit": "8f8fbb59c1285f0102e6ca981e560a11d4e0fb97",
  "patch": "diff --git a/src/Interpreters/NormalizeSelectWithUnionQueryVisitor.cpp b/src/Interpreters/NormalizeSelectWithUnionQueryVisitor.cpp\nindex cbdd656fb8cf..f48b987561e5 100644\n--- a/src/Interpreters/NormalizeSelectWithUnionQueryVisitor.cpp\n+++ b/src/Interpreters/NormalizeSelectWithUnionQueryVisitor.cpp\n@@ -29,7 +29,13 @@ void NormalizeSelectWithUnionQueryMatcher::getSelectsFromUnionListNode(ASTPtr as\n void NormalizeSelectWithUnionQueryMatcher::visit(ASTPtr & ast, Data & data)\n {\n     if (auto * select_union = ast->as<ASTSelectWithUnionQuery>())\n+    {\n+        /// The rewrite of ASTSelectWithUnionQuery may strip the format info, so\n+        /// we need to keep and restore it.\n+        auto format = select_union->format;\n         visit(*select_union, data);\n+        select_union->format = format;\n+    }\n }\n \n void NormalizeSelectWithUnionQueryMatcher::visit(ASTSelectWithUnionQuery & ast, Data & data)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02896_union_distinct_http_format.reference b/tests/queries/0_stateless/02896_union_distinct_http_format.reference\nnew file mode 100644\nindex 000000000000..3a68ab6dc9f2\n--- /dev/null\n+++ b/tests/queries/0_stateless/02896_union_distinct_http_format.reference\n@@ -0,0 +1,7 @@\n+\u250c\u2500\u001b[1m1\u001b[0m\u2500\u2510\n+\u2502 1 \u2502\n+\u2514\u2500\u2500\u2500\u2518\n+\u250c\u2500\u001b[1ma\u001b[0m\u2500\u2510\n+\u2502 1 \u2502\n+\u2502 2 \u2502\n+\u2514\u2500\u2500\u2500\u2518\ndiff --git a/tests/queries/0_stateless/02896_union_distinct_http_format.sh b/tests/queries/0_stateless/02896_union_distinct_http_format.sh\nnew file mode 100755\nindex 000000000000..bb35800e39d9\n--- /dev/null\n+++ b/tests/queries/0_stateless/02896_union_distinct_http_format.sh\n@@ -0,0 +1,8 @@\n+#!/usr/bin/env bash\n+\n+CURDIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CURDIR\"/../shell_config.sh\n+\n+curl -d@- -sS \"${CLICKHOUSE_URL}\" <<< 'SELECT 1 UNION DISTINCT SELECT 1 FORMAT PrettyCompactMonoBlock'\n+curl -d@- -sS \"${CLICKHOUSE_URL}\" <<< 'SELECT * FROM (SELECT 1 as a UNION DISTINCT SELECT 2 as a) ORDER BY a FORMAT PrettyCompactMonoBlock'\n",
  "problem_statement": "UNION DISTINCT may strip FORMAT from the query\nUnion distinct can not be returned as PrettyCompactMonoBlock.\r\n\r\n```\r\nselect 1\r\nunion all\r\nselect 2\r\nformat PrettyCompactMonoBlock\r\n```\r\n\r\nhttps://play.clickhouse.com/?user=play&query=select%201%20union%20all%20select%202%20format%20PrettyCompactMonoBlock\r\n\r\nReturns as expected:\r\n```\r\n\u250c\u2500\u001b[1m1\u001b[0m\u2500\u2510\r\n\u2502 1 \u2502\r\n\u2502 2 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n```\r\nHowever:\r\n```\r\nselect 1\r\nunion distinct\r\nselect 2\r\nformat PrettyCompactMonoBlock\r\n```\r\n\r\nhttps://play.clickhouse.com/?user=play&query=select%201%20union%20distinct%20select%202%20format%20PrettyCompactMonoBlock\r\n\r\nReturns TSV.\n",
  "hints_text": "The bug is introduced here: #16338\n```\r\n$ curl http://127.0.0.1:8123/ --data-binary 'explain select 1 union distinct select 2 format PrettyCompactMonoBlock'\r\n\u250c\u2500explain\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 Distinct                                                                    \u2502\r\n\u2502   Union                                                                     \u2502\r\n\u2502     Expression ((Conversion before UNION + (Projection + Before ORDER BY))) \u2502\r\n\u2502       ReadFromStorage (SystemOne)                                           \u2502\r\n\u2502     Expression ((Conversion before UNION + (Projection + Before ORDER BY))) \u2502\r\n\u2502       ReadFromStorage (SystemOne)                                           \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\n@ucasfl maybe you can help?\n@ucasfl Maybe you can help?\nI cann't reproduce now, looks works well:\r\n```sql\r\nSELECT 1\r\nUNION DISTINCT\r\nSELECT 2\r\nFORMAT PrettyCompactMonoBlock\r\n\r\nQuery id: acee9b76-1d45-44be-bf0f-5257e4d7e896\r\n\r\n\u250c\u25001\u2500\u2510\r\n\u2502 1 \u2502\r\n\u2502 2 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n\r\n2 rows in set. Elapsed: 0.001 sec.\r\n\r\nSELECT 1\r\nUNION ALL\r\nSELECT 2\r\nFORMAT PrettyCompactMonoBlock\r\n\r\nQuery id: 1b016329-af3d-4688-8083-8eb87fa073f0\r\n\r\n\u250c\u25001\u2500\u2510\r\n\u2502 1 \u2502\r\n\u2502 2 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n\r\n2 rows in set. Elapsed: 0.001 sec. \r\n```\n@ucasfl Only in the HTTP interface.",
  "created_at": "2023-10-20T16:32:28Z",
  "modified_files": [
    "src/Interpreters/NormalizeSelectWithUnionQueryVisitor.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02896_union_distinct_http_format.reference",
    "b/tests/queries/0_stateless/02896_union_distinct_http_format.sh"
  ]
}