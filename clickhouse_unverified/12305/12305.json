{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 12305,
  "instance_id": "ClickHouse__ClickHouse-12305",
  "issue_numbers": [
    "12166"
  ],
  "base_commit": "1918d1d4176c0b8abc5ad8bbb26ea5b81a2cdb88",
  "patch": "diff --git a/src/Storages/VirtualColumnUtils.cpp b/src/Storages/VirtualColumnUtils.cpp\nindex 2e1ce33951a5..f0718a014b80 100644\n--- a/src/Storages/VirtualColumnUtils.cpp\n+++ b/src/Storages/VirtualColumnUtils.cpp\n@@ -14,6 +14,7 @@\n \n #include <Columns/ColumnsNumber.h>\n #include <Columns/ColumnsCommon.h>\n+#include <Columns/FilterDescription.h>\n \n #include <Storages/VirtualColumnUtils.h>\n #include <IO/WriteHelpers.h>\n@@ -127,12 +128,21 @@ void filterBlockWithQuery(const ASTPtr & query, Block & block, const Context & c\n     /// Filter the block.\n     String filter_column_name = expression_ast->getColumnName();\n     ColumnPtr filter_column = block_with_filter.getByName(filter_column_name).column->convertToFullColumnIfConst();\n-    const IColumn::Filter & filter = typeid_cast<const ColumnUInt8 &>(*filter_column).getData();\n+\n+    ConstantFilterDescription constant_filter(*filter_column);\n+\n+    if (constant_filter.always_true)\n+        return;\n+\n+    if (constant_filter.always_false)\n+        block = block.cloneEmpty();\n+\n+    FilterDescription filter(*filter_column);\n \n     for (size_t i = 0; i < block.columns(); ++i)\n     {\n         ColumnPtr & column = block.safeGetByPosition(i).column;\n-        column = column->filter(filter, -1);\n+        column = column->filter(*filter.data, -1);\n     }\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01389_filter_by_virtual_columns.reference b/tests/queries/0_stateless/01389_filter_by_virtual_columns.reference\nnew file mode 100644\nindex 000000000000..573541ac9702\n--- /dev/null\n+++ b/tests/queries/0_stateless/01389_filter_by_virtual_columns.reference\n@@ -0,0 +1,1 @@\n+0\ndiff --git a/tests/queries/0_stateless/01389_filter_by_virtual_columns.sql b/tests/queries/0_stateless/01389_filter_by_virtual_columns.sql\nnew file mode 100644\nindex 000000000000..43ce3ad40e5f\n--- /dev/null\n+++ b/tests/queries/0_stateless/01389_filter_by_virtual_columns.sql\n@@ -0,0 +1,2 @@\n+SELECT count() FROM system.parts WHERE table = NULL AND database = currentDatabase();\n+SELECT DISTINCT marks FROM system.parts WHERE (table = NULL) AND (database = currentDatabase()) AND (active = 1);\n",
  "problem_statement": "Bad cast from type DB::ColumnNullable to DB::ColumnVector<char8_t>\n```\r\n/4/ :) SELECT DISTINCT marks FROM system.parts WHERE (table = NULL) AND (database = currentDatabase()) AND (active = 1)\r\n\r\n\r\nReceived exception from server (version 20.6.1):\r\nCode: 49. DB::Exception: Received from localhost:9000. DB::Exception: Bad cast from type DB::ColumnNullable to DB::ColumnVector<char8_t>. Stack trace:\r\n\r\n0. /home/akuzm/ch4/ch/contrib/poco/Foundation/src/Exception.cpp:27: Poco::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x1152b5c0 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n1. /home/akuzm/ch4/ch/src/Common/Exception.cpp:37: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x97a736d in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n2. std::__1::enable_if<is_reference_v<DB::ColumnVector<char8_t> const&>, DB::ColumnVector<char8_t> const&>::type typeid_cast<DB::ColumnVector<char8_t> const&, DB::IColumn const>(DB::IColumn const&) @ 0xba0e327 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n3. /home/akuzm/ch4/ch/src/Storages/VirtualColumnUtils.cpp:132: DB::VirtualColumnUtils::filterBlockWithQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Block&, DB::Context const&) @ 0xe9547ee in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n4. /home/akuzm/ch4/ch/src/Storages/System/StorageSystemPartsBase.cpp:159: DB::StoragesInfoStream::StoragesInfoStream(DB::SelectQueryInfo const&, DB::Context const&) @ 0xdc50237 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n5. /home/akuzm/ch4/ch/src/Storages/System/StorageSystemPartsBase.cpp:241: DB::StorageSystemPartsBase::read(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&, DB::SelectQueryInfo const&, DB::Context const&, DB::QueryProcessingStage::Enum, unsigned long, unsigned int) @ 0xdc517f7 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n6. /home/akuzm/ch4/ch/src/Processors/QueryPlan/ReadFromStorageStep.cpp:42: DB::ReadFromStorageStep::ReadFromStorageStep(std::__1::shared_ptr<DB::RWLockImpl::LockHolderImpl>, std::__1::shared_ptr<DB::StorageInMemoryMetadata const>&, DB::SelectQueryOptions, std::__1::shared_ptr<DB::IStorage>, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, DB::SelectQueryInfo const&, std::__1::shared_ptr<DB::Context>, DB::QueryProcessingStage::Enum, unsigned long, unsigned long) @ 0xf00c667 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n7. /home/akuzm/ch4/ch/contrib/libcxx/include/memory:3028: DB::InterpreterSelectQuery::executeFetchColumns(DB::QueryProcessingStage::Enum, DB::QueryPlan&, std::__1::shared_ptr<DB::PrewhereInfo> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0xe3d332d in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n8. /home/akuzm/ch4/ch/src/Interpreters/InterpreterSelectQuery.cpp:793: DB::InterpreterSelectQuery::executeImpl(DB::QueryPlan&, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>) @ 0xe3d7252 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n9. /home/akuzm/ch4/ch/contrib/libcxx/include/optional:224: DB::InterpreterSelectQuery::buildQueryPlan(DB::QueryPlan&) @ 0xe3d8854 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n10. /home/akuzm/ch4/ch/contrib/libcxx/include/vector:1549: DB::InterpreterSelectWithUnionQuery::buildQueryPlan(DB::QueryPlan&) @ 0xe53b57c in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n11. /home/akuzm/ch4/ch/src/Interpreters/InterpreterSelectWithUnionQuery.cpp:200: DB::InterpreterSelectWithUnionQuery::execute() @ 0xe53b8ac in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n12. /home/akuzm/ch4/ch/src/Interpreters/executeQuery.cpp:385: DB::executeQueryImpl(char const*, char const*, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool, DB::ReadBuffer*) @ 0xe6ae372 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n13. /home/akuzm/ch4/ch/src/Interpreters/executeQuery.cpp:644: DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool) @ 0xe6b1aaa in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n14. /home/akuzm/ch4/ch/src/Server/TCPHandler.cpp:253: DB::TCPHandler::runImpl() @ 0xece3bb6 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n15. /home/akuzm/ch4/ch/src/Server/TCPHandler.cpp:1203: DB::TCPHandler::run() @ 0xece4910 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n16. /home/akuzm/ch4/ch/contrib/poco/Net/src/TCPServerConnection.cpp:57: Poco::Net::TCPServerConnection::start() @ 0x1144942b in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n17. /home/akuzm/ch4/ch/contrib/libcxx/include/atomic:856: Poco::Net::TCPServerDispatcher::run() @ 0x114498bb in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n18. /home/akuzm/ch4/ch/contrib/poco/Foundation/include/Poco/Mutex_POSIX.h:59: Poco::PooledThread::run() @ 0x115c8396 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n19. /home/akuzm/ch4/ch/contrib/poco/Foundation/include/Poco/AutoPtr.h:223: Poco::ThreadImpl::runnableEntry(void*) @ 0x115c3790 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n20. start_thread @ 0x9609 in /lib/x86_64-linux-gnu/libpthread-2.31.so\r\n21. /build/glibc-YYA7BZ/glibc-2.31/misc/../sysdeps/unix/sysv/linux/x86_64/clone.S:97: __clone @ 0x122103 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.31.so\r\n```\n",
  "hints_text": "`SELECT count() FROM system.parts WHERE table = NULL AND database = currentDatabase()`",
  "created_at": "2020-07-08T23:56:48Z",
  "modified_files": [
    "src/Storages/VirtualColumnUtils.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01389_filter_by_virtual_columns.reference",
    "b/tests/queries/0_stateless/01389_filter_by_virtual_columns.sql"
  ]
}