{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 36803,
  "instance_id": "ClickHouse__ClickHouse-36803",
  "issue_numbers": [
    "35830"
  ],
  "base_commit": "8e12840941bfd72b65164ed7e104bbc5ffe769cd",
  "patch": "diff --git a/src/Interpreters/InterpreterCreateQuery.cpp b/src/Interpreters/InterpreterCreateQuery.cpp\nindex 5ddd9a227076..f48535efcd18 100644\n--- a/src/Interpreters/InterpreterCreateQuery.cpp\n+++ b/src/Interpreters/InterpreterCreateQuery.cpp\n@@ -589,7 +589,7 @@ ColumnsDescription InterpreterCreateQuery::getColumnsDescription(\n         res.add(std::move(column));\n     }\n \n-    if (context_->getSettingsRef().flatten_nested)\n+    if (!attach && context_->getSettingsRef().flatten_nested)\n         res.flattenNested();\n \n     if (res.getAllPhysical().empty())\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02292_nested_not_flattened_detach.reference b/tests/queries/0_stateless/02292_nested_not_flattened_detach.reference\nnew file mode 100644\nindex 000000000000..52970ab07a97\n--- /dev/null\n+++ b/tests/queries/0_stateless/02292_nested_not_flattened_detach.reference\n@@ -0,0 +1,4 @@\n+CREATE TABLE default.t_nested_detach\\n(\\n    `n` Nested(u UInt32, s String)\\n)\\nENGINE = Log\n+n\tNested(u UInt32, s String)\t\t\t\t\t\n+CREATE TABLE default.t_nested_detach\\n(\\n    `n` Nested(u UInt32, s String)\\n)\\nENGINE = Log\n+n\tNested(u UInt32, s String)\t\t\t\t\t\ndiff --git a/tests/queries/0_stateless/02292_nested_not_flattened_detach.sql b/tests/queries/0_stateless/02292_nested_not_flattened_detach.sql\nnew file mode 100644\nindex 000000000000..083b4ff7e101\n--- /dev/null\n+++ b/tests/queries/0_stateless/02292_nested_not_flattened_detach.sql\n@@ -0,0 +1,17 @@\n+DROP TABLE IF EXISTS t_nested_detach;\n+\n+SET flatten_nested = 0;\n+CREATE TABLE t_nested_detach (n Nested(u UInt32, s String)) ENGINE = Log;\n+\n+SHOW CREATE TABLE t_nested_detach;\n+DESC TABLE t_nested_detach;\n+\n+SET flatten_nested = 1;\n+\n+DETACH TABLE t_nested_detach;\n+ATTACH TABLE t_nested_detach;\n+\n+SHOW CREATE TABLE t_nested_detach;\n+DESC TABLE t_nested_detach;\n+\n+DROP TABLE IF EXISTS t_nested_detach;\n",
  "problem_statement": "Nested field structure lost when restarting the server\n**Describe what's wrong**\r\n\r\nWe have a nested field in a table.\r\nThe table is created using SET flatten_nested = 0.\r\nWhen the server is restarted the field is no longer nested (only flattened arrays appear).\r\n\r\n**Does it reproduce on recent release?**\r\n\r\nversion 22.2.3.1\r\n\r\n**How to reproduce**\r\n\r\nCreate a table using:\r\n\r\n` \r\nSET flatten_nested = 0            \r\n` \r\n` \r\nCREATE TABLE test.test    \r\n    (     \r\n        id String,  \r\n       nested_field Nested (nf1 String, nf2 String)  \r\n    ) ENGINE = MergeTree ORDER BY id  \r\n`\r\n\r\nRecover the table structure using describe:\r\n`\r\ndescribe test.test\r\n`\r\n`\r\nname           type\r\nid             String\r\nnested_field   Nested(nf1 String, nf2 String) \r\n`\r\n\r\nRestart click-house server.\r\n\r\nRecover the table structure using describe:\r\n`\r\n name               type            \r\n id                 String                                                                                          \r\n nested_field.nf1   Array(String)                                                                                   \r\n nested_field.nf2   Array(String)                                                                                   \r\n`\r\n\r\n*Expected behavior**\r\n\r\nRecover the initial structure of the table not he flatenned one.\r\n\r\n\n",
  "hints_text": "may be @CurtizJ can take a look?",
  "created_at": "2022-04-29T14:55:04Z",
  "modified_files": [
    "src/Interpreters/InterpreterCreateQuery.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02292_nested_not_flattened_detach.reference",
    "b/tests/queries/0_stateless/02292_nested_not_flattened_detach.sql"
  ]
}