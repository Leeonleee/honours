{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 11578,
  "instance_id": "ClickHouse__ClickHouse-11578",
  "issue_numbers": [
    "10240"
  ],
  "base_commit": "ba92f96a74404bc02d5455943ee45c40c0907e7c",
  "patch": "diff --git a/src/Interpreters/Context.cpp b/src/Interpreters/Context.cpp\nindex cbf00836103a..7b636b84c689 100644\n--- a/src/Interpreters/Context.cpp\n+++ b/src/Interpreters/Context.cpp\n@@ -166,6 +166,8 @@ class NamedSessions\n         if (!session.unique())\n             throw Exception(\"Session is locked by a concurrent client.\", ErrorCodes::SESSION_IS_LOCKED);\n \n+        session->context.client_info = context.client_info;\n+\n         return session;\n     }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01194_http_query_id.reference b/tests/queries/0_stateless/01194_http_query_id.reference\nnew file mode 100644\nindex 000000000000..b8626c4cff28\n--- /dev/null\n+++ b/tests/queries/0_stateless/01194_http_query_id.reference\n@@ -0,0 +1,1 @@\n+4\ndiff --git a/tests/queries/0_stateless/01194_http_query_id.sh b/tests/queries/0_stateless/01194_http_query_id.sh\nnew file mode 100755\nindex 000000000000..381ae67f88f7\n--- /dev/null\n+++ b/tests/queries/0_stateless/01194_http_query_id.sh\n@@ -0,0 +1,16 @@\n+#!/usr/bin/env bash\n+\n+CURDIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+. $CURDIR/../shell_config.sh\n+\n+url=\"http://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT_HTTP}/?session_id=test_01194\"\n+rnd=$RANDOM\n+\n+${CLICKHOUSE_CURL} -sS \"$url&query=SELECT+$rnd,1\" > /dev/null\n+${CLICKHOUSE_CURL} -sS \"$url&query=SELECT+$rnd,2\" > /dev/null\n+${CLICKHOUSE_CURL} -sS \"$url\" --data \"SELECT $rnd,3\" > /dev/null\n+${CLICKHOUSE_CURL} -sS \"$url\" --data \"SELECT $rnd,4\" > /dev/null\n+\n+${CLICKHOUSE_CURL} -sS \"$url\" --data \"SYSTEM FLUSH LOGS\"\n+\n+${CLICKHOUSE_CURL} -sS \"$url&query=SELECT+count(DISTINCT+query_id)+FROM+system.query_log+WHERE+query+LIKE+'SELECT+$rnd%25'\"\n",
  "problem_statement": "All queries in http session have the same query_id\n\r\n**How to reproduce**\r\n* Which ClickHouse server version to use: `20.4`\r\n```\r\n$ ./clickhouse-test temporary_and_external_tables\r\nRunning 1 stateless tests.\r\n01098_temporary_and_external_tables:                                    [ OK ]\r\n```\r\nThen look at `query_id` in `system.query_log`:\r\n```\r\n:) select query_id from system.query_log where lower(query) like '%_temporary_and_external_tables%' and event_date=today()\r\n\r\n\u250c\u2500query_id\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 f03de1f8-7256-4661-8344-e29d49961d2f \u2502\r\n\u2502 f03de1f8-7256-4661-8344-e29d49961d2f \u2502\r\n\u2502 f03de1f8-7256-4661-8344-e29d49961d2f \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n\r\n:) select type, event_time, query_id, query from system.query_log where query_id='f03de1f8-7256-4661-8344-e29d49961d2f'\r\n\r\n\u250c\u2500type\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500event_time\u2500\u252c\u2500query_id\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500query\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 QueryStart           \u2502 2020-04-13 21:12:04 \u2502 f03de1f8-7256-4661-8344-e29d49961d2f \u2502 CREATE TEMPORARY TABLE tmp_table AS SELECT number AS n FROM numbers(42)                                                                                                                                                                      \u2502\r\n\u2502 QueryFinish          \u2502 2020-04-13 21:12:04 \u2502 f03de1f8-7256-4661-8344-e29d49961d2f \u2502 CREATE TEMPORARY TABLE tmp_table AS SELECT number AS n FROM numbers(42)                                                                                                                                                                      \u2502\r\n\u2502 QueryStart           \u2502 2020-04-13 21:12:04 \u2502 f03de1f8-7256-4661-8344-e29d49961d2f \u2502 SELECT '`' || database || '`.`' || name || '`' FROM system.tables WHERE database='_temporary_and_external_tables' AND create_table_query LIKE '%tmp_table%'                                                                                  \u2502\r\n\u2502 QueryFinish          \u2502 2020-04-13 21:12:04 \u2502 f03de1f8-7256-4661-8344-e29d49961d2f \u2502 SELECT '`' || database || '`.`' || name || '`' FROM system.tables WHERE database='_temporary_and_external_tables' AND create_table_query LIKE '%tmp_table%'                                                                                  \u2502\r\n\u2502 ExceptionBeforeStart \u2502 2020-04-13 21:12:04 \u2502 f03de1f8-7256-4661-8344-e29d49961d2f \u2502 SELECT * FROM `_temporary_and_external_tables`.`_tmp_686c1988-fc91-4c9a-a862-a9a1f4ecad36`                                                                                                                                                   \u2502\r\n\u2502 QueryStart           \u2502 2020-04-13 21:12:21 \u2502 f03de1f8-7256-4661-8344-e29d49961d2f \u2502 SELECT sum((number GLOBAL IN (SELECT number AS n FROM remote('127.0.0.2', numbers(5)) WHERE n GLOBAL IN (SELECT * FROM tmp_table) AND n GLOBAL NOT IN (SELECT * FROM file) )) AS res), sum(number*res) FROM remote('127.0.0.2', numbers(10)) \u2502\r\n\u2502 QueryFinish          \u2502 2020-04-13 21:12:21 \u2502 f03de1f8-7256-4661-8344-e29d49961d2f \u2502 SELECT sum((number GLOBAL IN (SELECT number AS n FROM remote('127.0.0.2', numbers(5)) WHERE n GLOBAL IN (SELECT * FROM tmp_table) AND n GLOBAL NOT IN (SELECT * FROM file) )) AS res), sum(number*res) FROM remote('127.0.0.2', numbers(10)) \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n```\r\n\r\n**Expected behavior**\r\nDifferent queries should have different `query_id`s\r\n\r\n\n",
  "hints_text": "",
  "created_at": "2020-06-10T14:32:05Z",
  "modified_files": [
    "src/Interpreters/Context.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01194_http_query_id.reference",
    "b/tests/queries/0_stateless/01194_http_query_id.sh"
  ]
}