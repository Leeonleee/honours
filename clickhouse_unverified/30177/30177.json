{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 30177,
  "instance_id": "ClickHouse__ClickHouse-30177",
  "issue_numbers": [
    "30175"
  ],
  "base_commit": "6c1da023f7e5db9b7a6a05596fb0b516c940410f",
  "patch": "diff --git a/src/Functions/initializeAggregation.cpp b/src/Functions/initializeAggregation.cpp\nindex e8bd136e704a..02db90bfc43e 100644\n--- a/src/Functions/initializeAggregation.cpp\n+++ b/src/Functions/initializeAggregation.cpp\n@@ -40,6 +40,7 @@ class FunctionInitializeAggregation : public IFunction, private WithContext\n     bool isSuitableForShortCircuitArgumentsExecution(const DataTypesWithConstInfo & /*arguments*/) const override { return true; }\n \n     bool useDefaultImplementationForConstants() const override { return true; }\n+    bool useDefaultImplementationForNulls() const override { return false; }\n     ColumnNumbers getArgumentsThatAreAlwaysConstant() const override { return {0}; }\n \n     DataTypePtr getReturnTypeImpl(const ColumnsWithTypeAndName & arguments) const override;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02097_initializeAggregationNullable.reference b/tests/queries/0_stateless/02097_initializeAggregationNullable.reference\nnew file mode 100644\nindex 000000000000..6d2e42f2ca6e\n--- /dev/null\n+++ b/tests/queries/0_stateless/02097_initializeAggregationNullable.reference\n@@ -0,0 +1,6 @@\n+1\n+AggregateFunction(uniqExact, Nullable(String))\n+1\n+AggregateFunction(uniqExact, Nullable(UInt8))\n+1\n+1\ndiff --git a/tests/queries/0_stateless/02097_initializeAggregationNullable.sql b/tests/queries/0_stateless/02097_initializeAggregationNullable.sql\nnew file mode 100644\nindex 000000000000..aa4e6d475791\n--- /dev/null\n+++ b/tests/queries/0_stateless/02097_initializeAggregationNullable.sql\n@@ -0,0 +1,8 @@\n+SELECT finalizeAggregation(initializeAggregation('uniqExactState', toNullable('foo')));\n+SELECT toTypeName(initializeAggregation('uniqExactState', toNullable('foo')));\n+\n+SELECT finalizeAggregation(initializeAggregation('uniqExactState', toNullable(123)));\n+SELECT toTypeName(initializeAggregation('uniqExactState', toNullable(123)));\n+\n+SELECT initializeAggregation('uniqExactState', toNullable('foo')) = arrayReduce('uniqExactState', [toNullable('foo')]);\n+SELECT initializeAggregation('uniqExactState', toNullable(123)) = arrayReduce('uniqExactState', [toNullable(123)]);\n",
  "problem_statement": "initializeAggregation doesn't work with nullable types\n**Describe what's wrong**\r\n\r\nIt's not possible to initialize aggregation function from nullable types.\r\n\r\n**Does it reproduce on recent release?**\r\n\r\nYes, \r\nClickHouse version 21.10\r\n\r\n```\r\nSELECT initializeAggregation('uniqExactState', toNullable(''))\r\n\r\n\r\n0 rows in set. Elapsed: 0.003 sec.\r\n\r\nReceived exception from server (version 21.10.1):\r\nCode: 43. DB::Exception: Received from localhost:9000. DB::Exception: Nested type AggregateFunction(uniqExact, String) cannot be inside Nullable type: While processing initializeAggregation('uniqExactState', toNullable('')). (ILLEGAL_TYPE_OF_ARGUMENT)\r\n\r\n\r\nSELECT initializeAggregation('uniqExactState', toNullable(1))\r\n\r\n\r\nReceived exception from server (version 21.10.1):\r\nCode: 43. DB::Exception: Received from localhost:9000. DB::Exception: Nested type AggregateFunction(uniqExact, UInt8) cannot be inside Nullable type: While processing initializeAggregation('uniqExactState', toNullable(1)). (ILLEGAL_TYPE_OF_ARGUMENT)\r\n```\r\n\r\n\r\n**Expected behavior**\r\n\r\nIt should be possible to initialize aggregation function from nullable types.\r\n\r\n\r\n**Additional context**\r\n\r\nWA\r\n\r\n```\r\nSELECT arrayReduce('uniqExactState', [toNullable('')])\r\n\r\nQuery id: 29fc6760-78be-4f28-be5f-f1bbe12f04fc\r\n\r\n\u250c\u2500arrayReduce('uniqExactState', array(toNullable('')))\u2500\u2510\r\n\u2502 \u0001\u00012\ufffd\ufffd\ufffdV\ufffd\ufffd\ufffd\u5d76\ufffd\ufffd\ufffd\u0011\ufffd                                                \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\n",
  "hints_text": "",
  "created_at": "2021-10-14T12:10:18Z",
  "modified_files": [
    "src/Functions/initializeAggregation.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02097_initializeAggregationNullable.reference",
    "b/tests/queries/0_stateless/02097_initializeAggregationNullable.sql"
  ]
}