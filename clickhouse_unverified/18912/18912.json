{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 18912,
  "instance_id": "ClickHouse__ClickHouse-18912",
  "issue_numbers": [
    "18911"
  ],
  "base_commit": "53d0c9fa7255aa1dc48991d19f4246ff71cc2fd7",
  "patch": "diff --git a/src/AggregateFunctions/AggregateFunctionGroupBitmapData.h b/src/AggregateFunctions/AggregateFunctionGroupBitmapData.h\nindex 5bca64095fa1..3acaa29de7ed 100644\n--- a/src/AggregateFunctions/AggregateFunctionGroupBitmapData.h\n+++ b/src/AggregateFunctions/AggregateFunctionGroupBitmapData.h\n@@ -168,7 +168,7 @@ class RoaringBitmapWithSmallSet : private boost::noncopyable\n         {\n             for (const auto & x : small)\n             {\n-                if (rb->contains(static_cast<Value>(x.getValue())))\n+                if (r1.rb->contains(static_cast<Value>(x.getValue())))\n                     buffer.push_back(x.getValue());\n             }\n \n@@ -264,7 +264,7 @@ class RoaringBitmapWithSmallSet : private boost::noncopyable\n         {\n             for (const auto & x : small)\n             {\n-                if (rb->contains(static_cast<Value>(x.getValue())))\n+                if (r1.rb->contains(static_cast<Value>(x.getValue())))\n                     ++ret;\n             }\n         }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/00829_bitmap_function.sql b/tests/queries/0_stateless/00829_bitmap_function.sql\nindex 1217fbefc71f..3ed2ae5530e4 100644\n--- a/tests/queries/0_stateless/00829_bitmap_function.sql\n+++ b/tests/queries/0_stateless/00829_bitmap_function.sql\n@@ -309,3 +309,39 @@ select bitmapMax(bitmapBuild([1,5,7,9]));\n select bitmapMax(bitmapBuild([\n     0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,\n     100,200,500]));\n+\n+\n+-- reproduce #18911\n+CREATE TABLE bitmap_test(pickup_date Date, city_id UInt32, uid UInt32)ENGINE = Memory;\n+INSERT INTO bitmap_test SELECT '2019-01-01', 1, number FROM numbers(1,50);\n+INSERT INTO bitmap_test SELECT '2019-01-02', 1, number FROM numbers(11,60);\n+INSERT INTO bitmap_test SELECT '2019-01-03', 2, number FROM numbers(1,10);\n+\n+SELECT\n+    bitmapCardinality(day_today) AS today_users,\n+    bitmapCardinality(day_before) AS before_users,\n+    bitmapOrCardinality(day_today, day_before) AS all_users,\n+    bitmapAndCardinality(day_today, day_before) AS old_users,\n+    bitmapAndnotCardinality(day_today, day_before) AS new_users,\n+    bitmapXorCardinality(day_today, day_before) AS diff_users\n+FROM\n+(\n+    SELECT\n+        city_id,\n+        groupBitmapState(uid) AS day_today\n+    FROM bitmap_test\n+    WHERE pickup_date = '2019-01-02'\n+    GROUP BY\n+        rand((rand((rand('') % nan) = NULL) % 7) % rand(NULL)),\n+        city_id\n+) AS js1\n+ALL LEFT JOIN\n+(\n+    SELECT\n+        city_id,\n+        groupBitmapState(uid) AS day_before\n+    FROM bitmap_test\n+    WHERE pickup_date = '2019-01-01'\n+    GROUP BY city_id\n+) AS js2 USING (city_id) FORMAT Null;\n+drop table bitmap_test;\n",
  "problem_statement": "nullptr dereference in Roaring Bitmap functions\n**Describe the bug**\r\nhttps://clickhouse-test-reports.s3.yandex.net/0/f7e7725b8e6ca51d020eb05a8e78628231a78b08/fuzzer/report.html#fail1\r\n\r\n**How to reproduce**\r\n\r\nIt is always reproducing after:\r\n\r\n```\r\nCREATE TABLE bitmap_test(pickup_date Date, city_id UInt32, uid UInt32)ENGINE = Memory;\r\nINSERT INTO bitmap_test SELECT '2019-01-01', 1, number FROM numbers(1,50);\r\nINSERT INTO bitmap_test SELECT '2019-01-02', 1, number FROM numbers(11,60);\r\nINSERT INTO bitmap_test SELECT '2019-01-03', 2, number FROM numbers(1,10);\r\n```\r\n\r\n```\r\nSELECT\r\n    bitmapCardinality(day_today) AS today_users,\r\n    bitmapCardinality(day_before) AS before_users,\r\n    bitmapOrCardinality(day_today, day_before) AS all_users,\r\n    bitmapAndCardinality(day_today, day_before) AS old_users,\r\n    bitmapAndnotCardinality(day_today, day_before) AS new_users,\r\n    bitmapXorCardinality(day_today, day_before) AS diff_users\r\nFROM \r\n(\r\n    SELECT\r\n        city_id,\r\n        groupBitmapState(uid) AS day_today\r\n    FROM bitmap_test\r\n    WHERE pickup_date = '2019-01-02'\r\n    GROUP BY\r\n        rand((rand((rand('') % nan) = NULL) % 7) % rand(NULL)),\r\n        city_id\r\n) AS js1\r\nALL LEFT JOIN \r\n(\r\n    SELECT\r\n        city_id,\r\n        groupBitmapState(uid) AS day_before\r\n    FROM bitmap_test\r\n    WHERE pickup_date = '2019-01-01'\r\n    GROUP BY city_id\r\n) AS js2 USING (city_id)\r\n```\r\n\r\n```\r\n2021.01.10 18:02:22.570561 [ 51 ] {} <Trace> BaseDaemon: Received signal 11\r\n2021.01.10 18:02:22.570919 [ 145 ] {} <Fatal> BaseDaemon: ########################################\r\n2021.01.10 18:02:22.571385 [ 145 ] {} <Fatal> BaseDaemon: (version 20.13.1.5638 (official build), build id: AE52A812C77CD51984B95C53DF4AD0BB3264C79A) (from thread 105) (query_id: ab7bcf40-5940-4247-895c-d1c387f828e4) Received signal Segmentation fault (11)\r\n2021.01.10 18:02:22.571677 [ 145 ] {} <Fatal> BaseDaemon: Address: NULL pointer. Access: read. Address not mapped to object.\r\n2021.01.10 18:02:22.571982 [ 145 ] {} <Fatal> BaseDaemon: Stack trace: 0x1f429bc4 0x1f410366 0x1291ed2b 0x13e0bf47 0x13e0e9de 0x13e0e990 0x13e0e5ee 0x13e0d4b5 0x13baa02e 0x13bb0353 0x13bb12f5 0x1ac02842 0x1ac01fb6 0x1c3cb119 0x1b9357e5 0x1c121e18 0x1c18895c 0x1c1888bf 0x1c18887d 0x1c18882d 0x1c1887fd 0x1c18795e 0x1198acd5 0x11989f65 0x1c18609d 0x1c186a69 0x1c18aca9 0x1c18ac0d\r\n2021.01.10 18:02:22.623897 [ 145 ] {} <Fatal> BaseDaemon: 4. ./obj-x86_64-linux-gnu/../contrib/croaring/include/roaring/roaring_array.h:79: ra_get_index @ 0x1f429bc4 in /workspace/clickhouse\r\n2021.01.10 18:02:22.676961 [ 145 ] {} <Fatal> BaseDaemon: 5. ./obj-x86_64-linux-gnu/../contrib/croaring/src/roaring.c:2656: roaring_bitmap_contains @ 0x1f410366 in /workspace/clickhouse\r\n2021.01.10 18:02:22.682454 [ 145 ] {} <Fatal> BaseDaemon: 6. ./obj-x86_64-linux-gnu/../contrib/croaring/cpp/roaring.hh:170: roaring::Roaring::contains(unsigned int) const @ 0x1291ed2b in /workspace/clickhouse\r\n2021.01.10 18:02:22.692876 [ 145 ] {} <Fatal> BaseDaemon: 7. ./obj-x86_64-linux-gnu/../src/AggregateFunctions/AggregateFunctionGroupBitmapData.h:267: _ZNK2DB25RoaringBitmapWithSmallSetIjLDu32EE18rb_and_cardinalityERKS1_ @ 0x13e0bf47 in /workspace/clickhouse\r\n2021.01.10 18:02:22.703332 [ 145 ] {} <Fatal> BaseDaemon: 8. ./obj-x86_64-linux-gnu/../src/AggregateFunctions/AggregateFunctionGroupBitmapData.h:286: _ZNK2DB25RoaringBitmapWithSmallSetIjLDu32EE17rb_or_cardinalityERKS1_ @ 0x13e0e9de in /workspace/clickhouse\r\n2021.01.10 18:02:22.713929 [ 145 ] {} <Fatal> BaseDaemon: 9. ./obj-x86_64-linux-gnu/../src/Functions/FunctionsBitmap.h:661: DB::BitmapOrCardinalityImpl<unsigned int>::apply(DB::AggregateFunctionGroupBitmapData<unsigned int> const&, DB::AggregateFunctionGroupBitmapData<unsigned int> const&) @ 0x13e0e990 in /workspace/clickhouse\r\n2021.01.10 18:02:22.724331 [ 145 ] {} <Fatal> BaseDaemon: 10. ./obj-x86_64-linux-gnu/../src/Functions/FunctionsBitmap.h:890: void DB::FunctionBitmapCardinality<DB::BitmapOrCardinalityImpl, DB::NameBitmapOrCardinality, unsigned long>::executeIntType<unsigned int>(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, unsigned long, DB::PODArray<unsigned long, 4096ul, Allocator<false, false>, 15ul, 16ul>&) const @ 0x13e0e5ee in /workspace/clickhouse\r\n2021.01.10 18:02:22.734778 [ 145 ] {} <Fatal> BaseDaemon: 11. ./obj-x86_64-linux-gnu/../src/Functions/FunctionsBitmap.h:848: DB::FunctionBitmapCardinality<DB::BitmapOrCardinalityImpl, DB::NameBitmapOrCardinality, unsigned long>::executeImpl(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const @ 0x13e0d4b5 in /workspace/clickhouse\r\n```\n",
  "hints_text": "@amosbird @sundy-li Could you please help coordinate with people who are responsible for these functions?\nSeems it's an easy task to find the bug, I'll look at it.",
  "created_at": "2021-01-11T02:06:25Z",
  "modified_files": [
    "src/AggregateFunctions/AggregateFunctionGroupBitmapData.h"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/00829_bitmap_function.sql"
  ]
}