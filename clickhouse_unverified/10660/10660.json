{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 10660,
  "instance_id": "ClickHouse__ClickHouse-10660",
  "issue_numbers": [
    "10566"
  ],
  "base_commit": "3a0b77132d4bb4ae1da8d59a7ddc1db0e5100a3a",
  "patch": "diff --git a/src/Processors/Merges/Algorithms/MergingSortedAlgorithm.cpp b/src/Processors/Merges/Algorithms/MergingSortedAlgorithm.cpp\nindex d06e3c1179a6..77e9a9b7285d 100644\n--- a/src/Processors/Merges/Algorithms/MergingSortedAlgorithm.cpp\n+++ b/src/Processors/Merges/Algorithms/MergingSortedAlgorithm.cpp\n@@ -174,7 +174,7 @@ IMergingAlgorithm::Status MergingSortedAlgorithm::insertFromChunk(size_t source_\n \n     if (limit && total_merged_rows_after_insertion > limit)\n     {\n-        num_rows = total_merged_rows_after_insertion - limit;\n+        num_rows -= total_merged_rows_after_insertion - limit;\n         merged_data.insertFromChunk(std::move(source_chunks[source_num]), num_rows);\n     }\n     else\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01268_mergine_sorted_limit.reference b/tests/queries/0_stateless/01268_mergine_sorted_limit.reference\nnew file mode 100644\nindex 000000000000..14ecec1ff1db\n--- /dev/null\n+++ b/tests/queries/0_stateless/01268_mergine_sorted_limit.reference\n@@ -0,0 +1,7 @@\n+1\t1\n+1\t2\n+1\t3\n+1\t1\n+1\t2\n+1\t3\n+1\t4\ndiff --git a/tests/queries/0_stateless/01268_mergine_sorted_limit.sql b/tests/queries/0_stateless/01268_mergine_sorted_limit.sql\nnew file mode 100644\nindex 000000000000..fbe047a3a77f\n--- /dev/null\n+++ b/tests/queries/0_stateless/01268_mergine_sorted_limit.sql\n@@ -0,0 +1,12 @@\n+DROP TABLE IF EXISTS tab;\n+\n+CREATE TABLE tab (x UInt32, y UInt32) ENGINE = MergeTree() ORDER BY x;\n+\n+INSERT INTO tab VALUES (1,1),(1,2),(1,3),(1,4),(1,5);\n+\n+INSERT INTO tab VALUES (2,6),(2,7),(2,8),(2,9),(2,0);\n+\n+SELECT * FROM tab ORDER BY x LIMIT 3;\n+SELECT * FROM tab ORDER BY x LIMIT 4;\n+\n+DROP TABLE IF EXISTS tab;\n",
  "problem_statement": "Query a table of  MergeTree,  the number of rows in the result is incorrect\nQuery a table of  MergeTree,  the number of rows in the result is incorrect\r\n\r\n**How to reproduce**\r\n```sql\r\nDROP TABLE IF EXISTS x;\r\n\r\nCREATE TABLE x (\r\n    `t` DateTime,\r\n    `v` UInt32\r\n)\r\nENGINE = MergeTree()\r\nPARTITION BY toYYYYMMDD(t)\r\nORDER BY t;\r\n\r\nINSERT INTO x VALUES (now(),1),(now(),2),(now(),3),(now(),4),(now(),5);\r\n\r\nINSERT INTO x VALUES (now(),6),(now(),7),(now(),8),(now(),9),(now(),0);\r\n\r\nSELECT * FROM x ORDER BY t LIMIT 3;\r\n```\r\n\r\nOutput:\r\n```\r\n2020-04-29 09:18:26\t6\r\n2020-04-29 09:18:26\t7\r\n```\r\nExpected result is 3 rows\r\nBut the result is two lines\r\n\r\nClickhouse version: 20.3.8.53\r\nOS: ubuntu 14.04 server\r\n**Number of CPU cores: 4**\n",
  "hints_text": "```\r\n20.4.1.3163\r\n\r\nSELECT * FROM x ORDER BY t LIMIT 4;\r\n\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500t\u2500\u252c\u2500v\u2500\u2510\r\n\u2502 2020-04-29 02:12:47 \u2502 1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2518\r\n\r\n1 rows in set. Elapsed: 0.001 sec.\r\n\r\n\r\nSET experimental_use_processors = 0\r\n\r\nSELECT * FROM x ORDER BY t LIMIT 4;\r\n\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500t\u2500\u252c\u2500v\u2500\u2510\r\n\u2502 2020-04-29 02:12:47 \u2502 1 \u2502\r\n\u2502 2020-04-29 02:12:47 \u2502 2 \u2502\r\n\u2502 2020-04-29 02:12:47 \u2502 3 \u2502\r\n\u2502 2020-04-29 02:12:47 \u2502 4 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2518\r\n```",
  "created_at": "2020-05-04T17:29:40Z",
  "modified_files": [
    "src/Processors/Merges/Algorithms/MergingSortedAlgorithm.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01268_mergine_sorted_limit.reference",
    "b/tests/queries/0_stateless/01268_mergine_sorted_limit.sql"
  ]
}