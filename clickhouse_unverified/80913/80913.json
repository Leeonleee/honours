{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 80913,
  "instance_id": "ClickHouse__ClickHouse-80913",
  "issue_numbers": [
    "74072"
  ],
  "base_commit": "e3fdf1d976f2875e8ccde120f069816ff40a0634",
  "patch": "diff --git a/src/Columns/IColumn.cpp b/src/Columns/IColumn.cpp\nindex 664be7eab70f..6b291f65a8a5 100644\n--- a/src/Columns/IColumn.cpp\n+++ b/src/Columns/IColumn.cpp\n@@ -379,7 +379,7 @@ bool IColumnHelper<Derived, Parent>::hasEqualValues() const\n     size_t num_rows = self.size();\n     for (size_t i = 1; i < num_rows; ++i)\n     {\n-        if (self.compareAt(i, 0, self, 0) != 0)\n+        if (self.compareAt(i, 0, self, 1) != 0)\n             return false;\n     }\n     return true;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03522_nullable_partition_key.reference b/tests/queries/0_stateless/03522_nullable_partition_key.reference\nnew file mode 100644\nindex 000000000000..19441250f22d\n--- /dev/null\n+++ b/tests/queries/0_stateless/03522_nullable_partition_key.reference\n@@ -0,0 +1,5 @@\n+1\t1_2_2_1\n+\\N\t2b16b490a87466b6a6d34fd9027f3c3d_1_1_1\n+1\t1_1_1_1\n+2\t2_2_2_1\n+\\N\t2b16b490a87466b6a6d34fd9027f3c3d_3_3_1\ndiff --git a/tests/queries/0_stateless/03522_nullable_partition_key.sql b/tests/queries/0_stateless/03522_nullable_partition_key.sql\nnew file mode 100644\nindex 000000000000..589a0642c38d\n--- /dev/null\n+++ b/tests/queries/0_stateless/03522_nullable_partition_key.sql\n@@ -0,0 +1,10 @@\n+CREATE TABLE t (c0 Nullable(Int)) ENGINE = MergeTree() ORDER BY (c0) PARTITION BY (c0) SETTINGS allow_nullable_key = 1;\n+\n+INSERT INTO TABLE t (c0) VALUES (NULL),(1);\n+OPTIMIZE TABLE t FINAL;\n+SELECT c0, _part FROM t ORDER BY ALL;\n+\n+CREATE TABLE taggr (c0 Nullable(Int)) ENGINE = AggregatingMergeTree() ORDER BY (c0) PARTITION BY (c0) SETTINGS allow_nullable_key = 1;\n+INSERT INTO TABLE taggr (c0) VALUES (1), (2);\n+INSERT INTO TABLE taggr (c0) VALUES (NULL), (1), (2);\n+SELECT c0, _part FROM taggr FINAL ORDER BY ALL;\n",
  "problem_statement": "Wrong result with AggregatingMergeTree\n**Describe the bug**\r\nThe Fiddle uses the same table metadata for 2 insert cases using a table with a Nullable key. When inserting with a NULL case, the value inserted on the previous block appears duplicated.\r\n\r\n**How to reproduce**\r\nRun Fiddle: https://fiddle.clickhouse.com/e957ebfd-0e54-4e96-b6db-e4c1ef06344a\r\n\n",
  "hints_text": "Insert with NULL value inserts data into different partition:\r\nhttps://fiddle.clickhouse.com/0f739b8b-4ba0-4561-8566-3363926784a5\nAn easier case with MergeTree: https://fiddle.clickhouse.com/a43a2433-6175-4a9b-bcee-5714d815917f",
  "created_at": "2025-05-27T16:01:59Z"
}