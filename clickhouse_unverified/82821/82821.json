{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 82821,
  "instance_id": "ClickHouse__ClickHouse-82821",
  "issue_numbers": [
    "81836"
  ],
  "base_commit": "21dea30924975bd44d5090a1f2ea5b2eafb0996c",
  "patch": "diff --git a/src/Storages/MergeTree/MergeTreeData.cpp b/src/Storages/MergeTree/MergeTreeData.cpp\nindex 9d251f308068..85fb4d0912b3 100644\n--- a/src/Storages/MergeTree/MergeTreeData.cpp\n+++ b/src/Storages/MergeTree/MergeTreeData.cpp\n@@ -1129,9 +1129,31 @@ void MergeTreeData::checkTTLExpressions(const StorageInMemoryMetadata & new_meta\n \n namespace\n {\n-template <typename TMustHaveDataType>\n+\n void checkSpecialColumn(const std::string_view column_meta_name, const AlterCommand & command)\n {\n+    if (command.type == AlterCommand::DROP_COLUMN)\n+    {\n+        throw Exception(\n+            ErrorCodes::ALTER_OF_COLUMN_IS_FORBIDDEN,\n+            \"Trying to ALTER DROP {} ({}) column\",\n+            column_meta_name,\n+            backQuoteIfNeed(command.column_name));\n+    }\n+    else if (command.type == AlterCommand::RENAME_COLUMN)\n+    {\n+        throw Exception(\n+            ErrorCodes::ALTER_OF_COLUMN_IS_FORBIDDEN,\n+            \"Trying to ALTER RENAME {} ({}) column\",\n+            column_meta_name,\n+            backQuoteIfNeed(command.column_name));\n+    }\n+};\n+\n+template <typename TMustHaveDataType>\n+void checkSpecialColumnWithDataType(const std::string_view column_meta_name, const AlterCommand & command)\n+{\n+    checkSpecialColumn(column_meta_name, command);\n     if (command.type == AlterCommand::MODIFY_COLUMN)\n     {\n         if (!command.data_type)\n@@ -1153,23 +1175,8 @@ void checkSpecialColumn(const std::string_view column_meta_name, const AlterComm\n                 TypeName<TMustHaveDataType>);\n         }\n     }\n-    else if (command.type == AlterCommand::DROP_COLUMN)\n-    {\n-        throw Exception(\n-            ErrorCodes::ALTER_OF_COLUMN_IS_FORBIDDEN,\n-            \"Trying to ALTER DROP {} ({}) column\",\n-            column_meta_name,\n-            backQuoteIfNeed(command.column_name));\n-    }\n-    else if (command.type == AlterCommand::RENAME_COLUMN)\n-    {\n-        throw Exception(\n-            ErrorCodes::ALTER_OF_COLUMN_IS_FORBIDDEN,\n-            \"Trying to ALTER RENAME {} ({}) column\",\n-            column_meta_name,\n-            backQuoteIfNeed(command.column_name));\n-    }\n };\n+\n }\n \n void MergeTreeData::checkStoragePolicy(const StoragePolicyPtr & new_storage_policy) const\n@@ -3899,24 +3906,19 @@ void MergeTreeData::checkAlterIsPossible(const AlterCommands & commands, Context\n                 /// No other checks required\n                 continue;\n             }\n-            if (command.type == AlterCommand::DROP_COLUMN)\n-            {\n-                throw Exception(ErrorCodes::ALTER_OF_COLUMN_IS_FORBIDDEN,\n-                    \"Trying to ALTER DROP version {} column\", backQuoteIfNeed(command.column_name));\n-            }\n-            if (command.type == AlterCommand::RENAME_COLUMN)\n-            {\n-                throw Exception(ErrorCodes::ALTER_OF_COLUMN_IS_FORBIDDEN,\n-                    \"Trying to ALTER RENAME version {} column\", backQuoteIfNeed(command.column_name));\n-            }\n+            checkSpecialColumn(\"version\", command);\n         }\n         else if (command.column_name == merging_params.is_deleted_column)\n         {\n-            checkSpecialColumn<DataTypeUInt8>(\"is_deleted\", command);\n+            checkSpecialColumnWithDataType<DataTypeUInt8>(\"is_deleted\", command);\n         }\n         else if (command.column_name == merging_params.sign_column)\n         {\n-            checkSpecialColumn<DataTypeUInt8>(\"sign\", command);\n+            checkSpecialColumnWithDataType<DataTypeUInt8>(\"sign\", command);\n+        }\n+        else if (merging_params.columns_to_sum.end() != std::find(merging_params.columns_to_sum.begin(), merging_params.columns_to_sum.end(), command.column_name))\n+        {\n+            checkSpecialColumn(\"columns to sum\", command);\n         }\n \n         if (command.type == AlterCommand::MODIFY_QUERY)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03551_no_alter_for_columns_to_sum.reference b/tests/queries/0_stateless/03551_no_alter_for_columns_to_sum.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/03551_no_alter_for_columns_to_sum.sql b/tests/queries/0_stateless/03551_no_alter_for_columns_to_sum.sql\nnew file mode 100644\nindex 000000000000..2dd61cf9c2d8\n--- /dev/null\n+++ b/tests/queries/0_stateless/03551_no_alter_for_columns_to_sum.sql\n@@ -0,0 +1,4 @@\n+DROP TABLE IF EXISTS t0;\n+CREATE TABLE t0 (c0 Int) ENGINE = SummingMergeTree((c0)) ORDER BY tuple();\n+ALTER TABLE t0 RENAME COLUMN c0 TO c1; -- { serverError ALTER_OF_COLUMN_IS_FORBIDDEN }\n+DROP TABLE t0;\n",
  "problem_statement": "Summing column not found after restart\n### Describe the bug\n\nEasy to reproduce. A SummingMergeTree column is not found after the server restart if it's renamed.\n\n### How to reproduce\n\nRun:\n\n```sql\nCREATE TABLE t0 (c0 Int) ENGINE = SummingMergeTree((c0)) ORDER BY tuple();\nALTER TABLE t0 RENAME COLUMN c0 TO c1;\n```\nThen, restart the server and connect the client again. The following error is shown on the client:\n\n```\nCannot load data for command line suggestions: Code: 722. \nDB::Exception: Received from localhost:9000. DB::Exception: Waited job failed: Code: 696.\nDB::Exception: Load job 'startup table default.t0' -> Code: 695.\nDB::Exception: Load job 'load table default.t0' failed: Code: 16. \nDB::Exception: Column c0 listed in columns to sum does not exist in table declaration.:\nCannot attach table `default`.`t0` from metadata file store/6ce/6cef1bcd-fffb-4f7e-a9dc-0ce3e0aa4e07/t0.sql from query ATTACH TABLE default.t0 UUID '75c19534-efa8-4e40-a4c3-f4eaf2079bc2' (`c1` Int32) ENGINE = SummingMergeTree(c0) ORDER BY tuple() SETTINGS index_granularity = 8192. (NO_SUCH_COLUMN_IN_TABLE),. (ASYNC_LOAD_WAIT_FAILED) (version 25.6.1.1\n```\nor run Fiddle: https://fiddle.clickhouse.com/b7841522-533b-4024-8b06-e31403f67c39\n\n### Error message and/or stacktrace\n\n_No response_\n",
  "hints_text": "Hi! I'd like to work on it",
  "created_at": "2025-06-29T04:40:14Z"
}