{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 53818,
  "instance_id": "ClickHouse__ClickHouse-53818",
  "issue_numbers": [
    "52207"
  ],
  "base_commit": "cb831a5fb7d50c71ba04e8233bcfffa6b7c2c21f",
  "patch": "diff --git a/docs/en/operations/configuration-files.md b/docs/en/operations/configuration-files.md\nindex a19c55673ed3..81a35ad1ea95 100644\n--- a/docs/en/operations/configuration-files.md\n+++ b/docs/en/operations/configuration-files.md\n@@ -65,7 +65,7 @@ XML substitution example:\n \n Substitutions can also be performed from ZooKeeper. To do this, specify the attribute `from_zk = \"/path/to/node\"`. The element value is replaced with the contents of the node at `/path/to/node` in ZooKeeper. You can also put an entire XML subtree on the ZooKeeper node and it will be fully inserted into the source element.\n \n-## Encrypting Configuration {#encryption}\n+## Encrypting and Hiding Configuration {#encryption}\n \n You can use symmetric encryption to encrypt a configuration element, for example, a password field. To do so, first configure the [encryption codec](../sql-reference/statements/create/table.md#encryption-codecs), then add attribute `encrypted_by` with the name of the encryption codec as value to the element to encrypt.\n \n@@ -102,6 +102,21 @@ Example:\n 961F000000040000000000EEDDEF4F453CFE6457C4234BD7C09258BD651D85\n ```\n \n+Even with applied encryption in the preprocessed file the elements are still saved in plain text. In case this is a problem, we suggest two alternatives: either set file permissions of the preprocessed file to 600 or use the `hide_in_preprocessed` attribute.\n+\n+Example:\n+\n+```xml\n+<clickhouse>\n+\n+    <interserver_http_credentials hide_in_preprocessed=\"true\">\n+        <user>admin</user>\n+        <password>secret</password>\n+    </interserver_http_credentials>\n+\n+</clickhouse>\n+```\n+\n ## User Settings {#user-settings}\n \n The `config.xml` file can specify a separate config with user settings, profiles, and quotas. The relative path to this config is set in the `users_config` element. By default, it is `users.xml`. If `users_config` is omitted, the user settings, profiles, and quotas are specified directly in `config.xml`.\ndiff --git a/docs/ru/operations/configuration-files.md b/docs/ru/operations/configuration-files.md\nindex 085761d80c71..3b037521692a 100644\n--- a/docs/ru/operations/configuration-files.md\n+++ b/docs/ru/operations/configuration-files.md\n@@ -85,7 +85,7 @@ $ cat /etc/clickhouse-server/users.d/alice.xml\n \n \u0421\u0435\u0440\u0432\u0435\u0440 \u0441\u043b\u0435\u0434\u0438\u0442 \u0437\u0430 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f\u043c\u0438 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u043e\u043d\u043d\u044b\u0445 \u0444\u0430\u0439\u043b\u043e\u0432, \u0430 \u0442\u0430\u043a\u0436\u0435 \u0444\u0430\u0439\u043b\u043e\u0432 \u0438 ZooKeeper-\u0443\u0437\u043b\u043e\u0432, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u0431\u044b\u043b\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u044b \u043f\u0440\u0438 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0438 \u043f\u043e\u0434\u0441\u0442\u0430\u043d\u043e\u0432\u043e\u043a \u0438 \u043f\u0435\u0440\u0435\u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0439, \u0438 \u043f\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u0442 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 \u0438 \u043a\u043b\u0430\u0441\u0442\u0435\u0440\u043e\u0432 \u043d\u0430 \u043b\u0435\u0442\u0443. \u0422\u043e \u0435\u0441\u0442\u044c, \u043c\u043e\u0436\u043d\u043e \u0438\u0437\u043c\u0435\u043d\u044f\u0442\u044c \u043a\u043b\u0430\u0441\u0442\u0435\u0440\u0430, \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 \u0438 \u0438\u0445 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0431\u0435\u0437 \u043f\u0435\u0440\u0435\u0437\u0430\u043f\u0443\u0441\u043a\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430.\n \n-## \u0428\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u0435 {#encryption}\n+## \u0428\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0438 \u0421\u043a\u0440\u044b\u0442\u0438\u0435 {#encryption}\n \n \u0412\u044b \u043c\u043e\u0436\u0435\u0442\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u0441\u0438\u043c\u043c\u0435\u0442\u0440\u0438\u0447\u043d\u043e\u0435 \u0448\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0434\u043b\u044f \u0437\u0430\u0448\u0438\u0444\u0440\u043e\u0432\u043a\u0438 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438, \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440, \u043f\u043e\u043b\u044f password. \u0427\u0442\u043e\u0431\u044b \u044d\u0442\u043e \u0441\u0434\u0435\u043b\u0430\u0442\u044c, \u0441\u043d\u0430\u0447\u0430\u043b\u0430 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u0442\u0435 [\u043a\u043e\u0434\u0435\u043a \u0448\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u044f](../sql-reference/statements/create/table.md#encryption-codecs), \u0437\u0430\u0442\u0435\u043c \u0434\u043e\u0431\u0430\u0432\u044c\u0442\u0435 \u0430\u0442\u0442\u0438\u0431\u0443\u0442`encrypted_by` \u0441 \u0438\u043c\u0435\u043d\u0435\u043c \u043a\u043e\u0434\u0435\u043a\u0430 \u0448\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u043a\u0430\u043a \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u043a \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0443, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u043d\u0430\u0434\u043e \u0437\u0430\u0448\u0438\u0444\u0440\u043e\u0432\u0430\u0442\u044c.\n \n@@ -122,6 +122,21 @@ $ cat /etc/clickhouse-server/users.d/alice.xml\n 961F000000040000000000EEDDEF4F453CFE6457C4234BD7C09258BD651D85\n ```\n \n+\u0414\u0430\u0436\u0435 \u0441 \u043f\u0440\u0438\u043c\u0435\u043d\u0451\u043d\u043d\u044b\u043c \u0448\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u0435\u043c \u0432 \u0444\u0430\u0439\u043b\u0435 \u043f\u0440\u0435\u0434\u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u044b \u0432\u0441\u0435 \u0440\u0430\u0432\u043d\u043e \u0441\u043e\u0445\u0440\u0430\u043d\u044f\u044e\u0442\u0441\u044f \u0432 \u043d\u0435\u0437\u0430\u0448\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u043d\u043e\u043c \u0432\u0438\u0434\u0435. \u0412 \u0441\u043b\u0443\u0447\u0430\u0435 \u0435\u0441\u043b\u0438 \u044d\u0442\u043e \u044f\u0432\u043b\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u043e\u0431\u043b\u0435\u043c\u043e\u0439, \u043c\u044b \u043f\u0440\u0435\u0434\u043b\u0430\u0433\u0430\u0435\u043c \u0434\u0432\u0435 \u0430\u043b\u044c\u0442\u0435\u0440\u043d\u0430\u0442\u0438\u0432\u044b: \u0438\u043b\u0438 \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u0440\u0430\u0437\u0440\u0435\u0448\u0435\u043d\u0438\u044f \u043d\u0430 \u0444\u0430\u0439\u043b \u043f\u0440\u0435\u0434\u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 600 \u0438\u043b\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u0430\u0442\u0442\u0440\u0438\u0431\u0443\u0442 `hide_in_preprocessed`.\n+\n+\u041f\u0440\u0438\u043c\u0435\u0440:\n+\n+```xml\n+<clickhouse>\n+\n+    <interserver_http_credentials hide_in_preprocessed=\"true\">\n+        <user>admin</user>\n+        <password>secret</password>\n+    </interserver_http_credentials>\n+\n+</clickhouse>\n+```\n+\n ## \u041f\u0440\u0438\u043c\u0435\u0440\u044b \u0437\u0430\u043f\u0438\u0441\u0438 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438 \u043d\u0430 YAML {#example}\n \n \u0417\u0434\u0435\u0441\u044c \u043c\u043e\u0436\u043d\u043e \u0440\u0430\u0441\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u043f\u0440\u0438\u043c\u0435\u0440 \u0440\u0435\u0430\u043b\u044c\u043d\u043e\u0439 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438 \u0437\u0430\u043f\u0438\u0441\u0430\u043d\u043d\u043e\u0439 \u043d\u0430 YAML: [config.yaml.example](https://github.com/ClickHouse/ClickHouse/blob/master/programs/server/config.yaml.example).\ndiff --git a/src/Common/Config/ConfigProcessor.cpp b/src/Common/Config/ConfigProcessor.cpp\nindex 04f55600b409..fe16313c0bf5 100644\n--- a/src/Common/Config/ConfigProcessor.cpp\n+++ b/src/Common/Config/ConfigProcessor.cpp\n@@ -15,6 +15,7 @@\n #include <Poco/DOM/Comment.h>\n #include <Poco/XML/XMLWriter.h>\n #include <Poco/Util/XMLConfiguration.h>\n+#include <Poco/NumberParser.h>\n #include <Common/ZooKeeper/ZooKeeperNodeCache.h>\n #include <Common/ZooKeeper/KeeperException.h>\n #include <Common/StringUtils/StringUtils.h>\n@@ -254,6 +255,25 @@ void ConfigProcessor::decryptRecursive(Poco::XML::Node * config_root)\n \n #endif\n \n+void ConfigProcessor::hideRecursive(Poco::XML::Node * config_root)\n+{\n+    for (Node * node = config_root->firstChild(); node;)\n+    {\n+        Node * next_node = node->nextSibling();\n+        if (node->nodeType() == Node::ELEMENT_NODE)\n+        {\n+            Element & element = dynamic_cast<Element &>(*node);\n+            if (element.hasAttribute(\"hide_in_preprocessed\") && Poco::NumberParser::parseBool(element.getAttribute(\"hide_in_preprocessed\")))\n+            {\n+                config_root->removeChild(node);\n+            } else\n+                hideRecursive(node);\n+        }\n+        node = next_node;\n+    }\n+}\n+\n+\n void ConfigProcessor::mergeRecursive(XMLDocumentPtr config, Node * config_root, const Node * with_root)\n {\n     const NodeListPtr with_nodes = with_root->childNodes();\n@@ -792,6 +812,24 @@ void ConfigProcessor::decryptEncryptedElements(LoadedConfig & loaded_config)\n \n #endif\n \n+XMLDocumentPtr ConfigProcessor::hideElements(XMLDocumentPtr xml_tree)\n+{\n+    /// Create a copy of XML Document because hiding elements from preprocessed_xml document\n+    /// also influences on configuration which has a pointer to preprocessed_xml document.\n+\n+    XMLDocumentPtr xml_tree_copy = new Poco::XML::Document;\n+\n+    for (Node * node = xml_tree->firstChild(); node; node = node->nextSibling())\n+    {\n+        NodePtr new_node = xml_tree_copy->importNode(node, true);\n+        xml_tree_copy->appendChild(new_node);\n+    }\n+    Node * new_config_root = getRootNode(xml_tree_copy.get());\n+    hideRecursive(new_config_root);\n+\n+    return xml_tree_copy;\n+}\n+\n void ConfigProcessor::savePreprocessedConfig(LoadedConfig & loaded_config, std::string preprocessed_dir)\n {\n     try\n@@ -840,7 +878,8 @@ void ConfigProcessor::savePreprocessedConfig(LoadedConfig & loaded_config, std::\n         writer.setNewLine(\"\\n\");\n         writer.setIndent(\"    \");\n         writer.setOptions(Poco::XML::XMLWriter::PRETTY_PRINT);\n-        writer.writeNode(preprocessed_path, loaded_config.preprocessed_xml);\n+        XMLDocumentPtr preprocessed_xml_without_hidden_elements = hideElements(loaded_config.preprocessed_xml);\n+        writer.writeNode(preprocessed_path, preprocessed_xml_without_hidden_elements);\n         LOG_DEBUG(log, \"Saved preprocessed configuration to '{}'.\", preprocessed_path);\n     }\n     catch (Poco::Exception & e)\ndiff --git a/src/Common/Config/ConfigProcessor.h b/src/Common/Config/ConfigProcessor.h\nindex b4f85b105265..98592d8846e4 100644\n--- a/src/Common/Config/ConfigProcessor.h\n+++ b/src/Common/Config/ConfigProcessor.h\n@@ -142,6 +142,9 @@ class ConfigProcessor\n     void decryptEncryptedElements(LoadedConfig & loaded_config);\n #endif\n \n+    void hideRecursive(Poco::XML::Node * config_root);\n+    XMLDocumentPtr hideElements(XMLDocumentPtr xml_tree);\n+\n     void mergeRecursive(XMLDocumentPtr config, Poco::XML::Node * config_root, const Poco::XML::Node * with_root);\n \n     /// If config root node name is not 'clickhouse' and merging config's root node names doesn't match, bypasses merging and returns false.\n",
  "test_patch": "diff --git a/tests/integration/test_config_hide_in_preprocessed/__init__.py b/tests/integration/test_config_hide_in_preprocessed/__init__.py\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/integration/test_config_hide_in_preprocessed/configs/config.xml b/tests/integration/test_config_hide_in_preprocessed/configs/config.xml\nnew file mode 100644\nindex 000000000000..aac5f5729644\n--- /dev/null\n+++ b/tests/integration/test_config_hide_in_preprocessed/configs/config.xml\n@@ -0,0 +1,12 @@\n+<clickhouse>\n+    <max_thread_pool_free_size hide_in_preprocessed=\"1\">2000</max_thread_pool_free_size>\n+    <max_table_size_to_drop hide_in_preprocessed=\"true\">60000000000</max_table_size_to_drop>\n+    <max_partition_size_to_drop hide_in_preprocessed=\"false\">40000000000</max_partition_size_to_drop>\n+    <named_collections hide_in_preprocessed=\"true\">\n+        <name>\n+            <key_1>value</key_1>\n+            <key_2>value_2</key_2>\n+            <url>https://connection.url/</url>\n+        </name>\n+    </named_collections>\n+</clickhouse>\ndiff --git a/tests/integration/test_config_hide_in_preprocessed/configs/users.xml b/tests/integration/test_config_hide_in_preprocessed/configs/users.xml\nnew file mode 100644\nindex 000000000000..7f196179f80e\n--- /dev/null\n+++ b/tests/integration/test_config_hide_in_preprocessed/configs/users.xml\n@@ -0,0 +1,7 @@\n+<clickhouse>\n+    <users>\n+        <default>\n+            <named_collection_control>1</named_collection_control>\n+        </default>\n+    </users>\n+</clickhouse>\ndiff --git a/tests/integration/test_config_hide_in_preprocessed/test.py b/tests/integration/test_config_hide_in_preprocessed/test.py\nnew file mode 100644\nindex 000000000000..fd237063b183\n--- /dev/null\n+++ b/tests/integration/test_config_hide_in_preprocessed/test.py\n@@ -0,0 +1,57 @@\n+import pytest\n+import os\n+from helpers.cluster import ClickHouseCluster\n+\n+\n+cluster = ClickHouseCluster(__file__)\n+node = cluster.add_instance(\n+    \"node\", main_configs=[\"configs/config.xml\"], user_configs=[\"configs/users.xml\"]\n+)\n+\n+\n+@pytest.fixture(scope=\"module\")\n+def started_cluster():\n+    try:\n+        cluster.start()\n+        yield cluster\n+\n+    finally:\n+        cluster.shutdown()\n+\n+\n+def test_hide_in_preprocessed(started_cluster):\n+    assert (\n+        node.query(\n+            \"select value from system.server_settings where name ='max_thread_pool_free_size'\"\n+        )\n+        == \"2000\\n\"\n+    )\n+    assert (\n+        node.query(\n+            \"select value from system.server_settings where name ='max_table_size_to_drop'\"\n+        )\n+        == \"60000000000\\n\"\n+    )\n+    assert (\n+        node.query(\n+            \"select value from system.server_settings where name ='max_partition_size_to_drop'\"\n+        )\n+        == \"40000000000\\n\"\n+    )\n+    assert \"key_1\" in node.query(\"select collection from system.named_collections\")\n+    out = node.exec_in_container(\n+        [\"cat\", \"/var/lib/clickhouse/preprocessed_configs/config.xml\"]\n+    )\n+    assert (\n+        '<max_thread_pool_free_size hide_in_preprocessed=\"1\">2000</max_thread_pool_free_size>'\n+        not in out\n+    )\n+    assert (\n+        '<max_table_size_to_drop hide_in_preprocessed=\"true\">60000000000</max_table_size_to_drop>'\n+        not in out\n+    )\n+    assert (\n+        '<max_partition_size_to_drop hide_in_preprocessed=\"false\">40000000000</max_partition_size_to_drop>'\n+        in out\n+    )\n+    assert '<named_collections hide_in_preprocessed=\"true\">' not in out\n",
  "problem_statement": "Preprocessed config file with hidden/in-memory parts\nhttps://github.com/ClickHouse/ClickHouse/issues/48291 and https://github.com/ClickHouse/ClickHouse/pull/50986 try to avoid plaintext passwords in configuration files. A second angle of attack is the preprocessed XML file which might contains sensitive data (fused from multiple XML/JSON files with varying access rights). We should check if parts of the configuration tree can be marked \"hidden\" such they are not written into the preprocessed XML file in the first place.\r\n\r\n(perhaps it is easier to avoid writing a preprocessed XML file altogether, i.e. rather do both steps of preprocessing and populating the server config from the preprocessed data entirely in-memory)\n",
  "hints_text": "Please assign me to this task.",
  "created_at": "2023-08-25T06:01:20Z",
  "modified_files": [
    "docs/en/operations/configuration-files.md",
    "docs/ru/operations/configuration-files.md",
    "src/Common/Config/ConfigProcessor.cpp",
    "src/Common/Config/ConfigProcessor.h"
  ],
  "modified_test_files": [
    "b/tests/integration/test_config_hide_in_preprocessed/configs/config.xml",
    "b/tests/integration/test_config_hide_in_preprocessed/configs/users.xml",
    "b/tests/integration/test_config_hide_in_preprocessed/test.py"
  ]
}