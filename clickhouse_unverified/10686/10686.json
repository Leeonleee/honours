{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 10686,
  "instance_id": "ClickHouse__ClickHouse-10686",
  "issue_numbers": [
    "10539"
  ],
  "base_commit": "28c122b0c5a3fb3a45c36bb7161d74c03a9c2070",
  "patch": "diff --git a/src/Interpreters/ExpressionAnalyzer.cpp b/src/Interpreters/ExpressionAnalyzer.cpp\nindex 0cbfb5c6ac51..4a94bc833688 100644\n--- a/src/Interpreters/ExpressionAnalyzer.cpp\n+++ b/src/Interpreters/ExpressionAnalyzer.cpp\n@@ -409,7 +409,7 @@ bool ExpressionAnalyzer::makeAggregateDescriptions(ExpressionActionsPtr & action\n \n         for (size_t i = 0; i < arguments.size(); ++i)\n         {\n-            getRootActions(arguments[i], true, actions);\n+            getRootActionsNoMakeSet(arguments[i], true, actions);\n             const std::string & name = arguments[i]->getColumnName();\n             types[i] = actions->getSampleBlock().getByName(name).type;\n             aggregate.argument_names[i] = name;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01136_multiple_sets.reference b/tests/queries/0_stateless/01136_multiple_sets.reference\nnew file mode 100644\nindex 000000000000..7ac20ecffd35\n--- /dev/null\n+++ b/tests/queries/0_stateless/01136_multiple_sets.reference\n@@ -0,0 +1,5 @@\n+2\n+2\n+2\n+1\n+1\ndiff --git a/tests/queries/0_stateless/01136_multiple_sets.sql b/tests/queries/0_stateless/01136_multiple_sets.sql\nnew file mode 100644\nindex 000000000000..bd8651495513\n--- /dev/null\n+++ b/tests/queries/0_stateless/01136_multiple_sets.sql\n@@ -0,0 +1,12 @@\n+drop table if exists test;\n+\n+create table test (project LowCardinality(String)) engine=MergeTree() order by project;\n+insert into test values ('val1'), ('val2'), ('val3');\n+\n+select sum(project in ('val1', 'val2')) from test;\n+set force_primary_key = 1;\n+select sum(project in ('val1', 'val2')) from test where project in ('val1', 'val2');\n+select count() from test where project in ('val1', 'val2');\n+select project in ('val1', 'val2') from test where project in ('val1', 'val2');\n+\n+drop table test;\n",
  "problem_statement": "Exception when using IN expression with LowCardinality column from MT index\n**How to reproduce**\r\n```\r\n:) create table test (project LowCardinality(String)) engine=MergeTree() order by project\r\n:) insert into test values ('val1'), ('val2'), ('val3')\r\n:) select sum(project in ('val1', 'val2')) from test where project in ('val1', 'val2')\r\nCode: 169. DB::Exception: Received from localhost:9000. DB::Exception: Key expression contains comparison between inconvertible types: LowCardinality(String) and UInt8 inside project IN ('val1', 'val2').\r\n```\r\nIt happens when expression like `project in ('val1', 'val2')` occur multiple times in query.\r\n\r\nWas introduced between 20.3.5 and 20.3.8.\r\n\r\n\r\n**Workaround**\r\nReplace `project in ('val1', 'val2')` with `(select arrayJoin(['val1', 'val2']))`:\r\n```\r\n:) select sum(project in (select arrayJoin(['val1', 'val2']))) from test where project in (select arrayJoin(['val1', 'val2']))\r\n\u250c\u2500sum(in(project, _subquery3))\u2500\u2510\r\n\u2502                            2 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\n",
  "hints_text": "it's critical bug for us. we can't update clickhouse for new version(\nIn older verison this bug leads to non-usage of primary key.\r\n\r\n```\r\nselect version()\r\n\r\n\u250c\u2500version()\u2500\u2510\r\n\u2502 19.17.3.7 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\nset force_primary_key = 1;\r\nselect sum(project in ('val1', 'val2')) from test where project in ('val1', 'val2')\r\n\r\nReceived exception from server (version 20.5.1):\r\nCode: 277. DB::Exception: Received from localhost:9000. DB::Exception: Primary key (project) is not used and setting 'force_primary_key' is set..\n@orloffv Could you please share your use case (queries)? Maybe it is slightly different than the original.\n@alexey-milovidov https://nda.ya.ru/t/69aO58Sa3VxkoF ",
  "created_at": "2020-05-06T01:01:50Z"
}