{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 6676,
  "instance_id": "ClickHouse__ClickHouse-6676",
  "issue_numbers": [
    "6381"
  ],
  "base_commit": "a98b91c521b1ee2c5c826df98cb10fdbfc4f2424",
  "patch": "diff --git a/dbms/src/Storages/transformQueryForExternalDatabase.cpp b/dbms/src/Storages/transformQueryForExternalDatabase.cpp\nindex 55a0ef95200c..b6e48836efa3 100644\n--- a/dbms/src/Storages/transformQueryForExternalDatabase.cpp\n+++ b/dbms/src/Storages/transformQueryForExternalDatabase.cpp\n@@ -141,19 +141,17 @@ String transformQueryForExternalDatabase(\n             if (function->name == \"and\")\n             {\n                 bool compatible_found = false;\n-                auto new_function_and = std::make_shared<ASTFunction>();\n-                auto new_function_and_arguments = std::make_shared<ASTExpressionList>();\n-                new_function_and->arguments = new_function_and_arguments;\n-                new_function_and->children.push_back(new_function_and_arguments);\n-\n+                auto new_function_and = makeASTFunction(\"and\");\n                 for (const auto & elem : function->arguments->children)\n                 {\n                     if (isCompatible(*elem))\n                     {\n-                        new_function_and_arguments->children.push_back(elem);\n+                        new_function_and->arguments->children.push_back(elem);\n                         compatible_found = true;\n                     }\n                 }\n+                if (new_function_and->arguments->children.size() == 1)\n+                    new_function_and->name = \"\";\n \n                 if (compatible_found)\n                     select->setExpression(ASTSelectQuery::Expression::WHERE, std::move(new_function_and));\n",
  "test_patch": "diff --git a/dbms/src/Storages/tests/gtest_transform_query_for_external_database.cpp b/dbms/src/Storages/tests/gtest_transform_query_for_external_database.cpp\nindex e61ab6279a2f..67cd21b3cfbc 100644\n--- a/dbms/src/Storages/tests/gtest_transform_query_for_external_database.cpp\n+++ b/dbms/src/Storages/tests/gtest_transform_query_for_external_database.cpp\n@@ -76,3 +76,14 @@ TEST(TransformQueryForExternalDatabase, Substring)\n           \"SELECT \\\"column\\\" FROM \\\"test\\\".\\\"table\\\"\",\n           state().context, state().columns);\n }\n+\n+TEST(TransformQueryForExternalDatabase, MultipleAndSubqueries)\n+{\n+    check(\"SELECT column FROM test.table WHERE 1 = 1 AND toString(column) = '42' AND column = 42 AND left(column, 10) = RIGHT(column, 10) AND column IN (1, 42) AND SUBSTRING(column FROM 1 FOR 2) = 'Hello' AND column != 4\",\n+          \"SELECT \\\"column\\\" FROM \\\"test\\\".\\\"table\\\" WHERE 1 AND (\\\"column\\\" = 42) AND (\\\"column\\\" IN (1, 42)) AND (\\\"column\\\" != 4)\",\n+          state().context, state().columns);\n+    check(\"SELECT column FROM test.table WHERE toString(column) = '42' AND left(column, 10) = RIGHT(column, 10) AND column = 42\",\n+          \"SELECT \\\"column\\\" FROM \\\"test\\\".\\\"table\\\" WHERE (\\\"column\\\" = 42)\",\n+          state().context, state().columns);\n+\n+}\n",
  "problem_statement": "left/right/substring from mysql table reports error\n**Describe the bug**\r\nCould not use `left` or `right` or `substring` when selecting data from mysql directly\r\n\r\n**How to reproduce**\r\n* Version: 19.11.2\r\n* SQL that could run with error\r\n```SQL\r\n-- Exception msg for below sql : \r\n-- Code: 1000. DB::Exception: Received from clickhouse-server:9000. DB::Exception: mysqlxx::BadQuery: Operand should contain 1 column(s)\r\nselect \r\n            `id`\r\nfrom mysql('host:port', 'database', 'tablename', 'username', 'password')\r\nwhere 1=1 and left(stat_datetime, 10)='2019-08-07'  and advertiser_id = '12345'\r\n```\r\n* SQL that runs OK\r\n```SQL\r\nselect \r\n\t`id`\r\nfrom mysql('host:port', 'database', 'tablename', 'username', 'password')\r\nwhere 1=1 and advertiser_id = '12345'\r\n```\r\n\r\n\r\n**Expected behavior**\r\nBoth SQL should run OK\n",
  "hints_text": "@dimarub2000 Please try to reproduce this issue.\nReproduced the issue, trying to find the problem.\r\nwhen `select * from mysql('localhost:3306', 'test', 'kek', 'dsrub', 'kek') where id=123 and 1=1;`\r\nmysql gets ```SELECT `s`, `id` FROM `test`.`kek` WHERE (`id` = 123) AND (1 = 1)```\r\n\r\nwhen `select * from mysql('localhost:3306', 'test', 'kek', 'dsrub', 'kek') where left(s, 2) = 'ke'`\r\nmysql gets ```SELECT `s`, `id` FROM `test`.`kek` ```\r\n\r\nwhen `select * from mysql('localhost:3306', 'test', 'kek', 'dsrub', 'kek') where left(s, 2) = 'ke' and id=123 and 1=1;`\r\nmysql gets ```SELECT `s`, `id` FROM `test`.`kek` WHERE (`id` = 123, 1 = 1)```\r\n\r\nwhy substring() function is not sent to mysql but is processed localy?",
  "created_at": "2019-08-26T19:21:51Z"
}