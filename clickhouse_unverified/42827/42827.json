{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 42827,
  "instance_id": "ClickHouse__ClickHouse-42827",
  "issue_numbers": [
    "42452"
  ],
  "base_commit": "8ecc81d56879cb257875324972db7bd445b64a64",
  "patch": "diff --git a/src/Interpreters/ConvertFunctionOrLikeVisitor.cpp b/src/Interpreters/ConvertFunctionOrLikeVisitor.cpp\nindex 257bbda68eb7..5d48391d56d7 100644\n--- a/src/Interpreters/ConvertFunctionOrLikeVisitor.cpp\n+++ b/src/Interpreters/ConvertFunctionOrLikeVisitor.cpp\n@@ -15,7 +15,7 @@ void ConvertFunctionOrLikeData::visit(ASTFunction & function, ASTPtr &)\n     if (function.name != \"or\")\n         return;\n \n-    std::unordered_map<ASTPtr, std::shared_ptr<ASTLiteral>> identifier_to_literals;\n+    std::unordered_map<String, std::shared_ptr<ASTLiteral>> identifier_to_literals;\n     for (auto & child : function.children)\n     {\n         if (auto * expr_list_fn = child->as<ASTExpressionList>())\n@@ -51,10 +51,11 @@ void ConvertFunctionOrLikeData::visit(ASTFunction & function, ASTPtr &)\n                         regexp = \"(?i)\" + regexp;\n \n                     unique_elems.pop_back();\n-                    auto it = identifier_to_literals.find(identifier);\n+                    auto it = identifier_to_literals.find(identifier->getAliasOrColumnName());\n+\n                     if (it == identifier_to_literals.end())\n                     {\n-                        it = identifier_to_literals.insert({identifier, std::make_shared<ASTLiteral>(Field{Array{}})}).first;\n+                        it = identifier_to_literals.insert({identifier->getAliasOrColumnName(), std::make_shared<ASTLiteral>(Field{Array{}})}).first;\n                         auto match = makeASTFunction(\"multiMatchAny\");\n                         match->arguments->children.push_back(arguments[0]);\n                         match->arguments->children.push_back(it->second);\ndiff --git a/src/Interpreters/QueryNormalizer.cpp b/src/Interpreters/QueryNormalizer.cpp\nindex 2a8b256c3d1b..6a128d37e5d7 100644\n--- a/src/Interpreters/QueryNormalizer.cpp\n+++ b/src/Interpreters/QueryNormalizer.cpp\n@@ -113,12 +113,20 @@ void QueryNormalizer::visit(ASTIdentifier & node, ASTPtr & ast, Data & data)\n             if (!is_cycle)\n             {\n                 /// In a construct like \"a AS b\", where a is an alias, you must set alias b to the result of substituting alias a.\n+                /// Check size of the alias before cloning too large alias AST\n+                alias_node->checkSize(data.settings.max_expanded_ast_elements);\n                 ast = alias_node->clone();\n                 ast->setAlias(node_alias);\n             }\n         }\n         else\n-            ast = alias_node;\n+        {\n+            /// Check size of the alias before cloning too large alias AST\n+            alias_node->checkSize(data.settings.max_expanded_ast_elements);\n+            auto alias_name = ast->getAliasOrColumnName();\n+            ast = alias_node->clone();\n+            ast->setAlias(alias_name);\n+        }\n     }\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02475_or_function_alias_and_const_where.reference b/tests/queries/0_stateless/02475_or_function_alias_and_const_where.reference\nnew file mode 100644\nindex 000000000000..b5d8e605a7d4\n--- /dev/null\n+++ b/tests/queries/0_stateless/02475_or_function_alias_and_const_where.reference\n@@ -0,0 +1,2 @@\n+0\t0\n+0\t0\ndiff --git a/tests/queries/0_stateless/02475_or_function_alias_and_const_where.sql b/tests/queries/0_stateless/02475_or_function_alias_and_const_where.sql\nnew file mode 100644\nindex 000000000000..ddb0f70c6de6\n--- /dev/null\n+++ b/tests/queries/0_stateless/02475_or_function_alias_and_const_where.sql\n@@ -0,0 +1,2 @@\n+SELECT (number = 1) AND (number = 2) AS value, sum(value) OVER () FROM numbers(1) WHERE 1;\n+SELECT (number = 1) AND (number = 2) AS value, sum(value) OVER () FROM numbers(1) WHERE 1 SETTINGS allow_experimental_analyzer=1;\n\\ No newline at end of file\n",
  "problem_statement": "Logical error: 'LogicalExpressionsOptimizer: parent node information is corrupted'\n**Describe the bug**\r\n[A link to the report\r\n](https://s3.amazonaws.com/clickhouse-test-reports/0/8af95a6fc2cff71db3407c5da987f6e7565f7148/fuzzer_astfuzzerasan//report.html)\r\n**How to reproduce**\r\n```sql\r\nSELECT time, round(exp_smooth, 10), bar(exp_smooth, -9223372036854775807, 1048575, 50) AS bar FROM (SELECT 2 OR (number = 0) OR (number >= 1) AS value, number AS time, exponentialTimeDecayedSum(2147483646)(value, time) OVER (RANGE BETWEEN CURRENT ROW AND CURRENT ROW) AS exp_smooth FROM numbers(2147483647) WHERE 10) WHERE 25\r\n```\r\n\r\n```\r\n2022.10.18 17:15:14.590592 [ 197608 ] {d41426f1-7c52-43ce-b387-ea0eb39100ea} <Fatal> : Logical error: 'LogicalExpressionsOptimizer: parent node information is corrupted'.\r\n2022.10.18 17:15:14.591017 [ 197606 ] {} <Trace> BaseDaemon: Received signal 6\r\n2022.10.18 17:15:14.591676 [ 197931 ] {} <Fatal> BaseDaemon: ########################################\r\n2022.10.18 17:15:14.591948 [ 197931 ] {} <Fatal> BaseDaemon: (version 22.10.1.1 (official build), build id: AD76F1D00331FF83B84FF51C30F41B5C5FC116B2) (from thread 197608) (query_id: d41426f1-7c52-43ce-b387-ea0eb39100ea) (query: SELECT time, round(exp_smooth, 10), bar(exp_smooth, -9223372036854775807, 1048575, 50) AS bar FROM (SELECT 2 OR (number = 0) OR (number >= 1) AS value, number AS time, exponentialTimeDecayedSum(2147483646)(value, time) OVER (RANGE BETWEEN CURRENT ROW AND CURRENT ROW) AS exp_smooth FROM numbers(2147483647) WHERE 10) WHERE 25) Received signal Aborted (6)\r\n2022.10.18 17:15:14.592063 [ 197931 ] {} <Fatal> BaseDaemon:\r\n2022.10.18 17:15:14.592207 [ 197931 ] {} <Fatal> BaseDaemon: Stack trace: 0x7f199d53803b 0x7f199d517859 0x1ead443b 0x1ead497b 0x30588a8d 0x30586616 0x3049bfa0 0x2fd7a180 0x2fd71e5e 0x2fd6b70b 0x2fe492d6 0x2fe4533d 0x2fe4b772 0x306bc90f 0x2fee6bec 0x2fd6d3cf 0x2fd6b70b 0x2fe492d6 0x2fe4533d 0x2fcd2948 0x2fccff3b 0x3067b805 0x30674d20 0x329b5ba4 0x329e7563 0x3a2d366f 0x3a2d43f3 0x3a7a98dc 0x3a7a31c8 0x7f199d6ef609 0x7f199d614163\r\n2022.10.18 17:15:14.592356 [ 197931 ] {} <Fatal> BaseDaemon: 3. raise @ 0x7f199d53803b in ?\r\n2022.10.18 17:15:14.592468 [ 197931 ] {} <Fatal> BaseDaemon: 4. abort @ 0x7f199d517859 in ?\r\n2022.10.18 17:15:14.693446 [ 197931 ] {} <Fatal> BaseDaemon: 5. ./build_docker/../src/Common/Exception.cpp:40: DB::abortOnFailedAssertion(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0x1ead443b in /usr/bin/clickhouse\r\n2022.10.18 17:15:14.792436 [ 197931 ] {} <Fatal> BaseDaemon: 6.1. inlined from ./build_docker/../src/Common/Exception.cpp:63: DB::handle_error_code(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int, bool, std::__1::vector<void*, std::__1::allocator<void*> > const&)\r\n2022.10.18 17:15:14.792603 [ 197931 ] {} <Fatal> BaseDaemon: 6. ./build_docker/../src/Common/Exception.cpp:70: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int, bool) @ 0x1ead497b in /usr/bin/clickhouse\r\n2022.10.18 17:15:14.879039 [ 197931 ] {} <Fatal> BaseDaemon: 7. ./build_docker/../src/Interpreters/LogicalExpressionsOptimizer.cpp:154: DB::LogicalExpressionsOptimizer::collectDisjunctiveEqualityChains() @ 0x30588a8d in /usr/bin/clickhouse\r\n2022.10.18 17:15:14.960704 [ 197931 ] {} <Fatal> BaseDaemon: 8. ./build_docker/../src/Interpreters/LogicalExpressionsOptimizer.cpp:63: DB::LogicalExpressionsOptimizer::perform() @ 0x30586616 in /usr/bin/clickhouse\r\n2022.10.18 17:15:15.000216 [ 197836 ] {} <Trace> AsynchronousMetrics: MemoryTracking: was 1.67 GiB, peak 1.67 GiB, will set to 1.80 GiB (RSS), difference: 140.41 MiB\r\n2022.10.18 17:15:15.204321 [ 197931 ] {} <Fatal> BaseDaemon: 9. ./build_docker/../src/Interpreters/TreeRewriter.cpp:0: DB::TreeRewriter::analyzeSelect(std::__1::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::__1::vector<DB::TableWithColumnNamesAndTypes, std::__1::allocator<DB::TableWithColumnNamesAndTypes> > const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::TableJoin>) const @ 0x3049bfa0 in /usr/bin/clickhouse\r\n2022.10.18 17:15:15.654206 [ 197931 ] {} <Fatal> BaseDaemon: 10. ./build_docker/../src/Interpreters/InterpreterSelectQuery.cpp:505: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::__1::shared_ptr<DB::PreparedSets>)::$_1::operator()(bool) const @ 0x2fd7a180 in /usr/bin/clickhouse\r\n2022.10.18 17:15:16.000214 [ 197836 ] {} <Trace> AsynchronousMetrics: MemoryTracking: was 1.80 GiB, peak 1.80 GiB, will set to 1.87 GiB (RSS), difference: 70.72 MiB\r\n2022.10.18 17:15:16.078066 [ 197931 ] {} <Fatal> BaseDaemon: 11. ./build_docker/../src/Interpreters/InterpreterSelectQuery.cpp:0: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::__1::shared_ptr<DB::PreparedSets>) @ 0x2fd71e5e in /usr/bin/clickhouse\r\n2022.10.18 17:15:16.510060 [ 197931 ] {} <Fatal> BaseDaemon: 12. ./build_docker/../src/Interpreters/InterpreterSelectQuery.cpp:192: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0x2fd6b70b in /usr/bin/clickhouse\r\n2022.10.18 17:15:16.644165 [ 197931 ] {} <Fatal> BaseDaemon: 13. ./build_docker/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:247: DB::InterpreterSelectWithUnionQuery::buildCurrentChildInterpreter(std::__1::shared_ptr<DB::IAST> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0x2fe492d6 in /usr/bin/clickhouse\r\n^C2022.10.18 17:15:16.730987 [ 197606 ] {} <Trace> BaseDaemon: Received signal 2\r\n2022.10.18 17:15:16.731054 [ 197606 ] {} <Information> Application: Received termination signal (Interrupt)\r\n2022.10.18 17:15:16.731106 [ 197605 ] {} <Debug> Application: Received termination signal.\r\n2022.10.18 17:15:16.731155 [ 197605 ] {} <Debug> Application: Waiting for current connections to close.\r\n2022.10.18 17:15:16.762459 [ 197931 ] {} <Fatal> BaseDaemon: 14. ./build_docker/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:0: DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context>, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0x2fe4533d in /usr/bin/clickhouse\r\n```\n",
  "hints_text": "```\r\nSELECT (number = 1) OR (number = 2) AS value, sum(value) OVER () FROM numbers(1) WHERE 1\r\n```",
  "created_at": "2022-10-31T12:55:27Z"
}