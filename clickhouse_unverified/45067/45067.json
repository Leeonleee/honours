{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 45067,
  "instance_id": "ClickHouse__ClickHouse-45067",
  "issue_numbers": [
    "45038"
  ],
  "base_commit": "bb8cb829f9a2f51bb8044748b878f718e54aa763",
  "patch": "diff --git a/src/DataTypes/Native.h b/src/DataTypes/Native.h\nindex 9782c5d64e9b..8f4a2abcff7f 100644\n--- a/src/DataTypes/Native.h\n+++ b/src/DataTypes/Native.h\n@@ -138,7 +138,7 @@ static inline llvm::Value * nativeBoolCast(llvm::IRBuilder<> & b, const DataType\n     if (value->getType()->isIntegerTy())\n         return b.CreateICmpNE(value, zero);\n     if (value->getType()->isFloatingPointTy())\n-        return b.CreateFCmpONE(value, zero); /// QNaN is false\n+        return b.CreateFCmpUNE(value, zero);\n \n     throw Exception(ErrorCodes::NOT_IMPLEMENTED, \"Cannot cast non-number {} to bool\", from_type->getName());\n }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02525_jit_logical_functions_nan.reference b/tests/queries/0_stateless/02525_jit_logical_functions_nan.reference\nnew file mode 100644\nindex 000000000000..98fb6a686563\n--- /dev/null\n+++ b/tests/queries/0_stateless/02525_jit_logical_functions_nan.reference\n@@ -0,0 +1,4 @@\n+1\n+1\n+1\n+1\ndiff --git a/tests/queries/0_stateless/02525_jit_logical_functions_nan.sql b/tests/queries/0_stateless/02525_jit_logical_functions_nan.sql\nnew file mode 100644\nindex 000000000000..6b4770c76eae\n--- /dev/null\n+++ b/tests/queries/0_stateless/02525_jit_logical_functions_nan.sql\n@@ -0,0 +1,9 @@\n+SET min_count_to_compile_expression = 0;\n+\n+SELECT NOT NOT cos(MAX(pow(1523598955, 763027371))) FROM numbers(1) SETTINGS compile_expressions = 0;\n+\n+SELECT NOT NOT cos(MAX(pow(1523598955, 763027371))) FROM numbers(1) SETTINGS compile_expressions = 1;\n+\n+SELECT not(not(materialize(nan))) FROM numbers(1) SETTINGS compile_expressions = 0;\n+\n+SELECT not(not(materialize(nan))) FROM numbers(1) SETTINGS compile_expressions = 1;\n",
  "problem_statement": "NOT cos(MAX(pow(1523598955, 763027371))) is not TRUE, FALSE or NULL.\nhttps://s3.amazonaws.com/clickhouse-test-reports/0/0eaf05a2dd246fc6fee4e58ba78d3e9f51dac40c/sqlancer__release_/TLPHaving.err\r\n\r\n```\r\nDROP DATABASE IF EXISTS database0TLPHaving;\r\nCREATE DATABASE IF NOT EXISTS database0TLPHaving;\r\nUSE database0TLPHaving;\r\nCREATE TABLE database0TLPHaving.t0 (c0 String) ENGINE = Log() ;\r\nINSERT INTO t0(c0) VALUES ('-169109851');\r\nINSERT INTO t0(c0) VALUES ('+A');\r\nINSERT INTO t0(c0) VALUES ('-251131989'), ('Kn5c2^mLK'), ('r?IB[mf!_');\r\n```\r\n\r\nHas the result\r\n```\r\nSELECT\r\n    MAX(sin((410823204 + 1893374210) != -(-1976649740))),\r\n    1102699011,\r\n    ('-111708376' != '') + (1969336991 <= -1611144300)\r\nFROM t0 AS t0\r\nGROUP BY\r\n    -251131989,\r\n    -1154587996\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\n\u250c\u2500MAXOrNull(sin(notEquals(plus(410823204, 1893374210), negate(-1976649740))))\u2500\u252c\u25001102699011\u2500\u252c\u2500plus(notEquals('-111708376', ''), lessOrEquals(1969336991, -1611144300))\u2500\u2510\r\n\u2502                                                          0.8414709848078965 \u2502 1102699011 \u2502                                                                        1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\nAdding `HAVING expr`, `HAVING not(expr)`, `HAVING (expr IS NULL)` has no output:\r\n\r\nexpr = `NOT cos(MAX(pow(1523598955, 763027371)))`\r\n\r\n```\r\nSELECT\r\n    MAX(sin((410823204 + 1893374210) != -(-1976649740))),\r\n    1102699011,\r\n    ('-111708376' != '') + (1969336991 <= -1611144300)\r\nFROM t0 AS t0\r\nGROUP BY\r\n    -251131989,\r\n    -1154587996\r\nHAVING NOT cos(MAX(pow(1523598955, 763027371)))\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nQuery id: fb31da56-35b8-4c30-b714-59702125c2b3\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.035 sec.\r\n```\r\n\r\n```\r\nSELECT\r\n    MAX(sin((410823204 + 1893374210) != -(-1976649740))),\r\n    1102699011,\r\n    ('-111708376' != '') + (1969336991 <= -1611144300)\r\nFROM t0 AS t0\r\nGROUP BY\r\n    -251131989,\r\n    -1154587996\r\nHAVING NOT (NOT cos(MAX(pow(1523598955, 763027371))))\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nQuery id: 6bb6df4a-fab8-4036-ae9b-3d109cfb8ef3\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.034 sec.\r\n```\r\n\r\n```\r\nSELECT\r\n    MAX(sin((410823204 + 1893374210) != -(-1976649740))),\r\n    1102699011,\r\n    ('-111708376' != '') + (1969336991 <= -1611144300)\r\nFROM t0 AS t0\r\nGROUP BY\r\n    -251131989,\r\n    -1154587996\r\nHAVING (NOT cos(MAX(pow(1523598955, 763027371)))) IS NULL\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nQuery id: 2685f92d-a046-4dc9-8209-ab77f5d03cef\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.037 sec.\r\n```\n",
  "hints_text": "Minimized to case where with and without allow_experimental_analyzer results are different\r\n```\r\nSELECT max(number)\r\nFROM numbers(1)\r\nHAVING NOT (NOT cos(MAX(pow(1523598955, 763027371))))\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nQuery id: 6accc80c-2a29-4c5e-aedb-4e36210ad14b\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.023 sec.\r\n\r\nSELECT max(number)\r\nFROM numbers(1)\r\nHAVING NOT (NOT cos(MAX(pow(1523598955, 763027371))))\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 1\r\n\r\nQuery id: 1495c269-108d-4e00-985c-b235be8e0d2c\r\n\r\n\u250c\u2500max(number)\u2500\u2510\r\n\u2502           0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.024 sec.\r\n```\n```\r\nSELECT\r\n    max(number),\r\n    NOT cos(MAX(pow(1523598955, 763027371))) AS expr,\r\n    NOT expr AS not_expr,\r\n    expr IS NULL AS expr_is_null\r\nFROM numbers(1)\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nQuery id: 2e94ac7e-f729-4894-aaed-a521e93f06f8\r\n\r\n\u250c\u2500maxOrNull(number)\u2500\u252c\u2500expr\u2500\u252c\u2500not_expr\u2500\u252c\u2500expr_is_null\u2500\u2510\r\n\u2502                 0 \u2502    0 \u2502        0 \u2502            0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.024 sec.\r\n\r\nip-172-31-0-52 :) select max(number), NOT cos(MAX(pow(1523598955, 763027371))) as expr, not(expr) as not_expr, expr IS NULL as expr_is_null from numbers(1) settings aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer=1;\r\n\r\nSELECT\r\n    max(number),\r\n    NOT cos(MAX(pow(1523598955, 763027371))) AS expr,\r\n    NOT expr AS not_expr,\r\n    expr IS NULL AS expr_is_null\r\nFROM numbers(1)\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 1\r\n\r\nQuery id: fca020b3-93d3-48b8-a6c1-6fca6f834445\r\n\r\n\u250c\u2500max(number)\u2500\u252c\u2500expr\u2500\u252c\u2500not_expr\u2500\u252c\u2500expr_is_null\u2500\u2510\r\n\u2502           0 \u2502    0 \u2502        1 \u2502            0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.024 sec.\r\n```\nFor the second time it goes totally insane like here #43167\r\n\r\nI double check in fidlle/cloud and it does not reproduce.\r\nI reproduce locally with already running server and client and see the same incorrect result.\r\nI restart server and it is gone\r\n```\r\nip-172-31-0-52 :) SELECT max(number), NOT cos(MAX(pow(1523598955, 763027371))) AS expr, NOT expr AS not_expr, expr IS NULL AS expr_is_null FROM numbers(1) SETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nSELECT\r\n    max(number),\r\n    NOT cos(MAX(pow(1523598955, 763027371))) AS expr,\r\n    NOT expr AS not_expr,\r\n    expr IS NULL AS expr_is_null\r\nFROM numbers(1)\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nQuery id: 78bf1126-bdc3-4240-a86c-9024d7a2d0a3\r\n\r\n\u250c\u2500maxOrNull(number)\u2500\u252c\u2500expr\u2500\u252c\u2500not_expr\u2500\u252c\u2500expr_is_null\u2500\u2510\r\n\u2502                 0 \u2502    0 \u2502        0 \u2502            0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.025 sec.\r\n\r\nip-172-31-0-52 :) SELECT max(number), NOT cos(MAX(pow(1523598955, 763027371))) AS expr, NOT expr AS not_expr, expr IS NULL AS expr_is_null FROM numbers(1) SETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nSELECT\r\n    max(number),\r\n    NOT cos(MAX(pow(1523598955, 763027371))) AS expr,\r\n    NOT expr AS not_expr,\r\n    expr IS NULL AS expr_is_null\r\nFROM numbers(1)\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nQuery id: 31911f83-71db-4f24-b9e8-bfdaf072f496\r\n\r\nConnecting to localhost:9000 as user default. <---- RECONNECT\r\nConnected to ClickHouse server version 22.13.1 revision 54461.\r\n\r\n\u250c\u2500maxOrNull(number)\u2500\u252c\u2500expr\u2500\u252c\u2500not_expr\u2500\u252c\u2500expr_is_null\u2500\u2510\r\n\u2502                 0 \u2502    0 \u2502        1 \u2502            0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.026 sec.\r\n```\r\n\r\nAs client was not restarted it can't be something changed in session settings. And I haven't touched server config. Really strange.\nAnd I reproduced it again! After original query:\r\n\r\n```\r\nip-172-31-0-52 :) SELECT MAX((sin (((((410823204)+(1893374210)))<>((- (-1976649740))))))), 1102699011, (((('-111708376')!=('')))+(((1969336991)<=(-1611144300)))) FROM t0 AS t0 GROUP BY -251131989, -1154587996 HAVING (NOT ((cos (MAX(pow(1523598955,763027371)))))) UNION ALL SELECT MAX((sin (((((410823204)+(1893374210)))!=((- (-1976649740))))))), 1102699011, (((('-111708376')!=('')))+(((1969336991)<=(-1611144300)))) FROM t0 AS t0 GROUP BY -251131989, -1154587996 HAVING (NOT ((NOT ((cos (MAX(pow(1523598955,763027371)))))))) UNION ALL SELECT MAX((sin (((((410823204)+(1893374210)))!=((- (-1976649740))))))), 1102699011, (((('-111708376')!=('')))+(((1969336991)<=(-1611144300)))) FROM t0 AS t0 GROUP BY -251131989, -1154587996 HAVING (((NOT ((cos (MAX(pow(1523598955,763027371))))))) IS NULL) SETTINGS aggregate_functions_null_for_empty=1, enable_optimize_predicate_expression=0 , allow_experimental_analyzer = 0;\r\n\r\nSELECT\r\n    MAX(sin((410823204 + 1893374210) != -(-1976649740))),\r\n    1102699011,\r\n    ('-111708376' != '') + (1969336991 <= -1611144300)\r\nFROM t0 AS t0\r\nGROUP BY\r\n    -251131989,\r\n    -1154587996\r\nHAVING NOT cos(MAX(pow(1523598955, 763027371)))\r\nUNION ALL\r\nSELECT\r\n    MAX(sin((410823204 + 1893374210) != -(-1976649740))),\r\n    1102699011,\r\n    ('-111708376' != '') + (1969336991 <= -1611144300)\r\nFROM t0 AS t0\r\nGROUP BY\r\n    -251131989,\r\n    -1154587996\r\nHAVING NOT (NOT cos(MAX(pow(1523598955, 763027371))))\r\nUNION ALL\r\nSELECT\r\n    MAX(sin((410823204 + 1893374210) != -(-1976649740))),\r\n    1102699011,\r\n    ('-111708376' != '') + (1969336991 <= -1611144300)\r\nFROM t0 AS t0\r\nGROUP BY\r\n    -251131989,\r\n    -1154587996\r\nHAVING (NOT cos(MAX(pow(1523598955, 763027371)))) IS NULL\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nQuery id: a26ead72-9041-43ef-a549-d676c5e793e2\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.429 sec.\r\n\r\nip-172-31-0-52 :) SELECT max(number), NOT cos(MAX(pow(1523598955, 763027371))) AS expr, NOT expr AS not_expr, expr IS NULL AS expr_is_null FROM numbers(1) SETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0;\r\n\r\nSELECT\r\n    max(number),\r\n    NOT cos(MAX(pow(1523598955, 763027371))) AS expr,\r\n    NOT expr AS not_expr,\r\n    expr IS NULL AS expr_is_null\r\nFROM numbers(1)\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0\r\n\r\nQuery id: 3fba8d50-5e51-4ab1-8e23-c8ad24cfee47\r\n\r\n\u250c\u2500maxOrNull(number)\u2500\u252c\u2500expr\u2500\u252c\u2500not_expr\u2500\u252c\u2500expr_is_null\u2500\u2510\r\n\u2502                 0 \u2502    0 \u2502        0 \u2502            0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.025 sec.\r\n\r\nip-172-31-0-52 :)\r\n```\r\n\r\nSo I am still sane! Bug is in JIT and everything works as expected with `compile_expressions=0`\r\n```\r\nSELECT\r\n    max(number),\r\n    NOT cos(MAX(pow(1523598955, 763027371))) AS expr,\r\n    NOT expr AS not_expr,\r\n    expr IS NULL AS expr_is_null\r\nFROM numbers(1)\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0, compile_expressions = 0\r\n\r\nQuery id: a14f8d49-0016-43af-bade-c7dba5d88de3\r\n\r\n\u250c\u2500maxOrNull(number)\u2500\u252c\u2500expr\u2500\u252c\u2500not_expr\u2500\u252c\u2500expr_is_null\u2500\u2510\r\n\u2502                 0 \u2502    0 \u2502        1 \u2502            0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.025 sec.\r\n\r\nip-172-31-0-52 :) SELECT max(number), NOT cos(MAX(pow(1523598955, 763027371))) AS expr, NOT expr AS not_expr, expr IS NULL AS expr_is_null FROM numbers(1) SETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0, compile_expressions=1;\r\n\r\nSELECT\r\n    max(number),\r\n    NOT cos(MAX(pow(1523598955, 763027371))) AS expr,\r\n    NOT expr AS not_expr,\r\n    expr IS NULL AS expr_is_null\r\nFROM numbers(1)\r\nSETTINGS aggregate_functions_null_for_empty = 1, enable_optimize_predicate_expression = 0, allow_experimental_analyzer = 0, compile_expressions = 1\r\n\r\nQuery id: 75685bf1-4da9-4753-b443-bc522f7d5395\r\n\r\n\u250c\u2500maxOrNull(number)\u2500\u252c\u2500expr\u2500\u252c\u2500not_expr\u2500\u252c\u2500expr_is_null\u2500\u2510\r\n\u2502                 0 \u2502    0 \u2502        0 \u2502            0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.025 sec.\r\n```",
  "created_at": "2023-01-09T15:36:09Z"
}