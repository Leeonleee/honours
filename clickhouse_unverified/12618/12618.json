{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 12618,
  "instance_id": "ClickHouse__ClickHouse-12618",
  "issue_numbers": [
    "12617"
  ],
  "base_commit": "16e8c6143847e654e51fadda8ba1e83fc1d28cba",
  "patch": "diff --git a/src/Processors/Transforms/MergeSortingTransform.cpp b/src/Processors/Transforms/MergeSortingTransform.cpp\nindex 428fbb6d528a..9be139e78753 100644\n--- a/src/Processors/Transforms/MergeSortingTransform.cpp\n+++ b/src/Processors/Transforms/MergeSortingTransform.cpp\n@@ -231,9 +231,8 @@ void MergeSortingTransform::generate()\n             ProfileEvents::increment(ProfileEvents::ExternalSortMerge);\n             LOG_INFO(log, \"There are {} temporary sorted parts to merge.\", temporary_files.size());\n \n-            if (!chunks.empty())\n-                processors.emplace_back(std::make_shared<MergeSorterSource>(\n-                        header_without_constants, std::move(chunks), description, max_merged_block_size, limit));\n+            processors.emplace_back(std::make_shared<MergeSorterSource>(\n+                    header_without_constants, std::move(chunks), description, max_merged_block_size, limit));\n         }\n \n         generated_prefix = true;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/00110_external_sort.reference b/tests/queries/0_stateless/00110_external_sort.reference\nindex 1ceebce4e18f..b9044e2f4047 100644\n--- a/tests/queries/0_stateless/00110_external_sort.reference\n+++ b/tests/queries/0_stateless/00110_external_sort.reference\n@@ -8,3 +8,14 @@\n 8140551\n 5427034\n 2713517\n+-\n+440516\n+1540521\n+733765\n+1833770\n+1027014\n+220258\n+1320263\n+513507\n+1613512\n+806756\ndiff --git a/tests/queries/0_stateless/00110_external_sort.sql b/tests/queries/0_stateless/00110_external_sort.sql\nindex e7d6b41837b9..e72847965522 100644\n--- a/tests/queries/0_stateless/00110_external_sort.sql\n+++ b/tests/queries/0_stateless/00110_external_sort.sql\n@@ -1,3 +1,9 @@\n SET max_memory_usage = 300000000;\n SET max_bytes_before_external_sort = 20000000;\n SELECT number FROM (SELECT number FROM system.numbers LIMIT 10000000) ORDER BY number * 1234567890123456789 LIMIT 9999990, 10;\n+\n+SELECT '-';\n+\n+SET max_bytes_before_external_sort = 33554432;\n+set max_block_size = 1048576;\n+SELECT number FROM (SELECT number FROM numbers(2097152)) ORDER BY number * 1234567890123456789 LIMIT 2097142, 10;\n",
  "problem_statement": "Pipeline stuck for external sort\n```\r\nSET max_bytes_before_external_sort = 33554432;\r\nset max_block_size = 1048576;\r\nSELECT number FROM (SELECT number FROM numbers(2097152)) ORDER BY number * 1234567890123456789 LIMIT 2097142, 10;\r\n\r\nCode: 49. DB::Exception: Received from localhost:9000. DB::Exception: Pipeline stuck. Current state:\r\ndigraph\r\n{\r\n  rankdir=\"LR\";\r\n  { node [shape = box]\r\n    n140555455738912[label=\"Numbers(2 jobs) (Finished)\"];\r\n    n140554936614744[label=\"Limit(0 jobs) (Finished)\"];\r\n    n140554935957656[label=\"ExpressionTransform(2 jobs) (Finished)\"];\r\n    n140554935947416[label=\"ExpressionTransform(2 jobs) (Finished)\"];\r\n    n140554935947736[label=\"Converting(2 jobs) (Finished)\"];\r\n    n140554935957976[label=\"ExpressionTransform(2 jobs) (Finished)\"];\r\n    n140554935472152[label=\"PartialSortingTransform(2 jobs) (Finished)\"];\r\n    n140554935484312[label=\"LimitsCheckingTransform(2 jobs) (Finished)\"];\r\n    n140556954827928[label=\"MergeSortingTransform(5 jobs) (NeedData)\"];\r\n    n140556724839064[label=\"Limit(0 jobs) (NeedData)\"];\r\n    n140556724839704[label=\"ExpressionTransform(0 jobs) (NeedData)\"];\r\n    n140556724840024[label=\"Converting(0 jobs) (NeedData)\"];\r\n    n140554935476248[label=\"LimitsCheckingTransform(0 jobs) (NeedData)\"];\r\n    n140556954548216[label=\"NullSource(0 jobs) (NeedData)\"];\r\n    n140556954546872[label=\"NullSource(0 jobs) (NeedData)\"];\r\n    n140556716210200[label=\"LazyOutputFormat(0 jobs) (NeedData)\"];\r\n    n140556626042904[label=\"BufferingToFileTransform(4 jobs) (PortFull)\"];\r\n    n140556626043544[label=\"MergingSortedTransform(0 jobs) (NeedData)\"];\r\n  }\r\n  n140555455738912 -> n140554936614744;\r\n  n140554936614744 -> n140554935957656;\r\n  n140554935957656 -> n140554935947416;\r\n  n140554935947416 -> n140554935947736;\r\n  n140554935947736 -> n140554935957976;\r\n  n140554935957976 -> n140554935472152;\r\n  n140554935472152 -> n140554935484312;\r\n  n140554935484312 -> n140556954827928;\r\n  n140556954827928 -> n140556724839064;\r\n  n140556954827928 -> n140556626042904;\r\n  n140556724839064 -> n140556724839704;\r\n  n140556724839704 -> n140556724840024;\r\n  n140556724840024 -> n140554935476248;\r\n  n140554935476248 -> n140556716210200;\r\n  n140556954548216 -> n140556716210200;\r\n  n140556954546872 -> n140556716210200;\r\n  n140556626042904 -> n140556626043544;\r\n  n140556626043544 -> n140556954827928;\r\n}\r\n```\r\nmaster (20.7.1.1)\r\n\n",
  "hints_text": "",
  "created_at": "2020-07-21T09:31:42Z"
}