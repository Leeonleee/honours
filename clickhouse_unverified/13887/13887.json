{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 13887,
  "instance_id": "ClickHouse__ClickHouse-13887",
  "issue_numbers": [
    "13182"
  ],
  "base_commit": "fb5f98e8004efbd6bdb69a4d2628937c92d93aeb",
  "patch": "diff --git a/src/Columns/ColumnFixedString.cpp b/src/Columns/ColumnFixedString.cpp\nindex 3399ce5c6d05..95a477e54cf8 100644\n--- a/src/Columns/ColumnFixedString.cpp\n+++ b/src/Columns/ColumnFixedString.cpp\n@@ -189,7 +189,7 @@ void ColumnFixedString::updatePermutation(bool reverse, size_t limit, int, Permu\n         auto new_first = first;\n         for (auto j = first + 1; j < last; ++j)\n         {\n-            if (memcmpSmallAllowOverflow15(chars.data() + j * n, chars.data() + new_first * n, n) != 0)\n+            if (memcmpSmallAllowOverflow15(chars.data() + res[j] * n, chars.data() + res[new_first] * n, n) != 0)\n             {\n                 if (j - new_first > 1)\n                     new_ranges.emplace_back(new_first, j);\n@@ -210,7 +210,7 @@ void ColumnFixedString::updatePermutation(bool reverse, size_t limit, int, Permu\n         auto new_first = first;\n         for (auto j = first + 1; j < limit; ++j)\n         {\n-            if (memcmpSmallAllowOverflow15(chars.data() + j * n, chars.data() + new_first * n, n)  != 0)\n+            if (memcmpSmallAllowOverflow15(chars.data() + res[j] * n, chars.data() + res[new_first] * n, n)  != 0)\n             {\n                 if (j - new_first > 1)\n                     new_ranges.emplace_back(new_first, j);\n@@ -221,7 +221,7 @@ void ColumnFixedString::updatePermutation(bool reverse, size_t limit, int, Permu\n         auto new_last = limit;\n         for (auto j = limit; j < last; ++j)\n         {\n-            if (memcmpSmallAllowOverflow15(chars.data() + j * n, chars.data() + new_first * n, n)  == 0)\n+            if (memcmpSmallAllowOverflow15(chars.data() + res[j] * n, chars.data() + res[new_first] * n, n)  == 0)\n             {\n                 std::swap(res[new_last], res[j]);\n                 ++new_last;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01453_fixsed_string_sort.reference b/tests/queries/0_stateless/01453_fixsed_string_sort.reference\nnew file mode 100644\nindex 000000000000..1c94eaa1cb46\n--- /dev/null\n+++ b/tests/queries/0_stateless/01453_fixsed_string_sort.reference\n@@ -0,0 +1,12 @@\n+8AD8FC5EA49E544C98E61140AFD79F80\t1\n+8AD8FC5EA49E544C98E61140AFD79F80\t1\n+8AD8FC5EA49E544C98E61140AFD79F80\t2\n+8AD8FC5EA49E544C98E61140AFD79F80\t2\n+999E114066EF56109C3AB3FB33E0FDA9\t1\n+999E114066EF56109C3AB3FB33E0FDA9\t1\n+999E114066EF56109C3AB3FB33E0FDA9\t1\n+999E114066EF56109C3AB3FB33E0FDA9\t1\n+999E114066EF56109C3AB3FB33E0FDA9\t2\n+999E114066EF56109C3AB3FB33E0FDA9\t2\n+999E114066EF56109C3AB3FB33E0FDA9\t2\n+999E114066EF56109C3AB3FB33E0FDA9\t2\ndiff --git a/tests/queries/0_stateless/01453_fixsed_string_sort.sql b/tests/queries/0_stateless/01453_fixsed_string_sort.sql\nnew file mode 100644\nindex 000000000000..99907b62d4ab\n--- /dev/null\n+++ b/tests/queries/0_stateless/01453_fixsed_string_sort.sql\n@@ -0,0 +1,22 @@\n+drop table if exists badFixedStringSort;\n+CREATE TABLE IF NOT EXISTS badFixedStringSort (uuid5_old FixedString(16), subitem String) engine=MergeTree order by  tuple();\n+\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '1');\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '2');\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '1');\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '2');\n+\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '2');\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '1');\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '2');\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '1');\n+\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '1');\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '2');\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '1');\n+INSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '2');\n+\n+optimize table badFixedStringSort final;\n+select hex(uuid5_old), subitem from badFixedStringSort ORDER BY  uuid5_old, subitem;\n+\n+drop table if exists badFixedStringSort;\n",
  "problem_statement": "ORDER BY field with type FixedString(16) gives unexpected result\nTrying to sort query by field with type 'FixedString(16)' results is wrong record order.\r\n\r\n**How to reproduce**\r\nTested versions: \r\n * 20.7.1.4189 -- reproducible\r\n * 20.5.3.27 -- reproducible\r\n * 20.5.2.7 -- reproducible\r\n * 20.4.7.67 -- non-reproducible\r\n * 18.12.17 -- non-reproducible\r\n\r\nExample data set:\r\nTable containing rows with string name and corresponding UUID5 of each name (uuid_old == uuid_new and always match name).\r\n**Each statement of the set must be executed as separate query (not in one batch).**\r\n\r\n    -- sql.txt\r\n    CREATE TABLE IF NOT EXISTS bad_uuid_sort (date Date, timestamp DateTime, name String, uuid5_old FixedString(16), uuid5_new UUID, subitem String) engine MergeTree(date, (timestamp, uuid5_old), 8192);\r\n\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_1', UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '999e1140-66ef-5610-9c3a-b3fb33e0fda9', 'item1');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_1', UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '999e1140-66ef-5610-9c3a-b3fb33e0fda9', 'item3');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_1', UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '999e1140-66ef-5610-9c3a-b3fb33e0fda9', 'item2');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_1', UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '999e1140-66ef-5610-9c3a-b3fb33e0fda9', 'item5');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_1', UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '999e1140-66ef-5610-9c3a-b3fb33e0fda9', 'item4');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_1', UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '999e1140-66ef-5610-9c3a-b3fb33e0fda9', 'item1');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_1', UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '999e1140-66ef-5610-9c3a-b3fb33e0fda9', 'item3');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_1', UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '999e1140-66ef-5610-9c3a-b3fb33e0fda9', 'item2');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_1', UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '999e1140-66ef-5610-9c3a-b3fb33e0fda9', 'item5');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_1', UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '999e1140-66ef-5610-9c3a-b3fb33e0fda9', 'item4');\r\n\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_2', UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '8ad8fc5e-a49e-544c-98e6-1140afd79f80', 'item5');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_2', UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '8ad8fc5e-a49e-544c-98e6-1140afd79f80', 'item2');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_2', UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '8ad8fc5e-a49e-544c-98e6-1140afd79f80', 'item3');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_2', UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '8ad8fc5e-a49e-544c-98e6-1140afd79f80', 'item4');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_2', UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '8ad8fc5e-a49e-544c-98e6-1140afd79f80', 'item1');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_2', UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '8ad8fc5e-a49e-544c-98e6-1140afd79f80', 'item5');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_2', UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '8ad8fc5e-a49e-544c-98e6-1140afd79f80', 'item2');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_2', UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '8ad8fc5e-a49e-544c-98e6-1140afd79f80', 'item3');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_2', UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '8ad8fc5e-a49e-544c-98e6-1140afd79f80', 'item4');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_2', UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '8ad8fc5e-a49e-544c-98e6-1140afd79f80', 'item1');\r\n\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_3', UUIDStringToNum('ffa62c2d-2a77-52ff-a90b-7e296821f0f0'), 'ffa62c2d-2a77-52ff-a90b-7e296821f0f0', 'item3');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_3', UUIDStringToNum('ffa62c2d-2a77-52ff-a90b-7e296821f0f0'), 'ffa62c2d-2a77-52ff-a90b-7e296821f0f0', 'item5');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_3', UUIDStringToNum('ffa62c2d-2a77-52ff-a90b-7e296821f0f0'), 'ffa62c2d-2a77-52ff-a90b-7e296821f0f0', 'item2');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_3', UUIDStringToNum('ffa62c2d-2a77-52ff-a90b-7e296821f0f0'), 'ffa62c2d-2a77-52ff-a90b-7e296821f0f0', 'item1');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_3', UUIDStringToNum('ffa62c2d-2a77-52ff-a90b-7e296821f0f0'), 'ffa62c2d-2a77-52ff-a90b-7e296821f0f0', 'item4');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_3', UUIDStringToNum('ffa62c2d-2a77-52ff-a90b-7e296821f0f0'), 'ffa62c2d-2a77-52ff-a90b-7e296821f0f0', 'item3');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_3', UUIDStringToNum('ffa62c2d-2a77-52ff-a90b-7e296821f0f0'), 'ffa62c2d-2a77-52ff-a90b-7e296821f0f0', 'item5');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_3', UUIDStringToNum('ffa62c2d-2a77-52ff-a90b-7e296821f0f0'), 'ffa62c2d-2a77-52ff-a90b-7e296821f0f0', 'item2');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_3', UUIDStringToNum('ffa62c2d-2a77-52ff-a90b-7e296821f0f0'), 'ffa62c2d-2a77-52ff-a90b-7e296821f0f0', 'item1');\r\n    INSERT INTO bad_uuid_sort values (toDate(now()), now(), 'id_3', UUIDStringToNum('ffa62c2d-2a77-52ff-a90b-7e296821f0f0'), 'ffa62c2d-2a77-52ff-a90b-7e296821f0f0', 'item4');\r\n\r\n    \r\n    # Insert one-by-one with this oneliner\r\n    cat sql.txt | xargs -d '\\n' -I QUERY clickhouse-client -q 'QUERY'\r\n    \r\n\r\nSelection with ordering by uuid5_old gives broken ordering for ordering keys following it (check subitem column):\r\n\r\n    # clickhouse-client -q SELECT date, timestamp, name_raw, UUIDNumToString(uuid5_old), uuid5_new, subitem FROM bad_uuid_sort ORDER BY name_raw ASC, uuid5_old ASC, subitem ASC, timestamp ASC;\r\n    \r\n    2020-07-31      2020-07-31 12:55:33     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item1\r\n    2020-07-31      2020-07-31 12:55:33     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item5\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item5\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item5\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item5\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item5\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item5\r\n\r\n\r\nSelecting by uuid5_new gives expected ordering:\r\n\r\n    # clickhouse-client -q SELECT date, timestamp, name_raw, UUIDNumToString(uuid5_old), uuid5_new, subitem FROM bad_uuid_sort ORDER BY name_raw ASC, uuid5_new ASC, subitem ASC, timestamp ASC;\r\n    \r\n    2020-07-31      2020-07-31 12:55:33     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item2\r\n    2020-07-31      2020-07-31 12:55:33     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item5\r\n    2020-07-31      2020-07-31 12:55:34     id_1    999e1140-66ef-5610-9c3a-b3fb33e0fda9    999e1140-66ef-5610-9c3a-b3fb33e0fda9    item5\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item5\r\n    2020-07-31      2020-07-31 12:55:34     id_2    8ad8fc5e-a49e-544c-98e6-1140afd79f80    8ad8fc5e-a49e-544c-98e6-1140afd79f80    item5\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item1\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item2\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item3\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item4\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item5\r\n    2020-07-31      2020-07-31 12:55:34     id_3    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    ffa62c2d-2a77-52ff-a90b-7e296821f0f0    item5\r\n    \r\nResults are not always consistent, inserting same data over and over again with some intervals usually helps.\r\n\r\n**Expected behavior**\r\nBoth queries should result in same ordering\n",
  "hints_text": "could be the same issue as https://github.com/ClickHouse/ClickHouse/issues/12748\nPlayed around a bit with different version from `stable` repository, seems like problem has been introduced between versions \r\n`20.4.7.67` and `20.5.2.7`.\n@redrampage  thank you.\r\n\r\nI slightly minimized the example.\r\n\r\n```\r\n$ cat badFixedStringSort.sql\r\ndrop table if exists badFixedStringSort;\r\n\r\nCREATE TABLE IF NOT EXISTS badFixedStringSort (uuid5_old FixedString(16), subitem String)\r\nengine=MergeTree order by  tuple();\r\n\r\nsystem stop merges badFixedStringSort;\r\n\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '1');\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '2');\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '1');\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '2');\r\n\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '2');\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '1');\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '2');\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('8ad8fc5e-a49e-544c-98e6-1140afd79f80'), '1');\r\n\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '1');\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '2');\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '1');\r\nINSERT INTO badFixedStringSort values (UUIDStringToNum('999e1140-66ef-5610-9c3a-b3fb33e0fda9'), '2');\r\n\r\nSELECT cityHash64(groupArray(subitem)) FROM (select * from badFixedStringSort ORDER BY  uuid5_old ASC, subitem ASC);\r\nSELECT cityHash64(groupArray(subitem)) FROM (select * from badFixedStringSort ORDER BY  uuid5_old ASC, subitem ASC settings max_block_size=1);\r\n\r\nsystem start merges badFixedStringSort;\r\noptimize table badFixedStringSort final;\r\n\r\nSELECT cityHash64(groupArray(subitem)) FROM (select * from badFixedStringSort ORDER BY  uuid5_old ASC, subitem ASC);\r\nSELECT cityHash64(groupArray(subitem)) FROM (select * from badFixedStringSort ORDER BY  uuid5_old ASC, subitem ASC settings max_block_size=1);\r\n``` \r\n20.5.3.27 / 20.6.2.15\r\n```\r\ncat badFixedStringSort.sql |clickhouse-client -mn\r\n17245590760575760696\r\n17245590760575760696\r\n3040921239879513713\r\n17245590760575760696\r\n```\r\n\r\n\r\n19.13.7.57 / 20.4.7.67\r\n```\r\ncat badFixedStringSort.sql |clickhouse-client -mn\r\n17245590760575760696\r\n17245590760575760696\r\n17245590760575760696\r\n17245590760575760696\r\n```\r\n\r\n20.5.3.27 / 20.6.2.15\r\n```\r\nselect hex(uuid5_old), subitem from badFixedStringSort ORDER BY  uuid5_old, subitem;\r\n\u250c\u2500hex(uuid5_old)\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500subitem\u2500\u2510\r\n\u2502 8AD8FC5EA49E544C98E61140AFD79F80 \u2502 1       \u2502\r\n\u2502 8AD8FC5EA49E544C98E61140AFD79F80 \u2502 1       \u2502\r\n\u2502 8AD8FC5EA49E544C98E61140AFD79F80 \u2502 2       \u2502\r\n\u2502 8AD8FC5EA49E544C98E61140AFD79F80 \u2502 2       \u2502 \r\n\u2502 999E114066EF56109C3AB3FB33E0FDA9 \u2502 1       \u2502  <---\r\n\u2502 999E114066EF56109C3AB3FB33E0FDA9 \u2502 1       \u2502  <---\r\n\u2502 999E114066EF56109C3AB3FB33E0FDA9 \u2502 2       \u2502 \r\n\u2502 999E114066EF56109C3AB3FB33E0FDA9 \u2502 2       \u2502\r\n\u2502 999E114066EF56109C3AB3FB33E0FDA9 \u2502 1       \u2502   <---\r\n\u2502 999E114066EF56109C3AB3FB33E0FDA9 \u2502 1       \u2502   <---\r\n\u2502 999E114066EF56109C3AB3FB33E0FDA9 \u2502 2       \u2502\r\n\u2502 999E114066EF56109C3AB3FB33E0FDA9 \u2502 2       \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\n@alexey-milovidov ",
  "created_at": "2020-08-19T12:28:24Z"
}