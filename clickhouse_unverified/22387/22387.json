{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 22387,
  "instance_id": "ClickHouse__ClickHouse-22387",
  "issue_numbers": [
    "22157"
  ],
  "base_commit": "e2b25affe52d7ab62ed7fccd514f93d7b1597269",
  "patch": "diff --git a/src/Functions/array/range.cpp b/src/Functions/array/range.cpp\nindex 1a057458175b..ac9687869233 100644\n--- a/src/Functions/array/range.cpp\n+++ b/src/Functions/array/range.cpp\n@@ -22,6 +22,11 @@ namespace ErrorCodes\n }\n \n \n+/** Generates array\n+  * range(size): [0, size)\n+  * range(start, end): [start, end)\n+  * range(start, end, step): [start, end) with step increments.\n+  */\n class FunctionRange : public IFunction\n {\n public:\n@@ -40,9 +45,9 @@ class FunctionRange : public IFunction\n     {\n         if (arguments.size() > 3 || arguments.empty())\n         {\n-            throw Exception{\"Function \" + getName() + \" needs 1..3 arguments; passed \"\n-                            + std::to_string(arguments.size()) + \".\",\n-                            ErrorCodes::NUMBER_OF_ARGUMENTS_DOESNT_MATCH};\n+            throw Exception(ErrorCodes::NUMBER_OF_ARGUMENTS_DOESNT_MATCH,\n+                \"Function {} needs 1..3 arguments; passed {}.\",\n+                getName(), arguments.size());\n         }\n \n         for (const auto & arg : arguments)\n@@ -339,6 +344,18 @@ class FunctionRange : public IFunction\n \n     ColumnPtr executeImpl(const ColumnsWithTypeAndName & arguments, const DataTypePtr & result_type, size_t input_rows_count) const override\n     {\n+        DataTypePtr elem_type = checkAndGetDataType<DataTypeArray>(result_type.get())->getNestedType();\n+        WhichDataType which(elem_type);\n+\n+        if (!which.isUInt8()\n+            && !which.isUInt16()\n+            && !which.isUInt32()\n+            && !which.isUInt64())\n+        {\n+            throw Exception{\"Illegal columns of arguments of function \" + getName()\n+                + \", the function only implemented for unsigned integers up to 64 bit\", ErrorCodes::ILLEGAL_COLUMN};\n+        }\n+\n         ColumnPtr res;\n         if (arguments.size() == 1)\n         {\n@@ -356,22 +373,24 @@ class FunctionRange : public IFunction\n         Columns columns_holder(3);\n         ColumnRawPtrs column_ptrs(3);\n \n-        const auto return_type = checkAndGetDataType<DataTypeArray>(result_type.get())->getNestedType();\n-\n         for (size_t i = 0; i < arguments.size(); ++i)\n         {\n             if (i == 1)\n-                columns_holder[i] = castColumn(arguments[i], return_type)->convertToFullColumnIfConst();\n+                columns_holder[i] = castColumn(arguments[i], elem_type)->convertToFullColumnIfConst();\n             else\n-                columns_holder[i] = castColumn(arguments[i], return_type);\n+                columns_holder[i] = castColumn(arguments[i], elem_type);\n \n             column_ptrs[i] = columns_holder[i].get();\n         }\n \n-        // for step column, defaults to 1\n+        /// Step is one by default.\n         if (arguments.size() == 2)\n         {\n-            columns_holder[2] = return_type->createColumnConst(input_rows_count, 1);\n+            /// Convert a column with constant 1 to the result type.\n+            columns_holder[2] = castColumn(\n+                {DataTypeUInt8().createColumnConst(input_rows_count, 1), std::make_shared<DataTypeUInt8>(), {}},\n+                elem_type);\n+\n             column_ptrs[2] = columns_holder[2].get();\n         }\n \n@@ -385,7 +404,9 @@ class FunctionRange : public IFunction\n             if ((res = executeConstStartStep<UInt8>(column_ptrs[1], start, step, input_rows_count)) ||\n                 (res = executeConstStartStep<UInt16>(column_ptrs[1], start, step, input_rows_count)) ||\n                 (res = executeConstStartStep<UInt32>(column_ptrs[1], start, step, input_rows_count)) ||\n-                (res = executeConstStartStep<UInt64>(column_ptrs[1], start, step, input_rows_count))) {}\n+                (res = executeConstStartStep<UInt64>(column_ptrs[1], start, step, input_rows_count)))\n+            {\n+            }\n         }\n         else if (is_start_const && !is_step_const)\n         {\n@@ -394,7 +415,9 @@ class FunctionRange : public IFunction\n             if ((res = executeConstStart<UInt8>(column_ptrs[1], column_ptrs[2], start, input_rows_count)) ||\n                 (res = executeConstStart<UInt16>(column_ptrs[1], column_ptrs[2], start, input_rows_count)) ||\n                 (res = executeConstStart<UInt32>(column_ptrs[1], column_ptrs[2], start, input_rows_count)) ||\n-                (res = executeConstStart<UInt64>(column_ptrs[1], column_ptrs[2], start, input_rows_count))) {}\n+                (res = executeConstStart<UInt64>(column_ptrs[1], column_ptrs[2], start, input_rows_count)))\n+            {\n+            }\n         }\n         else if (!is_start_const && is_step_const)\n         {\n@@ -403,14 +426,18 @@ class FunctionRange : public IFunction\n             if ((res = executeConstStep<UInt8>(column_ptrs[0], column_ptrs[1], step, input_rows_count)) ||\n                 (res = executeConstStep<UInt16>(column_ptrs[0], column_ptrs[1], step, input_rows_count)) ||\n                 (res = executeConstStep<UInt32>(column_ptrs[0], column_ptrs[1], step, input_rows_count)) ||\n-                (res = executeConstStep<UInt64>(column_ptrs[0], column_ptrs[1], step, input_rows_count))) {}\n+                (res = executeConstStep<UInt64>(column_ptrs[0], column_ptrs[1], step, input_rows_count)))\n+            {\n+            }\n         }\n         else\n         {\n             if ((res = executeGeneric<UInt8>(column_ptrs[0], column_ptrs[1], column_ptrs[2], input_rows_count)) ||\n                 (res = executeGeneric<UInt16>(column_ptrs[0], column_ptrs[1], column_ptrs[2], input_rows_count)) ||\n                 (res = executeGeneric<UInt32>(column_ptrs[0], column_ptrs[1], column_ptrs[2], input_rows_count)) ||\n-                (res = executeGeneric<UInt64>(column_ptrs[0], column_ptrs[1], column_ptrs[2], input_rows_count))) {}\n+                (res = executeGeneric<UInt64>(column_ptrs[0], column_ptrs[1], column_ptrs[2], input_rows_count)))\n+            {\n+            }\n         }\n \n         if (!res)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01780_range_msan.reference b/tests/queries/0_stateless/01780_range_msan.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/01780_range_msan.sql b/tests/queries/0_stateless/01780_range_msan.sql\nnew file mode 100644\nindex 000000000000..dd0a35c3eea3\n--- /dev/null\n+++ b/tests/queries/0_stateless/01780_range_msan.sql\n@@ -0,0 +1,1 @@\n+SELECT range(toUInt256(1), 1); -- { serverError 44 }\n",
  "problem_statement": "MSan: use of uninitialized value in FunctionRange::executeImpl\nhttps://clickhouse-test-reports.s3.yandex.net/22133/33647ef3d53997b72d15df1e5abd8cf750609afc/fuzzer_msan/report.html#fail1\r\n\r\nIn debug it's a logical error.\r\n\r\n```\r\n SELECT arrayJoin(range(toUInt256(1048577), 100)) AS x FROM remote('127.0.0.2', system.one) WHERE x GLOBAL IN (SELECT toUInt8(arrayJoin(range(100)) + 50)) GROUP BY x ORDER BY x ASC NULLS FIRST LIMIT 10 FORMAT JSONCompact\r\n\r\n\r\nUninitialized bytes in __msan_check_mem_is_initialized at offset 8 inside [0x7200003ce020, 32)\r\n==42==WARNING: MemorySanitizer: use-of-uninitialized-value\r\n    #0 0x2ea9c421 in DB::ColumnConst::ColumnConst(COW<DB::IColumn>::immutable_ptr<DB::IColumn> const&, unsigned long) obj-x86_64-linux-gnu/../src/Columns/ColumnConst.cpp:41:9\r\n    #1 0x2c46ee84 in COW<DB::IColumn>::mutable_ptr<DB::ColumnConst> COWHelper<DB::IColumn, DB::ColumnConst>::create<COW<DB::IColumn>::mutable_ptr<DB::IColumn>, unsigned long&>(COW<DB::IColumn>::mutable_ptr<DB::IColumn>&&, unsigned long&) obj-x86_64-linux-gnu/../src/Common/COW.h:285:71\r\n    #2 0x2c46ee84 in DB::IDataType::createColumnConst(unsigned long, DB::Field const&) const obj-x86_64-linux-gnu/../src/DataTypes/IDataType.cpp:108:12\r\n    #3 0x266f9596 in DB::FunctionRange::executeImpl(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const (/workspace/clickhouse+0x266f9596)\r\n    #4 0x12ea3cdc in DB::IFunction::executeImplDryRun(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const (/workspace/clickhouse+0x12ea3cdc)\r\n    #5 0x12ea359c in DB::DefaultExecutable::executeDryRun(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const (/workspace/clickhouse+0x12ea359c)\r\n    #6 0x13010f45 in DB::ExecutableFunctionAdaptor::executeWithoutLowCardinalityColumns(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x13010f45)\r\n    #7 0x1300f1d3 in DB::ExecutableFunctionAdaptor::defaultImplementationForConstantArguments(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x1300f1d3)\r\n    #8 0x13010cc3 in DB::ExecutableFunctionAdaptor::executeWithoutLowCardinalityColumns(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x13010cc3)\r\n    #9 0x13013383 in DB::ExecutableFunctionAdaptor::execute(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x13013383)\r\n    #10 0x2c70b05f in DB::ActionsDAG::addFunction(std::__1::shared_ptr<DB::IFunctionOverloadResolver> const&, std::__1::vector<DB::ActionsDAG::Node const*, std::__1::allocator<DB::ActionsDAG::Node const*> >, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >) obj-x86_64-linux-gnu/../src/Interpreters/ActionsDAG.cpp:168:35\r\n    #11 0x2d810a1b in DB::ScopeStack::addFunction(std::__1::shared_ptr<DB::IFunctionOverloadResolver> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:569:51\r\n    #12 0x2d822a9c in DB::ActionsMatcher::Data::addFunction(std::__1::shared_ptr<DB::IFunctionOverloadResolver> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.h:164:27\r\n    #13 0x2d822a9c in DB::ActionsMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:1049:14\r\n    #14 0x2d812852 in DB::ActionsMatcher::visit(std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:623:9\r\n    #15 0x2d81536a in DB::ActionsMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:779:9\r\n    #16 0x2d812852 in DB::ActionsMatcher::visit(std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:623:9\r\n    #17 0x2d7be52f in DB::InDepthNodeVisitor<DB::ActionsMatcher, true, std::__1::shared_ptr<DB::IAST> const>::visit(std::__1::shared_ptr<DB::IAST> const&) obj-x86_64-linux-gnu/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #18 0x2d763cf2 in DB::ExpressionAnalyzer::getRootActionsNoMakeSet(std::__1::shared_ptr<DB::IAST> const&, bool, std::__1::shared_ptr<DB::ActionsDAG>&, bool) obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:417:48\r\n    #19 0x2d75f0bc in DB::ExpressionAnalyzer::analyzeAggregation() obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:235:21\r\n    #20 0x2d7592de in DB::ExpressionAnalyzer::ExpressionAnalyzer(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::TreeRewriterResult const> const&, DB::Context const&, unsigned long, bool, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, DB::SubqueryForSet, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, DB::SubqueryForSet> > >) obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:152:5\r\n2021.03.26 01:19:40.861948 [ 113 ] {} <Trace> SystemLog (system.query_log): Flushing system log, 448 entries to flush\r\n    #21 0x2cf8c367 in DB::SelectQueryExpressionAnalyzer::SelectQueryExpressionAnalyzer(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::TreeRewriterResult const> const&, DB::Context const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&, std::__1::unordered_set<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, bool, DB::SelectQueryOptions const&, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, DB::SubqueryForSet, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, DB::SubqueryForSet> > >) obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.h:268:11\r\n    #22 0x2cf26f51 in std::__1::__unique_if<DB::SelectQueryExpressionAnalyzer>::__unique_single std::__1::make_unique<DB::SelectQueryExpressionAnalyzer, std::__1::shared_ptr<DB::IAST>&, std::__1::shared_ptr<DB::TreeRewriterResult const>&, DB::Context&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const>&, std::__1::unordered_set<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > >, bool, DB::SelectQueryOptions&, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, DB::SubqueryForSet, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, DB::SubqueryForSet> > > >(std::__1::shared_ptr<DB::IAST>&, std::__1::shared_ptr<DB::TreeRewriterResult const>&, DB::Context&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const>&, std::__1::unordered_set<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > >&&, bool&&, DB::SelectQueryOptions&, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, DB::SubqueryForSet, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, DB::SubqueryForSet> > >&&) obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:2068:32\r\n    #23 0x2cf26f51 in DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&)::$_2::operator()(bool) const obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:414:26\r\n    #24 0x2cf16ee0 in DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&) obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:478:5\r\n    #25 0x2cf11310 in DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:160:7\r\n    #26 0x2e1923a0 in std::__1::__unique_if<DB::InterpreterSelectQuery>::__unique_single std::__1::make_unique<DB::InterpreterSelectQuery, std::__1::shared_ptr<DB::IAST> const&, DB::Context&, DB::SelectQueryOptions&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&>(std::__1::shared_ptr<DB::IAST> const&, DB::Context&, DB::SelectQueryOptions&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:2068:32\r\n    #27 0x2e1923a0 in DB::InterpreterSelectWithUnionQuery::buildCurrentChildInterpreter(std::__1::shared_ptr<DB::IAST> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:211:16\r\n    #28 0x2e18d439 in DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:133:13\r\n    #29 0x2cdfad56 in std::__1::__unique_if<DB::InterpreterSelectWithUnionQuery>::__unique_single std::__1::make_unique<DB::InterpreterSelectWithUnionQuery, std::__1::shared_ptr<DB::IAST>&, DB::Context&, DB::SelectQueryOptions const&>(std::__1::shared_ptr<DB::IAST>&, DB::Context&, DB::SelectQueryOptions const&) obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:2068:32\r\n    #30 0x2cdfad56 in DB::InterpreterFactory::get(std::__1::shared_ptr<DB::IAST>&, DB::Context&, DB::SelectQueryOptions const&) obj-x86_64-linux-gnu/../src/Interpreters/InterpreterFactory.cpp:110:16\r\n    #31 0x2e89d581 in DB::executeQueryImpl(char const*, char const*, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool, DB::ReadBuffer*) obj-x86_64-linux-gnu/../src/Interpreters/executeQuery.cpp:520:28\r\n    #32 0x2e8980e0 in DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool) obj-x86_64-linux-gnu/../src/Interpreters/executeQuery.cpp:908:30\r\n2021.03.26 01:19:40.922144 [ 113 ] {} <Debug> DiskLocal: Reserving 1.27 MiB on disk `default`, having unreserved 1.05 TiB.\r\n    #33 0x30a12f02 in DB::TCPHandler::runImpl() obj-x86_64-linux-gnu/../src/Server/TCPHandler.cpp:289:24\r\n    #34 0x30a4fe08 in DB::TCPHandler::run() obj-x86_64-linux-gnu/../src/Server/TCPHandler.cpp:1520:9\r\n    #35 0x3b59369a in Poco::Net::TCPServerConnection::start() obj-x86_64-linux-gnu/../contrib/poco/Net/src/TCPServerConnection.cpp:43:3\r\n    #36 0x3b594c84 in Poco::Net::TCPServerDispatcher::run() obj-x86_64-linux-gnu/../contrib/poco/Net/src/TCPServerDispatcher.cpp:113:19\r\n    #37 0x3ba3f525 in Poco::PooledThread::run() obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/ThreadPool.cpp:199:14\r\n    #38 0x3ba3a538 in Poco::(anonymous namespace)::RunnableHolder::run() obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Thread.cpp:55:11\r\n    #39 0x3ba3653b in Poco::ThreadImpl::runnableEntry(void*) obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Thread_POSIX.cpp:345:27\r\n    #40 0x7f3c4803c608 in start_thread /build/glibc-eX1tMB/glibc-2.31/nptl/pthread_create.c:477:8\r\n2021.03.26 01:19:40.951022 [ 113 ] {} <Trace> system.query_log (6b661c4f-2eab-40f1-b916-fc2665b7e7dc): Renaming temporary part tmp_insert_202103_240_240_0 to 202103_240_240_0.\r\n2021.03.26 01:19:40.953110 [ 113 ] {} <Trace> SystemLog (system.query_log): Flushed system log\r\n    #41 0x7f3c47f63292 in clone /build/glibc-eX1tMB/glibc-2.31/misc/../sysdeps/unix/sysv/linux/x86_64/clone.S:95\r\n  Uninitialized value was stored to memory at\r\n    #0 0x902c279 in __msan_memcpy (/workspace/clickhouse+0x902c279)\r\n2021.03.26 01:19:41.018893 [ 183 ] {} <Trace> system.text_log (2e1a0635-a0b8-492b-9c80-2ba208e22ae3): Found 7 old parts to remove.\r\n2021.03.26 01:19:41.019009 [ 183 ] {} <Debug> system.text_log (2e1a0635-a0b8-492b-9c80-2ba208e22ae3): Removing part from filesystem 202103_156_172_3\r\n2021.03.26 01:19:41.020521 [ 183 ] {} <Debug> system.text_log (2e1a0635-a0b8-492b-9c80-2ba208e22ae3): Removing part from filesystem 202103_173_173_0\r\n2021.03.26 01:19:41.020843 [ 183 ] {} <Debug> system.text_log (2e1a0635-a0b8-492b-9c80-2ba208e22ae3): Removing part from filesystem 202103_174_174_0\r\n2021.03.26 01:19:41.021118 [ 183 ] {} <Debug> system.text_log (2e1a0635-a0b8-492b-9c80-2ba208e22ae3): Removing part from filesystem 202103_175_175_0\r\n2021.03.26 01:19:41.021403 [ 183 ] {} <Debug> system.text_log (2e1a0635-a0b8-492b-9c80-2ba208e22ae3): Removing part from filesystem 202103_176_176_0\r\n2021.03.26 01:19:41.021681 [ 183 ] {} <Debug> system.text_log (2e1a0635-a0b8-492b-9c80-2ba208e22ae3): Removing part from filesystem 202103_177_177_0\r\n2021.03.26 01:19:41.021958 [ 183 ] {} <Debug> system.text_log (2e1a0635-a0b8-492b-9c80-2ba208e22ae3): Removing part from filesystem 202103_178_178_0\r\n    #1 0x2eed2a1e in void DB::PODArray<wide::integer<256ul, unsigned int>, 4096ul, Allocator<false, false>, 15ul, 16ul>::push_back<wide::integer<256ul, unsigned int> >(wide::integer<256ul, unsigned int>&&) obj-x86_64-linux-gnu/../src/Common/PODArray.h:437:23\r\n    #2 0x2eed2a1e in DB::ColumnVector<wide::integer<256ul, unsigned int> >::insert(DB::Field const&) obj-x86_64-linux-gnu/../src/Columns/ColumnVector.h:264:14\r\n    #3 0x2c46ed78 in DB::IDataType::createColumnConst(unsigned long, DB::Field const&) const obj-x86_64-linux-gnu/../src/DataTypes/IDataType.cpp:107:13\r\n    #4 0x266f9596 in DB::FunctionRange::executeImpl(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const (/workspace/clickhouse+0x266f9596)\r\n    #5 0x12ea3cdc in DB::IFunction::executeImplDryRun(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const (/workspace/clickhouse+0x12ea3cdc)\r\n    #6 0x12ea359c in DB::DefaultExecutable::executeDryRun(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const (/workspace/clickhouse+0x12ea359c)\r\n    #7 0x13010f45 in DB::ExecutableFunctionAdaptor::executeWithoutLowCardinalityColumns(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x13010f45)\r\n    #8 0x1300f1d3 in DB::ExecutableFunctionAdaptor::defaultImplementationForConstantArguments(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x1300f1d3)\r\n    #9 0x13010cc3 in DB::ExecutableFunctionAdaptor::executeWithoutLowCardinalityColumns(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x13010cc3)\r\n    #10 0x13013383 in DB::ExecutableFunctionAdaptor::execute(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x13013383)\r\n    #11 0x2c70b05f in DB::ActionsDAG::addFunction(std::__1::shared_ptr<DB::IFunctionOverloadResolver> const&, std::__1::vector<DB::ActionsDAG::Node const*, std::__1::allocator<DB::ActionsDAG::Node const*> >, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >) obj-x86_64-linux-gnu/../src/Interpreters/ActionsDAG.cpp:168:35\r\n    #12 0x2d810a1b in DB::ScopeStack::addFunction(std::__1::shared_ptr<DB::IFunctionOverloadResolver> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:569:51\r\n    #13 0x2d822a9c in DB::ActionsMatcher::Data::addFunction(std::__1::shared_ptr<DB::IFunctionOverloadResolver> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.h:164:27\r\n    #14 0x2d822a9c in DB::ActionsMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:1049:14\r\n    #15 0x2d812852 in DB::ActionsMatcher::visit(std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:623:9\r\n    #16 0x2d81536a in DB::ActionsMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:779:9\r\n    #17 0x2d812852 in DB::ActionsMatcher::visit(std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:623:9\r\n    #18 0x2d7be52f in DB::InDepthNodeVisitor<DB::ActionsMatcher, true, std::__1::shared_ptr<DB::IAST> const>::visit(std::__1::shared_ptr<DB::IAST> const&) obj-x86_64-linux-gnu/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #19 0x2d763cf2 in DB::ExpressionAnalyzer::getRootActionsNoMakeSet(std::__1::shared_ptr<DB::IAST> const&, bool, std::__1::shared_ptr<DB::ActionsDAG>&, bool) obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:417:48\r\n    #20 0x2d75f0bc in DB::ExpressionAnalyzer::analyzeAggregation() obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:235:21\r\n    #21 0x2d7592de in DB::ExpressionAnalyzer::ExpressionAnalyzer(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::TreeRewriterResult const> const&, DB::Context const&, unsigned long, bool, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, DB::SubqueryForSet, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, DB::SubqueryForSet> > >) obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:152:5\r\n\r\n  Uninitialized value was stored to memory at\r\n    #0 0x902c279 in __msan_memcpy (/workspace/clickhouse+0x902c279)\r\n    #1 0x2eed29a6 in wide::integer<256ul, unsigned int> DB::get<wide::integer<256ul, unsigned int> >(DB::Field const&) obj-x86_64-linux-gnu/../src/Core/Field.h:815:12\r\n    #2 0x2eed29a6 in DB::ColumnVector<wide::integer<256ul, unsigned int> >::insert(DB::Field const&) obj-x86_64-linux-gnu/../src/Columns/ColumnVector.h:264:24\r\n    #3 0x2c46ed78 in DB::IDataType::createColumnConst(unsigned long, DB::Field const&) const obj-x86_64-linux-gnu/../src/DataTypes/IDataType.cpp:107:13\r\n    #4 0x266f9596 in DB::FunctionRange::executeImpl(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const (/workspace/clickhouse+0x266f9596)\r\n    #5 0x12ea3cdc in DB::IFunction::executeImplDryRun(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const (/workspace/clickhouse+0x12ea3cdc)\r\n    #6 0x12ea359c in DB::DefaultExecutable::executeDryRun(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const (/workspace/clickhouse+0x12ea359c)\r\n    #7 0x13010f45 in DB::ExecutableFunctionAdaptor::executeWithoutLowCardinalityColumns(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x13010f45)\r\n    #8 0x1300f1d3 in DB::ExecutableFunctionAdaptor::defaultImplementationForConstantArguments(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x1300f1d3)\r\n    #9 0x13010cc3 in DB::ExecutableFunctionAdaptor::executeWithoutLowCardinalityColumns(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x13010cc3)\r\n    #10 0x13013383 in DB::ExecutableFunctionAdaptor::execute(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long, bool) const (/workspace/clickhouse+0x13013383)\r\n    #11 0x2c70b05f in DB::ActionsDAG::addFunction(std::__1::shared_ptr<DB::IFunctionOverloadResolver> const&, std::__1::vector<DB::ActionsDAG::Node const*, std::__1::allocator<DB::ActionsDAG::Node const*> >, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >) obj-x86_64-linux-gnu/../src/Interpreters/ActionsDAG.cpp:168:35\r\n    #12 0x2d810a1b in DB::ScopeStack::addFunction(std::__1::shared_ptr<DB::IFunctionOverloadResolver> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:569:51\r\n    #13 0x2d822a9c in DB::ActionsMatcher::Data::addFunction(std::__1::shared_ptr<DB::IFunctionOverloadResolver> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.h:164:27\r\n    #14 0x2d822a9c in DB::ActionsMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:1049:14\r\n    #15 0x2d812852 in DB::ActionsMatcher::visit(std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:623:9\r\n    #16 0x2d81536a in DB::ActionsMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:779:9\r\n    #17 0x2d812852 in DB::ActionsMatcher::visit(std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:623:9\r\n    #18 0x2d7be52f in DB::InDepthNodeVisitor<DB::ActionsMatcher, true, std::__1::shared_ptr<DB::IAST> const>::visit(std::__1::shared_ptr<DB::IAST> const&) obj-x86_64-linux-gnu/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #19 0x2d763cf2 in DB::ExpressionAnalyzer::getRootActionsNoMakeSet(std::__1::shared_ptr<DB::IAST> const&, bool, std::__1::shared_ptr<DB::ActionsDAG>&, bool) obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:417:48\r\n    #20 0x2d75f0bc in DB::ExpressionAnalyzer::analyzeAggregation() obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:235:21\r\n    #21 0x2d7592de in DB::ExpressionAnalyzer::ExpressionAnalyzer(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::TreeRewriterResult const> const&, DB::Context const&, unsigned long, bool, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, DB::SubqueryForSet, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, DB::SubqueryForSet> > >) obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:152:5\r\n\r\n  Uninitialized value was created by an allocation of 'ref.tmp143' in the stack frame of function '_ZNK2DB13FunctionRange11executeImplERKNSt3__16vectorINS_21ColumnWithTypeAndNameENS1_9allocatorIS3_EEEERKNS1_10shared_ptrIKNS_9IDataTypeEEEm'\r\n    #0 0x266f7ff0 in DB::FunctionRange::executeImpl(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&, std::__1::shared_ptr<DB::IDataType const> const&, unsigned long) const (/workspace/clickhouse+0x266f7ff0)\r\n\r\nSUMMARY: MemorySanitizer: use-of-uninitialized-value obj-x86_64-linux-gnu/../src/Columns/ColumnConst.cpp:41:9 in DB::ColumnConst::ColumnConst(COW<DB::IColumn>::immutable_ptr<DB::IColumn> const&, unsigned long)\r\nExiting\r\n\r\n\n",
  "hints_text": "It's trivially reproducible and I have MSan build at this moment of time... Will dig it.\nAs UInt256 is involved, I change the classification from \"bug\" to \"bug experimental\".\n`SELECT range(toUInt256(1), 1)`",
  "created_at": "2021-03-31T00:56:34Z",
  "modified_files": [
    "src/Functions/array/range.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01780_range_msan.sql"
  ]
}