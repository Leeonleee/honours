{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 2064,
  "instance_id": "ClickHouse__ClickHouse-2064",
  "issue_numbers": [
    "2044"
  ],
  "base_commit": "1656eafd8ce561c66829455f59e8044d50b65055",
  "patch": "diff --git a/dbms/src/Interpreters/ExpressionAnalyzer.cpp b/dbms/src/Interpreters/ExpressionAnalyzer.cpp\nindex f0bc81370290..411c868d6f0e 100644\n--- a/dbms/src/Interpreters/ExpressionAnalyzer.cpp\n+++ b/dbms/src/Interpreters/ExpressionAnalyzer.cpp\n@@ -980,7 +980,8 @@ void ExpressionAnalyzer::normalizeTreeImpl(\n         /// `IN t` can be specified, where t is a table, which is equivalent to `IN (SELECT * FROM t)`.\n         if (functionIsInOrGlobalInOperator(func_node->name))\n             if (ASTIdentifier * right = typeid_cast<ASTIdentifier *>(func_node->arguments->children.at(1).get()))\n-                right->kind = ASTIdentifier::Table;\n+                if (!aliases.count(right->name))\n+                    right->kind = ASTIdentifier::Table;\n \n         /// Special cases for count function.\n         String func_name_lowercase = Poco::toLower(func_node->name);\n",
  "test_patch": "diff --git a/dbms/tests/queries/0_stateless/00172_constexprs_in_set.reference b/dbms/tests/queries/0_stateless/00172_constexprs_in_set.reference\nindex c06d3de5a560..ac284bbc084e 100644\n--- a/dbms/tests/queries/0_stateless/00172_constexprs_in_set.reference\n+++ b/dbms/tests/queries/0_stateless/00172_constexprs_in_set.reference\n@@ -4,3 +4,4 @@\n 1\n 1\n 1\n+1\t0\ndiff --git a/dbms/tests/queries/0_stateless/00172_constexprs_in_set.sql b/dbms/tests/queries/0_stateless/00172_constexprs_in_set.sql\nindex 3c4384170539..5d79185ee8d2 100644\n--- a/dbms/tests/queries/0_stateless/00172_constexprs_in_set.sql\n+++ b/dbms/tests/queries/0_stateless/00172_constexprs_in_set.sql\n@@ -4,3 +4,4 @@ SELECT toDate('2015-06-12') IN (toDate('2015-06-12'));\n SELECT today() IN (toDate('2014-01-01'), toDate(now()));\n SELECT - -1 IN (2 - 1);\n SELECT - -1 IN (2 - 1, 3);\n+WITH (1, 2) AS a SELECT 1 IN a, 3 IN a;\n",
  "problem_statement": "\u041f\u0440\u043e\u0431\u043b\u0435\u043c\u0430 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u044f WITH \u0438 IN\n\u0422\u0430\u043a \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 http://prntscr.com/ir4x95, \u0430 \u0442\u0430\u043a https://prnt.sc/iqztsa - \u043d\u0435\u0442. \u0412 \u0434\u043e\u043a\u0435 \u043d\u0430\u043f\u0438\u0441\u0430\u043d\u043e \u0442\u0430\u043a\u043e\u0435 https://prnt.sc/iqzyh2, \u043d\u043e \u0434\u043e\u043b\u0436\u043d\u043e \u043b\u0438 \u043f\u0430\u0434\u0430\u0442\u044c \u0441 \u043e\u0448\u0438\u0431\u043a\u043e\u0439?\n",
  "hints_text": "test case to reproduce that error message (not sure if it's correct)\r\n```\r\nwith ['a','b','c'] as w select arrayFilter(x -> x IN w, c) FROM ( select ['a','b','c','d','e','f','g','h'] c ) ;\r\nCode: 60, e.displayText() = DB::Exception: Table default.w doesn't exist., e.what() = DB::Exception\r\n```\r\n\r\nworkaround (use has instead of IN)\r\n```\r\nwith ['a','b','c'] as w select arrayFilter(x -> has(w,x), c) FROM ( select ['a','b','c','d','e','f','g','h'] c ) ;\r\n```\nThe problem is even simpler `with ['a'] as w select 'a' IN w`\nUsing of arrays as the second argument of IN operator is prohibited: https://clickhouse.yandex/docs/en/single/#in-operators\r\nSo, the query has to fail for this reason.\r\n\r\nBut an arguable question about the following queries remains:\r\n```\r\nwith ('a') as w select 'a' IN w\r\nwith tuple('a') as w select 'a' IN w\r\n```\r\nThey don't for the same reason.\r\nShould they work (and should aliases be allowed for tuples and Sets)?",
  "created_at": "2018-03-15T18:42:25Z"
}