{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 29573,
  "instance_id": "ClickHouse__ClickHouse-29573",
  "issue_numbers": [
    "29184"
  ],
  "base_commit": "ffc4614f30a1bcba0718a82b3935ecba8652bdf3",
  "patch": "diff --git a/src/Interpreters/AddDefaultDatabaseVisitor.h b/src/Interpreters/AddDefaultDatabaseVisitor.h\nindex 63d026c9767a..3d93118047fd 100644\n--- a/src/Interpreters/AddDefaultDatabaseVisitor.h\n+++ b/src/Interpreters/AddDefaultDatabaseVisitor.h\n@@ -138,7 +138,12 @@ class AddDefaultDatabaseVisitor\n                         /// XXX: for some unknown reason this place assumes that argument can't be an alias,\n                         ///      like in the similar code in `MarkTableIdentifierVisitor`.\n                         if (auto * identifier = child->children[i]->as<ASTIdentifier>())\n-                            child->children[i] = identifier->createTable();\n+                        {\n+                            /// If identifier is broken then we can do nothing and get an exception\n+                            auto maybe_table_identifier = identifier->createTable();\n+                            if (maybe_table_identifier)\n+                                child->children[i] = maybe_table_identifier;\n+                        }\n \n                         /// Second argument of the \"in\" function (or similar) may be a table name or a subselect.\n                         /// Rewrite the table name or descend into subselect.\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02041_test_fuzzy_alter.reference b/tests/queries/0_stateless/02041_test_fuzzy_alter.reference\nnew file mode 100644\nindex 000000000000..d00491fd7e5b\n--- /dev/null\n+++ b/tests/queries/0_stateless/02041_test_fuzzy_alter.reference\n@@ -0,0 +1,1 @@\n+1\ndiff --git a/tests/queries/0_stateless/02041_test_fuzzy_alter.sql b/tests/queries/0_stateless/02041_test_fuzzy_alter.sql\nnew file mode 100644\nindex 000000000000..a330defc3164\n--- /dev/null\n+++ b/tests/queries/0_stateless/02041_test_fuzzy_alter.sql\n@@ -0,0 +1,13 @@\n+DROP TABLE IF EXISTS alter_table;\n+\n+CREATE TABLE alter_table (a UInt8, b Int16)\n+ENGINE = MergeTree\n+ORDER BY a;\n+\n+ALTER TABLE alter_table\n+    MODIFY COLUMN `b` DateTime DEFAULT now(([NULL, NULL, NULL, [-2147483648], [NULL, NULL, NULL, NULL, NULL, NULL, NULL]] AND (1048576 AND NULL) AND (NULL AND 1048575 AND NULL AND -2147483649) AND NULL) IN (test_01103.t1_distr.id)); --{serverError 47}\n+\n+SELECT 1;\n+\n+\n+DROP TABLE IF EXISTS alter_table;\n",
  "problem_statement": "Reference to nullptr in ALTER\n**Describe the bug**\r\nhttps://clickhouse-test-reports.s3.yandex.net/29183/6cf8509ab5da4229b5b1f6b96ff1f162b213e271/fuzzer_ubsan/report.html#fail1\r\n\r\n**How to reproduce**\r\n```\r\nALTER TABLE alter_test MODIFY COLUMN `b` DateTime DEFAULT now(([NULL, NULL, NULL, [-2147483648], [NULL, NULL, NULL, NULL, NULL, NULL, NULL]] AND (1048576 AND NULL) AND (NULL AND 1048575 AND NULL AND -2147483649) AND NULL) IN (test_01103.t1_distr.id))\r\n```\r\n\r\n`Changed settings: receive_timeout = '10', receive_data_timeout_ms = '10000', count_distinct_implementation = 'uniqTheta', max_result_rows = '10', optimize_injective_functions_inside_uniq = '0'`\n",
  "hints_text": "",
  "created_at": "2021-09-30T15:58:55Z",
  "modified_files": [
    "src/Interpreters/AddDefaultDatabaseVisitor.h"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02041_test_fuzzy_alter.reference",
    "b/tests/queries/0_stateless/02041_test_fuzzy_alter.sql"
  ]
}