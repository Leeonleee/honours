{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 43086,
  "instance_id": "ClickHouse__ClickHouse-43086",
  "issue_numbers": [
    "42856"
  ],
  "base_commit": "f54cce72690d4dfd1d92d3279eec6b893bd4a8f7",
  "patch": "diff --git a/src/Core/MySQL/MySQLReplication.cpp b/src/Core/MySQL/MySQLReplication.cpp\nindex 6f3ac1b40e95..b211d746a2fd 100644\n--- a/src/Core/MySQL/MySQLReplication.cpp\n+++ b/src/Core/MySQL/MySQLReplication.cpp\n@@ -118,7 +118,7 @@ namespace MySQLReplication\n         }\n         else if (query.starts_with(\"SAVEPOINT\"))\n         {\n-            throw ReplicationError(\"ParseQueryEvent: Unsupported query event:\" + query, ErrorCodes::LOGICAL_ERROR);\n+            typ = QUERY_SAVEPOINT;\n         }\n     }\n \n@@ -941,6 +941,7 @@ namespace MySQLReplication\n                 {\n                     case QUERY_EVENT_MULTI_TXN_FLAG:\n                     case QUERY_EVENT_XA:\n+                    case QUERY_SAVEPOINT:\n                     {\n                         event = std::make_shared<DryRunEvent>(std::move(query->header));\n                         break;\ndiff --git a/src/Core/MySQL/MySQLReplication.h b/src/Core/MySQL/MySQLReplication.h\nindex 8900eee01021..5825924d10b1 100644\n--- a/src/Core/MySQL/MySQLReplication.h\n+++ b/src/Core/MySQL/MySQLReplication.h\n@@ -368,7 +368,8 @@ namespace MySQLReplication\n     {\n         QUERY_EVENT_DDL = 0,\n         QUERY_EVENT_MULTI_TXN_FLAG = 1,\n-        QUERY_EVENT_XA = 2\n+        QUERY_EVENT_XA = 2,\n+        QUERY_SAVEPOINT = 3,\n     };\n \n     class QueryEvent : public EventBase\n",
  "test_patch": "diff --git a/tests/integration/test_materialized_mysql_database/materialize_with_ddl.py b/tests/integration/test_materialized_mysql_database/materialize_with_ddl.py\nindex 22d4633685ea..c6f2f80c2fe0 100644\n--- a/tests/integration/test_materialized_mysql_database/materialize_with_ddl.py\n+++ b/tests/integration/test_materialized_mysql_database/materialize_with_ddl.py\n@@ -2151,3 +2151,20 @@ def materialized_database_mysql_date_type_to_date32(\n         \"SELECT b from test_database.a order by a FORMAT TSV\",\n         \"1970-01-01\\n1971-02-16\\n2101-05-16\\n2022-02-16\\n\" + \"2104-06-06\\n\",\n     )\n+\n+\n+def savepoint(clickhouse_node, mysql_node, mysql_host):\n+    db = \"savepoint\"\n+    clickhouse_node.query(f\"DROP DATABASE IF EXISTS {db}\")\n+    mysql_node.query(f\"DROP DATABASE IF EXISTS {db}\")\n+    mysql_node.query(f\"CREATE DATABASE {db}\")\n+    mysql_node.query(f\"CREATE TABLE {db}.t1 (id INT PRIMARY KEY)\")\n+    clickhouse_node.query(\n+        f\"CREATE DATABASE {db} ENGINE = MaterializeMySQL('{mysql_host}:3306', '{db}', 'root', 'clickhouse')\"\n+    )\n+    mysql_node.query(\"BEGIN\")\n+    mysql_node.query(f\"INSERT INTO {db}.t1 VALUES (1)\")\n+    mysql_node.query(\"SAVEPOINT savepoint_1\")\n+    mysql_node.query(f\"INSERT INTO {db}.t1 VALUES (2)\")\n+    mysql_node.query(\"ROLLBACK TO savepoint_1\")\n+    mysql_node.query(\"COMMIT\")\ndiff --git a/tests/integration/test_materialized_mysql_database/test.py b/tests/integration/test_materialized_mysql_database/test.py\nindex a672ec72275a..0e33c01a6c92 100644\n--- a/tests/integration/test_materialized_mysql_database/test.py\n+++ b/tests/integration/test_materialized_mysql_database/test.py\n@@ -509,3 +509,10 @@ def test_materialized_database_mysql_date_type_to_date32(\n     materialize_with_ddl.materialized_database_mysql_date_type_to_date32(\n         clickhouse_node, started_mysql_5_7, \"mysql57\"\n     )\n+\n+\n+def test_savepoint_query(\n+    started_cluster, started_mysql_8_0, started_mysql_5_7, clickhouse_node\n+):\n+    materialize_with_ddl.savepoint(clickhouse_node, started_mysql_8_0, \"mysql80\")\n+    materialize_with_ddl.savepoint(clickhouse_node, started_mysql_5_7, \"mysql57\")\n",
  "problem_statement": "MaterializedMySQL got error Unsupported query event:SAVEPOINT `__EFSavePoint`\nHello! When I used MaterializedMySQL  to replicate data got this error: `Unsupported query event:SAVEPOINT __EFSavePoint`\r\nAny configurations to ignore this error and continue to replication ? \n",
  "hints_text": "Need help from @stigsb \n@stigsb \r\n\r\n- missing whitespace after colon;\r\n- SAVEPOINT is in all caps, it looks scary;\r\n- double underscore in __EFSavePoint is scary;\r\n- it's unclear what is EF;\r\n\r\nMost likely these are bad programming practices from the MySQL codebase.\nWill contribute a rewrite of MaterializedMySQL by the end of the year that also contains a fix for SAVEPOINT.",
  "created_at": "2022-11-09T12:37:39Z",
  "modified_files": [
    "src/Core/MySQL/MySQLReplication.cpp",
    "src/Core/MySQL/MySQLReplication.h"
  ],
  "modified_test_files": [
    "tests/integration/test_materialized_mysql_database/materialize_with_ddl.py",
    "tests/integration/test_materialized_mysql_database/test.py"
  ]
}