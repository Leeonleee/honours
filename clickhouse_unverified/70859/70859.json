{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 70859,
  "instance_id": "ClickHouse__ClickHouse-70859",
  "issue_numbers": [
    "70399"
  ],
  "base_commit": "1a1a920992a6cbc33ea3dc20e678b62a195b6753",
  "patch": "diff --git a/src/IO/WriteBufferFromHTTP.cpp b/src/IO/WriteBufferFromHTTP.cpp\nindex d54e16850179..4505228eda6c 100644\n--- a/src/IO/WriteBufferFromHTTP.cpp\n+++ b/src/IO/WriteBufferFromHTTP.cpp\n@@ -24,17 +24,17 @@ WriteBufferFromHTTP::WriteBufferFromHTTP(\n     request.setHost(uri.getHost());\n     request.setChunkedTransferEncoding(true);\n \n-    if (!content_type.empty())\n-    {\n-        request.set(\"Content-Type\", content_type);\n-    }\n-\n     if (!content_encoding.empty())\n         request.set(\"Content-Encoding\", content_encoding);\n \n     for (const auto & header: additional_headers)\n         request.add(header.name, header.value);\n \n+    if (!content_type.empty() && !request.has(\"Content-Type\"))\n+    {\n+        request.set(\"Content-Type\", content_type);\n+    }\n+\n     LOG_TRACE((getLogger(\"WriteBufferToHTTP\")), \"Sending request to {}\", uri.toString());\n \n     ostr = &session->sendRequest(request);\n",
  "test_patch": "diff --git a/tests/integration/test_storage_url_http_headers/test.py b/tests/integration/test_storage_url_http_headers/test.py\nindex 56585298b836..9f75c34df325 100644\n--- a/tests/integration/test_storage_url_http_headers/test.py\n+++ b/tests/integration/test_storage_url_http_headers/test.py\n@@ -114,3 +114,30 @@ def test_storage_url_redirected_headers(started_cluster):\n \n     assert \"Host: 127.0.0.1\" not in result\n     assert \"Host: localhost\" in result\n+\n+\n+def test_with_override_content_type_url_http_headers(started_cluster):\n+    query = \"INSERT INTO TABLE FUNCTION url('http://localhost:8000/', JSONEachRow, 'x UInt8') SELECT 1\"\n+\n+    server.query(query)\n+\n+    result = server.exec_in_container(\n+        [\"cat\", http_headers_echo_server.RESULT_PATH], user=\"root\"\n+    )\n+\n+    print(result)\n+\n+    assert \"Content-Type: application/x-ndjson; charset=UTF-8\" in result\n+\n+    query = \"INSERT INTO TABLE FUNCTION url('http://localhost:8000/', JSONEachRow, 'x UInt8', headers('Content-Type' = 'upyachka')) SELECT 1\"\n+\n+    server.query(query)\n+\n+    result = server.exec_in_container(\n+        [\"cat\", http_headers_echo_server.RESULT_PATH], user=\"root\"\n+    )\n+\n+    print(result)\n+\n+    assert \"Content-Type: application/x-ndjson; charset=UTF-8\" not in result\n+    assert \"Content-Type: upyachka\" in result\n",
  "problem_statement": "User-provided HTTP headers in the URL engine should override the default ones, such as Content-Type.\n```\r\n$ ch\r\n:) INSERT INTO FUNCTION url('http://localhost:5001/', JSONEachRow, 'x UInt8', headers('Content-Type' = 'upyachka')) SELECT 1\r\n```\r\n\r\n```\r\n$ nc -l localhost 5001\r\nPOST / HTTP/1.1\r\nHost: localhost\r\nTransfer-Encoding: chunked\r\nContent-Type: application/x-ndjson; charset=UTF-8\r\nContent-Type: upyachka\r\nConnection: Keep-Alive\r\nKeep-Alive: timeout=30, max=1000\r\n\r\n8\r\n{\"x\":1}\r\n\r\n0\r\n```\r\n\r\nHere you can see that the Content-Type header is duplicated.\r\nThis is what you need to fix - the user-provided header should replace the default one.\r\n\r\nPlease open another pull request.\r\n\r\n_Originally posted by @alexey-milovidov in https://github.com/ClickHouse/ClickHouse/issues/65254#issuecomment-2394929986_\r\n            \n",
  "hints_text": "",
  "created_at": "2024-10-19T20:26:20Z",
  "modified_files": [
    "src/IO/WriteBufferFromHTTP.cpp"
  ],
  "modified_test_files": [
    "tests/integration/test_storage_url_http_headers/test.py"
  ]
}