diff --git a/tests/integration/test_concurrent_queries_for_all_users_restriction/__init__.py b/tests/integration/test_concurrent_queries_for_all_users_restriction/__init__.py
new file mode 100644
index 000000000000..e69de29bb2d1
diff --git a/tests/integration/test_concurrent_queries_for_all_users_restriction/configs/user_restrictions.xml b/tests/integration/test_concurrent_queries_for_all_users_restriction/configs/user_restrictions.xml
new file mode 100644
index 000000000000..87790f2536c3
--- /dev/null
+++ b/tests/integration/test_concurrent_queries_for_all_users_restriction/configs/user_restrictions.xml
@@ -0,0 +1,38 @@
+<yandex>
+    <profiles>
+        <default>
+            <max_memory_usage>10000000000</max_memory_usage>
+            <use_uncompressed_cache>0</use_uncompressed_cache>
+            <load_balancing>random</load_balancing>
+            <max_concurrent_queries_for_all_users>2</max_concurrent_queries_for_all_users>
+        </default>
+        <someuser>
+            <max_memory_usage>10000000000</max_memory_usage>
+            <use_uncompressed_cache>0</use_uncompressed_cache>
+            <load_balancing>random</load_balancing>
+        </someuser>
+    </profiles>
+    <users>
+        <default>
+            <password></password>
+            <networks incl="networks" replace="replace">
+                <ip>::/0</ip>
+            </networks>
+            <profile>default</profile>
+            <quota>default</quota>
+        </default>
+        <someuser>
+            <password></password>
+            <networks incl="networks" replace="replace">
+                <ip>::/0</ip>
+            </networks>
+            <profile>someuser</profile>
+            <quota>default</quota>
+        </someuser>
+    </users>
+
+    <quotas>
+        <default>
+        </default>
+    </quotas>
+</yandex>
diff --git a/tests/integration/test_concurrent_queries_for_all_users_restriction/test.py b/tests/integration/test_concurrent_queries_for_all_users_restriction/test.py
new file mode 100644
index 000000000000..ac6e87cdee58
--- /dev/null
+++ b/tests/integration/test_concurrent_queries_for_all_users_restriction/test.py
@@ -0,0 +1,41 @@
+import time
+from multiprocessing.dummy import Pool
+
+import pytest
+from helpers.cluster import ClickHouseCluster
+
+cluster = ClickHouseCluster(__file__)
+
+node1 = cluster.add_instance('node1', user_configs=['configs/user_restrictions.xml'])
+
+
+@pytest.fixture(scope="module")
+def started_cluster():
+    try:
+        cluster.start()
+        node1.query("create table nums (number UInt64) ENGINE = MergeTree() order by tuple()")
+        node1.query("insert into nums values (0), (1)")
+        yield cluster
+    finally:
+        cluster.shutdown()
+
+
+def test_exception_message(started_cluster):
+    assert node1.query("select number from nums order by number") == "0
1
"
+
+    def node_busy(_):
+        for i in range(10):
+            node1.query("select sleep(2)", user='someuser', ignore_error=True)
+
+    busy_pool = Pool(3)
+    busy_pool.map_async(node_busy, range(3))
+    time.sleep(1)  # wait a little until polling starts
+
+    with pytest.raises(Exception) as exc_info:
+        for i in range(3):
+            assert node1.query("select number from remote('node1', 'default', 'nums')", user='default') == "0
1
"
+    exc_info.match("Too many simultaneous queries for all users")
+
+    for i in range(3):
+        assert node1.query("select number from remote('node1', 'default', 'nums')", user='default',
+                           settings={'max_concurrent_queries_for_all_users': 0}) == "0
1
"
