{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 63983,
  "instance_id": "ClickHouse__ClickHouse-63983",
  "issue_numbers": [
    "63943"
  ],
  "base_commit": "b1fc609e72e17b370ed66a3685d3467d836fee26",
  "patch": "diff --git a/src/Planner/PlannerExpressionAnalysis.cpp b/src/Planner/PlannerExpressionAnalysis.cpp\nindex ad8db83d66c4..6ad10d918321 100644\n--- a/src/Planner/PlannerExpressionAnalysis.cpp\n+++ b/src/Planner/PlannerExpressionAnalysis.cpp\n@@ -545,7 +545,7 @@ PlannerExpressionsAnalysisResult buildExpressionAnalysisResult(const QueryTreeNo\n           * otherwise coordinator does not find it in block.\n           */\n         NameSet required_output_nodes_names;\n-        if (sort_analysis_result_optional.has_value() && !planner_query_processing_info.isSecondStage())\n+        if (sort_analysis_result_optional.has_value() && planner_query_processing_info.isFirstStage() && planner_query_processing_info.getToStage() != QueryProcessingStage::Complete)\n         {\n             const auto & before_order_by_actions = sort_analysis_result_optional->before_order_by_actions;\n             for (const auto & output_node : before_order_by_actions->getOutputs())\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01757_optimize_skip_unused_shards_limit.sql b/tests/queries/0_stateless/01757_optimize_skip_unused_shards_limit.sql\nindex 22590a202230..3f97b9121056 100644\n--- a/tests/queries/0_stateless/01757_optimize_skip_unused_shards_limit.sql\n+++ b/tests/queries/0_stateless/01757_optimize_skip_unused_shards_limit.sql\n@@ -34,3 +34,6 @@ select * from dist_01757 where dummy in (0, 1) settings optimize_skip_unused_sha\n select * from dist_01757 where dummy in (0, 1) settings optimize_skip_unused_shards_limit=9223372036854775808; -- { serverError 69 }\n \n drop table dist_01757;\n+\n+-- fuzzed\n+SELECT * FROM remote('127.0.0.{1,2}', numbers(40), number) ORDER BY 'a' LIMIT 1 BY number SETTINGS optimize_skip_unused_shards = 1, force_optimize_skip_unused_shards=0 format Null\n",
  "problem_statement": "Not found column in block, optimize_skip_unused_shards = 1, analyzer\n```\r\nSELECT * FROM remote('127.0.0.{1,2}', numbers(40), number) ORDER BY 'a' LIMIT 1 BY number SETTINGS optimize_skip_unused_shards = 1\r\n\r\nSELECT *\r\nFROM remote('127.0.0.{1,2}', numbers(40), number)\r\nORDER BY 'a' ASC\r\nLIMIT 1 BY number\r\nSETTINGS optimize_skip_unused_shards = 1\r\n\r\nQuery id: e06483c3-f07c-425f-b6bb-a7db6663cb63\r\n\r\n\r\nElapsed: 0.016 sec. \r\n\r\nReceived exception from server (version 24.5.1):\r\nCode: 10. DB::Exception: Received from localhost:9000. DB::Exception: Not found column 'a'_String in block. There are only columns: __table1.number. (NOT_FOUND_COLUMN_IN_BLOCK)\r\n\r\n```\r\n\r\n```\r\n<Error> TCPHandler: Code: 10. DB::Exception: Not found column 'a'_String in block. There are only columns: __table1.number. (NOT_FOUND_COLUMN_IN_BLOCK), Stack trace (when copying this message, always include the lines below):\r\n\r\n0. ./contrib/llvm-project/libcxx/include/exception:141: Poco::Exception::Exception(String const&, int) @ 0x000000001191fc92\r\n1. ./build/./src/Common/Exception.cpp:101: DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000a6e86f9\r\n2. DB::Exception::Exception(PreformattedMessage&&, int) @ 0x0000000005c2cdec\r\n3. DB::Exception::Exception<String const&, String>(int, FormatStringHelperImpl<std::type_identity<String const&>::type, std::type_identity<String>::type>, String const&, String&&) @ 0x000000000643364b\r\n4. ./build/./src/Core/Block.cpp:0: DB::Block::getByName(String const&, bool) const @ 0x000000000e48804c\r\n5. ./build/./src/Processors/Merges/Algorithms/MergingSortedAlgorithm.cpp:36: DB::MergingSortedAlgorithm::MergingSortedAlgorithm(DB::Block, unsigned long, DB::SortDescription const&, unsigned long, unsigned long, DB::SortingQueueStrategy, unsigned long, DB::WriteBuffer*, bool) @ 0x0000000010b47e54\r\n6. ./src/Processors/Merges/IMergingTransform.h:92: DB::IMergingTransform<DB::MergingSortedAlgorithm>::IMergingTransform<DB::Block const&, unsigned long&, DB::SortDescription const&, unsigned long&, unsigned long&, DB::SortingQueueStrategy&, unsigned long&, DB::WriteBuffer*&, bool&>(unsigned long, DB::Block const&, DB::Block const&, bool, unsigned long, bool, DB::Block const&, unsigned long&, DB::SortDescription const&, unsigned long&, unsigned long&, DB::SortingQueueStrategy&, unsigned long&, DB::WriteBuffer*&, bool&) @ 0x0000000010b31977\r\n7. ./build/./src/Processors/Merges/MergingSortedTransform.cpp:24: DB::MergingSortedTransform::MergingSortedTransform(DB::Block const&, unsigned long, DB::SortDescription const&, unsigned long, unsigned long, DB::SortingQueueStrategy, unsigned long, bool, DB::WriteBuffer*, bool, bool, bool) @ 0x0000000010b30c72\r\n8. ./contrib/llvm-project/libcxx/include/__memory/construct_at.h:35: DB::SortingStep::mergingSorted(DB::QueryPipelineBuilder&, DB::SortDescription const&, unsigned long) @ 0x0000000010c816de\r\n9. ./build/./src/Processors/QueryPlan/ITransformingStep.cpp:0: DB::ITransformingStep::updatePipeline(std::vector<std::unique_ptr<DB::QueryPipelineBuilder, std::default_delete<DB::QueryPipelineBuilder>>, std::allocator<std::unique_ptr<DB::QueryPipelineBuilder, std::default_delete<DB::QueryPipelineBuilder>>>>, DB::BuildQueryPipelineSettings const&) @ 0x0000000010bebe0b\r\n10. ./contrib/llvm-project/libcxx/include/__memory/unique_ptr.h:302: DB::QueryPlan::buildQueryPipeline(DB::QueryPlanOptimizationSettings const&, DB::BuildQueryPipelineSettings const&) @ 0x0000000010c04046\r\n11. ./build/./src/Interpreters/InterpreterSelectQueryAnalyzer.cpp:223: DB::InterpreterSelectQueryAnalyzer::buildQueryPipeline() @ 0x000000000f433d6b\r\n12. ./contrib/llvm-project/libcxx/include/__memory/shared_ptr.h:436: DB::InterpreterSelectQueryAnalyzer::execute() @ 0x000000000f433b1e\r\n13. ./build/./src/Interpreters/executeQuery.cpp:0: DB::executeQueryImpl(char const*, char const*, std::shared_ptr<DB::Context>, DB::QueryFlags, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) @ 0x000000000f7d99ab\r\n14. ./build/./src/Interpreters/executeQuery.cpp:1392: DB::executeQuery(String const&, std::shared_ptr<DB::Context>, DB::QueryFlags, DB::QueryProcessingStage::Enum) @ 0x000000000f7d5ff5\r\n15. ./contrib/llvm-project/libcxx/include/__memory/shared_ptr.h:612: DB::TCPHandler::runImpl() @ 0x00000000107ad404\r\n16. ./contrib/llvm-project/libcxx/include/__memory/shared_ptr.h:593: DB::TCPHandler::run() @ 0x00000000107c4a39\r\n17. ./build/./base/poco/Net/src/TCPServerConnection.cpp:57: Poco::Net::TCPServerConnection::start() @ 0x000000001190e227\r\n18. ./contrib/llvm-project/libcxx/include/__memory/unique_ptr.h:48: Poco::Net::TCPServerDispatcher::run() @ 0x000000001190e6fa\r\n19. ./build/./base/poco/Foundation/src/ThreadPool.cpp:202: Poco::PooledThread::run() @ 0x00000000119751a7\r\n20. ./base/poco/Foundation/include/Poco/SharedPtr.h:139: Poco::ThreadImpl::runnableEntry(void*) @ 0x0000000011972cc3\r\n21. ? @ 0x00007fda7a65b609\r\n22. ? @ 0x00007fda7a576353\r\n\r\n\r\n```\n",
  "hints_text": "",
  "created_at": "2024-05-16T16:58:16Z"
}