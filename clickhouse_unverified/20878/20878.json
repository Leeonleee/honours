{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 20878,
  "instance_id": "ClickHouse__ClickHouse-20878",
  "issue_numbers": [
    "18926"
  ],
  "base_commit": "45119fce4f77dc96bc3edfd3b74948efb532f493",
  "patch": "diff --git a/src/Core/MySQL/PacketsProtocolText.cpp b/src/Core/MySQL/PacketsProtocolText.cpp\nindex ad34cd8c28d6..62efe549b335 100644\n--- a/src/Core/MySQL/PacketsProtocolText.cpp\n+++ b/src/Core/MySQL/PacketsProtocolText.cpp\n@@ -62,10 +62,10 @@ ColumnDefinition::ColumnDefinition()\n \n ColumnDefinition::ColumnDefinition(\n     String schema_, String table_, String org_table_, String name_, String org_name_, uint16_t character_set_, uint32_t column_length_,\n-    ColumnType column_type_, uint16_t flags_, uint8_t decimals_)\n+    ColumnType column_type_, uint16_t flags_, uint8_t decimals_, bool with_defaults_)\n     : schema(std::move(schema_)), table(std::move(table_)), org_table(std::move(org_table_)), name(std::move(name_)),\n       org_name(std::move(org_name_)), character_set(character_set_), column_length(column_length_), column_type(column_type_),\n-      flags(flags_), decimals(decimals_)\n+      flags(flags_), decimals(decimals_), is_comm_field_list_response(with_defaults_)\n {\n }\n \n@@ -77,8 +77,15 @@ ColumnDefinition::ColumnDefinition(\n \n size_t ColumnDefinition::getPayloadSize() const\n {\n-    return 12 + getLengthEncodedStringSize(\"def\") + getLengthEncodedStringSize(schema) + getLengthEncodedStringSize(table) + getLengthEncodedStringSize(org_table) + \\\n-            getLengthEncodedStringSize(name) + getLengthEncodedStringSize(org_name) + getLengthEncodedNumberSize(next_length);\n+    return 12 +\n+           getLengthEncodedStringSize(\"def\") +\n+           getLengthEncodedStringSize(schema) +\n+           getLengthEncodedStringSize(table) +\n+           getLengthEncodedStringSize(org_table) +\n+           getLengthEncodedStringSize(name) +\n+           getLengthEncodedStringSize(org_name) +\n+           getLengthEncodedNumberSize(next_length) +\n+           is_comm_field_list_response;\n }\n \n void ColumnDefinition::readPayloadImpl(ReadBuffer & payload)\n@@ -115,6 +122,13 @@ void ColumnDefinition::writePayloadImpl(WriteBuffer & buffer) const\n     buffer.write(reinterpret_cast<const char *>(&flags), 2);\n     buffer.write(reinterpret_cast<const char *>(&decimals), 1);\n     writeChar(0x0, 2, buffer);\n+    if (is_comm_field_list_response)\n+    {\n+        /// We should write length encoded int with string size\n+        /// followed by string with some \"default values\" (possibly it's column defaults).\n+        /// But we just send NULL for simplicity.\n+        writeChar(0xfb, buffer);\n+    }\n }\n \n ColumnDefinition getColumnDefinition(const String & column_name, const TypeIndex type_index)\ndiff --git a/src/Core/MySQL/PacketsProtocolText.h b/src/Core/MySQL/PacketsProtocolText.h\nindex d449e94cff1b..b54b1c5ca195 100644\n--- a/src/Core/MySQL/PacketsProtocolText.h\n+++ b/src/Core/MySQL/PacketsProtocolText.h\n@@ -101,6 +101,9 @@ class ColumnDefinition : public IMySQLWritePacket, public IMySQLReadPacket\n     ColumnType column_type;\n     uint16_t flags;\n     uint8_t decimals = 0x00;\n+    /// https://dev.mysql.com/doc/internals/en/com-query-response.html#column-definition\n+    /// There are extra fields in the packet for column defaults\n+    bool is_comm_field_list_response = false;\n \n protected:\n     size_t getPayloadSize() const override;\n@@ -114,7 +117,7 @@ class ColumnDefinition : public IMySQLWritePacket, public IMySQLReadPacket\n \n     ColumnDefinition(\n         String schema_, String table_, String org_table_, String name_, String org_name_, uint16_t character_set_, uint32_t column_length_,\n-        ColumnType column_type_, uint16_t flags_, uint8_t decimals_);\n+        ColumnType column_type_, uint16_t flags_, uint8_t decimals_, bool with_defaults_ = false);\n \n     /// Should be used when column metadata (original name, table, original table, database) is unknown.\n     ColumnDefinition(\ndiff --git a/src/Server/MySQLHandler.cpp b/src/Server/MySQLHandler.cpp\nindex 3cbe285615e4..ea2813cf6390 100644\n--- a/src/Server/MySQLHandler.cpp\n+++ b/src/Server/MySQLHandler.cpp\n@@ -289,7 +289,7 @@ void MySQLHandler::comFieldList(ReadBuffer & payload)\n     for (const NameAndTypePair & column : metadata_snapshot->getColumns().getAll())\n     {\n         ColumnDefinition column_definition(\n-            database, packet.table, packet.table, column.name, column.name, CharacterSet::binary, 100, ColumnType::MYSQL_TYPE_STRING, 0, 0\n+            database, packet.table, packet.table, column.name, column.name, CharacterSet::binary, 100, ColumnType::MYSQL_TYPE_STRING, 0, 0, true\n         );\n         packet_endpoint->sendPacket(column_definition);\n     }\n",
  "test_patch": "diff --git a/docker/test/fasttest/run.sh b/docker/test/fasttest/run.sh\nindex e6294b5d74d9..7e7c81169011 100755\n--- a/docker/test/fasttest/run.sh\n+++ b/docker/test/fasttest/run.sh\n@@ -259,6 +259,7 @@ function run_tests\n         00929_multi_match_edit_distance\n         01681_hyperscan_debug_assertion\n \n+        01176_mysql_client_interactive          # requires mysql client\n         01031_mutations_interpreter_and_context\n         01053_ssd_dictionary # this test mistakenly requires acces to /var/lib/clickhouse -- can't run this locally, disabled\n         01083_expressions_in_engine_arguments\ndiff --git a/docker/test/stateless/Dockerfile b/docker/test/stateless/Dockerfile\nindex b063f8d81f61..ba3355db89bd 100644\n--- a/docker/test/stateless/Dockerfile\n+++ b/docker/test/stateless/Dockerfile\n@@ -3,6 +3,9 @@ FROM yandex/clickhouse-test-base\n \n ARG odbc_driver_url=\"https://github.com/ClickHouse/clickhouse-odbc/releases/download/v1.1.4.20200302/clickhouse-odbc-1.1.4-Linux.tar.gz\"\n \n+RUN echo \"deb [trusted=yes] http://repo.mysql.com/apt/ubuntu/ bionic mysql-5.7\" >> /etc/apt/sources.list \\\n+    && apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 8C718D3B5072E1F5\n+\n RUN apt-get update -y \\\n     && env DEBIAN_FRONTEND=noninteractive \\\n         apt-get install --yes --no-install-recommends \\\n@@ -23,7 +26,8 @@ RUN apt-get update -y \\\n             telnet \\\n             tree \\\n             unixodbc \\\n-            wget\n+            wget \\\n+            mysql-client=5.7*\n \n RUN pip3 install numpy scipy pandas\n \ndiff --git a/tests/queries/0_stateless/01176_mysql_client_interactive.expect b/tests/queries/0_stateless/01176_mysql_client_interactive.expect\nnew file mode 100755\nindex 000000000000..d592bbe1ce21\n--- /dev/null\n+++ b/tests/queries/0_stateless/01176_mysql_client_interactive.expect\n@@ -0,0 +1,26 @@\n+#!/usr/bin/expect -f\n+\n+log_user 0\n+set timeout 5\n+match_max 100000\n+# A default timeout action is to do nothing, change it to fail\n+expect_after {\n+    timeout {\n+        exit 1\n+    }\n+}\n+\n+set basedir [file dirname $argv0]\n+spawn bash -c \"source $basedir/../shell_config.sh ; \\$MYSQL_CLIENT_BINARY \\$MYSQL_CLIENT_OPT\"\n+expect \"mysql> \"\n+\n+send -- \"USE system;\\r\"\n+expect \"Database changed\"\n+\n+send -- \"SELECT * FROM one;\\r\"\n+expect \"| dummy |\"\n+expect \"|     0 |\"\n+expect \"1 row in set\"\n+\n+send -- \"quit;\\r\"\n+expect eof\ndiff --git a/tests/queries/0_stateless/01176_mysql_client_interactive.reference b/tests/queries/0_stateless/01176_mysql_client_interactive.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/shell_config.sh b/tests/queries/shell_config.sh\nindex eed77fb107d7..d20b5669cc5e 100644\n--- a/tests/queries/shell_config.sh\n+++ b/tests/queries/shell_config.sh\n@@ -54,6 +54,8 @@ export CLICKHOUSE_PORT_HTTP=${CLICKHOUSE_PORT_HTTP:=\"8123\"}\n export CLICKHOUSE_PORT_HTTPS=${CLICKHOUSE_PORT_HTTPS:=$(${CLICKHOUSE_EXTRACT_CONFIG} --try --key=https_port 2>/dev/null)} 2>/dev/null\n export CLICKHOUSE_PORT_HTTPS=${CLICKHOUSE_PORT_HTTPS:=\"8443\"}\n export CLICKHOUSE_PORT_HTTP_PROTO=${CLICKHOUSE_PORT_HTTP_PROTO:=\"http\"}\n+export CLICKHOUSE_PORT_MYSQL=${CLICKHOUSE_PORT_MYSQL:=$(${CLICKHOUSE_EXTRACT_CONFIG} --try --key=mysql_port 2>/dev/null)} 2>/dev/null\n+export CLICKHOUSE_PORT_MYSQL=${CLICKHOUSE_PORT_MYSQL:=\"9004\"}\n \n # Add database and log comment to url params\n if [ -v CLICKHOUSE_URL_PARAMS ]\n@@ -87,6 +89,17 @@ export CLICKHOUSE_CURL=${CLICKHOUSE_CURL:=\"${CLICKHOUSE_CURL_COMMAND} -q -s --ma\n export CLICKHOUSE_TMP=${CLICKHOUSE_TMP:=\".\"}\n mkdir -p ${CLICKHOUSE_TMP}\n \n+export MYSQL_CLIENT_BINARY=${MYSQL_CLIENT_BINARY:=\"mysql\"}\n+export MYSQL_CLIENT_CLICKHOUSE_USER=${MYSQL_CLIENT_CLICKHOUSE_USER:=\"default\"}\n+# Avoids \"Can't connect to local MySQL server through socket '/var/run/mysqld/mysqld.sock'\" when connecting to localhost\n+[ -v CLICKHOUSE_HOST ] && MYSQL_CLIENT_OPT0+=\" --protocol tcp \"\n+[ -v CLICKHOUSE_HOST ] && MYSQL_CLIENT_OPT0+=\" --host ${CLICKHOUSE_HOST} \"\n+[ -v CLICKHOUSE_PORT_MYSQL ] && MYSQL_CLIENT_OPT0+=\" --port ${CLICKHOUSE_PORT_MYSQL} \"\n+[ -v CLICKHOUSE_DATABASE ] && MYSQL_CLIENT_OPT0+=\" --database ${CLICKHOUSE_DATABASE} \"\n+MYSQL_CLIENT_OPT0+=\" --user ${MYSQL_CLIENT_CLICKHOUSE_USER} \"\n+export MYSQL_CLIENT_OPT=\"${MYSQL_CLIENT_OPT0:-} ${MYSQL_CLIENT_OPT:-}\"\n+export MYSQL_CLIENT=${MYSQL_CLIENT:=\"$MYSQL_CLIENT_BINARY ${MYSQL_CLIENT_OPT:-}\"}\n+\n function clickhouse_client_removed_host_parameter()\n {\n     # removing only `--host=value` and `--host value` (removing '-hvalue' feels to dangerous) with python regex.\n",
  "problem_statement": "MYSQL protocol reading table information error after USE database query.\n**Describe the bug**\r\nIf you would change database with ```USE database``` command via mysql protocol and have auto completion enabled, you would get an error.\r\n\r\n**How to reproduce**\r\nClickhouse 20.13.1.5517\r\nmysql client 8.0\r\n```\r\nmysql --host 127.0.0.1 --port 9004 --user default\r\n\r\nWelcome to the MySQL monitor.  Commands end with ; or \\g.\r\nYour MySQL connection id is 4\r\nServer version: 20.13.1.5517-ClickHouse 0\r\n\r\nCopyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.\r\n\r\nOracle is a registered trademark of Oracle Corporation and/or its\r\naffiliates. Other names may be trademarks of their respective\r\nowners.\r\n\r\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\r\n\r\nmysql> SHOW TABLES;\r\n23 rows in set (0.01 sec)\r\nRead 23 rows, 776.00 B in 0.0084032 sec., 2737 rows/sec., 90.18 KiB/sec.\r\n\r\nmysql> SHOW DATABASES;\r\n+-----------+\r\n| name      |\r\n+-----------+\r\n| default   |\r\n| model     |\r\n| system    |\r\n| test      |\r\n+-----------+\r\n6 rows in set (0.00 sec)\r\nRead 6 rows, 879.00 B in 0.002237 sec., 2682 rows/sec., 383.73 KiB/sec.\r\n\r\nmysql> USE system\r\nReading table information for completion of table and column names\r\nYou can turn off this feature to get a quicker startup with -A\r\n\r\nDatabase changed\r\nmysql> SELECT 1;\r\nERROR 2006 (HY000): MySQL server has gone away\r\nNo connection. Trying to reconnect...\r\nConnection id:    5\r\nCurrent database: system\r\n\r\nERROR 2006 (HY000): MySQL server has gone away\r\nNo connection. Trying to reconnect...\r\nConnection id:    6\r\nCurrent database: system\r\n\r\nERROR 2006 (HY000): MySQL server has gone away\r\n```\r\n\r\nIf we would disable auto completion with -A cli arg.\r\n\r\n```\r\nmysql --host 127.0.0.1 --port 9004 --user default -A\r\nWelcome to the MySQL monitor.  Commands end with ; or \\g.\r\nYour MySQL connection id is 11\r\nServer version: 20.13.1.5517-ClickHouse 0\r\n\r\nCopyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.\r\n\r\nOracle is a registered trademark of Oracle Corporation and/or its\r\naffiliates. Other names may be trademarks of their respective\r\nowners.\r\n\r\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\r\n\r\nmysql> USE system\r\nDatabase changed, 1 warning\r\nmysql> SELECT 1;\r\n+------+\r\n| 1    |\r\n+------+\r\n|    1 |\r\n+------+\r\n1 row in set (0.01 sec)\r\nRead 1 rows, 1.00 B in 0.0013077 sec., 764 rows/sec., 764.70 B/sec.\r\n\r\nmysql> SHOW TABLES;\r\n75 rows in set (0.00 sec)\r\nRead 75 rows, 2.61 KiB in 0.0053943 sec., 13903 rows/sec., 483.91 KiB/sec.\r\n\r\n```\r\n**Expected behavior**\r\nIt's possible to change databases with ```USE database``` command in mysql client works with autocomplete enabled.\r\n\r\n**Error message and/or stacktrace**\r\n```\r\n2021.01.11 14:43:38.721310 [ 4371 ] {} <Debug> MySQLHandler: Received command: 4. Connection id: 21.\r\n2021.01.11 14:43:38.721427 [ 4371 ] {} <Debug> MySQLHandler: Received command: 4. Connection id: 21.\r\n2021.01.11 14:43:38.721590 [ 4371 ] {} <Error> MySQLHandler: DB::Exception: Cannot read all data. Bytes read: 0. Bytes expected: 3.\r\n\r\n2021.01.11 14:43:36.306221 [ 4372 ] {} <Error> MySQLHandler: DB::Exception: Cannot read all data. Bytes read: 0. Bytes expected: 3.\r\n2021.01.11 14:43:38.712040 [ 4372 ] {} <Error> MySQLHandler: DB::Exception: Cannot read all data. Bytes read: 0. Bytes expected: 3.\r\n2021.01.11 14:43:38.721590 [ 4371 ] {} <Error> MySQLHandler: DB::Exception: Cannot read all data. Bytes read: 0. Bytes expected: 3.\r\n\r\n```\r\n\r\n**Additional context**\r\nIf you would pass database name in mysql args, you need to disable auto completion too.\r\n\r\n```\r\n\r\n mysql --host 127.0.0.1 --port 9004 --user default --database default\r\n \r\n mysql> SELECT 1;\r\nERROR 2006 (HY000): MySQL server has gone away\r\nNo connection. Trying to reconnect...\r\nConnection id:    35\r\nCurrent database: default\r\n\r\nERROR 2006 (HY000): MySQL server has gone away\r\nNo connection. Trying to reconnect...\r\nConnection id:    36\r\nCurrent database: default\r\n\r\nERROR 2006 (HY000): MySQL server has gone away\r\n\r\nmysql --host 127.0.0.1 --port 9004 --user default --database default -A\r\n\r\nmysql> SELECT 1;\r\n+------+\r\n| 1    |\r\n+------+\r\n|    1 |\r\n+------+\r\n1 row in set (0.00 sec)\r\nRead 1 rows, 1.00 B in 0.0012839 sec., 778 rows/sec., 778.88 B/sec.\r\n```\n",
  "hints_text": "",
  "created_at": "2021-02-18T13:33:11Z"
}