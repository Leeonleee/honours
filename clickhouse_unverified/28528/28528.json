{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 28528,
  "instance_id": "ClickHouse__ClickHouse-28528",
  "issue_numbers": [
    "28515"
  ],
  "base_commit": "c832a41dff09b5c8d87942974b08b172679ff8cf",
  "patch": "diff --git a/src/Storages/MergeTree/ReplicatedMergeTreeTableMetadata.cpp b/src/Storages/MergeTree/ReplicatedMergeTreeTableMetadata.cpp\nindex db1c2bc89af0..0637a6bb0272 100644\n--- a/src/Storages/MergeTree/ReplicatedMergeTreeTableMetadata.cpp\n+++ b/src/Storages/MergeTree/ReplicatedMergeTreeTableMetadata.cpp\n@@ -46,7 +46,15 @@ ReplicatedMergeTreeTableMetadata::ReplicatedMergeTreeTableMetadata(const MergeTr\n \n     primary_key = formattedAST(metadata_snapshot->getPrimaryKey().expression_list_ast);\n     if (metadata_snapshot->isPrimaryKeyDefined())\n-        sorting_key = formattedAST(metadata_snapshot->getSortingKey().expression_list_ast);\n+    {\n+        /// We don't use preparsed AST `sorting_key.expression_list_ast` because\n+        /// it contain version column for VersionedCollapsingMergeTree, which\n+        /// is not stored in ZooKeeper for compatibility reasons. So the best\n+        /// compatible way is just to convert definition_ast to list and\n+        /// serialize it. In all other places key.expression_list_ast should be\n+        /// used.\n+        sorting_key = formattedAST(extractKeyExpressionList(metadata_snapshot->getSortingKey().definition_ast));\n+    }\n \n     data_format_version = data.format_version;\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01526_alter_add_and_modify_order_zookeeper.reference b/tests/queries/0_stateless/01526_alter_add_and_modify_order_zookeeper.reference\nindex 4063d93d542c..1dcd3543d4e9 100644\n--- a/tests/queries/0_stateless/01526_alter_add_and_modify_order_zookeeper.reference\n+++ b/tests/queries/0_stateless/01526_alter_add_and_modify_order_zookeeper.reference\n@@ -1,6 +1,6 @@\n 2019-10-01\ta\t1\taa\t1\t1\t1\n 2019-10-01\ta\t1\taa\t1\t1\t1\t0\n-CREATE TABLE default.table_for_alter\\n(\\n    `d` Date,\\n    `a` String,\\n    `b` UInt8,\\n    `x` String,\\n    `y` Int8,\\n    `version` UInt64,\\n    `sign` Int8 DEFAULT 1,\\n    `order` UInt32\\n)\\nENGINE = ReplicatedVersionedCollapsingMergeTree(\\'/clickhouse/tables/01526_alter_add/t1\\', \\'1\\', sign, version)\\nPARTITION BY y\\nPRIMARY KEY d\\nORDER BY (d, order)\\nSETTINGS index_granularity = 8192\n+CREATE TABLE default.table_for_alter\\n(\\n    `d` Date,\\n    `a` String,\\n    `b` UInt8,\\n    `x` String,\\n    `y` Int8,\\n    `version` UInt64,\\n    `sign` Int8 DEFAULT 1,\\n    `order` UInt32\\n)\\nENGINE = ReplicatedVersionedCollapsingMergeTree(\\'/clickhouse/tables/default/01526_alter_add/t1\\', \\'1\\', sign, version)\\nPARTITION BY y\\nPRIMARY KEY d\\nORDER BY (d, order)\\nSETTINGS index_granularity = 8192\n 2019-10-01\ta\t1\taa\t1\t1\t1\t0\t0\n 2019-10-02\tb\t2\tbb\t2\t2\t2\t1\t2\n-CREATE TABLE default.table_for_alter\\n(\\n    `d` Date,\\n    `a` String,\\n    `b` UInt8,\\n    `x` String,\\n    `y` Int8,\\n    `version` UInt64,\\n    `sign` Int8 DEFAULT 1,\\n    `order` UInt32,\\n    `datum` UInt32\\n)\\nENGINE = ReplicatedVersionedCollapsingMergeTree(\\'/clickhouse/tables/01526_alter_add/t1\\', \\'1\\', sign, version)\\nPARTITION BY y\\nPRIMARY KEY d\\nORDER BY (d, order, datum)\\nSETTINGS index_granularity = 8192\n+CREATE TABLE default.table_for_alter\\n(\\n    `d` Date,\\n    `a` String,\\n    `b` UInt8,\\n    `x` String,\\n    `y` Int8,\\n    `version` UInt64,\\n    `sign` Int8 DEFAULT 1,\\n    `order` UInt32,\\n    `datum` UInt32\\n)\\nENGINE = ReplicatedVersionedCollapsingMergeTree(\\'/clickhouse/tables/default/01526_alter_add/t1\\', \\'1\\', sign, version)\\nPARTITION BY y\\nPRIMARY KEY d\\nORDER BY (d, order, datum)\\nSETTINGS index_granularity = 8192\ndiff --git a/tests/queries/0_stateless/01526_alter_add_and_modify_order_zookeeper.sql b/tests/queries/0_stateless/01526_alter_add_and_modify_order_zookeeper.sql\nindex b718ba199c17..db8c2de09504 100644\n--- a/tests/queries/0_stateless/01526_alter_add_and_modify_order_zookeeper.sql\n+++ b/tests/queries/0_stateless/01526_alter_add_and_modify_order_zookeeper.sql\n@@ -12,17 +12,27 @@ CREATE TABLE table_for_alter\n     `version` UInt64,\n     `sign` Int8 DEFAULT 1\n )\n-ENGINE = ReplicatedVersionedCollapsingMergeTree('/clickhouse/tables/01526_alter_add/t1', '1', sign, version)\n+ENGINE = ReplicatedVersionedCollapsingMergeTree('/clickhouse/tables/{database}/01526_alter_add/t1', '1', sign, version)\n PARTITION BY y\n ORDER BY d\n SETTINGS index_granularity = 8192;\n \n INSERT INTO table_for_alter VALUES(toDate('2019-10-01'), 'a', 1, 'aa', 1, 1, 1);\n \n+DETACH TABLE table_for_alter;\n+\n+ATTACH TABLE table_for_alter;\n+\n+\n SELECT * FROM table_for_alter;\n \n ALTER TABLE table_for_alter ADD COLUMN order UInt32, MODIFY ORDER BY (d, order);\n \n+\n+DETACH TABLE table_for_alter;\n+\n+ATTACH TABLE table_for_alter;\n+\n SELECT * FROM table_for_alter;\n \n SHOW CREATE TABLE table_for_alter;\n@@ -35,4 +45,8 @@ SELECT * FROM table_for_alter ORDER BY d;\n \n SHOW CREATE TABLE table_for_alter;\n \n+DETACH TABLE table_for_alter;\n+\n+ATTACH TABLE table_for_alter;\n+\n DROP TABLE IF EXISTS table_for_alter;\n",
  "problem_statement": "Server fails after restarting: Existing table metadata in ZooKeeper differs in sorting key expression.\nHow to reproduce (this is the part of 01526_alter_add_and_modify_order_zookeeper test):\r\n\r\n```sql\r\nCREATE TABLE table_for_alter\r\n(\r\n    `d` Date,\r\n    `a` String,\r\n    `b` UInt8,\r\n    `x` String,\r\n    `y` Int8,\r\n    `version` UInt64,\r\n    `sign` Int8 DEFAULT 1\r\n)\r\nENGINE = ReplicatedVersionedCollapsingMergeTree('/clickhouse/tables/01526_alter_add/t4', '1', sign, version)\r\nPARTITION BY y\r\nORDER BY d\r\nSETTINGS index_granularity = 8192;\r\n\r\nINSERT INTO table_for_alter VALUES(toDate('2019-10-01'), 'a', 1, 'aa', 1, 1, 1);\r\n\r\nALTER TABLE table_for_alter ADD COLUMN order UInt32, MODIFY ORDER BY (d, order);\r\n```\r\n\r\nAfter restarting server it fails with the error:\r\n```\r\n<Error> Application: DB::Exception: Existing table metadata in ZooKeeper differs in sorting key expression. Stored in ZooKeeper: d, order, local: d, order, version: Cannot attach table `default`.`table_for_alter` from metadata file /home/avogar/ClickHouse/programs/server/store/379/3795dcee-cc60-41ab-b795-dceecc6001ab/table_for_alter.sql from query ATTACH TABLE default.table_for_alter UUID 'b7e7470c-6fcb-4a95-b7e7-470c6fcbda95' (`d` Date, `a` String, `b` UInt8, `x` String, `y` Int8, `version` UInt64, `sign` Int8 DEFAULT 1, `order` UInt32) ENGINE = ReplicatedVersionedCollapsingMergeTree('/clickhouse/tables/01526_alter_add/t4', '1', sign, version) PARTITION BY y PRIMARY KEY d ORDER BY (d, order) SETTINGS index_granularity = 8192: while loading database `default` from path ./metadata/default\r\n```\n",
  "hints_text": "",
  "created_at": "2021-09-02T14:48:49Z"
}