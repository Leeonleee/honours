{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 32755,
  "instance_id": "ClickHouse__ClickHouse-32755",
  "issue_numbers": [
    "32737"
  ],
  "base_commit": "233505b665f4f266405289246fd99a3775188742",
  "patch": "diff --git a/src/Functions/fuzzBits.cpp b/src/Functions/fuzzBits.cpp\nindex eb2af22d1ab9..8b54026724d9 100644\n--- a/src/Functions/fuzzBits.cpp\n+++ b/src/Functions/fuzzBits.cpp\n@@ -18,6 +18,7 @@ namespace ErrorCodes\n     extern const int ILLEGAL_COLUMN;\n     extern const int DECIMAL_OVERFLOW;\n     extern const int ARGUMENT_OUT_OF_BOUND;\n+    extern const int LOGICAL_ERROR;\n }\n \n \n@@ -142,6 +143,7 @@ class FunctionFuzzBits : public IFunction\n         else if (const ColumnFixedString * col_in_fixed = checkAndGetColumn<ColumnFixedString>(col_in_untyped.get()))\n         {\n             const auto n = col_in_fixed->getN();\n+            const auto col_in_rows = col_in_fixed->size();\n             auto col_to = ColumnFixedString::create(n);\n             ColumnFixedString::Chars & chars_to = col_to->getChars();\n \n@@ -153,7 +155,16 @@ class FunctionFuzzBits : public IFunction\n \n             const auto * ptr_in = col_in_fixed->getChars().data();\n             auto * ptr_to = chars_to.data();\n-            fuzzBits(ptr_in, ptr_to, chars_to.size(), inverse_probability);\n+\n+            if (col_in_rows >= input_rows_count)\n+                fuzzBits(ptr_in, ptr_to, chars_to.size(), inverse_probability);\n+            else if (col_in_rows != 1)\n+                throw Exception(\n+                    ErrorCodes::LOGICAL_ERROR,\n+                    \"1 != col_in_rows {} < input_rows_count {}\", col_in_rows, input_rows_count);\n+            else\n+                for (size_t i = 0; i < input_rows_count; ++i)\n+                    fuzzBits(ptr_in, ptr_to + i * n, n, inverse_probability);\n \n             return col_to;\n         }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02148_issue_32737.reference b/tests/queries/0_stateless/02148_issue_32737.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02148_issue_32737.sql b/tests/queries/0_stateless/02148_issue_32737.sql\nnew file mode 100644\nindex 000000000000..c8fbac457e73\n--- /dev/null\n+++ b/tests/queries/0_stateless/02148_issue_32737.sql\n@@ -0,0 +1,3 @@\n+SELECT fuzzBits(toFixedString('', 200), 0.99) from numbers(1) FORMAT Null;\n+SELECT fuzzBits(toFixedString('', 200), 0.99) from numbers(128) FORMAT Null;\n+SELECT fuzzBits(toFixedString('', 200), 0.99) from numbers(60000) FORMAT Null;\n",
  "problem_statement": "Crash in function `fuzzBits`\n```\r\nSELECT fuzzBits(toFixedString('', 200), 0.5) FROM system.numbers FORMAT Null\r\n```\n",
  "hints_text": "",
  "created_at": "2021-12-14T15:31:01Z"
}