{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 13396,
  "instance_id": "ClickHouse__ClickHouse-13396",
  "issue_numbers": [
    "13198"
  ],
  "base_commit": "a92438eff26294f4b95358922815930fd632c5ac",
  "patch": "diff --git a/src/Processors/Transforms/FinishSortingTransform.cpp b/src/Processors/Transforms/FinishSortingTransform.cpp\nindex b58b008339db..29d0170d9077 100644\n--- a/src/Processors/Transforms/FinishSortingTransform.cpp\n+++ b/src/Processors/Transforms/FinishSortingTransform.cpp\n@@ -25,23 +25,16 @@ FinishSortingTransform::FinishSortingTransform(\n     const SortDescription & description_to_sort_,\n     size_t max_merged_block_size_, UInt64 limit_)\n     : SortingTransform(header, description_to_sort_, max_merged_block_size_, limit_)\n-    , description_sorted(description_sorted_)\n {\n-    const auto & sample = inputs.front().getHeader();\n-\n-    /// Replace column names to column position in description_sorted.\n-    for (auto & column_description : description_sorted)\n-    {\n-        if (!column_description.column_name.empty())\n-        {\n-            column_description.column_number = sample.getPositionByName(column_description.column_name);\n-            column_description.column_name.clear();\n-        }\n-    }\n-\n-    if (!isPrefix(description_sorted, description))\n-        throw Exception(\"Can`t finish sorting. SortDescription of already sorted stream is not prefix of \"\n+    /// Check for sanity non-modified descriptions\n+    if (!isPrefix(description_sorted_, description_to_sort_))\n+        throw Exception(\"Can't finish sorting. SortDescription of already sorted stream is not prefix of \"\n             \"SortDescription needed to sort\", ErrorCodes::LOGICAL_ERROR);\n+\n+    /// The target description is modified in SortingTransform constructor.\n+    /// To avoid doing the same actions with description_sorted just copy it from prefix of target description.\n+    size_t prefix_size = description_sorted_.size();\n+    description_sorted.assign(description.begin(), description.begin() + prefix_size);\n }\n \n static bool less(const Columns & lhs, const Columns & rhs, size_t i, size_t j, const SortDescription & descr)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01431_finish_sorting_with_consts.reference b/tests/queries/0_stateless/01431_finish_sorting_with_consts.reference\nnew file mode 100644\nindex 000000000000..1627e09150f1\n--- /dev/null\n+++ b/tests/queries/0_stateless/01431_finish_sorting_with_consts.reference\n@@ -0,0 +1,3 @@\n+1\t2020-05-05 01:00:00\t0\n+1\t2020-05-05 01:00:00\t1\n+1\t2020-05-05 01:00:00\t2\ndiff --git a/tests/queries/0_stateless/01431_finish_sorting_with_consts.sql b/tests/queries/0_stateless/01431_finish_sorting_with_consts.sql\nnew file mode 100644\nindex 000000000000..8071f4f6cedf\n--- /dev/null\n+++ b/tests/queries/0_stateless/01431_finish_sorting_with_consts.sql\n@@ -0,0 +1,7 @@\n+DROP TABLE IF EXISTS pk_func;\n+\n+CREATE TABLE pk_func (`d` DateTime, `ui` UInt32 ) ENGINE = MergeTree ORDER BY toDate(d);\n+INSERT INTO pk_func SELECT '2020-05-05 01:00:00', number FROM numbers(1000);\n+SELECT 1, * FROM pk_func ORDER BY toDate(d) ASC, ui ASC LIMIT 3;\n+\n+DROP TABLE IF EXISTS pk_func;\n",
  "problem_statement": "Assertion failure in FinishSorting.\nSee https://github.com/ClickHouse/ClickHouse/pull/13193\n",
  "hints_text": "Queries, that lead to assertion:\r\n\r\n```\r\nCREATE TABLE pk_func (`d` DateTime, `ui` UInt32 ) ENGINE = MergeTree ORDER BY toDate(d);\r\nINSERT INTO pk_func SELECT '2020-05-05 01:00:00', number FROM numbers(1000000);\r\nSELECT NULL, * FROM pk_func ORDER BY toDate(d) ASC, ui ASC LIMIT 1;\r\n```",
  "created_at": "2020-08-05T23:39:38Z",
  "modified_files": [
    "src/Processors/Transforms/FinishSortingTransform.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01431_finish_sorting_with_consts.reference",
    "b/tests/queries/0_stateless/01431_finish_sorting_with_consts.sql"
  ]
}