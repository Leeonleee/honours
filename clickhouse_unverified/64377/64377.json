{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 64377,
  "instance_id": "ClickHouse__ClickHouse-64377",
  "issue_numbers": [
    "63701"
  ],
  "base_commit": "2f1fb6c5d83d08e904dae1e1e8d4bd2297d2a0f3",
  "patch": "diff --git a/src/Analyzer/ValidationUtils.cpp b/src/Analyzer/ValidationUtils.cpp\nindex c142a0c7cc0b..a8274799b1b3 100644\n--- a/src/Analyzer/ValidationUtils.cpp\n+++ b/src/Analyzer/ValidationUtils.cpp\n@@ -412,7 +412,21 @@ void validateTreeSize(const QueryTreeNodePtr & node,\n         if (processed_children)\n         {\n             ++tree_size;\n-            node_to_tree_size.emplace(node_to_process, tree_size);\n+\n+            size_t subtree_size = 1;\n+            for (const auto & node_to_process_child : node_to_process->getChildren())\n+            {\n+                if (!node_to_process_child)\n+                    continue;\n+\n+                subtree_size += node_to_tree_size[node_to_process_child];\n+            }\n+\n+            auto * constant_node = node_to_process->as<ConstantNode>();\n+            if (constant_node && constant_node->hasSourceExpression())\n+                subtree_size += node_to_tree_size[constant_node->getSourceExpression()];\n+\n+            node_to_tree_size.emplace(node_to_process, subtree_size);\n             continue;\n         }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03164_analyzer_validate_tree_size.reference b/tests/queries/0_stateless/03164_analyzer_validate_tree_size.reference\nnew file mode 100644\nindex 000000000000..d00491fd7e5b\n--- /dev/null\n+++ b/tests/queries/0_stateless/03164_analyzer_validate_tree_size.reference\n@@ -0,0 +1,1 @@\n+1\ndiff --git a/tests/queries/0_stateless/03164_analyzer_validate_tree_size.sql b/tests/queries/0_stateless/03164_analyzer_validate_tree_size.sql\nnew file mode 100644\nindex 000000000000..0e581592aef2\n--- /dev/null\n+++ b/tests/queries/0_stateless/03164_analyzer_validate_tree_size.sql\n@@ -0,0 +1,1007 @@\n+CREATE TABLE t\n+(\n+c1\tInt64\t,\n+c2\tInt64\t,\n+c3\tInt64\t,\n+c4\tInt64\t,\n+c5\tInt64\t,\n+c6\tInt64\t,\n+c7\tInt64\t,\n+c8\tInt64\t,\n+c9\tInt64\t,\n+c10\tInt64\t,\n+c11\tInt64\t,\n+c12\tInt64\t,\n+c13\tInt64\t,\n+c14\tInt64\t,\n+c15\tInt64\t,\n+c16\tInt64\t,\n+c17\tInt64\t,\n+c18\tInt64\t,\n+c19\tInt64\t,\n+c20\tInt64\t,\n+c21\tInt64\t,\n+c22\tInt64\t,\n+c23\tInt64\t,\n+c24\tInt64\t,\n+c25\tInt64\t,\n+c26\tInt64\t,\n+c27\tInt64\t,\n+c28\tInt64\t,\n+c29\tInt64\t,\n+c30\tInt64\t,\n+c31\tInt64\t,\n+c32\tInt64\t,\n+c33\tInt64\t,\n+c34\tInt64\t,\n+c35\tInt64\t,\n+c36\tInt64\t,\n+c37\tInt64\t,\n+c38\tInt64\t,\n+c39\tInt64\t,\n+c40\tInt64\t,\n+c41\tInt64\t,\n+c42\tInt64\t,\n+c43\tInt64\t,\n+c44\tInt64\t,\n+c45\tInt64\t,\n+c46\tInt64\t,\n+c47\tInt64\t,\n+c48\tInt64\t,\n+c49\tInt64\t,\n+c50\tInt64\t,\n+c51\tInt64\t,\n+c52\tInt64\t,\n+c53\tInt64\t,\n+c54\tInt64\t,\n+c55\tInt64\t,\n+c56\tInt64\t,\n+c57\tInt64\t,\n+c58\tInt64\t,\n+c59\tInt64\t,\n+c60\tInt64\t,\n+c61\tInt64\t,\n+c62\tInt64\t,\n+c63\tInt64\t,\n+c64\tInt64\t,\n+c65\tInt64\t,\n+c66\tInt64\t,\n+c67\tInt64\t,\n+c68\tInt64\t,\n+c69\tInt64\t,\n+c70\tInt64\t,\n+c71\tInt64\t,\n+c72\tInt64\t,\n+c73\tInt64\t,\n+c74\tInt64\t,\n+c75\tInt64\t,\n+c76\tInt64\t,\n+c77\tInt64\t,\n+c78\tInt64\t,\n+c79\tInt64\t,\n+c80\tInt64\t,\n+c81\tInt64\t,\n+c82\tInt64\t,\n+c83\tInt64\t,\n+c84\tInt64\t,\n+c85\tInt64\t,\n+c86\tInt64\t,\n+c87\tInt64\t,\n+c88\tInt64\t,\n+c89\tInt64\t,\n+c90\tInt64\t,\n+c91\tInt64\t,\n+c92\tInt64\t,\n+c93\tInt64\t,\n+c94\tInt64\t,\n+c95\tInt64\t,\n+c96\tInt64\t,\n+c97\tInt64\t,\n+c98\tInt64\t,\n+c99\tInt64\t,\n+c100\tInt64\t,\n+c101\tInt64\t,\n+c102\tInt64\t,\n+c103\tInt64\t,\n+c104\tInt64\t,\n+c105\tInt64\t,\n+c106\tInt64\t,\n+c107\tInt64\t,\n+c108\tInt64\t,\n+c109\tInt64\t,\n+c110\tInt64\t,\n+c111\tInt64\t,\n+c112\tInt64\t,\n+c113\tInt64\t,\n+c114\tInt64\t,\n+c115\tInt64\t,\n+c116\tInt64\t,\n+c117\tInt64\t,\n+c118\tInt64\t,\n+c119\tInt64\t,\n+c120\tInt64\t,\n+c121\tInt64\t,\n+c122\tInt64\t,\n+c123\tInt64\t,\n+c124\tInt64\t,\n+c125\tInt64\t,\n+c126\tInt64\t,\n+c127\tInt64\t,\n+c128\tInt64\t,\n+c129\tInt64\t,\n+c130\tInt64\t,\n+c131\tInt64\t,\n+c132\tInt64\t,\n+c133\tInt64\t,\n+c134\tInt64\t,\n+c135\tInt64\t,\n+c136\tInt64\t,\n+c137\tInt64\t,\n+c138\tInt64\t,\n+c139\tInt64\t,\n+c140\tInt64\t,\n+c141\tInt64\t,\n+c142\tInt64\t,\n+c143\tInt64\t,\n+c144\tInt64\t,\n+c145\tInt64\t,\n+c146\tInt64\t,\n+c147\tInt64\t,\n+c148\tInt64\t,\n+c149\tInt64\t,\n+c150\tInt64\t,\n+c151\tInt64\t,\n+c152\tInt64\t,\n+c153\tInt64\t,\n+c154\tInt64\t,\n+c155\tInt64\t,\n+c156\tInt64\t,\n+c157\tInt64\t,\n+c158\tInt64\t,\n+c159\tInt64\t,\n+c160\tInt64\t,\n+c161\tInt64\t,\n+c162\tInt64\t,\n+c163\tInt64\t,\n+c164\tInt64\t,\n+c165\tInt64\t,\n+c166\tInt64\t,\n+c167\tInt64\t,\n+c168\tInt64\t,\n+c169\tInt64\t,\n+c170\tInt64\t,\n+c171\tInt64\t,\n+c172\tInt64\t,\n+c173\tInt64\t,\n+c174\tInt64\t,\n+c175\tInt64\t,\n+c176\tInt64\t,\n+c177\tInt64\t,\n+c178\tInt64\t,\n+c179\tInt64\t,\n+c180\tInt64\t,\n+c181\tInt64\t,\n+c182\tInt64\t,\n+c183\tInt64\t,\n+c184\tInt64\t,\n+c185\tInt64\t,\n+c186\tInt64\t,\n+c187\tInt64\t,\n+c188\tInt64\t,\n+c189\tInt64\t,\n+c190\tInt64\t,\n+c191\tInt64\t,\n+c192\tInt64\t,\n+c193\tInt64\t,\n+c194\tInt64\t,\n+c195\tInt64\t,\n+c196\tInt64\t,\n+c197\tInt64\t,\n+c198\tInt64\t,\n+c199\tInt64\t,\n+c200\tInt64\t,\n+c201\tInt64\t,\n+c202\tInt64\t,\n+c203\tInt64\t,\n+c204\tInt64\t,\n+c205\tInt64\t,\n+c206\tInt64\t,\n+c207\tInt64\t,\n+c208\tInt64\t,\n+c209\tInt64\t,\n+c210\tInt64\t,\n+c211\tInt64\t,\n+c212\tInt64\t,\n+c213\tInt64\t,\n+c214\tInt64\t,\n+c215\tInt64\t,\n+c216\tInt64\t,\n+c217\tInt64\t,\n+c218\tInt64\t,\n+c219\tInt64\t,\n+c220\tInt64\t,\n+c221\tInt64\t,\n+c222\tInt64\t,\n+c223\tInt64\t,\n+c224\tInt64\t,\n+c225\tInt64\t,\n+c226\tInt64\t,\n+c227\tInt64\t,\n+c228\tInt64\t,\n+c229\tInt64\t,\n+c230\tInt64\t,\n+c231\tInt64\t,\n+c232\tInt64\t,\n+c233\tInt64\t,\n+c234\tInt64\t,\n+c235\tInt64\t,\n+c236\tInt64\t,\n+c237\tInt64\t,\n+c238\tInt64\t,\n+c239\tInt64\t,\n+c240\tInt64\t,\n+c241\tInt64\t,\n+c242\tInt64\t,\n+c243\tInt64\t,\n+c244\tInt64\t,\n+c245\tInt64\t,\n+c246\tInt64\t,\n+c247\tInt64\t,\n+c248\tInt64\t,\n+c249\tInt64\t,\n+c250\tInt64\t,\n+c251\tInt64\t,\n+c252\tInt64\t,\n+c253\tInt64\t,\n+c254\tInt64\t,\n+c255\tInt64\t,\n+c256\tInt64\t,\n+c257\tInt64\t,\n+c258\tInt64\t,\n+c259\tInt64\t,\n+c260\tInt64\t,\n+c261\tInt64\t,\n+c262\tInt64\t,\n+c263\tInt64\t,\n+c264\tInt64\t,\n+c265\tInt64\t,\n+c266\tInt64\t,\n+c267\tInt64\t,\n+c268\tInt64\t,\n+c269\tInt64\t,\n+c270\tInt64\t,\n+c271\tInt64\t,\n+c272\tInt64\t,\n+c273\tInt64\t,\n+c274\tInt64\t,\n+c275\tInt64\t,\n+c276\tInt64\t,\n+c277\tInt64\t,\n+c278\tInt64\t,\n+c279\tInt64\t,\n+c280\tInt64\t,\n+c281\tInt64\t,\n+c282\tInt64\t,\n+c283\tInt64\t,\n+c284\tInt64\t,\n+c285\tInt64\t,\n+c286\tInt64\t,\n+c287\tInt64\t,\n+c288\tInt64\t,\n+c289\tInt64\t,\n+c290\tInt64\t,\n+c291\tInt64\t,\n+c292\tInt64\t,\n+c293\tInt64\t,\n+c294\tInt64\t,\n+c295\tInt64\t,\n+c296\tInt64\t,\n+c297\tInt64\t,\n+c298\tInt64\t,\n+c299\tInt64\t,\n+c300\tInt64\t,\n+c301\tInt64\t,\n+c302\tInt64\t,\n+c303\tInt64\t,\n+c304\tInt64\t,\n+c305\tInt64\t,\n+c306\tInt64\t,\n+c307\tInt64\t,\n+c308\tInt64\t,\n+c309\tInt64\t,\n+c310\tInt64\t,\n+c311\tInt64\t,\n+c312\tInt64\t,\n+c313\tInt64\t,\n+c314\tInt64\t,\n+c315\tInt64\t,\n+c316\tInt64\t,\n+c317\tInt64\t,\n+c318\tInt64\t,\n+c319\tInt64\t,\n+c320\tInt64\t,\n+c321\tInt64\t,\n+c322\tInt64\t,\n+c323\tInt64\t,\n+c324\tInt64\t,\n+c325\tInt64\t,\n+c326\tInt64\t,\n+c327\tInt64\t,\n+c328\tInt64\t,\n+c329\tInt64\t,\n+c330\tInt64\t,\n+c331\tInt64\t,\n+c332\tInt64\t,\n+c333\tInt64\t,\n+c334\tInt64\t,\n+c335\tInt64\t,\n+c336\tInt64\t,\n+c337\tInt64\t,\n+c338\tInt64\t,\n+c339\tInt64\t,\n+c340\tInt64\t,\n+c341\tInt64\t,\n+c342\tInt64\t,\n+c343\tInt64\t,\n+c344\tInt64\t,\n+c345\tInt64\t,\n+c346\tInt64\t,\n+c347\tInt64\t,\n+c348\tInt64\t,\n+c349\tInt64\t,\n+c350\tInt64\t,\n+c351\tInt64\t,\n+c352\tInt64\t,\n+c353\tInt64\t,\n+c354\tInt64\t,\n+c355\tInt64\t,\n+c356\tInt64\t,\n+c357\tInt64\t,\n+c358\tInt64\t,\n+c359\tInt64\t,\n+c360\tInt64\t,\n+c361\tInt64\t,\n+c362\tInt64\t,\n+c363\tInt64\t,\n+c364\tInt64\t,\n+c365\tInt64\t,\n+c366\tInt64\t,\n+c367\tInt64\t,\n+c368\tInt64\t,\n+c369\tInt64\t,\n+c370\tInt64\t,\n+c371\tInt64\t,\n+c372\tInt64\t,\n+c373\tInt64\t,\n+c374\tInt64\t,\n+c375\tInt64\t,\n+c376\tInt64\t,\n+c377\tInt64\t,\n+c378\tInt64\t,\n+c379\tInt64\t,\n+c380\tInt64\t,\n+c381\tInt64\t,\n+c382\tInt64\t,\n+c383\tInt64\t,\n+c384\tInt64\t,\n+c385\tInt64\t,\n+c386\tInt64\t,\n+c387\tInt64\t,\n+c388\tInt64\t,\n+c389\tInt64\t,\n+c390\tInt64\t,\n+c391\tInt64\t,\n+c392\tInt64\t,\n+c393\tInt64\t,\n+c394\tInt64\t,\n+c395\tInt64\t,\n+c396\tInt64\t,\n+c397\tInt64\t,\n+c398\tInt64\t,\n+c399\tInt64\t,\n+c400\tInt64\t,\n+c401\tInt64\t,\n+c402\tInt64\t,\n+c403\tInt64\t,\n+c404\tInt64\t,\n+c405\tInt64\t,\n+c406\tInt64\t,\n+c407\tInt64\t,\n+c408\tInt64\t,\n+c409\tInt64\t,\n+c410\tInt64\t,\n+c411\tInt64\t,\n+c412\tInt64\t,\n+c413\tInt64\t,\n+c414\tInt64\t,\n+c415\tInt64\t,\n+c416\tInt64\t,\n+c417\tInt64\t,\n+c418\tInt64\t,\n+c419\tInt64\t,\n+c420\tInt64\t,\n+c421\tInt64\t,\n+c422\tInt64\t,\n+c423\tInt64\t,\n+c424\tInt64\t,\n+c425\tInt64\t,\n+c426\tInt64\t,\n+c427\tInt64\t,\n+c428\tInt64\t,\n+c429\tInt64\t,\n+c430\tInt64\t,\n+c431\tInt64\t,\n+c432\tInt64\t,\n+c433\tInt64\t,\n+c434\tInt64\t,\n+c435\tInt64\t,\n+c436\tInt64\t,\n+c437\tInt64\t,\n+c438\tInt64\t,\n+c439\tInt64\t,\n+c440\tInt64\t,\n+c441\tInt64\t,\n+c442\tInt64\t,\n+c443\tInt64\t,\n+c444\tInt64\t,\n+c445\tInt64\t,\n+c446\tInt64\t,\n+c447\tInt64\t,\n+c448\tInt64\t,\n+c449\tInt64\t,\n+c450\tInt64\t,\n+c451\tInt64\t,\n+c452\tInt64\t,\n+c453\tInt64\t,\n+c454\tInt64\t,\n+c455\tInt64\t,\n+c456\tInt64\t,\n+c457\tInt64\t,\n+c458\tInt64\t,\n+c459\tInt64\t,\n+c460\tInt64\t,\n+c461\tInt64\t,\n+c462\tInt64\t,\n+c463\tInt64\t,\n+c464\tInt64\t,\n+c465\tInt64\t,\n+c466\tInt64\t,\n+c467\tInt64\t,\n+c468\tInt64\t,\n+c469\tInt64\t,\n+c470\tInt64\t,\n+c471\tInt64\t,\n+c472\tInt64\t,\n+c473\tInt64\t,\n+c474\tInt64\t,\n+c475\tInt64\t,\n+c476\tInt64\t,\n+c477\tInt64\t,\n+c478\tInt64\t,\n+c479\tInt64\t,\n+c480\tInt64\t,\n+c481\tInt64\t,\n+c482\tInt64\t,\n+c483\tInt64\t,\n+c484\tInt64\t,\n+c485\tInt64\t,\n+c486\tInt64\t,\n+c487\tInt64\t,\n+c488\tInt64\t,\n+c489\tInt64\t,\n+c490\tInt64\t,\n+c491\tInt64\t,\n+c492\tInt64\t,\n+c493\tInt64\t,\n+c494\tInt64\t,\n+c495\tInt64\t,\n+c496\tInt64\t,\n+c497\tInt64\t,\n+c498\tInt64\t,\n+c499\tInt64\t,\n+c500\tInt64\t,\n+b1\tInt64\t,\n+b2\tInt64\t,\n+b3\tInt64\t,\n+b4\tInt64\t,\n+b5\tInt64\t,\n+b6\tInt64\t,\n+b7\tInt64\t,\n+b8\tInt64\t,\n+b9\tInt64\t,\n+b10\tInt64\t,\n+b11\tInt64\t,\n+b12\tInt64\t,\n+b13\tInt64\t,\n+b14\tInt64\t,\n+b15\tInt64\t,\n+b16\tInt64\t,\n+b17\tInt64\t,\n+b18\tInt64\t,\n+b19\tInt64\t,\n+b20\tInt64\t,\n+b21\tInt64\t,\n+b22\tInt64\t,\n+b23\tInt64\t,\n+b24\tInt64\t,\n+b25\tInt64\t,\n+b26\tInt64\t,\n+b27\tInt64\t,\n+b28\tInt64\t,\n+b29\tInt64\t,\n+b30\tInt64\t,\n+b31\tInt64\t,\n+b32\tInt64\t,\n+b33\tInt64\t,\n+b34\tInt64\t,\n+b35\tInt64\t,\n+b36\tInt64\t,\n+b37\tInt64\t,\n+b38\tInt64\t,\n+b39\tInt64\t,\n+b40\tInt64\t,\n+b41\tInt64\t,\n+b42\tInt64\t,\n+b43\tInt64\t,\n+b44\tInt64\t,\n+b45\tInt64\t,\n+b46\tInt64\t,\n+b47\tInt64\t,\n+b48\tInt64\t,\n+b49\tInt64\t,\n+b50\tInt64\t,\n+b51\tInt64\t,\n+b52\tInt64\t,\n+b53\tInt64\t,\n+b54\tInt64\t,\n+b55\tInt64\t,\n+b56\tInt64\t,\n+b57\tInt64\t,\n+b58\tInt64\t,\n+b59\tInt64\t,\n+b60\tInt64\t,\n+b61\tInt64\t,\n+b62\tInt64\t,\n+b63\tInt64\t,\n+b64\tInt64\t,\n+b65\tInt64\t,\n+b66\tInt64\t,\n+b67\tInt64\t,\n+b68\tInt64\t,\n+b69\tInt64\t,\n+b70\tInt64\t,\n+b71\tInt64\t,\n+b72\tInt64\t,\n+b73\tInt64\t,\n+b74\tInt64\t,\n+b75\tInt64\t,\n+b76\tInt64\t,\n+b77\tInt64\t,\n+b78\tInt64\t,\n+b79\tInt64\t,\n+b80\tInt64\t,\n+b81\tInt64\t,\n+b82\tInt64\t,\n+b83\tInt64\t,\n+b84\tInt64\t,\n+b85\tInt64\t,\n+b86\tInt64\t,\n+b87\tInt64\t,\n+b88\tInt64\t,\n+b89\tInt64\t,\n+b90\tInt64\t,\n+b91\tInt64\t,\n+b92\tInt64\t,\n+b93\tInt64\t,\n+b94\tInt64\t,\n+b95\tInt64\t,\n+b96\tInt64\t,\n+b97\tInt64\t,\n+b98\tInt64\t,\n+b99\tInt64\t,\n+b100\tInt64\t,\n+b101\tInt64\t,\n+b102\tInt64\t,\n+b103\tInt64\t,\n+b104\tInt64\t,\n+b105\tInt64\t,\n+b106\tInt64\t,\n+b107\tInt64\t,\n+b108\tInt64\t,\n+b109\tInt64\t,\n+b110\tInt64\t,\n+b111\tInt64\t,\n+b112\tInt64\t,\n+b113\tInt64\t,\n+b114\tInt64\t,\n+b115\tInt64\t,\n+b116\tInt64\t,\n+b117\tInt64\t,\n+b118\tInt64\t,\n+b119\tInt64\t,\n+b120\tInt64\t,\n+b121\tInt64\t,\n+b122\tInt64\t,\n+b123\tInt64\t,\n+b124\tInt64\t,\n+b125\tInt64\t,\n+b126\tInt64\t,\n+b127\tInt64\t,\n+b128\tInt64\t,\n+b129\tInt64\t,\n+b130\tInt64\t,\n+b131\tInt64\t,\n+b132\tInt64\t,\n+b133\tInt64\t,\n+b134\tInt64\t,\n+b135\tInt64\t,\n+b136\tInt64\t,\n+b137\tInt64\t,\n+b138\tInt64\t,\n+b139\tInt64\t,\n+b140\tInt64\t,\n+b141\tInt64\t,\n+b142\tInt64\t,\n+b143\tInt64\t,\n+b144\tInt64\t,\n+b145\tInt64\t,\n+b146\tInt64\t,\n+b147\tInt64\t,\n+b148\tInt64\t,\n+b149\tInt64\t,\n+b150\tInt64\t,\n+b151\tInt64\t,\n+b152\tInt64\t,\n+b153\tInt64\t,\n+b154\tInt64\t,\n+b155\tInt64\t,\n+b156\tInt64\t,\n+b157\tInt64\t,\n+b158\tInt64\t,\n+b159\tInt64\t,\n+b160\tInt64\t,\n+b161\tInt64\t,\n+b162\tInt64\t,\n+b163\tInt64\t,\n+b164\tInt64\t,\n+b165\tInt64\t,\n+b166\tInt64\t,\n+b167\tInt64\t,\n+b168\tInt64\t,\n+b169\tInt64\t,\n+b170\tInt64\t,\n+b171\tInt64\t,\n+b172\tInt64\t,\n+b173\tInt64\t,\n+b174\tInt64\t,\n+b175\tInt64\t,\n+b176\tInt64\t,\n+b177\tInt64\t,\n+b178\tInt64\t,\n+b179\tInt64\t,\n+b180\tInt64\t,\n+b181\tInt64\t,\n+b182\tInt64\t,\n+b183\tInt64\t,\n+b184\tInt64\t,\n+b185\tInt64\t,\n+b186\tInt64\t,\n+b187\tInt64\t,\n+b188\tInt64\t,\n+b189\tInt64\t,\n+b190\tInt64\t,\n+b191\tInt64\t,\n+b192\tInt64\t,\n+b193\tInt64\t,\n+b194\tInt64\t,\n+b195\tInt64\t,\n+b196\tInt64\t,\n+b197\tInt64\t,\n+b198\tInt64\t,\n+b199\tInt64\t,\n+b200\tInt64\t,\n+b201\tInt64\t,\n+b202\tInt64\t,\n+b203\tInt64\t,\n+b204\tInt64\t,\n+b205\tInt64\t,\n+b206\tInt64\t,\n+b207\tInt64\t,\n+b208\tInt64\t,\n+b209\tInt64\t,\n+b210\tInt64\t,\n+b211\tInt64\t,\n+b212\tInt64\t,\n+b213\tInt64\t,\n+b214\tInt64\t,\n+b215\tInt64\t,\n+b216\tInt64\t,\n+b217\tInt64\t,\n+b218\tInt64\t,\n+b219\tInt64\t,\n+b220\tInt64\t,\n+b221\tInt64\t,\n+b222\tInt64\t,\n+b223\tInt64\t,\n+b224\tInt64\t,\n+b225\tInt64\t,\n+b226\tInt64\t,\n+b227\tInt64\t,\n+b228\tInt64\t,\n+b229\tInt64\t,\n+b230\tInt64\t,\n+b231\tInt64\t,\n+b232\tInt64\t,\n+b233\tInt64\t,\n+b234\tInt64\t,\n+b235\tInt64\t,\n+b236\tInt64\t,\n+b237\tInt64\t,\n+b238\tInt64\t,\n+b239\tInt64\t,\n+b240\tInt64\t,\n+b241\tInt64\t,\n+b242\tInt64\t,\n+b243\tInt64\t,\n+b244\tInt64\t,\n+b245\tInt64\t,\n+b246\tInt64\t,\n+b247\tInt64\t,\n+b248\tInt64\t,\n+b249\tInt64\t,\n+b250\tInt64\t,\n+b251\tInt64\t,\n+b252\tInt64\t,\n+b253\tInt64\t,\n+b254\tInt64\t,\n+b255\tInt64\t,\n+b256\tInt64\t,\n+b257\tInt64\t,\n+b258\tInt64\t,\n+b259\tInt64\t,\n+b260\tInt64\t,\n+b261\tInt64\t,\n+b262\tInt64\t,\n+b263\tInt64\t,\n+b264\tInt64\t,\n+b265\tInt64\t,\n+b266\tInt64\t,\n+b267\tInt64\t,\n+b268\tInt64\t,\n+b269\tInt64\t,\n+b270\tInt64\t,\n+b271\tInt64\t,\n+b272\tInt64\t,\n+b273\tInt64\t,\n+b274\tInt64\t,\n+b275\tInt64\t,\n+b276\tInt64\t,\n+b277\tInt64\t,\n+b278\tInt64\t,\n+b279\tInt64\t,\n+b280\tInt64\t,\n+b281\tInt64\t,\n+b282\tInt64\t,\n+b283\tInt64\t,\n+b284\tInt64\t,\n+b285\tInt64\t,\n+b286\tInt64\t,\n+b287\tInt64\t,\n+b288\tInt64\t,\n+b289\tInt64\t,\n+b290\tInt64\t,\n+b291\tInt64\t,\n+b292\tInt64\t,\n+b293\tInt64\t,\n+b294\tInt64\t,\n+b295\tInt64\t,\n+b296\tInt64\t,\n+b297\tInt64\t,\n+b298\tInt64\t,\n+b299\tInt64\t,\n+b300\tInt64\t,\n+b301\tInt64\t,\n+b302\tInt64\t,\n+b303\tInt64\t,\n+b304\tInt64\t,\n+b305\tInt64\t,\n+b306\tInt64\t,\n+b307\tInt64\t,\n+b308\tInt64\t,\n+b309\tInt64\t,\n+b310\tInt64\t,\n+b311\tInt64\t,\n+b312\tInt64\t,\n+b313\tInt64\t,\n+b314\tInt64\t,\n+b315\tInt64\t,\n+b316\tInt64\t,\n+b317\tInt64\t,\n+b318\tInt64\t,\n+b319\tInt64\t,\n+b320\tInt64\t,\n+b321\tInt64\t,\n+b322\tInt64\t,\n+b323\tInt64\t,\n+b324\tInt64\t,\n+b325\tInt64\t,\n+b326\tInt64\t,\n+b327\tInt64\t,\n+b328\tInt64\t,\n+b329\tInt64\t,\n+b330\tInt64\t,\n+b331\tInt64\t,\n+b332\tInt64\t,\n+b333\tInt64\t,\n+b334\tInt64\t,\n+b335\tInt64\t,\n+b336\tInt64\t,\n+b337\tInt64\t,\n+b338\tInt64\t,\n+b339\tInt64\t,\n+b340\tInt64\t,\n+b341\tInt64\t,\n+b342\tInt64\t,\n+b343\tInt64\t,\n+b344\tInt64\t,\n+b345\tInt64\t,\n+b346\tInt64\t,\n+b347\tInt64\t,\n+b348\tInt64\t,\n+b349\tInt64\t,\n+b350\tInt64\t,\n+b351\tInt64\t,\n+b352\tInt64\t,\n+b353\tInt64\t,\n+b354\tInt64\t,\n+b355\tInt64\t,\n+b356\tInt64\t,\n+b357\tInt64\t,\n+b358\tInt64\t,\n+b359\tInt64\t,\n+b360\tInt64\t,\n+b361\tInt64\t,\n+b362\tInt64\t,\n+b363\tInt64\t,\n+b364\tInt64\t,\n+b365\tInt64\t,\n+b366\tInt64\t,\n+b367\tInt64\t,\n+b368\tInt64\t,\n+b369\tInt64\t,\n+b370\tInt64\t,\n+b371\tInt64\t,\n+b372\tInt64\t,\n+b373\tInt64\t,\n+b374\tInt64\t,\n+b375\tInt64\t,\n+b376\tInt64\t,\n+b377\tInt64\t,\n+b378\tInt64\t,\n+b379\tInt64\t,\n+b380\tInt64\t,\n+b381\tInt64\t,\n+b382\tInt64\t,\n+b383\tInt64\t,\n+b384\tInt64\t,\n+b385\tInt64\t,\n+b386\tInt64\t,\n+b387\tInt64\t,\n+b388\tInt64\t,\n+b389\tInt64\t,\n+b390\tInt64\t,\n+b391\tInt64\t,\n+b392\tInt64\t,\n+b393\tInt64\t,\n+b394\tInt64\t,\n+b395\tInt64\t,\n+b396\tInt64\t,\n+b397\tInt64\t,\n+b398\tInt64\t,\n+b399\tInt64\t,\n+b400\tInt64\t,\n+b401\tInt64\t,\n+b402\tInt64\t,\n+b403\tInt64\t,\n+b404\tInt64\t,\n+b405\tInt64\t,\n+b406\tInt64\t,\n+b407\tInt64\t,\n+b408\tInt64\t,\n+b409\tInt64\t,\n+b410\tInt64\t,\n+b411\tInt64\t,\n+b412\tInt64\t,\n+b413\tInt64\t,\n+b414\tInt64\t,\n+b415\tInt64\t,\n+b416\tInt64\t,\n+b417\tInt64\t,\n+b418\tInt64\t,\n+b419\tInt64\t,\n+b420\tInt64\t,\n+b421\tInt64\t,\n+b422\tInt64\t,\n+b423\tInt64\t,\n+b424\tInt64\t,\n+b425\tInt64\t,\n+b426\tInt64\t,\n+b427\tInt64\t,\n+b428\tInt64\t,\n+b429\tInt64\t,\n+b430\tInt64\t,\n+b431\tInt64\t,\n+b432\tInt64\t,\n+b433\tInt64\t,\n+b434\tInt64\t,\n+b435\tInt64\t,\n+b436\tInt64\t,\n+b437\tInt64\t,\n+b438\tInt64\t,\n+b439\tInt64\t,\n+b440\tInt64\t,\n+b441\tInt64\t,\n+b442\tInt64\t,\n+b443\tInt64\t,\n+b444\tInt64\t,\n+b445\tInt64\t,\n+b446\tInt64\t,\n+b447\tInt64\t,\n+b448\tInt64\t,\n+b449\tInt64\t,\n+b450\tInt64\t,\n+b451\tInt64\t,\n+b452\tInt64\t,\n+b453\tInt64\t,\n+b454\tInt64\t,\n+b455\tInt64\t,\n+b456\tInt64\t,\n+b457\tInt64\t,\n+b458\tInt64\t,\n+b459\tInt64\t,\n+b460\tInt64\t,\n+b461\tInt64\t,\n+b462\tInt64\t,\n+b463\tInt64\t,\n+b464\tInt64\t,\n+b465\tInt64\t,\n+b466\tInt64\t,\n+b467\tInt64\t,\n+b468\tInt64\t,\n+b469\tInt64\t,\n+b470\tInt64\t,\n+b471\tInt64\t,\n+b472\tInt64\t,\n+b473\tInt64\t,\n+b474\tInt64\t,\n+b475\tInt64\t,\n+b476\tInt64\t,\n+b477\tInt64\t,\n+b478\tInt64\t,\n+b479\tInt64\t,\n+b480\tInt64\t,\n+b481\tInt64\t,\n+b482\tInt64\t,\n+b483\tInt64\t,\n+b484\tInt64\t,\n+b485\tInt64\t,\n+b486\tInt64\t,\n+b487\tInt64\t,\n+b488\tInt64\t,\n+b489\tInt64\t,\n+b490\tInt64\t,\n+b491\tInt64\t,\n+b492\tInt64\t,\n+b493\tInt64\t,\n+b494\tInt64\t,\n+b495\tInt64\t,\n+b496\tInt64\t,\n+b497\tInt64\t,\n+b498\tInt64\t,\n+b499\tInt64\t,\n+b500\tInt64\t  \n+) ENGINE = Memory;\n+\n+insert into t(c1) values(1);\n+\n+SELECT count() FROM (SELECT tuple(*) FROM t);\n",
  "problem_statement": "Analyzer: DB::Exception: Received from localhost:9000. DB::Exception: Query tree is too big.\nStarting from ClickHouse 24.3, given that `experimental_analyzer` is on by default I started to get the following error:\r\n\r\n```\r\nCode: 36. DB::Exception: Received from localhost:9000. DB::Exception: Query tree is too big. Maximum: 500000. (BAD_ARGUMENTS)\r\n```\r\n\r\nI randomly get that error after executing:\r\n\r\n```sql\r\nSELECT bool, toTypeName(bool) FROM table0_fc3716d7_0be4_11ef_9a0e_31523c49d68a ORDER BY tuple(*) FORMAT JSONEachRow\r\n```\r\n\r\nI executed a lot of queries before that, where I both read from and write to a Parquet file locally. \r\n\r\nGiven that I never got this error before with the same set of queries, maybe it makes sense to have the `experimental_analyzer` turned off by default? \n",
  "hints_text": "> I randomly get that error after executing:\r\n\r\nCan you check and share system.query_log for the failing queries? Also share the table definition of the tables involved. Ideally a reproducer via https://fiddle.clickhouse.com/ is much better.\r\n\r\n> maybe it makes sense to have the experimental_analyzer turned off by default?\r\n\r\nNo. It might have bugs that we are working on fixing, but the analyzer has fixed hundreds of long standing issues in CH.\nHey @Algunenano,\r\n\r\nHere are the steps how I was able to reproduce this issue;\r\n\r\n1. Create `table_1` with Parquet engine with the following structure: https://gist.github.com/Selfeer/87edac697060fb4850a99a07cd27931b\r\n2. Insert data into all of the columns in that table\r\n3. Execute the: `cp /var/lib/clickhouse/data/default/table_1/data.Parquet /var/lib/clickhouse/user_files/table_1.Parquet`\r\n4. Create `table_2`  table with the same structure but the `ENGINE = Memory`\r\n5. Insert into the `table_2` values from the `table_1.Parquet` via this command\r\n```sql\r\nINSERT INTO table_2 FROM INFILE '/var/lib/clickhouse/user_files/table_1.Parquet' FORMAT Parquet\r\n```\r\n6. Try to select data from the newly created table\r\n```sql\r\nSELECT bool, toTypeName(bool) FROM table0_6f9f2a27_1770_11ef_a7cc_810020732561 ORDER BY tuple(*) FORMAT JSONEachRow\r\n```\r\n\r\n7. Get the following exception:\r\n``` \r\nCode: 36. DB::Exception: Received from localhost:9000. DB::Exception: Query tree is too big. Maximum: 500000. (BAD_ARGUMENTS)\r\n```\nIt simply related to the number of columns in the tuple function argument\r\n\r\nhttps://fiddle.clickhouse.com/c953f52a-f975-47c5-a038-0de2955d1ec9\r\n\r\nIt's not a real issue, it just synthetic nonsense.\r\nReal people should use `ORDER BY ALL` instead of `ORDER BY tuple(*)`\r\n\r\nThe same with `SELECT tuple(*) FROM t ` https://fiddle.clickhouse.com/8dd922f5-0fa3-485c-a4bd-339c717f3509\nThe issue is more that it doesn't throw that error if the analyzer is disabled or if we use the older versions where its off by default. \nI confirm there is a bug in the implementation of `validateTreeSize` function. The tree size for the leaf nodes is not always `1`.\r\nhttps://github.com/ClickHouse/ClickHouse/blob/4018298f73c53fa859a8edaffb5bea8de5a6e8b3/src/Analyzer/ValidationUtils.cpp#L412-L417\r\n\r\nI'll fix it. As a temporary workaround you can increase the value of `max_expanded_ast_elements` setting.",
  "created_at": "2024-05-24T15:06:29Z",
  "modified_files": [
    "src/Analyzer/ValidationUtils.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/03164_analyzer_validate_tree_size.reference",
    "b/tests/queries/0_stateless/03164_analyzer_validate_tree_size.sql"
  ]
}