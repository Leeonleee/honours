{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 73634,
  "instance_id": "ClickHouse__ClickHouse-73634",
  "issue_numbers": [
    "65205"
  ],
  "base_commit": "199890a62ac21a300f57efcd50c7cd1ddefbd0d7",
  "patch": "diff --git a/src/Interpreters/InterpreterExplainQuery.cpp b/src/Interpreters/InterpreterExplainQuery.cpp\nindex 85dd4bcc9470..4df6b79b8eab 100644\n--- a/src/Interpreters/InterpreterExplainQuery.cpp\n+++ b/src/Interpreters/InterpreterExplainQuery.cpp\n@@ -74,10 +74,8 @@ namespace\n \n         static void visit(ASTSelectQuery & select, ASTPtr & node, Data & data)\n         {\n-            /// we need to read statistic when `allow_statistics_optimize` is enabled.\n-            bool only_analyze = !data.getContext()->getSettingsRef()[Setting::allow_statistics_optimize];\n             InterpreterSelectQuery interpreter(\n-                node, data.getContext(), SelectQueryOptions(QueryProcessingStage::FetchColumns).analyze(only_analyze).modify());\n+                node, data.getContext(), SelectQueryOptions(QueryProcessingStage::FetchColumns).analyze().modify());\n \n             const SelectQueryInfo & query_info = interpreter.getQueryInfo();\n             if (query_info.view_query)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03289_explain_syntax_statistics.reference b/tests/queries/0_stateless/03289_explain_syntax_statistics.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/03289_explain_syntax_statistics.sql b/tests/queries/0_stateless/03289_explain_syntax_statistics.sql\nnew file mode 100644\nindex 000000000000..a916040c4a14\n--- /dev/null\n+++ b/tests/queries/0_stateless/03289_explain_syntax_statistics.sql\n@@ -0,0 +1,7 @@\n+create table data_01247 as system.numbers engine=Memory();\n+insert into data_01247 select * from system.numbers limit 2;\n+create table dist_01247 as data_01247 engine=Distributed(test_cluster_two_shards, currentDatabase(), data_01247, number);\n+\n+set allow_statistics_optimize = 1;\n+\n+EXPLAIN SYNTAX SELECT 'Get hierarchy', toNullable(13), count() IGNORE NULLS FROM dist_01247 GROUP BY number WITH CUBE SETTINGS distributed_group_by_no_merge = 3 FORMAT Null;\n",
  "problem_statement": "Logical error: Queries with distributed_group_by_no_merge=1 should be processed to Complete stage\nhttps://s3.amazonaws.com/clickhouse-test-reports/65184/bf04aebc948b078ba2f00dcb601e89158367422c/ast_fuzzer__ubsan_.html\r\n\r\n```\r\n4965721:2024.06.13 01:49:09.427779 [ 161 ] {b2175080-7296-4079-8822-3e16ea8831c8} <Debug> executeQuery: (from [::ffff:127.0.0.1]:49124) (comment: /workspace/ch/tests/queries/0_stateless/02899_distributed_limit_by.gen.sql) EXPLAIN SYNTAX SELECT 'dict_db_01224', 13, toUInt128(13), 13 FROM remote('127.{1,1}') WHERE (dummy + dummy) >= 0 LIMIT 10 BY (dummy + dummy) + materialize(toNullable(0)) AS l SETTINGS prefer_localhost_replica = 1, distributed_group_by_no_merge = 3, distributed_push_down_limit = 255 (stage: Complete)\r\n4965722:2024.06.13 01:49:09.428569 [ 161 ] {b2175080-7296-4079-8822-3e16ea8831c8} <Fatal> : Logical error: 'Queries with distributed_group_by_no_merge=1 should be processed to Complete stage'.\r\n```\r\n\r\ncc: @azat \n",
  "hints_text": "Interesting.\r\n\r\nFirst of all this query simply cannot fail with this error, since EXPLAIN SYNTAX does not even create interpreter, so the query_id is wrong, I hope that it could be fixed by https://github.com/ClickHouse/ClickHouse/pull/65206\r\n\r\nSo I've tried to reproduce it somehow, but without luck for now:\r\n\r\n```\r\n$ tac server.log | grep -a -o 'executeQuery: (from.*' | grep /workspace/ch/tests/queries/0_stateless/02899_distributed_limit_by.gen.sql | grep -v 'Used settings' | grep -v initial_query_id | sed -E 's#.*sql\\) (.*) \\(stage:.*#\\1;#g' | clickhouse-client --echo --ignore-error -nm |& grep LOGICAL_ERROR\r\n$ tac server.log | grep -a -o 'executeQuery: (from.*' | grep distributed_group_by_no_merge | grep -v 'Used settings' | grep -v initial_query_id | sed -E 's#.*sql\\) (.*) \\(stage:.*#\\1;#g' | clickhouse-client --echo --ignore-error -nm |& grep LOGICAL_ERROR\r\n```\nAlso here: https://s3.amazonaws.com/clickhouse-test-reports/67324/7a53a14940ae1be299305548f0d024de7f279fe3/ast_fuzzer__tsan_.html\n`01244_optimize_distributed_group_by_sharding_key.sql`:\r\n\r\n`EXPLAIN SYNTAX SELECT 'Get hierarchy', toNullable(13), count() IGNORE NULLS FROM dist_01247 GROUP BY number WITH CUBE SETTINGS distributed_group_by_no_merge = 3`\r\n\r\n```\r\nSET prefer_localhost_replica = 0;\r\nSET max_parallel_replicas = 3, cluster_for_parallel_replicas = 'test_cluster_one_shard_three_replicas_localhost', parallel_replicas_for_non_replicated_merge_tree = true;\r\nSET optimize_distributed_group_by_sharding_key = 1;\r\nSET optimize_skip_unused_shards = 1;\r\nSET max_distributed_connections = 1;\r\nSET enable_positional_arguments = 0;\r\n```\nhttps://s3.amazonaws.com/clickhouse-test-reports/0/c945209427e759dccfaff5a6af11f2e18c100390/ast_fuzzer__ubsan_.html\nhttps://s3.amazonaws.com/clickhouse-test-reports/71182/f73ff65edb2824a744462dbb4dc760fe22ee3648/ast_fuzzer__debug_.html\nhttps://s3.amazonaws.com/clickhouse-test-reports/73390/bae0e18ef7765fccc1df3fa35df5d1b52689c7cf/ast_fuzzer__debug_.html\nhttps://s3.amazonaws.com/clickhouse-test-reports/71983/ffec230fd75341fca9559e3b67db6276190c2277/ast_fuzzer__debug_.html\nRepro: https://fiddle.clickhouse.com/3c721798-36d3-4dae-bb54-30b393b2da89\r\n\r\nThe issue is related to `allow_statistics_optimize` setting and was introduced in #53240 by @hanfei1991 \r\n\r\nhttps://github.com/ClickHouse/ClickHouse/blob/660feb566e4f4052aee4c95dc4a2c30c0d46ca32/src/Interpreters/InterpreterExplainQuery.cpp#L78-L80\r\n\r\n`EXPLAIN SYNTAX` tries to interpret (not analyze) query until `FetchColumns` with `allow_statistics_optimize` is enabled.",
  "created_at": "2024-12-19T16:21:59Z"
}