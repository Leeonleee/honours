{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 47537,
  "instance_id": "ClickHouse__ClickHouse-47537",
  "issue_numbers": [
    "46704"
  ],
  "base_commit": "ee6c18cbc6f5729033b5e50492d17ff5692da8db",
  "patch": "diff --git a/src/Interpreters/inplaceBlockConversions.cpp b/src/Interpreters/inplaceBlockConversions.cpp\nindex 55d2f7ce5a8e..5bbd2667f553 100644\n--- a/src/Interpreters/inplaceBlockConversions.cpp\n+++ b/src/Interpreters/inplaceBlockConversions.cpp\n@@ -61,11 +61,17 @@ void addDefaultRequiredExpressionsRecursively(\n         RequiredSourceColumnsVisitor::Data columns_context;\n         RequiredSourceColumnsVisitor(columns_context).visit(column_default_expr);\n         NameSet required_columns_names = columns_context.requiredColumns();\n+        auto required_type = std::make_shared<ASTLiteral>(columns.get(required_column_name).type->getName());\n \n-        auto expr = makeASTFunction(\"_CAST\", column_default_expr, std::make_shared<ASTLiteral>(columns.get(required_column_name).type->getName()));\n+        auto expr = makeASTFunction(\"_CAST\", column_default_expr, required_type);\n \n         if (is_column_in_query && convert_null_to_default)\n+        {\n             expr = makeASTFunction(\"ifNull\", std::make_shared<ASTIdentifier>(required_column_name), std::move(expr));\n+            /// ifNull does not respect LowCardinality.\n+            /// It may be fixed later or re-implemented properly for identical types.\n+            expr = makeASTFunction(\"_CAST\", std::move(expr), required_type);\n+        }\n         default_expr_list_accum->children.emplace_back(setAlias(expr, required_column_name));\n \n         added_columns.emplace(required_column_name);\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02680_lc_null_as_default.reference b/tests/queries/0_stateless/02680_lc_null_as_default.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02680_lc_null_as_default.sql b/tests/queries/0_stateless/02680_lc_null_as_default.sql\nnew file mode 100644\nindex 000000000000..f6bfad377719\n--- /dev/null\n+++ b/tests/queries/0_stateless/02680_lc_null_as_default.sql\n@@ -0,0 +1,6 @@\n+drop table if exists test_null_as_default__fuzz_46;\n+SET allow_suspicious_low_cardinality_types = 1;\n+CREATE TABLE test_null_as_default__fuzz_46 (a Nullable(DateTime64(3)), b LowCardinality(Float32) DEFAULT a + 1000) ENGINE = Memory;\n+INSERT INTO test_null_as_default__fuzz_46 SELECT 1, NULL UNION ALL SELECT 2, NULL;\n+drop table test_null_as_default__fuzz_46;\n+\n",
  "problem_statement": "Logical error: block structure mismatch when inserting into Memory table with DEFAULT\n```\r\nmilovidov@milovidov-desktop:~/Downloads$ clickhouse-local \r\nClickHouse local version 23.2.1.1.\r\n\r\nmilovidov-desktop :) CREATE TABLE test_null_as_default__fuzz_46 (`a` Nullable(DateTime64(3)), `b` LowCardinality(Float32) DEFAULT a + 1000) ENGINE = Memory;\r\n\r\nCREATE TABLE test_null_as_default__fuzz_46\r\n(\r\n    `a` Nullable(DateTime64(3)),\r\n    `b` LowCardinality(Float32) DEFAULT a + 1000\r\n)\r\nENGINE = Memory\r\n\r\nQuery id: b981a570-a090-4790-835c-f611346d90c8\r\n\r\n\r\n0 rows in set. Elapsed: 0.161 sec. \r\n\r\nReceived exception:\r\nCode: 455. DB::Exception: Creating columns of type LowCardinality(Float32) is prohibited by default due to expected negative impact on performance. It can be enabled with the \"allow_suspicious_low_cardinality_types\" setting. (SUSPICIOUS_TYPE_FOR_LOW_CARDINALITY)\r\n\r\nmilovidov-desktop :) SET allow_suspicious_low_cardinality_types = 1\r\n\r\nSET allow_suspicious_low_cardinality_types = 1\r\n\r\nQuery id: 67ec54e7-b771-43a8-9057-954f8a05f7a1\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.000 sec. \r\n\r\nmilovidov-desktop :) CREATE TABLE test_null_as_default__fuzz_46 (`a` Nullable(DateTime64(3)), `b` LowCardinality(Float32) DEFAULT a + 1000) ENGINE = Memory;\r\n\r\nCREATE TABLE test_null_as_default__fuzz_46\r\n(\r\n    `a` Nullable(DateTime64(3)),\r\n    `b` LowCardinality(Float32) DEFAULT a + 1000\r\n)\r\nENGINE = Memory\r\n\r\nQuery id: 90e6e6fe-6780-4229-9d9f-a3757fbf5aef\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.000 sec. \r\n\r\nmilovidov-desktop :) INSERT INTO test_null_as_default__fuzz_46 SELECT 1, NULL UNION ALL SELECT 2, NULL;\r\n\r\nINSERT INTO test_null_as_default__fuzz_46 SELECT\r\n    1,\r\n    NULL\r\nUNION ALL\r\nSELECT\r\n    2,\r\n    NULL\r\n\r\nQuery id: d3c73a37-d3a4-4cc3-9c5e-07600198acef\r\n\r\n\r\n0 rows in set. Elapsed: 0.017 sec. \r\n\r\nReceived exception:\r\nCode: 49. DB::Exception: Block structure mismatch in function connect between ConvertingTransform and MemorySink stream: different types:\r\nb Float32 Float32(size = 0)\r\nb LowCardinality(Float32) ColumnLowCardinality(size = 0, UInt8(size = 0), ColumnUnique(size = 1, Float32(size = 1))). (LOGICAL_ERROR)\r\n\r\nmilovidov-desktop :) INSERT INTO test_null_as_default__fuzz_46 SELECT 1, NULL;\r\n\r\nINSERT INTO test_null_as_default__fuzz_46 SELECT\r\n    1,\r\n    NULL\r\n\r\nQuery id: 4b594185-5fb5-4cbb-a48c-f42c7ab38e99\r\n\r\n\r\n0 rows in set. Elapsed: 0.001 sec. \r\n\r\nReceived exception:\r\nCode: 49. DB::Exception: Block structure mismatch in function connect between ConvertingTransform and MemorySink stream: different types:\r\nb Float32 Float32(size = 0)\r\nb LowCardinality(Float32) ColumnLowCardinality(size = 0, UInt8(size = 0), ColumnUnique(size = 1, Float32(size = 1))). (LOGICAL_ERROR)\r\n```\n",
  "hints_text": "https://s3.amazonaws.com/clickhouse-test-reports/0/12525f768cd2375d6605a4cf9e2ebdcdda16dfd0/fuzzer_astfuzzerubsan/report.html\nhttps://s3.amazonaws.com/clickhouse-test-reports/47487/357dab3c62b5e0cadbfb573bc8bf470b5e86392f/fuzzer_astfuzzerasan/report.html",
  "created_at": "2023-03-13T17:59:31Z"
}