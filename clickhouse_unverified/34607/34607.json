{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 34607,
  "instance_id": "ClickHouse__ClickHouse-34607",
  "issue_numbers": [
    "31092"
  ],
  "base_commit": "2340a6c6849ebc05a8efbf97ba8de3ff9dc0eff4",
  "patch": "diff --git a/docs/en/sql-reference/functions/url-functions.md b/docs/en/sql-reference/functions/url-functions.md\nindex 98c3135f2b43..c337af9b5b34 100644\n--- a/docs/en/sql-reference/functions/url-functions.md\n+++ b/docs/en/sql-reference/functions/url-functions.md\n@@ -345,6 +345,21 @@ URLPathHierarchy('https://example.com/browse/CONV-6788') =\n ]\n ```\n \n+### encodeURLComponent(URL) {#encodeurlcomponenturl}\n+\n+Returns the encoded URL.\n+Example:\n+\n+``` sql\n+SELECT encodeURLComponent('http://127.0.0.1:8123/?query=SELECT 1;') AS EncodedURL;\n+```\n+\n+``` text\n+\u250c\u2500EncodedURL\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n+\u2502 http%3A%2F%2F127.0.0.1%3A8123%2F%3Fquery%3DSELECT%201%3B \u2502\n+\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n+```\n+\n ### decodeURLComponent(URL) {#decodeurlcomponenturl}\n \n Returns the decoded URL.\n@@ -360,6 +375,21 @@ SELECT decodeURLComponent('http://127.0.0.1:8123/?query=SELECT%201%3B') AS Decod\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n ```\n \n+### encodeURLFormComponent(URL) {#encodeurlformcomponenturl}\n+\n+Returns the encoded URL. Follows rfc-1866, space(` `) is encoded as plus(`+`).\n+Example:\n+\n+``` sql\n+SELECT encodeURLFormComponent('http://127.0.0.1:8123/?query=SELECT 1 2+3') AS EncodedURL;\n+```\n+\n+``` text\n+\u250c\u2500EncodedURL\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n+\u2502 http%3A%2F%2F127.0.0.1%3A8123%2F%3Fquery%3DSELECT+1+2%2B3 \u2502\n+\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n+```\n+\n ### decodeURLFormComponent(URL) {#decodeurlformcomponenturl}\n \n Returns the decoded URL. Follows rfc-1866, plain plus(`+`) is decoded as space(` `).\ndiff --git a/src/Functions/URL/decodeURLComponent.cpp b/src/Functions/URL/decodeURLComponent.cpp\nindex 9ed290b1832e..0125f25fb96f 100644\n--- a/src/Functions/URL/decodeURLComponent.cpp\n+++ b/src/Functions/URL/decodeURLComponent.cpp\n@@ -11,6 +11,31 @@ namespace ErrorCodes\n     extern const int ILLEGAL_COLUMN;\n }\n \n+static size_t encodeURL(const char * src, size_t src_size, char * dst, bool space_as_plus)\n+{\n+    char * dst_pos = dst;\n+    for (size_t i = 0; i < src_size - 1; i++)\n+    {\n+        if ((src[i] >= '0' && src[i] <= '9') || (src[i] >= 'a' && src[i] <= 'z') || (src[i] >= 'A' && src[i] <= 'Z')\n+            || src[i] == '-' || src[i] == '_' || src[i] == '.' || src[i] == '~')\n+        {\n+            *dst_pos++ = src[i];\n+        }\n+        else if (src[i] == ' ' && space_as_plus)\n+        {\n+            *dst_pos++ = '+';\n+        }\n+        else\n+        {\n+            *dst_pos++ = '%';\n+            *dst_pos++ = hexDigitUppercase(src[i] >> 4);\n+            *dst_pos++ = hexDigitUppercase(src[i] & 0xf);\n+        }\n+    }\n+    *dst_pos++ = src[src_size - 1];\n+    return dst_pos - dst;\n+}\n+\n /// We assume that size of the dst buf isn't less than src_size.\n static size_t decodeURL(const char * src, size_t src_size, char * dst, bool plus_as_space)\n {\n@@ -81,15 +106,24 @@ static size_t decodeURL(const char * src, size_t src_size, char * dst, bool plus\n     return dst_pos - dst;\n }\n \n+enum URLCodeStrategy\n+{\n+    encode,\n+    decode\n+};\n \n /// Percent decode of URL data.\n-template <bool plus_as_space>\n-struct DecodeURLComponentImpl\n+template <URLCodeStrategy code_strategy, bool plus_space_swap>\n+struct CodeURLComponentImpl\n {\n     static void vector(const ColumnString::Chars & data, const ColumnString::Offsets & offsets,\n         ColumnString::Chars & res_data, ColumnString::Offsets & res_offsets)\n     {\n-        res_data.resize(data.size());\n+        if (code_strategy == encode)\n+            //the destination(res_data) string is at most three times the length of the source string\n+            res_data.resize(data.size() * 3);\n+        else\n+            res_data.resize(data.size());\n         size_t size = offsets.size();\n         res_offsets.resize(size);\n \n@@ -100,8 +134,11 @@ struct DecodeURLComponentImpl\n         {\n             const char * src_data = reinterpret_cast<const char *>(&data[prev_offset]);\n             size_t src_size = offsets[i] - prev_offset;\n-            size_t dst_size = decodeURL(src_data, src_size, reinterpret_cast<char *>(res_data.data() + res_offset), plus_as_space);\n-\n+            size_t dst_size;\n+            if (code_strategy == encode)\n+                dst_size = encodeURL(src_data, src_size, reinterpret_cast<char *>(res_data.data() + res_offset), plus_space_swap);\n+            else\n+                dst_size = decodeURL(src_data, src_size, reinterpret_cast<char *>(res_data.data() + res_offset), plus_space_swap);\n             res_offset += dst_size;\n             res_offsets[i] = res_offset;\n             prev_offset = offsets[i];\n@@ -118,14 +155,20 @@ struct DecodeURLComponentImpl\n \n \n struct NameDecodeURLComponent { static constexpr auto name = \"decodeURLComponent\"; };\n+struct NameEncodeURLComponent { static constexpr auto name = \"encodeURLComponent\"; };\n struct NameDecodeURLFormComponent { static constexpr auto name = \"decodeURLFormComponent\"; };\n-using FunctionDecodeURLComponent = FunctionStringToString<DecodeURLComponentImpl<false>, NameDecodeURLComponent>;\n-using FunctionDecodeURLFormComponent = FunctionStringToString<DecodeURLComponentImpl<true>, NameDecodeURLFormComponent>;\n+struct NameEncodeURLFormComponent { static constexpr auto name = \"encodeURLFormComponent\"; };\n+using FunctionDecodeURLComponent = FunctionStringToString<CodeURLComponentImpl<decode, false>, NameDecodeURLComponent>;\n+using FunctionEncodeURLComponent = FunctionStringToString<CodeURLComponentImpl<encode, false>, NameEncodeURLComponent>;\n+using FunctionDecodeURLFormComponent = FunctionStringToString<CodeURLComponentImpl<decode, true>, NameDecodeURLFormComponent>;\n+using FunctionEncodeURLFormComponent = FunctionStringToString<CodeURLComponentImpl<encode, true>, NameEncodeURLFormComponent>;\n \n-void registerFunctionDecodeURLComponent(FunctionFactory & factory)\n+void registerFunctionEncodeAndDecodeURLComponent(FunctionFactory & factory)\n {\n     factory.registerFunction<FunctionDecodeURLComponent>();\n+    factory.registerFunction<FunctionEncodeURLComponent>();\n     factory.registerFunction<FunctionDecodeURLFormComponent>();\n+    factory.registerFunction<FunctionEncodeURLFormComponent>();\n }\n \n }\ndiff --git a/src/Functions/URL/registerFunctionsURL.cpp b/src/Functions/URL/registerFunctionsURL.cpp\nindex 91118074b7a0..91142a593f25 100644\n--- a/src/Functions/URL/registerFunctionsURL.cpp\n+++ b/src/Functions/URL/registerFunctionsURL.cpp\n@@ -27,7 +27,7 @@ void registerFunctionCutQueryString(FunctionFactory & factory);\n void registerFunctionCutFragment(FunctionFactory & factory);\n void registerFunctionCutQueryStringAndFragment(FunctionFactory & factory);\n void registerFunctionCutURLParameter(FunctionFactory & factory);\n-void registerFunctionDecodeURLComponent(FunctionFactory & factory);\n+void registerFunctionEncodeAndDecodeURLComponent(FunctionFactory & factory);\n void registerFunctionNetloc(FunctionFactory & factory);\n \n void registerFunctionsURL(FunctionFactory & factory)\n@@ -56,7 +56,7 @@ void registerFunctionsURL(FunctionFactory & factory)\n     registerFunctionCutFragment(factory);\n     registerFunctionCutQueryStringAndFragment(factory);\n     registerFunctionCutURLParameter(factory);\n-    registerFunctionDecodeURLComponent(factory);\n+    registerFunctionEncodeAndDecodeURLComponent(factory);\n     registerFunctionNetloc(factory);\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/00398_url_functions.reference b/tests/queries/0_stateless/00398_url_functions.reference\nindex e5f89fbea78d..feba95fb1b37 100644\n--- a/tests/queries/0_stateless/00398_url_functions.reference\n+++ b/tests/queries/0_stateless/00398_url_functions.reference\n@@ -59,6 +59,14 @@ query=hello world+foo+bar\n query=hello world+foo+bar\n query=hello world+foo+bar\n query=hello world foo+bar\n+\n+\n+\\N\n+\\N\n+hello%20world%20foo%2Bbar\n+hello+world+foo%2Bbar\n+http://paul@127.0.0.1/?query=hello world foo+bar\n+http://paul@127.0.0.1/?query=hello world foo+bar\n ====FRAGMENT====\n \n \n@@ -74,6 +82,10 @@ query=hello world+foo+bar#a=b\n query=hello world+foo+bar#a=b\n #a=b\n query=hello world foo+bar#a=b\n+hello%20world%20foo%2Bbar%23a%3Db\n+hello+world+foo%2Bbar%23a%3Db\n+http://paul@127.0.0.1/?query=hello world foo+bar#a=b\n+http://paul@127.0.0.1/?query=hello world foo+bar#a=b\n ====CUT TO FIRST SIGNIFICANT SUBDOMAIN====\n example.com\n example.com\ndiff --git a/tests/queries/0_stateless/00398_url_functions.sql b/tests/queries/0_stateless/00398_url_functions.sql\nindex ea71ed226d70..66fe591bb588 100644\n--- a/tests/queries/0_stateless/00398_url_functions.sql\n+++ b/tests/queries/0_stateless/00398_url_functions.sql\n@@ -64,6 +64,14 @@ SELECT decodeURLComponent(queryString('http://127.0.0.1:443/?query=hello%20world\n SELECT decodeURLComponent(queryString('http://paul@127.0.0.1:443/?query=hello%20world+foo%2Bbar'));\n SELECT decodeURLComponent(queryString('//paul@127.0.0.1:443/?query=hello%20world+foo%2Bbar'));\n SELECT decodeURLFormComponent(queryString('//paul@127.0.0.1:443/?query=hello%20world+foo%2Bbar'));\n+SELECT encodeURLComponent('');\n+SELECT encodeURLFormComponent('');\n+SELECT encodeURLComponent(NULL);\n+SELECT encodeURLFormComponent(NULL);\n+SELECT encodeURLComponent('hello world foo+bar');\n+SELECT encodeURLFormComponent('hello world foo+bar');\n+SELECT decodeURLComponent(encodeURLComponent('http://paul@127.0.0.1/?query=hello world foo+bar'));\n+SELECT decodeURLFormComponent(encodeURLFormComponent('http://paul@127.0.0.1/?query=hello world foo+bar'));\n \n SELECT '====FRAGMENT====';\n SELECT decodeURLComponent(fragment('http://127.0.0.1/?query=hello%20world+foo%2Bbar'));\n@@ -81,6 +89,10 @@ SELECT decodeURLComponent(queryStringAndFragment('http://paul@127.0.0.1/?query=h\n SELECT decodeURLComponent(queryStringAndFragment('//paul@127.0.0.1/?query=hello%20world+foo%2Bbar#a=b'));\n SELECT decodeURLComponent(queryStringAndFragment('//paul@127.0.0.1/#a=b'));\n SELECT decodeURLFormComponent(queryStringAndFragment('//paul@127.0.0.1/?query=hello%20world+foo%2Bbar#a=b'));\n+SELECT encodeURLComponent('hello world foo+bar#a=b');\n+SELECT encodeURLFormComponent('hello world foo+bar#a=b');\n+SELECT decodeURLComponent(encodeURLComponent('http://paul@127.0.0.1/?query=hello world foo+bar#a=b'));\n+SELECT decodeURLFormComponent(encodeURLFormComponent('http://paul@127.0.0.1/?query=hello world foo+bar#a=b'));\n \n SELECT '====CUT TO FIRST SIGNIFICANT SUBDOMAIN====';\n SELECT cutToFirstSignificantSubdomain('http://www.example.com');\n",
  "problem_statement": " Is there  such function\uff1aencodeURLComponent?\nthere is the function : decodeURLComponent ,why not encodeURLComponent?\r\n\n",
  "hints_text": "For reference this is the behaviour of the decodeURLComponent: https://clickhouse.com/docs/en/sql-reference/functions/url-functions/#decodeurlcomponenturl \nI will try to fix it ",
  "created_at": "2022-02-15T12:27:47Z"
}