{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 18893,
  "instance_id": "ClickHouse__ClickHouse-18893",
  "issue_numbers": [
    "18891"
  ],
  "base_commit": "f2cb2714253261169970183e1a6a5b2b7fc9fecf",
  "patch": "diff --git a/programs/local/LocalServer.cpp b/programs/local/LocalServer.cpp\nindex dbf153eeb81b..1fee37985a79 100644\n--- a/programs/local/LocalServer.cpp\n+++ b/programs/local/LocalServer.cpp\n@@ -273,11 +273,12 @@ try\n     global_context->setCurrentDatabase(default_database);\n     applyCmdOptions(*global_context);\n \n-    String path = global_context->getPath();\n-    if (!path.empty())\n+    if (config().has(\"path\"))\n     {\n+        String path = global_context->getPath();\n+\n         /// Lock path directory before read\n-        status.emplace(global_context->getPath() + \"status\", StatusFile::write_full_info);\n+        status.emplace(path + \"status\", StatusFile::write_full_info);\n \n         LOG_DEBUG(log, \"Loading metadata from {}\", path);\n         Poco::File(path + \"data/\").createDirectories();\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01647_clickhouse_local_hung.reference b/tests/queries/0_stateless/01647_clickhouse_local_hung.reference\nnew file mode 100644\nindex 000000000000..8925955b88e8\n--- /dev/null\n+++ b/tests/queries/0_stateless/01647_clickhouse_local_hung.reference\n@@ -0,0 +1,1 @@\n+    100 14\ndiff --git a/tests/queries/0_stateless/01647_clickhouse_local_hung.sh b/tests/queries/0_stateless/01647_clickhouse_local_hung.sh\nnew file mode 100755\nindex 000000000000..04f32055ab68\n--- /dev/null\n+++ b/tests/queries/0_stateless/01647_clickhouse_local_hung.sh\n@@ -0,0 +1,10 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+CURDIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CURDIR\"/../shell_config.sh\n+\n+\n+for _ in {1..100}; do echo 'Hello, world!' | ${CLICKHOUSE_LOCAL} --query \"SELECT * FROM table\" --structure 's String' | wc -c; done | uniq -c\n",
  "problem_statement": "clickhouse-local cannot shutdown correctly.\n**How to reproduce**\r\n```\r\nfor i in {1..1000}; do echo 'Hello, world!' | clickhouse-local --query \"SELECT * FROM table\" --structure 's String' | wc -c; done\r\n```\r\n\r\nThis script hangs.\n",
  "hints_text": "CC @tavplubix ",
  "created_at": "2021-01-10T03:35:54Z"
}