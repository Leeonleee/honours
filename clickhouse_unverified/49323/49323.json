{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 49323,
  "instance_id": "ClickHouse__ClickHouse-49323",
  "issue_numbers": [
    "49322"
  ],
  "base_commit": "38b2f94bfa225b21749d0ffab0185b03f9fec417",
  "patch": "diff --git a/src/Columns/ColumnLowCardinality.h b/src/Columns/ColumnLowCardinality.h\nindex e7f4b92d7337..f9bf72906013 100644\n--- a/src/Columns/ColumnLowCardinality.h\n+++ b/src/Columns/ColumnLowCardinality.h\n@@ -160,7 +160,9 @@ class ColumnLowCardinality final : public COWHelper<IColumn, ColumnLowCardinalit\n \n     void reserve(size_t n) override { idx.reserve(n); }\n \n-    size_t byteSize() const override { return idx.getPositions()->byteSize() + getDictionary().byteSize(); }\n+    /// Don't count the dictionary size as it can be shared between different blocks.\n+    size_t byteSize() const override { return idx.getPositions()->byteSize(); }\n+\n     size_t byteSizeAt(size_t n) const override { return getDictionary().byteSizeAt(getIndexes().getUInt(n)); }\n     size_t allocatedBytes() const override { return idx.getPositions()->allocatedBytes() + getDictionary().allocatedBytes(); }\n \n",
  "test_patch": "diff --git a/tests/integration/test_system_metrics/test.py b/tests/integration/test_system_metrics/test.py\nindex 8539828a8b81..9ebe198a109e 100644\n--- a/tests/integration/test_system_metrics/test.py\n+++ b/tests/integration/test_system_metrics/test.py\n@@ -122,11 +122,12 @@ def test_metrics_storage_buffer_size(start_cluster):\n         )\n         == \"1\\n\"\n     )\n+    # By the way, this metric does not count the LowCardinality's dictionary size.\n     assert (\n         node1.query(\n             \"SELECT value FROM system.metrics WHERE metric = 'StorageBufferBytes'\"\n         )\n-        == \"24\\n\"\n+        == \"1\\n\"\n     )\n \n     node1.query(\"INSERT INTO test.buffer_table VALUES('hello');\")\n@@ -140,7 +141,7 @@ def test_metrics_storage_buffer_size(start_cluster):\n         node1.query(\n             \"SELECT value FROM system.metrics WHERE metric = 'StorageBufferBytes'\"\n         )\n-        == \"25\\n\"\n+        == \"2\\n\"\n     )\n \n     # flush\n",
  "problem_statement": "Processing of small blocks with LowCardinality fields may produce a wrong value in the progress bar.\n**Describe the unexpected behaviour**\r\n\r\n```\r\nCREATE TABLE test\r\n(\r\n    s LowCardinality(String)\r\n)\r\nENGINE = MergeTree ORDER BY ();\r\n\r\nINSERT INTO test SELECT randomPrintableASCII(10000) FROM numbers(1000000);\r\n\r\nSET preferred_block_size_bytes = '64K'\r\n\r\nSELECT blockSize(), count() AS c, sum(length(s)) FROM test GROUP BY ALL ORDER BY c DESC;\r\n```\r\n\r\nShows > 1 TB/sec, which is obviously wrong.\n",
  "hints_text": "",
  "created_at": "2023-04-28T22:15:27Z"
}