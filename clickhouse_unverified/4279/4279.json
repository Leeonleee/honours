{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 4279,
  "instance_id": "ClickHouse__ClickHouse-4279",
  "issue_numbers": [
    "4271"
  ],
  "base_commit": "693782ee5b956582174b7e7e0e43553916373b23",
  "patch": "diff --git a/dbms/src/Interpreters/Join.cpp b/dbms/src/Interpreters/Join.cpp\nindex 4b7731b2e421..8858dd0f2b67 100644\n--- a/dbms/src/Interpreters/Join.cpp\n+++ b/dbms/src/Interpreters/Join.cpp\n@@ -469,9 +469,15 @@ bool Join::insertFromBlock(const Block & block)\n     }\n     else\n     {\n+        NameSet erased; /// HOTFIX: there could be duplicates in JOIN ON section\n+\n         /// Remove the key columns from stored_block, as they are not needed.\n         for (const auto & name : key_names_right)\n-            stored_block->erase(stored_block->getPositionByName(name));\n+        {\n+            if (!erased.count(name))\n+                stored_block->erase(stored_block->getPositionByName(name));\n+            erased.insert(name);\n+        }\n     }\n \n     size_t size = stored_block->columns();\n",
  "test_patch": "diff --git a/dbms/tests/queries/0_stateless/00818_join_bug_4271.reference b/dbms/tests/queries/0_stateless/00818_join_bug_4271.reference\nnew file mode 100644\nindex 000000000000..4d5913814214\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00818_join_bug_4271.reference\n@@ -0,0 +1,9 @@\n+1\t1\ta\t1\t1\ta\n+2\t2\tb\t\\N\t\\N\t\\N\n+1\t1\ta\t1\t1\ta\n+2\t2\tb\t\\N\t\\N\t\\N\n+1\t1\ta\t1\t1\ta\n+1\t1\ta\t1\t1\ta\n+2\t2\tb\t\\N\t\\N\t\\N\n+1\t1\ta\t1\t1\ta\n+2\t2\tb\t\\N\t\\N\t\\N\ndiff --git a/dbms/tests/queries/0_stateless/00818_join_bug_4271.sql b/dbms/tests/queries/0_stateless/00818_join_bug_4271.sql\nnew file mode 100644\nindex 000000000000..8f7fc7f8ef4a\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00818_join_bug_4271.sql\n@@ -0,0 +1,19 @@\n+use test;\n+\n+drop table if exists t;\n+drop table if exists s;\n+\n+create table t(a Nullable(Int64), b Nullable(Int64), c Nullable(String)) engine = Memory;\n+create table s(a Nullable(Int64), b Nullable(Int64), c Nullable(String)) engine = Memory;\n+\n+insert into t values(1,1,'a'), (2,2,'b');\n+insert into s values(1,1,'a');\n+\n+select * from t left join s on t.a = s.a;\n+select * from t left join s on t.a = s.a and t.a = s.b;\n+select * from t left join s on t.a = s.a where s.a = 1;\n+select * from t left join s on t.a = s.a and t.a = s.a;\n+select * from t left join s on t.a = s.a and t.b = s.a;\n+\n+drop table t;\n+drop table s;\n",
  "problem_statement": "Not found column for duplicate columns in JOIN ON section\nCannot resolve duplicated column from right table of JOIN.\r\n\r\n```\r\ncreate table t(a Nullable(Int64), b Nullable(Int64), c Nullable(String)) engine = Memory;\r\ncreate table s(a Nullable(Int64), b Nullable(Int64), c Nullable(String)) engine = Memory;\r\n\r\ninsert into t values(1,1,'a'), (2,2,'b');\r\ninsert into s values(1,1,'a');\r\n\r\nselect * from t left outer join s on t.a = s.a;\r\n1       1       a       1       1       a\r\n2       2       b       \\N      \\N      \\N\r\n\r\nselect * from t left outer join s on t.a = s.a and t.a = s.b;\r\n1       1       a       1       1       a\r\n2       2       b       \\N      \\N      \\N\r\n\r\nselect * from t left outer join s on t.a = s.a and t.a = s.a;\r\nCode: 10. DB::Exception: Received from localhost:9000, 127.0.0.1. DB::Exception: Not found column s.a in block. There are only columns: s.b, s.c. \r\n\r\nselect * from t left outer join s on t.a = s.a and t.b = s.a;\r\nCode: 10. DB::Exception: Received from localhost:9000, 127.0.0.1. DB::Exception: Not found column s.a in block. There are only columns: s.b, s.c.\r\n```\n",
  "hints_text": "Possibly related errors #4222 #971",
  "created_at": "2019-02-05T17:00:40Z"
}