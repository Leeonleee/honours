{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 3837,
  "instance_id": "ClickHouse__ClickHouse-3837",
  "issue_numbers": [
    "3756"
  ],
  "base_commit": "af31ff24b99d389c901b89536decdfeb1a80c563",
  "patch": "diff --git a/dbms/src/Interpreters/InterpreterSelectQuery.cpp b/dbms/src/Interpreters/InterpreterSelectQuery.cpp\nindex a7f0c0dcc529..718f88d19675 100644\n--- a/dbms/src/Interpreters/InterpreterSelectQuery.cpp\n+++ b/dbms/src/Interpreters/InterpreterSelectQuery.cpp\n@@ -606,6 +606,8 @@ void InterpreterSelectQuery::executeImpl(Pipeline & pipeline, const BlockInputSt\n                         executeRollupOrCube(pipeline, Modificator::ROLLUP);\n                     else if (query.group_by_with_cube)\n                         executeRollupOrCube(pipeline, Modificator::CUBE);\n+                    if ((query.group_by_with_rollup || query.group_by_with_cube) && expressions.has_having)\n+                        executeHaving(pipeline, expressions.before_having);\n                 }\n                 else if (expressions.has_having)\n                     executeHaving(pipeline, expressions.before_having);\n@@ -625,10 +627,15 @@ void InterpreterSelectQuery::executeImpl(Pipeline & pipeline, const BlockInputSt\n                     executeTotalsAndHaving(pipeline, expressions.has_having, expressions.before_having, aggregate_overflow_row, final);\n                 }\n \n-                if (query.group_by_with_rollup && !aggregate_final)\n-                    executeRollupOrCube(pipeline, Modificator::ROLLUP);\n-                else if (query.group_by_with_cube && !aggregate_final)\n-                    executeRollupOrCube(pipeline, Modificator::CUBE);\n+                if ((query.group_by_with_rollup || query.group_by_with_cube) && !aggregate_final)\n+                {\n+                    if (query.group_by_with_rollup)\n+                        executeRollupOrCube(pipeline, Modificator::ROLLUP);\n+                    else if (query.group_by_with_cube)\n+                        executeRollupOrCube(pipeline, Modificator::CUBE);\n+                    if (expressions.has_having)\n+                        executeHaving(pipeline, expressions.before_having);\n+                }\n             }\n \n             if (expressions.has_order_by)\n@@ -1483,3 +1490,4 @@ void InterpreterSelectQuery::initSettings()\n }\n \n }\n+\n",
  "test_patch": "diff --git a/dbms/tests/queries/0_stateless/00804_rollup_with_having.reference b/dbms/tests/queries/0_stateless/00804_rollup_with_having.reference\nnew file mode 100644\nindex 000000000000..5023e1bbd1c1\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00804_rollup_with_having.reference\n@@ -0,0 +1,12 @@\n+a\t\\N\t1\n+a\tb\t1\n+a\t\\N\t2\n+a\tb\t1\n+a\t\\N\t1\n+a\tb\t1\n+a\t\\N\t2\n+\n+\\N\t\\N\t2\n+a\tb\t1\n+\n+\\N\t\\N\t1\ndiff --git a/dbms/tests/queries/0_stateless/00804_rollup_with_having.sql b/dbms/tests/queries/0_stateless/00804_rollup_with_having.sql\nnew file mode 100644\nindex 000000000000..6a2ba90fc52b\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00804_rollup_with_having.sql\n@@ -0,0 +1,15 @@\n+DROP TABLE IF EXISTS test.rollup_having;\n+CREATE TABLE test.rollup_having (\n+  a Nullable(String),\n+  b Nullable(String)\n+) ENGINE = Memory;\n+\n+INSERT INTO test.rollup_having VALUES (NULL, NULL);\n+INSERT INTO test.rollup_having VALUES ('a', NULL);\n+INSERT INTO test.rollup_having VALUES ('a', 'b');\n+\n+SELECT a, b, count(*) FROM test.rollup_having GROUP BY a, b WITH ROLLUP HAVING a IS NOT NULL;\n+SELECT a, b, count(*) FROM test.rollup_having GROUP BY a, b WITH ROLLUP HAVING a IS NOT NULL and b IS NOT NULL;\n+\n+SELECT a, b, count(*) FROM test.rollup_having GROUP BY a, b WITH ROLLUP WITH TOTALS HAVING a IS NOT NULL;\n+SELECT a, b, count(*) FROM test.rollup_having GROUP BY a, b WITH ROLLUP WITH TOTALS HAVING a IS NOT NULL and b IS NOT NULL;\n",
  "problem_statement": "ROLLUP with HAVING - incorrect results\n```\r\n# ClickHouse\r\nCREATE TABLE test (\r\n  a Nullable(String),\r\n  b Nullable(String)\r\n) ENGINE = Memory;\r\n\r\nINSERT INTO test VALUES (NULL, NULL);\r\nINSERT INTO test VALUES ('a', NULL);\r\nINSERT INTO test VALUES ('a', 'b');\r\n\r\nSELECT a, b, count(*) FROM test GROUP BY a, b WITH ROLLUP HAVING a IS NOT NULL and b IS NOT NULL;\r\n\u250c\u2500a\u2500\u2500\u2500\u2500\u252c\u2500b\u2500\u2500\u2500\u2500\u252c\u2500count()\u2500\u2510\r\n\u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502       1 \u2502\r\n\u2502 a    \u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502       1 \u2502\r\n\u2502 a    \u2502 b    \u2502       1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\u250c\u2500a\u2500\u2500\u2500\u2500\u252c\u2500b\u2500\u2500\u2500\u2500\u252c\u2500count()\u2500\u2510\r\n\u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502       1 \u2502\r\n\u2502 a    \u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502       2 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\u250c\u2500a\u2500\u2500\u2500\u2500\u252c\u2500b\u2500\u2500\u2500\u2500\u252c\u2500count()\u2500\u2510\r\n\u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502       3 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n6 rows in set. Elapsed: 0.010 sec.\r\n\r\nSELECT a, b, count(*) FROM test GROUP BY a, b WITH ROLLUP HAVING a IS NOT NULL;\r\n\u250c\u2500a\u2500\u2500\u2500\u2500\u252c\u2500b\u2500\u2500\u2500\u2500\u252c\u2500count()\u2500\u2510\r\n\u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502       1 \u2502\r\n\u2502 a    \u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502       1 \u2502\r\n\u2502 a    \u2502 b    \u2502       1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\u250c\u2500a\u2500\u2500\u2500\u2500\u252c\u2500b\u2500\u2500\u2500\u2500\u252c\u2500count()\u2500\u2510\r\n\u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502       1 \u2502\r\n\u2502 a    \u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502       2 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\u250c\u2500a\u2500\u2500\u2500\u2500\u252c\u2500b\u2500\u2500\u2500\u2500\u252c\u2500count()\u2500\u2510\r\n\u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502 \u1d3a\u1d41\u1d38\u1d38 \u2502       3 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n6 rows in set. Elapsed: 0.008 sec\r\n\r\n\r\n# Postgresql\r\nCREATE TABLE test (\r\n  a TEXT,\r\n  b TEXT\r\n);\r\n\r\nINSERT INTO test VALUES (NULL, NULL);\r\nINSERT INTO test VALUES ('a', NULL);\r\nINSERT INTO test VALUES ('a', 'b');\r\n\r\nSELECT a, b, count(*) FROM test GROUP BY ROLLUP(a, b) HAVING a IS NOT NULL and b IS NOT NULL;\r\n a | b | count\r\n---+---+-------\r\n a | b |     1\r\n(1 row)\r\n\r\nSELECT a, b, count(*) FROM test GROUP BY ROLLUP(a, b) HAVING a IS NOT NULL;\r\n a | b | count\r\n---+---+-------\r\n a | b |     1\r\n a |   |     1\r\n a |   |     2\r\n(3 rows)\r\n```\n",
  "hints_text": "Hi, any update on this issue as it's been over a week?  Thanks!",
  "created_at": "2018-12-15T06:35:23Z"
}