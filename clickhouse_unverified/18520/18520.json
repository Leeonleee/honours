{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 18520,
  "instance_id": "ClickHouse__ClickHouse-18520",
  "issue_numbers": [
    "17876"
  ],
  "base_commit": "4af0d73446a8845bf7349c332910562eb0876123",
  "patch": "diff --git a/src/Functions/bar.cpp b/src/Functions/bar.cpp\nindex 12b22bae80c0..2eddf23af665 100644\n--- a/src/Functions/bar.cpp\n+++ b/src/Functions/bar.cpp\n@@ -75,11 +75,14 @@ class FunctionBar : public IFunction\n         /// The maximum width of the bar in characters, by default.\n         Float64 max_width = arguments.size() == 4 ? extractConstant<Float64>(arguments, 3, \"Fourth\") : 80;\n \n+        if (isNaN(max_width))\n+            throw Exception(\"Argument 'max_width' must not be NaN\", ErrorCodes::ILLEGAL_TYPE_OF_ARGUMENT);\n+\n         if (max_width < 1)\n-            throw Exception(\"Max_width argument must be >= 1.\", ErrorCodes::ARGUMENT_OUT_OF_BOUND);\n+            throw Exception(\"Argument 'max_width' must be >= 1\", ErrorCodes::ARGUMENT_OUT_OF_BOUND);\n \n         if (max_width > 1000)\n-            throw Exception(\"Too large max_width.\", ErrorCodes::ARGUMENT_OUT_OF_BOUND);\n+            throw Exception(\"Argument 'max_width' must be <= 1000\", ErrorCodes::ARGUMENT_OUT_OF_BOUND);\n \n         const auto & src = *arguments[0].column;\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01621_bar_nan_arguments.reference b/tests/queries/0_stateless/01621_bar_nan_arguments.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/01621_bar_nan_arguments.sql b/tests/queries/0_stateless/01621_bar_nan_arguments.sql\nnew file mode 100644\nindex 000000000000..c28cb53d7cea\n--- /dev/null\n+++ b/tests/queries/0_stateless/01621_bar_nan_arguments.sql\n@@ -0,0 +1,2 @@\n+SELECT bar((greatCircleAngle(65537, 2, 1, 1) - 1) * 65535, 1048576, 1048577, nan); -- { serverError 43 }\n+select bar(1,1,1,nan); -- { serverError 43 }\n",
  "problem_statement": "Query Fuzzer: bar, greatCircleAngle: too large size passed to allocator.\n```\r\nSELECT bar((greatCircleAngle(65537, 2, number, number) - number) * 65535, 1048576, 1048577, nan)\r\nFROM numbers(1025)\r\n\r\nQuery id: 1792a79a-e5ae-425d-aaeb-55fbff42ea0e\r\n\r\n\u2192 Progress: 1.02 thousand rows, 8.20 KB (10.09 thousand rows/s., 80.73 KB/s.)  99%\r\nReceived exception from server (version 20.13.1):\r\nCode: 49. DB::Exception: Received from localhost:9000. DB::Exception: Too large size (9223372036854776864) passed to allocator. It indicates an error.: while executing 'FUNCTION bar(multiply(minus(greatCircleAngle(65537, 2, number, number), number), 65535) :: 0, 1048576 :: 4, 1048577 :: 5, nan :: 6) -> bar(multiply(minus(greatCircleAngle(65537, 2, number, number), number), 65535), 1048576, 1048577, nan) String : 3'.\r\n```\n",
  "hints_text": "",
  "created_at": "2020-12-25T15:58:51Z"
}