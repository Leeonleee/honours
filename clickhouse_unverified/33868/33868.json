{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 33868,
  "instance_id": "ClickHouse__ClickHouse-33868",
  "issue_numbers": [
    "33866"
  ],
  "base_commit": "9b3a36a420471b3885d4142ad82e3fd9fb774174",
  "patch": "diff --git a/src/Interpreters/InterpreterCreateFunctionQuery.cpp b/src/Interpreters/InterpreterCreateFunctionQuery.cpp\nindex 20114fa0d758..f61224b1278d 100644\n--- a/src/Interpreters/InterpreterCreateFunctionQuery.cpp\n+++ b/src/Interpreters/InterpreterCreateFunctionQuery.cpp\n@@ -66,7 +66,12 @@ void InterpreterCreateFunctionQuery::validateFunction(ASTPtr function, const Str\n \n     for (const auto & argument : tuple_function_arguments.arguments->children)\n     {\n-        const auto & argument_name = argument->as<ASTIdentifier>()->name();\n+        const auto * argument_identifier = argument->as<ASTIdentifier>();\n+\n+        if (!argument_identifier)\n+            throw Exception(ErrorCodes::UNSUPPORTED_METHOD, \"Lambda argument must be identifier\");\n+\n+        const auto & argument_name = argument_identifier->name();\n         auto [_, inserted] = arguments.insert(argument_name);\n         if (!inserted)\n             throw Exception(ErrorCodes::UNSUPPORTED_METHOD, \"Identifier {} already used as function parameter\", argument_name);\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02181_sql_user_defined_functions_invalid_lambda.reference b/tests/queries/0_stateless/02181_sql_user_defined_functions_invalid_lambda.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02181_sql_user_defined_functions_invalid_lambda.sql b/tests/queries/0_stateless/02181_sql_user_defined_functions_invalid_lambda.sql\nnew file mode 100644\nindex 000000000000..ecb5dc8e9f38\n--- /dev/null\n+++ b/tests/queries/0_stateless/02181_sql_user_defined_functions_invalid_lambda.sql\n@@ -0,0 +1,1 @@\n+CREATE FUNCTION 02181_invalid_lambda AS lambda(((x * 2) AS x_doubled) + x_doubled); --{serverError 1}\n",
  "problem_statement": "InterpreterCreateFunctionQuery.cpp:69:69: member call on null pointer of type 'DB::ASTIdentifier'\nhttps://s3.amazonaws.com/clickhouse-test-reports/33847/8921725d716e05b13dc82f2db1c3d5bfc3ad6983/fuzzer_astfuzzerubsan,actions//report.html\r\n\r\n```\r\n../src/Interpreters/InterpreterCreateFunctionQuery.cpp:69:69: runtime error: member call on null pointer of type 'DB::ASTIdentifier'\r\n    #0 0x1f78fbff in DB::InterpreterCreateFunctionQuery::validateFunction(std::__1::shared_ptr<DB::IAST>, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) obj-x86_64-linux-gnu/../src/Interpreters/InterpreterCreateFunctionQuery.cpp:69:69\r\n    #1 0x1f78f3cf in DB::InterpreterCreateFunctionQuery::execute() obj-x86_64-linux-gnu/../src/Interpreters/InterpreterCreateFunctionQuery.cpp:52:5\r\n    #2 0x1fd64086 in DB::executeQueryImpl(char const*, char const*, std::__1::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, DB::ReadBuffer*) obj-x86_64-linux-gnu/../src/Interpreters/executeQuery.cpp:665:36\r\n    #3 0x1fd610c9 in DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum) obj-x86_64-linux-gnu/../src/Interpreters/executeQuery.cpp:984:30\r\n    #4 0x20b10c06 in DB::TCPHandler::runImpl() obj-x86_64-linux-gnu/../src/Server/TCPHandler.cpp:333:24\r\n    #5 0x20b2fef5 in DB::TCPHandler::run() obj-x86_64-linux-gnu/../src/Server/TCPHandler.cpp:1909:9\r\n    #6 0x217a3b6b in Poco::Net::TCPServerConnection::start() obj-x86_64-linux-gnu/../contrib/poco/Net/src/TCPServerConnection.cpp:43:3\r\n    #7 0x217a4044 in Poco::Net::TCPServerDispatcher::run() obj-x86_64-linux-gnu/../contrib/poco/Net/src/TCPServerDispatcher.cpp:115:20\r\n    #8 0x21917f86 in Poco::PooledThread::run() obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/ThreadPool.cpp:199:14\r\n    #9 0x2191586b in Poco::ThreadImpl::runnableEntry(void*) obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Thread_POSIX.cpp:345:27\r\n    #10 0x7fb19dd4e608 in start_thread /build/glibc-eX1tMB/glibc-2.31/nptl/pthread_create.c:477:8\r\n    #11 0x7fb19dc75292 in __clone /build/glibc-eX1tMB/glibc-2.31/misc/../sysdeps/unix/sysv/linux/x86_64/clone.S:95\r\n```\r\n\r\n```\r\n2022.01.21 16:15:19.035403 [ 167 ] {34849040-5c23-4c9a-aa17-eab03a062a38} <Debug> executeQuery: (from [::ffff:127.0.0.1]:60978) CREATE FUNCTION `02098_alias_function` AS lambda(((x * 2) AS x_doubled) + x_doubled)\r\n2022.01.21 16:15:19.035453 [ 167 ] {34849040-5c23-4c9a-aa17-eab03a062a38} <Trace> ContextAccess (default): Access granted: CREATE FUNCTION ON *.*\r\n2022.01.21 16:15:20.373854 [ 415 ] {} <Fatal> BaseDaemon: (version 22.2.1.2962, build id: B1EAAF5B1933AEE2) (from thread 167) (query_id: 34849040-5c23-4c9a-aa17-eab03a062a38) Received signal Unknown signal (-3)\r\n```\n",
  "hints_text": "",
  "created_at": "2022-01-21T14:35:58Z"
}