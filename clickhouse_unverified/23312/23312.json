{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 23312,
  "instance_id": "ClickHouse__ClickHouse-23312",
  "issue_numbers": [
    "23002"
  ],
  "base_commit": "c59628846c3b9f8eb9ca223eed039c7913977a44",
  "patch": "diff --git a/src/Interpreters/TableJoin.h b/src/Interpreters/TableJoin.h\nindex 71a27849297d..b75ef848f13a 100644\n--- a/src/Interpreters/TableJoin.h\n+++ b/src/Interpreters/TableJoin.h\n@@ -128,7 +128,11 @@ class TableJoin\n     bool allowDictJoin(const String & dict_key, const Block & sample_block, Names &, NamesAndTypesList &) const;\n     bool preferMergeJoin() const { return join_algorithm == JoinAlgorithm::PREFER_PARTIAL_MERGE; }\n     bool forceMergeJoin() const { return join_algorithm == JoinAlgorithm::PARTIAL_MERGE; }\n-    bool forceHashJoin() const { return join_algorithm == JoinAlgorithm::HASH; }\n+    bool forceHashJoin() const\n+    {\n+        /// HashJoin always used for DictJoin\n+        return dictionary_reader || join_algorithm == JoinAlgorithm::HASH;\n+    }\n \n     bool forceNullableRight() const { return join_use_nulls && isLeftOrFull(table_join.kind); }\n     bool forceNullableLeft() const { return join_use_nulls && isRightOrFull(table_join.kind); }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01115_join_with_dictionary.reference b/tests/queries/0_stateless/01115_join_with_dictionary.reference\nindex fbff63d1777b..77f7ba193c05 100644\n--- a/tests/queries/0_stateless/01115_join_with_dictionary.reference\n+++ b/tests/queries/0_stateless/01115_join_with_dictionary.reference\n@@ -101,3 +101,38 @@ not optimized (smoke)\n -\n 2\t2\t2\t2\n 3\t3\t3\t3\n+issue 23002\n+-\n+0\t0\t0\t0\t0\n+1\t1\t1\t1\t1\n+2\t2\t2\t2\t2\n+3\t3\t3\t3\t3\n+4\t0\t0\t\t0\n+-\n+0\t0\t0\t0\n+1\t1\t1\t1\n+2\t2\t2\t2\n+3\t3\t3\t3\n+4\t0\t\t0\n+-\n+0\t0\t0\t0\t0\n+1\t1\t1\t1\t1\n+0\t2\t2\t2\t2\n+0\t3\t3\t3\t3\n+-\n+0\t0\t0\t0\t0\n+1\t1\t1\t1\t1\n+2\t2\t2\t2\t2\n+3\t3\t3\t3\t3\n+4\t0\t0\t\t0\n+-\n+0\t0\t0\t0\n+1\t1\t1\t1\n+2\t2\t2\t2\n+3\t3\t3\t3\n+4\t0\t\t0\n+-\n+0\t0\t0\t0\t0\n+1\t1\t1\t1\t1\n+0\t2\t2\t2\t2\n+0\t3\t3\t3\t3\ndiff --git a/tests/queries/0_stateless/01115_join_with_dictionary.sql b/tests/queries/0_stateless/01115_join_with_dictionary.sql\nindex a57141696412..d2c42bb6f753 100644\n--- a/tests/queries/0_stateless/01115_join_with_dictionary.sql\n+++ b/tests/queries/0_stateless/01115_join_with_dictionary.sql\n@@ -82,6 +82,27 @@ SELECT * FROM (SELECT number AS key FROM numbers(2)) s1 SEMI RIGHT JOIN dict_fla\n SELECT '-';\n SELECT * FROM (SELECT number AS key FROM numbers(2)) s1 ANTI RIGHT JOIN dict_flat d USING(key) ORDER BY s1.key;\n \n+SET join_use_nulls = 0;\n+\n+SELECT 'issue 23002';\n+\n+SET join_algorithm = 'auto';\n+SELECT '-';\n+SELECT * FROM (SELECT number AS key FROM numbers(5)) s1 LEFT JOIN dict_flat d ON s1.key = d.key ORDER BY s1.key;\n+SELECT '-';\n+SELECT * FROM (SELECT number AS key FROM numbers(5)) s1 ANY LEFT JOIN dict_flat d USING(key) ORDER BY key;\n+SELECT '-';\n+SELECT * FROM (SELECT number AS key FROM numbers(2)) s1 RIGHT JOIN dict_flat d ON s1.key = d.key ORDER BY d.key;\n+\n+SET join_algorithm = 'partial_merge';\n+SELECT '-';\n+SELECT * FROM (SELECT number AS key FROM numbers(5)) s1 LEFT JOIN dict_flat d ON s1.key = d.key ORDER BY s1.key;\n+SELECT '-';\n+SELECT * FROM (SELECT number AS key FROM numbers(5)) s1 ANY LEFT JOIN dict_flat d USING(key) ORDER BY key;\n+SELECT '-';\n+SELECT * FROM (SELECT number AS key FROM numbers(2)) s1 RIGHT JOIN dict_flat d ON s1.key = d.key ORDER BY d.key;\n+\n+\n DROP DICTIONARY dict_flat;\n DROP DICTIONARY dict_hashed;\n DROP DICTIONARY dict_complex_cache;\n",
  "problem_statement": "(JOIN with dictionary) HashJoin: container overflow (range check)\n**Describe the bug**\r\nhttps://clickhouse-test-reports.s3.yandex.net/22994/eaa092cae2c633d78c8b5856956df420a8c5096c/fuzzer_asan/report.html#fail1\r\n\n",
  "hints_text": "```\r\nCREATE DICTIONARY dict_flat (`key` UInt64 DEFAULT 0, `a` UInt8 DEFAULT 42, `b` String DEFAULT 'x', `c` Float64 DEFAULT 42.) PRIMARY KEY key SOURCE(CLICKHOUSE(HOST 'localhost' PORT tcpPort() USER 'default' TABLE 't1' PASSWORD '' DB 'db_01115')) LIFETIME(MIN 1 MAX 10) LAYOUT(FLAT())\r\n```\r\n\r\n```\r\nSELECT * FROM (SELECT number AS key FROM numbers(5)) AS s1 LEFT JOIN dict_flat AS d ON s1.key = d.key ORDER BY s1.key ASC\r\n```",
  "created_at": "2021-04-19T15:05:09Z",
  "modified_files": [
    "src/Interpreters/TableJoin.h"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/01115_join_with_dictionary.reference",
    "tests/queries/0_stateless/01115_join_with_dictionary.sql"
  ]
}