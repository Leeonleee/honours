{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 26957,
  "instance_id": "ClickHouse__ClickHouse-26957",
  "issue_numbers": [
    "26899"
  ],
  "base_commit": "6951e8147d7a25f7bb4f7d43738793cff239db6d",
  "patch": "diff --git a/src/Interpreters/JoinToSubqueryTransformVisitor.cpp b/src/Interpreters/JoinToSubqueryTransformVisitor.cpp\nindex 8595d3a4179f..eabdeaefc049 100644\n--- a/src/Interpreters/JoinToSubqueryTransformVisitor.cpp\n+++ b/src/Interpreters/JoinToSubqueryTransformVisitor.cpp\n@@ -551,8 +551,6 @@ std::vector<TableNeededColumns> normalizeColumnNamesExtractNeeded(\n             else\n                 needed_columns[*table_pos].no_clashes.emplace(ident->shortName());\n         }\n-        else if (!got_alias)\n-            throw Exception(\"Unknown column name '\" + ident->name() + \"'\", ErrorCodes::UNKNOWN_IDENTIFIER);\n     }\n \n     return needed_columns;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/00820_multiple_joins.reference b/tests/queries/0_stateless/00820_multiple_joins.reference\nindex 6d317230813f..f9d9a6647840 100644\n--- a/tests/queries/0_stateless/00820_multiple_joins.reference\n+++ b/tests/queries/0_stateless/00820_multiple_joins.reference\n@@ -48,3 +48,4 @@\n 6\t6\t60\t60\t66\t66\t120\n 12\t12\t120\t120\t132\t132\t240\n 18\t18\t180\t180\t198\t198\t360\n+1\ndiff --git a/tests/queries/0_stateless/00820_multiple_joins.sql b/tests/queries/0_stateless/00820_multiple_joins.sql\nindex 890d003a124c..df82a199337b 100644\n--- a/tests/queries/0_stateless/00820_multiple_joins.sql\n+++ b/tests/queries/0_stateless/00820_multiple_joins.sql\n@@ -2,6 +2,7 @@ DROP TABLE IF EXISTS table1;\n DROP TABLE IF EXISTS table2;\n DROP TABLE IF EXISTS table3;\n DROP TABLE IF EXISTS table5;\n+DROP TABLE IF EXISTS table_set;\n \n CREATE TABLE table1 (a UInt32) ENGINE = Memory;\n CREATE TABLE table2 (a UInt32, b UInt32) ENGINE = Memory;\n@@ -76,6 +77,18 @@ join table3 as t3 on t2_b = t3_b;\n --join table2 as t2 on t1_t2_x = t2.a\n --join table3 as t3 on t1_t3_x = t2_t3_x;\n \n+\n+CREATE TABLE table_set ( x UInt32 ) ENGINE = Set;\n+INSERT INTO table_set VALUES (0), (1), (2);\n+\n+select count()\n+from table1 as t1\n+join table2 as t2 on t1.a = t2.a\n+join table3 as t3 on t2.b = t3.b\n+join table5 as t5 on t3.c = t5.c\n+WHERE t1.a in table_set;\n+\n+DROP TABLE table_set;\n DROP TABLE table1;\n DROP TABLE table2;\n DROP TABLE table3;\n",
  "problem_statement": "Select from table with Engine=Set does not work with 2 joins\n**Bug description**\r\n\r\nSelect from table with Engine=Set does not work with 2 joins.\r\n\r\n**Affected version**\r\n\r\nReproduces on 21.3.15.4\r\n\r\n**How to reproduce**\r\n\r\nCreating base table and set table:\r\n\r\n```sql\r\nCREATE TABLE users (\r\n  userid UInt64\r\n)\r\nENGINE = MergeTree() ORDER BY (userid);\r\nINSERT INTO users VALUES (1),(2),(3);\r\n\r\nCREATE TABLE users_set (\r\n  userid UInt64\r\n)\r\nENGINE = Set;\r\nINSERT INTO users_set VALUES (1),(2);\r\n\r\n-- works\r\nselect * from users where userid in users_set;\r\n```\r\n\r\nAdding one more table and one more join:\r\n\r\n```sql\r\nCREATE TABLE user_names(\r\n    userid UInt64,\r\n    name String\r\n) ENGINE = MergeTree() ORDER BY (userid);\r\n\r\nINSERT INTO user_names VALUES (1, 'Batman'), (2, 'Joker'), (3, 'Superman');\r\n\r\n-- still works\r\nselect userid, name \r\nfrom users any left join user_names on (users.userid = user_names.userid) \r\nwhere userid in users_set;\r\n```\r\n\r\nAnd one more table plus 2nd join breaks it:\r\n\r\n```sql\r\nCREATE TABLE user_real_names(\r\n    uid UInt64,\r\n    real_name String\r\n) ENGINE = MergeTree() ORDER BY (uid);\r\n\r\nINSERT INTO user_real_names VALUES (1, 'Bruce Wayne'), (2, 'Unknown'), (3, 'Clark Kent');\r\n\r\n--DOES NOT WORK\r\nselect \r\n    users.userid,\r\n    name,\r\n    real_name\r\nfrom users \r\n    any left join user_names on (users.userid = user_names.userid) \r\n    any left join user_real_names on (users.userid = user_real_names.uid)\r\nwhere users.userid in users_set;\r\n```\r\n\r\n**Expected behavior**\r\n\r\nWorking query, just like with one or no joins. Expected output: \r\n\r\n```\r\n1\tBatman\tBruce Wayne\r\n2\tJoker\tUnknown\r\n```\r\n\r\n**Error message and/or stacktrace**\r\n\r\n```Unknown column name 'users_set': While processing SELECT```\r\n\n",
  "hints_text": "21.7.4.18 same issue.",
  "created_at": "2021-07-29T11:52:41Z"
}