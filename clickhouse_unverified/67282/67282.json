{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 67282,
  "instance_id": "ClickHouse__ClickHouse-67282",
  "issue_numbers": [
    "67165"
  ],
  "base_commit": "b64c7814572c5245bb2cbd8d6aaab1b87f81c7fa",
  "patch": "diff --git a/programs/server/config.d/session_log.xml b/programs/server/config.d/session_log.xml\nnew file mode 120000\nindex 000000000000..7678cc331299\n--- /dev/null\n+++ b/programs/server/config.d/session_log.xml\n@@ -0,0 +1,1 @@\n+../../../tests/config/config.d/session_log.xml\n\\ No newline at end of file\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02833_concurrrent_sessions.reference b/tests/queries/0_stateless/02833_concurrent_sessions.reference\nsimilarity index 84%\nrename from tests/queries/0_stateless/02833_concurrrent_sessions.reference\nrename to tests/queries/0_stateless/02833_concurrent_sessions.reference\nindex bfe507e8eac0..904e8cefc6e1 100644\n--- a/tests/queries/0_stateless/02833_concurrrent_sessions.reference\n+++ b/tests/queries/0_stateless/02833_concurrent_sessions.reference\n@@ -1,34 +1,34 @@\n sessions:\n-150\n+45\n port_0_sessions:\n 0\n address_0_sessions:\n 0\n tcp_sessions\n-60\n+18\n http_sessions\n-30\n+9\n http_with_session_id_sessions\n-30\n-my_sql_sessions\n-30\n+9\n+mysql_sessions\n+9\n Corresponding LoginSuccess/Logout\n-10\n+3\n LoginFailure\n-10\n+3\n Corresponding LoginSuccess/Logout\n-10\n+3\n LoginFailure\n-10\n+3\n Corresponding LoginSuccess/Logout\n-10\n+3\n LoginFailure\n-10\n+3\n Corresponding LoginSuccess/Logout\n-10\n+3\n LoginFailure\n-10\n+3\n Corresponding LoginSuccess/Logout\n-10\n+3\n LoginFailure\n-10\n+3\ndiff --git a/tests/queries/0_stateless/02833_concurrrent_sessions.sh b/tests/queries/0_stateless/02833_concurrent_sessions.sh\nsimilarity index 88%\nrename from tests/queries/0_stateless/02833_concurrrent_sessions.sh\nrename to tests/queries/0_stateless/02833_concurrent_sessions.sh\nindex c5b6204529b8..846661cfeed3 100755\n--- a/tests/queries/0_stateless/02833_concurrrent_sessions.sh\n+++ b/tests/queries/0_stateless/02833_concurrent_sessions.sh\n@@ -37,11 +37,11 @@ done\n # These functions try to create a session with successful login and logout.\n # Sleep a small, random amount of time to make concurrency more intense.\n # and try to login with an invalid password.\n-function tcp_session() \n+function tcp_session()\n {\n     local user=$1\n     local i=0\n-    while (( (i++) < 10 )); do\n+    while (( (i++) < 3 )); do\n         # login logout\n         ${CLICKHOUSE_CLIENT} -q \"SELECT 1, sleep(0.01${RANDOM})\" --user=\"${user}\" --password=\"pass\"\n         # login failure\n@@ -49,11 +49,11 @@ function tcp_session()\n     done\n }\n \n-function http_session() \n+function http_session()\n {\n     local user=$1\n     local i=0\n-    while (( (i++) < 10 )); do\n+    while (( (i++) < 3 )); do\n         # login logout\n         ${CLICKHOUSE_CURL} -sS \"${CLICKHOUSE_URL}&user=${user}&password=pass\" -d \"SELECT 3, sleep(0.01${RANDOM})\"\n \n@@ -62,11 +62,11 @@ function http_session()\n     done\n }\n \n-function http_with_session_id_session() \n+function http_with_session_id_session()\n {\n     local user=$1\n     local i=0\n-    while (( (i++) < 10 )); do\n+    while (( (i++) < 3 )); do\n         # login logout\n         ${CLICKHOUSE_CURL} -sS \"${CLICKHOUSE_URL}&session_id=${user}&user=${user}&password=pass\" -d \"SELECT 5, sleep 0.01${RANDOM}\"\n \n@@ -75,11 +75,11 @@ function http_with_session_id_session()\n     done\n }\n \n-function mysql_session() \n+function mysql_session()\n {\n     local user=$1\n     local i=0\n-    while (( (i++) < 10 )); do\n+    while (( (i++) < 3 )); do\n         # login logout\n         ${CLICKHOUSE_CLIENT} -q \"SELECT 1, sleep(0.01${RANDOM}) FROM mysql('127.0.0.1:9004', 'system', 'one', '${user}', 'pass')\"\n \n@@ -97,29 +97,29 @@ export -f http_with_session_id_session;\n export -f mysql_session;\n \n for user in \"${TCP_USERS[@]}\"; do\n-    timeout 60s bash -c \"tcp_session ${user}\" >/dev/null 2>&1 &\n+    tcp_session ${user} >/dev/null 2>&1 &\n done\n \n for user in \"${HTTP_USERS[@]}\"; do\n-    timeout 60s bash -c \"http_session ${user}\" >/dev/null 2>&1 &\n+    http_session ${user} >/dev/null 2>&1 &\n done\n \n for user in \"${HTTP_WITH_SESSION_ID_SESSION_USERS[@]}\"; do\n-    timeout 60s bash -c \"http_with_session_id_session ${user}\" >/dev/null 2>&1 &\n+    http_with_session_id_session ${user} >/dev/null 2>&1 &\n done\n \n for user in \"${MYSQL_USERS[@]}\"; do\n-    timeout 60s bash -c \"mysql_session ${user}\" >/dev/null 2>&1 &\n+    mysql_session ${user} >/dev/null 2>&1 &\n done\n \n wait\n \n ${CLICKHOUSE_CLIENT} -q \"SYSTEM FLUSH LOGS\"\n \n-echo \"sessions:\" \n+echo \"sessions:\"\n ${CLICKHOUSE_CLIENT} -q \"SELECT count(*) FROM system.session_log WHERE user IN (${ALL_USERS_SQL_COLLECTION_STRING})\"\n \n-echo \"port_0_sessions:\" \n+echo \"port_0_sessions:\"\n ${CLICKHOUSE_CLIENT} -q \"SELECT count(*) FROM system.session_log WHERE user IN (${ALL_USERS_SQL_COLLECTION_STRING}) AND client_port = 0\"\n \n echo \"address_0_sessions:\"\n@@ -131,13 +131,13 @@ echo \"http_sessions\"\n ${CLICKHOUSE_CLIENT} -q \"SELECT count(*) FROM system.session_log WHERE user IN (${HTTP_USERS_SQL_COLLECTION_STRING}) AND interface = 'HTTP'\"\n echo \"http_with_session_id_sessions\"\n ${CLICKHOUSE_CLIENT} -q \"SELECT count(*) FROM system.session_log WHERE user IN (${HTTP_WITH_SESSION_ID_USERS_SQL_COLLECTION_STRING}) AND interface = 'HTTP'\"\n-echo \"my_sql_sessions\"\n+echo \"mysql_sessions\"\n ${CLICKHOUSE_CLIENT} -q \"SELECT count(*) FROM system.session_log WHERE user IN (${MYSQL_USERS_SQL_COLLECTION_STRING}) AND interface = 'MySQL'\"\n \n for user in \"${ALL_USERS[@]}\"; do\n     ${CLICKHOUSE_CLIENT} -q \"DROP USER ${user}\"\n-    echo \"Corresponding LoginSuccess/Logout\" \n+    echo \"Corresponding LoginSuccess/Logout\"\n     ${CLICKHOUSE_CLIENT} -q \"SELECT COUNT(*) FROM (SELECT ${SESSION_LOG_MATCHING_FIELDS} FROM system.session_log WHERE user = '${user}' AND type = 'LoginSuccess' INTERSECT SELECT ${SESSION_LOG_MATCHING_FIELDS} FROM system.session_log WHERE user = '${user}' AND type = 'Logout')\"\n     echo \"LoginFailure\"\n-    ${CLICKHOUSE_CLIENT} -q \"SELECT COUNT(*) FROM system.session_log WHERE user = '${user}' AND type = 'LoginFailure'\" \n+    ${CLICKHOUSE_CLIENT} -q \"SELECT COUNT(*) FROM system.session_log WHERE user = '${user}' AND type = 'LoginFailure'\"\n  done\n",
  "problem_statement": "Test `02833_concurrrent_sessions` has failed\n@Demilivor, this is your test.\r\n\r\nhttps://s3.amazonaws.com/clickhouse-test-reports/0/e32109174e069f698821a2cac7e1571d3377ebbe/stateless_tests__msan__[2_4].html\r\n\r\nIt has already failed several times in a year!\r\n\r\nhttps://play.clickhouse.com/play?user=play#U0VMRUNUIGNoZWNrX3N0YXJ0X3RpbWUsIGNoZWNrX25hbWUsIHRlc3RfbmFtZSwgcmVwb3J0X3VybApGUk9NIGNoZWNrcwpXSEVSRSBjaGVja19zdGFydF90aW1lID49IG5vdygpIC0gSU5URVJWQUwgMSBZRUFSCiAgICBBTkQgcHVsbF9yZXF1ZXN0X251bWJlciA9IDAKICAgIEFORCB0ZXN0X3N0YXR1cyAhPSAnU0tJUFBFRCcKICAgIEFORCAodGVzdF9zdGF0dXMgTElLRSAnRiUnIE9SIHRlc3Rfc3RhdHVzIExJS0UgJ0UlJykgCiAgICBBTkQgY2hlY2tfc3RhdHVzICE9ICdzdWNjZXNzJwogICAgQU5EIHBvc2l0aW9uKHRlc3RfbmFtZSwgJzAyODMzX2NvbmN1cnJyZW50X3Nlc3Npb25zJykgPiAwCk9SREVSIEJZIGNoZWNrX3N0YXJ0X3RpbWU=\n",
  "hints_text": "Hello Alexey,\r\n\r\nThanks for reporting the issue, \r\nThe test results hint at the fact that the test has some timing issues.\r\n\r\nI can't work on the test right now, I will fix it in a while as soon as I have free time.\r\n\r\n\nThat's not tolerable. The tests should not have timing issues.\r\nWe cannot have flaky tests, because they prevent working in the repository.\n@Demilivor In this test you don't need so many sessions. For example:\r\n\r\n```\r\nmy_sql_sessions\r\n30\r\nCorresponding LoginSuccess/Logout\r\n10\r\nLoginFailure\r\n10\r\nCorresponding LoginSuccess/Logout\r\n10\r\n```\r\n\r\nProbably one session per \"corresponding\" event is enough.\r\nAlso rely on timing as less as possible. Try organize the test for deterministically: remove any random timing things like: ` sleep(0.01${RANDOM})`.\r\n\n> my_sql_sessions\r\n\r\nThis is wrong, it should be \"MySQL\" or \"mysql\", not \"my sql\".\nThe test is named `concurrrent_sessions`, should be `concurrent_sessions`.",
  "created_at": "2024-07-27T15:19:12Z"
}