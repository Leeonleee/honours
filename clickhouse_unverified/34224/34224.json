{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 34224,
  "instance_id": "ClickHouse__ClickHouse-34224",
  "issue_numbers": [
    "34014"
  ],
  "base_commit": "a93aecf1cb9fc03bc6c71a1b860efda5edc5ba66",
  "patch": "diff --git a/src/Interpreters/ProcessList.cpp b/src/Interpreters/ProcessList.cpp\nindex 37b2992d657a..3c91f00ebf4c 100644\n--- a/src/Interpreters/ProcessList.cpp\n+++ b/src/Interpreters/ProcessList.cpp\n@@ -17,6 +17,11 @@\n #include <chrono>\n \n \n+namespace CurrentMetrics\n+{\n+    extern const Metric Query;\n+}\n+\n namespace DB\n {\n \n@@ -313,6 +318,7 @@ QueryStatus::QueryStatus(\n     , client_info(client_info_)\n     , priority_handle(std::move(priority_handle_))\n     , query_kind(query_kind_)\n+    , num_queries_increment(CurrentMetrics::Query)\n {\n     auto settings = getContext()->getSettings();\n     limits.max_execution_time = settings.max_execution_time;\ndiff --git a/src/Interpreters/ProcessList.h b/src/Interpreters/ProcessList.h\nindex 545e5b073453..2ba0b0814ee9 100644\n--- a/src/Interpreters/ProcessList.h\n+++ b/src/Interpreters/ProcessList.h\n@@ -121,6 +121,10 @@ class QueryStatus : public WithContext\n \n     IAST::QueryKind query_kind;\n \n+    /// This field is unused in this class, but it\n+    /// increments/decrements metric in constructor/destructor.\n+    CurrentMetrics::Increment num_queries_increment;\n+\n public:\n \n     QueryStatus(\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02190_current_metrics_query.reference b/tests/queries/0_stateless/02190_current_metrics_query.reference\nnew file mode 100644\nindex 000000000000..d00491fd7e5b\n--- /dev/null\n+++ b/tests/queries/0_stateless/02190_current_metrics_query.reference\n@@ -0,0 +1,1 @@\n+1\ndiff --git a/tests/queries/0_stateless/02190_current_metrics_query.sql b/tests/queries/0_stateless/02190_current_metrics_query.sql\nnew file mode 100644\nindex 000000000000..e8b22e92a99f\n--- /dev/null\n+++ b/tests/queries/0_stateless/02190_current_metrics_query.sql\n@@ -0,0 +1,2 @@\n+-- This query itself is also accounted in metric.\n+SELECT value > 0 FROM system.metrics WHERE metric = 'Query';\n",
  "problem_statement": "system.metrics name='Query' and system.metric_log CurrentMetric_Query gauge doesn't calculate anymore\n**Describe what's wrong**\r\nQuery metric doesn't calculate anymore\r\n```sql\r\nSELECT * FROM system.metrics WHERE metric='Query'\r\n```\r\nalways return value=0 \r\n\r\n```sql\r\nSELECT event_time, CurrentMetrics_Query FROM system.metric_log WHERE CurrentMetrics_Query>0\r\n```\r\nalways return 0 rows\r\n\r\nI check these queries during run following script in separate terminal\r\n```bash\r\nclickhouse-client -q \"SELECT sleepEachRow(1),now() FROM numbers(60)\"\r\n```\r\n\r\n**Does it reproduce on recent release?**\r\nYes it reproduce on 22.1 and 21.12\r\nAnd doesn't reproduce on 21.11\r\n\n",
  "hints_text": "I can confirm it reproduce on 22.12\r\nand doesn't reproduce on 21.8.",
  "created_at": "2022-02-01T12:10:51Z"
}