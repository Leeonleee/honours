{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 30562,
  "instance_id": "ClickHouse__ClickHouse-30562",
  "issue_numbers": [
    "30438"
  ],
  "base_commit": "1c72421e53b9a1553f6c8eea070069a7212c8aac",
  "patch": "diff --git a/src/Processors/QueryPlan/LimitStep.cpp b/src/Processors/QueryPlan/LimitStep.cpp\nindex 8c5e3e3c87c7..aff7472e4aa1 100644\n--- a/src/Processors/QueryPlan/LimitStep.cpp\n+++ b/src/Processors/QueryPlan/LimitStep.cpp\n@@ -40,7 +40,7 @@ void LimitStep::updateInputStream(DataStream input_stream)\n {\n     input_streams.clear();\n     input_streams.emplace_back(std::move(input_stream));\n-    output_stream = createOutputStream(input_streams.front(), output_stream->header, getDataStreamTraits());\n+    output_stream = createOutputStream(input_streams.front(), input_streams.front().header, getDataStreamTraits());\n }\n \n void LimitStep::transformPipeline(QueryPipelineBuilder & pipeline, const BuildQueryPipelineSettings &)\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02100_limit_push_down_bug.reference b/tests/queries/0_stateless/02100_limit_push_down_bug.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02100_limit_push_down_bug.sql b/tests/queries/0_stateless/02100_limit_push_down_bug.sql\nnew file mode 100644\nindex 000000000000..2ba9d2b8818d\n--- /dev/null\n+++ b/tests/queries/0_stateless/02100_limit_push_down_bug.sql\n@@ -0,0 +1,21 @@\n+drop table if exists tbl_repr;\n+\n+CREATE TABLE tbl_repr(\n+ts DateTime,\n+x  String)\n+ENGINE=MergeTree ORDER BY ts;\n+\n+\n+SELECT *\n+FROM\n+(\n+    SELECT\n+        x,\n+        length(x)\n+    FROM tbl_repr\n+    WHERE ts > now()\n+    LIMIT 1\n+)\n+WHERE x != '';\n+\n+drop table if exists tbl_repr;\n",
  "problem_statement": "Cannot find column `length(x)` in source stream\n**Describe what's wrong**\r\n\r\nCorrect query doesn't work.\r\n\r\n**Does it reproduce on recent release?**\r\n\r\nYes,\r\n\r\nClickHouse version 21.11\r\n\r\n```\r\nCREATE TABLE tbl_repr(\r\nts DateTime,\r\nx  String)\r\nENGINE=MergeTree ORDER BY ts;\r\n\r\nSELECT *\r\nFROM\r\n(\r\n    SELECT\r\n        x,\r\n        length(x)\r\n    FROM tbl_repr\r\n    WHERE ts > now()\r\n    LIMIT 1\r\n)\r\nWHERE x != ''\r\n\r\nQuery id: 083cdb34-500b-4b43-b096-9c8140165a65\r\n\r\n\r\n0 rows in set. Elapsed: 0.004 sec.\r\n\r\nReceived exception from server (version 21.11.1):\r\nCode: 8. DB::Exception: Received from localhost:9000. DB::Exception: Cannot find column `length(x)` in source stream, there are only columns: [x]. (THERE_IS_NO_COLUMN)\r\n```\r\n\r\n**Expected behavior**\r\n\r\nQuery works\r\n\r\n\r\n**Error message and/or stacktrace**\r\n\r\nCode: 8. DB::Exception: Received from localhost:9000. DB::Exception: Cannot find column `length(x)` in source stream, there are only columns: [x]. (THERE_IS_NO_COLUMN)\r\n\n",
  "hints_text": "@CurtizJ Maybe you have a clue.\nActually not.\r\n```sql\r\nSELECT *\r\nFROM\r\n(\r\n    SELECT\r\n        x,\r\n        length(x)\r\n    FROM tbl_repr\r\n    WHERE ts > now()\r\n    LIMIT 1\r\n)\r\nWHERE x != ''\r\nSETTINGS query_plan_enable_optimizations = 1\r\n\r\nReceived exception from server (version 21.11.1):\r\nCode: 8. DB::Exception: Received from localhost:9000. DB::Exception: Cannot find column `length(x)` in source stream, there are only columns: [x]. (THERE_IS_NO_COLUMN)\r\n```\r\n```sql\r\nSELECT *\r\nFROM\r\n(\r\n    SELECT\r\n        x,\r\n        length(x)\r\n    FROM tbl_repr\r\n    WHERE ts > now()\r\n    LIMIT 1\r\n)\r\nWHERE x != ''\r\nSETTINGS query_plan_enable_optimizations = 0\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.003 sec. \r\n```\r\n\r\n@KochetovNicolai, maybe you can take a look?",
  "created_at": "2021-10-22T13:21:55Z"
}