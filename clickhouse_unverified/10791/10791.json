{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 10791,
  "instance_id": "ClickHouse__ClickHouse-10791",
  "issue_numbers": [
    "6287"
  ],
  "base_commit": "9654532940fa5500ce1c4e6a613535a799e3f0bf",
  "patch": "diff --git a/src/Storages/MergeTree/KeyCondition.cpp b/src/Storages/MergeTree/KeyCondition.cpp\nindex 24f460cab647..6ae22885dfde 100644\n--- a/src/Storages/MergeTree/KeyCondition.cpp\n+++ b/src/Storages/MergeTree/KeyCondition.cpp\n@@ -710,8 +710,7 @@ static void castValueToType(const DataTypePtr & desired_type, Field & src_value,\n \n     try\n     {\n-        /// NOTE: We don't need accurate info about src_type at this moment\n-        src_value = convertFieldToType(src_value, *desired_type);\n+        src_value = convertFieldToType(src_value, *desired_type, src_type.get());\n     }\n     catch (...)\n     {\n",
  "test_patch": "diff --git a/tests/queries/1_stateful/00155_date_datetime_key_condition.reference b/tests/queries/1_stateful/00155_date_datetime_key_condition.reference\nnew file mode 100644\nindex 000000000000..01fa724e3e98\n--- /dev/null\n+++ b/tests/queries/1_stateful/00155_date_datetime_key_condition.reference\n@@ -0,0 +1,10 @@\n+['2020-01-01 10:00:00']\n+['2020-01-02 00:00:00']\n+['2020-01-01 00:00:00','2020-01-01 10:00:00']\n+['2020-01-01 00:00:00','2020-01-01 10:00:00','2020-01-02 00:00:00']\n+['2020-01-01 00:00:00','2020-01-01 10:00:00','2020-01-02 00:00:00']\n+['2020-01-01 00:00:00','2020-01-01 10:00:00','2020-01-02 00:00:00']\n+['2020-01-01 00:00:00','2020-01-01 10:00:00','2020-01-02 00:00:00']\n+[]\n+[]\n+[]\ndiff --git a/tests/queries/1_stateful/00155_date_datetime_key_condition.sql b/tests/queries/1_stateful/00155_date_datetime_key_condition.sql\nnew file mode 100644\nindex 000000000000..cee1c7cfb46f\n--- /dev/null\n+++ b/tests/queries/1_stateful/00155_date_datetime_key_condition.sql\n@@ -0,0 +1,22 @@\n+DROP TABLE IF EXISTS test.date_datetime_key_condition;\n+\n+CREATE TABLE test.date_datetime_key_condition (dt DateTime) ENGINE = MergeTree() ORDER BY dt;\n+INSERT INTO test.date_datetime_key_condition VALUES ('2020-01-01 00:00:00'), ('2020-01-01 10:00:00'), ('2020-01-02 00:00:00');\n+\n+-- partial\n+SELECT groupArray(dt) from test.date_datetime_key_condition WHERE dt > toDate('2020-01-01') AND dt < toDate('2020-01-02');\n+SELECT groupArray(dt) from test.date_datetime_key_condition WHERE dt >= toDate('2020-01-02');\n+SELECT groupArray(dt) from test.date_datetime_key_condition WHERE dt < toDate('2020-01-02');\n+\n+-- inside\n+SELECT groupArray(dt) from test.date_datetime_key_condition WHERE dt > toDate('2019-01-02');\n+SELECT groupArray(dt) from test.date_datetime_key_condition WHERE dt < toDate('2021-01-02');\n+SELECT groupArray(dt) from test.date_datetime_key_condition WHERE dt >= toDate('2019-01-02') AND dt < toDate('2021-01-02');\n+SELECT groupArray(dt) from test.date_datetime_key_condition WHERE dt > toDate('2019-01-02') OR dt <= toDate('2021-01-02');\n+\n+-- outside \n+SELECT groupArray(dt) from test.date_datetime_key_condition WHERE dt < toDate('2019-01-02');\n+SELECT groupArray(dt) from test.date_datetime_key_condition WHERE dt > toDate('2021-01-02');\n+SELECT groupArray(dt) from test.date_datetime_key_condition WHERE dt < toDate('2019-01-02') OR dt > toDate('2021-01-02');\n+\n+DROP TABLE test.date_datetime_key_condition;\n\\ No newline at end of file\n",
  "problem_statement": "Select DateTime less Date doesn't work\nComparison DateTime and Date in SELECT doesn't work\r\nWhen I limit DateTime from below it works normally. But limit on top - doesn't work\r\n![Select](https://user-images.githubusercontent.com/51990161/62343237-31251d00-b514-11e9-826a-e8e79ed0b303.png)\r\n\n",
  "hints_text": "```\r\nSELECT now() > (today() - 1)\r\n\r\n\u250c\u2500greater(now(), minus(today(), 1))\u2500\u2510\r\n\u2502                                 1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\nSELECT now() < (today() + 1)\r\n\r\n\u250c\u2500less(now(), plus(today(), 1))\u2500\u2510\r\n\u2502                             1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\nprobably index related issue. \r\n\r\n@dkhodorchenko please check a result of \r\nselect count()\r\nfrom radacct\r\nwhere identity(acctstarttime) < ....\n![identity](https://user-images.githubusercontent.com/51990161/62434417-645ceb80-b762-11e9-9416-550efc9212ba.png)\r\n\r\nWith identity it works\r\n\n@dkhodorchenko can you show radacct DDL ? partition / orderby section.\r\nI suspect this is a duplicate for https://github.com/yandex/ClickHouse/issues/5131\nSTR:\r\n\r\n```\r\ncreate table radacct (acctstarttime DateTime) Engine=MergeTree order by acctstarttime;\r\ninsert into radacct select now() + number%545 from numbers(10000);\r\ninsert into radacct select '2019-09-01 00:01:01';\r\n\r\nselect count() from radacct \r\nwhere acctstarttime between toDate('2019-09-01') and toDate('2019-09-02');\r\n\r\nOk.\r\n0 rows in set. Elapsed: 0.002 sec.\r\n\r\n\r\nselect count() from radacct \r\nwhere acctstarttime between toDateTime(toDate('2019-09-01')) and toDateTime(toDate('2019-09-02'));\r\n\u250c\u2500count()\u2500\u2510\r\n\u2502       1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n\r\nselect count() from radacct \r\nwhere identity(acctstarttime) between toDate('2019-09-01') and toDate('2019-09-02');\r\n\u250c\u2500count()\u2500\u2510\r\n\u2502       1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n```\r\n\r\n19.13.1.1010 (official build)\r\n\r\nrelated https://github.com/yandex/ClickHouse/issues/6248\n`ENGINE = MergeTree\r\n PARTITION BY toYYYYMM(acctstarttime)\r\n ORDER BY (acctstarttime)\r\n  `\nstill relevant.  Still wrong query result.\n@CurtizJ This issue is still relevant.",
  "created_at": "2020-05-10T23:22:21Z"
}