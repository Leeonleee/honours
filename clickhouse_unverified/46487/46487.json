{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 46487,
  "instance_id": "ClickHouse__ClickHouse-46487",
  "issue_numbers": [
    "45185"
  ],
  "base_commit": "3f424301cd0bdee58ec282eb2110b8e0acbcd1cf",
  "patch": "diff --git a/src/Interpreters/TreeRewriter.cpp b/src/Interpreters/TreeRewriter.cpp\nindex f88094ffbc63..025572fd5db8 100644\n--- a/src/Interpreters/TreeRewriter.cpp\n+++ b/src/Interpreters/TreeRewriter.cpp\n@@ -655,10 +655,7 @@ void collectJoinedColumns(TableJoin & analyzed_join, ASTTableJoin & table_join,\n     {\n         bool join_on_const_ok = tryJoinOnConst(analyzed_join, table_join.on_expression, context);\n         if (join_on_const_ok)\n-        {\n-            table_join.on_expression = nullptr;\n             return;\n-        }\n \n         bool is_asof = (table_join.strictness == JoinStrictness::Asof);\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02552_inner_join_with_where_true.reference b/tests/queries/0_stateless/02552_inner_join_with_where_true.reference\nnew file mode 100644\nindex 000000000000..55e1eabd3b53\n--- /dev/null\n+++ b/tests/queries/0_stateless/02552_inner_join_with_where_true.reference\n@@ -0,0 +1,3 @@\n+1\t2\n+1\t1\n+0\t0\ndiff --git a/tests/queries/0_stateless/02552_inner_join_with_where_true.sql b/tests/queries/0_stateless/02552_inner_join_with_where_true.sql\nnew file mode 100644\nindex 000000000000..223fafb5319d\n--- /dev/null\n+++ b/tests/queries/0_stateless/02552_inner_join_with_where_true.sql\n@@ -0,0 +1,9 @@\n+CREATE TABLE t0 (c0 Int32) ENGINE = Memory;\n+CREATE TABLE t1 (c1 Int32) ENGINE = Memory;\n+\n+INSERT INTO t0(c0) VALUES (1), (2);\n+INSERT INTO t1(c1) VALUES (1);\n+\n+SELECT max(1), count() FROM t0 AS t0 LEFT JOIN t1 ON true WHERE 1;\n+SELECT max(1), count() FROM t0 AS t0 INNER JOIN t1 ON t0.c0 = t1.c1 WHERE 1;\n+SELECT max(1), count() FROM t0 AS t0 INNER JOIN t1 ON true WHERE 0;\n",
  "problem_statement": "Aggregation results are different when just `WHERE true` added\nPrepare data:\r\n```\r\nDROP DATABASE IF EXISTS database9TLPAggregate;\r\nCREATE DATABASE IF NOT EXISTS database9TLPAggregate;\r\nUSE database9TLPAggregate;\r\nCREATE TABLE database9TLPAggregate.t0 (c0 String) ENGINE = Log() ;\r\nCREATE TABLE database9TLPAggregate.t1 (c0 Int32) ENGINE = Log() ;\r\nCREATE TABLE IF NOT EXISTS database9TLPAggregate.t2 (c0 String) ENGINE = Log() ;\r\nCREATE TABLE IF NOT EXISTS database9TLPAggregate.t3 (c0 Int32) ENGINE = Log() ;\r\nCREATE TABLE database9TLPAggregate.t4 (c0 String) ENGINE = MergeTree()  ORDER BY c0;\r\nINSERT INTO t3(c0) VALUES (-433424209);\r\nINSERT INTO t3(c0) VALUES (1924849780), (350410727);\r\nINSERT INTO t0(c0) VALUES ('#]-');\r\nINSERT INTO t4(c0) VALUES ('859440159');\r\nINSERT INTO t1(c0) VALUES (-806303643);\r\nINSERT INTO t0(c0) VALUES ('w');\r\nINSERT INTO t4(c0) VALUES ('1228837680');\r\nINSERT INTO t1(c0) VALUES (86642829), (-178295749);\r\nINSERT INTO t4(c0) VALUES ('');\r\nINSERT INTO t2(c0) VALUES ('GmS#7<I?');\r\nINSERT INTO t2(c0) VALUES ('|');\r\nINSERT INTO t0(c0) VALUES ('-1887896159'), ('hx'), ('');\r\nINSERT INTO t4(c0) VALUES ('426356725');\r\n```\r\n\r\nSomething is completely wrong. There originally constant expression `intDiv(-731974690, '' < '8') < 1280677533` that is always `true`. I checked with actually `WHERE true` and it has the same issue. Aggregation result differs just by adding `WHERE true`. \r\n\r\n```\r\nSELECT\r\n    MAX(-1690797) AS aggr,\r\n    true\r\nFROM t3 AS t3\r\nINNER JOIN t4 AS right_0 ON gcd(-2021105281, 1441404898) = erf(1273027572)\r\n\r\nQuery id: 9db00e57-d888-48b8-b665-8d4374a160f4\r\n\r\n\u250c\u2500\u2500\u2500\u2500\u2500aggr\u2500\u252c\u2500true\u2500\u2510\r\n\u2502 -1690797 \u2502 true \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.005 sec.\r\n\r\nip-172-31-0-52 :) SELECT MAX(-1690797) AS aggr, true\r\n                  FROM t3 AS t3\r\n                  INNER JOIN t4 AS right_0 ON gcd(-2021105281, 1441404898) = erf(1273027572) WHERE true;\r\n\r\nSELECT\r\n    MAX(-1690797) AS aggr,\r\n    true\r\nFROM t3 AS t3\r\nINNER JOIN t4 AS right_0 ON gcd(-2021105281, 1441404898) = erf(1273027572)\r\nWHERE true\r\n\r\nQuery id: 80350053-693c-4c83-9a0c-7030b1c6faeb\r\n\r\n\u250c\u2500aggr\u2500\u252c\u2500true\u2500\u2510\r\n\u2502    0 \u2502 true \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.005 sec.\r\n```\n",
  "hints_text": "Analyzer fixes this problem \r\n```\r\nSELECT\r\n    max(1),\r\n    count()\r\nFROM t3 AS t3\r\nINNER JOIN t4 AS right_0 ON true\r\nWHERE 1\r\nSETTINGS allow_experimental_analyzer = 1\r\n\r\nQuery id: 6a2351da-a014-4a6b-bd7c-cbed481153a5\r\n\r\n\u250c\u2500max(1)\u2500\u252c\u2500count()\u2500\u2510\r\n\u2502      1 \u2502      12 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.005 sec.\r\n```\r\n\r\nSimplified JOIN\r\n```\r\nSELECT\r\n    max(1),\r\n    count()\r\nFROM t3 AS t3\r\nINNER JOIN t4 AS right_0 ON true\r\nWHERE 1\r\n\r\nQuery id: b86ea865-dd6d-46bd-9fd1-43307e23dab9\r\n\r\n\u250c\u2500max(1)\u2500\u252c\u2500count()\u2500\u2510\r\n\u2502      0 \u2502       0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 row in set. Elapsed: 0.005 sec.\r\n\r\nSELECT\r\n    max(1),\r\n    count()\r\nFROM t3 AS t3\r\nINNER JOIN t4 AS right_0 ON true\r\n\r\nQuery id: fc226c72-5ef7-4425-bdf5-719a34c72676\r\n\r\n\u250c\u2500max(1)\u2500\u252c\u2500count()\u2500\u2510\r\n\u2502      1 \u2502      12 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n```",
  "created_at": "2023-02-16T15:17:19Z"
}