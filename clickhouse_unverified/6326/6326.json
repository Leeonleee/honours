{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 6326,
  "instance_id": "ClickHouse__ClickHouse-6326",
  "issue_numbers": [
    "6242"
  ],
  "base_commit": "a0599214efc78707eb6ac4d3ff6243b3d4b213e7",
  "patch": "diff --git a/dbms/src/Functions/IFunction.cpp b/dbms/src/Functions/IFunction.cpp\nindex c05ece54e11b..f4dbac7c638d 100644\n--- a/dbms/src/Functions/IFunction.cpp\n+++ b/dbms/src/Functions/IFunction.cpp\n@@ -232,10 +232,9 @@ bool PreparedFunctionImpl::defaultImplementationForConstantArguments(Block & blo\n         const ColumnWithTypeAndName & column = block.getByPosition(args[arg_num]);\n \n         if (arguments_to_remain_constants.end() != std::find(arguments_to_remain_constants.begin(), arguments_to_remain_constants.end(), arg_num))\n-            if (column.column->empty())\n-                temporary_block.insert({column.column->cloneResized(1), column.type, column.name});\n-            else\n-                temporary_block.insert(column);\n+        {\n+            temporary_block.insert({column.column->cloneResized(1), column.type, column.name});\n+        }\n         else\n         {\n             have_converted_columns = true;\ndiff --git a/dbms/src/Functions/array/arrayReduce.cpp b/dbms/src/Functions/array/arrayReduce.cpp\nindex ffab005e949f..516449a48721 100644\n--- a/dbms/src/Functions/array/arrayReduce.cpp\n+++ b/dbms/src/Functions/array/arrayReduce.cpp\n@@ -111,8 +111,6 @@ void FunctionArrayReduce::executeImpl(Block & block, const ColumnNumbers & argum\n \n     std::unique_ptr<Arena> arena = agg_func.allocatesMemoryInArena() ? std::make_unique<Arena>() : nullptr;\n \n-    size_t rows = input_rows_count;\n-\n     /// Aggregate functions do not support constant columns. Therefore, we materialize them.\n     std::vector<ColumnPtr> materialized_columns;\n \n@@ -124,6 +122,7 @@ void FunctionArrayReduce::executeImpl(Block & block, const ColumnNumbers & argum\n     for (size_t i = 0; i < num_arguments_columns; ++i)\n     {\n         const IColumn * col = block.getByPosition(arguments[i + 1]).column.get();\n+\n         const ColumnArray::Offsets * offsets_i = nullptr;\n         if (const ColumnArray * arr = checkAndGetColumn<ColumnArray>(col))\n         {\n@@ -159,7 +158,7 @@ void FunctionArrayReduce::executeImpl(Block & block, const ColumnNumbers & argum\n                         + block.getByPosition(result).type->getName(), ErrorCodes::ILLEGAL_COLUMN);\n \n     ColumnArray::Offset current_offset = 0;\n-    for (size_t i = 0; i < rows; ++i)\n+    for (size_t i = 0; i < input_rows_count; ++i)\n     {\n         agg_func.create(place);\n         ColumnArray::Offset next_offset = (*offsets)[i];\n",
  "test_patch": "diff --git a/dbms/tests/queries/0_stateless/00978_sum_map_bugfix.reference b/dbms/tests/queries/0_stateless/00978_sum_map_bugfix.reference\nnew file mode 100644\nindex 000000000000..135fc035446b\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00978_sum_map_bugfix.reference\n@@ -0,0 +1,43 @@\n+0\t([100,200],[30,30])\n+0\t([100,200],[30,30])\n+1\t([100,200],[30,30])\n+2\t([100,200],[30,30])\n+3\t([100,200],[30,30])\n+4\t([100,200],[30,30])\n+5\t([100,200],[30,30])\n+6\t([100,200],[30,30])\n+7\t([100,200],[30,30])\n+8\t([100,200],[30,30])\n+9\t([100,200],[30,30])\n+0\t([100,200],[30,30])\n+1\t([100,200],[30,30])\n+2\t([100,200],[30,30])\n+3\t([100,200],[30,30])\n+4\t([100,200],[30,30])\n+5\t([100,200],[30,30])\n+6\t([100,200],[30,30])\n+7\t([100,200],[30,30])\n+8\t([100,200],[30,30])\n+9\t([100,200],[30,30])\n+0\t400\n+1\t400\n+2\t400\n+3\t400\n+4\t400\n+5\t400\n+6\t400\n+7\t400\n+8\t400\n+9\t400\n+0\t[100,100,200]\n+1\t[100,100,200]\n+2\t[100,100,200]\n+3\t[100,100,200]\n+4\t[100,100,200]\n+5\t[100,100,200]\n+6\t[100,100,200]\n+7\t[100,100,200]\n+8\t[100,100,200]\n+9\t[100,100,200]\n+Array(Array(UInt8)), Const(size = 2, Array(size = 1, UInt64(size = 1), Array(size = 1, UInt64(size = 1), UInt8(size = 2))))\t([1,2],[1,2])\n+Array(Array(UInt8)), Const(size = 2, Array(size = 1, UInt64(size = 1), Array(size = 1, UInt64(size = 1), UInt8(size = 2))))\t([1,2],[1,2])\ndiff --git a/dbms/tests/queries/0_stateless/00978_sum_map_bugfix.sql b/dbms/tests/queries/0_stateless/00978_sum_map_bugfix.sql\nnew file mode 100644\nindex 000000000000..091c56c68683\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00978_sum_map_bugfix.sql\n@@ -0,0 +1,7 @@\n+select number, arrayReduce( 'sumMap', [a],[b]  ) from (select [100,100,200] a,[10,20,30] b, number from numbers(1));\n+select number, arrayReduce( 'sumMap', [a],[b]  ) from (select materialize([100,100,200]) a,materialize([10,20,30]) b, number from numbers(10));\n+select number, arrayReduce( 'sumMap', [a],[b]  ) from (select [100,100,200] a,[10,20,30] b, number from numbers(10));\n+select number, arrayReduce( 'sum', a) from (select materialize([100,100,200]) a, number from numbers(10));\n+select number, arrayReduce( 'max', [a] ) from (select materialize([100,100,200]) a, number from numbers(10));\n+\n+select dumpColumnStructure([a]), arrayReduce('sumMap', [a], [a]) from (select [1, 2] a FROM numbers(2));\n",
  "problem_statement": "overflow when using arrayReduce + sumMap on constant params \nProper behaviour\r\n```\r\nselect number, arrayReduce( 'sumMap', [a],[b]  ) from (select [100,100,200] a,[10,20,30] b, number from numbers(1));\r\n\r\nselect number, arrayReduce( 'sumMap', [a],[b]  ) from (select materialize([100,100,200]) a,materialize([10,20,30]) b, number from numbers(20));\r\n```\r\n\r\n\r\nNot proper behaviour:\r\n```\r\nselect number, arrayReduce( 'sumMap', [a],[b]  ) from (select [100,100,200] a,[10,20,30] b, number from numbers(2));\r\n\r\n\u2198 Progress: 0.00 rows, 0.00 B (0.00 rows/s., 0.00 B/s.) Received exception from server (version 19.11.3):\r\nCode: 48. DB::Exception: Received from localhost:9000. DB::Exception: Cannot cloneResized() column Tuple(Array(UInt8), Array(UInt64)). \r\n\r\n-- once again => another exception!\r\nselect number, arrayReduce( 'sumMap', [a],[b]  ) from (select [100,100,200] a,[10,20,30] b, number from numbers(2));\r\n\r\n\u2196 Progress: 0.00 rows, 0.00 B (0.00 rows/s., 0.00 B/s.) Received exception from server (version 19.11.3):\r\nCode: 49. DB::Exception: Received from localhost:9000. DB::Exception: Sizes of keys and values arrays do not match. \r\n```\r\n\r\nOn 19.6 also encounter segfault \r\n```\r\n2019.07.31 16:14:38.453594 [ 47 ] {} <Error> BaseDaemon: ########################################\r\n2019.07.31 16:14:38.453654 [ 47 ] {} <Error> BaseDaemon: (version 19.6.2.1) (from thread 45) Received signal Segmentation fault (11).\r\n2019.07.31 16:14:38.453669 [ 47 ] {} <Error> BaseDaemon: Address: 0x7f5de7a00000\r\n2019.07.31 16:14:38.453676 [ 47 ] {} <Error> BaseDaemon: Access: read.\r\n2019.07.31 16:14:38.453683 [ 47 ] {} <Error> BaseDaemon: Address not mapped to object.\r\n2019.07.31 16:14:38.482454 [ 47 ] {} <Error> BaseDaemon: 0. clickhouse-server(DB::ColumnVector<unsigned char>::get(unsigned long, DB::Field&) const+0xf) [0x32e9a6f]\r\n2019.07.31 16:14:38.482487 [ 47 ] {} <Error> BaseDaemon: 1. clickhouse-server() [0x5c4659c]\r\n2019.07.31 16:14:38.482505 [ 47 ] {} <Error> BaseDaemon: 2. clickhouse-server(DB::FunctionArrayReduce::executeImpl(DB::Block&, std::vector<unsigned long, std::allocator<unsigned long> > const&, unsigned long, unsigned long)+0x466) [0x38dc596]\r\n2019.07.31 16:14:38.482517 [ 47 ] {} <Error> BaseDaemon: 3. clickhouse-server(DB::PreparedFunctionImpl::defaultImplementationForConstantArguments(DB::Block&, std::vector<unsigned long, std::allocator<unsigned long> > const&, unsigned long, unsigned long, bool)+0x49f) [0x634b79f]\r\n2019.07.31 16:14:38.482527 [ 47 ] {} <Error> BaseDaemon: 4. clickhouse-server(DB::PreparedFunctionImpl::executeWithoutLowCardinalityColumns(DB::Block&, std::vector<unsigned long, std::allocator<unsigned long> > const&, unsigned long, unsigned long, bool)+0x35) [0x634be75]\r\n2019.07.31 16:14:38.482537 [ 47 ] {} <Error> BaseDaemon: 5. clickhouse-server(DB::PreparedFunctionImpl::execute(DB::Block&, std::vector<unsigned long, std::allocator<unsigned long> > const&, unsigned long, unsigned long, bool)+0x378) [0x634c518]\r\n2019.07.31 16:14:38.482547 [ 47 ] {} <Error> BaseDaemon: 6. clickhouse-server(DB::ExpressionAction::execute(DB::Block&, bool) const+0x264) [0x64e5ed4]\r\n2019.07.31 16:14:38.482556 [ 47 ] {} <Error> BaseDaemon: 7. clickhouse-server(DB::ExpressionActions::execute(DB::Block&, bool) const+0x45) [0x64e7ab5]\r\n2019.07.31 16:14:38.482565 [ 47 ] {} <Error> BaseDaemon: 8. clickhouse-server(DB::ExpressionBlockInputStream::readImpl()+0x35) [0x63adee5]\r\n2019.07.31 16:14:38.482577 [ 47 ] {} <Error> BaseDaemon: 9. clickhouse-server(DB::IBlockInputStream::read()+0x135) [0x5e338a5]\r\n2019.07.31 16:14:38.482586 [ 47 ] {} <Error> BaseDaemon: 10. clickhouse-server(DB::ExpressionBlockInputStream::readImpl()+0x1a) [0x63adeca]\r\n2019.07.31 16:14:38.482596 [ 47 ] {} <Error> BaseDaemon: 11. clickhouse-server(DB::IBlockInputStream::read()+0x135) [0x5e338a5]\r\n2019.07.31 16:14:38.482604 [ 47 ] {} <Error> BaseDaemon: 12. clickhouse-server(DB::AsynchronousBlockInputStream::calculate()+0x43) [0x5e2dca3]\r\n2019.07.31 16:14:38.482612 [ 47 ] {} <Error> BaseDaemon: 13. clickhouse-server() [0x5e2e11a]\r\n2019.07.31 16:14:38.482621 [ 47 ] {} <Error> BaseDaemon: 14. clickhouse-server(ThreadPoolImpl<ThreadFromGlobalPool>::worker(std::_List_iterator<ThreadFromGlobalPool>)+0x187) [0x68d8717]\r\n2019.07.31 16:14:38.482639 [ 47 ] {} <Error> BaseDaemon: 15. clickhouse-server(_ZZN20ThreadFromGlobalPoolC4IZN14ThreadPoolImplIS_E12scheduleImplIvEET_St8functionIFvvEEiSt8optionalImEEUlvE1_JEEEOS4_DpOT0_ENKUlvE_clEv+0x28) [0x68d9828]\r\n2019.07.31 16:14:38.482648 [ 47 ] {} <Error> BaseDaemon: 16. clickhouse-server(ThreadPoolImpl<std::thread>::worker(std::_List_iterator<std::thread>)+0x187) [0x68d7947]\r\n2019.07.31 16:14:38.482660 [ 47 ] {} <Error> BaseDaemon: 17. clickhouse-server() [0x745371f]\r\n2019.07.31 16:14:38.482668 [ 47 ] {} <Error> BaseDaemon: 18. /lib64/libpthread.so.0(+0x7e25) [0x7f5df32fde25]\r\n```\r\n\r\n\r\nMaster with asan:\r\n```\r\nInclude not found: clickhouse_remote_servers\r\nInclude not found: clickhouse_compression\r\n=================================================================\r\n==1==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60600009f780 at pc 0x0000079cfa15 bp 0x7f9003a8afb0 sp 0x7f9003a8afa8\r\nREAD of size 1 at 0x60600009f780 thread T36 (AsyncBlockInput)\r\n    #0 0x79cfa14 in DB::ColumnVector<unsigned char>::get(unsigned long, DB::Field&) const (/usr/bin/clickhouse+0x79cfa14)\r\n    #1 0x107114ea in DB::AggregateFunctionSumMapBase<unsigned char, DB::AggregateFunctionSumMap<unsigned char, DB::(anonymous namespace)::WithoutOverflowPolicy>, DB::(anonymous namespace)::WithoutOverflowPolicy>::add(char*, DB::IColumn const**, unsigned long, DB::Arena*) const /build/obj-x86_64-linux-gnu/../dbms/src/AggregateFunctions/AggregateFunctionSumMap.h:112:40\r\n    #2 0xdcd2cee in DB::FunctionArrayReduce::executeImpl(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long) (/usr/bin/clickhouse+0xdcd2cee)\r\n    #3 0x13750d85 in DB::PreparedFunctionImpl::executeWithoutLowCardinalityColumns(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) /build/obj-x86_64-linux-gnu/../dbms/src/Functions/IFunction.cpp:312:9\r\n    #4 0x13750d85 in DB::PreparedFunctionImpl::defaultImplementationForConstantArguments(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) /build/obj-x86_64-linux-gnu/../dbms/src/Functions/IFunction.cpp:259\r\n    #5 0x137549c6 in DB::PreparedFunctionImpl::executeWithoutLowCardinalityColumns(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) /build/obj-x86_64-linux-gnu/../dbms/src/Functions/IFunction.cpp:303:9\r\n    #6 0x137549c6 in DB::PreparedFunctionImpl::execute(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) /build/obj-x86_64-linux-gnu/../dbms/src/Functions/IFunction.cpp:463\r\n    #7 0x11ed16cf in DB::ExpressionAction::execute(DB::Block&, bool) const /build/obj-x86_64-linux-gnu/../dbms/src/Interpreters/ExpressionActions.cpp:362:23\r\n    #8 0x11eef97d in DB::ExpressionActions::execute(DB::Block&, bool) const /build/obj-x86_64-linux-gnu/../dbms/src/Interpreters/ExpressionActions.cpp:738:16\r\n    #9 0x1234d0f1 in DB::ExpressionBlockInputStream::readImpl() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/ExpressionBlockInputStream.cpp:35:21\r\n    #10 0x119d29e4 in DB::IBlockInputStream::read() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/IBlockInputStream.cpp:56:15\r\n    #11 0x1234d09d in DB::ExpressionBlockInputStream::readImpl() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/ExpressionBlockInputStream.cpp:33:34\r\n    #12 0x119d29e4 in DB::IBlockInputStream::read() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/IBlockInputStream.cpp:56:15\r\n    #13 0x119ce444 in DB::AsynchronousBlockInputStream::calculate() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/AsynchronousBlockInputStream.cpp:74:34\r\n    #14 0x119cf406 in DB::AsynchronousBlockInputStream::next()::$_0::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/AsynchronousBlockInputStream.cpp:59:9\r\n    #15 0x119cf406 in _ZNSt3__18__invokeIRZN2DB28AsynchronousBlockInputStream4nextEvE3$_0JEEEDTclclsr3std3__1E7forwardIT_Efp_Espclsr3std3__1E7forwardIT0_Efp0_EEEOS5_DpOS6_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4410\r\n    #16 0x119cf406 in void std::__1::__invoke_void_return_wrapper<void>::__call<DB::AsynchronousBlockInputStream::next()::$_0&>(DB::AsynchronousBlockInputStream::next()::$_0&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__functional_base:348\r\n    #17 0x119cf406 in std::__1::__function::__alloc_func<DB::AsynchronousBlockInputStream::next()::$_0, std::__1::allocator<DB::AsynchronousBlockInputStream::next()::$_0>, void ()>::operator()() /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1527\r\n    #18 0x119cf406 in std::__1::__function::__func<DB::AsynchronousBlockInputStream::next()::$_0, std::__1::allocator<DB::AsynchronousBlockInputStream::next()::$_0>, void ()>::operator()() /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1651\r\n    #19 0x748fc6b in std::__1::__function::__value_func<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1799:16\r\n    #20 0x748fc6b in std::__1::function<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2347\r\n    #21 0x748fc6b in ThreadPoolImpl<ThreadFromGlobalPool>::worker(std::__1::__list_iterator<ThreadFromGlobalPool, void*>) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:177\r\n    #22 0x7497746 in ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:73:73\r\n    #23 0x7497746 in _ZNSt3__118__invoke_constexprIRKZN14ThreadPoolImplI20ThreadFromGlobalPoolE12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEDTclclsr3std3__1E7forwardIS5_Efp_Espclsr3std3__1E7forwardIT0_Efp0_EEEOS5_DpOSE_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4416\r\n    #24 0x7497746 in decltype(auto) std::__1::__apply_tuple_impl<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&, std::__1::__tuple_indices<>) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/tuple:1358\r\n    #25 0x7497746 in decltype(auto) std::__1::apply<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/tuple:1367\r\n    #26 0x7497746 in ThreadFromGlobalPool::ThreadFromGlobalPool<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&)::{lambda()#1}::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.h:147\r\n    #27 0x7497746 in _ZNSt3__18__invokeIRZN20ThreadFromGlobalPoolC1IZN14ThreadPoolImplIS1_E12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEOS6_DpOT0_EUlvE_JEEEDTclclsr3std3__1E7forwardIS6_Efp_Espclsr3std3__1E7forwardISE_Efp0_EEESD_SG_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4410\r\n    #28 0x7497746 in void std::__1::__invoke_void_return_wrapper<void>::__call<ThreadFromGlobalPool::ThreadFromGlobalPool<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&)::{lambda()#1}&>(ThreadFromGlobalPool::ThreadFromGlobalPool<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&)::{lambda()#1}&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__functional_base:348\r\n    #29 0x7497746 in _ZNSt3__110__function12__alloc_funcIZN20ThreadFromGlobalPoolC1IZN14ThreadPoolImplIS2_E12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEOS7_DpOT0_EUlvE_NS_9allocatorISI_EES9_EclEv /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1527\r\n    #30 0x7497746 in _ZNSt3__110__function6__funcIZN20ThreadFromGlobalPoolC1IZN14ThreadPoolImplIS2_E12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEOS7_DpOT0_EUlvE_NS_9allocatorISI_EES9_EclEv /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1651\r\n    #31 0x7489a9e in std::__1::__function::__value_func<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1799:16\r\n    #32 0x7489a9e in std::__1::function<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2347\r\n    #33 0x7489a9e in ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:177\r\n    #34 0x7492f17 in ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:73:73\r\n    #35 0x7492f17 in _ZNSt3__18__invokeIZN14ThreadPoolImplINS_6threadEE12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEDTclclsr3std3__1E7forwardIS5_Efp_Espclsr3std3__1E7forwardIT0_Efp0_EEEOS5_DpOSC_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4410\r\n    #36 0x7492f17 in void std::__1::__thread_execute<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>&, std::__1::__tuple_indices<>) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/thread:341\r\n    #37 0x7492f17 in void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}> >(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/thread:351\r\n    #38 0x7f90695456da in start_thread (/lib/x86_64-linux-gnu/libpthread.so.0+0x76da)\r\n    #39 0x7f9068ed088e in clone (/lib/x86_64-linux-gnu/libc.so.6+0x12188e)\r\n\r\n0x60600009f780 is located 0 bytes to the right of 64-byte region [0x60600009f740,0x60600009f780)\r\nallocated by thread T36 (AsyncBlockInput) here:\r\n    #0 0x735c292 in __interceptor_realloc (/usr/bin/clickhouse+0x735c292)\r\n    #1 0x7460535 in AllocatorWithHint<false, AllocatorHints::DefaultHint, 67108864ul>::realloc(void*, unsigned long, unsigned long, unsigned long) /build/obj-x86_64-linux-gnu/../dbms/src/Common/Allocator.h:144:30\r\n    #2 0x74602ad in void DB::PODArrayBase<1ul, 4096ul, AllocatorWithHint<false, AllocatorHints::DefaultHint, 67108864ul>, 15ul, 16ul>::realloc<>(unsigned long) /build/obj-x86_64-linux-gnu/../dbms/src/Common/PODArray.h:139:29\r\n    #3 0x74602ad in void DB::PODArrayBase<1ul, 4096ul, AllocatorWithHint<false, AllocatorHints::DefaultHint, 67108864ul>, 15ul, 16ul>::reserve<>(unsigned long) /build/obj-x86_64-linux-gnu/../dbms/src/Common/PODArray.h:208\r\n    #4 0x12917a78 in void DB::PODArrayBase<1ul, 4096ul, AllocatorWithHint<false, AllocatorHints::DefaultHint, 67108864ul>, 15ul, 16ul>::resize<>(unsigned long) /build/obj-x86_64-linux-gnu/../dbms/src/Common/PODArray.h:214:9\r\n    #5 0x12917a78 in DB::ColumnVector<unsigned char>::insertRangeFrom(DB::IColumn const&, unsigned long, unsigned long) /build/obj-x86_64-linux-gnu/../dbms/src/Columns/ColumnVector.cpp:237\r\n    #6 0x12818aee in DB::ColumnArray::insertFrom(DB::IColumn const&, unsigned long) /build/obj-x86_64-linux-gnu/../dbms/src/Columns/ColumnArray.cpp:234:15\r\n    #7 0xda78f58 in DB::FunctionArray::executeImpl(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long) (/usr/bin/clickhouse+0xda78f58)\r\n    #8 0x13750d85 in DB::PreparedFunctionImpl::executeWithoutLowCardinalityColumns(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) /build/obj-x86_64-linux-gnu/../dbms/src/Functions/IFunction.cpp:312:9\r\n    #9 0x13750d85 in DB::PreparedFunctionImpl::defaultImplementationForConstantArguments(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) /build/obj-x86_64-linux-gnu/../dbms/src/Functions/IFunction.cpp:259\r\n    #10 0x137549c6 in DB::PreparedFunctionImpl::executeWithoutLowCardinalityColumns(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) /build/obj-x86_64-linux-gnu/../dbms/src/Functions/IFunction.cpp:303:9\r\n    #11 0x137549c6 in DB::PreparedFunctionImpl::execute(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) /build/obj-x86_64-linux-gnu/../dbms/src/Functions/IFunction.cpp:463\r\n    #12 0x11ed16cf in DB::ExpressionAction::execute(DB::Block&, bool) const /build/obj-x86_64-linux-gnu/../dbms/src/Interpreters/ExpressionActions.cpp:362:23\r\n    #13 0x11eef97d in DB::ExpressionActions::execute(DB::Block&, bool) const /build/obj-x86_64-linux-gnu/../dbms/src/Interpreters/ExpressionActions.cpp:738:16\r\n    #14 0x1234d0f1 in DB::ExpressionBlockInputStream::readImpl() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/ExpressionBlockInputStream.cpp:35:21\r\n    #15 0x119d29e4 in DB::IBlockInputStream::read() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/IBlockInputStream.cpp:56:15\r\n    #16 0x1234d09d in DB::ExpressionBlockInputStream::readImpl() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/ExpressionBlockInputStream.cpp:33:34\r\n    #17 0x119d29e4 in DB::IBlockInputStream::read() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/IBlockInputStream.cpp:56:15\r\n    #18 0x119ce444 in DB::AsynchronousBlockInputStream::calculate() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/AsynchronousBlockInputStream.cpp:74:34\r\n    #19 0x119cf406 in DB::AsynchronousBlockInputStream::next()::$_0::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/AsynchronousBlockInputStream.cpp:59:9\r\n    #20 0x119cf406 in _ZNSt3__18__invokeIRZN2DB28AsynchronousBlockInputStream4nextEvE3$_0JEEEDTclclsr3std3__1E7forwardIT_Efp_Espclsr3std3__1E7forwardIT0_Efp0_EEEOS5_DpOS6_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4410\r\n    #21 0x119cf406 in void std::__1::__invoke_void_return_wrapper<void>::__call<DB::AsynchronousBlockInputStream::next()::$_0&>(DB::AsynchronousBlockInputStream::next()::$_0&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__functional_base:348\r\n    #22 0x119cf406 in std::__1::__function::__alloc_func<DB::AsynchronousBlockInputStream::next()::$_0, std::__1::allocator<DB::AsynchronousBlockInputStream::next()::$_0>, void ()>::operator()() /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1527\r\n    #23 0x119cf406 in std::__1::__function::__func<DB::AsynchronousBlockInputStream::next()::$_0, std::__1::allocator<DB::AsynchronousBlockInputStream::next()::$_0>, void ()>::operator()() /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1651\r\n    #24 0x748fc6b in std::__1::__function::__value_func<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1799:16\r\n    #25 0x748fc6b in std::__1::function<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2347\r\n    #26 0x748fc6b in ThreadPoolImpl<ThreadFromGlobalPool>::worker(std::__1::__list_iterator<ThreadFromGlobalPool, void*>) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:177\r\n    #27 0x7497746 in ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:73:73\r\n    #28 0x7497746 in _ZNSt3__118__invoke_constexprIRKZN14ThreadPoolImplI20ThreadFromGlobalPoolE12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEDTclclsr3std3__1E7forwardIS5_Efp_Espclsr3std3__1E7forwardIT0_Efp0_EEEOS5_DpOSE_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4416\r\n    #29 0x7497746 in decltype(auto) std::__1::__apply_tuple_impl<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&, std::__1::__tuple_indices<>) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/tuple:1358\r\n    #30 0x7497746 in decltype(auto) std::__1::apply<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/tuple:1367\r\n    #31 0x7497746 in ThreadFromGlobalPool::ThreadFromGlobalPool<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&)::{lambda()#1}::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.h:147\r\n    #32 0x7497746 in _ZNSt3__18__invokeIRZN20ThreadFromGlobalPoolC1IZN14ThreadPoolImplIS1_E12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEOS6_DpOT0_EUlvE_JEEEDTclclsr3std3__1E7forwardIS6_Efp_Espclsr3std3__1E7forwardISE_Efp0_EEESD_SG_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4410\r\n    #33 0x7497746 in void std::__1::__invoke_void_return_wrapper<void>::__call<ThreadFromGlobalPool::ThreadFromGlobalPool<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&)::{lambda()#1}&>(ThreadFromGlobalPool::ThreadFromGlobalPool<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&)::{lambda()#1}&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__functional_base:348\r\n    #34 0x7497746 in _ZNSt3__110__function12__alloc_funcIZN20ThreadFromGlobalPoolC1IZN14ThreadPoolImplIS2_E12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEOS7_DpOT0_EUlvE_NS_9allocatorISI_EES9_EclEv /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1527\r\n    #35 0x7497746 in _ZNSt3__110__function6__funcIZN20ThreadFromGlobalPoolC1IZN14ThreadPoolImplIS2_E12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEOS7_DpOT0_EUlvE_NS_9allocatorISI_EES9_EclEv /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1651\r\n    #36 0x7489a9e in std::__1::__function::__value_func<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1799:16\r\n    #37 0x7489a9e in std::__1::function<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2347\r\n    #38 0x7489a9e in ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:177\r\n    #39 0x7492f17 in ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:73:73\r\n    #40 0x7492f17 in _ZNSt3__18__invokeIZN14ThreadPoolImplINS_6threadEE12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEDTclclsr3std3__1E7forwardIS5_Efp_Espclsr3std3__1E7forwardIT0_Efp0_EEEOS5_DpOSC_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4410\r\n    #41 0x7492f17 in void std::__1::__thread_execute<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>&, std::__1::__tuple_indices<>) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/thread:341\r\n    #42 0x7492f17 in void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}> >(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/thread:351\r\n    #43 0x7f90695456da in start_thread (/lib/x86_64-linux-gnu/libpthread.so.0+0x76da)\r\n\r\nThread T36 (AsyncBlockInput) created by T35 (AsyncBlockInput) here:\r\n    #0 0x734478d in __interceptor_pthread_create (/usr/bin/clickhouse+0x734478d)\r\n    #1 0x74910fe in std::__1::__libcpp_thread_create(unsigned long*, void* (*)(void*), void*) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__threading_support:327:10\r\n    #2 0x74910fe in std::__1::thread::thread<ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}, , void>(ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/thread:367\r\n    #3 0x74861cc in void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:73:35\r\n    #4 0x7487ed3 in ThreadPoolImpl<std::__1::thread>::scheduleOrThrow(std::__1::function<void ()>, int, unsigned long) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:100:5\r\n    #5 0x1205d34d in ThreadFromGlobalPool::ThreadFromGlobalPool<void (DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::*)(std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long), DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>*, std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long&>(void (DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::*&&)(std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long), DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>*&&, std::__1::shared_ptr<DB::ThreadGroupStatus>&&, unsigned long&) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.h:140:38\r\n    #6 0x1205a54b in void std::__1::allocator<ThreadFromGlobalPool>::construct<ThreadFromGlobalPool, void (DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::*)(std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long), DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>*, std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long&>(ThreadFromGlobalPool*, void (DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::*&&)(std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long), DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>*&&, std::__1::shared_ptr<DB::ThreadGroupStatus>&&, unsigned long&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:1825:31\r\n    #7 0x1205a54b in void std::__1::allocator_traits<std::__1::allocator<ThreadFromGlobalPool> >::__construct<ThreadFromGlobalPool, void (DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::*)(std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long), DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>*, std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long&>(std::__1::integral_constant<bool, true>, std::__1::allocator<ThreadFromGlobalPool>&, ThreadFromGlobalPool*, void (DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::*&&)(std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long), DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>*&&, std::__1::shared_ptr<DB::ThreadGroupStatus>&&, unsigned long&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:1717\r\n    #8 0x1205a54b in void std::__1::allocator_traits<std::__1::allocator<ThreadFromGlobalPool> >::construct<ThreadFromGlobalPool, void (DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::*)(std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long), DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>*, std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long&>(std::__1::allocator<ThreadFromGlobalPool>&, ThreadFromGlobalPool*, void (DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::*&&)(std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long), DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>*&&, std::__1::shared_ptr<DB::ThreadGroupStatus>&&, unsigned long&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:1560\r\n    #9 0x1205a54b in ThreadFromGlobalPool& std::__1::vector<ThreadFromGlobalPool, std::__1::allocator<ThreadFromGlobalPool> >::emplace_back<void (DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::*)(std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long), DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>*, std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long&>(void (DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::*&&)(std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long), DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>*&&, std::__1::shared_ptr<DB::ThreadGroupStatus>&&, unsigned long&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:1687\r\n    #10 0x1205a54b in DB::ParallelInputsProcessor<DB::UnionBlockInputStream::Handler>::process() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/ParallelInputsProcessor.h:102\r\n    #11 0x12051f54 in DB::UnionBlockInputStream::readImpl() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/UnionBlockInputStream.h:168:23\r\n    #12 0x119d29e4 in DB::IBlockInputStream::read() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/IBlockInputStream.cpp:56:15\r\n    #13 0x1233d896 in DB::DistinctBlockInputStream::readImpl() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/DistinctBlockInputStream.cpp:32:36\r\n    #14 0x119d29e4 in DB::IBlockInputStream::read() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/IBlockInputStream.cpp:56:15\r\n    #15 0x1234d09d in DB::ExpressionBlockInputStream::readImpl() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/ExpressionBlockInputStream.cpp:33:34\r\n    #16 0x119d29e4 in DB::IBlockInputStream::read() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/IBlockInputStream.cpp:56:15\r\n    #17 0x119ce444 in DB::AsynchronousBlockInputStream::calculate() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/AsynchronousBlockInputStream.cpp:74:34\r\n    #18 0x119cf406 in DB::AsynchronousBlockInputStream::next()::$_0::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/AsynchronousBlockInputStream.cpp:59:9\r\n    #19 0x119cf406 in _ZNSt3__18__invokeIRZN2DB28AsynchronousBlockInputStream4nextEvE3$_0JEEEDTclclsr3std3__1E7forwardIT_Efp_Espclsr3std3__1E7forwardIT0_Efp0_EEEOS5_DpOS6_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4410\r\n    #20 0x119cf406 in void std::__1::__invoke_void_return_wrapper<void>::__call<DB::AsynchronousBlockInputStream::next()::$_0&>(DB::AsynchronousBlockInputStream::next()::$_0&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__functional_base:348\r\n    #21 0x119cf406 in std::__1::__function::__alloc_func<DB::AsynchronousBlockInputStream::next()::$_0, std::__1::allocator<DB::AsynchronousBlockInputStream::next()::$_0>, void ()>::operator()() /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1527\r\n    #22 0x119cf406 in std::__1::__function::__func<DB::AsynchronousBlockInputStream::next()::$_0, std::__1::allocator<DB::AsynchronousBlockInputStream::next()::$_0>, void ()>::operator()() /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1651\r\n    #23 0x748fc6b in std::__1::__function::__value_func<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1799:16\r\n    #24 0x748fc6b in std::__1::function<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2347\r\n    #25 0x748fc6b in ThreadPoolImpl<ThreadFromGlobalPool>::worker(std::__1::__list_iterator<ThreadFromGlobalPool, void*>) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:177\r\n    #26 0x7497746 in ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:73:73\r\n    #27 0x7497746 in _ZNSt3__118__invoke_constexprIRKZN14ThreadPoolImplI20ThreadFromGlobalPoolE12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEDTclclsr3std3__1E7forwardIS5_Efp_Espclsr3std3__1E7forwardIT0_Efp0_EEEOS5_DpOSE_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4416\r\n    #28 0x7497746 in decltype(auto) std::__1::__apply_tuple_impl<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&, std::__1::__tuple_indices<>) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/tuple:1358\r\n    #29 0x7497746 in decltype(auto) std::__1::apply<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3} const&, std::__1::tuple<> const&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/tuple:1367\r\n    #30 0x7497746 in ThreadFromGlobalPool::ThreadFromGlobalPool<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&)::{lambda()#1}::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.h:147\r\n    #31 0x7497746 in _ZNSt3__18__invokeIRZN20ThreadFromGlobalPoolC1IZN14ThreadPoolImplIS1_E12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEOS6_DpOT0_EUlvE_JEEEDTclclsr3std3__1E7forwardIS6_Efp_Espclsr3std3__1E7forwardISE_Efp0_EEESD_SG_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4410\r\n    #32 0x7497746 in void std::__1::__invoke_void_return_wrapper<void>::__call<ThreadFromGlobalPool::ThreadFromGlobalPool<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&)::{lambda()#1}&>(ThreadFromGlobalPool::ThreadFromGlobalPool<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&)::{lambda()#1}&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__functional_base:348\r\n    #33 0x7497746 in _ZNSt3__110__function12__alloc_funcIZN20ThreadFromGlobalPoolC1IZN14ThreadPoolImplIS2_E12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEOS7_DpOT0_EUlvE_NS_9allocatorISI_EES9_EclEv /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1527\r\n    #34 0x7497746 in _ZNSt3__110__function6__funcIZN20ThreadFromGlobalPoolC1IZN14ThreadPoolImplIS2_E12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEOS7_DpOT0_EUlvE_NS_9allocatorISI_EES9_EclEv /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1651\r\n    #35 0x7489a9e in std::__1::__function::__value_func<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1799:16\r\n    #36 0x7489a9e in std::__1::function<void ()>::operator()() const /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:2347\r\n    #37 0x7489a9e in ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:177\r\n    #38 0x7492f17 in ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}::operator()() const /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:73:73\r\n    #39 0x7492f17 in _ZNSt3__18__invokeIZN14ThreadPoolImplINS_6threadEE12scheduleImplIvEET_NS_8functionIFvvEEEiNS_8optionalImEEEUlvE1_JEEEDTclclsr3std3__1E7forwardIS5_Efp_Espclsr3std3__1E7forwardIT0_Efp0_EEEOS5_DpOSC_ /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4410\r\n    #40 0x7492f17 in void std::__1::__thread_execute<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>&, std::__1::__tuple_indices<>) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/thread:341\r\n    #41 0x7492f17 in void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}> >(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/thread:351\r\n    #42 0x7f90695456da in start_thread (/lib/x86_64-linux-gnu/libpthread.so.0+0x76da)\r\n\r\nThread T35 (AsyncBlockInput) created by T26 (TCPHandler) here:\r\n    #0 0x734478d in __interceptor_pthread_create (/usr/bin/clickhouse+0x734478d)\r\n    #1 0x74910fe in std::__1::__libcpp_thread_create(unsigned long*, void* (*)(void*), void*) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__threading_support:327:10\r\n    #2 0x74910fe in std::__1::thread::thread<ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}, , void>(ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/thread:367\r\n    #3 0x74861cc in void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:73:35\r\n    #4 0x7487ed3 in ThreadPoolImpl<std::__1::thread>::scheduleOrThrow(std::__1::function<void ()>, int, unsigned long) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:100:5\r\n    #5 0x7494c25 in ThreadFromGlobalPool::ThreadFromGlobalPool<ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}>(ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::{lambda()#3}&&) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.h:140:38\r\n    #6 0x748b755 in void ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:73:35\r\n    #7 0x748a9eb in ThreadPoolImpl<ThreadFromGlobalPool>::schedule(std::__1::function<void ()>, int) /build/obj-x86_64-linux-gnu/../dbms/src/Common/ThreadPool.cpp:88:5\r\n    #8 0x119cea72 in DB::AsynchronousBlockInputStream::next() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/AsynchronousBlockInputStream.cpp:39:10\r\n    #9 0x75406d5 in DB::AsynchronousBlockInputStream::readPrefix() /build/obj-x86_64-linux-gnu/../dbms/src/DataStreams/AsynchronousBlockInputStream.h:41:13\r\n    #10 0x75406d5 in DB::TCPHandler::processOrdinaryQuery() /build/obj-x86_64-linux-gnu/../dbms/programs/server/TCPHandler.cpp:416\r\n    #11 0x752fd33 in DB::TCPHandler::runImpl() /build/obj-x86_64-linux-gnu/../dbms/programs/server/TCPHandler.cpp:217:17\r\n    #12 0x754e17b in DB::TCPHandler::run() /build/obj-x86_64-linux-gnu/../dbms/programs/server/TCPHandler.cpp:1076:9\r\n    #13 0x14044bae in Poco::Net::TCPServerConnection::start() /build/obj-x86_64-linux-gnu/../contrib/poco/Net/src/TCPServerConnection.cpp:43:3\r\n    #14 0x1404584f in Poco::Net::TCPServerDispatcher::run() /build/obj-x86_64-linux-gnu/../contrib/poco/Net/src/TCPServerDispatcher.cpp:114:20\r\n    #15 0x152abb84 in Poco::PooledThread::run() /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/ThreadPool.cpp:214:14\r\n    #16 0x152a622e in Poco::ThreadImpl::runnableEntry(void*) /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Thread_STD.cpp:139:27\r\n    #17 0x152aa2bd in void std::__1::__thread_execute<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void* (*)(void*), Poco::ThreadImpl*, 2ul>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void* (*)(void*), Poco::ThreadImpl*>&, std::__1::__tuple_indices<2ul>) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:4410:1\r\n    #18 0x152aa2bd in void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void* (*)(void*), Poco::ThreadImpl*> >(void*) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/thread:351\r\n    #19 0x7f90695456da in start_thread (/lib/x86_64-linux-gnu/libpthread.so.0+0x76da)\r\n\r\nThread T26 (TCPHandler) created by T0 here:\r\n    #0 0x734478d in __interceptor_pthread_create (/usr/bin/clickhouse+0x734478d)\r\n    #1 0x152a9329 in std::__1::__libcpp_thread_create(unsigned long*, void* (*)(void*), void*) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__threading_support:327:10\r\n    #2 0x152a9329 in std::__1::thread::thread<void* (&)(void*), Poco::ThreadImpl*, void>(void* (&)(void*), Poco::ThreadImpl*&&) /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/thread:367\r\n    #3 0x152a5758 in Poco::ThreadImpl::startImpl(Poco::SharedPtr<Poco::Runnable, Poco::ReferenceCounter, Poco::ReleasePolicy<Poco::Runnable> >) /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Thread_STD.cpp:58:53\r\n    #4 0x152a82e7 in Poco::Thread::start(Poco::Runnable&) /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Thread.cpp:116:2\r\n    #5 0x152ac13f in Poco::PooledThread::start(int) /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/ThreadPool.cpp:88:10\r\n    #6 0x152ac13f in Poco::ThreadPool::ThreadPool(int, int, int, int, Poco::ThreadPool::ThreadAffinityPolicy) /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/ThreadPool.cpp:278\r\n    #7 0x73a77df in DB::Server::main(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) /build/obj-x86_64-linux-gnu/../dbms/programs/server/Server.cpp:561:26\r\n    #8 0x1426d3a0 in Poco::Util::Application::run() /build/obj-x86_64-linux-gnu/../contrib/poco/Util/src/Application.cpp:335:8\r\n    #9 0x7391309 in DB::Server::run() /build/obj-x86_64-linux-gnu/../dbms/programs/server/Server.cpp:142:25\r\n    #10 0x73d4fdb in mainEntryClickHouseServer(int, char**) /build/obj-x86_64-linux-gnu/../dbms/programs/server/Server.cpp:891:20\r\n    #11 0x738eca1 in main /build/obj-x86_64-linux-gnu/../dbms/programs/main.cpp:182:12\r\n    #12 0x7f9068dd0b96 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)\r\n\r\nSUMMARY: AddressSanitizer: heap-buffer-overflow (/usr/bin/clickhouse+0x79cfa14) in DB::ColumnVector<unsigned char>::get(unsigned long, DB::Field&) const\r\nShadow bytes around the buggy address:\r\n  0x0c0c8000bea0: fd fd fd fd fd fd fd fd fa fa fa fa fd fd fd fd\r\n  0x0c0c8000beb0: fd fd fd fd fa fa fa fa fd fd fd fd fd fd fd fd\r\n  0x0c0c8000bec0: fa fa fa fa fd fd fd fd fd fd fd fd fa fa fa fa\r\n  0x0c0c8000bed0: 00 00 00 00 00 00 00 00 fa fa fa fa 00 00 00 00\r\n  0x0c0c8000bee0: 00 00 00 00 fa fa fa fa 00 00 00 00 00 00 00 00\r\n=>0x0c0c8000bef0:[fa]fa fa fa 00 00 00 00 00 00 00 00 fa fa fa fa\r\n  0x0c0c8000bf00: 00 00 00 00 00 00 00 00 fa fa fa fa 00 00 00 00\r\n  0x0c0c8000bf10: 00 00 00 00 fa fa fa fa 00 00 00 00 00 00 00 00\r\n  0x0c0c8000bf20: fa fa fa fa 00 00 00 00 00 00 00 00 fa fa fa fa\r\n  0x0c0c8000bf30: 00 00 00 00 00 00 00 00 fa fa fa fa 00 00 00 00\r\n  0x0c0c8000bf40: 00 00 00 00 fa fa fa fa 00 00 00 00 00 00 00 00\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n  Shadow gap:              cc\r\n==1==ABORTING\r\n```\n",
  "hints_text": "How I think the problem is that aggregate functions don't support constant columns. So in this function https://github.com/yandex/ClickHouse/blob/7015e5ca7df1647a6189a0da4f33bb9f8edc99fa/dbms/src/Functions/array/arrayReduce.cpp#L116 we try to materialize them if they were constant. But they are not constant, because constancy dissapeared after this line https://github.com/yandex/ClickHouse/blob/7015e5ca7df1647a6189a0da4f33bb9f8edc99fa/dbms/src/Functions/IFunction.cpp#L242 So non materialized column used as a full column, that's why the buffer overflows. Actually, this fact causes reading an item outside the buffer from vector. (call operator[] with extremly big number.) \r\nThe solution is not to use default implementation for constants. ",
  "created_at": "2019-08-04T18:23:34Z"
}