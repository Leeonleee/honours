{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 37600,
  "instance_id": "ClickHouse__ClickHouse-37600",
  "issue_numbers": [
    "37514"
  ],
  "base_commit": "6d6779f17a83eb139a6419930dead8e12b36cc50",
  "patch": "diff --git a/src/Processors/Transforms/FillingTransform.cpp b/src/Processors/Transforms/FillingTransform.cpp\nindex 9e5d57a2b43f..a41b5660e0da 100644\n--- a/src/Processors/Transforms/FillingTransform.cpp\n+++ b/src/Processors/Transforms/FillingTransform.cpp\n@@ -90,9 +90,9 @@ static bool tryConvertFields(FillColumnDescription & descr, const DataTypePtr &\n         if (which.isDate() || which.isDate32())\n         {\n             Int64 avg_seconds = get<Int64>(descr.fill_step) * descr.step_kind->toAvgSeconds();\n-            if (avg_seconds < 86400)\n+            if (std::abs(avg_seconds) < 86400)\n                 throw Exception(ErrorCodes::INVALID_WITH_FILL_EXPRESSION,\n-                                \"Value of step is to low ({} seconds). Must be >= 1 day\", avg_seconds);\n+                                \"Value of step is to low ({} seconds). Must be >= 1 day\", std::abs(avg_seconds));\n         }\n \n         if (which.isDate())\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02112_with_fill_interval.reference b/tests/queries/0_stateless/02112_with_fill_interval.reference\nindex fc6f9378bfa3..4bb99803eb19 100644\n--- a/tests/queries/0_stateless/02112_with_fill_interval.reference\n+++ b/tests/queries/0_stateless/02112_with_fill_interval.reference\n@@ -107,3 +107,6 @@\n 2020-05-01\t2\t0\n 2020-05-01\t3\t0\n 2020-05-01\t4\t0\n+1970-01-04\n+1970-01-03\n+1970-01-02\ndiff --git a/tests/queries/0_stateless/02112_with_fill_interval.sql b/tests/queries/0_stateless/02112_with_fill_interval.sql\nindex f26ec7da8c9d..d2416f9a84b3 100644\n--- a/tests/queries/0_stateless/02112_with_fill_interval.sql\n+++ b/tests/queries/0_stateless/02112_with_fill_interval.sql\n@@ -79,3 +79,6 @@ d WITH FILL\n id WITH FILL FROM 1 TO 5;\n \n DROP TABLE with_fill_date;\n+\n+SELECT d FROM (SELECT toDate(1) AS d)\n+ORDER BY d DESC WITH FILL FROM toDate(3) TO toDate(0) STEP INTERVAL -1 DAY;\n",
  "problem_statement": "The WITH FILL modifier can not be applied to Date in descending order\n**Describe the unexpected behaviour**\r\n\r\nThe `WITH FILL` modifier on an `ORDER BY` clause does not accept a negative\r\n`INTERVAL` as a `STEP`, when the `ORDER BY` is applied to a `Date` column\r\nand the order is `DESC`. This is unexpected because negative steps work\r\nfine on numeric columns sorted in descending order.\r\n\r\n**How to reproduce**\r\n\r\n* Which ClickHouse server version to use\r\n\r\n22.4.4.3\r\n\r\n* Queries to run that lead to unexpected result\r\n\r\n```sql\r\nSELECT d\r\nFROM\r\n(\r\n  SELECT toDate(1) AS d\r\n)\r\nORDER BY d DESC WITH FILL FROM toDate(3) TO toDate(0) STEP INTERVAL -1 DAY\r\n;\r\n```\r\n\r\n```\r\nReceived exception from server (version 22.4.4):\r\nCode: 475. DB::Exception: Received from localhost:9000. DB::Exception: Value of step is to low (-86400 seconds). Must be >= 1 day. (INVALID_WITH_FILL_EXPRESSION)\r\n```\r\n\r\n**Expected behavior**\r\n\r\nLike numeric columns, `Date` should also support negative steps.\r\n\r\n```sql\r\nSELECT n\r\nFROM\r\n(\r\n    SELECT 1 AS n\r\n)\r\nORDER BY n DESC WITH FILL FROM 3 TO 0 STEP -1\r\n\r\n\u250c\u2500n\u2500\u2510\r\n\u2502 3 \u2502\r\n\u2502 2 \u2502\r\n\u2502 1 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n```\r\n\n",
  "hints_text": "",
  "created_at": "2022-05-27T12:44:53Z",
  "modified_files": [
    "src/Processors/Transforms/FillingTransform.cpp"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/02112_with_fill_interval.reference",
    "tests/queries/0_stateless/02112_with_fill_interval.sql"
  ]
}