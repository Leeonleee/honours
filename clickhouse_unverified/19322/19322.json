{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 19322,
  "instance_id": "ClickHouse__ClickHouse-19322",
  "issue_numbers": [
    "18063"
  ],
  "base_commit": "f44f169aaa1b9fe0580ca4862056bf0d31330e8f",
  "patch": "diff --git a/src/AggregateFunctions/AggregateFunctionSum.h b/src/AggregateFunctions/AggregateFunctionSum.h\nindex 812390641693..15fc93dec75a 100644\n--- a/src/AggregateFunctions/AggregateFunctionSum.h\n+++ b/src/AggregateFunctions/AggregateFunctionSum.h\n@@ -287,7 +287,7 @@ class AggregateFunctionSum final : public IAggregateFunctionDataHelper<Data, Agg\n \n     void add(AggregateDataPtr place, const IColumn ** columns, size_t row_num, Arena *) const override\n     {\n-        const auto & column = static_cast<const ColVecType &>(*columns[0]);\n+        const auto & column = assert_cast<const ColVecType &>(*columns[0]);\n         if constexpr (is_big_int_v<T>)\n             this->data(place).add(static_cast<TResult>(column.getData()[row_num]));\n         else\n@@ -309,7 +309,7 @@ class AggregateFunctionSum final : public IAggregateFunctionDataHelper<Data, Agg\n         }\n         else\n         {\n-            const auto & column = static_cast<const ColVecType &>(*columns[0]);\n+            const auto & column = assert_cast<const ColVecType &>(*columns[0]);\n             this->data(place).addMany(column.getData().data(), batch_size);\n         }\n     }\n@@ -327,7 +327,7 @@ class AggregateFunctionSum final : public IAggregateFunctionDataHelper<Data, Agg\n         }\n         else\n         {\n-            const auto & column = static_cast<const ColVecType &>(*columns[0]);\n+            const auto & column = assert_cast<const ColVecType &>(*columns[0]);\n             this->data(place).addManyNotNull(column.getData().data(), null_map, batch_size);\n         }\n     }\n@@ -349,7 +349,7 @@ class AggregateFunctionSum final : public IAggregateFunctionDataHelper<Data, Agg\n \n     void insertResultInto(AggregateDataPtr place, IColumn & to, Arena *) const override\n     {\n-        auto & column = static_cast<ColVecResult &>(to);\n+        auto & column = assert_cast<ColVecResult &>(to);\n         column.getData().push_back(this->data(place).get());\n     }\n \ndiff --git a/src/Storages/StorageMaterializedView.cpp b/src/Storages/StorageMaterializedView.cpp\nindex 61fdbc0198b9..af00b37b1d5a 100644\n--- a/src/Storages/StorageMaterializedView.cpp\n+++ b/src/Storages/StorageMaterializedView.cpp\n@@ -11,6 +11,7 @@\n #include <Interpreters/InterpreterRenameQuery.h>\n #include <Interpreters/getTableExpressions.h>\n #include <Interpreters/AddDefaultDatabaseVisitor.h>\n+#include <Interpreters/getHeaderForProcessingStage.h>\n #include <Access/AccessFlags.h>\n #include <DataStreams/IBlockInputStream.h>\n #include <DataStreams/IBlockOutputStream.h>\n@@ -24,6 +25,7 @@\n #include <Common/checkStackSize.h>\n #include <Processors/Sources/SourceFromInputStream.h>\n #include <Processors/QueryPlan/SettingQuotaAndLimitsStep.h>\n+#include <Processors/QueryPlan/ExpressionStep.h>\n \n \n namespace DB\n@@ -130,7 +132,7 @@ Pipe StorageMaterializedView::read(\n void StorageMaterializedView::read(\n     QueryPlan & query_plan,\n     const Names & column_names,\n-    const StorageMetadataPtr & /*metadata_snapshot*/,\n+    const StorageMetadataPtr & metadata_snapshot,\n     SelectQueryInfo & query_info,\n     const Context & context,\n     QueryProcessingStage::Enum processed_stage,\n@@ -139,15 +141,27 @@ void StorageMaterializedView::read(\n {\n     auto storage = getTargetTable();\n     auto lock = storage->lockForShare(context.getCurrentQueryId(), context.getSettingsRef().lock_acquire_timeout);\n-    auto metadata_snapshot = storage->getInMemoryMetadataPtr();\n+    auto target_metadata_snapshot = storage->getInMemoryMetadataPtr();\n \n     if (query_info.order_optimizer)\n-        query_info.input_order_info = query_info.order_optimizer->getInputOrder(metadata_snapshot, context);\n+        query_info.input_order_info = query_info.order_optimizer->getInputOrder(target_metadata_snapshot, context);\n \n-    storage->read(query_plan, column_names, metadata_snapshot, query_info, context, processed_stage, max_block_size, num_streams);\n+    storage->read(query_plan, column_names, target_metadata_snapshot, query_info, context, processed_stage, max_block_size, num_streams);\n \n     if (query_plan.isInitialized())\n     {\n+        auto mv_header = getHeaderForProcessingStage(*this, column_names, metadata_snapshot, query_info, context, processed_stage);\n+        auto target_header = query_plan.getCurrentDataStream().header;\n+        if (!blocksHaveEqualStructure(mv_header, target_header))\n+        {\n+            auto converting_actions = ActionsDAG::makeConvertingActions(target_header.getColumnsWithTypeAndName(),\n+                                                                        mv_header.getColumnsWithTypeAndName(),\n+                                                                        ActionsDAG::MatchColumnsMode::Name);\n+            auto converting_step = std::make_unique<ExpressionStep>(query_plan.getCurrentDataStream(), converting_actions);\n+            converting_step->setStepDescription(\"Convert target table structure to MaterializedView structure\");\n+            query_plan.addStep(std::move(converting_step));\n+        }\n+\n         StreamLocalLimits limits;\n         SizeLimits leaf_limits;\n \n@@ -161,7 +175,7 @@ void StorageMaterializedView::read(\n                 nullptr,\n                 nullptr);\n \n-        adding_limits_and_quota->setStepDescription(\"Lock destination table for Buffer\");\n+        adding_limits_and_quota->setStepDescription(\"Lock destination table for MaterializedView\");\n         query_plan.addStep(std::move(adding_limits_and_quota));\n     }\n }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01182_materialized_view_different_structure.reference b/tests/queries/0_stateless/01182_materialized_view_different_structure.reference\nnew file mode 100644\nindex 000000000000..a1f113394b28\n--- /dev/null\n+++ b/tests/queries/0_stateless/01182_materialized_view_different_structure.reference\n@@ -0,0 +1,6 @@\n+4999950000.000000\n+4999950000\n+1000\t499500\t499500\t999\t0\n+1000\t124716\t499500\t255\t0\n+1000\t124716\t99\t0\n+2000\t249432\t255\t0\ndiff --git a/tests/queries/0_stateless/01182_materialized_view_different_structure.sql b/tests/queries/0_stateless/01182_materialized_view_different_structure.sql\nnew file mode 100644\nindex 000000000000..751bcc9e48e6\n--- /dev/null\n+++ b/tests/queries/0_stateless/01182_materialized_view_different_structure.sql\n@@ -0,0 +1,42 @@\n+DROP TABLE IF EXISTS test_table;\n+DROP TABLE IF EXISTS numbers;\n+DROP TABLE IF EXISTS test_mv;\n+DROP TABLE IF EXISTS src;\n+DROP TABLE IF EXISTS dst;\n+DROP TABLE IF EXISTS mv;\n+DROP TABLE IF EXISTS dist;\n+\n+CREATE TABLE test_table (key UInt32, value Decimal(16, 6)) ENGINE = SummingMergeTree() ORDER BY key;\n+CREATE TABLE numbers (number UInt64) ENGINE=Memory;\n+\n+CREATE MATERIALIZED VIEW test_mv TO test_table (number UInt64, value Decimal(38, 6))\n+AS SELECT number, sum(number) AS value FROM (SELECT *, toDecimal64(number, 6) AS val FROM numbers) GROUP BY number;\n+\n+INSERT INTO numbers SELECT * FROM numbers(100000);\n+\n+SELECT sum(value) FROM test_mv;\n+SELECT sum(value) FROM (SELECT number, sum(number) AS value FROM (SELECT *, toDecimal64(number, 6) AS val FROM numbers) GROUP BY number);\n+\n+CREATE TABLE src (n UInt64, s FixedString(16)) ENGINE=Memory;\n+CREATE TABLE dst (n UInt8, s String) ENGINE = Memory;\n+CREATE MATERIALIZED VIEW mv TO dst (n String) AS SELECT * FROM src;\n+SET allow_experimental_bigint_types=1;\n+CREATE TABLE dist (n Int128) ENGINE=Distributed(test_cluster_two_shards, currentDatabase(), mv);\n+\n+INSERT INTO src SELECT number, toString(number) FROM numbers(1000);\n+INSERT INTO mv SELECT toString(number + 1000) FROM numbers(1000); -- { serverError 53 }\n+INSERT INTO mv SELECT arrayJoin(['42', 'test']); -- { serverError 53 }\n+\n+SELECT count(), sum(n), sum(toInt64(s)), max(n), min(n) FROM src;\n+SELECT count(), sum(n), sum(toInt64(s)), max(n), min(n) FROM dst;\n+SELECT count(), sum(toInt64(n)), max(n), min(n) FROM mv;\n+SELECT count(), sum(toInt64(n)), max(n), min(n) FROM dist; -- { serverError 70 }\n+SELECT count(), sum(toInt64(n)), max(toUInt32(n)), min(toInt128(n)) FROM dist;\n+\n+DROP TABLE test_table;\n+DROP TABLE numbers;\n+DROP TABLE test_mv;\n+DROP TABLE src;\n+DROP TABLE dst;\n+DROP TABLE mv;\n+DROP TABLE dist;\ndiff --git a/tests/queries/0_stateless/arcadia_skip_list.txt b/tests/queries/0_stateless/arcadia_skip_list.txt\nindex 4ac71596280c..2aeaa7b3ac21 100644\n--- a/tests/queries/0_stateless/arcadia_skip_list.txt\n+++ b/tests/queries/0_stateless/arcadia_skip_list.txt\n@@ -189,4 +189,5 @@\n 01650_fetch_patition_with_macro_in_zk_path\n 01651_bugs_from_15889\n 01655_agg_if_nullable\n+01182_materialized_view_different_structure\n 01660_sum_ubsan\n",
  "problem_statement": "SEGFAULT and wrong result while querying MV with mismatched Decimal Types.\n**How to reproduce**\r\nClickhouse version 20.12.3.3, 20.13.1.5365\r\n\r\n```\r\nCREATE TABLE default.test_table\r\n(\r\n    `key` UInt32,\r\n    `value` Decimal(16, 6)\r\n)\r\nENGINE = SummingMergeTree()\r\nPARTITION BY tuple()\r\nORDER BY key\r\nSETTINGS index_granularity = 8192\r\n\r\n\r\nINSERT INTO test_table  SELECT *, toDecimal64(number,6) as val FROM numbers(32000000);\r\n\r\n\r\nCREATE MATERIALIZED VIEW default.test_mv TO default.test_table\r\n(\r\n    `number` UInt64,\r\n    `value` Decimal(38, 6)\r\n) AS\r\nSELECT\r\n    number,\r\n    sum(number) AS value\r\nFROM\r\n(\r\n    SELECT\r\n        *,\r\n        toDecimal64(number, 6) AS val\r\n    FROM system.numbers\r\n)\r\nGROUP BY number\r\n\r\nSELECT sum(value)\u3000FROM test_mv;\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500sum(value)\u2500\u2510\r\n\u2502 20169775271081582806606521273206.229723 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\nSELECT sum(value)\u3000FROM test_mv;\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500sum(value)\u2500\u2510\r\n\u2502 -99821308067231861049021501577149.641700 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n\r\necho \"SELECT sum(value)\u3000FROM test_mv;\" | clickhouse-benchmark -c 10;\r\n\r\n2020.12.14 15:09:00.632224 [ 167 ] {} <Fatal> BaseDaemon: ########################################\r\n2020.12.14 15:09:00.666960 [ 167 ] {} <Fatal> BaseDaemon: (version 20.12.3.3 (official build), build id: 046AC38B14F316A5) (from thread 155) (query_id: d6cf2cb2-fa08-457d-8730-71c4fbc08060) Received signal Segmentation fault (11)\r\n2020.12.14 15:09:00.667040 [ 167 ] {} <Fatal> BaseDaemon: Address: 0x7f2855817000 Access: read. Attempted access has violated the permissions assigned to the memory area.\r\n2020.12.14 15:09:00.667092 [ 167 ] {} <Fatal> BaseDaemon: Stack trace: 0x8c30221 0xdc8edca 0xdc907f2 0xe799c56 0xe79710b 0xe64239c 0xe63f4c7 0xe644475 0x7d1baad 0x7d1f5d3 0x7f2859033609 0x7f2858f49293\r\n2020.12.14 15:09:00.667200 [ 167 ] {} <Fatal> BaseDaemon: 2. void DB::AggregateFunctionSumData<DB::Decimal<__int128> >::addMany<DB::Decimal<__int128> >(DB::Decimal<__int128> const*, unsigned long) @ 0x8c30221 in /usr/bin/clickhouse\r\n2020.12.14 15:09:00.667270 [ 167 ] {} <Fatal> BaseDaemon: 3. DB::Aggregator::executeWithoutKeyImpl(char*&, unsigned long, DB::Aggregator::AggregateFunctionInstruction*, DB::Arena*) @ 0xdc8edca in /usr/bin/clickhouse\r\n2020.12.14 15:09:00.667329 [ 167 ] {} <Fatal> BaseDaemon: 4. DB::Aggregator::executeOnBlock(std::__1::vector<COW<DB::IColumn>::immutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::immutable_ptr<DB::IColumn> > >, unsigned long, DB::AggregatedDataVariants&, std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*> >&, std::__1::vector<std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*> >, std::__1::allocator<std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*> > > >&, bool&) @ 0xdc907f2 in /usr/bin/clickhouse\r\n2020.12.14 15:09:00.667396 [ 167 ] {} <Fatal> BaseDaemon: 5. DB::AggregatingTransform::consume(DB::Chunk) @ 0xe799c56 in /usr/bin/clickhouse\r\n2020.12.14 15:09:00.667493 [ 167 ] {} <Fatal> BaseDaemon: 6. DB::AggregatingTransform::work() @ 0xe79710b in /usr/bin/clickhouse\r\n2020.12.14 15:09:00.667549 [ 167 ] {} <Fatal> BaseDaemon: 7. ? @ 0xe64239c in /usr/bin/clickhouse\r\n2020.12.14 15:09:00.667613 [ 167 ] {} <Fatal> BaseDaemon: 8. DB::PipelineExecutor::executeStepImpl(unsigned long, unsigned long, std::__1::atomic<bool>*) @ 0xe63f4c7 in /usr/bin/clickhouse\r\n2020.12.14 15:09:00.667660 [ 167 ] {} <Fatal> BaseDaemon: 9. ? @ 0xe644475 in /usr/bin/clickhouse\r\n2020.12.14 15:09:00.667727 [ 167 ] {} <Fatal> BaseDaemon: 10. ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) @ 0x7d1baad in /usr/bin/clickhouse\r\n2020.12.14 15:09:00.667784 [ 167 ] {} <Fatal> BaseDaemon: 11. ? @ 0x7d1f5d3 in /usr/bin/clickhouse\r\n2020.12.14 15:09:00.667846 [ 167 ] {} <Fatal> BaseDaemon: 12. start_thread @ 0x9609 in /usr/lib/x86_64-linux-gnu/libpthread-2.31.so\r\n2020.12.14 15:09:00.667909 [ 167 ] {} <Fatal> BaseDaemon: 13. __clone @ 0x122293 in /usr/lib/x86_64-linux-gnu/libc-2.31.so\r\n\r\n\n",
  "hints_text": "```\r\n==1826225==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x7fa38bc95800 at pc 0x00000ae19e86 bp 0x7fa2a86f5e20 sp 0x7fa2a86f5e18\r\n    #0 0xae19e85 in DB::Decimal<__int128>::operator __int128() const /home/milovidov/work/ClickHouse/build/../src/Core/Types.h:146:34\r\n    #1 0xae19e85 in void DB::AggregateFunctionSumData<DB::Decimal<__int128> >::addMany<DB::Decimal<__int128> >(DB::Decimal<__int128> const*, unsigned long) /home/milovidov/work/ClickHouse/build/../src/AggregateFunctions/AggregateFunctionSum.h:45:36\r\n    #2 0x1e622eac in DB::Aggregator::executeWithoutKeyImpl(char*&, unsigned long, DB::Aggregator::AggregateFunctionInstruction*, DB::Arena*) /home/milovidov/work/ClickHouse/build/../src/Interpreters/Aggregator.cpp\r\n    #3 0x1e627046 in DB::Aggregator::executeOnBlock(std::__1::vector<COW<DB::IColumn>::immutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::immutable_ptr<DB::IColumn> > >, unsigned long, DB::AggregatedDataVariants&, std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*> >&, std::__1::vector<std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*> >, std::__1::allocator<std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*> > > >&, bool&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/Aggregator.cpp:765:9\r\n    #4 0x205ce52d in DB::AggregatingTransform::consume(DB::Chunk) /home/milovidov/work/ClickHouse/build/../src/Processors/Transforms/AggregatingTransform.cpp:525:29\r\n    #5 0x205c9dca in DB::AggregatingTransform::work() /home/milovidov/work/ClickHouse/build/../src/Processors/Transforms/AggregatingTransform.cpp:495:9\r\n    #6 0x202193d2 in DB::executeJob(DB::IProcessor*) /home/milovidov/work/ClickHouse/build/../src/Processors/Executors/PipelineExecutor.cpp:79:20\r\n    #7 0x202193d2 in DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0::operator()() const /home/milovidov/work/ClickHouse/build/../src/Processors/Executors/PipelineExecutor.cpp:96:13\r\n    #8 0x202193d2 in decltype(std::__1::forward<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&>(fp)()) std::__1::__invoke<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&>(DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/type_traits:3676:1\r\n    #9 0x202193d2 in void std::__1::__invoke_void_return_wrapper<void>::__call<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&>(DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/__functional_base:348:9\r\n    #10 0x202193d2 in std::__1::__function::__default_alloc_func<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0, void ()>::operator()() /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:1608:12\r\n    #11 0x202193d2 in void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0, void ()> >(std::__1::__function::__policy_storage const*) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2089:16\r\n    #12 0x2021463a in std::__1::__function::__policy_func<void ()>::operator()() const /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2221:16\r\n    #13 0x2021463a in std::__1::function<void ()>::operator()() const /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2560:12\r\n    #14 0x2021463a in DB::PipelineExecutor::executeStepImpl(unsigned long, unsigned long, std::__1::atomic<bool>*) /home/milovidov/work/ClickHouse/build/../src/Processors/Executors/PipelineExecutor.cpp:580:17\r\n    #15 0x2021a2a8 in DB::PipelineExecutor::executeSingleThread(unsigned long, unsigned long) /home/milovidov/work/ClickHouse/build/../src/Processors/Executors/PipelineExecutor.cpp:473:5\r\n    #16 0x2021a2a8 in DB::PipelineExecutor::executeImpl(unsigned long)::$_4::operator()() const /home/milovidov/work/ClickHouse/build/../src/Processors/Executors/PipelineExecutor.cpp:771:21\r\n    #17 0x2021a2a8 in decltype(std::__1::forward<DB::PipelineExecutor::executeImpl(unsigned long)::$_4&>(fp)()) std::__1::__invoke_constexpr<DB::PipelineExecutor::executeImpl(unsigned long)::$_4&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/type_traits:3682:1\r\n    #18 0x2021a2a8 in decltype(auto) std::__1::__apply_tuple_impl<DB::PipelineExecutor::executeImpl(unsigned long)::$_4&, std::__1::tuple<>&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&, std::__1::tuple<>&, std::__1::__tuple_indices<>) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/tuple:1415:1\r\n    #19 0x2021a2a8 in decltype(auto) std::__1::apply<DB::PipelineExecutor::executeImpl(unsigned long)::$_4&, std::__1::tuple<>&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&, std::__1::tuple<>&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/tuple:1424:1\r\n    #20 0x2021a2a8 in ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&)::'lambda'()::operator()() /home/milovidov/work/ClickHouse/build/../src/Common/ThreadPool.h:178:13\r\n    #21 0x2021a2a8 in decltype(std::__1::forward<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(fp)()) std::__1::__invoke<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&)::'lambda'()&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/type_traits:3676:1\r\n    #22 0x2021a2a8 in void std::__1::__invoke_void_return_wrapper<void>::__call<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&)::'lambda'()&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&...) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/__functional_base:348:9\r\n    #23 0x2021a2a8 in std::__1::__function::__default_alloc_func<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&)::'lambda'(), void ()>::operator()() /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:1608:12\r\n    #24 0x2021a2a8 in void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&)::'lambda'(), void ()> >(std::__1::__function::__policy_storage const*) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2089:16\r\n    #25 0xa88dbab in std::__1::__function::__policy_func<void ()>::operator()() const /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2221:16\r\n    #26 0xa88dbab in std::__1::function<void ()>::operator()() const /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2560:12\r\n    #27 0xa88dbab in ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) /home/milovidov/work/ClickHouse/build/../src/Common/ThreadPool.cpp:247:17\r\n    #28 0xa896743 in void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()::operator()() const /home/milovidov/work/ClickHouse/build/../src/Common/ThreadPool.cpp:124:73\r\n    #29 0xa896743 in decltype(std::__1::forward<void>(fp)(std::__1::forward<void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()>(fp0)...)) std::__1::__invoke<void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()>(void&&, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()&&...) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/type_traits:3676:1\r\n    #30 0xa896743 in void std::__1::__thread_execute<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()>(std::__1::tuple<void, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()>&, std::__1::__tuple_indices<>) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/thread:280:5\r\n    #31 0xa896743 in void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()> >(void*) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/thread:291:5\r\n    #32 0x7fa3922cb608 in start_thread /build/glibc-ZN95T4/glibc-2.31/nptl/pthread_create.c:477:8\r\n    #33 0x7fa3921f2292 in clone /build/glibc-ZN95T4/glibc-2.31/misc/../sysdeps/unix/sysv/linux/x86_64/clone.S:95\r\n\r\n0x7fa38bc95800 is located 0 bytes to the right of 524288-byte region [0x7fa38bc15800,0x7fa38bc95800)\r\nallocated by thread T33 (QueryPipelineEx) here:\r\n    #0 0xa772b79 in realloc /home/milovidov/work/ClickHouse/utils/ci/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:164:3\r\n    #1 0xa8f971f in Allocator<false, false>::realloc(void*, unsigned long, unsigned long, unsigned long) /home/milovidov/work/ClickHouse/build/../src/Common/Allocator.h:126:30\r\n    #2 0xabda030 in void DB::PODArrayBase<8ul, 4096ul, Allocator<false, false>, 15ul, 16ul>::realloc<>(unsigned long) /home/milovidov/work/ClickHouse/build/../src/Common/PODArray.h:151:29\r\n    #3 0xabda030 in void DB::PODArrayBase<8ul, 4096ul, Allocator<false, false>, 15ul, 16ul>::reserve<>(unsigned long) /home/milovidov/work/ClickHouse/build/../src/Common/PODArray.h:223:13\r\n    #4 0xabda030 in void DB::PODArrayBase<8ul, 4096ul, Allocator<false, false>, 15ul, 16ul>::resize<>(unsigned long) /home/milovidov/work/ClickHouse/build/../src/Common/PODArray.h:236:9\r\n    #5 0x1d836716 in DB::DataTypeDecimalBase<DB::Decimal<long> >::deserializeBinaryBulk(DB::IColumn&, DB::ReadBuffer&, unsigned long, double) const /home/milovidov/work/ClickHouse/build/../src/DataTypes/DataTypeDecimalBase.cpp:88:7\r\n    #6 0x1da4e9ed in DB::IDataType::deserializeBinaryBulkWithMultipleStreams(COW<DB::IColumn>::immutable_ptr<DB::IColumn>&, unsigned long, DB::IDataType::DeserializeBinaryBulkSettings&, std::__1::shared_ptr<DB::IDataType::DeserializeBinaryBulkState>&, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, COW<DB::IColumn>::immutable_ptr<DB::IColumn>, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, COW<DB::IColumn>::immutable_ptr<DB::IColumn> > > >*) const /home/milovidov/work/ClickHouse/build/../src/DataTypes/IDataType.cpp:327:5\r\n    #7 0x1fcf378a in DB::MergeTreeReaderWide::readData(DB::NameAndTypePair const&, COW<DB::IColumn>::immutable_ptr<DB::IColumn>&, unsigned long, bool, unsigned long, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, COW<DB::IColumn>::immutable_ptr<DB::IColumn>, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, COW<DB::IColumn>::immutable_ptr<DB::IColumn> > > >&) /home/milovidov/work/ClickHouse/build/../src/Storages/MergeTree/MergeTreeReaderWide.cpp:214:25\r\n    #8 0x1fcf1302 in DB::MergeTreeReaderWide::readRows(unsigned long, bool, unsigned long, std::__1::vector<COW<DB::IColumn>::immutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::immutable_ptr<DB::IColumn> > >&) /home/milovidov/work/ClickHouse/build/../src/Storages/MergeTree/MergeTreeReaderWide.cpp:94:17\r\n    #9 0x1fd0aefe in DB::MergeTreeRangeReader::DelayedStream::readRows(std::__1::vector<COW<DB::IColumn>::immutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::immutable_ptr<DB::IColumn> > >&, unsigned long) /home/milovidov/work/ClickHouse/build/../src/Storages/MergeTree/MergeTreeRangeReader.cpp:56:47\r\n    #10 0x1fd0aefe in DB::MergeTreeRangeReader::DelayedStream::finalize(std::__1::vector<COW<DB::IColumn>::immutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::immutable_ptr<DB::IColumn> > >&) /home/milovidov/work/ClickHouse/build/../src/Storages/MergeTree/MergeTreeRangeReader.cpp:129:12\r\n    #11 0x1fd1755c in DB::MergeTreeRangeReader::Stream::finalize(std::__1::vector<COW<DB::IColumn>::immutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::immutable_ptr<DB::IColumn> > >&) /home/milovidov/work/ClickHouse/build/../src/Storages/MergeTree/MergeTreeRangeReader.cpp:240:31\r\n    #12 0x1fd1755c in DB::MergeTreeRangeReader::startReadingChain(unsigned long, std::__1::deque<DB::MarkRange, std::__1::allocator<DB::MarkRange> >&) /home/milovidov/work/ClickHouse/build/../src/Storages/MergeTree/MergeTreeRangeReader.cpp:746:27\r\n    #13 0x1fd1428e in DB::MergeTreeRangeReader::read(unsigned long, std::__1::deque<DB::MarkRange, std::__1::allocator<DB::MarkRange> >&) /home/milovidov/work/ClickHouse/build/../src/Storages/MergeTree/MergeTreeRangeReader.cpp:675:23\r\n    #14 0x1fd03628 in DB::MergeTreeBaseSelectProcessor::readFromPartImpl() /home/milovidov/work/ClickHouse/build/../src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp:147:43\r\n    #15 0x1fd04f66 in DB::MergeTreeBaseSelectProcessor::readFromPart() /home/milovidov/work/ClickHouse/build/../src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp:195:12\r\n    #16 0x1fd0057b in DB::MergeTreeBaseSelectProcessor::generate() /home/milovidov/work/ClickHouse/build/../src/Storages/MergeTree/MergeTreeBaseSelectProcessor.cpp:58:20\r\n    #17 0x20174a2c in DB::ISource::tryGenerate() /home/milovidov/work/ClickHouse/build/../src/Processors/ISource.cpp:79:18\r\n    #18 0x20173d76 in DB::ISource::work() /home/milovidov/work/ClickHouse/build/../src/Processors/ISource.cpp:53:26\r\n    #19 0x2054cfb6 in DB::SourceWithProgress::work() /home/milovidov/work/ClickHouse/build/../src/Processors/Sources/SourceWithProgress.cpp:36:30\r\n    #20 0x202193d2 in DB::executeJob(DB::IProcessor*) /home/milovidov/work/ClickHouse/build/../src/Processors/Executors/PipelineExecutor.cpp:79:20\r\n    #21 0x202193d2 in DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0::operator()() const /home/milovidov/work/ClickHouse/build/../src/Processors/Executors/PipelineExecutor.cpp:96:13\r\n    #22 0x202193d2 in decltype(std::__1::forward<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&>(fp)()) std::__1::__invoke<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&>(DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/type_traits:3676:1\r\n    #23 0x202193d2 in void std::__1::__invoke_void_return_wrapper<void>::__call<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&>(DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/__functional_base:348:9\r\n    #24 0x202193d2 in std::__1::__function::__default_alloc_func<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0, void ()>::operator()() /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:1608:12\r\n    #25 0x202193d2 in void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<DB::PipelineExecutor::addJob(DB::ExecutingGraph::Node*)::$_0, void ()> >(std::__1::__function::__policy_storage const*) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2089:16\r\n    #26 0x2021463a in std::__1::__function::__policy_func<void ()>::operator()() const /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2221:16\r\n    #27 0x2021463a in std::__1::function<void ()>::operator()() const /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2560:12\r\n    #28 0x2021463a in DB::PipelineExecutor::executeStepImpl(unsigned long, unsigned long, std::__1::atomic<bool>*) /home/milovidov/work/ClickHouse/build/../src/Processors/Executors/PipelineExecutor.cpp:580:17\r\n    #29 0x2021a2a8 in DB::PipelineExecutor::executeSingleThread(unsigned long, unsigned long) /home/milovidov/work/ClickHouse/build/../src/Processors/Executors/PipelineExecutor.cpp:473:5\r\n    #30 0x2021a2a8 in DB::PipelineExecutor::executeImpl(unsigned long)::$_4::operator()() const /home/milovidov/work/ClickHouse/build/../src/Processors/Executors/PipelineExecutor.cpp:771:21\r\n    #31 0x2021a2a8 in decltype(std::__1::forward<DB::PipelineExecutor::executeImpl(unsigned long)::$_4&>(fp)()) std::__1::__invoke_constexpr<DB::PipelineExecutor::executeImpl(unsigned long)::$_4&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/type_traits:3682:1\r\n    #32 0x2021a2a8 in decltype(auto) std::__1::__apply_tuple_impl<DB::PipelineExecutor::executeImpl(unsigned long)::$_4&, std::__1::tuple<>&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&, std::__1::tuple<>&, std::__1::__tuple_indices<>) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/tuple:1415:1\r\n    #33 0x2021a2a8 in decltype(auto) std::__1::apply<DB::PipelineExecutor::executeImpl(unsigned long)::$_4&, std::__1::tuple<>&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&, std::__1::tuple<>&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/tuple:1424:1\r\n    #34 0x2021a2a8 in ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&)::'lambda'()::operator()() /home/milovidov/work/ClickHouse/build/../src/Common/ThreadPool.h:178:13\r\n    #35 0x2021a2a8 in decltype(std::__1::forward<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(fp)()) std::__1::__invoke<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&)::'lambda'()&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/type_traits:3676:1\r\n    #36 0x2021a2a8 in void std::__1::__invoke_void_return_wrapper<void>::__call<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&)::'lambda'()&>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&...) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/__functional_base:348:9\r\n    #37 0x2021a2a8 in std::__1::__function::__default_alloc_func<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&)::'lambda'(), void ()>::operator()() /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:1608:12\r\n    #38 0x2021a2a8 in void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PipelineExecutor::executeImpl(unsigned long)::$_4>(DB::PipelineExecutor::executeImpl(unsigned long)::$_4&&)::'lambda'(), void ()> >(std::__1::__function::__policy_storage const*) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2089:16\r\n    #39 0xa88dbab in std::__1::__function::__policy_func<void ()>::operator()() const /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2221:16\r\n    #40 0xa88dbab in std::__1::function<void ()>::operator()() const /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/functional:2560:12\r\n    #41 0xa88dbab in ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) /home/milovidov/work/ClickHouse/build/../src/Common/ThreadPool.cpp:247:17\r\n    #42 0xa896743 in void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()::operator()() const /home/milovidov/work/ClickHouse/build/../src/Common/ThreadPool.cpp:124:73\r\n    #43 0xa896743 in decltype(std::__1::forward<void>(fp)(std::__1::forward<void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()>(fp0)...)) std::__1::__invoke<void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()>(void&&, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()&&...) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/type_traits:3676:1\r\n    #44 0xa896743 in void std::__1::__thread_execute<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()>(std::__1::tuple<void, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()>&, std::__1::__tuple_indices<>) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/thread:280:5\r\n    #45 0xa896743 in void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()> >(void*) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/thread:291:5\r\n    #46 0x7fa3922cb608 in start_thread /build/glibc-ZN95T4/glibc-2.31/nptl/pthread_create.c:477:8\r\n```",
  "created_at": "2021-01-20T16:39:53Z",
  "modified_files": [
    "src/AggregateFunctions/AggregateFunctionSum.h",
    "src/Storages/StorageMaterializedView.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01182_materialized_view_different_structure.reference",
    "b/tests/queries/0_stateless/01182_materialized_view_different_structure.sql",
    "tests/queries/0_stateless/arcadia_skip_list.txt"
  ]
}