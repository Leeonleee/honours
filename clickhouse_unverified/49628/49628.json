{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 49628,
  "instance_id": "ClickHouse__ClickHouse-49628",
  "issue_numbers": [
    "49622"
  ],
  "base_commit": "df8c930be388d7ee8c026dd666c976502fb1cb72",
  "patch": "diff --git a/src/Core/Settings.h b/src/Core/Settings.h\nindex dbac8a7ec537..d82df76cc6f6 100644\n--- a/src/Core/Settings.h\n+++ b/src/Core/Settings.h\n@@ -733,7 +733,7 @@ class IColumn;\n     M(Bool, multiple_joins_try_to_keep_original_names, false, \"Do not add aliases to top level expression list on multiple joins rewrite\", 0) \\\n     M(UInt64, grace_hash_join_initial_buckets, 1, \"Initial number of grace hash join buckets\", 0) \\\n     M(UInt64, grace_hash_join_max_buckets, 1024, \"Limit on the number of grace hash join buckets\", 0) \\\n-    M(Bool, optimize_distinct_in_order, true, \"Enable DISTINCT optimization if some columns in DISTINCT form a prefix of sorting. For example, prefix of sorting key in merge tree or ORDER BY statement\", 0) \\\n+    M(Bool, optimize_distinct_in_order, false, \"This optimization has a bug and it is disabled. Enable DISTINCT optimization if some columns in DISTINCT form a prefix of sorting. For example, prefix of sorting key in merge tree or ORDER BY statement\", 0) \\\n     M(Bool, optimize_sorting_by_input_stream_properties, true, \"Optimize sorting by sorting properties of input stream\", 0) \\\n     M(UInt64, insert_keeper_max_retries, 20, \"Max retries for keeper operations during insert\", 0) \\\n     M(UInt64, insert_keeper_retry_initial_backoff_ms, 100, \"Initial backoff timeout for keeper operations during insert\", 0) \\\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02733_distinct.reference b/tests/queries/0_stateless/02733_distinct.reference\nnew file mode 100644\nindex 000000000000..caaa76087c9f\n--- /dev/null\n+++ b/tests/queries/0_stateless/02733_distinct.reference\n@@ -0,0 +1,10 @@\n+\t\t1\n+\t\t2\n+v1\tv2\t3\n+v1\tv2\t4\n+v1\tv2\t5\n+\t\t1\n+\t\t2\n+v1\tv2\t3\n+v1\tv2\t4\n+v1\tv2\t5\ndiff --git a/tests/queries/0_stateless/02733_distinct.sql b/tests/queries/0_stateless/02733_distinct.sql\nnew file mode 100644\nindex 000000000000..bbb26b17d8cd\n--- /dev/null\n+++ b/tests/queries/0_stateless/02733_distinct.sql\n@@ -0,0 +1,19 @@\n+-- Tags: no-random-settings\n+-- there is a bug if `optimize_distinct_in_order` is true\n+\n+DROP TABLE IF EXISTS test;\n+CREATE TABLE test\n+(\n+    c1 String,\n+    c2 String,\n+    c3 String\n+)\n+ENGINE = ReplacingMergeTree\n+ORDER BY (c1, c3);\n+\n+INSERT INTO test(c1, c2, c3) VALUES ('', '', '1'), ('', '', '2'),('v1', 'v2', '3'),('v1', 'v2', '4'),('v1', 'v2', '5');\n+\n+SELECT c1, c2, c3 FROM test GROUP BY c1, c2, c3 ORDER BY c1, c2, c3;\n+SELECT DISTINCT c1, c2, c3 FROM test;\n+\n+DROP TABLE test;\n",
  "problem_statement": "Unexpected \"DISTINCT\" result with empty string\n+ ClickHouse Version\r\n\r\n    `23.4.2.11`\r\n\r\n+ DDL\r\n    ```sql\r\n    CREATE TABLE test\r\n    (\r\n        c1 String,\r\n        c2 String,\r\n        c3 String\r\n    )\r\n    ENGINE = ReplacingMergeTree\r\n    ORDER BY (c1, c3);\r\n    \r\n    INSERT INTO test(c1, c2, c3) VALUES\r\n        ('', '', '1'), ('', '', '2'),('v1', 'v2', '3'),('v1', 'v2', '4'),('v1', 'v2', '5');\r\n    ```\r\n\r\n```sql\r\n\r\nSELECT c1, c2, c3 FROM test GROUP BY c1, c2, c3;\r\n\u250c\u2500c1\u2500\u252c\u2500c2\u2500\u252c\u2500c3\u2500\u2510\r\n\u2502    \u2502    \u2502 2  \u2502\r\n\u2502 v1 \u2502 v2 \u2502 4  \u2502\r\n\u2502 v1 \u2502 v2 \u2502 3  \u2502\r\n\u2502    \u2502    \u2502 1  \u2502\r\n\u2502 v1 \u2502 v2 \u2502 5  \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2518\r\n\r\nSELECT DISTINCT c1, c2, c3 FROM test;\r\n\u250c\u2500c1\u2500\u252c\u2500c2\u2500\u252c\u2500c3\u2500\u2510\r\n\u2502    \u2502    \u2502 1  \u2502\r\n\u2502 v1 \u2502 v2 \u2502 3  \u2502\r\n\u2502 v1 \u2502 v2 \u2502 4  \u2502\r\n\u2502 v1 \u2502 v2 \u2502 5  \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2518\r\n\r\n```\r\nWhy does the query result of this DISTINCT clause not contain rows where c3 is 2\r\n\r\n\r\n\r\n\r\n\n",
  "hints_text": "It's a bug in `optimize_distinct_in_order`\r\n\r\nhttps://fiddle.clickhouse.com/11229299-e12c-40b0-ab26-d0051344d96f\r\n\r\n@devcrafter \r\n\r\nbroken in 23.1.7.30",
  "created_at": "2023-05-07T15:51:00Z",
  "modified_files": [
    "src/Core/Settings.h"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02733_distinct.reference",
    "b/tests/queries/0_stateless/02733_distinct.sql"
  ]
}