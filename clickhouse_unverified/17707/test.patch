diff --git a/docker/test/fasttest/run.sh b/docker/test/fasttest/run.sh
index fb905bdaa5d5..21cd80198d46 100755
--- a/docker/test/fasttest/run.sh
+++ b/docker/test/fasttest/run.sh
@@ -318,6 +318,9 @@ function run_tests
         01545_system_errors
         # Checks system.errors
         01563_distributed_query_finish
+
+        # nc - command not found
+        01601_proxy_protocol
     )
 
     time clickhouse-test -j 8 --order=random --no-long --testname --shard --zookeeper --skip "${TESTS_TO_SKIP[@]}" -- "$FASTTEST_FOCUS" 2>&1 | ts '%Y-%m-%d %H:%M:%S' | tee "$FASTTEST_OUTPUT/test_log.txt"
diff --git a/tests/config/config.d/tcp_with_proxy.xml b/tests/config/config.d/tcp_with_proxy.xml
new file mode 100644
index 000000000000..19046054c166
--- /dev/null
+++ b/tests/config/config.d/tcp_with_proxy.xml
@@ -0,0 +1,3 @@
+<yandex>
+    <tcp_with_proxy_port>9010</tcp_with_proxy_port>
+</yandex>
diff --git a/tests/config/install.sh b/tests/config/install.sh
index c20fb4c8f4e6..d7127a8f690f 100755
--- a/tests/config/install.sh
+++ b/tests/config/install.sh
@@ -29,6 +29,7 @@ ln -sf $SRC_PATH/config.d/graphite.xml $DEST_SERVER_PATH/config.d/
 ln -sf $SRC_PATH/config.d/database_atomic.xml $DEST_SERVER_PATH/config.d/
 ln -sf $SRC_PATH/config.d/test_cluster_with_incorrect_pw.xml $DEST_SERVER_PATH/config.d/
 ln -sf $SRC_PATH/config.d/logging_no_rotate.xml $DEST_SERVER_PATH/config.d/
+ln -sf $SRC_PATH/config.d/tcp_with_proxy.xml $DEST_SERVER_PATH/config.d/
 ln -sf $SRC_PATH/users.d/log_queries.xml $DEST_SERVER_PATH/users.d/
 ln -sf $SRC_PATH/users.d/readonly.xml $DEST_SERVER_PATH/users.d/
 ln -sf $SRC_PATH/users.d/access_management.xml $DEST_SERVER_PATH/users.d/
diff --git a/tests/queries/0_stateless/01600_quota_by_forwarded_ip.reference b/tests/queries/0_stateless/01600_quota_by_forwarded_ip.reference
new file mode 100644
index 000000000000..6f4fa48a62f0
--- /dev/null
+++ b/tests/queries/0_stateless/01600_quota_by_forwarded_ip.reference
@@ -0,0 +1,11 @@
+--- Test with quota by immediate IP ---
+10
+exceeded
+exceeded
+--- Test with quota by forwarded IP ---
+10
+exceeded
+10
+exceeded
+exceeded
+10
diff --git a/tests/queries/0_stateless/01600_quota_by_forwarded_ip.sh b/tests/queries/0_stateless/01600_quota_by_forwarded_ip.sh
new file mode 100755
index 000000000000..33f5434dc6c7
--- /dev/null
+++ b/tests/queries/0_stateless/01600_quota_by_forwarded_ip.sh
@@ -0,0 +1,65 @@
+#!/usr/bin/env bash
+
+CURDIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
+. "$CURDIR"/../shell_config.sh
+
+
+$CLICKHOUSE_CLIENT -n --query "
+DROP USER IF EXISTS quoted_by_ip;
+DROP USER IF EXISTS quoted_by_forwarded_ip;
+
+DROP QUOTA IF EXISTS quota_by_ip;
+DROP QUOTA IF EXISTS quota_by_forwarded_ip;
+
+CREATE USER quoted_by_ip;
+CREATE USER quoted_by_forwarded_ip;
+
+GRANT SELECT, CREATE ON *.* TO quoted_by_ip;
+GRANT SELECT, CREATE ON *.* TO quoted_by_forwarded_ip;
+
+CREATE QUOTA quota_by_ip KEYED BY ip_address FOR RANDOMIZED INTERVAL 1 YEAR MAX QUERIES = 1 TO quoted_by_ip;
+CREATE QUOTA quota_by_forwarded_ip KEYED BY forwarded_ip_address FOR RANDOMIZED INTERVAL 1 YEAR MAX QUERIES = 1 TO quoted_by_forwarded_ip;
+"
+
+# Note: the test can be flaky if the randomized interval will end while the loop is run. But with year long interval it's unlikely.
+# One query is allowed per quota. Actually two queries will execute successfully due to some implementation specific behaviour.
+
+echo '--- Test with quota by immediate IP ---'
+
+while true; do
+    $CLICKHOUSE_CLIENT --user quoted_by_ip --query "SELECT count() FROM numbers(10)" 2>/dev/null || break
+done | uniq
+
+${CLICKHOUSE_CURL} -sS "${CLICKHOUSE_URL}&user=quoted_by_ip" -d "SELECT count() FROM numbers(10)" | grep -oF 'exceeded'
+
+# X-Forwarded-For is ignored for quota by immediate IP address
+${CLICKHOUSE_CURL} -H 'X-Forwarded-For: 1.2.3.4' -sS "${CLICKHOUSE_URL}&user=quoted_by_ip" -d "SELECT count() FROM numbers(10)" | grep -oF 'exceeded'
+
+
+echo '--- Test with quota by forwarded IP ---'
+
+while true; do
+    $CLICKHOUSE_CLIENT --user quoted_by_forwarded_ip --query "SELECT count() FROM numbers(10)" 2>/dev/null || break
+done | uniq
+
+${CLICKHOUSE_CURL} -sS "${CLICKHOUSE_URL}&user=quoted_by_forwarded_ip" -d "SELECT count() FROM numbers(10)" | grep -oF 'exceeded'
+
+# X-Forwarded-For is respected for quota by forwarded IP address
+while true; do
+    ${CLICKHOUSE_CURL} -H 'X-Forwarded-For: 1.2.3.4' -sS "${CLICKHOUSE_URL}&user=quoted_by_forwarded_ip" -d "SELECT count() FROM numbers(10)" | grep -oP '^10$' || break
+done | uniq
+
+${CLICKHOUSE_CURL} -H 'X-Forwarded-For: 1.2.3.4' -sS "${CLICKHOUSE_URL}&user=quoted_by_forwarded_ip" -d "SELECT count() FROM numbers(10)" | grep -oF 'exceeded'
+
+# Only the last IP address is trusted
+${CLICKHOUSE_CURL} -H 'X-Forwarded-For: 5.6.7.8, 1.2.3.4' -sS "${CLICKHOUSE_URL}&user=quoted_by_forwarded_ip" -d "SELECT count() FROM numbers(10)" | grep -oF 'exceeded'
+
+${CLICKHOUSE_CURL} -H 'X-Forwarded-For: 1.2.3.4, 5.6.7.8' -sS "${CLICKHOUSE_URL}&user=quoted_by_forwarded_ip" -d "SELECT count() FROM numbers(10)"
+
+$CLICKHOUSE_CLIENT -n --query "
+DROP QUOTA IF EXISTS quota_by_ip;
+DROP QUOTA IF EXISTS quota_by_forwarded_ip;
+
+DROP USER IF EXISTS quoted_by_ip;
+DROP USER IF EXISTS quoted_by_forwarded_ip;
+"
diff --git a/tests/queries/0_stateless/01601_proxy_protocol.reference b/tests/queries/0_stateless/01601_proxy_protocol.reference
new file mode 100644
index 000000000000..a5c196677102
--- /dev/null
+++ b/tests/queries/0_stateless/01601_proxy_protocol.reference
@@ -0,0 +1,1 @@
+Hello, world
diff --git a/tests/queries/0_stateless/01601_proxy_protocol.sh b/tests/queries/0_stateless/01601_proxy_protocol.sh
new file mode 100755
index 000000000000..8a431ba6dae6
--- /dev/null
+++ b/tests/queries/0_stateless/01601_proxy_protocol.sh
@@ -0,0 +1,6 @@
+#!/usr/bin/env bash
+
+CURDIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
+. "$CURDIR"/../shell_config.sh
+
+printf "PROXY TCP4 255.255.255.255 255.255.255.255 65535 65535\r
\0\21ClickHouse client\24\r\253\251\3\0\7default\0\4\1\0\1\0\0\t0.0.0.0:0\1\tmilovidov\21milovidov-desktop\vClickHouse \24\r\253\251\3\0\1\0\0\0\2\1\25SELECT 'Hello, world'\2\0\247\203\254l\325\\z|\265\254F\275\333\206\342\24\202\24\0\0\0
\0\0\0\240\1\0\2\377\377\377\377\0\0\0" | nc "${CLICKHOUSE_HOST}" "${CLICKHOUSE_PORT_TCP_WITH_PROXY}" | head -c150 | grep --text -o -F 'Hello, world'
diff --git a/tests/queries/shell_config.sh b/tests/queries/shell_config.sh
index 88ff59c5084d..9e287740c116 100644
--- a/tests/queries/shell_config.sh
+++ b/tests/queries/shell_config.sh
@@ -41,6 +41,8 @@ export CLICKHOUSE_PORT_TCP=${CLICKHOUSE_PORT_TCP:=$(${CLICKHOUSE_EXTRACT_CONFIG}
 export CLICKHOUSE_PORT_TCP=${CLICKHOUSE_PORT_TCP:="9000"}
 export CLICKHOUSE_PORT_TCP_SECURE=${CLICKHOUSE_PORT_TCP_SECURE:=$(${CLICKHOUSE_EXTRACT_CONFIG} --try --key=tcp_port_secure 2>/dev/null)} 2>/dev/null
 export CLICKHOUSE_PORT_TCP_SECURE=${CLICKHOUSE_PORT_TCP_SECURE:="9440"}
+export CLICKHOUSE_PORT_TCP_WITH_PROXY=${CLICKHOUSE_PORT_TCP_WITH_PROXY:=$(${CLICKHOUSE_EXTRACT_CONFIG} --try --key=tcp_with_proxy_port 2>/dev/null)} 2>/dev/null
+export CLICKHOUSE_PORT_TCP_WITH_PROXY=${CLICKHOUSE_PORT_TCP_WITH_PROXY:="9010"}
 export CLICKHOUSE_PORT_HTTP=${CLICKHOUSE_PORT_HTTP:=$(${CLICKHOUSE_EXTRACT_CONFIG} --key=http_port 2>/dev/null)}
 export CLICKHOUSE_PORT_HTTP=${CLICKHOUSE_PORT_HTTP:="8123"}
 export CLICKHOUSE_PORT_HTTPS=${CLICKHOUSE_PORT_HTTPS:=$(${CLICKHOUSE_EXTRACT_CONFIG} --try --key=https_port 2>/dev/null)} 2>/dev/null
