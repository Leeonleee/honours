{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 50585,
  "instance_id": "ClickHouse__ClickHouse-50585",
  "issue_numbers": [
    "50578"
  ],
  "base_commit": "13fc7c6c5592a24c97636654319d8dea78a33316",
  "patch": "diff --git a/src/Storages/StorageLog.cpp b/src/Storages/StorageLog.cpp\nindex 02dc48436608..22922e8be79d 100644\n--- a/src/Storages/StorageLog.cpp\n+++ b/src/Storages/StorageLog.cpp\n@@ -775,6 +775,8 @@ void StorageLog::truncate(const ASTPtr &, const StorageMetadataPtr &, ContextPtr\n \n     marks_loaded = true;\n     num_marks_saved = 0;\n+    total_rows = 0;\n+    total_bytes = 0;\n     getContext()->dropMMappedFileCache();\n }\n \ndiff --git a/src/Storages/StorageStripeLog.cpp b/src/Storages/StorageStripeLog.cpp\nindex b2e7c202800d..d17d8a715d2f 100644\n--- a/src/Storages/StorageStripeLog.cpp\n+++ b/src/Storages/StorageStripeLog.cpp\n@@ -424,6 +424,8 @@ void StorageStripeLog::truncate(const ASTPtr &, const StorageMetadataPtr &, Cont\n \n     indices_loaded = true;\n     num_indices_saved = 0;\n+    total_rows = 0;\n+    total_bytes = 0;\n     getContext()->dropMMappedFileCache();\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02771_log_faminy_truncate_count.reference b/tests/queries/0_stateless/02771_log_faminy_truncate_count.reference\nnew file mode 100644\nindex 000000000000..aa47d0d46d47\n--- /dev/null\n+++ b/tests/queries/0_stateless/02771_log_faminy_truncate_count.reference\n@@ -0,0 +1,2 @@\n+0\n+0\ndiff --git a/tests/queries/0_stateless/02771_log_faminy_truncate_count.sql b/tests/queries/0_stateless/02771_log_faminy_truncate_count.sql\nnew file mode 100644\nindex 000000000000..3fb22837f5bb\n--- /dev/null\n+++ b/tests/queries/0_stateless/02771_log_faminy_truncate_count.sql\n@@ -0,0 +1,26 @@\n+DROP TABLE IF EXISTS test_log;\n+CREATE TABLE test_log\n+(\n+    `crypto_name` String,\n+    `trade_date` Date\n+)\n+ENGINE = Log;\n+\n+INSERT INTO test_log (crypto_name, trade_date) VALUES ('abc', '2021-01-01'), ('def', '2022-02-02');\n+\n+TRUNCATE TABLE test_log;\n+SELECT count() FROM  test_log;\n+\n+DROP TABLE IF EXISTS test_log;\n+CREATE TABLE test_log\n+(\n+    `crypto_name` String,\n+    `trade_date` Date\n+)\n+ENGINE = StripeLog;\n+\n+INSERT INTO test_log (crypto_name, trade_date) VALUES ('abc', '2021-01-01'), ('def', '2022-02-02');\n+\n+TRUNCATE TABLE test_log;\n+SELECT count() FROM  test_log;\n+DROP TABLE test_log;\n",
  "problem_statement": "LOG engine count() after TRUNCATE is not empty\n> A clear and concise description of what works not as it is supposed to.\r\n\r\nWhen I do TRUNCATE on LOG ENGINE table, it deletes records, but count() is not empty\r\n\r\n> A link to reproducer\r\n\r\nhttps://fiddle.clickhouse.com/9ee5ac13-56b9-4b78-9f61-66f0e8e49de6\r\n\r\n**Does it reproduce on recent release?**\r\nYes\r\n\r\n**How to reproduce**\r\n\r\n* Which ClickHouse server version to use\r\n23.4.2.11\r\n* Which interface to use, if matters\r\nfiddle\r\n* `CREATE TABLE` statements for all tables involved\r\n```\r\nCREATE TABLE default.test_log\r\n(\r\n    `crypto_name` String,\r\n    `trade_date` Date\r\n)\r\nENGINE = Log\r\nSETTINGS index_granularity = 8192;\r\n```\r\n\r\n* Sample data for all these tables\r\n`INSERT INTO default.test_log (crypto_name, trade_date) VALUES ('abc', '2021-01-01'), ('def', '2022-02-02');`\r\n* Queries to run that lead to unexpected result\r\n```\r\nTRUNCATE TABLE default.test_log;\r\nSELECT count(*) FROM  default.test_log;\r\n```\r\n2\r\n**Expected behavior**\r\ncount is 0\r\n> A clear and concise description of what you expected to happen.\r\n\r\nas `select` from the table after `truncate` returns nothing, `count` should return 0\r\n\r\n\n",
  "hints_text": "Reproduced.",
  "created_at": "2023-06-05T12:45:07Z",
  "modified_files": [
    "src/Storages/StorageLog.cpp",
    "src/Storages/StorageStripeLog.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02771_log_faminy_truncate_count.reference",
    "b/tests/queries/0_stateless/02771_log_faminy_truncate_count.sql"
  ]
}