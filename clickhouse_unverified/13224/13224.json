{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 13224,
  "instance_id": "ClickHouse__ClickHouse-13224",
  "issue_numbers": [
    "12172"
  ],
  "base_commit": "0adf8c723eb296a5423aa1095750ceecfe74df18",
  "patch": "diff --git a/src/Functions/array/arrayElement.cpp b/src/Functions/array/arrayElement.cpp\nindex 2836c5ea4d70..9a60ac4a39df 100644\n--- a/src/Functions/array/arrayElement.cpp\n+++ b/src/Functions/array/arrayElement.cpp\n@@ -780,8 +780,10 @@ void FunctionArrayElement::executeImpl(Block & block, const ColumnNumbers & argu\n         ArrayImpl::NullMapBuilder builder;\n         Block source_block;\n \n-        const auto & input_type = typeid_cast<const DataTypeNullable &>(*typeid_cast<const DataTypeArray &>(*block.getByPosition(arguments[0]).type).getNestedType()).getNestedType();\n-        const auto & tmp_ret_type = typeid_cast<const DataTypeNullable &>(*block.getByPosition(result).type).getNestedType();\n+        const DataTypePtr & input_type = typeid_cast<const DataTypeNullable &>(\n+            *typeid_cast<const DataTypeArray &>(*block.getByPosition(arguments[0]).type).getNestedType()).getNestedType();\n+\n+        DataTypePtr tmp_ret_type = removeNullable(block.getByPosition(result).type);\n \n         if (col_array)\n         {\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01421_array_nullable_element_nullable_index.reference b/tests/queries/0_stateless/01421_array_nullable_element_nullable_index.reference\nnew file mode 100644\nindex 000000000000..070f5e44a15b\n--- /dev/null\n+++ b/tests/queries/0_stateless/01421_array_nullable_element_nullable_index.reference\n@@ -0,0 +1,4 @@\n+[1]\t1\n+[1]\t1\n+[1]\t1\n+[1]\t1\ndiff --git a/tests/queries/0_stateless/01421_array_nullable_element_nullable_index.sql b/tests/queries/0_stateless/01421_array_nullable_element_nullable_index.sql\nnew file mode 100644\nindex 000000000000..5cf8bc8fe008\n--- /dev/null\n+++ b/tests/queries/0_stateless/01421_array_nullable_element_nullable_index.sql\n@@ -0,0 +1,4 @@\n+SELECT [toNullable(1)] AS x, x[toNullable(1)] AS y;\n+SELECT materialize([toNullable(1)]) AS x, x[toNullable(1)] AS y;\n+SELECT [toNullable(1)] AS x, x[materialize(toNullable(1))] AS y;\n+SELECT materialize([toNullable(1)]) AS x, x[materialize(toNullable(1))] AS y;\ndiff --git a/tests/queries/0_stateless/01422_array_nullable_element_nullable_index.reference b/tests/queries/0_stateless/01422_array_nullable_element_nullable_index.reference\nnew file mode 100644\nindex 000000000000..2d128a6ab32d\n--- /dev/null\n+++ b/tests/queries/0_stateless/01422_array_nullable_element_nullable_index.reference\n@@ -0,0 +1,3 @@\n+1\n+1\n+\\N\ndiff --git a/tests/queries/0_stateless/01422_array_nullable_element_nullable_index.sql b/tests/queries/0_stateless/01422_array_nullable_element_nullable_index.sql\nnew file mode 100644\nindex 000000000000..82def86ea8a6\n--- /dev/null\n+++ b/tests/queries/0_stateless/01422_array_nullable_element_nullable_index.sql\n@@ -0,0 +1,3 @@\n+SELECT [1, NULL][toNullable(1)];\n+SELECT [toNullable(1)][toNullable(1)];\n+SELECT [NULL][toNullable(1)];\n",
  "problem_statement": "FunctionArrayElement::executeImpl: Bad cast from type DB::DataTypeNumber<char8_t> to DB::DataTypeNullable\n```\r\n/4/ :) SELECT [1, null][[1, NULL][1]]\r\n\r\n\r\nReceived exception from server (version 20.6.1):\r\nCode: 49. DB::Exception: Received from localhost:9000. DB::Exception: Bad cast from type DB::DataTypeNumber<char8_t> to DB::DataTypeNullable. Stack trace:\r\n\r\n0. /home/akuzm/ch4/ch/contrib/poco/Foundation/src/Exception.cpp:27: Poco::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x1152bbd0 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n1. /home/akuzm/ch4/ch/src/Common/Exception.cpp:37: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x97a736d in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n2. std::__1::enable_if<is_reference_v<DB::DataTypeNullable const&>, DB::DataTypeNullable const&>::type typeid_cast<DB::DataTypeNullable const&, DB::IDataType const>(DB::IDataType const&) @ 0xcb995f8 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n3. DB::FunctionArrayElement::executeImpl(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long) @ 0xcb9719e in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n4. DB::ExecutableFunctionAdaptor::defaultImplementationForNulls(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) @ 0xa3cf29a in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n5. DB::ExecutableFunctionAdaptor::executeWithoutLowCardinalityColumns(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) @ 0xa3cf0f1 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n6. DB::ExecutableFunctionAdaptor::defaultImplementationForConstantArguments(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) @ 0xa3ceea6 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n7. DB::ExecutableFunctionAdaptor::executeWithoutLowCardinalityColumns(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) @ 0xa3cf0c2 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n8. DB::ExecutableFunctionAdaptor::execute(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) @ 0xa3cfe41 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n9. /home/akuzm/ch4/ch/src/Interpreters/ExpressionActions.cpp:209: DB::ExpressionAction::prepare(DB::Block&, DB::Settings const&, std::__1::unordered_set<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > >&) @ 0xe3843f5 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n10. /home/akuzm/ch4/ch/contrib/libcxx/include/vector:1635: DB::ExpressionActions::addImpl(DB::ExpressionAction, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > >&) @ 0xe384fb5 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n11. /home/akuzm/ch4/ch/src/Interpreters/ExpressionActions.cpp:586: DB::ExpressionActions::add(DB::ExpressionAction const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > >&) @ 0xe38561d in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n12. /home/akuzm/ch4/ch/contrib/libcxx/include/vector:1549: DB::ScopeStack::addAction(DB::ExpressionAction const&) @ 0xe42a8ed in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n13. /home/akuzm/ch4/ch/src/Interpreters/ActionsVisitor.cpp:593: DB::ActionsMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) @ 0xe432776 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n14. /home/akuzm/ch4/ch/contrib/libcxx/include/memory:3826: DB::InDepthNodeVisitor<DB::ActionsMatcher, true, std::__1::shared_ptr<DB::IAST> const>::visit(std::__1::shared_ptr<DB::IAST> const&) @ 0xe42002b in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n15. /home/akuzm/ch4/ch/src/Interpreters/InDepthNodeVisitor.h:45: DB::ExpressionAnalyzer::getRootActions(std::__1::shared_ptr<DB::IAST> const&, bool, std::__1::shared_ptr<DB::ExpressionActions>&, bool) (.constprop.0) @ 0xe4126f3 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n16. /home/akuzm/ch4/ch/contrib/libcxx/include/vector:656: DB::SelectQueryExpressionAnalyzer::appendSelect(DB::ExpressionActionsChain&, bool) @ 0xe413688 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n17. /home/akuzm/ch4/ch/contrib/libcxx/include/vector:662: DB::ExpressionAnalysisResult::ExpressionAnalysisResult(DB::SelectQueryExpressionAnalyzer&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&, bool, bool, bool, std::__1::shared_ptr<DB::FilterInfo> const&, DB::Block const&) @ 0xe41ceb7 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n18. /home/akuzm/ch4/ch/src/Interpreters/ExpressionAnalyzer.h:164: DB::InterpreterSelectQuery::getSampleBlockImpl() @ 0xe3cb1cd in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n19. /home/akuzm/ch4/ch/src/Interpreters/InterpreterSelectQuery.cpp:312: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&)::'lambda'(bool)::operator()(bool) const @ 0xe3d1c6a in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n20. /home/akuzm/ch4/ch/src/Interpreters/InterpreterSelectQuery.cpp:408: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&) @ 0xe3d9cb7 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n21. /home/akuzm/ch4/ch/src/Interpreters/InterpreterSelectQuery.cpp:146: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0xe3db669 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n22. /home/akuzm/ch4/ch/contrib/libcxx/include/vector:1681: DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0xe53cb77 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n23. /home/akuzm/ch4/ch/contrib/libcxx/include/vector:461: DB::InterpreterFactory::get(std::__1::shared_ptr<DB::IAST>&, DB::Context&, DB::QueryProcessingStage::Enum) @ 0xe347064 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n24. /home/akuzm/ch4/ch/contrib/libcxx/include/memory:2587: DB::executeQueryImpl(char const*, char const*, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool, DB::ReadBuffer*) @ 0xe6ae7cd in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n25. /home/akuzm/ch4/ch/src/Interpreters/executeQuery.cpp:644: DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool) @ 0xe6b20ba in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n26. /home/akuzm/ch4/ch/src/Server/TCPHandler.cpp:253: DB::TCPHandler::runImpl() @ 0xece41c6 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n27. /home/akuzm/ch4/ch/src/Server/TCPHandler.cpp:1203: DB::TCPHandler::run() @ 0xece4f20 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n28. /home/akuzm/ch4/ch/contrib/poco/Net/src/TCPServerConnection.cpp:57: Poco::Net::TCPServerConnection::start() @ 0x11449a3b in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n29. /home/akuzm/ch4/ch/contrib/libcxx/include/atomic:856: Poco::Net::TCPServerDispatcher::run() @ 0x11449ecb in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n30. /home/akuzm/ch4/ch/contrib/poco/Foundation/include/Poco/Mutex_POSIX.h:59: Poco::PooledThread::run() @ 0x115c89a6 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n31. /home/akuzm/ch4/ch/contrib/poco/Foundation/include/Poco/AutoPtr.h:223: Poco::ThreadImpl::runnableEntry(void*) @ 0x115c3da0 in /home/akuzm/ch4/build-gcc9-rel/programs/clickhouse\r\n```\n",
  "hints_text": "`SELECT [1, NULL][toNullable(1)]`\r\n`SELECT [toNullable(1)][toNullable(1)]`\r\n`SELECT [NULL][toNullable(1)]`",
  "created_at": "2020-08-02T01:08:13Z",
  "modified_files": [
    "src/Functions/array/arrayElement.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01421_array_nullable_element_nullable_index.reference",
    "b/tests/queries/0_stateless/01421_array_nullable_element_nullable_index.sql",
    "b/tests/queries/0_stateless/01422_array_nullable_element_nullable_index.reference",
    "b/tests/queries/0_stateless/01422_array_nullable_element_nullable_index.sql"
  ]
}