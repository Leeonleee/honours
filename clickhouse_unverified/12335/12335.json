{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 12335,
  "instance_id": "ClickHouse__ClickHouse-12335",
  "issue_numbers": [
    "12301"
  ],
  "base_commit": "26293e4640080a3d7c9c97a28f670717a87e746b",
  "patch": "diff --git a/src/Storages/AlterCommands.cpp b/src/Storages/AlterCommands.cpp\nindex fc72effca9a3..c1b5c3ee45fb 100644\n--- a/src/Storages/AlterCommands.cpp\n+++ b/src/Storages/AlterCommands.cpp\n@@ -479,11 +479,23 @@ void AlterCommand::apply(StorageInMemoryMetadata & metadata, const Context & con\n         if (metadata.table_ttl.definition_ast)\n             rename_visitor.visit(metadata.table_ttl.definition_ast);\n \n-        metadata.table_ttl = TTLTableDescription::getTTLForTableFromAST(\n-            metadata.table_ttl.definition_ast, metadata.columns, context, metadata.primary_key);\n-\n         for (auto & constraint : metadata.constraints.constraints)\n             rename_visitor.visit(constraint);\n+\n+        if (metadata.isSortingKeyDefined())\n+            rename_visitor.visit(metadata.sorting_key.definition_ast);\n+\n+        if (metadata.isPrimaryKeyDefined())\n+            rename_visitor.visit(metadata.primary_key.definition_ast);\n+\n+        if (metadata.isSamplingKeyDefined())\n+            rename_visitor.visit(metadata.sampling_key.definition_ast);\n+\n+        if (metadata.isPartitionKeyDefined())\n+            rename_visitor.visit(metadata.partition_key.definition_ast);\n+\n+        for (auto & index : metadata.secondary_indices)\n+            rename_visitor.visit(index.definition_ast);\n     }\n     else\n         throw Exception(\"Wrong parameter type in ALTER query\", ErrorCodes::LOGICAL_ERROR);\n@@ -722,10 +734,10 @@ void AlterCommands::apply(StorageInMemoryMetadata & metadata, const Context & co\n             command.apply(metadata_copy, context);\n \n     /// Changes in columns may lead to changes in keys expression.\n-    metadata_copy.sorting_key.recalculateWithNewColumns(metadata_copy.columns, context);\n+    metadata_copy.sorting_key.recalculateWithNewAST(metadata_copy.sorting_key.definition_ast, metadata_copy.columns, context);\n     if (metadata_copy.primary_key.definition_ast != nullptr)\n     {\n-        metadata_copy.primary_key.recalculateWithNewColumns(metadata_copy.columns, context);\n+        metadata_copy.primary_key.recalculateWithNewAST(metadata_copy.primary_key.definition_ast, metadata_copy.columns, context);\n     }\n     else\n     {\n@@ -735,11 +747,11 @@ void AlterCommands::apply(StorageInMemoryMetadata & metadata, const Context & co\n \n     /// And in partition key expression\n     if (metadata_copy.partition_key.definition_ast != nullptr)\n-        metadata_copy.partition_key.recalculateWithNewColumns(metadata_copy.columns, context);\n+        metadata_copy.partition_key.recalculateWithNewAST(metadata_copy.partition_key.definition_ast, metadata_copy.columns, context);\n \n     /// Changes in columns may lead to changes in secondary indices\n     for (auto & index : metadata_copy.secondary_indices)\n-        index.recalculateWithNewColumns(metadata_copy.columns, context);\n+        index = IndexDescription::getIndexFromAST(index.definition_ast, metadata_copy.columns, context);\n \n     /// Changes in columns may lead to changes in TTL expressions.\n     auto column_ttl_asts = metadata_copy.columns.getColumnTTLs();\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01213_alter_rename_primary_key_zookeeper.sql b/tests/queries/0_stateless/01213_alter_rename_primary_key_zookeeper.sql\nindex b7102fab2309..5c62d5d91070 100644\n--- a/tests/queries/0_stateless/01213_alter_rename_primary_key_zookeeper.sql\n+++ b/tests/queries/0_stateless/01213_alter_rename_primary_key_zookeeper.sql\n@@ -17,11 +17,11 @@ INSERT INTO table_for_rename_pk SELECT toDate('2019-10-01') + number % 3, number\n \n SELECT key1, value1 FROM table_for_rename_pk WHERE key1 = 1 AND key2 = 1 AND key3 = 1;\n \n-ALTER TABLE table_for_rename_pk RENAME COLUMN key1 TO renamed_key1; --{serverError 47}\n+ALTER TABLE table_for_rename_pk RENAME COLUMN key1 TO renamed_key1; --{serverError 524}\n \n-ALTER TABLE table_for_rename_pk RENAME COLUMN key3 TO renamed_key3; --{serverError 47}\n+ALTER TABLE table_for_rename_pk RENAME COLUMN key3 TO renamed_key3; --{serverError 524}\n \n-ALTER TABLE table_for_rename_pk RENAME COLUMN key2 TO renamed_key2; --{serverError 47}\n+ALTER TABLE table_for_rename_pk RENAME COLUMN key2 TO renamed_key2; --{serverError 524}\n \n DROP TABLE IF EXISTS table_for_rename_pk NO DELAY;\n SELECT sleep(1) FORMAT Null;\n@@ -45,12 +45,12 @@ PRIMARY KEY (key1, key2);\n \n INSERT INTO table_for_rename_with_primary_key SELECT toDate('2019-10-01') + number % 3, number, number, number, toString(number), toString(number) from numbers(9);\n \n-ALTER TABLE table_for_rename_with_primary_key RENAME COLUMN key1 TO renamed_key1; --{serverError 47}\n+ALTER TABLE table_for_rename_with_primary_key RENAME COLUMN key1 TO renamed_key1; --{serverError 524}\n \n-ALTER TABLE table_for_rename_with_primary_key RENAME COLUMN key2 TO renamed_key2; --{serverError 47}\n+ALTER TABLE table_for_rename_with_primary_key RENAME COLUMN key2 TO renamed_key2; --{serverError 524}\n \n-ALTER TABLE table_for_rename_with_primary_key RENAME COLUMN key3 TO renamed_key3; --{serverError 47}\n+ALTER TABLE table_for_rename_with_primary_key RENAME COLUMN key3 TO renamed_key3; --{serverError 524}\n \n-ALTER TABLE table_for_rename_with_primary_key RENAME COLUMN value1 TO renamed_value1; --{serverError 47}\n+ALTER TABLE table_for_rename_with_primary_key RENAME COLUMN value1 TO renamed_value1; --{serverError 524}\n \n DROP TABLE IF EXISTS table_for_rename_with_primary_key;\ndiff --git a/tests/queries/0_stateless/01344_alter_enum_partition_key.sql b/tests/queries/0_stateless/01344_alter_enum_partition_key.sql\nindex 14bc3b5cdaaa..be6b48918eed 100644\n--- a/tests/queries/0_stateless/01344_alter_enum_partition_key.sql\n+++ b/tests/queries/0_stateless/01344_alter_enum_partition_key.sql\n@@ -28,8 +28,8 @@ ALTER TABLE test MODIFY COLUMN x UInt64; -- { serverError 524 }\n ALTER TABLE test MODIFY COLUMN x String; -- { serverError 524 }\n ALTER TABLE test MODIFY COLUMN x Nullable(Int64); -- { serverError 524 }\n \n-ALTER TABLE test RENAME COLUMN x TO z; -- { serverError 47 }\n-ALTER TABLE test RENAME COLUMN y TO z; -- { serverError 47 }\n+ALTER TABLE test RENAME COLUMN x TO z; -- { serverError 524 }\n+ALTER TABLE test RENAME COLUMN y TO z; -- { serverError 524 }\n ALTER TABLE test DROP COLUMN x; -- { serverError 47 }\n ALTER TABLE test DROP COLUMN y; -- { serverError 47 }\n \ndiff --git a/tests/queries/0_stateless/01346_alter_enum_partition_key_replicated.sql b/tests/queries/0_stateless/01346_alter_enum_partition_key_replicated.sql\nindex 8929fb79d174..35faf6f43ec3 100644\n--- a/tests/queries/0_stateless/01346_alter_enum_partition_key_replicated.sql\n+++ b/tests/queries/0_stateless/01346_alter_enum_partition_key_replicated.sql\n@@ -40,8 +40,8 @@ ALTER TABLE test MODIFY COLUMN x UInt64; -- { serverError 524 }\n ALTER TABLE test MODIFY COLUMN x String; -- { serverError 524 }\n ALTER TABLE test MODIFY COLUMN x Nullable(Int64); -- { serverError 524 }\n \n-ALTER TABLE test RENAME COLUMN x TO z; -- { serverError 47 }\n-ALTER TABLE test RENAME COLUMN y TO z; -- { serverError 47 }\n+ALTER TABLE test RENAME COLUMN x TO z; -- { serverError 524 }\n+ALTER TABLE test RENAME COLUMN y TO z; -- { serverError 524 }\n ALTER TABLE test DROP COLUMN x; -- { serverError 47 }\n ALTER TABLE test DROP COLUMN y; -- { serverError 47 }\n \n",
  "problem_statement": "20.5 is confused while trying to rename a key column\nI tried to rename a key column in a MergeTree table. It does not work, and 20.4 is very clear about the reason. \r\n20.5.2 is complaining about non-existing column with the old name, suggesting there is a column with the new name:\r\n```\r\nALTER TABLE rename_key\r\n    RENAME COLUMN key TO new\r\n\r\nReceived exception from server (version 20.4.6):\r\nCode: 44. DB::Exception: Received from localhost:9000. \r\nDB::Exception: Trying to ALTER RENAME key key column which is a part of key expression.\r\n\r\nReceived exception from server (version 20.5.2):\r\nCode: 47. DB::Exception: Received from localhost:9000. \r\nDB::Exception: Missing columns: 'key' while processing query: 'key', required columns: 'key', source columns: 'value' 'new' 'date'.\r\n```\r\nThe message hasn't changed for the partition key:\r\n```\r\nALTER TABLE rename_key\r\n    RENAME COLUMN date TO new\r\n\r\nReceived exception from server (version 20.4.6):\r\nCode: 44. DB::Exception: Received from localhost:9000. \r\nDB::Exception: Trying to ALTER RENAME key date column which is a part of key expression.\r\n\r\nReceived exception from server (version 20.5.2):\r\nCode: 524. DB::Exception: Received from localhost:9000. \r\nDB::Exception: Trying to ALTER RENAME key date column which is a part of key expression.\r\n```\r\nThe table:\r\n```\r\nCREATE TABLE rename_key\r\n(\r\n    `date` Date,\r\n    `key` UInt64,\r\n    `value` String\r\n)\r\nENGINE = MergeTree()\r\nPARTITION BY date\r\nORDER BY key\r\n```\r\n\n",
  "hints_text": "",
  "created_at": "2020-07-09T14:33:09Z",
  "modified_files": [
    "src/Storages/AlterCommands.cpp"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/01213_alter_rename_primary_key_zookeeper.sql",
    "tests/queries/0_stateless/01344_alter_enum_partition_key.sql",
    "tests/queries/0_stateless/01346_alter_enum_partition_key_replicated.sql"
  ]
}