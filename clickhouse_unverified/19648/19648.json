{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 19648,
  "instance_id": "ClickHouse__ClickHouse-19648",
  "issue_numbers": [
    "19495"
  ],
  "base_commit": "e97c01c3ea41a51b1f9f16f7b78e19c21be80790",
  "patch": "diff --git a/src/Interpreters/MergeJoin.cpp b/src/Interpreters/MergeJoin.cpp\nindex 2cf1024648a4..e1e4cd9e8a3d 100644\n--- a/src/Interpreters/MergeJoin.cpp\n+++ b/src/Interpreters/MergeJoin.cpp\n@@ -930,7 +930,7 @@ std::shared_ptr<Block> MergeJoin::loadRightBlock(size_t pos) const\n     {\n         auto load_func = [&]() -> std::shared_ptr<Block>\n         {\n-            TemporaryFileStream input(flushed_right_blocks[pos]->path(), right_sample_block);\n+            TemporaryFileStream input(flushed_right_blocks[pos]->path(), materializeBlock(right_sample_block));\n             return std::make_shared<Block>(input.block_in->read());\n         };\n \ndiff --git a/src/Interpreters/SortedBlocksWriter.cpp b/src/Interpreters/SortedBlocksWriter.cpp\nindex 0dba09bc80f2..35df9cd45161 100644\n--- a/src/Interpreters/SortedBlocksWriter.cpp\n+++ b/src/Interpreters/SortedBlocksWriter.cpp\n@@ -3,6 +3,7 @@\n #include <DataStreams/MergingSortedBlockInputStream.h>\n #include <DataStreams/OneBlockInputStream.h>\n #include <DataStreams/TemporaryFileStream.h>\n+#include <DataStreams/materializeBlock.h>\n #include <Disks/StoragePolicy.h>\n \n namespace DB\n@@ -198,7 +199,7 @@ SortedBlocksWriter::SortedFiles SortedBlocksWriter::finishMerge(std::function<vo\n \n BlockInputStreamPtr SortedBlocksWriter::streamFromFile(const TmpFilePtr & file) const\n {\n-    return std::make_shared<TemporaryFileLazyInputStream>(file->path(), sample_block);\n+    return std::make_shared<TemporaryFileLazyInputStream>(file->path(), materializeBlock(sample_block));\n }\n \n String SortedBlocksWriter::getPath() const\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01671_merge_join_and_constants.reference b/tests/queries/0_stateless/01671_merge_join_and_constants.reference\nnew file mode 100644\nindex 000000000000..114fc9ff91fc\n--- /dev/null\n+++ b/tests/queries/0_stateless/01671_merge_join_and_constants.reference\n@@ -0,0 +1,5 @@\n+\u250c\u2500\u001b[1ma\u001b[0m\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u001b[1mb\u001b[0m\u2500\u252c\u2500\u001b[1mc\u001b[0m\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u001b[1md\u001b[0m\u2500\u252c\u2500\u001b[1mt2.'0.10'\u001b[0m\u2500\u2510\n+\u2502 a \u2502 2018-01-01 \u2502   \u2502 1970-01-01 \u2502           \u2502\n+\u2502 b \u2502 2018-01-01 \u2502 B \u2502 2018-01-01 \u2502 0.10      \u2502\n+\u2502 c \u2502 2018-01-01 \u2502 C \u2502 2018-01-01 \u2502 0.10      \u2502\n+\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\ndiff --git a/tests/queries/0_stateless/01671_merge_join_and_constants.sql b/tests/queries/0_stateless/01671_merge_join_and_constants.sql\nnew file mode 100644\nindex 000000000000..8611a96a7233\n--- /dev/null\n+++ b/tests/queries/0_stateless/01671_merge_join_and_constants.sql\n@@ -0,0 +1,15 @@\n+DROP TABLE IF EXISTS table1;\n+DROP TABLE IF EXISTS table2;\n+\n+CREATE TABLE table1(a String, b Date) ENGINE MergeTree order by a;\n+CREATE TABLE table2(c String, a String, d Date) ENGINE MergeTree order by c;\n+\n+INSERT INTO table1 VALUES ('a', '2018-01-01') ('b', '2018-01-01') ('c', '2018-01-01');\n+INSERT INTO table2 VALUES ('D', 'd', '2018-01-01') ('B', 'b', '2018-01-01') ('C', 'c', '2018-01-01');\n+\n+set join_algorithm = 'partial_merge';\n+\n+SELECT * FROM table1 AS t1 ALL LEFT JOIN (SELECT *, '0.10', c, d AS b FROM table2) AS t2 USING (a, b) ORDER BY d ASC FORMAT PrettyCompact settings max_rows_in_join = 1;\n+\n+DROP TABLE IF EXISTS table1;\n+DROP TABLE IF EXISTS table2;\n",
  "problem_statement": "Block structure mismatch in Native stream\nhttps://clickhouse-test-reports.s3.yandex.net/19475/02d28c1f9b9558ca5af267167a542819b9e1d061/fuzzer_debug/report.html#fail1\n",
  "hints_text": "",
  "created_at": "2021-01-26T12:40:33Z",
  "modified_files": [
    "src/Interpreters/MergeJoin.cpp",
    "src/Interpreters/SortedBlocksWriter.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01671_merge_join_and_constants.reference",
    "b/tests/queries/0_stateless/01671_merge_join_and_constants.sql"
  ]
}