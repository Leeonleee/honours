{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 64388,
  "instance_id": "ClickHouse__ClickHouse-64388",
  "issue_numbers": [
    "64172"
  ],
  "base_commit": "ebaf19bf3f0fc5a0423438a1a60259d1e982b700",
  "patch": "diff --git a/src/Storages/StorageBuffer.cpp b/src/Storages/StorageBuffer.cpp\nindex d9a0b2b4d59e..a3f6b6afc5d4 100644\n--- a/src/Storages/StorageBuffer.cpp\n+++ b/src/Storages/StorageBuffer.cpp\n@@ -302,6 +302,8 @@ void StorageBuffer::read(\n                 auto src_table_query_info = query_info;\n                 if (src_table_query_info.prewhere_info)\n                 {\n+                    src_table_query_info.prewhere_info = src_table_query_info.prewhere_info->clone();\n+\n                     auto actions_dag = ActionsDAG::makeConvertingActions(\n                             header_after_adding_defaults.getColumnsWithTypeAndName(),\n                             header.getColumnsWithTypeAndName(),\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/00910_buffer_prewhere_different_types.sql b/tests/queries/0_stateless/00910_buffer_prewhere_different_types.sql\nindex 8f305914cb8a..702d9bb3e6c4 100644\n--- a/tests/queries/0_stateless/00910_buffer_prewhere_different_types.sql\n+++ b/tests/queries/0_stateless/00910_buffer_prewhere_different_types.sql\n@@ -2,8 +2,14 @@ DROP TABLE IF EXISTS buffer_table1__fuzz_28;\n DROP TABLE IF EXISTS merge_tree_table1;\n \n CREATE TABLE merge_tree_table1 (`x` UInt32) ENGINE = MergeTree ORDER BY x;\n+\n+CREATE TABLE buffer_table1__fuzz_24 (`s` Nullable(Int128), `x` Nullable(FixedString(17))) ENGINE = Buffer(currentDatabase(), 'merge_tree_table1', 16, 10, 60, 10, 1000, 1048576, 2097152);\n+SELECT s FROM buffer_table1__fuzz_24 PREWHERE factorial(toNullable(10)); -- { serverError ILLEGAL_TYPE_OF_COLUMN_FOR_FILTER }\n+\n INSERT INTO merge_tree_table1 VALUES (1), (2), (3), (4), (5), (6), (7), (8), (9), (10);\n \n+SELECT s FROM buffer_table1__fuzz_24 PREWHERE factorial(toNullable(10)); -- { serverError ILLEGAL_TYPE_OF_COLUMN_FOR_FILTER }\n+\n SET send_logs_level='error';\n \n CREATE TABLE buffer_table1__fuzz_28 (`x` Nullable(UInt32)) ENGINE = Buffer(currentDatabase(), 'merge_tree_table1', 16, 10, 60, 10, 1000, 1048576, 2097152);\n",
  "problem_statement": "Prewhere: Bad cast from type DB::ColumnNullable to DB::ColumnLowCardinality\n**Describe the bug**\r\nhttps://s3.amazonaws.com/clickhouse-test-reports/0/2450eb993229d127d6006d92bd5919d2352f19cb/ast_fuzzer__ubsan_.html\r\n\r\n**How to reproduce**\r\n\r\n```\r\nCREATE TABLE merge_tree_table1 (`s` LowCardinality(String), `x` UInt32) ENGINE = MergeTree ORDER BY x SETTINGS index_granularity = 1;\r\n\r\nCREATE TABLE buffer_table1__fuzz_24 (`s` Nullable(Int128), `x` Nullable(FixedString(17))) ENGINE = Buffer(currentDatabase(), 'merge_tree_table1', 16, 10, 60, 10, 1000, 1048576, 2097152);\r\n\r\nSELECT s FROM buffer_table1__fuzz_24 PREWHERE factorial(toNullable(10))\r\n```\r\n\r\n```\r\n2024.05.20 20:58:38.020550 [ 395287 ] {ea80d8c2-0e0c-4a23-b942-1a0366a3e515} <Fatal> : Logical error: 'Bad cast from type DB::ColumnNullable to DB::ColumnLowCardinality'.\r\n```\r\n\r\nBacktrace from ch local: https://pastila.nl/?0006a671/66f68d2874c5bc5a7442763566bb3b0b#aDb6JD5VXiIulj7aDBX6Ew==\r\n\r\n\r\nWorks fine in the old interpreter (throws `ILLEGAL_TYPE_OF_COLUMN_FOR_FILTER`)\n",
  "hints_text": "",
  "created_at": "2024-05-24T15:39:29Z"
}