{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 53439,
  "instance_id": "ClickHouse__ClickHouse-53439",
  "issue_numbers": [
    "53437"
  ],
  "base_commit": "e7d0edfce6b8ceb9231f3e7a2cdeeb0f73d9ab69",
  "patch": "diff --git a/src/Interpreters/PreparedSets.cpp b/src/Interpreters/PreparedSets.cpp\nindex c2c01b912f95..e0551dff2adb 100644\n--- a/src/Interpreters/PreparedSets.cpp\n+++ b/src/Interpreters/PreparedSets.cpp\n@@ -198,7 +198,11 @@ SetPtr FutureSetFromSubquery::buildOrderedSetInplace(const ContextPtr & context)\n     CompletedPipelineExecutor executor(pipeline);\n     executor.execute();\n \n-    set_and_key->set->checkIsCreated();\n+    /// SET may not be created successfully at this step because of the sub-query timeout, but if we have\n+    /// timeout_overflow_mode set to `break`, no exception is thrown, and the executor just stops executing\n+    /// the pipeline without setting `set_and_key->set->is_created` to true.\n+    if (!set_and_key->set->isCreated())\n+        return nullptr;\n \n     return set_and_key->set;\n }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02844_subquery_timeout_with_break.reference b/tests/queries/0_stateless/02844_subquery_timeout_with_break.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02844_subquery_timeout_with_break.sql b/tests/queries/0_stateless/02844_subquery_timeout_with_break.sql\nnew file mode 100644\nindex 000000000000..511ed0c59de2\n--- /dev/null\n+++ b/tests/queries/0_stateless/02844_subquery_timeout_with_break.sql\n@@ -0,0 +1,10 @@\n+DROP TABLE IF EXISTS t;\n+CREATE TABLE t (key UInt64, value UInt64, INDEX value_idx value TYPE bloom_filter GRANULARITY 1) ENGINE=MergeTree() ORDER BY key;\n+\n+INSERT INTO t SELECT number, rand()%1000 FROM numbers(10000);\n+\n+SET timeout_overflow_mode='break';\n+SET max_execution_time=0.1;\n+SELECT * FROM t WHERE value IN (SELECT number FROM numbers(1000000000));\n+\n+DROP TABLE t;\n",
  "problem_statement": "Logical error: Trying to use set before it has been built (with timeout_overflow_mode = 'break')\n**Describe the unexpected behaviour**\r\nWhen set `timeout_overflow_mode = 'break'` we expect that if query timeout it will break and not throwing exception, but it still can if query has subquery in the rhs of IN and index is used.\r\n\r\n```\r\nDB::Exception: Logical error: Trying to use set before it has been built. (LOGICAL_ERROR) (version 23.7.4.5 (official build))\r\n```\r\n\r\n**How to reproduce**\r\nhttps://fiddle.clickhouse.com/b1b82a33-df3d-4d9d-bdd9-5bc0d538cf8b\r\n\r\n```sql\r\nCREATE TABLE t (key UInt64, value UInt64, INDEX value_idx value TYPE bloom_filter GRANULARITY 1) ENGINE=MergeTree() ORDER BY key;\r\n\r\nINSERT INTO t SELECT number, rand()%1000 FROM numbers(10000);\r\n\r\nSET timeout_overflow_mode='break';\r\nSET max_execution_time=0.5;\r\nSET send_logs_level='debug';\r\n\r\nSELECT * FROM t WHERE value IN (SELECT number FROM numbers(100000000));\r\n```\r\n\r\n\n",
  "hints_text": "",
  "created_at": "2023-08-15T04:38:55Z"
}