{
  "repo": "duckdb/duckdb",
  "pull_number": 7858,
  "instance_id": "duckdb__duckdb-7858",
  "issue_numbers": [
    "7795",
    "7795"
  ],
  "base_commit": "e9b683ce153659dc6fc7983417e562f90e12ed42",
  "patch": "diff --git a/src/planner/binder/tableref/bind_pivot.cpp b/src/planner/binder/tableref/bind_pivot.cpp\nindex 89a3651bfe90..c7ef817c275d 100644\n--- a/src/planner/binder/tableref/bind_pivot.cpp\n+++ b/src/planner/binder/tableref/bind_pivot.cpp\n@@ -546,6 +546,9 @@ unique_ptr<BoundTableRef> Binder::Bind(PivotRef &ref) {\n \n \t// bind the source of the pivot\n \t// we need to do this to be able to expand star expressions\n+\tif (ref.source->type == TableReferenceType::SUBQUERY && ref.source->alias.empty()) {\n+\t\tref.source->alias = \"__internal_pivot_alias_\" + to_string(GenerateTableIndex());\n+\t}\n \tauto copied_source = ref.source->Copy();\n \tauto star_binder = Binder::CreateBinder(context, this);\n \tstar_binder->Bind(*copied_source);\n",
  "test_patch": "diff --git a/test/sql/pivot/test_unpivot.test b/test/sql/pivot/test_unpivot.test\nindex a9e11593626c..f635ff3b3b3f 100644\n--- a/test/sql/pivot/test_unpivot.test\n+++ b/test/sql/pivot/test_unpivot.test\n@@ -159,6 +159,24 @@ Feb\t400\n Mar\t100\n April\t50\n \n+# unpivot over subquery\n+query IIIII\n+UNPIVOT (SELECT * FROM monthly_sales)\n+    ON jan, feb, mar april\n+    INTO\n+        NAME month\n+        VALUE sales;\n+----\n+1\telectronics\t100\tJan\t100\n+1\telectronics\t100\tFeb\t200\n+1\telectronics\t100\tapril\t300\n+2\tclothes\t200\tJan\t100\n+2\tclothes\t200\tFeb\t300\n+2\tclothes\t200\tapril\t150\n+3\tcars\t50\tJan\t200\n+3\tcars\t50\tFeb\t400\n+3\tcars\t50\tapril\t100\n+\n # empty IN clause\n statement error\n SELECT * FROM monthly_sales\n",
  "problem_statement": "`Error: Binder Error: Referenced table \"unnamed_subquery1\" not found!` in UNPIVOT with a SELECT expression\n### What happens?\n\nWhen performing an UNPIVOT on a SELECT expression (rather than just a table name, as in the [examples](https://duckdb.org/docs/sql/statements/unpivot#unpivot-manually), duckdb gives the following error:\r\n```\r\nError: Binder Error: Referenced table \"unnamed_subquery1\" not found!\r\nCandidate tables: \"unnamed_subquery8\"\r\n```\n\n### To Reproduce\n\n```sql\r\nCREATE OR REPLACE TABLE monthly_sales(empid INT, dept TEXT, Jan INT, Feb INT, Mar INT, Apr INT, May INT, Jun INT);\r\nINSERT INTO monthly_sales VALUES\r\n(1, 'electronics', 1, 2, 3, 4, 5, 6),\r\n(2, 'clothes', 10, 20, 30, 40, 50, 60),\r\n(3, 'cars', 100, 200, 300, 400, 500, 600);\r\n\r\n-- works as intended\r\nUNPIVOT monthly_sales\r\n    ON jan, feb, mar, apr, may, jun\r\n    INTO\r\n        NAME month\r\n        VALUE sales;\r\n\r\n-- complains about missing unnamed_subquery\r\nUNPIVOT (SELECT * FROM monthly_sales)\r\n    ON jan, feb, mar, apr, may, jun\r\n    INTO\r\n        NAME month\r\n        VALUE sales;\r\n```\n\n### OS:\n\nmacOS 13.1 (arm64)\n\n### DuckDB Version:\n\nv0.8.0 e8e4cea5ec\n\n### DuckDB Client:\n\nCLI\n\n### Full Name:\n\nJonathan Shi\n\n### Affiliation:\n\nPonder Data\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n`Error: Binder Error: Referenced table \"unnamed_subquery1\" not found!` in UNPIVOT with a SELECT expression\n### What happens?\n\nWhen performing an UNPIVOT on a SELECT expression (rather than just a table name, as in the [examples](https://duckdb.org/docs/sql/statements/unpivot#unpivot-manually), duckdb gives the following error:\r\n```\r\nError: Binder Error: Referenced table \"unnamed_subquery1\" not found!\r\nCandidate tables: \"unnamed_subquery8\"\r\n```\n\n### To Reproduce\n\n```sql\r\nCREATE OR REPLACE TABLE monthly_sales(empid INT, dept TEXT, Jan INT, Feb INT, Mar INT, Apr INT, May INT, Jun INT);\r\nINSERT INTO monthly_sales VALUES\r\n(1, 'electronics', 1, 2, 3, 4, 5, 6),\r\n(2, 'clothes', 10, 20, 30, 40, 50, 60),\r\n(3, 'cars', 100, 200, 300, 400, 500, 600);\r\n\r\n-- works as intended\r\nUNPIVOT monthly_sales\r\n    ON jan, feb, mar, apr, may, jun\r\n    INTO\r\n        NAME month\r\n        VALUE sales;\r\n\r\n-- complains about missing unnamed_subquery\r\nUNPIVOT (SELECT * FROM monthly_sales)\r\n    ON jan, feb, mar, apr, may, jun\r\n    INTO\r\n        NAME month\r\n        VALUE sales;\r\n```\n\n### OS:\n\nmacOS 13.1 (arm64)\n\n### DuckDB Version:\n\nv0.8.0 e8e4cea5ec\n\n### DuckDB Client:\n\nCLI\n\n### Full Name:\n\nJonathan Shi\n\n### Affiliation:\n\nPonder Data\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "\n",
  "created_at": "2023-06-07T07:59:04Z",
  "modified_files": [
    "src/planner/binder/tableref/bind_pivot.cpp"
  ],
  "modified_test_files": [
    "test/sql/pivot/test_unpivot.test"
  ]
}