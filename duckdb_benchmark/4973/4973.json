{
  "repo": "duckdb/duckdb",
  "pull_number": 4973,
  "instance_id": "duckdb__duckdb-4973",
  "issue_numbers": [
    "4965"
  ],
  "base_commit": "9913e0e80bba57ece3ad4275798d134d2bfef0aa",
  "patch": "diff --git a/src/function/scalar/date/date_diff.cpp b/src/function/scalar/date/date_diff.cpp\nindex d3808e1c25ff..491eda5781c3 100644\n--- a/src/function/scalar/date/date_diff.cpp\n+++ b/src/function/scalar/date/date_diff.cpp\n@@ -50,7 +50,7 @@ struct DateDiff {\n \tstruct DayOperator {\n \t\ttemplate <class TA, class TB, class TR>\n \t\tstatic inline TR Operation(TA startdate, TB enddate) {\n-\t\t\treturn Date::EpochDays(enddate) - Date::EpochDays(startdate);\n+\t\t\treturn TR(Date::EpochDays(enddate)) - TR(Date::EpochDays(startdate));\n \t\t}\n \t};\n \n",
  "test_patch": "diff --git a/test/sql/function/timestamp/date_diff.test_coverage b/test/sql/function/timestamp/date_diff.test_coverage\nindex 2b19b9a2e18e..1bb04bd3d91d 100644\n--- a/test/sql/function/timestamp/date_diff.test_coverage\n+++ b/test/sql/function/timestamp/date_diff.test_coverage\n@@ -103,6 +103,12 @@ endloop\n statement error\n SELECT datediff('microseconds',DATE '4151706-4-6',DATE '-5559461-6-26');\n \n+\n+query I\n+SELECT datediff('isodow',DATE '4765396-11-24',DATE '-4389735-12-13');\n+----\n+-3343842916\n+\n #\n # TIMESTAMP\n #\n",
  "problem_statement": "[Fuzzer] Date diff overflow 2\n### What happens?\n\nAs a follow-up to #4943. Run the following statement with UBSAN:\r\n```\r\nSELECT datediff('isodow',DATE '4765396-11-24',DATE '-4389735-12-13');\r\n```\r\n\r\nIt reports: src/function/scalar/date/date_diff.cpp:53:36: runtime error: signed integer overflow: -1604036967 - 1739805949 cannot be represented in type 'int'\n\n### To Reproduce\n\nRun the statement above.\n\n### OS:\n\nLinux\n\n### DuckDB Version:\n\nlatest from sources\n\n### DuckDB Client:\n\nShell\n\n### Full Name:\n\nPedro Ferreira\n\n### Affiliation:\n\nHuawei\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "Soon after I got this overflow:\r\n```\r\nSELECT datesub('week',TIMESTAMP '-214169-1-18 21:29:6',TIMESTAMP '93495-11-19 13:3:22');\r\n```\r\n\r\nsrc/function/scalar/date/date_sub.cpp:110:53: runtime error: signed integer overflow: 2888277915802000000 - -6820686527454000000 cannot be represented in type 'long'\nOne more :)\r\n```\r\nSELECT datesub('dayofyear',TIMESTAMP '-109502-12-4 20:26:13',TIMESTAMP '252823-4-6 9:56:28');\r\n```\r\n\r\nsrc/function/scalar/date/date_sub.cpp:102:53: runtime error: signed integer overflow: 7916164336588000000 - -3517687280027000000 cannot be represented in type 'long'\nOne more @hawkfish \r\n```\r\nSELECT datesub('epoch',TIMESTAMP '153520-4-1 20:33:43',TIMESTAMP '-269898-3-29 12:9:14');\r\n```\r\nsrc/function/scalar/date/date_sub.cpp:133:53: runtime error: signed integer overflow: -8579317866646000000 - 4782463936423000000 cannot be represented in type 'long'\r\n",
  "created_at": "2022-10-12T23:59:20Z",
  "modified_files": [
    "src/function/scalar/date/date_diff.cpp"
  ],
  "modified_test_files": [
    "test/sql/function/timestamp/date_diff.test_coverage"
  ]
}