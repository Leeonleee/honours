{
  "repo": "duckdb/duckdb",
  "pull_number": 14092,
  "instance_id": "duckdb__duckdb-14092",
  "issue_numbers": [
    "14077",
    "14077"
  ],
  "base_commit": "af39bd0dcf66876e09ac2a7c3baa28fe1b301151",
  "patch": "diff --git a/src/include/duckdb/storage/table/segment_tree.hpp b/src/include/duckdb/storage/table/segment_tree.hpp\nindex e267d2e351eb..218cdac9b16f 100644\n--- a/src/include/duckdb/storage/table/segment_tree.hpp\n+++ b/src/include/duckdb/storage/table/segment_tree.hpp\n@@ -145,6 +145,7 @@ class SegmentTree {\n \t\t}\n \t\tSegmentNode<T> node;\n \t\tsegment->index = nodes.size();\n+\t\tsegment->next = nullptr;\n \t\tnode.row_start = segment->start;\n \t\tnode.node = std::move(segment);\n \t\tnodes.push_back(std::move(node));\ndiff --git a/src/storage/table/row_group_collection.cpp b/src/storage/table/row_group_collection.cpp\nindex b0eb5022f75b..4dfb194921b6 100644\n--- a/src/storage/table/row_group_collection.cpp\n+++ b/src/storage/table/row_group_collection.cpp\n@@ -962,8 +962,8 @@ unique_ptr<CheckpointTask> RowGroupCollection::GetCheckpointTask(CollectionCheck\n }\n \n void RowGroupCollection::Checkpoint(TableDataWriter &writer, TableStatistics &global_stats) {\n-\tauto segments = row_groups->MoveSegments();\n \tauto l = row_groups->Lock();\n+\tauto segments = row_groups->MoveSegments(l);\n \n \tCollectionCheckpointState checkpoint_state(*this, writer, segments, global_stats);\n \n",
  "test_patch": "diff --git a/test/sql/storage/delete/delete_final_row_group.test b/test/sql/storage/delete/delete_final_row_group.test\nnew file mode 100644\nindex 000000000000..6dba3aca5923\n--- /dev/null\n+++ b/test/sql/storage/delete/delete_final_row_group.test\n@@ -0,0 +1,42 @@\n+# name: test/sql/storage/delete/delete_final_row_group.test\n+# description: Test deleting the final row groups of a table\n+# group: [delete]\n+\n+load __TEST_DIR__/delete_final_row_group.db\n+\n+statement ok\n+CREATE TABLE integers AS SELECT * FROM range(0, 10000000) t(i);\n+\n+query I\n+DELETE FROM integers WHERE i>=5000000\n+----\n+5000000\n+\n+query II\n+SELECT COUNT(*), SUM(i) FROM integers\n+----\n+5000000\t12499997500000\n+\n+\n+statement ok\n+ALTER TABLE integers ADD COLUMN j INTEGER\n+\n+query III\n+SELECT COUNT(*), SUM(i), SUM(j) FROM integers\n+----\n+5000000\t12499997500000\tNULL\n+\n+statement ok\n+UPDATE integers SET j=i+1\n+\n+query III\n+SELECT COUNT(*), SUM(i), SUM(j) FROM integers\n+----\n+5000000\t12499997500000\t12500002500000\n+\n+restart\n+\n+query III\n+SELECT COUNT(*), SUM(i), SUM(j) FROM integers\n+----\n+5000000\t12499997500000\t12500002500000\ndiff --git a/test/sqlite/sqllogic_command.cpp b/test/sqlite/sqllogic_command.cpp\nindex eb7636362900..527b91c6d115 100644\n--- a/test/sqlite/sqllogic_command.cpp\n+++ b/test/sqlite/sqllogic_command.cpp\n@@ -492,14 +492,6 @@ void UnzipCommand::ExecuteInternal(ExecuteContext &context) const {\n \t\tthrow CatalogException(\"Cannot open the file \\\"%s\\\"\", input_path);\n \t}\n \n-\t// read the compressed data from the file\n-\tint64_t file_size = vfs.GetFileSize(*compressed_file_handle);\n-\tstd::unique_ptr<char[]> compressed_buffer(new char[BUFFER_SIZE]);\n-\tint64_t bytes_read = vfs.Read(*compressed_file_handle, compressed_buffer.get(), BUFFER_SIZE);\n-\tif (bytes_read < file_size) {\n-\t\tthrow CatalogException(\"Cannot read the file \\\"%s\\\"\", input_path);\n-\t}\n-\n \t// output\n \tFileOpenFlags out_flags(FileOpenFlags::FILE_FLAGS_FILE_CREATE | FileOpenFlags::FILE_FLAGS_WRITE);\n \tauto output_file = vfs.OpenFile(extraction_path, out_flags);\n@@ -507,9 +499,15 @@ void UnzipCommand::ExecuteInternal(ExecuteContext &context) const {\n \t\tthrow CatalogException(\"Cannot open the file \\\"%s\\\"\", extraction_path);\n \t}\n \n-\tint64_t bytes_written = vfs.Write(*output_file, compressed_buffer.get(), BUFFER_SIZE);\n-\tif (bytes_written < file_size) {\n-\t\tthrow CatalogException(\"Cannot write the file \\\"%s\\\"\", extraction_path);\n+\t// read the compressed data from the file\n+\twhile (true) {\n+\t\tstd::unique_ptr<char[]> compressed_buffer(new char[BUFFER_SIZE]);\n+\t\tint64_t bytes_read = vfs.Read(*compressed_file_handle, compressed_buffer.get(), BUFFER_SIZE);\n+\t\tif (bytes_read == 0) {\n+\t\t\tbreak;\n+\t\t}\n+\n+\t\tvfs.Write(*output_file, compressed_buffer.get(), bytes_read);\n \t}\n }\n \n",
  "problem_statement": "Segmentation fault\n### What happens?\n\nSometimes a segmentation fault when DuckDB is backed by a file, in-memory it does not issue a seg fault.\r\n\r\nOut of 277 datasets, only 5 have this issue. With provided dataset, can always be reproduced.\r\n\r\n```\r\n(gdb) bt\r\n#0  0x0000555555775ed6 in std::__shared_ptr<duckdb::DataTableInfo, (__gnu_cxx::_Lock_policy)2>::get (this=0x29c) at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr_base.h:1667\r\n#1  0x00005555557688de in duckdb::shared_ptr<duckdb::DataTableInfo, true>::operator* (this=0x29c) at /home/skinkie/Sources/duckdb/src/include/duckdb/common/shared_ptr_ipp.hpp:196\r\n#2  0x000055555621bb98 in duckdb::RowGroupCollection::GetTableInfo (this=0x28c) at /home/skinkie/Sources/duckdb/src/include/duckdb/storage/table/row_group_collection.hpp:129\r\n#3  0x00005555561e5cc6 in duckdb::RowGroup::GetTableInfo (this=0x55555a7159e0) at /home/skinkie/Sources/duckdb/src/storage/table/row_group.cpp:135\r\n#4  0x00005555561e6c1a in duckdb::RowGroup::AddColumn (this=0x55555a7159e0, new_collection=..., new_column=..., executor=..., result=...) at /home/skinkie/Sources/duckdb/src/storage/table/row_group.cpp:305\r\n#5  0x00005555561f019a in duckdb::RowGroupCollection::AddColumn (this=0x55555a1ee9c0, context=..., new_column=..., default_executor=...) at /home/skinkie/Sources/duckdb/src/storage/table/row_group_collection.cpp:1066\r\n#6  0x0000555556279e05 in duckdb::DataTable::DataTable (this=0x55555a80eaf0, context=..., parent=..., new_column=..., default_value=...) at /home/skinkie/Sources/duckdb/src/storage/data_table.cpp:80\r\n#7  0x00005555557a16e8 in std::_Construct<duckdb::DataTable, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (__p=0x55555a80eaf0)\r\n    at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/stl_construct.h:119\r\n#8  0x000055555579c4e8 in std::allocator_traits<std::allocator<void> >::construct<duckdb::DataTable, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (__p=0x55555a80eaf0)\r\n    at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/alloc_traits.h:657\r\n#9  std::_Sp_counted_ptr_inplace<duckdb::DataTable, std::allocator<void>, (__gnu_cxx::_Lock_policy)2>::_Sp_counted_ptr_inplace<duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (\r\n    this=0x55555a80eae0, __a=...) at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr_base.h:607\r\n#10 0x00005555557974e8 in std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<duckdb::DataTable, std::allocator<void>, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (\r\n    this=0x7fffffffa588, __p=@0x7fffffffa580: 0x0, __a=...) at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr_base.h:969\r\n#11 0x00005555557916e2 in std::__shared_ptr<duckdb::DataTable, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<void>, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (\r\n    this=0x7fffffffa580, __tag=...) at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr_base.h:1713\r\n#12 0x0000555555788805 in std::shared_ptr<duckdb::DataTable>::shared_ptr<std::allocator<void>, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (this=0x7fffffffa580, __tag=...)\r\n    at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr.h:463\r\n#13 0x000055555577cb90 in std::make_shared<duckdb::DataTable, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> () at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr.h:1008\r\n#14 0x000055555576f1f0 in duckdb::make_shared_ptr<duckdb::DataTable, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> () at /home/skinkie/Sources/duckdb/src/include/duckdb/common/helper.hpp:73\r\n#15 0x0000555555753e98 in duckdb::DuckTableEntry::AddColumn (this=0x55555a196530, context=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog_entry/duck_table_entry.cpp:391\r\n#16 0x000055555575271e in duckdb::DuckTableEntry::AlterEntry (this=0x55555a196530, context=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog_entry/duck_table_entry.cpp:231\r\n#17 0x00005555557522bc in duckdb::DuckTableEntry::AlterEntry (this=0x55555a196530, transaction=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog_entry/duck_table_entry.cpp:184\r\n#18 0x00005555557b6bd8 in duckdb::CatalogSet::AlterEntry (this=0x55555a16be20, transaction=..., name=\"kv6_import\", alter_info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog_set.cpp:328\r\n#19 0x000055555574fcf9 in duckdb::DuckSchemaEntry::Alter (this=0x55555a16bd40, transaction=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog_entry/duck_schema_entry.cpp:291\r\n#20 0x00005555557b156a in duckdb::Catalog::Alter (this=0x55555a1704e0, transaction=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog.cpp:904\r\n#21 0x00005555557b176b in duckdb::Catalog::Alter (this=0x55555a1704e0, context=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog.cpp:912\r\n#22 0x00005555570b1ff5 in duckdb::PhysicalAlter::GetData (this=0x7fffdc5f55a0, context=..., chunk=..., input=...) at /home/skinkie/Sources/duckdb/src/execution/operator/schema/physical_alter.cpp:13\r\n#23 0x0000555555ff23af in duckdb::PipelineExecutor::GetData (this=0x55555a31e250, chunk=..., input=...) at /home/skinkie/Sources/duckdb/src/parallel/pipeline_executor.cpp:478\r\n#24 0x0000555555ff24a0 in duckdb::PipelineExecutor::FetchFromSource (this=0x55555a31e250, result=...) at /home/skinkie/Sources/duckdb/src/parallel/pipeline_executor.cpp:504\r\n#25 0x0000555555ff1268 in duckdb::PipelineExecutor::Execute (this=0x55555a31e250, max_chunks=50) at /home/skinkie/Sources/duckdb/src/parallel/pipeline_executor.cpp:204\r\n#26 0x0000555555fed597 in duckdb::PipelineTask::ExecuteTask (this=0x7fffdc15fff0, mode=duckdb::TaskExecutionMode::PROCESS_PARTIAL) at /home/skinkie/Sources/duckdb/src/parallel/pipeline.cpp:40\r\n#27 0x0000555555fe7c38 in duckdb::ExecutorTask::Execute (this=0x7fffdc15fff0, mode=duckdb::TaskExecutionMode::PROCESS_PARTIAL) at /home/skinkie/Sources/duckdb/src/parallel/executor_task.cpp:44\r\n#28 0x0000555555feb739 in duckdb::Executor::ExecuteTask (this=0x55555a173350, dry_run=false) at /home/skinkie/Sources/duckdb/src/parallel/executor.cpp:580\r\n#29 0x0000555555eab6d5 in duckdb::ClientContext::ExecuteTaskInternal (this=0x55555a16e960, lock=..., result=..., dry_run=false) at /home/skinkie/Sources/duckdb/src/main/client_context.cpp:557\r\n#30 0x0000555555ec66bd in duckdb::PendingQueryResult::ExecuteTaskInternal (this=0x55555a46b6d0, lock=...) at /home/skinkie/Sources/duckdb/src/main/pending_query_result.cpp:68\r\n#31 0x0000555555ec6751 in duckdb::PendingQueryResult::ExecuteInternal (this=0x55555a46b6d0, lock=...) at /home/skinkie/Sources/duckdb/src/main/pending_query_result.cpp:75\r\n#32 0x0000555555ec6905 in duckdb::PendingQueryResult::Execute (this=0x55555a46b6d0) at /home/skinkie/Sources/duckdb/src/main/pending_query_result.cpp:95\r\n#33 0x0000555555ec72be in duckdb::PreparedStatement::Execute (this=0x55555a4dd5b0, values=..., allow_stream_result=false) at /home/skinkie/Sources/duckdb/src/main/prepared_statement.cpp:85\r\n#34 0x00005555556b91da in duckdb_shell_sqlite3_print_duckbox (pStmt=0x7fffcc091870, max_rows=40, max_width=0, null_value=0x7fffffffc03c \"\", columnar=0)\r\n    at /home/skinkie/Sources/duckdb/tools/sqlite3_api_wrapper/sqlite3_api_wrapper.cpp:249\r\n#35 0x000055555568be00 in exec_prepared_stmt (pArg=0x7fffffffbf20, pStmt=0x7fffcc091870) at /home/skinkie/Sources/duckdb/tools/shell/shell.c:12752\r\n#36 0x000055555568cc4c in shell_exec (pArg=0x7fffffffbf20, zSql=0x55555a1ef160 \"alter table kv6_import add column trip_id varchar(16);\", pzErrMsg=0x7fffffffbdb0) at /home/skinkie/Sources/duckdb/tools/shell/shell.c:13087\r\n#37 0x0000555555699c79 in runOneSqlLine (p=0x7fffffffbf20, zSql=0x55555a1ef160 \"alter table kv6_import add column trip_id varchar(16);\", in=0x55555a31e000, startline=31) at /home/skinkie/Sources/duckdb/tools/shell/shell.c:19273\r\n#38 0x000055555569a16f in process_input (p=0x7fffffffbf20) at /home/skinkie/Sources/duckdb/tools/shell/shell.c:19384\r\n#39 0x000055555569a49a in process_sqliterc (p=0x7fffffffbf20, sqliterc_override=0x7fffffffd720 \"/tmp/script.sql\") at /home/skinkie/Sources/duckdb/tools/shell/shell.c:19505\r\n#40 0x000055555569b174 in main (argc=4, argv=0x7fffffffd258) at /home/skinkie/Sources/duckdb/tools/shell/shell.c:19951\r\n```\n\n### To Reproduce\n\n```sql\r\nDROP TABLE IF EXISTS kv6_import;\r\nDROP TABLE IF EXISTS tt_import;\r\n\r\nCREATE TABLE \"kv6_import\" (\r\n        \"receive\"                   TIMESTAMP     NOT NULL,\r\n        \"message\"                   TIMESTAMP     NOT NULL,\r\n        \"vehicle\"                   TIMESTAMP     NOT NULL,\r\n        \"messagetype\"               VARCHAR(10)   NOT NULL,\r\n        \"operatingday\"              DATE          NOT NULL,\r\n        \"dataownercode\"             VARCHAR(10)   NOT NULL,\r\n        \"lineplanningnumber\"        VARCHAR(10),\r\n        \"journeynumber\"             UINTEGER       NOT NULL,\r\n        \"reinforcementnumber\"       UTINYINT       NOT NULL,\r\n        \"userstopcode\"              VARCHAR(10),\r\n        \"passagesequencenumber\"     TINYINT,\r\n        \"distancesincelastuserstop\" INTEGER,\r\n        \"punctuality\"               INTEGER,\r\n        \"rd_x\"                      VARCHAR(11),\r\n        \"rd_y\"                      VARCHAR(11),\r\n        \"blockcode\"                 INTEGER,\r\n        \"vehiclenumber\"             SMALLINT,\r\n        \"wheelchairaccessible\"      VARCHAR(5),\r\n        \"source\"                    VARCHAR(10)   NOT NULL,\r\n        \"numberofcoaches\"           UTINYINT\r\n);\r\n\r\ncopy kv6_import from '/tmp/kv6-20240917.log' (DELIMITER ';');\r\n\r\ndelete from kv6_import where messagetype not in ('ARRIVAL', 'DEPARTURE');\r\n\r\nalter table kv6_import add column trip_id varchar(16);\r\n\r\nupdate kv6_import set trip_id = dataownercode || ':' || lineplanningnumber || ':' || journeynumber;\r\n\r\nCREATE TABLE \"tt_import\" (\r\n        \"operatingday\"          DATE          NOT NULL,\r\n        \"trip_id\"               VARCHAR(16)   NOT NULL,\r\n        \"pointorder\"            UTINYINT      NOT NULL,\r\n        \"passagesequencenumber\" UTINYINT      NOT NULL,\r\n        \"userstopcode\"          VARCHAR(10)   NOT NULL,\r\n        \"targetarrivaltime\"     VARCHAR(8)    NOT NULL,\r\n        \"targetdeparturetime\"   VARCHAR(8)    NOT NULL,\r\n        \"recordedarrivaltime\"   VARCHAR(8),\r\n        \"recordeddeparturetime\" VARCHAR(8)\r\n);\r\n\r\ncopy tt_import from '/tmp/transittimes.csv' (DELIMITER ',');\r\n\r\ndelete from tt_import where trip_id like 'DOEKSEN:%' or trip_id like 'WSF:%' or trip_id like 'IFF%' or trip_id like 'WPD%' or trip_id like 'TESO%';\r\n\r\nalter table tt_import drop column recordedarrivaltime;\r\nalter table tt_import drop column recordeddeparturetime;\r\n\r\nupdate kv6_import set trip_id = w.trip_id from (select tt_import.trip_id as trip_id, z.trip_id as kv6_trip_id, vehiclenumber from tt_import join (select trip_id, userstopcode, vehiclenumber from kv6_import join (select trip_id, min(receive) as receive from kv6_import where trip_id in (select trip_id from kv6_import where trip_id like 'ARR:%' and length(trip_id) = 13  except select trip_id from tt_import) group by trip_id) as y using (trip_id, receive)) as z using (userstopcode) where pointorder = 1 and tt_import.trip_id like z.trip_id[0:8] || '_' || z.trip_id[-5:]) as w where kv6_import.trip_id = kv6_trip_id and kv6_import.vehiclenumber = w.vehiclenumber;\r\n\r\ncopy (select tt_import.operatingday, tt_import.trip_id, x.reinforcementnumber, x.vehiclenumber, tt_import.userstopcode, tt_import.passagesequencenumber, tt_import.pointorder, tt_import.targetarrivaltime, tt_import.targetdeparturetime, x.arrival as recordedarrivaltime, x.departure as recordeddeparturetime from (select trip_id, reinforcementnumber, vehiclenumber, userstopcode, passagesequencenumber, max(a.receive) as arrival, max(b.receive) as departure from kv6_import as a full outer join kv6_import as b using (trip_id, reinforcementnumber, userstopcode, passagesequencenumber, vehiclenumber) where a.messagetype = 'ARRIVAL' and b.messagetype = 'DEPARTURE' group by trip_id, reinforcementnumber, userstopcode, passagesequencenumber, vehiclenumber) as x right join tt_import using (trip_id, userstopcode, passagesequencenumber) order by trip_id, reinforcementnumber, pointorder) to '/home/skinkie/arriva/volledig-20240917.csv.gz' header;\r\n```\r\n\r\nData:\r\nhttps://download.stefan.konink.de/duckdb/kv6-20240917.log.gz\r\nhttps://download.stefan.konink.de/duckdb/transittimes.csv.gz\r\n\n\n### OS:\n\nLinux\n\n### DuckDB Version:\n\nmain\n\n### DuckDB Client:\n\ncli\n\n### Hardware:\n\namd64\n\n### Full Name:\n\nStefan de Konink\n\n### Affiliation:\n\nStichting OpenGeo\n\n### What is the latest build you tested with? If possible, we recommend testing with the latest nightly build.\n\nI have tested with a source build\n\n### Did you include all relevant data sets for reproducing the issue?\n\nNo - Other reason (please specify in the issue body)\n\n### Did you include all code required to reproduce the issue?\n\n- [X] Yes, I have\n\n### Did you include all relevant configuration (e.g., CPU architecture, Python version, Linux distribution) to reproduce the issue?\n\n- [X] Yes, I have\nSegmentation fault\n### What happens?\n\nSometimes a segmentation fault when DuckDB is backed by a file, in-memory it does not issue a seg fault.\r\n\r\nOut of 277 datasets, only 5 have this issue. With provided dataset, can always be reproduced.\r\n\r\n```\r\n(gdb) bt\r\n#0  0x0000555555775ed6 in std::__shared_ptr<duckdb::DataTableInfo, (__gnu_cxx::_Lock_policy)2>::get (this=0x29c) at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr_base.h:1667\r\n#1  0x00005555557688de in duckdb::shared_ptr<duckdb::DataTableInfo, true>::operator* (this=0x29c) at /home/skinkie/Sources/duckdb/src/include/duckdb/common/shared_ptr_ipp.hpp:196\r\n#2  0x000055555621bb98 in duckdb::RowGroupCollection::GetTableInfo (this=0x28c) at /home/skinkie/Sources/duckdb/src/include/duckdb/storage/table/row_group_collection.hpp:129\r\n#3  0x00005555561e5cc6 in duckdb::RowGroup::GetTableInfo (this=0x55555a7159e0) at /home/skinkie/Sources/duckdb/src/storage/table/row_group.cpp:135\r\n#4  0x00005555561e6c1a in duckdb::RowGroup::AddColumn (this=0x55555a7159e0, new_collection=..., new_column=..., executor=..., result=...) at /home/skinkie/Sources/duckdb/src/storage/table/row_group.cpp:305\r\n#5  0x00005555561f019a in duckdb::RowGroupCollection::AddColumn (this=0x55555a1ee9c0, context=..., new_column=..., default_executor=...) at /home/skinkie/Sources/duckdb/src/storage/table/row_group_collection.cpp:1066\r\n#6  0x0000555556279e05 in duckdb::DataTable::DataTable (this=0x55555a80eaf0, context=..., parent=..., new_column=..., default_value=...) at /home/skinkie/Sources/duckdb/src/storage/data_table.cpp:80\r\n#7  0x00005555557a16e8 in std::_Construct<duckdb::DataTable, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (__p=0x55555a80eaf0)\r\n    at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/stl_construct.h:119\r\n#8  0x000055555579c4e8 in std::allocator_traits<std::allocator<void> >::construct<duckdb::DataTable, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (__p=0x55555a80eaf0)\r\n    at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/alloc_traits.h:657\r\n#9  std::_Sp_counted_ptr_inplace<duckdb::DataTable, std::allocator<void>, (__gnu_cxx::_Lock_policy)2>::_Sp_counted_ptr_inplace<duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (\r\n    this=0x55555a80eae0, __a=...) at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr_base.h:607\r\n#10 0x00005555557974e8 in std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<duckdb::DataTable, std::allocator<void>, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (\r\n    this=0x7fffffffa588, __p=@0x7fffffffa580: 0x0, __a=...) at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr_base.h:969\r\n#11 0x00005555557916e2 in std::__shared_ptr<duckdb::DataTable, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<void>, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (\r\n    this=0x7fffffffa580, __tag=...) at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr_base.h:1713\r\n#12 0x0000555555788805 in std::shared_ptr<duckdb::DataTable>::shared_ptr<std::allocator<void>, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> (this=0x7fffffffa580, __tag=...)\r\n    at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr.h:463\r\n#13 0x000055555577cb90 in std::make_shared<duckdb::DataTable, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> () at /usr/lib/gcc/x86_64-pc-linux-gnu/14/include/g++-v14/bits/shared_ptr.h:1008\r\n#14 0x000055555576f1f0 in duckdb::make_shared_ptr<duckdb::DataTable, duckdb::ClientContext&, duckdb::DataTable&, duckdb::ColumnDefinition&, duckdb::Expression&> () at /home/skinkie/Sources/duckdb/src/include/duckdb/common/helper.hpp:73\r\n#15 0x0000555555753e98 in duckdb::DuckTableEntry::AddColumn (this=0x55555a196530, context=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog_entry/duck_table_entry.cpp:391\r\n#16 0x000055555575271e in duckdb::DuckTableEntry::AlterEntry (this=0x55555a196530, context=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog_entry/duck_table_entry.cpp:231\r\n#17 0x00005555557522bc in duckdb::DuckTableEntry::AlterEntry (this=0x55555a196530, transaction=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog_entry/duck_table_entry.cpp:184\r\n#18 0x00005555557b6bd8 in duckdb::CatalogSet::AlterEntry (this=0x55555a16be20, transaction=..., name=\"kv6_import\", alter_info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog_set.cpp:328\r\n#19 0x000055555574fcf9 in duckdb::DuckSchemaEntry::Alter (this=0x55555a16bd40, transaction=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog_entry/duck_schema_entry.cpp:291\r\n#20 0x00005555557b156a in duckdb::Catalog::Alter (this=0x55555a1704e0, transaction=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog.cpp:904\r\n#21 0x00005555557b176b in duckdb::Catalog::Alter (this=0x55555a1704e0, context=..., info=...) at /home/skinkie/Sources/duckdb/src/catalog/catalog.cpp:912\r\n#22 0x00005555570b1ff5 in duckdb::PhysicalAlter::GetData (this=0x7fffdc5f55a0, context=..., chunk=..., input=...) at /home/skinkie/Sources/duckdb/src/execution/operator/schema/physical_alter.cpp:13\r\n#23 0x0000555555ff23af in duckdb::PipelineExecutor::GetData (this=0x55555a31e250, chunk=..., input=...) at /home/skinkie/Sources/duckdb/src/parallel/pipeline_executor.cpp:478\r\n#24 0x0000555555ff24a0 in duckdb::PipelineExecutor::FetchFromSource (this=0x55555a31e250, result=...) at /home/skinkie/Sources/duckdb/src/parallel/pipeline_executor.cpp:504\r\n#25 0x0000555555ff1268 in duckdb::PipelineExecutor::Execute (this=0x55555a31e250, max_chunks=50) at /home/skinkie/Sources/duckdb/src/parallel/pipeline_executor.cpp:204\r\n#26 0x0000555555fed597 in duckdb::PipelineTask::ExecuteTask (this=0x7fffdc15fff0, mode=duckdb::TaskExecutionMode::PROCESS_PARTIAL) at /home/skinkie/Sources/duckdb/src/parallel/pipeline.cpp:40\r\n#27 0x0000555555fe7c38 in duckdb::ExecutorTask::Execute (this=0x7fffdc15fff0, mode=duckdb::TaskExecutionMode::PROCESS_PARTIAL) at /home/skinkie/Sources/duckdb/src/parallel/executor_task.cpp:44\r\n#28 0x0000555555feb739 in duckdb::Executor::ExecuteTask (this=0x55555a173350, dry_run=false) at /home/skinkie/Sources/duckdb/src/parallel/executor.cpp:580\r\n#29 0x0000555555eab6d5 in duckdb::ClientContext::ExecuteTaskInternal (this=0x55555a16e960, lock=..., result=..., dry_run=false) at /home/skinkie/Sources/duckdb/src/main/client_context.cpp:557\r\n#30 0x0000555555ec66bd in duckdb::PendingQueryResult::ExecuteTaskInternal (this=0x55555a46b6d0, lock=...) at /home/skinkie/Sources/duckdb/src/main/pending_query_result.cpp:68\r\n#31 0x0000555555ec6751 in duckdb::PendingQueryResult::ExecuteInternal (this=0x55555a46b6d0, lock=...) at /home/skinkie/Sources/duckdb/src/main/pending_query_result.cpp:75\r\n#32 0x0000555555ec6905 in duckdb::PendingQueryResult::Execute (this=0x55555a46b6d0) at /home/skinkie/Sources/duckdb/src/main/pending_query_result.cpp:95\r\n#33 0x0000555555ec72be in duckdb::PreparedStatement::Execute (this=0x55555a4dd5b0, values=..., allow_stream_result=false) at /home/skinkie/Sources/duckdb/src/main/prepared_statement.cpp:85\r\n#34 0x00005555556b91da in duckdb_shell_sqlite3_print_duckbox (pStmt=0x7fffcc091870, max_rows=40, max_width=0, null_value=0x7fffffffc03c \"\", columnar=0)\r\n    at /home/skinkie/Sources/duckdb/tools/sqlite3_api_wrapper/sqlite3_api_wrapper.cpp:249\r\n#35 0x000055555568be00 in exec_prepared_stmt (pArg=0x7fffffffbf20, pStmt=0x7fffcc091870) at /home/skinkie/Sources/duckdb/tools/shell/shell.c:12752\r\n#36 0x000055555568cc4c in shell_exec (pArg=0x7fffffffbf20, zSql=0x55555a1ef160 \"alter table kv6_import add column trip_id varchar(16);\", pzErrMsg=0x7fffffffbdb0) at /home/skinkie/Sources/duckdb/tools/shell/shell.c:13087\r\n#37 0x0000555555699c79 in runOneSqlLine (p=0x7fffffffbf20, zSql=0x55555a1ef160 \"alter table kv6_import add column trip_id varchar(16);\", in=0x55555a31e000, startline=31) at /home/skinkie/Sources/duckdb/tools/shell/shell.c:19273\r\n#38 0x000055555569a16f in process_input (p=0x7fffffffbf20) at /home/skinkie/Sources/duckdb/tools/shell/shell.c:19384\r\n#39 0x000055555569a49a in process_sqliterc (p=0x7fffffffbf20, sqliterc_override=0x7fffffffd720 \"/tmp/script.sql\") at /home/skinkie/Sources/duckdb/tools/shell/shell.c:19505\r\n#40 0x000055555569b174 in main (argc=4, argv=0x7fffffffd258) at /home/skinkie/Sources/duckdb/tools/shell/shell.c:19951\r\n```\n\n### To Reproduce\n\n```sql\r\nDROP TABLE IF EXISTS kv6_import;\r\nDROP TABLE IF EXISTS tt_import;\r\n\r\nCREATE TABLE \"kv6_import\" (\r\n        \"receive\"                   TIMESTAMP     NOT NULL,\r\n        \"message\"                   TIMESTAMP     NOT NULL,\r\n        \"vehicle\"                   TIMESTAMP     NOT NULL,\r\n        \"messagetype\"               VARCHAR(10)   NOT NULL,\r\n        \"operatingday\"              DATE          NOT NULL,\r\n        \"dataownercode\"             VARCHAR(10)   NOT NULL,\r\n        \"lineplanningnumber\"        VARCHAR(10),\r\n        \"journeynumber\"             UINTEGER       NOT NULL,\r\n        \"reinforcementnumber\"       UTINYINT       NOT NULL,\r\n        \"userstopcode\"              VARCHAR(10),\r\n        \"passagesequencenumber\"     TINYINT,\r\n        \"distancesincelastuserstop\" INTEGER,\r\n        \"punctuality\"               INTEGER,\r\n        \"rd_x\"                      VARCHAR(11),\r\n        \"rd_y\"                      VARCHAR(11),\r\n        \"blockcode\"                 INTEGER,\r\n        \"vehiclenumber\"             SMALLINT,\r\n        \"wheelchairaccessible\"      VARCHAR(5),\r\n        \"source\"                    VARCHAR(10)   NOT NULL,\r\n        \"numberofcoaches\"           UTINYINT\r\n);\r\n\r\ncopy kv6_import from '/tmp/kv6-20240917.log' (DELIMITER ';');\r\n\r\ndelete from kv6_import where messagetype not in ('ARRIVAL', 'DEPARTURE');\r\n\r\nalter table kv6_import add column trip_id varchar(16);\r\n\r\nupdate kv6_import set trip_id = dataownercode || ':' || lineplanningnumber || ':' || journeynumber;\r\n\r\nCREATE TABLE \"tt_import\" (\r\n        \"operatingday\"          DATE          NOT NULL,\r\n        \"trip_id\"               VARCHAR(16)   NOT NULL,\r\n        \"pointorder\"            UTINYINT      NOT NULL,\r\n        \"passagesequencenumber\" UTINYINT      NOT NULL,\r\n        \"userstopcode\"          VARCHAR(10)   NOT NULL,\r\n        \"targetarrivaltime\"     VARCHAR(8)    NOT NULL,\r\n        \"targetdeparturetime\"   VARCHAR(8)    NOT NULL,\r\n        \"recordedarrivaltime\"   VARCHAR(8),\r\n        \"recordeddeparturetime\" VARCHAR(8)\r\n);\r\n\r\ncopy tt_import from '/tmp/transittimes.csv' (DELIMITER ',');\r\n\r\ndelete from tt_import where trip_id like 'DOEKSEN:%' or trip_id like 'WSF:%' or trip_id like 'IFF%' or trip_id like 'WPD%' or trip_id like 'TESO%';\r\n\r\nalter table tt_import drop column recordedarrivaltime;\r\nalter table tt_import drop column recordeddeparturetime;\r\n\r\nupdate kv6_import set trip_id = w.trip_id from (select tt_import.trip_id as trip_id, z.trip_id as kv6_trip_id, vehiclenumber from tt_import join (select trip_id, userstopcode, vehiclenumber from kv6_import join (select trip_id, min(receive) as receive from kv6_import where trip_id in (select trip_id from kv6_import where trip_id like 'ARR:%' and length(trip_id) = 13  except select trip_id from tt_import) group by trip_id) as y using (trip_id, receive)) as z using (userstopcode) where pointorder = 1 and tt_import.trip_id like z.trip_id[0:8] || '_' || z.trip_id[-5:]) as w where kv6_import.trip_id = kv6_trip_id and kv6_import.vehiclenumber = w.vehiclenumber;\r\n\r\ncopy (select tt_import.operatingday, tt_import.trip_id, x.reinforcementnumber, x.vehiclenumber, tt_import.userstopcode, tt_import.passagesequencenumber, tt_import.pointorder, tt_import.targetarrivaltime, tt_import.targetdeparturetime, x.arrival as recordedarrivaltime, x.departure as recordeddeparturetime from (select trip_id, reinforcementnumber, vehiclenumber, userstopcode, passagesequencenumber, max(a.receive) as arrival, max(b.receive) as departure from kv6_import as a full outer join kv6_import as b using (trip_id, reinforcementnumber, userstopcode, passagesequencenumber, vehiclenumber) where a.messagetype = 'ARRIVAL' and b.messagetype = 'DEPARTURE' group by trip_id, reinforcementnumber, userstopcode, passagesequencenumber, vehiclenumber) as x right join tt_import using (trip_id, userstopcode, passagesequencenumber) order by trip_id, reinforcementnumber, pointorder) to '/home/skinkie/arriva/volledig-20240917.csv.gz' header;\r\n```\r\n\r\nData:\r\nhttps://download.stefan.konink.de/duckdb/kv6-20240917.log.gz\r\nhttps://download.stefan.konink.de/duckdb/transittimes.csv.gz\r\n\n\n### OS:\n\nLinux\n\n### DuckDB Version:\n\nmain\n\n### DuckDB Client:\n\ncli\n\n### Hardware:\n\namd64\n\n### Full Name:\n\nStefan de Konink\n\n### Affiliation:\n\nStichting OpenGeo\n\n### What is the latest build you tested with? If possible, we recommend testing with the latest nightly build.\n\nI have tested with a source build\n\n### Did you include all relevant data sets for reproducing the issue?\n\nNo - Other reason (please specify in the issue body)\n\n### Did you include all code required to reproduce the issue?\n\n- [X] Yes, I have\n\n### Did you include all relevant configuration (e.g., CPU architecture, Python version, Linux distribution) to reproduce the issue?\n\n- [X] Yes, I have\n",
  "hints_text": "Thanks for the report and the reproducible example, I can confirm that this crashes.\nThanks for the report and the reproducible example, I can confirm that this crashes.",
  "created_at": "2024-09-24T11:32:53Z"
}