{
  "repo": "duckdb/duckdb",
  "pull_number": 3359,
  "instance_id": "duckdb__duckdb-3359",
  "issue_numbers": [
    "3353",
    "3353"
  ],
  "base_commit": "7c5ba6c0e1521a76a6644a4525dd6f393215baed",
  "patch": "diff --git a/tools/sqlite3_api_wrapper/sqlite3_api_wrapper.cpp b/tools/sqlite3_api_wrapper/sqlite3_api_wrapper.cpp\nindex 92a81297d1fb..70ea23c16af9 100644\n--- a/tools/sqlite3_api_wrapper/sqlite3_api_wrapper.cpp\n+++ b/tools/sqlite3_api_wrapper/sqlite3_api_wrapper.cpp\n@@ -234,7 +234,7 @@ int sqlite3_step(sqlite3_stmt *pStmt) {\n \t\tpStmt->current_row = -1;\n \n \t\tauto statement_type = pStmt->prepared->GetStatementType();\n-\t\tif (StatementTypeReturnChanges(statement_type) && pStmt->current_chunk->size() > 0) {\n+\t\tif (StatementTypeReturnChanges(statement_type) && pStmt->current_chunk && pStmt->current_chunk->size() > 0) {\n \t\t\t// update total changes\n \t\t\tauto row_changes = pStmt->current_chunk->GetValue(0, 0);\n \t\t\tif (!row_changes.IsNull() && row_changes.TryCastAs(LogicalType::BIGINT)) {\n",
  "test_patch": "diff --git a/test/issues/fuzz/sqlite_wrapper_crash.test b/test/issues/fuzz/sqlite_wrapper_crash.test\nnew file mode 100644\nindex 000000000000..272fa593b9a1\n--- /dev/null\n+++ b/test/issues/fuzz/sqlite_wrapper_crash.test\n@@ -0,0 +1,14 @@\n+# name: test/issues/fuzz/sqlite_wrapper_crash.test\n+# description: Issue #3353: NullPointer at sqlite3_api_wrapper.cpp:237:75\n+# group: [fuzz]\n+\n+statement ok\n+PRAGMA enable_verification\n+\n+statement ok\n+CREATE TABLE strings (a INTEGER DEFAULT -1, b INTEGER DEFAULT -2, t0 INTEGER DEFAULT -3);\n+\n+statement ok\n+DELETE FROM strings\n+WHERE b IN (SELECT sum(a) FROM strings GROUP BY b)\n+RETURNING *;\n",
  "problem_statement": "NullPointer at sqlite3_api_wrapper.cpp:237:75\n#### What happens?\r\nNullPointer at sqlite3_api_wrapper.cpp:237:75\r\n\r\n#### To Reproduce\r\n```sql\r\nCREATE TABLE strings (a INTEGER DEFAULT -1, b INTEGER DEFAULT -2, t0 INTEGER DEFAULT -3);\r\nDELETE FROM strings\r\nWHERE b IN (SELECT sum(a) FROM strings GROUP BY b)\r\nRETURNING *;\r\n```\r\n\r\n#### Environment (please complete the following information):\r\n - OS: linux\r\n - DuckDB Version: v0.3.3-dev1395 80ae1e12d\r\n - DuckDB Client: /usr/local/bin/duckdb\r\n\r\n#### Before Submitting\r\n\r\n- [x] **Have you tried this on the latest `master` branch?**\r\n* **Python**: `pip install duckdb --upgrade --pre`\r\n* **R**: `install.packages(\"https://github.com/duckdb/duckdb/releases/download/master-builds/duckdb_r_src.tar.gz\", repos = NULL)`\r\n* **Other Platforms**: You can find binaries [here](https://github.com/duckdb/duckdb/releases/tag/master-builds) or compile from source.\r\n\r\n- [x] **Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?**\r\n\r\n#### UBSAN detail\r\n```\r\n/root/duckdb/tools/sqlite3_api_wrapper/sqlite3_api_wrapper.cpp:237:75: runtime error: member call on null pointer of type 'duckdb::DataChunk'\r\nSUMMARY: UndefinedBehaviorSanitizer: undefined-behavior /root/duckdb/tools/sqlite3_api_wrapper/sqlite3_api_wrapper.cpp:237:75 in \r\n```\nNullPointer at sqlite3_api_wrapper.cpp:237:75\n#### What happens?\r\nNullPointer at sqlite3_api_wrapper.cpp:237:75\r\n\r\n#### To Reproduce\r\n```sql\r\nCREATE TABLE strings (a INTEGER DEFAULT -1, b INTEGER DEFAULT -2, t0 INTEGER DEFAULT -3);\r\nDELETE FROM strings\r\nWHERE b IN (SELECT sum(a) FROM strings GROUP BY b)\r\nRETURNING *;\r\n```\r\n\r\n#### Environment (please complete the following information):\r\n - OS: linux\r\n - DuckDB Version: v0.3.3-dev1395 80ae1e12d\r\n - DuckDB Client: /usr/local/bin/duckdb\r\n\r\n#### Before Submitting\r\n\r\n- [x] **Have you tried this on the latest `master` branch?**\r\n* **Python**: `pip install duckdb --upgrade --pre`\r\n* **R**: `install.packages(\"https://github.com/duckdb/duckdb/releases/download/master-builds/duckdb_r_src.tar.gz\", repos = NULL)`\r\n* **Other Platforms**: You can find binaries [here](https://github.com/duckdb/duckdb/releases/tag/master-builds) or compile from source.\r\n\r\n- [x] **Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?**\r\n\r\n#### UBSAN detail\r\n```\r\n/root/duckdb/tools/sqlite3_api_wrapper/sqlite3_api_wrapper.cpp:237:75: runtime error: member call on null pointer of type 'duckdb::DataChunk'\r\nSUMMARY: UndefinedBehaviorSanitizer: undefined-behavior /root/duckdb/tools/sqlite3_api_wrapper/sqlite3_api_wrapper.cpp:237:75 in \r\n```\n",
  "hints_text": "\n",
  "created_at": "2022-04-02T12:59:36Z"
}