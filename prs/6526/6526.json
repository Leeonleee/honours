{
  "repo": "duckdb/duckdb",
  "pull_number": 6526,
  "instance_id": "duckdb__duckdb-6526",
  "issue_numbers": [
    "6509"
  ],
  "base_commit": "c817201fa84f8d01289d0c327e07db4a2cc8894e",
  "patch": "diff --git a/tools/rpkg/inst/include/cpp11/external_pointer.hpp b/tools/rpkg/inst/include/cpp11/external_pointer.hpp\nindex c9348cb37131..ca85adcdf88e 100644\n--- a/tools/rpkg/inst/include/cpp11/external_pointer.hpp\n+++ b/tools/rpkg/inst/include/cpp11/external_pointer.hpp\n@@ -68,9 +68,15 @@ class external_pointer {\n     data_ = safe[Rf_shallow_duplicate](rhs.data_);\n   }\n \n-  external_pointer(external_pointer&& rhs) { reset(rhs.release()); }\n+  external_pointer(external_pointer&& rhs) {\n+    data_ = rhs.data_;\n+    rhs.data_ = R_NilValue;\n+  }\n \n-  external_pointer& operator=(external_pointer&& rhs) noexcept { reset(rhs.release()); }\n+  external_pointer& operator=(external_pointer&& rhs) noexcept {\n+    data_ = rhs.data_;\n+    rhs.data_ = R_NilValue;\n+  }\n \n   external_pointer& operator=(std::nullptr_t) noexcept { reset(); };\n \ndiff --git a/tools/rpkg/src/relational.cpp b/tools/rpkg/src/relational.cpp\nindex 9b67a0978185..8baa32eacd0d 100644\n--- a/tools/rpkg/src/relational.cpp\n+++ b/tools/rpkg/src/relational.cpp\n@@ -30,14 +30,14 @@ template <typename T, typename... ARGS>\n external_pointer<T> make_external(const string &rclass, ARGS &&... args) {\n \tauto extptr = external_pointer<T>(new T(std::forward<ARGS>(args)...));\n \t((sexp)extptr).attr(\"class\") = rclass;\n-\treturn (extptr);\n+\treturn extptr;\n }\n \n template <typename T, typename... ARGS>\n external_pointer<T> make_external_prot(const string &rclass, SEXP prot, ARGS &&... args) {\n \tauto extptr = external_pointer<T>(new T(std::forward<ARGS>(args)...), true, true, prot);\n \t((sexp)extptr).attr(\"class\") = rclass;\n-\treturn (extptr);\n+\treturn extptr;\n }\n \n // DuckDB Expressions\n",
  "test_patch": "diff --git a/tools/rpkg/tests/testthat/test_relational.R b/tools/rpkg/tests/testthat/test_relational.R\nindex 707c133612fe..634c0ac0cda2 100644\n--- a/tools/rpkg/tests/testthat/test_relational.R\n+++ b/tools/rpkg/tests/testthat/test_relational.R\n@@ -1,12 +1,12 @@\n-library(\"DBI\")\n-library(\"testthat\")\n+# Run this file with testthat::test_local(filter = \"^relational$\")\n \n con <- dbConnect(duckdb())\n on.exit(dbDisconnect(con, shutdown = TRUE))\n \n test_that(\"we can create a relation from a df\", {\n-  rel_from_df(con, mtcars)\n-  expect_true(TRUE)\n+  rel <- rel_from_df(con, mtcars)\n+  expect_type(rel, \"externalptr\")\n+  expect_s3_class(rel, \"duckdb_relation\")\n })\n \n test_that(\"we won't crash when creating a relation from odd things\", {\n",
  "problem_statement": "R: Support for classed external pointers varies across platforms\n### What happens?\n\nRun into a major WAT a few minutes ago: code behaving differently across platforms, a thing almost unheard of in the R world.\r\n\r\nThe `\"class\"` attribute for external pointers is preserved on macOS, but not on Linux (Ubuntu).\r\n\r\nWe don't necessarily need to fix here, but we could. Because we can't assume that this class attribute is retained, we have two options:\r\n\r\n1. avoid adding the `\"class\"` attribute to external pointers to never rely on it\r\n2. always wrap external pointers in a list, which then can have a `\"class\"`\r\n\r\nWe can easily do any of those options because the `rel_...()` functions aren't exported yet. \ud83e\uddd0 \r\n\r\nI'm slightly in favor of the second option. @hannes: do you have a preference?\n\n### To Reproduce\n\n## Ubuntu\r\n\r\n``` r\r\ncon <- DBI::dbConnect(duckdb::duckdb())\r\ndf <- data.frame(a = 1)\r\nduckdb:::rel_from_df(con, df)\r\n#> <pointer: 0x561d4dea5d10>\r\n#> attr(,\"df\")\r\n#>   a\r\n#> 1 1\r\n```\r\n\r\n<sup>Created on 2023-03-01 with [reprex v2.0.2](https://reprex.tidyverse.org)</sup>\r\n\r\n<details style=\"margin-bottom:10px;\">\r\n\r\n<summary>Session info</summary>\r\n\r\n``` r\r\nsessioninfo::session_info()\r\n#> \u2500 Session info \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n#>  setting  value\r\n#>  version  R version 4.2.2 (2022-10-31)\r\n#>  os       Ubuntu 20.04.5 LTS\r\n#>  system   x86_64, linux-gnu\r\n#>  ui       X11\r\n#>  language (EN)\r\n#>  collate  en_US.UTF-8\r\n#>  ctype    en_US.UTF-8\r\n#>  tz       Etc/UTC\r\n#>  date     2023-03-01\r\n#>  pandoc   2.5 @ /usr/bin/ (via rmarkdown)\r\n#> \r\n#> \u2500 Packages \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n#>  package     * version date (UTC) lib source\r\n#>  cli           3.6.0   2023-01-09 [1] RSPM\r\n#>  DBI           1.1.3   2022-06-18 [1] RSPM\r\n#>  digest        0.6.31  2022-12-11 [1] RSPM\r\n#>  duckdb        0.7.0   2023-03-01 [1] local\r\n#>  evaluate      0.20    2023-01-17 [1] RSPM\r\n#>  fastmap       1.1.1   2023-02-24 [1] RSPM\r\n#>  fs            1.6.1   2023-02-06 [1] RSPM\r\n#>  glue          1.6.2   2022-02-24 [1] RSPM\r\n#>  htmltools     0.5.4   2022-12-07 [1] RSPM\r\n#>  knitr         1.42    2023-01-25 [1] RSPM\r\n#>  lifecycle     1.0.3   2022-10-07 [1] RSPM\r\n#>  magrittr      2.0.3   2022-03-30 [1] RSPM\r\n#>  purrr         1.0.1   2023-01-10 [1] RSPM\r\n#>  R.cache       0.16.0  2022-07-21 [1] RSPM\r\n#>  R.methodsS3   1.8.2   2022-06-13 [1] RSPM\r\n#>  R.oo          1.25.0  2022-06-12 [1] RSPM\r\n#>  R.utils       2.12.2  2022-11-11 [1] RSPM\r\n#>  reprex        2.0.2   2022-08-17 [1] RSPM\r\n#>  rlang         1.0.6   2022-09-24 [1] RSPM\r\n#>  rmarkdown     2.20    2023-01-19 [1] RSPM\r\n#>  sessioninfo   1.2.2   2021-12-06 [1] RSPM\r\n#>  styler        1.9.0   2023-01-15 [1] RSPM\r\n#>  vctrs         0.5.2   2023-01-23 [1] RSPM\r\n#>  withr         2.5.0   2022-03-03 [1] RSPM\r\n#>  xfun          0.37    2023-01-31 [1] RSPM\r\n#>  yaml          2.3.7   2023-01-23 [1] RSPM\r\n#> \r\n#>  [1] /home/gitpod/R/x86_64-pc-linux-gnu-library/4.2\r\n#>  [2] /opt/R/4.2.2/lib/R/library\r\n#> \r\n#> \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n```\r\n\r\n</details>\r\n\r\n## macOS\r\n\r\n``` r\r\ncon <- DBI::dbConnect(duckdb::duckdb())\r\ndf <- data.frame(a = 1)\r\nduckdb:::rel_from_df(con, df)\r\n#> DuckDB Relation: \r\n#> ---------------------\r\n#> --- Relation Tree ---\r\n#> ---------------------\r\n#> r_dataframe_scan(0x141644310)\r\n#> \r\n#> ---------------------\r\n#> -- Result Columns  --\r\n#> ---------------------\r\n#> - a (DOUBLE)\r\n```\r\n\r\n<sup>Created on 2023-03-01 with [reprex v2.0.2](https://reprex.tidyverse.org)</sup>\r\n\r\n<details style=\"margin-bottom:10px;\">\r\n<summary>\r\nSession info\r\n</summary>\r\n\r\n``` r\r\nsessioninfo::session_info()\r\n#> \u2500 Session info \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n#>  setting  value\r\n#>  version  R version 4.2.2 (2022-10-31)\r\n#>  os       macOS Ventura 13.1\r\n#>  system   aarch64, darwin20\r\n#>  ui       X11\r\n#>  language (EN)\r\n#>  collate  en_US.UTF-8\r\n#>  ctype    en_US.UTF-8\r\n#>  tz       Europe/Zurich\r\n#>  date     2023-03-01\r\n#>  pandoc   2.19.2 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/ (via rmarkdown)\r\n#> \r\n#> \u2500 Packages \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n#>  package     * version date (UTC) lib source\r\n#>  cli           3.6.0   2023-01-09 [1] CRAN (R 4.2.0)\r\n#>  DBI           1.1.3   2022-06-18 [1] CRAN (R 4.2.0)\r\n#>  digest        0.6.31  2022-12-11 [1] CRAN (R 4.2.0)\r\n#>  duckdb        0.7.0   2023-03-01 [1] local\r\n#>  evaluate      0.20    2023-01-17 [1] CRAN (R 4.2.0)\r\n#>  fastmap       1.1.0   2021-01-25 [1] CRAN (R 4.2.0)\r\n#>  fs            1.6.1   2023-02-06 [1] CRAN (R 4.2.0)\r\n#>  glue          1.6.2   2022-02-24 [1] CRAN (R 4.2.0)\r\n#>  htmltools     0.5.4   2022-12-07 [1] CRAN (R 4.2.0)\r\n#>  knitr         1.42    2023-01-25 [1] CRAN (R 4.2.0)\r\n#>  lifecycle     1.0.3   2022-10-07 [1] CRAN (R 4.2.0)\r\n#>  magrittr      2.0.3   2022-03-30 [1] CRAN (R 4.2.0)\r\n#>  purrr         1.0.1   2023-01-10 [1] CRAN (R 4.2.0)\r\n#>  R.cache       0.16.0  2022-07-21 [1] CRAN (R 4.2.0)\r\n#>  R.methodsS3   1.8.2   2022-06-13 [1] CRAN (R 4.2.0)\r\n#>  R.oo          1.25.0  2022-06-12 [1] CRAN (R 4.2.0)\r\n#>  R.utils       2.12.2  2022-11-11 [1] CRAN (R 4.2.0)\r\n#>  reprex        2.0.2   2022-08-17 [1] CRAN (R 4.2.0)\r\n#>  rlang         1.0.6   2022-09-24 [1] CRAN (R 4.2.0)\r\n#>  rmarkdown     2.20    2023-01-19 [1] CRAN (R 4.2.0)\r\n#>  rstudioapi    0.14    2022-08-22 [1] CRAN (R 4.2.0)\r\n#>  sessioninfo   1.2.2   2021-12-06 [1] CRAN (R 4.2.0)\r\n#>  styler        1.9.0   2023-01-15 [1] CRAN (R 4.2.0)\r\n#>  vctrs         0.5.2   2023-01-23 [1] CRAN (R 4.2.0)\r\n#>  withr         2.5.0   2022-03-03 [1] CRAN (R 4.2.0)\r\n#>  xfun          0.37    2023-01-31 [1] CRAN (R 4.2.0)\r\n#>  yaml          2.3.7   2023-01-23 [1] CRAN (R 4.2.0)\r\n#> \r\n#>  [1] /Users/kirill/Library/R/arm64/4.2/library\r\n#>  [2] /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library\r\n#> \r\n#> \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n```\r\n\r\n</details>\n\n### OS:\n\nUbuntu 20.04 arm64, macOS aarch64\n\n### DuckDB Version:\n\nc817201fa84f8d01289d0c327e07db4a2cc8894e\n\n### DuckDB Client:\n\nR\n\n### Full Name:\n\nKirill M\u00fcller\n\n### Affiliation:\n\ncynkra GmbH\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "Fine with a list but perhaps we should open an issue in R-core as well.",
  "created_at": "2023-03-02T06:16:26Z"
}