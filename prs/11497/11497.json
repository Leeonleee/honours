{
  "repo": "duckdb/duckdb",
  "pull_number": 11497,
  "instance_id": "duckdb__duckdb-11497",
  "issue_numbers": [
    "11445",
    "11445"
  ],
  "base_commit": "dfaac6862994c4775369f1472cf748ff139ad5ee",
  "patch": "diff --git a/src/include/duckdb/planner/query_node/bound_select_node.hpp b/src/include/duckdb/planner/query_node/bound_select_node.hpp\nindex af16afc501c3..0bab35cacb1e 100644\n--- a/src/include/duckdb/planner/query_node/bound_select_node.hpp\n+++ b/src/include/duckdb/planner/query_node/bound_select_node.hpp\n@@ -62,6 +62,8 @@ class BoundSelectNode : public BoundQueryNode {\n \n \t//! The amount of columns in the final result\n \tidx_t column_count;\n+\t//! The amount of bound columns in the select list\n+\tidx_t bound_column_count = 0;\n \n \t//! Index used by the LogicalProjection\n \tidx_t projection_index;\ndiff --git a/src/planner/binder/query_node/bind_select_node.cpp b/src/planner/binder/query_node/bind_select_node.cpp\nindex accd54a27642..568237abbda1 100644\n--- a/src/planner/binder/query_node/bind_select_node.cpp\n+++ b/src/planner/binder/query_node/bind_select_node.cpp\n@@ -506,6 +506,7 @@ unique_ptr<BoundQueryNode> Binder::BindSelectNode(SelectNode &statement, unique_\n \t\tbool is_original_column = i < result->column_count;\n \t\tbool can_group_by_all =\n \t\t    statement.aggregate_handling == AggregateHandling::FORCE_AGGREGATES && is_original_column;\n+\t\tresult->bound_column_count++;\n \n \t\tif (select_binder.HasExpandedExpressions()) {\n \t\t\tif (!is_original_column) {\ndiff --git a/src/planner/expression_binder/base_select_binder.cpp b/src/planner/expression_binder/base_select_binder.cpp\nindex b4708561e2a8..76c472a4aa69 100644\n--- a/src/planner/expression_binder/base_select_binder.cpp\n+++ b/src/planner/expression_binder/base_select_binder.cpp\n@@ -83,7 +83,7 @@ BindResult BaseSelectBinder::BindColumnRef(unique_ptr<ParsedExpression> &expr_pt\n \t\tif (alias_entry != alias_map.end()) {\n \t\t\t// found entry!\n \t\t\tauto index = alias_entry->second;\n-\t\t\tif (index >= node.select_list.size()) {\n+\t\t\tif (index >= node.bound_column_count) {\n \t\t\t\tthrow BinderException(\"Column \\\"%s\\\" referenced that exists in the SELECT clause - but this column \"\n \t\t\t\t                      \"cannot be referenced before it is defined\",\n \t\t\t\t                      colref.column_names[0]);\n",
  "test_patch": "diff --git a/test/sql/types/struct/struct_unnest_recursion.test b/test/sql/types/struct/struct_unnest_recursion.test\nnew file mode 100644\nindex 000000000000..4078abc470e7\n--- /dev/null\n+++ b/test/sql/types/struct/struct_unnest_recursion.test\n@@ -0,0 +1,22 @@\n+# name: test/sql/types/struct/struct_unnest_recursion.test\n+# description: Test struct unnest recursion\n+# group: [struct]\n+\n+statement ok\n+PRAGMA enable_verification\n+\n+statement error\n+SELECT UNNEST ( ( '1,2,3,4,,6' , ( 1 ) ) ) , x x;\n+----\n+cannot be referenced before it is defined\n+\n+mode skip\n+\n+# FIXME this should work\n+statement error\n+SELECT UNNEST ( ( '1,2,3,4,,6' , ( random() ) ) ), 42 x, x;\n+----\n+1,2,3,4,,6\t1\t42\t42\n+\n+mode unskip\n+\n",
  "problem_statement": "DuckDB crashes with the UNNEST function.\n### What happens?\r\n\r\nDuckDB crashes with the UNNEST function.\r\n\r\n### To Reproduce\r\n\r\nPoC:\r\n```\r\nSELECT UNNEST ( ( '1,2,3,4,,6' , ( 1 ) ) ) , x x;\r\n```\r\n\r\nBacktrace:\r\n```\r\n#0 0x70c3f2 (_ZN10duckdb_fmt2v620basic_printf_contextISt20back_insert_iteratorINS0_8internal6bufferIcEEEcE12parse_headerERPKcS9_RNS0_18basic_format_specsIcEE+0x2)\r\n#1 0x70bc6f (_ZN10duckdb_fmt2v620basic_printf_contextISt20back_insert_iteratorINS0_8internal6bufferIcEEEcE6formatINS0_20printf_arg_formatterINS0_12buffer_rangeIcEEEEEES6_v+0x1af)\r\n#2 0x6fcf57 (_ZN10duckdb_fmt2v68vsprintfINSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEcEENS3_IT0_S4_IS8_ESaIS8_EEERKT_NS0_17basic_format_argsINS0_20basic_printf_contextISt20back_insert_iteratorINS0_8internal6bufferIS8_EEES8_EEEE+0x67)\r\n#3 0x69368c (_ZN6duckdb20ExceptionFormatValue6FormatERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEERSt6vectorIS0_SaIS0_EE+0x3bc)\r\n#4 0x6932c9 (_ZN6duckdb9Exception25ConstructMessageRecursiveERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEERSt6vectorINS_20ExceptionFormatValueESaISA_EE+0x9)\r\n#5 0x47d638 (_ZN6duckdb9Exception25ConstructMessageRecursiveINSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEJEEES7_RKS7_RSt6vectorINS_20ExceptionFormatValueESaISB_EET_DpT0_+0x148)\r\n#6 0x493bb0 (_ZN6duckdb9Exception25ConstructMessageRecursiveINSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEJS7_EEES7_RKS7_RSt6vectorINS_20ExceptionFormatValueESaISB_EET_DpT0_+0x1d0)\r\n#7 0x49388d (_ZN6duckdb9Exception16ConstructMessageIJNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEES7_EEES7_RKS7_DpT_+0x12d)\r\n#8 0x490a0d (_ZN6duckdb10StringUtil6FormatIJNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEES7_EEES7_S7_DpT_+0x10d)\r\n#9 0x4c7145 (_ZN6duckdb15BinderException14ColumnNotFoundERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEERKNS_6vectorIS6_Lb1EEENS_17QueryErrorContextE+0x445)\r\n#10 0xbe3c61 (_ZN6duckdb16ExpressionBinder17QualifyColumnNameERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEERNS_9ErrorDataE+0x3d1)\r\n#11 0xbe4658 (_ZN6duckdb16ExpressionBinder17QualifyColumnNameERNS_19ColumnRefExpressionERNS_9ErrorDataE+0xa8)\r\n#12 0xbe62f6 (_ZN6duckdb16ExpressionBinder14BindExpressionERNS_19ColumnRefExpressionEm+0xd6)\r\n#13 0xc8183f (_ZN6duckdb16ExpressionBinder14BindExpressionERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEmb+0x26f)\r\n#14 0xc62f47 (_ZN6duckdb16BaseSelectBinder13BindColumnRefERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEm+0x27)\r\n#15 0xc62923 (_ZN6duckdb16BaseSelectBinder14BindExpressionERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEmb+0x83)\r\n#16 0xc63157 (_ZN6duckdb16BaseSelectBinder13BindColumnRefERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEm+0x237)\r\n#17 0xc62923 (_ZN6duckdb16BaseSelectBinder14BindExpressionERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEmb+0x83)\r\n#18 0xc63157 (_ZN6duckdb16BaseSelectBinder13BindColumnRefERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEm+0x237)\r\n#19 0xc62923 (_ZN6duckdb16BaseSelectBinder14BindExpressionERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEmb+0x83)\r\n...\r\n#40252 0xc63157 (_ZN6duckdb16BaseSelectBinder13BindColumnRefERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEm+0x237)\r\n#40253 0xc62923 (_ZN6duckdb16BaseSelectBinder14BindExpressionERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEmb+0x83)\r\n```\r\n\r\n### OS:\r\n\r\nUbuntu 20.04\r\n\r\n### DuckDB Version:\r\n\r\nv0.10.1\r\n\r\n### DuckDB Client:\r\n\r\nbinary (/usr/local/bin/duckdb)\r\n\r\n### Full Name:\r\n\r\nZongrui Peng\r\n\r\n### Affiliation:\r\n\r\nWingtecher Lab of Tsinghua University\r\n\r\n### Have you tried this on the latest [nightly build](https://duckdb.org/docs/installation/?version=main)?\r\n\r\nI have tested with a nightly build\r\n\r\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\r\n\r\n- [X] Yes, I have\nDuckDB crashes with the UNNEST function.\n### What happens?\r\n\r\nDuckDB crashes with the UNNEST function.\r\n\r\n### To Reproduce\r\n\r\nPoC:\r\n```\r\nSELECT UNNEST ( ( '1,2,3,4,,6' , ( 1 ) ) ) , x x;\r\n```\r\n\r\nBacktrace:\r\n```\r\n#0 0x70c3f2 (_ZN10duckdb_fmt2v620basic_printf_contextISt20back_insert_iteratorINS0_8internal6bufferIcEEEcE12parse_headerERPKcS9_RNS0_18basic_format_specsIcEE+0x2)\r\n#1 0x70bc6f (_ZN10duckdb_fmt2v620basic_printf_contextISt20back_insert_iteratorINS0_8internal6bufferIcEEEcE6formatINS0_20printf_arg_formatterINS0_12buffer_rangeIcEEEEEES6_v+0x1af)\r\n#2 0x6fcf57 (_ZN10duckdb_fmt2v68vsprintfINSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEcEENS3_IT0_S4_IS8_ESaIS8_EEERKT_NS0_17basic_format_argsINS0_20basic_printf_contextISt20back_insert_iteratorINS0_8internal6bufferIS8_EEES8_EEEE+0x67)\r\n#3 0x69368c (_ZN6duckdb20ExceptionFormatValue6FormatERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEERSt6vectorIS0_SaIS0_EE+0x3bc)\r\n#4 0x6932c9 (_ZN6duckdb9Exception25ConstructMessageRecursiveERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEERSt6vectorINS_20ExceptionFormatValueESaISA_EE+0x9)\r\n#5 0x47d638 (_ZN6duckdb9Exception25ConstructMessageRecursiveINSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEJEEES7_RKS7_RSt6vectorINS_20ExceptionFormatValueESaISB_EET_DpT0_+0x148)\r\n#6 0x493bb0 (_ZN6duckdb9Exception25ConstructMessageRecursiveINSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEJS7_EEES7_RKS7_RSt6vectorINS_20ExceptionFormatValueESaISB_EET_DpT0_+0x1d0)\r\n#7 0x49388d (_ZN6duckdb9Exception16ConstructMessageIJNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEES7_EEES7_RKS7_DpT_+0x12d)\r\n#8 0x490a0d (_ZN6duckdb10StringUtil6FormatIJNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEES7_EEES7_S7_DpT_+0x10d)\r\n#9 0x4c7145 (_ZN6duckdb15BinderException14ColumnNotFoundERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEERKNS_6vectorIS6_Lb1EEENS_17QueryErrorContextE+0x445)\r\n#10 0xbe3c61 (_ZN6duckdb16ExpressionBinder17QualifyColumnNameERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEERNS_9ErrorDataE+0x3d1)\r\n#11 0xbe4658 (_ZN6duckdb16ExpressionBinder17QualifyColumnNameERNS_19ColumnRefExpressionERNS_9ErrorDataE+0xa8)\r\n#12 0xbe62f6 (_ZN6duckdb16ExpressionBinder14BindExpressionERNS_19ColumnRefExpressionEm+0xd6)\r\n#13 0xc8183f (_ZN6duckdb16ExpressionBinder14BindExpressionERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEmb+0x26f)\r\n#14 0xc62f47 (_ZN6duckdb16BaseSelectBinder13BindColumnRefERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEm+0x27)\r\n#15 0xc62923 (_ZN6duckdb16BaseSelectBinder14BindExpressionERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEmb+0x83)\r\n#16 0xc63157 (_ZN6duckdb16BaseSelectBinder13BindColumnRefERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEm+0x237)\r\n#17 0xc62923 (_ZN6duckdb16BaseSelectBinder14BindExpressionERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEmb+0x83)\r\n#18 0xc63157 (_ZN6duckdb16BaseSelectBinder13BindColumnRefERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEm+0x237)\r\n#19 0xc62923 (_ZN6duckdb16BaseSelectBinder14BindExpressionERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEmb+0x83)\r\n...\r\n#40252 0xc63157 (_ZN6duckdb16BaseSelectBinder13BindColumnRefERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEm+0x237)\r\n#40253 0xc62923 (_ZN6duckdb16BaseSelectBinder14BindExpressionERNS_10unique_ptrINS_16ParsedExpressionESt14default_deleteIS2_ELb1EEEmb+0x83)\r\n```\r\n\r\n### OS:\r\n\r\nUbuntu 20.04\r\n\r\n### DuckDB Version:\r\n\r\nv0.10.1\r\n\r\n### DuckDB Client:\r\n\r\nbinary (/usr/local/bin/duckdb)\r\n\r\n### Full Name:\r\n\r\nZongrui Peng\r\n\r\n### Affiliation:\r\n\r\nWingtecher Lab of Tsinghua University\r\n\r\n### Have you tried this on the latest [nightly build](https://duckdb.org/docs/installation/?version=main)?\r\n\r\nI have tested with a nightly build\r\n\r\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\r\n\r\n- [X] Yes, I have\n",
  "hints_text": "\n",
  "created_at": "2024-04-03T18:50:46Z"
}