{
  "repo": "duckdb/duckdb",
  "pull_number": 16691,
  "instance_id": "duckdb__duckdb-16691",
  "issue_numbers": [
    "16627",
    "16627"
  ],
  "base_commit": "8758084398b63837a9a6cbdc418a3ec6ab9e033f",
  "patch": "diff --git a/src/storage/statistics/numeric_stats.cpp b/src/storage/statistics/numeric_stats.cpp\nindex a9379812292e..4283ea78988e 100644\n--- a/src/storage/statistics/numeric_stats.cpp\n+++ b/src/storage/statistics/numeric_stats.cpp\n@@ -147,6 +147,7 @@ FilterPropagateResult CheckZonemapTemplated(const BaseStatistics &stats, Express\n                                             T max_value, T constant) {\n \tswitch (comparison_type) {\n \tcase ExpressionType::COMPARE_EQUAL:\n+\tcase ExpressionType::COMPARE_NOT_DISTINCT_FROM:\n \t\tif (ConstantExactRange(min_value, max_value, constant)) {\n \t\t\treturn FilterPropagateResult::FILTER_ALWAYS_TRUE;\n \t\t}\n@@ -155,6 +156,7 @@ FilterPropagateResult CheckZonemapTemplated(const BaseStatistics &stats, Express\n \t\t}\n \t\treturn FilterPropagateResult::FILTER_ALWAYS_FALSE;\n \tcase ExpressionType::COMPARE_NOTEQUAL:\n+\tcase ExpressionType::COMPARE_DISTINCT_FROM:\n \t\tif (!ConstantValueInRange(min_value, max_value, constant)) {\n \t\t\treturn FilterPropagateResult::FILTER_ALWAYS_TRUE;\n \t\t} else if (ConstantExactRange(min_value, max_value, constant)) {\ndiff --git a/src/storage/statistics/string_stats.cpp b/src/storage/statistics/string_stats.cpp\nindex 691bae090520..ae6a1e5fe57e 100644\n--- a/src/storage/statistics/string_stats.cpp\n+++ b/src/storage/statistics/string_stats.cpp\n@@ -210,12 +210,14 @@ FilterPropagateResult StringStats::CheckZonemap(const_data_ptr_t min_data, idx_t\n \tint max_comp = StringValueComparison(data, MinValue(max_len, size), max_data);\n \tswitch (comparison_type) {\n \tcase ExpressionType::COMPARE_EQUAL:\n+\tcase ExpressionType::COMPARE_NOT_DISTINCT_FROM:\n \t\tif (min_comp >= 0 && max_comp <= 0) {\n \t\t\treturn FilterPropagateResult::NO_PRUNING_POSSIBLE;\n \t\t} else {\n \t\t\treturn FilterPropagateResult::FILTER_ALWAYS_FALSE;\n \t\t}\n \tcase ExpressionType::COMPARE_NOTEQUAL:\n+\tcase ExpressionType::COMPARE_DISTINCT_FROM:\n \t\tif (min_comp < 0 || max_comp > 0) {\n \t\t\treturn FilterPropagateResult::FILTER_ALWAYS_TRUE;\n \t\t}\n",
  "test_patch": "diff --git a/test/optimizer/pushdown/distinct_from_pushdown.test b/test/optimizer/pushdown/distinct_from_pushdown.test\nnew file mode 100644\nindex 000000000000..fa50f3094948\n--- /dev/null\n+++ b/test/optimizer/pushdown/distinct_from_pushdown.test\n@@ -0,0 +1,27 @@\n+# name: test/optimizer/pushdown/distinct_from_pushdown.test\n+# description: Test DISTINCT FROM pushed down into scans\n+# group: [pushdown]\n+\n+statement ok\n+create table test as select 'tst' as tst;\n+\n+query I\n+select * from test where tst is not distinct from 'a' or tst is not distinct from 'b';\n+----\n+\n+query I\n+select * from test where tst is distinct from 'a' or tst is distinct from 'b';\n+----\n+tst\n+\n+statement ok\n+create table test2 as select 42 as tst;\n+\n+query I\n+select * from test2 where tst is not distinct from 12 or tst is not distinct from 13;\n+----\n+\n+query I\n+select * from test2 where tst is distinct from 12 or tst is distinct from 13\n+----\n+42\n",
  "problem_statement": "Internal error, Expression type not implemented for string statistics zone map\n### What happens?\n\nDuckDB internal error happens when \"is not distinct from\" is combined with or. This seems to be a regression in 1.2, still present in 1.2.1.  Error does not happen in 1.1.3.\n\nCan be reproduced in cli, or in client APIs, or in shell.duckdb.org.\n\nOutput from cli:\n\n```text\nv1.2.1 8e52ec4395\nEnter \".help\" for usage hints.\nConnected to a transient in-memory database.\nUse \".open FILENAME\" to reopen on a persistent database.\n```\n```sql\ncreate table test as select 'tst' as tst;\nselect * from test where tst is not distinct from 'a' or tst is not distinct from 'b';\n```\n```console\nINTERNAL Error:\nExpression type not implemented for string statistics zone map\nThis error signals an assertion failure within DuckDB. This usually occurs due to unexpected conditions or errors in the program's logic.\nFor more information, see https://duckdb.org/docs/dev/internal_errors\n```\n\n### To Reproduce\n\n```\ncreate table test as select 'tst' as tst; \nselect * from test where tst is not distinct from 'a' or tst is not distinct from 'b';\n```\n\n### OS:\n\nWin10 x86_64\n\n### DuckDB Version:\n\n1.2.1 and v1.3.0-dev1204\n\n### DuckDB Client:\n\nall\n\n### Hardware:\n\n_No response_\n\n### Full Name:\n\nHeikki Innanen\n\n### Affiliation:\n\nMetabees Oy\n\n### What is the latest build you tested with? If possible, we recommend testing with the latest nightly build.\n\nI have tested with a stable release (1.2.1) and v1.3.0-dev1204\n\n### Did you include all relevant data sets for reproducing the issue?\n\nYes\n\n### Did you include all code required to reproduce the issue?\n\n- [x] Yes, I have\n\n### Did you include all relevant configuration (e.g., CPU architecture, Python version, Linux distribution) to reproduce the issue?\n\n- [x] Yes, I have\nInternal error, Expression type not implemented for string statistics zone map\n### What happens?\n\nDuckDB internal error happens when \"is not distinct from\" is combined with or. This seems to be a regression in 1.2, still present in 1.2.1.  Error does not happen in 1.1.3.\n\nCan be reproduced in cli, or in client APIs, or in shell.duckdb.org.\n\nOutput from cli:\n\n```text\nv1.2.1 8e52ec4395\nEnter \".help\" for usage hints.\nConnected to a transient in-memory database.\nUse \".open FILENAME\" to reopen on a persistent database.\n```\n```sql\ncreate table test as select 'tst' as tst;\nselect * from test where tst is not distinct from 'a' or tst is not distinct from 'b';\n```\n```console\nINTERNAL Error:\nExpression type not implemented for string statistics zone map\nThis error signals an assertion failure within DuckDB. This usually occurs due to unexpected conditions or errors in the program's logic.\nFor more information, see https://duckdb.org/docs/dev/internal_errors\n```\n\n### To Reproduce\n\n```\ncreate table test as select 'tst' as tst; \nselect * from test where tst is not distinct from 'a' or tst is not distinct from 'b';\n```\n\n### OS:\n\nWin10 x86_64\n\n### DuckDB Version:\n\n1.2.1 and v1.3.0-dev1204\n\n### DuckDB Client:\n\nall\n\n### Hardware:\n\n_No response_\n\n### Full Name:\n\nHeikki Innanen\n\n### Affiliation:\n\nMetabees Oy\n\n### What is the latest build you tested with? If possible, we recommend testing with the latest nightly build.\n\nI have tested with a stable release (1.2.1) and v1.3.0-dev1204\n\n### Did you include all relevant data sets for reproducing the issue?\n\nYes\n\n### Did you include all code required to reproduce the issue?\n\n- [x] Yes, I have\n\n### Did you include all relevant configuration (e.g., CPU architecture, Python version, Linux distribution) to reproduce the issue?\n\n- [x] Yes, I have\n",
  "hints_text": "\n",
  "created_at": "2025-03-17T13:25:21Z"
}