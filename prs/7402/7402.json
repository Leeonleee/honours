{
  "repo": "duckdb/duckdb",
  "pull_number": 7402,
  "instance_id": "duckdb__duckdb-7402",
  "issue_numbers": [
    "5882"
  ],
  "base_commit": "4c6157b920e4fb808122a1754f1b4483064961f0",
  "patch": "diff --git a/src/storage/statistics/string_stats.cpp b/src/storage/statistics/string_stats.cpp\nindex af1ef69c94d6..7f717535107b 100644\n--- a/src/storage/statistics/string_stats.cpp\n+++ b/src/storage/statistics/string_stats.cpp\n@@ -140,7 +140,7 @@ void StringStats::Update(BaseStatistics &stats, const string_t &value) {\n \t\tif (unicode == UnicodeType::UNICODE) {\n \t\t\tstring_data.has_unicode = true;\n \t\t} else if (unicode == UnicodeType::INVALID) {\n-\t\t\tthrow InternalException(\n+\t\t\tthrow InvalidInputException(\n \t\t\t    ErrorManager::InvalidUnicodeError(string((char *)data, size), \"segment statistics update\"));\n \t\t}\n \t}\n",
  "test_patch": "diff --git a/data/parquet-testing/invalid.parquet b/data/parquet-testing/invalid.parquet\nnew file mode 100644\nindex 000000000000..e1eb3a807038\nBinary files /dev/null and b/data/parquet-testing/invalid.parquet differ\ndiff --git a/test/parquet/invalid_parquet.test b/test/parquet/invalid_parquet.test\nnew file mode 100644\nindex 000000000000..94a0b1b5a5b1\n--- /dev/null\n+++ b/test/parquet/invalid_parquet.test\n@@ -0,0 +1,21 @@\n+# name: test/parquet/invalid_parquet.test\n+# description: Test Parquet Reader on data/parquet-testing/invalid.parquet\n+# group: [parquet]\n+\n+require parquet\n+\n+statement ok\n+PRAGMA enable_verification\n+\n+statement error\n+SELECT * FROM parquet_scan('data/parquet-testing/invalid.parquet') limit 50;\n+----\n+Invalid Input Error: Invalid unicode (byte sequence mismatch) detected in segment statistics update\n+\n+statement ok\n+pragma disable_optimizer\n+\n+statement error\n+SELECT * FROM parquet_scan('data/parquet-testing/invalid.parquet') limit 50;\n+----\n+Invalid Input Error: Invalid string encoding found in Parquet file: value \"TREL\\xC3\" is not valid UTF8!\n",
  "problem_statement": "INTERNAL Error while querying from Parquet\n### What happens?\n\nWhile trying to query from the enclosed Parquet-file ([invalid.zip](https://github.com/duckdb/duckdb/files/10382907/invalid.zip)), DuckDB throws an `INTERNAL Error: Invalid unicode (byte sequence mismatch) detected in segment statistics update`. This is obviously due to invalid unicode in the parquet-file, but I would have expected it to result in `Invalid Input Error: Invalid string encoding found in Parquet file: value \"TREL\\xC3\" is not valid UTF8!` instead of INTERNAL Error leading to database invalidation and need for restarting database.\r\n\r\n\r\n\n\n### To Reproduce\n\nUnzip the [invalid.zip](https://github.com/duckdb/duckdb/files/10389803/invalid.zip) and execute query `SELECT * FROM 'invalid.parquet';`.\r\n\n\n### OS:\n\nWindows 10\n\n### DuckDB Version:\n\n0.6.1 latest master\n\n### DuckDB Client:\n\nR, but probably occurs in any client\n\n### Full Name:\n\nReijo Sund\n\n### Affiliation:\n\nUniversity of Eastern Finland\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "Indeed it should not be INTERNAL\nI want to work in this issue",
  "created_at": "2023-05-08T09:04:17Z"
}