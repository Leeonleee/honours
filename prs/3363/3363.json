{
  "repo": "duckdb/duckdb",
  "pull_number": 3363,
  "instance_id": "duckdb__duckdb-3363",
  "issue_numbers": [
    "3361",
    "3361"
  ],
  "base_commit": "6ac91ddc15c18023e56c2702c33c082cd5776541",
  "patch": "diff --git a/src/function/scalar/sequence/nextval.cpp b/src/function/scalar/sequence/nextval.cpp\nindex 533ccc9676cc..e8f09a277416 100644\n--- a/src/function/scalar/sequence/nextval.cpp\n+++ b/src/function/scalar/sequence/nextval.cpp\n@@ -47,14 +47,11 @@ struct NextSequenceValueOperator {\n \t\tbool overflow = !TryAddOperator::Operation(seq->counter, seq->increment, seq->counter);\n \t\tif (seq->cycle) {\n \t\t\tif (overflow) {\n-\t\t\t\tthrow SequenceException(\"overflow in sequence\");\n-\t\t\t}\n-\t\t\tif (result < seq->min_value) {\n-\t\t\t\tresult = seq->max_value;\n-\t\t\t\tseq->counter = seq->max_value + seq->increment;\n-\t\t\t} else if (result > seq->max_value) {\n-\t\t\t\tresult = seq->min_value;\n-\t\t\t\tseq->counter = seq->min_value + seq->increment;\n+\t\t\t\tseq->counter = seq->increment < 0 ? seq->max_value : seq->min_value;\n+\t\t\t} else if (seq->counter < seq->min_value) {\n+\t\t\t\tseq->counter = seq->max_value;\n+\t\t\t} else if (seq->counter > seq->max_value) {\n+\t\t\t\tseq->counter = seq->min_value;\n \t\t\t}\n \t\t} else {\n \t\t\tif (result < seq->min_value || (overflow && seq->increment < 0)) {\n",
  "test_patch": "diff --git a/test/issues/fuzz/sequence_overflow.test b/test/issues/fuzz/sequence_overflow.test\nnew file mode 100644\nindex 000000000000..7e059722aea2\n--- /dev/null\n+++ b/test/issues/fuzz/sequence_overflow.test\n@@ -0,0 +1,56 @@\n+# name: test/issues/fuzz/sequence_overflow.test\n+# description: Issue #3361: signed integer overflow in sequence\n+# group: [fuzz]\n+\n+statement ok\n+create sequence test INCREMENT BY -1 MINVALUE -9223372036854775808 MAXVALUE -9223372036854775800 CYCLE;\n+\n+query I\n+SELECT nextval('test') from generate_series(0,20);\n+----\n+-9223372036854775800\n+-9223372036854775801\n+-9223372036854775802\n+-9223372036854775803\n+-9223372036854775804\n+-9223372036854775805\n+-9223372036854775806\n+-9223372036854775807\n+-9223372036854775808\n+-9223372036854775800\n+-9223372036854775801\n+-9223372036854775802\n+-9223372036854775803\n+-9223372036854775804\n+-9223372036854775805\n+-9223372036854775806\n+-9223372036854775807\n+-9223372036854775808\n+-9223372036854775800\n+-9223372036854775801\n+-9223372036854775802\n+\n+query I\n+SELECT nextval('test') from generate_series(0,20);\n+----\n+-9223372036854775803\n+-9223372036854775804\n+-9223372036854775805\n+-9223372036854775806\n+-9223372036854775807\n+-9223372036854775808\n+-9223372036854775800\n+-9223372036854775801\n+-9223372036854775802\n+-9223372036854775803\n+-9223372036854775804\n+-9223372036854775805\n+-9223372036854775806\n+-9223372036854775807\n+-9223372036854775808\n+-9223372036854775800\n+-9223372036854775801\n+-9223372036854775802\n+-9223372036854775803\n+-9223372036854775804\n+-9223372036854775805\ndiff --git a/test/sql/catalog/sequence/sequence_cycle.test b/test/sql/catalog/sequence/sequence_cycle.test\nnew file mode 100644\nindex 000000000000..479e6f1a074f\n--- /dev/null\n+++ b/test/sql/catalog/sequence/sequence_cycle.test\n@@ -0,0 +1,31 @@\n+# name: test/sql/catalog/sequence/sequence_cycle.test\n+# description: Test Sequences with cycles\n+# group: [sequence]\n+\n+statement ok\n+create sequence minseq INCREMENT BY -1 MINVALUE -5 MAXVALUE 5 CYCLE;\n+\n+query I\n+SELECT nextval('minseq') from generate_series(0,20);\n+----\n+5\n+4\n+3\n+2\n+1\n+0\n+-1\n+-2\n+-3\n+-4\n+-5\n+5\n+4\n+3\n+2\n+1\n+0\n+-1\n+-2\n+-3\n+-4\ndiff --git a/test/sql/catalog/sequence/sequence_overflow.test b/test/sql/catalog/sequence/sequence_overflow.test\nindex c8cf5be38c09..6255c26a6e5a 100644\n--- a/test/sql/catalog/sequence/sequence_overflow.test\n+++ b/test/sql/catalog/sequence/sequence_overflow.test\n@@ -5,14 +5,58 @@\n statement ok\n create sequence seq1 INCREMENT BY 1 MINVALUE 9223372036854775800 MAXVALUE 9223372036854775807 CYCLE;\n \n-statement error\n+query I\n SELECT nextval('seq1') from generate_series(0,20);\n+----\n+9223372036854775800\n+9223372036854775801\n+9223372036854775802\n+9223372036854775803\n+9223372036854775804\n+9223372036854775805\n+9223372036854775806\n+9223372036854775807\n+9223372036854775800\n+9223372036854775801\n+9223372036854775802\n+9223372036854775803\n+9223372036854775804\n+9223372036854775805\n+9223372036854775806\n+9223372036854775807\n+9223372036854775800\n+9223372036854775801\n+9223372036854775802\n+9223372036854775803\n+9223372036854775804\n \n statement ok\n create sequence seq2 INCREMENT BY -1 MINVALUE -9223372036854775808 MAXVALUE -9223372036854775800 CYCLE;\n \n-statement error\n+query I\n SELECT nextval('seq2') from generate_series(0,20);\n+----\n+-9223372036854775800\n+-9223372036854775801\n+-9223372036854775802\n+-9223372036854775803\n+-9223372036854775804\n+-9223372036854775805\n+-9223372036854775806\n+-9223372036854775807\n+-9223372036854775808\n+-9223372036854775800\n+-9223372036854775801\n+-9223372036854775802\n+-9223372036854775803\n+-9223372036854775804\n+-9223372036854775805\n+-9223372036854775806\n+-9223372036854775807\n+-9223372036854775808\n+-9223372036854775800\n+-9223372036854775801\n+-9223372036854775802\n \n statement ok\n create sequence seq3 INCREMENT BY 1 MINVALUE 9223372036854775800 MAXVALUE 9223372036854775807;\n@@ -29,8 +73,30 @@ SELECT nextval('seq4') from generate_series(0,20);\n statement ok\n create sequence seq5 INCREMENT BY 9223372036854775807 MINVALUE 9223372036854775800 MAXVALUE 9223372036854775807 CYCLE;\n \n-statement error\n+query I\n SELECT nextval('seq5') from generate_series(0,20);\n+----\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n+9223372036854775800\n \n statement ok\n create sequence seq6 INCREMENT BY 9223372036854775807 MINVALUE 9223372036854775800 MAXVALUE 9223372036854775807;\n",
  "problem_statement": "signed integer overflow in sequence\n#### What happens?\r\n```\r\n/root/duckdb/src/function/scalar/sequence/nextval.cpp:57:35: runtime error: signed integer overflow: -9223372036854775808 + -1 cannot be represented in type 'long'\r\nSUMMARY: UndefinedBehaviorSanitizer: undefined-behavior /root/duckdb/src/function/scalar/sequence/nextval.cpp:57:35 in \r\n```\r\n\r\n#### To Reproduce\r\n```sql\r\ncreate sequence test INCREMENT BY -1 MINVALUE -9223372036854775808 MAXVALUE -9223372036854775800 CYCLE;\r\nSELECT nextval('test') from generate_series(0,20);\r\nSELECT nextval('test') from generate_series(0,20);\r\n```\r\n\r\n#### Environment (please complete the following information):\r\n - OS: linux\r\n - DuckDB Version: v0.3.3-dev1399 7c5ba6c0e\r\n - DuckDB Client: /usr/local/bin/duckdb\r\n\r\n#### Before Submitting\r\n\r\n- [x] **Have you tried this on the latest `master` branch?**\r\n* **Python**: `pip install duckdb --upgrade --pre`\r\n* **R**: `install.packages(\"https://github.com/duckdb/duckdb/releases/download/master-builds/duckdb_r_src.tar.gz\", repos = NULL)`\r\n* **Other Platforms**: You can find binaries [here](https://github.com/duckdb/duckdb/releases/tag/master-builds) or compile from source.\r\n\r\n- [x] **Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?**\r\n\nsigned integer overflow in sequence\n#### What happens?\r\n```\r\n/root/duckdb/src/function/scalar/sequence/nextval.cpp:57:35: runtime error: signed integer overflow: -9223372036854775808 + -1 cannot be represented in type 'long'\r\nSUMMARY: UndefinedBehaviorSanitizer: undefined-behavior /root/duckdb/src/function/scalar/sequence/nextval.cpp:57:35 in \r\n```\r\n\r\n#### To Reproduce\r\n```sql\r\ncreate sequence test INCREMENT BY -1 MINVALUE -9223372036854775808 MAXVALUE -9223372036854775800 CYCLE;\r\nSELECT nextval('test') from generate_series(0,20);\r\nSELECT nextval('test') from generate_series(0,20);\r\n```\r\n\r\n#### Environment (please complete the following information):\r\n - OS: linux\r\n - DuckDB Version: v0.3.3-dev1399 7c5ba6c0e\r\n - DuckDB Client: /usr/local/bin/duckdb\r\n\r\n#### Before Submitting\r\n\r\n- [x] **Have you tried this on the latest `master` branch?**\r\n* **Python**: `pip install duckdb --upgrade --pre`\r\n* **R**: `install.packages(\"https://github.com/duckdb/duckdb/releases/download/master-builds/duckdb_r_src.tar.gz\", repos = NULL)`\r\n* **Other Platforms**: You can find binaries [here](https://github.com/duckdb/duckdb/releases/tag/master-builds) or compile from source.\r\n\r\n- [x] **Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?**\r\n\n",
  "hints_text": "\n",
  "created_at": "2022-04-02T20:42:46Z"
}