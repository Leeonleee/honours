{
  "repo": "duckdb/duckdb",
  "pull_number": 11678,
  "instance_id": "duckdb__duckdb-11678",
  "issue_numbers": [
    "11669",
    "11669"
  ],
  "base_commit": "3c7ad7001e271f32b11bb233143d1e03df2a47b1",
  "patch": "diff --git a/src/planner/binder/tableref/bind_pivot.cpp b/src/planner/binder/tableref/bind_pivot.cpp\nindex 6c89b7b2cd91..34a9ae6a7737 100644\n--- a/src/planner/binder/tableref/bind_pivot.cpp\n+++ b/src/planner/binder/tableref/bind_pivot.cpp\n@@ -19,6 +19,7 @@\n #include \"duckdb/planner/expression/bound_aggregate_expression.hpp\"\n #include \"duckdb/main/client_config.hpp\"\n #include \"duckdb/catalog/catalog_entry/aggregate_function_catalog_entry.hpp\"\n+#include \"duckdb/main/query_result.hpp\"\n \n namespace duckdb {\n \n@@ -344,7 +345,9 @@ unique_ptr<BoundTableRef> Binder::BindBoundPivot(PivotRef &ref) {\n \tresult->bound_pivot.group_count = ref.bound_group_names.size();\n \tresult->bound_pivot.types = types;\n \tauto subquery_alias = ref.alias.empty() ? \"__unnamed_pivot\" : ref.alias;\n+\tQueryResult::DeduplicateColumns(names);\n \tbind_context.AddGenericBinding(result->bind_index, subquery_alias, names, types);\n+\n \tMoveCorrelatedExpressions(*result->child_binder);\n \treturn std::move(result);\n }\n",
  "test_patch": "diff --git a/test/sql/pivot/pivot_case_insensitive.test b/test/sql/pivot/pivot_case_insensitive.test\nnew file mode 100644\nindex 000000000000..d2c3be4af06b\n--- /dev/null\n+++ b/test/sql/pivot/pivot_case_insensitive.test\n@@ -0,0 +1,34 @@\n+# name: test/sql/pivot/pivot_case_insensitive.test\n+# description: Test case insensitivity in pivot names\n+# group: [pivot]\n+\n+statement ok\n+PRAGMA enable_verification\n+\n+statement ok\n+CREATE TABLE Cities (Name VARCHAR, id INTEGER);\n+INSERT INTO Cities VALUES ('Test', 1);\n+INSERT INTO Cities VALUES ('test',2);\n+\n+statement ok\n+SET pivot_filter_threshold=1;\n+\n+query II\n+FROM Cities\n+PIVOT (\n+    array_agg(id)\n+    FOR\n+        name IN ('test','Test')\n+);\n+----\n+[2]\t[1]\n+\n+query IIII\n+FROM Cities\n+PIVOT (\n+    array_agg(id), sum(id)\n+    FOR\n+        name IN ('test','Test')\n+);\n+----\n+[2]\t2\t[1]\t1\n",
  "problem_statement": "Pivot Operation Fails with Case-Sensitive column values\n### What happens?\r\n\r\nRunning the given query causes\r\n\r\n```text\r\nBinder Error: table \"__unnamed_pivot\" has duplicate column name \"Test\"\r\n```\r\n\r\n### To Reproduce\r\n\r\n```sql\r\nCREATE TABLE Cities (Name VARCHAR, id INTEGER);\r\nINSERT INTO Cities VALUES ('Test', 1);\r\nINSERT INTO Cities VALUES ('test',2);\r\nINSERT INTO Cities VALUES ('random3',3);\r\nINSERT INTO Cities VALUES ('random4',4);\r\nINSERT INTO Cities VALUES ('random5',5);\r\nINSERT INTO Cities VALUES ('random6',6);\r\nINSERT INTO Cities VALUES ('random7',7);\r\nINSERT INTO Cities VALUES ('random8',8);\r\nINSERT INTO Cities VALUES ('random9',9);\r\nINSERT INTO Cities VALUES ('random10',10);\r\nINSERT INTO Cities VALUES ('random11',11);\r\nINSERT INTO Cities VALUES ('random12',12);\r\nINSERT INTO Cities VALUES ('random13',13);\r\nINSERT INTO Cities VALUES ('random14',14);\r\nINSERT INTO Cities VALUES ('random15',15);\r\nINSERT INTO Cities VALUES ('random16',16);\r\nINSERT INTO Cities VALUES ('random17',17);\r\nINSERT INTO Cities VALUES ('random18',18);\r\nINSERT INTO Cities VALUES ('random19',19);\r\nINSERT INTO Cities VALUES ('random20',20);\r\nFROM Cities\r\nPIVOT (\r\n    array_agg(id)\r\n    FOR\r\n        name IN ('test','Test','random3','random4','random5','random6','random7','random8','random9','random10'\r\n        ,'random11'\r\n        )\r\n);\r\n```\r\n\r\n### OS:\r\n\r\nwindows\r\n\r\n### DuckDB Version:\r\n\r\n0.10.1\r\n\r\n### DuckDB Client:\r\n\r\nnode v16\r\n\r\n### Full Name:\r\n\r\nRajvindra Singh\r\n\r\n### Affiliation:\r\n\r\nPaxcom India Pvt Limited \r\n\r\n### What is the latest build you tested with? If possible, we recommend testing with the latest nightly build.\r\n\r\nI have tested with a stable release\r\n\r\n### Did you include all relevant data sets for reproducing the issue?\r\n\r\nNot applicable - the reproduction does not require a data set\r\n\r\n### Did you include all code required to reproduce the issue?\r\n\r\n- [x] Yes, I have\r\n\r\n### Did you include all relevant configuration (e.g., CPU architecture, Python version, Linux distribution) to reproduce the issue?\r\n\r\n- [x] Yes, I have\nPivot Operation Fails with Case-Sensitive column values\n### What happens?\r\n\r\nRunning the given query causes\r\n\r\n```text\r\nBinder Error: table \"__unnamed_pivot\" has duplicate column name \"Test\"\r\n```\r\n\r\n### To Reproduce\r\n\r\n```sql\r\nCREATE TABLE Cities (Name VARCHAR, id INTEGER);\r\nINSERT INTO Cities VALUES ('Test', 1);\r\nINSERT INTO Cities VALUES ('test',2);\r\nINSERT INTO Cities VALUES ('random3',3);\r\nINSERT INTO Cities VALUES ('random4',4);\r\nINSERT INTO Cities VALUES ('random5',5);\r\nINSERT INTO Cities VALUES ('random6',6);\r\nINSERT INTO Cities VALUES ('random7',7);\r\nINSERT INTO Cities VALUES ('random8',8);\r\nINSERT INTO Cities VALUES ('random9',9);\r\nINSERT INTO Cities VALUES ('random10',10);\r\nINSERT INTO Cities VALUES ('random11',11);\r\nINSERT INTO Cities VALUES ('random12',12);\r\nINSERT INTO Cities VALUES ('random13',13);\r\nINSERT INTO Cities VALUES ('random14',14);\r\nINSERT INTO Cities VALUES ('random15',15);\r\nINSERT INTO Cities VALUES ('random16',16);\r\nINSERT INTO Cities VALUES ('random17',17);\r\nINSERT INTO Cities VALUES ('random18',18);\r\nINSERT INTO Cities VALUES ('random19',19);\r\nINSERT INTO Cities VALUES ('random20',20);\r\nFROM Cities\r\nPIVOT (\r\n    array_agg(id)\r\n    FOR\r\n        name IN ('test','Test','random3','random4','random5','random6','random7','random8','random9','random10'\r\n        ,'random11'\r\n        )\r\n);\r\n```\r\n\r\n### OS:\r\n\r\nwindows\r\n\r\n### DuckDB Version:\r\n\r\n0.10.1\r\n\r\n### DuckDB Client:\r\n\r\nnode v16\r\n\r\n### Full Name:\r\n\r\nRajvindra Singh\r\n\r\n### Affiliation:\r\n\r\nPaxcom India Pvt Limited \r\n\r\n### What is the latest build you tested with? If possible, we recommend testing with the latest nightly build.\r\n\r\nI have tested with a stable release\r\n\r\n### Did you include all relevant data sets for reproducing the issue?\r\n\r\nNot applicable - the reproduction does not require a data set\r\n\r\n### Did you include all code required to reproduce the issue?\r\n\r\n- [x] Yes, I have\r\n\r\n### Did you include all relevant configuration (e.g., CPU architecture, Python version, Linux distribution) to reproduce the issue?\r\n\r\n- [x] Yes, I have\n",
  "hints_text": "\n",
  "created_at": "2024-04-16T14:23:32Z"
}