{
  "repo": "duckdb/duckdb",
  "pull_number": 7851,
  "instance_id": "duckdb__duckdb-7851",
  "issue_numbers": [
    "7711",
    "7711"
  ],
  "base_commit": "3e90df65e0804ef3632de74acb249a36e89d163d",
  "patch": "diff --git a/src/main/database_manager.cpp b/src/main/database_manager.cpp\nindex e96d51c5a76f..694f14f97adb 100644\n--- a/src/main/database_manager.cpp\n+++ b/src/main/database_manager.cpp\n@@ -43,6 +43,11 @@ void DatabaseManager::AddDatabase(ClientContext &context, unique_ptr<AttachedDat\n }\n \n void DatabaseManager::DetachDatabase(ClientContext &context, const string &name, OnEntryNotFound if_not_found) {\n+\tif (GetDefaultDatabase(context) == name) {\n+\t\tthrow BinderException(\"Cannot detach database \\\"%s\\\" because it is the default database. Select a different \"\n+\t\t                      \"database using `USE` to allow detaching this database\",\n+\t\t                      name);\n+\t}\n \tif (!databases->DropEntry(context, name, false, true)) {\n \t\tif (if_not_found == OnEntryNotFound::THROW_EXCEPTION) {\n \t\t\tthrow BinderException(\"Failed to detach database with name \\\"%s\\\": database not found\", name);\n",
  "test_patch": "diff --git a/test/sql/attach/attach_issue7711.test b/test/sql/attach/attach_issue7711.test\nnew file mode 100644\nindex 000000000000..493831a9d386\n--- /dev/null\n+++ b/test/sql/attach/attach_issue7711.test\n@@ -0,0 +1,22 @@\n+# name: test/sql/attach/attach_issue7711.test\n+# description: Issue #7711 - Detaching the current database prevents from using another one\n+# group: [attach]\n+\n+require noforcestorage\n+\n+statement ok\n+attach ':memory:' as test;\n+\n+statement ok\n+use test;\n+\n+statement error\n+detach test;\n+----\n+Cannot detach database \"test\" because it is the default database\n+\n+statement ok\n+use memory\n+\n+statement ok\n+detach test\n",
  "problem_statement": "Detaching the current database prevents from using another one\n### What happens?\n\nIf detach your current database, and want to set another to be used, you get an error about the current databases being missing.\r\n\r\nI think it has to do with the `USE` command being interpreted as a schema (which is then looked up in the default db, which is gone).\n\n### To Reproduce\n\n```\r\nv0.8.1-dev125 09486d2b9d\r\nEnter \".help\" for usage hints.\r\nConnected to a transient in-memory database.\r\nUse \".open FILENAME\" to reopen on a persistent database.\r\nD attach ':memory:' as test;\r\nD use test;\r\nD detach test;\r\nD attach ':memory:' as test2;\r\nD use test2;\r\nError: Binder Error: Catalog \"test\" does not exist!\r\n```\n\n### OS:\n\nMacOS\n\n### DuckDB Version:\n\nmaster\n\n### DuckDB Client:\n\ncli\n\n### Full Name:\n\nBoaz Leskes\n\n### Affiliation:\n\nMotherDuck\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\nDetaching the current database prevents from using another one\n### What happens?\n\nIf detach your current database, and want to set another to be used, you get an error about the current databases being missing.\r\n\r\nI think it has to do with the `USE` command being interpreted as a schema (which is then looked up in the default db, which is gone).\n\n### To Reproduce\n\n```\r\nv0.8.1-dev125 09486d2b9d\r\nEnter \".help\" for usage hints.\r\nConnected to a transient in-memory database.\r\nUse \".open FILENAME\" to reopen on a persistent database.\r\nD attach ':memory:' as test;\r\nD use test;\r\nD detach test;\r\nD attach ':memory:' as test2;\r\nD use test2;\r\nError: Binder Error: Catalog \"test\" does not exist!\r\n```\n\n### OS:\n\nMacOS\n\n### DuckDB Version:\n\nmaster\n\n### DuckDB Client:\n\ncli\n\n### Full Name:\n\nBoaz Leskes\n\n### Affiliation:\n\nMotherDuck\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "\n",
  "created_at": "2023-06-06T16:28:21Z"
}