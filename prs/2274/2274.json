{
  "repo": "duckdb/duckdb",
  "pull_number": 2274,
  "instance_id": "duckdb__duckdb-2274",
  "issue_numbers": [
    "2267"
  ],
  "base_commit": "4d6940afd5bfed9a7e65c8039645fa0b82c95e21",
  "patch": "diff --git a/extension/parquet/include/struct_column_reader.hpp b/extension/parquet/include/struct_column_reader.hpp\nindex 58f3bdb6854e..a6ad89d92a01 100644\n--- a/extension/parquet/include/struct_column_reader.hpp\n+++ b/extension/parquet/include/struct_column_reader.hpp\n@@ -37,15 +37,19 @@ class StructColumnReader : public ColumnReader {\n \t           Vector &result) override {\n \t\tauto &struct_entries = StructVector::GetEntries(result);\n \t\tD_ASSERT(StructType::GetChildTypes(Type()).size() == struct_entries.size());\n+\n+\t\tidx_t read_count = num_values;\n \t\tfor (idx_t i = 0; i < struct_entries.size(); i++) {\n \t\t\tauto child_num_values =\n \t\t\t    child_readers[i]->Read(num_values, filter, define_out, repeat_out, *struct_entries[i]);\n-\t\t\tif (child_num_values != num_values) {\n+\t\t\tif (i == 0) {\n+\t\t\t\tread_count = child_num_values;\n+\t\t\t} else if (read_count != child_num_values) {\n \t\t\t\tthrow std::runtime_error(\"Struct child row count mismatch\");\n \t\t\t}\n \t\t}\n \n-\t\treturn num_values;\n+\t\treturn read_count;\n \t}\n \n \tvirtual void Skip(idx_t num_values) override {\n@@ -53,6 +57,11 @@ class StructColumnReader : public ColumnReader {\n \t}\n \n \tidx_t GroupRowsAvailable() override {\n+\t\tfor (idx_t i = 0; i < child_readers.size(); i++) {\n+\t\t\tif (child_readers[i]->Type().id() != LogicalTypeId::LIST) {\n+\t\t\t\treturn child_readers[i]->GroupRowsAvailable();\n+\t\t\t}\n+\t\t}\n \t\treturn child_readers[0]->GroupRowsAvailable();\n \t}\n \n",
  "test_patch": "diff --git a/data/parquet-testing/bug2267.parquet b/data/parquet-testing/bug2267.parquet\nnew file mode 100644\nindex 000000000000..9791024ce1ee\nBinary files /dev/null and b/data/parquet-testing/bug2267.parquet differ\ndiff --git a/test/sql/copy/parquet/parquet_2267.test b/test/sql/copy/parquet/parquet_2267.test\nnew file mode 100644\nindex 000000000000..cf6efc81a0ef\n--- /dev/null\n+++ b/test/sql/copy/parquet/parquet_2267.test\n@@ -0,0 +1,10 @@\n+# name: test/sql/copy/parquet/parquet_2267.test\n+# description: Issue #2267: \"Struct child row count mismatch\" on parquet read\n+# group: [parquet]\n+\n+require parquet\n+\n+query I\n+SELECT * FROM parquet_scan('data/parquet-testing/bug2267.parquet')\n+----\n+[{'disabledPlans': [bea4c11e-220a-4e6d-8eb8-8ea15d019f90], 'skuId': c7df2760-2c81-4ef7-b578-5b5392b571df}, {'disabledPlans': [8a256a2b-b617-496d-b51b-e76466e88db0, 41781fb2-bc02-4b7c-bd55-b576c07bb09d, eec0eb4f-6444-4f95-aba0-50c24d67f998], 'skuId': 84a661c4-e949-4bd2-a560-ed7766fcaf2b}, {'disabledPlans': NULL, 'skuId': b05e124f-c7cc-45a0-a6aa-8cf78c946968}, {'disabledPlans': NULL, 'skuId': f30db892-07e9-47e9-837c-80727f46fd3d}]\n",
  "problem_statement": "\"Struct child row count mismatch\" on parquet read\n```\r\n>>> duckdb.query(\"select * from 'test.parquet'\").fetchone()\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\nRuntimeError: Struct child row count mismatch\r\n```\r\n\r\nExpect duckdb to be able to read from the parquet file.\r\n\r\nMinimal offending parquet file attached.\r\n\r\n - OS: MacOS 11.5\r\n - DuckDB Version: 0.2.9 and 0.2.10.dev247\r\n[test.parquet.zip](https://github.com/duckdb/duckdb/files/7148879/test.parquet.zip)\r\n\n",
  "hints_text": "",
  "created_at": "2021-09-13T12:37:39Z"
}