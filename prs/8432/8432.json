{
  "repo": "duckdb/duckdb",
  "pull_number": 8432,
  "instance_id": "duckdb__duckdb-8432",
  "issue_numbers": [
    "8422"
  ],
  "base_commit": "bd1859a8a66cb2dd5f34fe01e688653daf91b536",
  "patch": "diff --git a/extension/icu/icu-datepart.cpp b/extension/icu/icu-datepart.cpp\nindex cd2bbb64f8a1..725d7265e45b 100644\n--- a/extension/icu/icu-datepart.cpp\n+++ b/extension/icu/icu-datepart.cpp\n@@ -54,13 +54,13 @@ struct ICUDatePart : public ICUDateFunc {\n \t}\n \n \tstatic int64_t ExtractDayOfWeek(icu::Calendar *calendar, const uint64_t micros) {\n-\t\tcalendar->setFirstDayOfWeek(UCAL_SUNDAY);\n+\t\t// [Sun(0), Sat(6)]\n \t\treturn ExtractField(calendar, UCAL_DAY_OF_WEEK) - UCAL_SUNDAY;\n \t}\n \n \tstatic int64_t ExtractISODayOfWeek(icu::Calendar *calendar, const uint64_t micros) {\n-\t\tcalendar->setFirstDayOfWeek(UCAL_MONDAY);\n-\t\treturn ExtractField(calendar, UCAL_DAY_OF_WEEK);\n+\t\t// [Mon(1), Sun(7)]\n+\t\treturn 1 + (ExtractField(calendar, UCAL_DAY_OF_WEEK) + 7 - UCAL_MONDAY) % 7;\n \t}\n \n \tstatic int64_t ExtractWeek(icu::Calendar *calendar, const uint64_t micros) {\n",
  "test_patch": "diff --git a/test/sql/function/timestamp/test_icu_datepart.test b/test/sql/function/timestamp/test_icu_datepart.test\nindex 002afb40e373..43822f5b0354 100644\n--- a/test/sql/function/timestamp/test_icu_datepart.test\n+++ b/test/sql/function/timestamp/test_icu_datepart.test\n@@ -214,18 +214,42 @@ NULL\tNULL\n query II\n SELECT isodow(ts), isodow(ts::TIMESTAMP) FROM timestamps;\n ----\n-4\t3\n-3\t2\n-5\t4\n-2\t1\n-6\t5\n-2\t1\n-2\t1\n-6\t5\n+3\t3\n+2\t2\n+4\t4\n+1\t1\n+5\t5\n+1\t1\n+1\t1\n+5\t5\n NULL\tNULL\n NULL\tNULL\n NULL\tNULL\n \n+query II\n+SELECT date_part('isodow', ts), date_part('isodow', ts::timestamp)\n+FROM range('1992-01-06'::timestamptz, '1992-01-13'::timestamptz, interval 1 day) as t(ts);\n+----\n+1\t1\n+2\t2\n+3\t3\n+4\t4\n+5\t5\n+6\t6\n+7\t7\n+\n+query II\n+SELECT date_part('dow', ts), date_part('dow', ts::timestamp)\n+FROM range('1992-01-05'::timestamptz, '1992-01-12'::timestamptz, interval 1 day) as t(ts);\n+----\n+0\t0\n+1\t1\n+2\t2\n+3\t3\n+4\t4\n+5\t5\n+6\t6\n+\n query II\n SELECT week(ts), week(ts::TIMESTAMP) FROM timestamps;\n ----\n@@ -575,14 +599,14 @@ ORDER BY 2\n ----\n NULL\tNULL\n {'weekday': NULL, 'isodow': NULL, 'doy': NULL}\t-infinity\n-{'weekday': 3, 'isodow': 4, 'doy': 72}\t0044-03-13 (BC) 01:40:43.987654-07:52\n-{'weekday': 2, 'isodow': 3, 'doy': 212}\t1962-07-31 05:20:48.123456-07\n-{'weekday': 4, 'isodow': 5, 'doy': 366}\t2020-12-31 16:00:00-08\n-{'weekday': 1, 'isodow': 2, 'doy': 32}\t2021-02-01 16:00:00-08\n-{'weekday': 1, 'isodow': 2, 'doy': 319}\t2021-11-15 01:30:00-08\n-{'weekday': 1, 'isodow': 2, 'doy': 319}\t2021-11-15 02:30:00-08\n-{'weekday': 5, 'isodow': 6, 'doy': 330}\t2021-11-26 02:15:13.123456-08\n-{'weekday': 5, 'isodow': 6, 'doy': 358}\t2021-12-24 14:00:00-08\n+{'weekday': 3, 'isodow': 3, 'doy': 72}\t0044-03-13 (BC) 01:40:43.987654-07:52\n+{'weekday': 2, 'isodow': 2, 'doy': 212}\t1962-07-31 05:20:48.123456-07\n+{'weekday': 4, 'isodow': 4, 'doy': 366}\t2020-12-31 16:00:00-08\n+{'weekday': 1, 'isodow': 1, 'doy': 32}\t2021-02-01 16:00:00-08\n+{'weekday': 1, 'isodow': 1, 'doy': 319}\t2021-11-15 01:30:00-08\n+{'weekday': 1, 'isodow': 1, 'doy': 319}\t2021-11-15 02:30:00-08\n+{'weekday': 5, 'isodow': 5, 'doy': 330}\t2021-11-26 02:15:13.123456-08\n+{'weekday': 5, 'isodow': 5, 'doy': 358}\t2021-12-24 14:00:00-08\n {'weekday': NULL, 'isodow': NULL, 'doy': NULL}\tinfinity\n \n # ISO parts\n",
  "problem_statement": "icu date_part('isodow', timestamptz) uses wrong day mapping.\n### What happens?\n\n\r\n2023-07-30 is sunday and maps to an isoweekday 7 but duckdb returns 1 rather than 7.\r\n\r\n```sql\r\nload icu;\r\nset TimeZone = 'US/Pacific';\r\nselect date_part('isodow', ts) from (select '2023-07-30 14:20:23-07:00'::timestamptz);\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 date_part('isodow', ts) \u2502\r\n\u2502          int64          \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502                       1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\nThe code in icu-datepart.cpp calls `calendar->setFirstDayOfWeek(UCAL_MONDAY);` but it has no effect on remapping weekdays. the functions need to remove the call to setFirstDayOfWeek and then be rewritten as:\r\n```\r\n       static int64_t ExtractISODayOfWeek(icu::Calendar *calendar, const uint64_t micros) {\r\n                auto res = ExtractDayOfWeek(calendar, micros);\r\n                return res > 0 ? res : 7;\r\n        }\r\n```\r\n\r\nNote that plane timestamps work fine expected.\n\n### To Reproduce\n\njust run the function on a timestamptz. all days of the week it outputs are wrong. They should be: [isodow The day of the week as Monday (1) to Sunday (7)](https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-EXTRACT).\r\n```sql\r\nload icu;\r\nselect date_part('isodow', now());\r\n```\n\n### OS:\n\nx86_64 GNU/Linux\n\n### DuckDB Version:\n\nv0.8.2-dev\n\n### DuckDB Client:\n\ncli\n\n### Full Name:\n\nrobert manchester\n\n### Affiliation:\n\nunaffiliated\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "",
  "created_at": "2023-07-31T15:24:38Z"
}