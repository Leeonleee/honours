{
  "repo": "duckdb/duckdb",
  "pull_number": 12226,
  "instance_id": "duckdb__duckdb-12226",
  "issue_numbers": [
    "12217"
  ],
  "base_commit": "1678c7fd74318bce263b093acc5443ce89cc14b4",
  "patch": "diff --git a/src/catalog/dependency_manager.cpp b/src/catalog/dependency_manager.cpp\nindex 66042b4d9350..303d511b3744 100644\n--- a/src/catalog/dependency_manager.cpp\n+++ b/src/catalog/dependency_manager.cpp\n@@ -513,6 +513,9 @@ void DependencyManager::AlterObject(CatalogTransaction transaction, CatalogEntry\n \t\t\t\tdisallow_alter = false;\n \t\t\t\tbreak;\n \t\t\t}\n+\t\t\tcase AlterTableType::ADD_COLUMN: {\n+\t\t\t\tdisallow_alter = false;\n+\t\t\t}\n \t\t\tdefault:\n \t\t\t\tbreak;\n \t\t\t}\n",
  "test_patch": "diff --git a/test/fuzzer/pedro/alter_dependency_conflict.test b/test/fuzzer/pedro/alter_dependency_conflict.test\nindex 482cdbd41fb1..8323705c99e3 100644\n--- a/test/fuzzer/pedro/alter_dependency_conflict.test\n+++ b/test/fuzzer/pedro/alter_dependency_conflict.test\n@@ -10,15 +10,11 @@ CREATE TABLE t4 (c0 DATE, c3 VARCHAR(10));\n statement ok\n CREATE INDEX i2 ON t4 (c3);\n \n-# Catalog Error: Cannot alter entry \"t4\" because there are entries that depend on it.\n-statement error\n+statement ok\n ALTER TABLE t4 ADD c1 BLOB;\n-----\n-Cannot alter entry \"t4\" because there are entries that depend on it.\n \n-# the table should still be in a usable state after the alter\n statement ok\n-INSERT INTO t4 VALUES (NULL, NULL)\n+INSERT INTO t4 VALUES (NULL, NULL, NULL)\n \n statement ok\n START TRANSACTION;\ndiff --git a/test/sql/catalog/dependencies/add_column_to_table_referenced_by_fk.test b/test/sql/catalog/dependencies/add_column_to_table_referenced_by_fk.test\nnew file mode 100644\nindex 000000000000..c2701079052b\n--- /dev/null\n+++ b/test/sql/catalog/dependencies/add_column_to_table_referenced_by_fk.test\n@@ -0,0 +1,33 @@\n+# name: test/sql/catalog/dependencies/add_column_to_table_referenced_by_fk.test\n+# group: [dependencies]\n+\n+statement ok\n+pragma enable_verification;\n+\n+statement ok\n+create table tbl(a varchar primary key);\n+\n+statement ok\n+create table tbl2(\n+\ta varchar,\n+\tforeign key (a) references tbl(a)\n+)\n+\n+statement ok\n+insert into tbl values('abc');\n+\n+statement ok\n+insert into tbl2 values ('abc');\n+\n+statement ok\n+alter table tbl add column b integer default 5;\n+\n+query II\n+select * from tbl;\n+----\n+abc\t5\n+\n+query I\n+select * from tbl2;\n+----\n+abc\ndiff --git a/test/sql/catalog/dependencies/add_column_to_table_referenced_by_macro.test b/test/sql/catalog/dependencies/add_column_to_table_referenced_by_macro.test\nnew file mode 100644\nindex 000000000000..8d067eb866c7\n--- /dev/null\n+++ b/test/sql/catalog/dependencies/add_column_to_table_referenced_by_macro.test\n@@ -0,0 +1,27 @@\n+# name: test/sql/catalog/dependencies/add_column_to_table_referenced_by_macro.test\n+# group: [dependencies]\n+\n+statement ok\n+pragma enable_verification;\n+\n+statement ok\n+create table tbl(a varchar default 'abc');\n+\n+statement ok\n+insert into tbl values(DEFAULT);\n+\n+statement ok\n+create macro mcr() as table select * from tbl;\n+\n+query I\n+select * from mcr();\n+----\n+abc\n+\n+statement ok\n+alter table tbl add column b integer default 5;\n+\n+query II\n+select * from mcr();\n+----\n+abc\t5\ndiff --git a/test/sql/catalog/dependencies/add_column_to_table_referenced_by_view.test b/test/sql/catalog/dependencies/add_column_to_table_referenced_by_view.test\nnew file mode 100644\nindex 000000000000..59ab7d4aed2d\n--- /dev/null\n+++ b/test/sql/catalog/dependencies/add_column_to_table_referenced_by_view.test\n@@ -0,0 +1,27 @@\n+# name: test/sql/catalog/dependencies/add_column_to_table_referenced_by_view.test\n+# group: [dependencies]\n+\n+statement ok\n+pragma enable_verification;\n+\n+statement ok\n+create table tbl(a varchar default 'abc');\n+\n+statement ok\n+insert into tbl values(DEFAULT);\n+\n+statement ok\n+create view vw as select * from tbl;\n+\n+query I\n+select * from vw;\n+----\n+abc\n+\n+statement ok\n+alter table tbl add column b integer default 5;\n+\n+statement error\n+select * from vw;\n+----\n+Contents of view were altered: types don't match! Expected [VARCHAR], but found [VARCHAR, INTEGER] instead\ndiff --git a/test/sql/catalog/dependencies/change_type_of_table_column_referenced_by_index.test b/test/sql/catalog/dependencies/change_type_of_table_column_referenced_by_index.test\nnew file mode 100644\nindex 000000000000..e6770922e55b\n--- /dev/null\n+++ b/test/sql/catalog/dependencies/change_type_of_table_column_referenced_by_index.test\n@@ -0,0 +1,16 @@\n+# name: test/sql/catalog/dependencies/change_type_of_table_column_referenced_by_index.test\n+# group: [dependencies]\n+\n+statement ok\n+pragma enable_verification;\n+\n+statement ok\n+create table tbl(a varchar, b integer);\n+\n+statement ok\n+create index idx on tbl(a);\n+\n+statement error\n+alter table tbl alter a set type integer;\n+----\n+Catalog Error: Cannot change the type of this column: an index depends on it!\ndiff --git a/test/sql/catalog/dependencies/remove_table_column_referenced_by_index.test b/test/sql/catalog/dependencies/remove_table_column_referenced_by_index.test\nnew file mode 100644\nindex 000000000000..1c6298918665\n--- /dev/null\n+++ b/test/sql/catalog/dependencies/remove_table_column_referenced_by_index.test\n@@ -0,0 +1,16 @@\n+# name: test/sql/catalog/dependencies/remove_table_column_referenced_by_index.test\n+# group: [dependencies]\n+\n+statement ok\n+pragma enable_verification;\n+\n+statement ok\n+create table tbl(a varchar, b integer);\n+\n+statement ok\n+create index idx on tbl(a);\n+\n+statement error\n+alter table tbl drop column a;\n+----\n+Catalog Error: Cannot drop this column: an index depends on it!\ndiff --git a/test/sql/catalog/dependencies/rename_table_column_referenced_by_index.test b/test/sql/catalog/dependencies/rename_table_column_referenced_by_index.test\nnew file mode 100644\nindex 000000000000..1b8a73c07315\n--- /dev/null\n+++ b/test/sql/catalog/dependencies/rename_table_column_referenced_by_index.test\n@@ -0,0 +1,16 @@\n+# name: test/sql/catalog/dependencies/rename_table_column_referenced_by_index.test\n+# group: [dependencies]\n+\n+statement ok\n+pragma enable_verification;\n+\n+statement ok\n+create table tbl(a varchar);\n+\n+statement ok\n+create index idx on tbl(a);\n+\n+statement error\n+alter table tbl rename a to b;\n+----\n+Cannot alter entry \"tbl\" because there are entries that depend on it.\ndiff --git a/test/sql/catalog/dependencies/rename_view_referenced_by_table_macro.test b/test/sql/catalog/dependencies/rename_view_referenced_by_table_macro.test\nnew file mode 100644\nindex 000000000000..014282b9613f\n--- /dev/null\n+++ b/test/sql/catalog/dependencies/rename_view_referenced_by_table_macro.test\n@@ -0,0 +1,27 @@\n+# name: test/sql/catalog/dependencies/rename_view_referenced_by_table_macro.test\n+# group: [dependencies]\n+\n+statement ok\n+pragma enable_verification;\n+\n+# Create a table so our view has something to reference\n+statement ok\n+create table tbl (a varchar);\n+\n+# Create the view\n+statement ok\n+create view vw as select * from tbl;\n+\n+# Create a table macro that references the view\n+statement ok\n+create macro static_table() as table select * from vw;\n+\n+# Rename the view (Postgres 16.0 does not block this ALTER)\n+statement ok\n+alter view vw rename to vw2;\n+\n+# Our table macro now errors\n+statement error\n+select * from static_table();\n+----\n+Catalog Error: Table with name vw does not exist!\ndiff --git a/test/sql/catalog/dependencies/set_default_of_table_column_referenced_by_index.test b/test/sql/catalog/dependencies/set_default_of_table_column_referenced_by_index.test\nnew file mode 100644\nindex 000000000000..fe71c702c964\n--- /dev/null\n+++ b/test/sql/catalog/dependencies/set_default_of_table_column_referenced_by_index.test\n@@ -0,0 +1,17 @@\n+# name: test/sql/catalog/dependencies/set_default_of_table_column_referenced_by_index.test\n+# group: [dependencies]\n+\n+statement ok\n+pragma enable_verification;\n+\n+statement ok\n+create table tbl(a varchar, b integer);\n+\n+statement ok\n+create index idx on tbl(a);\n+\n+statement error\n+alter table tbl alter a set default 'test';\n+----\n+Dependency Error: Cannot alter entry \"tbl\" because there are entries that depend on it.\n+\n",
  "problem_statement": ":bug: `v0.10.3` Regression while adding a new column to a table \"because there are entries that depend on it.\"\n### What happens?\n\nSince latest [`v0.10.3`](https://github.com/duckdb/duckdb/releases/tag/v0.10.3), my scheduled notebook is broken, a regression has been introduced.\r\n\r\nAs a proof, see : \r\n\r\n- [:+1:  Before](https://www.kaggle.com/code/adriensales/fiches-emploi-nouvelle-cal-donie)\r\n- [:-1: Now](https://www.kaggle.com/code/adriensales/fiches-emploi-nouvelle-cal-donie?scriptVersionId=179423277)\n\n### To Reproduce\n\nSee notebook [here](https://www.kaggle.com/code/adriensales/fiches-emploi-nouvelle-cal-donie/log?scriptVersionId=179423277), still here are the steps to reproduce : \r\n\r\n# :one:  Create a main table : \r\n\r\n```python\r\ncon.execute(\"\"\"create or replace table familles(id varchar primary key)\"\"\")\r\ncon.execute(\"\"\"insert into familles\r\n                    select distinct famille\r\n                        from load_fiches\r\n                    order by famille;\"\"\")\r\ndf = con.query(\"from familles\").to_df()\r\ndf\r\n```\r\n\r\n# :two: Create a table that references it\r\n\r\n```python\r\ncon.execute(\"\"\"create or replace SEQUENCE id_fiche START 1; \"\"\")\r\ncon.execute(\"\"\"create or replace table fiches(\r\n                id integer DEFAULT nextval('id_fiche') primary key,\r\n                famille varchar not null references familles(id),\r\n                titre varchar not null,\r\n                url_pdf_fiche_emploi varchar not null\r\n                )\"\"\")\r\n\r\ncon.execute(\"\"\"insert into fiches (famille, titre, url_pdf_fiche_emploi)\r\n                    select famille, titre, url_pdf_fiche_emploi\r\n                        from load_fiches\r\n                    order by famille, titre;\"\"\")\r\ndf = con.query(\"from fiches\").to_df()\r\ndf\r\n```\r\n\r\n# :three: Add a column to the main table\r\n\r\n```python\r\ncon.execute(\"\"\"alter table familles add column code_rome varchar\"\"\")\r\n```\r\n\n\n### OS:\n\nKaggle\n\n### DuckDB Version:\n\n`v0.10.3` \n\n### DuckDB Client:\n\nPython\n\n### Full Name:\n\nAdrien Sales\n\n### Affiliation:\n\nhttps://dev.to/adriens\n\n### What is the latest build you tested with? If possible, we recommend testing with the latest nightly build.\n\nI have tested with a stable release\n\n### Did you include all relevant data sets for reproducing the issue?\n\nYes\n\n### Did you include all code required to reproduce the issue?\n\n- [X] Yes, I have\n\n### Did you include all relevant configuration (e.g., CPU architecture, Python version, Linux distribution) to reproduce the issue?\n\n- [X] Yes, I have\n",
  "hints_text": "https://github.com/duckdb/duckdb/pull/11524\n- https://github.com/duckdb/duckdb/pull/11524\r\n\r\nIs there a planning fo the release of `v0.10.4` ?\nHey sorry, I wasn't clear\r\n\r\nThe problem is introduced by that PR, I just wanted to point to the relevant context\r\nThere is no real reason the ALTER you're doing should be blocked by this dependency but there is no fine grained control on this yet\r\n\r\nPerhaps we should take the same approach as #12209 to fix this problem until the handling is more mature and we don't block ALTERs unnecessarily",
  "created_at": "2024-05-24T12:22:35Z"
}