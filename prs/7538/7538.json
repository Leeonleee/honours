{
  "repo": "duckdb/duckdb",
  "pull_number": 7538,
  "instance_id": "duckdb__duckdb-7538",
  "issue_numbers": [
    "7530"
  ],
  "base_commit": "4e856aa5296a1693c242637c689759e4d389b063",
  "patch": "diff --git a/src/execution/index/art/leaf.cpp b/src/execution/index/art/leaf.cpp\nindex 6d9e86bc6303..ca789d212e95 100644\n--- a/src/execution/index/art/leaf.cpp\n+++ b/src/execution/index/art/leaf.cpp\n@@ -192,15 +192,12 @@ void Leaf::Remove(ART &art, const row_t row_id) {\n \treference<LeafSegment> prev_segment(LeafSegment::Get(art, ptr));\n \twhile (copy_idx < count) {\n \n-\t\t// calculate the copy count\n-\t\tauto copy_count = count - copy_idx;\n-\t\tif (Node::LEAF_SEGMENT_SIZE - 1 < copy_count) {\n-\t\t\tcopy_count = Node::LEAF_SEGMENT_SIZE - 1;\n-\t\t}\n+\t\tauto copy_start = copy_idx % Node::LEAF_SEGMENT_SIZE;\n+\t\tD_ASSERT(copy_start != 0);\n+\t\tauto copy_end = MinValue(copy_start + count - copy_idx, Node::LEAF_SEGMENT_SIZE);\n \n \t\t// copy row IDs\n-\t\tD_ASSERT((copy_idx % Node::LEAF_SEGMENT_SIZE) != 0);\n-\t\tfor (idx_t i = copy_idx % Node::LEAF_SEGMENT_SIZE; i <= copy_count; i++) {\n+\t\tfor (idx_t i = copy_start; i < copy_end; i++) {\n \t\t\tsegment.get().row_ids[i - 1] = segment.get().row_ids[i];\n \t\t\tcopy_idx++;\n \t\t}\n",
  "test_patch": "diff --git a/test/sql/index/art/art_issue_7530.test b/test/sql/index/art/art_issue_7530.test\nnew file mode 100644\nindex 000000000000..79cc79677a6d\n--- /dev/null\n+++ b/test/sql/index/art/art_issue_7530.test\n@@ -0,0 +1,15 @@\n+# name: test/sql/index/art/art_issue_7530.test\n+# description: Test to ensure correct multi-value leaf deletions\n+# group: [art]\n+\n+statement ok\n+CREATE TABLE t14(c0 BIGINT);\n+\n+statement ok\n+INSERT INTO t14(c0) VALUES ((1)), ((1)), ((1));\n+\n+statement ok\n+CREATE INDEX i1 ON t14(c0 );\n+\n+statement ok\n+DELETE FROM t14 WHERE t14.rowid;\n\\ No newline at end of file\n",
  "problem_statement": "DuckDB hang on `DELETE`\n### What happens?\n\nDuckDB hang on the following program:\r\n```\r\nCREATE TABLE t14(c0 BIGINT);\r\nINSERT INTO t14(c0) VALUES ((1)), ((1)), ((1));\r\nCREATE INDEX i1 ON t14(c0 );\r\nDELETE FROM t14 WHERE t14.rowid;\r\n```\n\n### To Reproduce\n\nI can reproduce this on the latest commit version https://github.com/duckdb/duckdb/commit/59a4ec3adce7e2bf67fe62912a8128bcbb6db0be\n\n### OS:\n\nubuntu 22.04\n\n### DuckDB Version:\n\nhttps://github.com/duckdb/duckdb/commit/59a4ec3adce7e2bf67fe62912a8128bcbb6db0be\n\n### DuckDB Client:\n\nCLI\n\n### Full Name:\n\nChi Zhang\n\n### Affiliation:\n\nNanjing University, National University of Singapore\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "",
  "created_at": "2023-05-16T11:53:57Z"
}