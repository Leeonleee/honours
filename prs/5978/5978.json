{
  "repo": "duckdb/duckdb",
  "pull_number": 5978,
  "instance_id": "duckdb__duckdb-5978",
  "issue_numbers": [
    "5971",
    "5971"
  ],
  "base_commit": "09f803d3ad2972e36b15612c4bc15d65685a743e",
  "patch": "diff --git a/extension/icu/icu-dateadd.cpp b/extension/icu/icu-dateadd.cpp\nindex 907dac9eeb6d..56fb7bb3a3f2 100644\n--- a/extension/icu/icu-dateadd.cpp\n+++ b/extension/icu/icu-dateadd.cpp\n@@ -53,6 +53,10 @@ static inline void CalendarAddHour(icu::Calendar *calendar, int64_t interval_hou\n \n template <>\n timestamp_t ICUCalendarAdd::Operation(timestamp_t timestamp, interval_t interval, icu::Calendar *calendar) {\n+\tif (!Timestamp::IsFinite(timestamp)) {\n+\t\treturn timestamp;\n+\t}\n+\n \tint64_t millis = timestamp.value / Interval::MICROS_PER_MSEC;\n \tint64_t micros = timestamp.value % Interval::MICROS_PER_MSEC;\n \n",
  "test_patch": "diff --git a/test/sql/function/timestamp/test_icu_dateadd.test b/test/sql/function/timestamp/test_icu_dateadd.test\nindex 1f4a6c4a368b..087427b69f2e 100644\n--- a/test/sql/function/timestamp/test_icu_dateadd.test\n+++ b/test/sql/function/timestamp/test_icu_dateadd.test\n@@ -109,7 +109,7 @@ select 'epoch'::timestamptz + '-9223372022400001000 microseconds'::interval\n ----\n 290303-12-10 (BC) 16:07:02-07:52\n \n-#  interval + timestamp\n+# interval + timestamp\n query II\n SELECT iv, iv + '2021-12-01 13:54:48.123456Z'::TIMESTAMPTZ FROM intervals;\n ----\n@@ -166,6 +166,27 @@ select  '-9223372022400001000 microseconds'::interval + 'epoch'::timestamptz\n ----\n 290303-12-10 (BC) 16:07:02-07:52\n \n+# infinity\n+query I\n+select 'infinity'::timestamptz + '1 microsecond'::interval\n+----\n+infinity\n+\n+query I\n+select '1 microsecond'::interval + 'infinity'::timestamptz\n+----\n+infinity\n+\n+query I\n+select '-infinity'::timestamptz + '1 microsecond'::interval\n+----\n+-infinity\n+\n+query I\n+select '1 microsecond'::interval + '-infinity'::timestamptz\n+----\n+-infinity\n+\n # timestamp - interval\n query II\n SELECT iv, '2021-12-01 13:54:48.123456Z'::TIMESTAMPTZ - iv FROM intervals;\n@@ -215,6 +236,17 @@ select 'epoch'::timestamptz - '9223372022400001000 microseconds'::interval\n ----\n 290303-12-10 (BC) 16:07:02-07:52\n \n+# infinity\n+query I\n+select 'infinity'::timestamptz - '1 day'::interval\n+----\n+infinity\n+\n+query I\n+select '-infinity'::timestamptz - '1 day'::interval\n+----\n+-infinity\n+\n # Before the epoch\n query II\n SELECT iv, '1962-07-31 12:20:48.123456Z'::TIMESTAMPTZ + iv FROM intervals;\n",
  "problem_statement": "Subtraction from infinity of TIMESTAMPTZ returns a finite value\n### What happens?\n\nSubtraction from infinity of `TIMESTAMPTZ` returns a finite value.\n\n### To Reproduce\n\n```sql\r\nD select 'infinity'::timestamptz - '1 second'::interval;\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 (CAST('infinity' AS TIMESTAMP WITH TIME ZONE) - CAST('1 second' AS INTERVAL)) \u2502\r\n\u2502                           timestamp with time zone                            \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 294247-01-10 04:00:53.776807+00                                               \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\n\n### OS:\n\nUbuntu 22.04 on WSL2 of Windows 11 Home\n\n### DuckDB Version:\n\nv0.6.2-dev1283 99681d8\n\n### DuckDB Client:\n\nCLI\n\n### Full Name:\n\nKoki Ueha\n\n### Affiliation:\n\nNone\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\nSubtraction from infinity of TIMESTAMPTZ returns a finite value\n### What happens?\n\nSubtraction from infinity of `TIMESTAMPTZ` returns a finite value.\n\n### To Reproduce\n\n```sql\r\nD select 'infinity'::timestamptz - '1 second'::interval;\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 (CAST('infinity' AS TIMESTAMP WITH TIME ZONE) - CAST('1 second' AS INTERVAL)) \u2502\r\n\u2502                           timestamp with time zone                            \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 294247-01-10 04:00:53.776807+00                                               \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\n\n### OS:\n\nUbuntu 22.04 on WSL2 of Windows 11 Home\n\n### DuckDB Version:\n\nv0.6.2-dev1283 99681d8\n\n### DuckDB Client:\n\nCLI\n\n### Full Name:\n\nKoki Ueha\n\n### Affiliation:\n\nNone\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "\n",
  "created_at": "2023-01-23T23:42:48Z"
}