{
  "repo": "duckdb/duckdb",
  "pull_number": 11316,
  "instance_id": "duckdb__duckdb-11316",
  "issue_numbers": [
    "11293",
    "11293"
  ],
  "base_commit": "ef62c27528b726c0777b8f42b10b0c75d017e2d3",
  "patch": "diff --git a/src/parser/transform/expression/transform_subquery.cpp b/src/parser/transform/expression/transform_subquery.cpp\nindex 5b636890037a..33a9b1604bc4 100644\n--- a/src/parser/transform/expression/transform_subquery.cpp\n+++ b/src/parser/transform/expression/transform_subquery.cpp\n@@ -69,6 +69,12 @@ unique_ptr<ParsedExpression> Transformer::TransformSubquery(duckdb_libpgquery::P\n \t\tvector<unique_ptr<ParsedExpression>> children;\n \t\tchildren.push_back(std::move(columns_star));\n \t\tauto aggr = make_uniq<FunctionExpression>(\"array_agg\", std::move(children));\n+\t\tfor (auto &modifier : subquery_expr->subquery->node->modifiers) {\n+\t\t\tif (modifier->type == ResultModifierType::ORDER_MODIFIER) {\n+\t\t\t\taggr->order_bys = unique_ptr_cast<ResultModifier, OrderModifier>(modifier->Copy());\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n \t\t// ARRAY_AGG(COLUMNS(*)) IS NULL\n \t\tauto agg_is_null = make_uniq<OperatorExpression>(ExpressionType::OPERATOR_IS_NULL, aggr->Copy());\n \t\t// empty list\n",
  "test_patch": "diff --git a/test/sql/subquery/scalar/array_order_subquery.test b/test/sql/subquery/scalar/array_order_subquery.test\nnew file mode 100644\nindex 000000000000..d622e99df772\n--- /dev/null\n+++ b/test/sql/subquery/scalar/array_order_subquery.test\n@@ -0,0 +1,39 @@\n+# name: test/sql/subquery/scalar/array_order_subquery.test\n+# description: Issue #11293: Unstable ordering of array(subquery) function when using DISTINCT and ORDER BY in subquery\n+# group: [scalar]\n+\n+statement ok\n+PRAGMA enable_verification\n+\n+statement ok\n+create table t (i int);\n+\n+statement ok\n+insert into t values (1),(2),(3),(4),(4);\n+\n+query III\n+select\n+  array(select distinct i from t order by i desc) as a,\n+  array(select distinct i from t order by i desc) as b,\n+  array(select distinct i from t order by i desc) as c;\n+----\n+[4, 3, 2, 1]\t[4, 3, 2, 1]\t[4, 3, 2, 1]\n+\n+\n+# correlated\n+query I\n+select array(select unnest(l) AS i order by i desc nulls last) as a from (values ([NULL, 1, 2, 3, 4]), ([5, 6, NULL, 7, 8]), ([]), ([10, 11, 12])) t(l);\n+----\n+[4, 3, 2, 1, NULL]\n+[8, 7, 6, 5, NULL]\n+[]\n+[12, 11, 10]\n+\n+query I\n+select array(select unnest(l) AS i order by i desc nulls first) as a from (values ([NULL, 1, 2, 3, 4]), ([5, 6, NULL, 7, 8]), ([]), ([10, 11, 12])) t(l);\n+----\n+[NULL, 4, 3, 2, 1]\n+[NULL, 8, 7, 6, 5]\n+[]\n+[12, 11, 10]\n+\n",
  "problem_statement": "Unstable ordering of array(subquery) function when using DISTINCT and ORDER BY in subquery\n### What happens?\n\nThe `array(subquery)` function doesn't maintain ordering when combining `DISTINCT` with `ORDER BY`\n\n### To Reproduce\n\n```sql\r\ncreate table t (i int);\r\ninsert into t values (1),(2),(3),(4),(4);\r\nselect \r\n  array(select distinct i from t order by i desc) as a,\r\n  array(select distinct i from t order by i desc) as b,\r\n  array(select distinct i from t order by i desc) as c;\r\n```\r\n\r\nEvery time I run the query, I get a different result, e.g.\r\n\r\n```\r\n|a        |b        |c        |\r\n|---------|---------|---------|\r\n|[2,1,4,3]|[4,3,2,1]|[2,4,1,3]|\r\n```\r\n\r\nThis doesn't happen when I remove `DISTINCT`:\r\n\r\n```\r\n|a        |b        |c        |\r\n|---------|---------|---------|\r\n|[4,3,2,1]|[4,3,2,1]|[4,3,2,1]|\r\n```\r\n\r\nUsing a derived table doesn't help, the problem still exists:\r\n\r\n```sql\r\nselect \r\n  array(select * from (select distinct i from t) order by i desc) as a,\r\n  array(select * from (select distinct i from t) order by i desc) as b,\r\n  array(select * from (select distinct i from t) order by i desc) as c;\r\n```\r\n\r\nAs a workaround, I can use `GROUP BY`:\r\n\r\n```sql\r\nselect \r\n  array(select i from t group by i order by i desc) as a,\r\n  array(select i from t group by i order by i desc) as b,\r\n  array(select i from t group by i order by i desc) as c;\r\n```\r\n\r\nNote, I couldn't test the latest snapshots because of:\r\n\r\n- https://github.com/duckdb/duckdb/issues/11244\n\n### OS:\n\nMicrosoft Windows [Version 10.0.22631.3296]\n\n### DuckDB Version:\n\n0.10.0\n\n### DuckDB Client:\n\nJDBC\n\n### Full Name:\n\nLukas Eder\n\n### Affiliation:\n\nData Geekery\n\n### Have you tried this on the latest [nightly build](https://duckdb.org/docs/installation/?version=main)?\n\nI have tested with a release build (and could not test with a nightly build)\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] Yes, I have\nUnstable ordering of array(subquery) function when using DISTINCT and ORDER BY in subquery\n### What happens?\n\nThe `array(subquery)` function doesn't maintain ordering when combining `DISTINCT` with `ORDER BY`\n\n### To Reproduce\n\n```sql\r\ncreate table t (i int);\r\ninsert into t values (1),(2),(3),(4),(4);\r\nselect \r\n  array(select distinct i from t order by i desc) as a,\r\n  array(select distinct i from t order by i desc) as b,\r\n  array(select distinct i from t order by i desc) as c;\r\n```\r\n\r\nEvery time I run the query, I get a different result, e.g.\r\n\r\n```\r\n|a        |b        |c        |\r\n|---------|---------|---------|\r\n|[2,1,4,3]|[4,3,2,1]|[2,4,1,3]|\r\n```\r\n\r\nThis doesn't happen when I remove `DISTINCT`:\r\n\r\n```\r\n|a        |b        |c        |\r\n|---------|---------|---------|\r\n|[4,3,2,1]|[4,3,2,1]|[4,3,2,1]|\r\n```\r\n\r\nUsing a derived table doesn't help, the problem still exists:\r\n\r\n```sql\r\nselect \r\n  array(select * from (select distinct i from t) order by i desc) as a,\r\n  array(select * from (select distinct i from t) order by i desc) as b,\r\n  array(select * from (select distinct i from t) order by i desc) as c;\r\n```\r\n\r\nAs a workaround, I can use `GROUP BY`:\r\n\r\n```sql\r\nselect \r\n  array(select i from t group by i order by i desc) as a,\r\n  array(select i from t group by i order by i desc) as b,\r\n  array(select i from t group by i order by i desc) as c;\r\n```\r\n\r\nNote, I couldn't test the latest snapshots because of:\r\n\r\n- https://github.com/duckdb/duckdb/issues/11244\n\n### OS:\n\nMicrosoft Windows [Version 10.0.22631.3296]\n\n### DuckDB Version:\n\n0.10.0\n\n### DuckDB Client:\n\nJDBC\n\n### Full Name:\n\nLukas Eder\n\n### Affiliation:\n\nData Geekery\n\n### Have you tried this on the latest [nightly build](https://duckdb.org/docs/installation/?version=main)?\n\nI have tested with a release build (and could not test with a nightly build)\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] Yes, I have\n",
  "hints_text": "Possibly related:\r\n\r\n- https://github.com/duckdb/duckdb/issues/11269\nPossibly related:\r\n\r\n- https://github.com/duckdb/duckdb/issues/11269",
  "created_at": "2024-03-22T18:13:25Z"
}