{
  "repo": "duckdb/duckdb",
  "pull_number": 2196,
  "instance_id": "duckdb__duckdb-2196",
  "issue_numbers": [
    "2194"
  ],
  "base_commit": "9faff5bbc1efad0845e2d0482fe0ee8fe7c2ba06",
  "patch": "diff --git a/extension/parquet/parquet-extension.cpp b/extension/parquet/parquet-extension.cpp\nindex 0eb57ea17358..0e58fccfe032 100644\n--- a/extension/parquet/parquet-extension.cpp\n+++ b/extension/parquet/parquet-extension.cpp\n@@ -80,7 +80,13 @@ class ParquetScanFunction {\n \t                                                vector<string> &expected_names,\n \t                                                vector<LogicalType> &expected_types) {\n \t\tfor (auto &option : info.options) {\n-\t\t\tthrow NotImplementedException(\"Unsupported option for COPY FROM parquet: %s\", option.first);\n+\t\t\tauto loption = StringUtil::Lower(option.first);\n+\t\t\tif (loption == \"compression\" || loption == \"codec\") {\n+\t\t\t\t// CODEC option has no effect on parquet read: we determine codec from the file\n+\t\t\t\tcontinue;\n+\t\t\t} else {\n+\t\t\t\tthrow NotImplementedException(\"Unsupported option for COPY FROM parquet: %s\", option.first);\n+\t\t\t}\n \t\t}\n \t\tauto result = make_unique<ParquetReadBindData>();\n \n",
  "test_patch": "diff --git a/test/sql/export/parquet_export.test b/test/sql/export/parquet_export.test\nindex fb69827bd2ea..37bff3abc579 100644\n--- a/test/sql/export/parquet_export.test\n+++ b/test/sql/export/parquet_export.test\n@@ -38,4 +38,35 @@ SELECT SUM(i), SUM(j) FROM integers\n statement error\n INSERT INTO integers VALUES (NULL, NULL)\n \n+statement ok\n+DROP TABLE integers\n+\n+# now do it with a codec specified\n+statement ok\n+BEGIN TRANSACTION\n+\n+statement ok\n+CREATE TABLE integers(i INTEGER NOT NULL, j INTEGER)\n+\n+statement ok\n+INSERT INTO integers SELECT i, i+1 FROM range(0, 1000) tbl(i)\n+\n+query II nosort sumresult\n+SELECT SUM(i), SUM(j) FROM integers\n+\n+statement ok\n+EXPORT DATABASE '__TEST_DIR__/export_test' (FORMAT PARQUET, CODEC 'SNAPPY')\n+\n+statement ok\n+ROLLBACK\n+\n+statement ok\n+IMPORT DATABASE '__TEST_DIR__/export_test'\n \n+# verify the data is still there\n+query II nosort sumresult\n+SELECT SUM(i), SUM(j) FROM integers\n+\n+# verify that the not null constraint is still there\n+statement error\n+INSERT INTO integers VALUES (NULL, NULL)\n",
  "problem_statement": "EXPORT database using 'codec zstd' writes a broken load.sql file\n**What does happen?**\r\n\r\nI create a database 'main' with a single table 'data' loaded from a parquet file.  I store the database to disk:\r\n\r\nEXPORT database 'datastore' (format parquet, codec zstd);\r\n\r\nThis successfully writes out the the parquet file and two sql files to the 'datastore' subfolder.  Here are the contents of the load.sql file:\r\n\r\nload.sql:\r\nCOPY \"data\" FROM 'datastore\\0_data.parquet' (FORMAT 'parquet', codec 'zstd');\r\n\r\nNow I exit duckdb and start a new session.  I attempt to import the saved database:\r\n\r\nIMPORT DATABASE 'datastore';\r\nError: Not implemented Error: Unsupported option for COPY FROM parquet: codec\r\n\r\nThe 'data' table is created but empty, due to the error.\r\n\r\nI edit the load.sql to remove the Codec part:\r\nCOPY \"data\" FROM 'datastore\\0_data.parquet' (FORMAT 'parquet');\r\n\r\nI drop the empty 'data' table then try again importing the database:\r\n\r\nIMPORT DATABASE 'datastore';\r\nOK\r\n\r\nEverything's fine.  It creates the 'data' table and populates it.\r\n\r\n\r\n**What should happen?**\r\nApparently for the IMPORT function, when it comes to loading parquet databases, duckdb is smart enough to know what kind of compression is in use and does not like it when you specify the Codec option.  Therefore, I suppose when creating the load.sql file it should not add the Codec option??\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior. Bonus points if those are only SQL queries.\r\n1. EXPORT your in-memory database in parquet format using zstd compression, as described above\r\n2. restart your duckdb session\r\n3. run: IMPORT DATABASE 'your_database';\r\n4. see if you get the same error: \"Error: Not implemented Error: Unsupported option for COPY FROM parquet: codec\". If so...\r\n5. restart your duckdb session\r\n6. edit your database load.sql file as described above\r\n7. run: IMPORT DATABASE 'your_database';\r\n8. see if your database loaded fine this with the modified load.sql file.\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Windows 10 1909\r\n - DuckDB Version: CLI 0.2.7\r\n\r\n\n",
  "hints_text": "",
  "created_at": "2021-08-28T15:41:24Z"
}