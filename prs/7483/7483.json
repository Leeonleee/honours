{
  "repo": "duckdb/duckdb",
  "pull_number": 7483,
  "instance_id": "duckdb__duckdb-7483",
  "issue_numbers": [
    "6234",
    "6234"
  ],
  "base_commit": "599c3b68c2dbaf082d589b1922851abf2660377a",
  "patch": "diff --git a/src/catalog/catalog_search_path.cpp b/src/catalog/catalog_search_path.cpp\nindex 1ce30a897332..b7c6a882e3df 100644\n--- a/src/catalog/catalog_search_path.cpp\n+++ b/src/catalog/catalog_search_path.cpp\n@@ -145,6 +145,11 @@ void CatalogSearchPath::Set(vector<CatalogSearchEntry> new_paths, bool is_set_sc\n \t\t\t                       is_set_schema ? \"schema\" : \"search_path\", path.ToString());\n \t\t}\n \t}\n+\tif (is_set_schema) {\n+\t\tif (new_paths[0].catalog == TEMP_CATALOG || new_paths[0].catalog == SYSTEM_CATALOG) {\n+\t\t\tthrow CatalogException(\"SET schema cannot be set to internal schema \\\"%s\\\"\", new_paths[0].catalog);\n+\t\t}\n+\t}\n \tthis->set_paths = std::move(new_paths);\n \tSetPaths(set_paths);\n }\ndiff --git a/src/catalog/catalog_set.cpp b/src/catalog/catalog_set.cpp\nindex 5efddd70bd25..60768df1d6b2 100644\n--- a/src/catalog/catalog_set.cpp\n+++ b/src/catalog/catalog_set.cpp\n@@ -84,7 +84,7 @@ bool CatalogSet::CreateEntry(CatalogTransaction transaction, const string &name,\n \t\t\tthrow InternalException(\"Attempting to create temporary entry \\\"%s\\\" in non-temporary catalog\", name);\n \t\t}\n \t\tif (!value->temporary && catalog.IsTemporaryCatalog() && name != DEFAULT_SCHEMA) {\n-\t\t\tthrow InternalException(\"Attempting to create non-temporary entry \\\"%s\\\" in temporary catalog\", name);\n+\t\t\tthrow InvalidInputException(\"Cannot create non-temporary entry \\\"%s\\\" in temporary catalog\", name);\n \t\t}\n \t}\n \t// lock the catalog for writing\n",
  "test_patch": "diff --git a/test/sql/settings/set_schema_temp_main.test b/test/sql/settings/set_schema_temp_main.test\nnew file mode 100644\nindex 000000000000..36159dbf6071\n--- /dev/null\n+++ b/test/sql/settings/set_schema_temp_main.test\n@@ -0,0 +1,25 @@\n+# name: test/sql/settings/set_schema_temp_main.test\n+# group: [settings]\n+\n+statement ok\n+pragma enable_verification;\n+\n+statement error\n+CREATE SCHEMA temp.s1;\n+----\n+Cannot create non-temporary entry \"s1\" in temporary catalog\n+\n+statement error\n+CREATE SCHEMA system.s1;\n+----\n+Cannot create schema in system catalog\n+\n+statement error\n+set schema = 'temp';\n+----\n+SET schema cannot be set to internal schema \"temp\"\n+\n+statement error\n+set schema = 'system';\n+----\n+SET schema cannot be set to internal schema \"system\"\n",
  "problem_statement": "set schema is acting funky\n### What happens?\n\nIn v 0.6.1 a configuration statement like `SET schema = '<schema>'` would set the current schema. It would fail if the configuration value was a non-existing schema.\r\n\r\nIn  v 0.6.2-dev things are different. I can do a SET SCHEMA='temp' even though no such schema is listed, but this now changes the current database to 'temp', and sets the schema to 'main'.\r\n\r\nAnd when I do set schema='system', that statement succeeds (or at least does not fail with an error message), but any subsequent statements fail with:\r\n\r\n> Error: Binder Error: Catalog \"\" does not exist!\r\n\r\nAlso, we can get a fatal error if we first set the schema to 'temp' and then do a CREATE SCHEMA statement (or probably, any CREATE statement)\n\n### To Reproduce\n\n```\r\nD select * from duckdb_schemas();\r\n+------+---------------+--------------+--------------------+----------+-----+\r\n| oid  | database_name | database_oid |    schema_name     | internal | sql |\r\n+------+---------------+--------------+--------------------+----------+-----+\r\n| 1335 | memory        | 4            | information_schema | true     |     |\r\n| 854  | memory        | 4            | main               | true     |     |\r\n| 1336 | memory        | 4            | pg_catalog         | true     |     |\r\n| 1337 | system        | 0            | information_schema | true     |     |\r\n| 6    | system        | 0            | main               | true     |     |\r\n| 1338 | system        | 0            | pg_catalog         | true     |     |\r\n| 1339 | temp          | 1280         | information_schema | true     |     |\r\n| 1281 | temp          | 1280         | main               | true     |     |\r\n| 1340 | temp          | 1280         | pg_catalog         | true     |     |\r\n+------+---------------+--------------+--------------------+----------+-----+\r\nD select * from duckdb_databases();\r\n+---------------+--------------+------+----------+--------+\r\n| database_name | database_oid | path | internal |  type  |\r\n+---------------+--------------+------+----------+--------+\r\n| memory        | 4            |      | false    | duckdb |\r\n| system        | 0            |      | true     | duckdb |\r\n| temp          | 1280         |      | true     | duckdb |\r\n+---------------+--------------+------+----------+--------+\r\nD select current_database(), current_schema();\r\n+--------------------+------------------+\r\n| current_database() | current_schema() |\r\n+--------------------+------------------+\r\n| memory             | main             |\r\n+--------------------+------------------+\r\nD set schema = 'information_schema';\r\nD select current_database(), current_schema();\r\n+--------------------+--------------------+\r\n| current_database() |  current_schema()  |\r\n+--------------------+--------------------+\r\n| memory             | information_schema |\r\n+--------------------+--------------------+\r\nD set schema = 'bla';\r\nError: Binder Error: Catalog \"bla\" does not exist!\r\nD select current_database(), current_schema();\r\n+--------------------+--------------------+\r\n| current_database() |  current_schema()  |\r\n+--------------------+--------------------+\r\n| memory             | information_schema |\r\n+--------------------+--------------------+\r\nD set schema = 'temp';\r\nD select current_database(), current_schema();\r\n+--------------------+------------------+\r\n| current_database() | current_schema() |\r\n+--------------------+------------------+\r\n| temp               | main             |\r\n+--------------------+------------------+\r\nD set schema = 'system';\r\nD select current_database(), current_schema();\r\nError: Binder Error: Catalog \"\" does not exist!\r\nD set schema = 'temp';\r\nD select current_database(), current_schema();\r\n+--------------------+------------------+\r\n| current_database() | current_schema() |\r\n+--------------------+------------------+\r\n| temp               | main             |\r\n+--------------------+------------------+\r\nD set schema='information_schema';\r\nD select current_database(), current_schema();\r\n+--------------------+--------------------+\r\n| current_database() |  current_schema()  |\r\n+--------------------+--------------------+\r\n| memory             | information_schema |\r\n+--------------------+--------------------+\r\nD set schema = 'temp';\r\nD create schema 'bla';\r\nError: INTERNAL Error: Attempting to create non-temporary entry \"bla\" in temporary catalog\r\nD select version();\r\nError: FATAL Error: Failed: database has been invalidated because of a previous fatal error. The database must be restarted prior to being used again.\r\nOriginal error: \"INTERNAL Error: Attempting to create non-temporary entry \"bla\" in temporary catalog\"\r\n```\n\n### OS:\n\nWindows 10 Pro\n\n### DuckDB Version:\n\nv0.6.2-dev2485\n\n### DuckDB Client:\n\nCLI (any)\n\n### Full Name:\n\nRoland Bouman\n\n### Affiliation:\n\nJust-Bi.nl (an EPAM company) \n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\nset schema is acting funky\n### What happens?\n\nIn v 0.6.1 a configuration statement like `SET schema = '<schema>'` would set the current schema. It would fail if the configuration value was a non-existing schema.\r\n\r\nIn  v 0.6.2-dev things are different. I can do a SET SCHEMA='temp' even though no such schema is listed, but this now changes the current database to 'temp', and sets the schema to 'main'.\r\n\r\nAnd when I do set schema='system', that statement succeeds (or at least does not fail with an error message), but any subsequent statements fail with:\r\n\r\n> Error: Binder Error: Catalog \"\" does not exist!\r\n\r\nAlso, we can get a fatal error if we first set the schema to 'temp' and then do a CREATE SCHEMA statement (or probably, any CREATE statement)\n\n### To Reproduce\n\n```\r\nD select * from duckdb_schemas();\r\n+------+---------------+--------------+--------------------+----------+-----+\r\n| oid  | database_name | database_oid |    schema_name     | internal | sql |\r\n+------+---------------+--------------+--------------------+----------+-----+\r\n| 1335 | memory        | 4            | information_schema | true     |     |\r\n| 854  | memory        | 4            | main               | true     |     |\r\n| 1336 | memory        | 4            | pg_catalog         | true     |     |\r\n| 1337 | system        | 0            | information_schema | true     |     |\r\n| 6    | system        | 0            | main               | true     |     |\r\n| 1338 | system        | 0            | pg_catalog         | true     |     |\r\n| 1339 | temp          | 1280         | information_schema | true     |     |\r\n| 1281 | temp          | 1280         | main               | true     |     |\r\n| 1340 | temp          | 1280         | pg_catalog         | true     |     |\r\n+------+---------------+--------------+--------------------+----------+-----+\r\nD select * from duckdb_databases();\r\n+---------------+--------------+------+----------+--------+\r\n| database_name | database_oid | path | internal |  type  |\r\n+---------------+--------------+------+----------+--------+\r\n| memory        | 4            |      | false    | duckdb |\r\n| system        | 0            |      | true     | duckdb |\r\n| temp          | 1280         |      | true     | duckdb |\r\n+---------------+--------------+------+----------+--------+\r\nD select current_database(), current_schema();\r\n+--------------------+------------------+\r\n| current_database() | current_schema() |\r\n+--------------------+------------------+\r\n| memory             | main             |\r\n+--------------------+------------------+\r\nD set schema = 'information_schema';\r\nD select current_database(), current_schema();\r\n+--------------------+--------------------+\r\n| current_database() |  current_schema()  |\r\n+--------------------+--------------------+\r\n| memory             | information_schema |\r\n+--------------------+--------------------+\r\nD set schema = 'bla';\r\nError: Binder Error: Catalog \"bla\" does not exist!\r\nD select current_database(), current_schema();\r\n+--------------------+--------------------+\r\n| current_database() |  current_schema()  |\r\n+--------------------+--------------------+\r\n| memory             | information_schema |\r\n+--------------------+--------------------+\r\nD set schema = 'temp';\r\nD select current_database(), current_schema();\r\n+--------------------+------------------+\r\n| current_database() | current_schema() |\r\n+--------------------+------------------+\r\n| temp               | main             |\r\n+--------------------+------------------+\r\nD set schema = 'system';\r\nD select current_database(), current_schema();\r\nError: Binder Error: Catalog \"\" does not exist!\r\nD set schema = 'temp';\r\nD select current_database(), current_schema();\r\n+--------------------+------------------+\r\n| current_database() | current_schema() |\r\n+--------------------+------------------+\r\n| temp               | main             |\r\n+--------------------+------------------+\r\nD set schema='information_schema';\r\nD select current_database(), current_schema();\r\n+--------------------+--------------------+\r\n| current_database() |  current_schema()  |\r\n+--------------------+--------------------+\r\n| memory             | information_schema |\r\n+--------------------+--------------------+\r\nD set schema = 'temp';\r\nD create schema 'bla';\r\nError: INTERNAL Error: Attempting to create non-temporary entry \"bla\" in temporary catalog\r\nD select version();\r\nError: FATAL Error: Failed: database has been invalidated because of a previous fatal error. The database must be restarted prior to being used again.\r\nOriginal error: \"INTERNAL Error: Attempting to create non-temporary entry \"bla\" in temporary catalog\"\r\n```\n\n### OS:\n\nWindows 10 Pro\n\n### DuckDB Version:\n\nv0.6.2-dev2485\n\n### DuckDB Client:\n\nCLI (any)\n\n### Full Name:\n\nRoland Bouman\n\n### Affiliation:\n\nJust-Bi.nl (an EPAM company) \n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "Probably, names of the internal databases 'temp' and 'system' should be prohibited as values for for `set schema`\nProbably, names of the internal databases 'temp' and 'system' should be prohibited as values for for `set schema`",
  "created_at": "2023-05-12T12:57:20Z"
}