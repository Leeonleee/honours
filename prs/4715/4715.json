{
  "repo": "duckdb/duckdb",
  "pull_number": 4715,
  "instance_id": "duckdb__duckdb-4715",
  "issue_numbers": [
    "4703",
    "4703"
  ],
  "base_commit": "3ccb7e6d91a9beafc6cb7356f606450f3e33a49a",
  "patch": "diff --git a/src/catalog/catalog_entry/table_catalog_entry.cpp b/src/catalog/catalog_entry/table_catalog_entry.cpp\nindex f9e19aad4277..a9d737f639c7 100644\n--- a/src/catalog/catalog_entry/table_catalog_entry.cpp\n+++ b/src/catalog/catalog_entry/table_catalog_entry.cpp\n@@ -441,7 +441,7 @@ unique_ptr<CatalogEntry> TableCatalogEntry::RemoveColumn(ClientContext &context,\n \t\treturn make_unique<TableCatalogEntry>(catalog, schema, (BoundCreateTableInfo *)bound_create_info.get(),\n \t\t                                      storage);\n \t}\n-\tauto new_storage = make_shared<DataTable>(context, *storage, removed_index);\n+\tauto new_storage = make_shared<DataTable>(context, *storage, columns[removed_index].StorageOid());\n \treturn make_unique<TableCatalogEntry>(catalog, schema, (BoundCreateTableInfo *)bound_create_info.get(),\n \t                                      new_storage);\n }\n@@ -863,7 +863,7 @@ void TableCatalogEntry::CommitAlter(AlterInfo &info) {\n \t\t}\n \t}\n \tD_ASSERT(removed_index != DConstants::INVALID_INDEX);\n-\tstorage->CommitDropColumn(removed_index);\n+\tstorage->CommitDropColumn(columns[removed_index].StorageOid());\n }\n \n void TableCatalogEntry::CommitDrop() {\n",
  "test_patch": "diff --git a/test/sql/alter/drop_col/test_drop_col_with_generated_cols.test b/test/sql/alter/drop_col/test_drop_col_with_generated_cols.test\nnew file mode 100644\nindex 000000000000..173c15ec8660\n--- /dev/null\n+++ b/test/sql/alter/drop_col/test_drop_col_with_generated_cols.test\n@@ -0,0 +1,18 @@\n+# name: test/sql/alter/drop_col/test_drop_col_with_generated_cols.test\n+# description: Test ALTER TABLE DROP COLUMN with generated cols in the table\n+# group: [drop_col]\n+\n+statement ok\n+create table t(i int, j as (2), k int, m as (3), n int);\n+\n+statement ok\n+alter table t drop column n;\n+\n+statement ok\n+alter table t drop column m;\n+\n+statement ok\n+alter table t drop column k;\n+\n+statement ok\n+alter table t drop column j;\n\\ No newline at end of file\n",
  "problem_statement": "Internal error when drop column with generated column presented.\n### What happens?\n\nInternal error when drop column with generated column presented.\r\n```sql\r\ncreate table t(i int, j as (2), k int);\r\nalter table t drop column k;\r\n```\n\n### To Reproduce\n\n```sql\r\ncreate table t(i int, j as (2), k int);\r\nalter table t drop column k;\r\nError: INTERNAL Error: Assertion triggered in file \"/data/zippond/git/duckdb_clean/src/storage/data_table.cpp\" on line 147: removed_column < column_definitions.size()\r\n```\n\n### OS:\n\nlinuxamd64\n\n### DuckDB Version:\n\nv0.5.1-dev126 3591cd172\n\n### DuckDB Client:\n\nCLI\n\n### Full Name:\n\nDong Zhi-peng\n\n### Affiliation:\n\nXJTU\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\nInternal error when drop column with generated column presented.\n### What happens?\n\nInternal error when drop column with generated column presented.\r\n```sql\r\ncreate table t(i int, j as (2), k int);\r\nalter table t drop column k;\r\n```\n\n### To Reproduce\n\n```sql\r\ncreate table t(i int, j as (2), k int);\r\nalter table t drop column k;\r\nError: INTERNAL Error: Assertion triggered in file \"/data/zippond/git/duckdb_clean/src/storage/data_table.cpp\" on line 147: removed_column < column_definitions.size()\r\n```\n\n### OS:\n\nlinuxamd64\n\n### DuckDB Version:\n\nv0.5.1-dev126 3591cd172\n\n### DuckDB Client:\n\nCLI\n\n### Full Name:\n\nDong Zhi-peng\n\n### Affiliation:\n\nXJTU\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "I will try to fix this.\nI will try to fix this.",
  "created_at": "2022-09-14T13:01:15Z"
}