{
  "repo": "duckdb/duckdb",
  "pull_number": 15260,
  "instance_id": "duckdb__duckdb-15260",
  "issue_numbers": [
    "15239",
    "15239"
  ],
  "base_commit": "bebfb9ddeb96259ce5b53cf23b46bfc6f5c1a342",
  "patch": "diff --git a/src/planner/binder/query_node/plan_subquery.cpp b/src/planner/binder/query_node/plan_subquery.cpp\nindex 4b5857f573e7..6e3f551be4cd 100644\n--- a/src/planner/binder/query_node/plan_subquery.cpp\n+++ b/src/planner/binder/query_node/plan_subquery.cpp\n@@ -457,6 +457,9 @@ unique_ptr<LogicalOperator> Binder::PlanLateralJoin(unique_ptr<LogicalOperator>\n \tvector<JoinCondition> conditions;\n \tvector<unique_ptr<Expression>> arbitrary_expressions;\n \tif (condition) {\n+\t\tif (condition->HasSubquery()) {\n+\t\t\tthrow BinderException(*condition, \"Subqueries are not supported in LATERAL join conditions\");\n+\t\t}\n \t\t// extract join conditions, if there are any\n \t\tLogicalComparisonJoin::ExtractJoinConditions(context, join_type, JoinRefType::REGULAR, left, right,\n \t\t                                             std::move(condition), conditions, arbitrary_expressions);\n",
  "test_patch": "diff --git a/test/fuzzer/public/lateral_join_subquery.test b/test/fuzzer/public/lateral_join_subquery.test\nnew file mode 100644\nindex 000000000000..30a2ce2f3acc\n--- /dev/null\n+++ b/test/fuzzer/public/lateral_join_subquery.test\n@@ -0,0 +1,14 @@\n+# name: test/fuzzer/public/lateral_join_subquery.test\n+# description: Subqueries in the join condition of lateral joins\n+# group: [public]\n+\n+statement ok\n+pragma enable_verification\n+\n+statement ok\n+CREATE TABLE t1 (c1 INT);\n+\n+statement error\n+FROM t1 INNER JOIN (SELECT t1.c1) ON (SELECT 42);\n+----\n+Subqueries are not supported in LATERAL join conditions\n",
  "problem_statement": "DuckDB Internal Error: Attempting to initialize state of expression of unknown type\n### What happens?\n\nThe latest version of the DuckDB (latest main: v1.1.4-dev3139 07780a0d22 and released version v1.1.3 19864453f7\r\n) triggers Internal Error when running the following SQL statement: \r\n\r\n```sql\r\nCREATE TABLE v00 (c01 INT, c02 STRING);\r\nPIVOT ( v00 AS ta03 INNER JOIN ( SELECT c02 ) ON 'any_string' IN ARRAY ( SELECT 'abc' ) ) ta04 USING c02;\r\n```\r\n\r\nHere is the stack trace from v1.1.4-dev3139 07780a0d22: \r\n\r\n```\r\n#0  duckdb::InternalException::InternalException (this=0x60d0000170d0, Python Exception <class 'gdb.error'> There is no member named _M_dataplus.: \r\nmsg=) at /home/duckdb/duckdb/src/common/exception.cpp:333\r\n#1  0x0000000002e4be16 in duckdb::ExpressionExecutor::InitializeState (expr=..., state=...) at /home/duckdb/duckdb/src/execution/expression_executor.cpp:166\r\n#2  0x0000000002e4a032 in duckdb::ExpressionExecutor::Initialize (this=0xefae18ffa44, expression=..., state=...)\r\n    at /home/duckdb/duckdb/src/execution/expression_executor.cpp:67\r\n#3  0x0000000002e471b2 in duckdb::ExpressionExecutor::AddExpression (this=<optimized out>, expr=...)\r\n    at /home/duckdb/duckdb/src/execution/expression_executor.cpp:60\r\n#4  0x0000000002e4775f in duckdb::ExpressionExecutor::ExpressionExecutor (this=0x60b000075cc8, context=..., expression=...)\r\n    at /home/duckdb/duckdb/src/execution/expression_executor.cpp:21\r\n#5  0x0000000009ee961a in duckdb::FilterState::FilterState (this=0x60b000075cb0, context=..., expr=...)\r\n    at /home/duckdb/duckdb/src/execution/operator/filter/physical_filter.cpp:26\r\n#6  0x0000000009ee65ce in duckdb::make_uniq<duckdb::FilterState, duckdb::ExecutionContext&, duckdb::Expression&> (args=..., args=...)\r\n    at ../../src/include/duckdb/common/helper.hpp:65\r\n#7  0x0000000009ee49b9 in duckdb::PhysicalFilter::GetOperatorState (this=<optimized out>, context=...)\r\n    at /home/duckdb/duckdb/src/execution/operator/filter/physical_filter.cpp:39\r\n#8  0x0000000003aa3520 in duckdb::PipelineExecutor::PipelineExecutor (this=<optimized out>, context_p=..., pipeline_p=...)\r\n    at /home/duckdb/duckdb/src/parallel/pipeline_executor.cpp:40\r\n#9  0x0000000003ae077e in duckdb::make_uniq<duckdb::PipelineExecutor, duckdb::ClientContext&, duckdb::Pipeline&> (args=..., args=...)\r\n    at ../../src/include/duckdb/common/helper.hpp:65\r\n#10 0x0000000003a8ba9c in duckdb::PipelineTask::ExecuteTask (this=0x607000087550, mode=<optimized out>) at /home/duckdb/duckdb/src/parallel/pipeline.cpp:34\r\n#11 0x0000000003a5acec in duckdb::ExecutorTask::Execute (this=0x607000087550, mode=<optimized out>) at /home/duckdb/duckdb/src/parallel/executor_task.cpp:49\r\n#12 0x0000000003ac2c3f in duckdb::TaskScheduler::ExecuteForever (this=<optimized out>, marker=<optimized out>)\r\n    at /home/duckdb/duckdb/src/parallel/task_scheduler.cpp:189\r\n#13 0x000077d7121c9df4 in ?? () from /lib/x86_64-linux-gnu/libstdc++.so.6\r\n#14 0x000077d7122dd609 in start_thread (arg=<optimized out>) at pthread_create.c:477\r\n#15 0x000077d711eaa353 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95\r\n```\n\n### To Reproduce\n\n1. Clone the DuckDB Git from the official repo.\r\n2. Checkout to the latest main (07780a0d22).\r\n3. Compile the DuckDB binary by using `make relassert`.\r\n4. Run the compiled DuckDB and input the following SQL:\r\n\r\n```sql\r\nCREATE TABLE v00 (c01 INT, c02 STRING);\r\nPIVOT ( v00 AS ta03 INNER JOIN ( SELECT c02 ) ON 'any_string' IN ARRAY ( SELECT 'abc' ) ) ta04 USING c02;\r\n```\n\n### OS:\n\nUbuntu 24.04 LTS\n\n### DuckDB Version:\n\nlatest main: v1.1.4-dev3139 07780a0d22 and released version v1.1.3 19864453f7\n\n### DuckDB Client:\n\ncli\n\n### Hardware:\n\n_No response_\n\n### Full Name:\n\nYu Liang\n\n### Affiliation:\n\nThe Pennsylvania State University\n\n### What is the latest build you tested with? If possible, we recommend testing with the latest nightly build.\n\nI have tested with a stable release\n\n### Did you include all relevant data sets for reproducing the issue?\n\nYes\n\n### Did you include all code required to reproduce the issue?\n\n- [X] Yes, I have\n\n### Did you include all relevant configuration (e.g., CPU architecture, Python version, Linux distribution) to reproduce the issue?\n\n- [X] Yes, I have\nDuckDB Internal Error: Attempting to initialize state of expression of unknown type\n### What happens?\n\nThe latest version of the DuckDB (latest main: v1.1.4-dev3139 07780a0d22 and released version v1.1.3 19864453f7\r\n) triggers Internal Error when running the following SQL statement: \r\n\r\n```sql\r\nCREATE TABLE v00 (c01 INT, c02 STRING);\r\nPIVOT ( v00 AS ta03 INNER JOIN ( SELECT c02 ) ON 'any_string' IN ARRAY ( SELECT 'abc' ) ) ta04 USING c02;\r\n```\r\n\r\nHere is the stack trace from v1.1.4-dev3139 07780a0d22: \r\n\r\n```\r\n#0  duckdb::InternalException::InternalException (this=0x60d0000170d0, Python Exception <class 'gdb.error'> There is no member named _M_dataplus.: \r\nmsg=) at /home/duckdb/duckdb/src/common/exception.cpp:333\r\n#1  0x0000000002e4be16 in duckdb::ExpressionExecutor::InitializeState (expr=..., state=...) at /home/duckdb/duckdb/src/execution/expression_executor.cpp:166\r\n#2  0x0000000002e4a032 in duckdb::ExpressionExecutor::Initialize (this=0xefae18ffa44, expression=..., state=...)\r\n    at /home/duckdb/duckdb/src/execution/expression_executor.cpp:67\r\n#3  0x0000000002e471b2 in duckdb::ExpressionExecutor::AddExpression (this=<optimized out>, expr=...)\r\n    at /home/duckdb/duckdb/src/execution/expression_executor.cpp:60\r\n#4  0x0000000002e4775f in duckdb::ExpressionExecutor::ExpressionExecutor (this=0x60b000075cc8, context=..., expression=...)\r\n    at /home/duckdb/duckdb/src/execution/expression_executor.cpp:21\r\n#5  0x0000000009ee961a in duckdb::FilterState::FilterState (this=0x60b000075cb0, context=..., expr=...)\r\n    at /home/duckdb/duckdb/src/execution/operator/filter/physical_filter.cpp:26\r\n#6  0x0000000009ee65ce in duckdb::make_uniq<duckdb::FilterState, duckdb::ExecutionContext&, duckdb::Expression&> (args=..., args=...)\r\n    at ../../src/include/duckdb/common/helper.hpp:65\r\n#7  0x0000000009ee49b9 in duckdb::PhysicalFilter::GetOperatorState (this=<optimized out>, context=...)\r\n    at /home/duckdb/duckdb/src/execution/operator/filter/physical_filter.cpp:39\r\n#8  0x0000000003aa3520 in duckdb::PipelineExecutor::PipelineExecutor (this=<optimized out>, context_p=..., pipeline_p=...)\r\n    at /home/duckdb/duckdb/src/parallel/pipeline_executor.cpp:40\r\n#9  0x0000000003ae077e in duckdb::make_uniq<duckdb::PipelineExecutor, duckdb::ClientContext&, duckdb::Pipeline&> (args=..., args=...)\r\n    at ../../src/include/duckdb/common/helper.hpp:65\r\n#10 0x0000000003a8ba9c in duckdb::PipelineTask::ExecuteTask (this=0x607000087550, mode=<optimized out>) at /home/duckdb/duckdb/src/parallel/pipeline.cpp:34\r\n#11 0x0000000003a5acec in duckdb::ExecutorTask::Execute (this=0x607000087550, mode=<optimized out>) at /home/duckdb/duckdb/src/parallel/executor_task.cpp:49\r\n#12 0x0000000003ac2c3f in duckdb::TaskScheduler::ExecuteForever (this=<optimized out>, marker=<optimized out>)\r\n    at /home/duckdb/duckdb/src/parallel/task_scheduler.cpp:189\r\n#13 0x000077d7121c9df4 in ?? () from /lib/x86_64-linux-gnu/libstdc++.so.6\r\n#14 0x000077d7122dd609 in start_thread (arg=<optimized out>) at pthread_create.c:477\r\n#15 0x000077d711eaa353 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95\r\n```\n\n### To Reproduce\n\n1. Clone the DuckDB Git from the official repo.\r\n2. Checkout to the latest main (07780a0d22).\r\n3. Compile the DuckDB binary by using `make relassert`.\r\n4. Run the compiled DuckDB and input the following SQL:\r\n\r\n```sql\r\nCREATE TABLE v00 (c01 INT, c02 STRING);\r\nPIVOT ( v00 AS ta03 INNER JOIN ( SELECT c02 ) ON 'any_string' IN ARRAY ( SELECT 'abc' ) ) ta04 USING c02;\r\n```\n\n### OS:\n\nUbuntu 24.04 LTS\n\n### DuckDB Version:\n\nlatest main: v1.1.4-dev3139 07780a0d22 and released version v1.1.3 19864453f7\n\n### DuckDB Client:\n\ncli\n\n### Hardware:\n\n_No response_\n\n### Full Name:\n\nYu Liang\n\n### Affiliation:\n\nThe Pennsylvania State University\n\n### What is the latest build you tested with? If possible, we recommend testing with the latest nightly build.\n\nI have tested with a stable release\n\n### Did you include all relevant data sets for reproducing the issue?\n\nYes\n\n### Did you include all code required to reproduce the issue?\n\n- [X] Yes, I have\n\n### Did you include all relevant configuration (e.g., CPU architecture, Python version, Linux distribution) to reproduce the issue?\n\n- [X] Yes, I have\n",
  "hints_text": "\n",
  "created_at": "2024-12-10T18:28:01Z"
}