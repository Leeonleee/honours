{
  "repo": "duckdb/duckdb",
  "pull_number": 6657,
  "instance_id": "duckdb__duckdb-6657",
  "issue_numbers": [
    "6651",
    "6651"
  ],
  "base_commit": "d967b11e3a6ebdc982a87124c30588369462bce1",
  "patch": "diff --git a/src/include/duckdb/storage/table/update_segment.hpp b/src/include/duckdb/storage/table/update_segment.hpp\nindex 857908b55ee2..fcb43931967d 100644\n--- a/src/include/duckdb/storage/table/update_segment.hpp\n+++ b/src/include/duckdb/storage/table/update_segment.hpp\n@@ -34,7 +34,6 @@ class UpdateSegment {\n \tbool HasUncommittedUpdates(idx_t vector_index);\n \tbool HasUpdates(idx_t vector_index) const;\n \tbool HasUpdates(idx_t start_row_idx, idx_t end_row_idx);\n-\tvoid ClearUpdates();\n \n \tvoid FetchUpdates(TransactionData transaction, idx_t vector_index, Vector &result);\n \tvoid FetchCommitted(idx_t vector_index, Vector &result);\ndiff --git a/src/storage/table/update_segment.cpp b/src/storage/table/update_segment.cpp\nindex 165c70b4ef53..697f76125a8c 100644\n--- a/src/storage/table/update_segment.cpp\n+++ b/src/storage/table/update_segment.cpp\n@@ -38,7 +38,17 @@ UpdateSegment::UpdateSegment(UpdateSegment &other, ColumnData &owner)\n     : column_data(owner), root(std::move(other.root)), stats(std::move(other.stats)), type_size(other.type_size) {\n \n \tthis->heap.Move(other.heap);\n-\n+\t// update the segment links\n+\tif (root) {\n+\t\tfor (idx_t i = 0; i < RowGroup::ROW_GROUP_VECTOR_COUNT; i++) {\n+\t\t\tif (!root->info[i]) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\t\t\tfor (auto info = root->info[i]->info.get(); info; info = info->next) {\n+\t\t\t\tinfo->segment = this;\n+\t\t\t}\n+\t\t}\n+\t}\n \tinitialize_update_function = other.initialize_update_function;\n \tmerge_update_function = other.merge_update_function;\n \tfetch_update_function = other.fetch_update_function;\n@@ -52,12 +62,6 @@ UpdateSegment::UpdateSegment(UpdateSegment &other, ColumnData &owner)\n UpdateSegment::~UpdateSegment() {\n }\n \n-void UpdateSegment::ClearUpdates() {\n-\tstats.statistics.Copy(BaseStatistics::CreateEmpty(stats.statistics.GetType()));\n-\troot.reset();\n-\theap.Destroy();\n-}\n-\n //===--------------------------------------------------------------------===//\n // Update Info Helpers\n //===--------------------------------------------------------------------===//\n",
  "test_patch": "diff --git a/test/sql/update/update_after_commit.test b/test/sql/update/update_after_commit.test\nnew file mode 100644\nindex 000000000000..9a6525e97908\n--- /dev/null\n+++ b/test/sql/update/update_after_commit.test\n@@ -0,0 +1,29 @@\n+# name: test/sql/update/update_after_commit.test\n+# description: Issue #6651 - Crash When Updating after Commit\n+# group: [update]\n+\n+statement ok\n+PRAGMA enable_verification\n+\n+statement ok\n+CREATE TABLE a (b int);\n+\n+statement ok\n+BEGIN;\n+\n+statement ok\n+INSERT INTO a VALUES (1);\n+\n+statement ok\n+UPDATE a SET b = b + 10;\n+\n+statement ok\n+COMMIT;\n+\n+statement ok\n+UPDATE a SET b = b + 10;\n+\n+query I\n+SELECT * FROM a\n+----\n+21\n",
  "problem_statement": "Crash When Updating after Commit\n### What happens?\n\nCrash.\n\n### To Reproduce\n\n```sql\r\nCREATE TABLE a (b int);\r\nBEGIN; -- or START TRANSACTION\r\nINSERT INTO a VALUES (1);\r\nUPDATE a SET b = b + 10;\r\nCOMMIT;\r\nUPDATE a SET b = b + 10; -- segmentation fault\r\n```\n\n### OS:\n\nWSL2-ubuntu22.04 and macOS13.2.1\n\n### DuckDB Version:\n\nduckdb-v0.7.1 b00b93f0b1\n\n### DuckDB Client:\n\nCLI\n\n### Full Name:\n\nSuyang Zhong\n\n### Affiliation:\n\nNUS\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\nCrash When Updating after Commit\n### What happens?\n\nCrash.\n\n### To Reproduce\n\n```sql\r\nCREATE TABLE a (b int);\r\nBEGIN; -- or START TRANSACTION\r\nINSERT INTO a VALUES (1);\r\nUPDATE a SET b = b + 10;\r\nCOMMIT;\r\nUPDATE a SET b = b + 10; -- segmentation fault\r\n```\n\n### OS:\n\nWSL2-ubuntu22.04 and macOS13.2.1\n\n### DuckDB Version:\n\nduckdb-v0.7.1 b00b93f0b1\n\n### DuckDB Client:\n\nCLI\n\n### Full Name:\n\nSuyang Zhong\n\n### Affiliation:\n\nNUS\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "\n",
  "created_at": "2023-03-10T06:44:07Z"
}