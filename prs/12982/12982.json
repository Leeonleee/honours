{
  "repo": "duckdb/duckdb",
  "pull_number": 12982,
  "instance_id": "duckdb__duckdb-12982",
  "issue_numbers": [
    "12933"
  ],
  "base_commit": "7849f0c6eaff856e8fd0471f9cac9d629778d209",
  "patch": "diff --git a/src/execution/operator/aggregate/physical_window.cpp b/src/execution/operator/aggregate/physical_window.cpp\nindex 64080681ae5b..06af6e804295 100644\n--- a/src/execution/operator/aggregate/physical_window.cpp\n+++ b/src/execution/operator/aggregate/physical_window.cpp\n@@ -790,11 +790,22 @@ bool PhysicalWindow::SupportsBatchIndex() const {\n \t//\tWe can only preserve order for single partitioning\n \t//\tor work stealing causes out of order batch numbers\n \tauto &wexpr = select_list[order_idx]->Cast<BoundWindowExpression>();\n-\treturn wexpr.partitions.empty() && !wexpr.orders.empty();\n+\treturn wexpr.partitions.empty();\n }\n \n OrderPreservationType PhysicalWindow::SourceOrder() const {\n-\treturn SupportsBatchIndex() ? OrderPreservationType::FIXED_ORDER : OrderPreservationType::NO_ORDER;\n+\tauto &wexpr = select_list[order_idx]->Cast<BoundWindowExpression>();\n+\tif (!wexpr.partitions.empty()) {\n+\t\t// if we have partitions the window order is not defined\n+\t\treturn OrderPreservationType::NO_ORDER;\n+\t}\n+\t// without partitions we can maintain order\n+\tif (wexpr.orders.empty()) {\n+\t\t// if we have no orders we maintain insertion order\n+\t\treturn OrderPreservationType::INSERTION_ORDER;\n+\t}\n+\t// otherwise we can maintain the fixed order\n+\treturn OrderPreservationType::FIXED_ORDER;\n }\n \n double PhysicalWindow::GetProgress(ClientContext &context, GlobalSourceState &gsource_p) const {\n",
  "test_patch": "diff --git a/test/sql/limit/test_parallel_limit.test_slow b/test/sql/limit/test_parallel_limit.test_slow\nindex 429432fb9ed0..177f7f14cf23 100644\n--- a/test/sql/limit/test_parallel_limit.test_slow\n+++ b/test/sql/limit/test_parallel_limit.test_slow\n@@ -71,6 +71,26 @@ SELECT * FROM integers WHERE i>4978321 LIMIT 5 OFFSET 1000000;\n 5978325\n 5978326\n \n+# insertion order preservation with window functions\n+query II\n+SELECT i, lead(i, 1) over () FROM integers LIMIT 5 OFFSET 4978321;\n+----\n+4978321\t4978322\n+4978322\t4978323\n+4978323\t4978324\n+4978324\t4978325\n+4978325\t4978326\n+\n+# large lead\n+query II\n+SELECT i, lead(i, 100000) over () FROM integers LIMIT 5 OFFSET 4978321;\n+----\n+4978321\t5078321\n+4978322\t5078322\n+4978323\t5078323\n+4978324\t5078324\n+4978325\t5078325\n+\n # IN-clause (semi join)\n query I sort\n SELECT * FROM integers WHERE i IN (SELECT * FROM other_table)\n",
  "problem_statement": "CSV reader on .zst and lag/lead: line order is not preserved \n### What happens?\r\n\r\nWhen using `read_csv()` to read from a .zst-compressedfile and using `lead(line, 1) over ()`, the positions of the rows in the resultset do not match the positions of the corresponding lines in the file, even though the `preserve_insertion_order` is set to `TRUE` (default). (`lag(line, 1) over ()` shows similar behavior)\r\n\r\nWIth a plain, uncompressed text file, the order is as expected.\r\nInterestingly, adding `row_number() over ()` seems to remedy the issue.\r\n\r\n### To Reproduce\r\n\r\n```sql\r\nSELECT  line\r\n,       lead(line, 1) over () as next_line\r\nFROM    read_csv(\r\n          'https://database.lichess.org/standard/lichess_db_standard_rated_2013-01.pgn.zst'\r\n        , columns = {'line': 'VARCHAR'}\r\n        )\r\nLIMIT 20;\r\n```\r\n\r\noutput:\r\n\r\n```\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502         line         \u2502                                                                next_line                                                                 \u2502\r\n\u2502       varchar        \u2502                                                                 varchar                                                                  \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 [BlackElo \"1855\"]    \u2502 [WhiteRatingDiff \"+13\"]                                                                                                                  \u2502\r\n\u2502 [WhiteRatingDiff \".  \u2502 [BlackRatingDiff \"-15\"]                                                                                                                  \u2502\r\n\u2502 [BlackRatingDiff \".  \u2502 [ECO \"C00\"]                                                                                                                              \u2502\r\n\u2502 [ECO \"C00\"]          \u2502 [Opening \"Queen's Pawn Game: Franco-Sicilian Defense\"]                                                                                   \u2502\r\n\u2502 [Opening \"Queen's .  \u2502 [TimeControl \"60+0\"]                                                                                                                     \u2502\r\n\u2502 [TimeControl \"60+0\"] \u2502 [Termination \"Normal\"]                                                                                                                   \u2502\r\n\u2502 [Termination \"Norm.  \u2502                                                                                                                                          \u2502\r\n\u2502                      \u2502 1. e4 c5 2. d4 e6 3. dxc5 Bxc5 4. Nf3 Be7 5. c4 d5 6. cxd5 exd5 7. exd5 Nf6 8. Nc3 O-O 9. Bg5 h6 10. Bxf6 Bxf6 11. Be2 Re8 12. O-O Bg4.  \u2502\r\n\u2502 1. e4 c5 2. d4 e6 .  \u2502                                                                                                                                          \u2502\r\n\u2502                      \u2502 [Event \"Rated Bullet game\"]                                                                                                              \u2502\r\n\u2502 [Event \"Rated Bull.  \u2502 [Site \"https://lichess.org/4op0p4eh\"]                                                                                                    \u2502\r\n\u2502 [Site \"https://lic.  \u2502 [White \"LEGENDARY_ERFAN\"]                                                                                                                \u2502\r\n\u2502 [White \"LEGENDARY_.  \u2502 [Black \"RookieRook\"]                                                                                                                     \u2502\r\n\u2502 [Black \"RookieRook\"] \u2502 [Result \"0-1\"]                                                                                                                           \u2502\r\n\u2502 [Result \"0-1\"]       \u2502 [UTCDate \"2013.01.01\"]                                                                                                                   \u2502\r\n\u2502 [UTCDate \"2013.01..  \u2502 [UTCTime \"02:16:18\"]                                                                                                                     \u2502\r\n\u2502 [UTCTime \"02:16:18\"] \u2502 [WhiteElo \"1395\"]                                                                                                                        \u2502\r\n\u2502 [WhiteElo \"1395\"]    \u2502 [BlackElo \"1525\"]                                                                                                                        \u2502\r\n\u2502 [BlackElo \"1525\"]    \u2502 [WhiteRatingDiff \"-18\"]                                                                                                                  \u2502\r\n\u2502 [WhiteRatingDiff \".  \u2502 [BlackRatingDiff \"+8\"]                                                                                                                   \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 20 rows                                                                                                                                               2 columns \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\nQuery demonstrating line order as it appears in file:\r\n\r\n```sql\r\nSELECT  line\r\nFROM    read_csv(\r\n          'https://database.lichess.org/standard/lichess_db_standard_rated_2013-01.pgn.zst'\r\n        , columns = {'line': 'VARCHAR'}\r\n        )\r\nLIMIT 20;\r\n```\r\n\r\nOutput:\r\n```\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502                                                                        line                                                                        \u2502\r\n\u2502                                                                      varchar                                                                       \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 [Event \"Rated Classical game\"]                                                                                                                     \u2502\r\n\u2502 [Site \"https://lichess.org/j1dkb5dw\"]                                                                                                              \u2502\r\n\u2502 [White \"BFG9k\"]                                                                                                                                    \u2502\r\n\u2502 [Black \"mamalak\"]                                                                                                                                  \u2502\r\n\u2502 [Result \"1-0\"]                                                                                                                                     \u2502\r\n\u2502 [UTCDate \"2012.12.31\"]                                                                                                                             \u2502\r\n\u2502 [UTCTime \"23:01:03\"]                                                                                                                               \u2502\r\n\u2502 [WhiteElo \"1639\"]                                                                                                                                  \u2502\r\n\u2502 [BlackElo \"1403\"]                                                                                                                                  \u2502\r\n\u2502 [WhiteRatingDiff \"+5\"]                                                                                                                             \u2502\r\n\u2502 [BlackRatingDiff \"-8\"]                                                                                                                             \u2502\r\n\u2502 [ECO \"C00\"]                                                                                                                                        \u2502\r\n\u2502 [Opening \"French Defense: Normal Variation\"]                                                                                                       \u2502\r\n\u2502 [TimeControl \"600+8\"]                                                                                                                              \u2502\r\n\u2502 [Termination \"Normal\"]                                                                                                                             \u2502\r\n\u2502                                                                                                                                                    \u2502\r\n\u2502 1. e4 e6 2. d4 b6 3. a3 Bb7 4. Nc3 Nh6 5. Bxh6 gxh6 6. Be2 Qg5 7. Bg4 h5 8. Nf3 Qg6 9. Nh4 Qg5 10. Bxh5 Qxh4 11. Qf3 Kd8 12. Qxf7 Nc6 13. Qe8# 1-0 \u2502\r\n\u2502                                                                                                                                                    \u2502\r\n\u2502 [Event \"Rated Classical game\"]                                                                                                                     \u2502\r\n\u2502 [Site \"https://lichess.org/a9tcp02g\"]                                                                                                              \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502                                                                      20 rows                                                                       \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\n### OS:\r\n\r\nwindows 11 enterprise\r\n\r\n### DuckDB Version:\r\n\r\nv1.0.0 1f98600c2c\r\n\r\n### DuckDB Client:\r\n\r\nCLI\r\n\r\n### Full Name:\r\n\r\nRoland Bouman\r\n\r\n### Affiliation:\r\n\r\nEPAM Systems BV Netherlands\r\n\r\n### What is the latest build you tested with? If possible, we recommend testing with the latest nightly build.\r\n\r\nI have tested with a nightly build\r\n\r\n### Did you include all relevant data sets for reproducing the issue?\r\n\r\nYes\r\n\r\n### Did you include all code required to reproduce the issue?\r\n\r\n- [X] Yes, I have\r\n\r\n### Did you include all relevant configuration (e.g., CPU architecture, Python version, Linux distribution) to reproduce the issue?\r\n\r\n- [X] Yes, I have\n",
  "hints_text": "Here are a few more observations that may be relevant to finding the cause/fixing it:\r\n\r\n1) With a similar `lag(line, 1) over()` expression, the result is different than from `lead(line, 1) over()`, but in both cases the order doesn't match line order\r\n2) If you open a new session, and first run the query with `lead()`, and then immediately after that, within the same session, the query with `lag()`, the result of the latter does match the line order!\r\n3) Adding `row_number() over () `seems to enforce the correct row order.",
  "created_at": "2024-07-13T17:46:25Z"
}