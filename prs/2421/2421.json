{
  "repo": "duckdb/duckdb",
  "pull_number": 2421,
  "instance_id": "duckdb__duckdb-2421",
  "issue_numbers": [
    "2407",
    "2407"
  ],
  "base_commit": "41b1cff3cb4bb65dd8a58f9929f696c3311e9731",
  "patch": "diff --git a/src/function/aggregate/distributive/arg_min_max.cpp b/src/function/aggregate/distributive/arg_min_max.cpp\nindex 5b58395e0102..92bf11545b71 100644\n--- a/src/function/aggregate/distributive/arg_min_max.cpp\n+++ b/src/function/aggregate/distributive/arg_min_max.cpp\n@@ -107,10 +107,10 @@ template <class OP, class T>\n AggregateFunction GetArgMinMaxFunctionArg2(LogicalTypeId arg_2, const LogicalType &arg) {\n \tswitch (arg_2) {\n \tcase LogicalTypeId::INTEGER:\n-\t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, int>, T, int, T, OP>(arg, LogicalType::INTEGER,\n-\t\t                                                                                 arg);\n+\t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, int32_t>, T, int32_t, T, OP>(\n+\t\t    arg, LogicalType::INTEGER, arg);\n \tcase LogicalTypeId::BIGINT:\n-\t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, uint64_t>, T, uint64_t, T, OP>(\n+\t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, int64_t>, T, int64_t, T, OP>(\n \t\t    arg, LogicalType::BIGINT, arg);\n \tcase LogicalTypeId::DOUBLE:\n \t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, double>, T, double, T, OP>(arg, LogicalType::DOUBLE,\n@@ -119,10 +119,10 @@ AggregateFunction GetArgMinMaxFunctionArg2(LogicalTypeId arg_2, const LogicalTyp\n \t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, string_t>, T, string_t, T, OP>(\n \t\t    arg, LogicalType::VARCHAR, arg);\n \tcase LogicalTypeId::DATE:\n-\t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, uint64_t>, T, uint64_t, T, OP>(\n-\t\t    arg, LogicalType::DATE, arg);\n+\t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, date_t>, T, date_t, T, OP>(arg, LogicalType::DATE,\n+\t\t                                                                                       arg);\n \tcase LogicalTypeId::TIMESTAMP:\n-\t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, uint64_t>, T, uint64_t, T, OP>(\n+\t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, timestamp_t>, T, timestamp_t, T, OP>(\n \t\t    arg, LogicalType::TIMESTAMP, arg);\n \tcase LogicalTypeId::BLOB:\n \t\treturn AggregateFunction::BinaryAggregate<ArgMinMaxState<T, string_t>, T, string_t, T, OP>(\n@@ -136,13 +136,13 @@ template <class OP>\n void GetArgMinMaxFunction(LogicalTypeId arg_1, AggregateFunctionSet &fun) {\n \tswitch (arg_1) {\n \tcase LogicalTypeId::INTEGER:\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int>(LogicalTypeId::INTEGER, LogicalType::INTEGER));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int>(LogicalTypeId::BIGINT, LogicalType::INTEGER));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int>(LogicalTypeId::DOUBLE, LogicalType::INTEGER));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int>(LogicalTypeId::VARCHAR, LogicalType::INTEGER));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int>(LogicalTypeId::DATE, LogicalType::INTEGER));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int>(LogicalTypeId::TIMESTAMP, LogicalType::INTEGER));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int>(LogicalTypeId::BLOB, LogicalType::INTEGER));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int32_t>(LogicalTypeId::INTEGER, LogicalType::INTEGER));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int32_t>(LogicalTypeId::BIGINT, LogicalType::INTEGER));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int32_t>(LogicalTypeId::DOUBLE, LogicalType::INTEGER));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int32_t>(LogicalTypeId::VARCHAR, LogicalType::INTEGER));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int32_t>(LogicalTypeId::DATE, LogicalType::INTEGER));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int32_t>(LogicalTypeId::TIMESTAMP, LogicalType::INTEGER));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int32_t>(LogicalTypeId::BLOB, LogicalType::INTEGER));\n \t\tbreak;\n \tcase LogicalTypeId::BIGINT:\n \t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::INTEGER, LogicalType::BIGINT));\n@@ -172,22 +172,22 @@ void GetArgMinMaxFunction(LogicalTypeId arg_1, AggregateFunctionSet &fun) {\n \t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, string_t>(LogicalTypeId::BLOB, LogicalType::VARCHAR));\n \t\tbreak;\n \tcase LogicalTypeId::DATE:\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::INTEGER, LogicalType::DATE));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::BIGINT, LogicalType::DATE));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::DOUBLE, LogicalType::DATE));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::VARCHAR, LogicalType::DATE));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::DATE, LogicalType::DATE));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::TIMESTAMP, LogicalType::DATE));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::BLOB, LogicalType::DATE));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, date_t>(LogicalTypeId::INTEGER, LogicalType::DATE));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, date_t>(LogicalTypeId::BIGINT, LogicalType::DATE));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, date_t>(LogicalTypeId::DOUBLE, LogicalType::DATE));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, date_t>(LogicalTypeId::VARCHAR, LogicalType::DATE));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, date_t>(LogicalTypeId::DATE, LogicalType::DATE));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, date_t>(LogicalTypeId::TIMESTAMP, LogicalType::DATE));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, date_t>(LogicalTypeId::BLOB, LogicalType::DATE));\n \t\tbreak;\n \tcase LogicalTypeId::TIMESTAMP:\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::INTEGER, LogicalType::TIMESTAMP));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::BIGINT, LogicalType::TIMESTAMP));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::DOUBLE, LogicalType::TIMESTAMP));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::VARCHAR, LogicalType::TIMESTAMP));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::DATE, LogicalType::TIMESTAMP));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::TIMESTAMP, LogicalType::TIMESTAMP));\n-\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, int64_t>(LogicalTypeId::BLOB, LogicalType::TIMESTAMP));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, timestamp_t>(LogicalTypeId::INTEGER, LogicalType::TIMESTAMP));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, timestamp_t>(LogicalTypeId::BIGINT, LogicalType::TIMESTAMP));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, timestamp_t>(LogicalTypeId::DOUBLE, LogicalType::TIMESTAMP));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, timestamp_t>(LogicalTypeId::VARCHAR, LogicalType::TIMESTAMP));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, timestamp_t>(LogicalTypeId::DATE, LogicalType::TIMESTAMP));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, timestamp_t>(LogicalTypeId::TIMESTAMP, LogicalType::TIMESTAMP));\n+\t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, timestamp_t>(LogicalTypeId::BLOB, LogicalType::TIMESTAMP));\n \t\tbreak;\n \tcase LogicalTypeId::BLOB:\n \t\tfun.AddFunction(GetArgMinMaxFunctionArg2<OP, string_t>(LogicalTypeId::INTEGER, LogicalType::BLOB));\n",
  "test_patch": "diff --git a/test/issues/general/test_2407.test b/test/issues/general/test_2407.test\nnew file mode 100644\nindex 000000000000..8ebb08520de7\n--- /dev/null\n+++ b/test/issues/general/test_2407.test\n@@ -0,0 +1,39 @@\n+# name: test/issues/general/test_2407.test\n+# description: Issue 2407: arg_max/arg_min doesn't work properly with DATE\n+# group: [general]\n+\n+statement ok\n+PRAGMA enable_verification\n+\n+statement ok\n+CREATE TABLE test(d DATE, i INTEGER);\n+\n+statement ok\n+INSERT INTO test VALUES ('2021-01-01', 1), ('2021-02-01', 2), ('2021-03-01', 3), ('2021-04-01', 4);\n+\n+query II\n+select arg_max(i, d), arg_max(d, i) from test;\n+----\n+4\t2021-04-01\n+\n+query II\n+select arg_min(i, d), arg_min(d, i) from test;\n+----\n+1\t2021-01-01\n+\n+# bigint\n+statement ok\n+CREATE TABLE test2(d BIGINT, i INTEGER);\n+\n+statement ok\n+INSERT INTO test2 VALUES (-9223372036854775807, 1), (-1, 2), (1, 3), (9223372036854775807, 4);\n+\n+query II\n+select arg_max(i, d), arg_max(d, i) from test2;\n+----\n+4\t9223372036854775807\n+\n+query II\n+select arg_min(i, d), arg_min(d, i) from test2;\n+----\n+1\t-9223372036854775807\n",
  "problem_statement": "arg_max/arg_min doesn't work properly with DATE\n#### Environment:\r\n* SQLite v0.3.1-dev208 b948abc70 msvc-1929\r\n* SQLite v0.3.1-dev214 9981e8a3a gcc-10.2.1 20210110\r\n\r\n#### What does happen?\r\narg_min/max(&lt;column&gt;, &lt;date-column&gt;)  returns a value from &lt;column&gt;, but almost never the correct one.\r\n\r\narg_min/max(&lt;date-column&gt;, &lt;column&gt;) often returns an arbitrary date that's not even a value in &lt;date-column&gt;.\r\n\r\n#### To reproduce:\r\n\r\n(results are almost always wrong, but not in a reproducible way):\r\n\r\n\r\n```\r\nD CREATE TABLE test(d DATE, i INTEGER);\r\n\r\nD INSERT INTO test VALUES ('2021-01-01', 1), ('2021-02-01', 2), ('2021-03-01', 3), ('2021-04-01', 4);\r\n\r\nD select arg_max(i, d) from test;\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 arg_max(i, d) \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 2             \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\nD select arg_min(i, d) from test;\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 arg_min(i, d) \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 3             \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\nD select arg_max(d, i) from test;\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 arg_max(d, d) \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 2021-09-29    \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\narg_max/arg_min doesn't work properly with DATE\n#### Environment:\r\n* SQLite v0.3.1-dev208 b948abc70 msvc-1929\r\n* SQLite v0.3.1-dev214 9981e8a3a gcc-10.2.1 20210110\r\n\r\n#### What does happen?\r\narg_min/max(&lt;column&gt;, &lt;date-column&gt;)  returns a value from &lt;column&gt;, but almost never the correct one.\r\n\r\narg_min/max(&lt;date-column&gt;, &lt;column&gt;) often returns an arbitrary date that's not even a value in &lt;date-column&gt;.\r\n\r\n#### To reproduce:\r\n\r\n(results are almost always wrong, but not in a reproducible way):\r\n\r\n\r\n```\r\nD CREATE TABLE test(d DATE, i INTEGER);\r\n\r\nD INSERT INTO test VALUES ('2021-01-01', 1), ('2021-02-01', 2), ('2021-03-01', 3), ('2021-04-01', 4);\r\n\r\nD select arg_max(i, d) from test;\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 arg_max(i, d) \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 2             \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\nD select arg_min(i, d) from test;\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 arg_min(i, d) \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 3             \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\nD select arg_max(d, i) from test;\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502 arg_max(d, d) \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\r\n\u2502 2021-09-29    \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\n",
  "hints_text": "\n",
  "created_at": "2021-10-13T19:47:25Z"
}