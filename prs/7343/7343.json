{
  "repo": "duckdb/duckdb",
  "pull_number": 7343,
  "instance_id": "duckdb__duckdb-7343",
  "issue_numbers": [
    "7182",
    "4886"
  ],
  "base_commit": "aa20f173b1a4ca6e60c7595d59a61e2edf59e607",
  "patch": "diff --git a/src/execution/index/art/art.cpp b/src/execution/index/art/art.cpp\nindex 0cc55f5b0dc1..431e68d18b0f 100644\n--- a/src/execution/index/art/art.cpp\n+++ b/src/execution/index/art/art.cpp\n@@ -879,7 +879,11 @@ string ART::GenerateConstraintErrorMessage(VerifyExistenceType verify_type, cons\n \tcase VerifyExistenceType::APPEND: {\n \t\t// APPEND to PK/UNIQUE table, but node/key already exists in PK/UNIQUE table\n \t\tstring type = IsPrimary() ? \"primary key\" : \"unique\";\n-\t\treturn StringUtil::Format(\"Duplicate key \\\"%s\\\" violates %s constraint\", key_name, type);\n+\t\treturn StringUtil::Format(\n+\t\t    \"Duplicate key \\\"%s\\\" violates %s constraint. \"\n+\t\t    \"If this is an unexpected constraint violation please double \"\n+\t\t    \"check with the known index limitations section in our documentation (docs - sql - indexes).\",\n+\t\t    key_name, type);\n \t}\n \tcase VerifyExistenceType::APPEND_FK: {\n \t\t// APPEND_FK to FK table, node/key does not exist in PK/UNIQUE table\n",
  "test_patch": "diff --git a/test/sql/index/art/art_eager_constraint_checking.test b/test/sql/index/art/art_eager_constraint_checking.test\nnew file mode 100644\nindex 000000000000..ea10aac83d60\n--- /dev/null\n+++ b/test/sql/index/art/art_eager_constraint_checking.test\n@@ -0,0 +1,106 @@\n+# name: test/sql/index/art/art_eager_constraint_checking.test\n+# description: Contains different tests triggering the eager ART constraint violation\n+# group: [art]\n+\n+# issue 7182\n+\n+statement ok\n+CREATE TABLE t (it INTEGER PRIMARY KEY, jt INTEGER);\n+\n+statement ok\n+CREATE TABLE u (iu INTEGER PRIMARY KEY, ju INTEGER REFERENCES t (it));\n+\n+statement ok\n+INSERT INTO t VALUES (1, 1);\n+\n+statement ok\n+INSERT INTO u VALUES (1, NULL);\n+\n+statement error\n+UPDATE u SET ju = 1 WHERE iu = 1;\n+----\n+Constraint Error: Duplicate key \"iu: 1\" violates primary key constraint. If this is an unexpected constraint violation please double check with the known index limitations section in our documentation (docs - sql - indexes).\n+\n+# issue #5807\n+\n+statement ok\n+CREATE TABLE tunion (\n+  id INTEGER PRIMARY KEY,\n+  u UNION (i int));\n+\n+statement ok\n+INSERT INTO tunion\n+SELECT 1, 41;\n+\n+statement error\n+UPDATE tunion SET u = 42 WHERE id = 1;\n+----\n+Constraint Error: Duplicate key \"id: 1\" violates primary key constraint. If this is an unexpected constraint violation please double check with the known index limitations section in our documentation (docs - sql - indexes).\n+\n+# issue #5771\n+\n+statement ok\n+CREATE TABLE IF NOT EXISTS workers (\n+    id INTEGER PRIMARY KEY NOT NULL,\n+    worker VARCHAR(150) UNIQUE NOT NULL,\n+    phone VARCHAR(20) NOT NULL);\n+\n+statement ok\n+INSERT INTO workers VALUES (1, 'wagner', '123');\n+\n+statement ok\n+UPDATE workers SET phone = '345' WHERE id = 1;\n+\n+statement error\n+UPDATE workers SET worker = 'leo' WHERE id = 1;\n+----\n+Constraint Error: Duplicate key \"id: 1\" violates primary key constraint. If this is an unexpected constraint violation please double check with the known index limitations section in our documentation (docs - sql - indexes).\n+\n+# issue #4886\n+\n+statement ok\n+CREATE TABLE test (i INTEGER PRIMARY KEY);\n+\n+statement ok\n+INSERT INTO test VALUES (1);\n+\n+statement ok\n+START TRANSACTION;\n+\n+# we locally insert another value (4) into the ART, but do\n+# not update the global ART yet (no COMMIT)\n+statement ok\n+UPDATE test SET i = 4 WHERE i = 1;\n+\n+# global ART still contains the value 1, and we do not keep track of\n+# deletions from indexes during tx yet\n+statement error\n+INSERT INTO test VALUES (1);\n+----\n+Constraint Error: Duplicate key \"i: 1\" violates primary key constraint. If this is an unexpected constraint violation please double check with the known index limitations section in our documentation (docs - sql - indexes).\n+\n+statement ok\n+ROLLBACK\n+\n+# issue #1631\n+\n+statement ok\n+DROP TABLE IF EXISTS tbl;\n+\n+statement ok\n+CREATE TABLE tbl (\n+\tid INTEGER PRIMARY KEY,\n+\tsometext text NOT NULL UNIQUE,\n+\tsomeothertext text NOT NULL);\n+\n+statement ok\n+INSERT INTO tbl VALUES (1, 'abc', 'def'), (2, 'ghi', 'jkl');\n+\n+statement error\n+UPDATE tbl\n+SET sometext = 'ghi', someothertext = 'mno'\n+WHERE id = 2;\n+----\n+Constraint Error: Duplicate key \"id: 2\" violates primary key constraint. If this is an unexpected constraint violation please double check with the known index limitations section in our documentation (docs - sql - indexes).\n+\n+\n",
  "problem_statement": "Wrong constraint violation error reported when updating foreign key column\n### What happens?\n\nIt seems impossible to run an `UPDATE` statement on a (certain? all?) foreign key columns\n\n### To Reproduce\n\nThere should be nothing wrong with the following set of statements:\r\n\r\n```sql\r\ncreate table t (i int primary key, j int);\r\ncreate table u (i int primary key, j int references t (i));\r\n\r\ninsert into t values (1, 1);\r\ninsert into u values (1, null);\r\nupdate u set j = 1 where i = 1;\r\n```\r\n\r\nYet, the `UPDATE` can't be executed because of:\r\n\r\n> Constraint Error: Duplicate key \"i: 1\" violates primary key constraint\r\n\r\nInterestingly, if I update the primary key at the same time, I'm not running into this problem, so this workaround seems to do the trick:\r\n\r\n```sql\r\nupdate u set i = -1, j = 1 where i = 1;\r\nupdate u set i = 1 where i = -1;\r\n```\n\n### OS:\n\nMicrosoft Windows [Version 10.0.22621.1555]\n\n### DuckDB Version:\n\nv0.7.1\n\n### DuckDB Client:\n\nJDBC\n\n### Full Name:\n\nLukas Eder\n\n### Affiliation:\n\nData Geekery / jOOQ\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\nInvalid Primary Key Constraint Error: Duplicate key\n### What happens?\n\nDuckDB will wrongfully throw a `ConstraintException` when updating and inserting a primary key within the same transaction.\n\n### To Reproduce\n\n```sql\r\ncreate table test (i int primary key);\r\ninsert into test values (1);\r\nstart transaction;\r\nupdate test set i = 4 where i = 1;\r\ninsert into test values (1);\r\n-- Error: Constraint Error: duplicate key \"i: 1\" violates primary key constraint\r\n```\r\n\r\nThe value 1 has been replaced by 4, therefore inserting 1 into the primary key column should work, but an error is thrown.\n\n### OS:\n\nMacOS\n\n### DuckDB Version:\n\nLatest master\n\n### DuckDB Client:\n\nCLI\n\n### Full Name:\n\nLaurens Kuiper\n\n### Affiliation:\n\nDuckDB Labs\n\n### Have you tried this on the latest `master` branch?\n\n- [X] I agree\n\n### Have you tried the steps to reproduce? Do they include all relevant data and configuration? Does the issue you report still appear there?\n\n- [X] I agree\n",
  "hints_text": "This bug seems related:\r\n\r\n- https://github.com/duckdb/duckdb/issues/7206\r\n\r\nMay or may not be the same bug, but the manifestation is different.\nThis is very odd, afaik my changes (that are on master currently) did not touch anything beyond that first SQL query `create table test (i int primary key);`. Will of course have a look anyways.\nThis looks like a duplicate of this long-standing issue #1631. This can be cleanly resolved by adding a separate deleted index to the table/transactions to check which tuples have been deleted, but it won't be a very trivial fix.",
  "created_at": "2023-05-03T13:25:32Z"
}