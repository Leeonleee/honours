{
  "repo": "duckdb/duckdb",
  "pull_number": 2662,
  "instance_id": "duckdb__duckdb-2662",
  "issue_numbers": [
    "2656",
    "2656"
  ],
  "base_commit": "a13ec3642e654c35e146121c1e04a321ccb80972",
  "patch": "diff --git a/src/planner/binder/query_node/bind_select_node.cpp b/src/planner/binder/query_node/bind_select_node.cpp\nindex 2ac13c132d89..e08fa1f30a3f 100644\n--- a/src/planner/binder/query_node/bind_select_node.cpp\n+++ b/src/planner/binder/query_node/bind_select_node.cpp\n@@ -66,6 +66,11 @@ void Binder::BindModifiers(OrderBinder &order_binder, QueryNode &statement, Boun\n \t\tcase ResultModifierType::DISTINCT_MODIFIER: {\n \t\t\tauto &distinct = (DistinctModifier &)*mod;\n \t\t\tauto bound_distinct = make_unique<BoundDistinctModifier>();\n+\t\t\tif (distinct.distinct_on_targets.empty()) {\n+\t\t\t\tfor (idx_t i = 0; i < result.names.size(); i++) {\n+\t\t\t\t\tdistinct.distinct_on_targets.push_back(make_unique<ConstantExpression>(Value::INTEGER(1 + i)));\n+\t\t\t\t}\n+\t\t\t}\n \t\t\tfor (auto &distinct_on_target : distinct.distinct_on_targets) {\n \t\t\t\tauto expr = BindOrderExpression(order_binder, move(distinct_on_target));\n \t\t\t\tif (!expr) {\n",
  "test_patch": "diff --git a/test/sql/aggregate/distinct/issue2656.test b/test/sql/aggregate/distinct/issue2656.test\nnew file mode 100644\nindex 000000000000..24dfb054b036\n--- /dev/null\n+++ b/test/sql/aggregate/distinct/issue2656.test\n@@ -0,0 +1,43 @@\n+# name: test/sql/aggregate/distinct/issue2656.test\n+# description: Issue #2656: DISTINCT + ORDER produces incorrect result\n+# group: [distinct]\n+\n+statement ok\n+PRAGMA enable_verification\n+\n+statement ok\n+CREATE TABLE T (t1 int, t2 int);\n+\n+statement ok\n+INSERT INTO t VALUES (1, 1), (1, 2);\n+\n+query I\n+SELECT DISTINCT t1\n+FROM T\n+ORDER BY t1, t2;\n+----\n+1\n+\n+query II\n+SELECT DISTINCT ON (1) t1, t2\n+FROM T\n+ORDER BY t1, t2;\n+----\n+1\t1\n+\n+query I\n+SELECT DISTINCT t1 FROM T\n+UNION\n+SELECT DISTINCT t1 FROM T\n+ORDER BY t1;\n+----\n+1\n+\n+query I\n+SELECT DISTINCT t1 FROM T\n+UNION ALL\n+SELECT DISTINCT t1 FROM T\n+ORDER BY t1;\n+----\n+1\n+1\n",
  "problem_statement": "DISTINCT + ORDER produces incorrect result\n```sql\r\nCREATE TABLE T (t1 int, t2 int);\r\nINSERT INTO t VALUES (1, 1), (1, 2);\r\nSELECT DISTINCT t1\r\nFROM T\r\nORDER BY t1, t2;\r\n\r\nReturns:\r\n\u250c\u2500\u2500\u2500\u2500\u2510\r\n\u2502 t1 \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2524\r\n\u2502 1  \u2502\r\n\u2502 1  \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\nThe query should fail to compile, e.g. Postgres:\r\n\r\n```sql\r\nERROR:  for SELECT DISTINCT, ORDER BY expressions must appear in select list\r\nLINE 3: ORDER BY t1, t2;\r\n```\r\n\r\n\nDISTINCT + ORDER produces incorrect result\n```sql\r\nCREATE TABLE T (t1 int, t2 int);\r\nINSERT INTO t VALUES (1, 1), (1, 2);\r\nSELECT DISTINCT t1\r\nFROM T\r\nORDER BY t1, t2;\r\n\r\nReturns:\r\n\u250c\u2500\u2500\u2500\u2500\u2510\r\n\u2502 t1 \u2502\r\n\u251c\u2500\u2500\u2500\u2500\u2524\r\n\u2502 1  \u2502\r\n\u2502 1  \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\nThe query should fail to compile, e.g. Postgres:\r\n\r\n```sql\r\nERROR:  for SELECT DISTINCT, ORDER BY expressions must appear in select list\r\nLINE 3: ORDER BY t1, t2;\r\n```\r\n\r\n\n",
  "hints_text": "Reported by @PedroTadim, thanks!\nYou are very fast :+1: \nReported by @PedroTadim, thanks!\nYou are very fast :+1: ",
  "created_at": "2021-11-23T22:26:25Z"
}