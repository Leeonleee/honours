{
  "repo": "ydb-platform/ydb",
  "pull_number": 2213,
  "instance_id": "ydb-platform__ydb-2213",
  "issue_numbers": [
    "1917"
  ],
  "base_commit": "c713cd6d38ecda14c312e6e02d429dcf396b81d3",
  "patch": "diff --git a/.github/config/muted_ya.txt b/.github/config/muted_ya.txt\nindex d2bb1511d9aa..b807e30db3b9 100644\n--- a/.github/config/muted_ya.txt\n+++ b/.github/config/muted_ya.txt\n@@ -95,7 +95,6 @@ ydb/tests/functional/clickbench test.py.test_plans*\n ydb/tests/functional/clickbench test.py.test_run*\n ydb/tests/functional/kqp/kqp_indexes ConsistentIndexRead.InteractiveTx\n ydb/tests/functional/kqp/kqp_query_session KqpQuerySession.NoLocalAttach\n-ydb/tests/functional/postgresql test_postgres.py.TestPostgresSuite.test_postgres_suite*\n ydb/tests/functional/restarts test_restarts.py.*\n ydb/tests/functional/serverless test_serverless.py.test_database_with_disk_quotas[enable_alter_database_create_hive_first--*]\n ydb/tests/functional/sqs/cloud test_common.py.TestCommonSqsYandexCloudMode.test_private_create_queue[tables_format_v0-std]\n",
  "test_patch": "diff --git a/.github/config/muted_functest.txt b/.github/config/muted_functest.txt\nindex f14ce2afff3f..be9a39bcc9c3 100644\n--- a/.github/config/muted_functest.txt\n+++ b/.github/config/muted_functest.txt\n@@ -1,4 +1,3 @@\n-ydb/tests/functional/postgresql::test_postgres.py.TestPostgresSuite.test_postgres_suite*\n ydb/tests/functional/tenants/test_dynamic_tenants.py::*\n ydb/tests/functional/tenants/test_storage_config.py::TestStorageConfig::*\n ydb/tests/functional/tenants/test_tenants.py::*\ndiff --git a/ydb/tests/functional/postgresql/cases/int8.out b/ydb/tests/functional/postgresql/cases/int8.out\ndeleted file mode 100644\nindex 58c5041f953e..000000000000\n--- a/ydb/tests/functional/postgresql/cases/int8.out\n+++ /dev/null\n@@ -1,140 +0,0 @@\n---\n--- INT8\n--- Test int8 64-bit integers.\n---\n-CREATE TABLE INT8_TBL(q1 int8, q2 int8, primary key (q1, q2));\n-INSERT INTO INT8_TBL (q1, q2) VALUES('  123   ','  456');\n-INSERT INTO INT8_TBL (q1, q2) VALUES('123   ','4567890123456789');\n-INSERT INTO INT8_TBL (q1, q2) VALUES('4567890123456789','123');\n-INSERT INTO INT8_TBL (q1, q2) VALUES(+4567890123456789,'4567890123456789');\n-INSERT INTO INT8_TBL (q1, q2) VALUES('+4567890123456789','-4567890123456789');\n--- bad inputs\n-INSERT INTO INT8_TBL(q1) VALUES ('      ');\n-ERROR:  invalid input syntax for type bigint: \"      \"\n-LINE 1: INSERT INTO INT8_TBL(q1) VALUES ('      ');\n-                                         ^\n-INSERT INTO INT8_TBL(q1) VALUES ('xxx');\n-ERROR:  invalid input syntax for type bigint: \"xxx\"\n-LINE 1: INSERT INTO INT8_TBL(q1) VALUES ('xxx');\n-                                         ^\n-INSERT INTO INT8_TBL(q1) VALUES ('3908203590239580293850293850329485');\n-ERROR:  value \"3908203590239580293850293850329485\" is out of range for type bigint\n-LINE 1: INSERT INTO INT8_TBL(q1) VALUES ('39082035902395802938502938...\n-                                         ^\n-INSERT INTO INT8_TBL(q1) VALUES ('-1204982019841029840928340329840934');\n-ERROR:  value \"-1204982019841029840928340329840934\" is out of range for type bigint\n-LINE 1: INSERT INTO INT8_TBL(q1) VALUES ('-1204982019841029840928340...\n-                                         ^\n-INSERT INTO INT8_TBL(q1) VALUES ('- 123');\n-ERROR:  invalid input syntax for type bigint: \"- 123\"\n-LINE 1: INSERT INTO INT8_TBL(q1) VALUES ('- 123');\n-                                         ^\n-INSERT INTO INT8_TBL(q1) VALUES ('  345     5');\n-ERROR:  invalid input syntax for type bigint: \"  345     5\"\n-LINE 1: INSERT INTO INT8_TBL(q1) VALUES ('  345     5');\n-                                         ^\n-INSERT INTO INT8_TBL(q1) VALUES ('');\n-ERROR:  invalid input syntax for type bigint: \"\"\n-LINE 1: INSERT INTO INT8_TBL(q1) VALUES ('');\n-                                         ^\n-SELECT * FROM INT8_TBL;\n-        q1        |        q2         \n-------------------+-------------------\n-              123 |               456\n-              123 |  4567890123456789\n- 4567890123456789 | -4567890123456789\n- 4567890123456789 |               123\n- 4567890123456789 |  4567890123456789\n-(5 rows)\n-\n--- int8/int8 cmp\n-SELECT * FROM INT8_TBL WHERE q2 = 4567890123456789;\n-        q1        |        q2        \n-------------------+------------------\n-              123 | 4567890123456789\n- 4567890123456789 | 4567890123456789\n-(2 rows)\n-\n-SELECT * FROM INT8_TBL WHERE q2 <> 4567890123456789;\n-        q1        |        q2         \n-------------------+-------------------\n-              123 |               456\n- 4567890123456789 | -4567890123456789\n- 4567890123456789 |               123\n-(3 rows)\n-\n-SELECT * FROM INT8_TBL WHERE q2 < 4567890123456789;\n-        q1        |        q2         \n-------------------+-------------------\n-              123 |               456\n- 4567890123456789 | -4567890123456789\n- 4567890123456789 |               123\n-(3 rows)\n-\n-SELECT * FROM INT8_TBL WHERE q2 > 4567890123456789;\n- q1 | q2 \n-----+----\n-(0 rows)\n-\n-SELECT * FROM INT8_TBL WHERE q2 <= 4567890123456789;\n-        q1        |        q2         \n-------------------+-------------------\n-              123 |               456\n-              123 |  4567890123456789\n- 4567890123456789 | -4567890123456789\n- 4567890123456789 |               123\n- 4567890123456789 |  4567890123456789\n-(5 rows)\n-\n-SELECT * FROM INT8_TBL WHERE q2 >= 4567890123456789;\n-        q1        |        q2        \n-------------------+------------------\n-              123 | 4567890123456789\n- 4567890123456789 | 4567890123456789\n-(2 rows)\n-\n--- int8/int4 cmp\n-SELECT * FROM INT8_TBL WHERE q2 = 456;\n- q1  | q2  \n------+-----\n- 123 | 456\n-(1 row)\n-\n-SELECT * FROM INT8_TBL WHERE q2 <> 456;\n-        q1        |        q2         \n-------------------+-------------------\n-              123 |  4567890123456789\n- 4567890123456789 | -4567890123456789\n- 4567890123456789 |               123\n- 4567890123456789 |  4567890123456789\n-(4 rows)\n-\n-SELECT * FROM INT8_TBL WHERE q2 < 456;\n-        q1        |        q2         \n-------------------+-------------------\n- 4567890123456789 | -4567890123456789\n- 4567890123456789 |               123\n-(2 rows)\n-\n-SELECT * FROM INT8_TBL WHERE q2 > 456;\n-        q1        |        q2        \n-------------------+------------------\n-              123 | 4567890123456789\n- 4567890123456789 | 4567890123456789\n-(2 rows)\n-\n-SELECT * FROM INT8_TBL WHERE q2 <= 456;\n-        q1        |        q2         \n-------------------+-------------------\n-              123 |               456\n- 4567890123456789 | -4567890123456789\n- 4567890123456789 |               123\n-(3 rows)\n-\n-SELECT * FROM INT8_TBL WHERE q2 >= 456;\n-        q1        |        q2        \n-------------------+------------------\n-              123 |              456\n-              123 | 4567890123456789\n- 4567890123456789 | 4567890123456789\n-(3 rows)\ndiff --git a/ydb/tests/functional/postgresql/cases/int8.sql b/ydb/tests/functional/postgresql/cases/int8.sql\ndeleted file mode 100644\nindex 3e3cf95d666a..000000000000\n--- a/ydb/tests/functional/postgresql/cases/int8.sql\n+++ /dev/null\n@@ -1,33 +0,0 @@\n---\n--- INT8\n--- Test int8 64-bit integers.\n---\n-CREATE TABLE INT8_TBL(q1 int8, q2 int8, primary key (q1, q2));\n-INSERT INTO INT8_TBL (q1, q2) VALUES('  123   ','  456');\n-INSERT INTO INT8_TBL (q1, q2) VALUES('123   ','4567890123456789');\n-INSERT INTO INT8_TBL (q1, q2) VALUES('4567890123456789','123');\n-INSERT INTO INT8_TBL (q1, q2) VALUES(+4567890123456789,'4567890123456789');\n-INSERT INTO INT8_TBL (q1, q2) VALUES('+4567890123456789','-4567890123456789');\n--- bad inputs\n-INSERT INTO INT8_TBL(q1) VALUES ('      ');\n-INSERT INTO INT8_TBL(q1) VALUES ('xxx');\n-INSERT INTO INT8_TBL(q1) VALUES ('3908203590239580293850293850329485');\n-INSERT INTO INT8_TBL(q1) VALUES ('-1204982019841029840928340329840934');\n-INSERT INTO INT8_TBL(q1) VALUES ('- 123');\n-INSERT INTO INT8_TBL(q1) VALUES ('  345     5');\n-INSERT INTO INT8_TBL(q1) VALUES ('');\n-SELECT * FROM INT8_TBL;\n--- int8/int8 cmp\n-SELECT * FROM INT8_TBL WHERE q2 = 4567890123456789;\n-SELECT * FROM INT8_TBL WHERE q2 <> 4567890123456789;\n-SELECT * FROM INT8_TBL WHERE q2 < 4567890123456789;\n-SELECT * FROM INT8_TBL WHERE q2 > 4567890123456789;\n-SELECT * FROM INT8_TBL WHERE q2 <= 4567890123456789;\n-SELECT * FROM INT8_TBL WHERE q2 >= 4567890123456789;\n--- int8/int4 cmp\n-SELECT * FROM INT8_TBL WHERE q2 = 456;\n-SELECT * FROM INT8_TBL WHERE q2 <> 456;\n-SELECT * FROM INT8_TBL WHERE q2 < 456;\n-SELECT * FROM INT8_TBL WHERE q2 > 456;\n-SELECT * FROM INT8_TBL WHERE q2 <= 456;\n-SELECT * FROM INT8_TBL WHERE q2 >= 456;\ndiff --git a/ydb/tests/functional/postgresql/cases/int4.out b/ydb/tests/functional/postgresql/cases/withtable.out\nsimilarity index 65%\nrename from ydb/tests/functional/postgresql/cases/int4.out\nrename to ydb/tests/functional/postgresql/cases/withtable.out\nindex b40e01733c3d..0fab722c255b 100644\n--- a/ydb/tests/functional/postgresql/cases/int4.out\n+++ b/ydb/tests/functional/postgresql/cases/withtable.out\n@@ -5,42 +5,9 @@ CREATE TABLE INT4_TBL(f1 int4 primary key);\n INSERT INTO INT4_TBL(f1) VALUES ('   0  ');\n INSERT INTO INT4_TBL(f1) VALUES ('123456     ');\n INSERT INTO INT4_TBL(f1) VALUES ('    -123456');\n-INSERT INTO INT4_TBL(f1) VALUES ('34.5');\n-ERROR:  invalid input syntax for type integer: \"34.5\"\n-LINE 1: INSERT INTO INT4_TBL(f1) VALUES ('34.5');\n-                                         ^\n -- largest and smallest values\n INSERT INTO INT4_TBL(f1) VALUES ('2147483647');\n INSERT INTO INT4_TBL(f1) VALUES ('-2147483647');\n--- bad input values -- should give errors\n-INSERT INTO INT4_TBL(f1) VALUES ('1000000000000');\n-ERROR:  value \"1000000000000\" is out of range for type integer\n-LINE 1: INSERT INTO INT4_TBL(f1) VALUES ('1000000000000');\n-                                         ^\n-INSERT INTO INT4_TBL(f1) VALUES ('asdf');\n-ERROR:  invalid input syntax for type integer: \"asdf\"\n-LINE 1: INSERT INTO INT4_TBL(f1) VALUES ('asdf');\n-                                         ^\n-INSERT INTO INT4_TBL(f1) VALUES ('     ');\n-ERROR:  invalid input syntax for type integer: \"     \"\n-LINE 1: INSERT INTO INT4_TBL(f1) VALUES ('     ');\n-                                         ^\n-INSERT INTO INT4_TBL(f1) VALUES ('   asdf   ');\n-ERROR:  invalid input syntax for type integer: \"   asdf   \"\n-LINE 1: INSERT INTO INT4_TBL(f1) VALUES ('   asdf   ');\n-                                         ^\n-INSERT INTO INT4_TBL(f1) VALUES ('- 1234');\n-ERROR:  invalid input syntax for type integer: \"- 1234\"\n-LINE 1: INSERT INTO INT4_TBL(f1) VALUES ('- 1234');\n-                                         ^\n-INSERT INTO INT4_TBL(f1) VALUES ('123       5');\n-ERROR:  invalid input syntax for type integer: \"123       5\"\n-LINE 1: INSERT INTO INT4_TBL(f1) VALUES ('123       5');\n-                                         ^\n-INSERT INTO INT4_TBL(f1) VALUES ('');\n-ERROR:  invalid input syntax for type integer: \"\"\n-LINE 1: INSERT INTO INT4_TBL(f1) VALUES ('');\n-                                         ^\n SELECT * FROM INT4_TBL;\n      f1      \n -------------\n@@ -157,8 +124,6 @@ SELECT i.* FROM INT4_TBL i WHERE (i.f1 % int4 '2') = int2 '0';\n   123456\n (3 rows)\n \n-SELECT i.f1, i.f1 * int2 '2' AS x FROM INT4_TBL i;\n-ERROR:  integer out of range\n SELECT i.f1, i.f1 * int2 '2' AS x FROM INT4_TBL i\n WHERE abs(f1) < 1073741824;\n    f1    |    x    \n@@ -168,8 +133,6 @@ WHERE abs(f1) < 1073741824;\n   123456 |  246912\n (3 rows)\n \n-SELECT i.f1, i.f1 * int4 '2' AS x FROM INT4_TBL i;\n-ERROR:  integer out of range\n SELECT i.f1, i.f1 * int4 '2' AS x FROM INT4_TBL i\n WHERE abs(f1) < 1073741824;\n    f1    |    x    \n@@ -179,8 +142,6 @@ WHERE abs(f1) < 1073741824;\n   123456 |  246912\n (3 rows)\n \n-SELECT i.f1, i.f1 + int2 '2' AS x FROM INT4_TBL i;\n-ERROR:  integer out of range\n SELECT i.f1, i.f1 + int2 '2' AS x FROM INT4_TBL i\n WHERE f1 < 2147483646;\n      f1      |      x      \n@@ -191,8 +152,6 @@ WHERE f1 < 2147483646;\n       123456 |      123458\n (4 rows)\n \n-SELECT i.f1, i.f1 + int4 '2' AS x FROM INT4_TBL i;\n-ERROR:  integer out of range\n SELECT i.f1, i.f1 + int4 '2' AS x FROM INT4_TBL i\n WHERE f1 < 2147483646;\n      f1      |      x      \n@@ -203,8 +162,6 @@ WHERE f1 < 2147483646;\n       123456 |      123458\n (4 rows)\n \n-SELECT i.f1, i.f1 - int2 '2' AS x FROM INT4_TBL i;\n-ERROR:  integer out of range\n SELECT i.f1, i.f1 - int2 '2' AS x FROM INT4_TBL i\n WHERE f1 > -2147483647;\n      f1     |     x      \n@@ -215,8 +172,6 @@ WHERE f1 > -2147483647;\n  2147483647 | 2147483645\n (4 rows)\n \n-SELECT i.f1, i.f1 - int4 '2' AS x FROM INT4_TBL i;\n-ERROR:  integer out of range\n SELECT i.f1, i.f1 - int4 '2' AS x FROM INT4_TBL i\n WHERE f1 > -2147483647;\n      f1     |     x      \ndiff --git a/ydb/tests/functional/postgresql/cases/int4.sql b/ydb/tests/functional/postgresql/cases/withtable.sql\nsimilarity index 70%\nrename from ydb/tests/functional/postgresql/cases/int4.sql\nrename to ydb/tests/functional/postgresql/cases/withtable.sql\nindex 4c7a7b6ffea5..8cc0f6fc8d82 100644\n--- a/ydb/tests/functional/postgresql/cases/int4.sql\n+++ b/ydb/tests/functional/postgresql/cases/withtable.sql\n@@ -5,18 +5,9 @@ CREATE TABLE INT4_TBL(f1 int4 primary key);\n INSERT INTO INT4_TBL(f1) VALUES ('   0  ');\n INSERT INTO INT4_TBL(f1) VALUES ('123456     ');\n INSERT INTO INT4_TBL(f1) VALUES ('    -123456');\n-INSERT INTO INT4_TBL(f1) VALUES ('34.5');\n -- largest and smallest values\n INSERT INTO INT4_TBL(f1) VALUES ('2147483647');\n INSERT INTO INT4_TBL(f1) VALUES ('-2147483647');\n--- bad input values -- should give errors\n-INSERT INTO INT4_TBL(f1) VALUES ('1000000000000');\n-INSERT INTO INT4_TBL(f1) VALUES ('asdf');\n-INSERT INTO INT4_TBL(f1) VALUES ('     ');\n-INSERT INTO INT4_TBL(f1) VALUES ('   asdf   ');\n-INSERT INTO INT4_TBL(f1) VALUES ('- 1234');\n-INSERT INTO INT4_TBL(f1) VALUES ('123       5');\n-INSERT INTO INT4_TBL(f1) VALUES ('');\n SELECT * FROM INT4_TBL;\n SELECT i.* FROM INT4_TBL i WHERE i.f1 <> int2 '0';\n SELECT i.* FROM INT4_TBL i WHERE i.f1 <> int4 '0';\n@@ -34,22 +25,16 @@ SELECT i.* FROM INT4_TBL i WHERE i.f1 >= int4 '0';\n SELECT i.* FROM INT4_TBL i WHERE (i.f1 % int2 '2') = int2 '1';\n -- any evens\n SELECT i.* FROM INT4_TBL i WHERE (i.f1 % int4 '2') = int2 '0';\n-SELECT i.f1, i.f1 * int2 '2' AS x FROM INT4_TBL i;\n SELECT i.f1, i.f1 * int2 '2' AS x FROM INT4_TBL i\n WHERE abs(f1) < 1073741824;\n-SELECT i.f1, i.f1 * int4 '2' AS x FROM INT4_TBL i;\n SELECT i.f1, i.f1 * int4 '2' AS x FROM INT4_TBL i\n WHERE abs(f1) < 1073741824;\n-SELECT i.f1, i.f1 + int2 '2' AS x FROM INT4_TBL i;\n SELECT i.f1, i.f1 + int2 '2' AS x FROM INT4_TBL i\n WHERE f1 < 2147483646;\n-SELECT i.f1, i.f1 + int4 '2' AS x FROM INT4_TBL i;\n SELECT i.f1, i.f1 + int4 '2' AS x FROM INT4_TBL i\n WHERE f1 < 2147483646;\n-SELECT i.f1, i.f1 - int2 '2' AS x FROM INT4_TBL i;\n SELECT i.f1, i.f1 - int2 '2' AS x FROM INT4_TBL i\n WHERE f1 > -2147483647;\n-SELECT i.f1, i.f1 - int4 '2' AS x FROM INT4_TBL i;\n SELECT i.f1, i.f1 - int4 '2' AS x FROM INT4_TBL i\n WHERE f1 > -2147483647;\n SELECT i.f1, i.f1 / int2 '2' AS x FROM INT4_TBL i;\ndiff --git a/ydb/tests/functional/postgresql/test_postgres.py b/ydb/tests/functional/postgresql/test_postgres.py\nindex 6ec4593759fd..1529c75597de 100644\n--- a/ydb/tests/functional/postgresql/test_postgres.py\n+++ b/ydb/tests/functional/postgresql/test_postgres.py\n@@ -14,7 +14,6 @@\n \n arcadia_root = yatest.common.source_path('')\n DATA_PATH = os.path.join(arcadia_root, yatest.common.test_source_path('cases'))\n-pm = yatest.common.network.PortManager()\n \n \n def get_unique_path_case(sub_folder, file):\n@@ -47,7 +46,7 @@ def execute_binary(binary_name, cmd, stdin_string=None):\n     stdout = get_unique_path_case('psql', 'stdout')\n \n     with open(stdout, 'w') as stdout_file:\n-        process = yatest.common.execute(\n+        yatest.common.execute(\n             cmd,\n             stdout=stdout_file,\n             stderr=stdout_file,\n@@ -60,6 +59,8 @@ def execute_binary(binary_name, cmd, stdin_string=None):\n class BasePostgresTest(object):\n     @classmethod\n     def setup_class(cls):\n+        cls.pm = yatest.common.network.PortManager()\n+        cls.pgport = cls.pm.get_port()\n         cls.cluster = kikimr_cluster_factory(KikimrConfigGenerator(\n             additional_log_configs={\n                 'LOCAL_PGWIRE': LogLevels.DEBUG,\n@@ -68,13 +69,15 @@ def setup_class(cls):\n                 'KQP_COMPILE_REQUEST': LogLevels.DEBUG,\n                 'KQP_PROXY': LogLevels.DEBUG\n             },\n-            extra_feature_flags=['enable_table_pg_types', 'enable_temp_tables']\n+            extra_feature_flags=['enable_table_pg_types', 'enable_temp_tables'],\n+            pgwire_port=cls.pgport\n         ))\n         cls.cluster.start()\n \n     @classmethod\n     def teardown_class(cls):\n         cls.cluster.stop()\n+        cls.pm.release()\n \n \n class TestPostgresSuite(BasePostgresTest):\n@@ -82,7 +85,7 @@ class TestPostgresSuite(BasePostgresTest):\n     def test_postgres_suite(self, sql, out):\n         stdout_file = execute_binary(\n             'psql',\n-            [psql_binary_path(), 'postgresql://root:1234@localhost:5432/Root', '-w', '-a', '-f', sql]\n+            [psql_binary_path(), 'postgresql://root:1234@localhost:{}/Root'.format(self.pgport), '-w', '-a', '-f', sql]\n         )\n \n         with open(stdout_file, 'rb') as stdout_data:\ndiff --git a/ydb/tests/library/harness/kikimr_config.py b/ydb/tests/library/harness/kikimr_config.py\nindex 17f20055b437..c4375953b6a4 100644\n--- a/ydb/tests/library/harness/kikimr_config.py\n+++ b/ydb/tests/library/harness/kikimr_config.py\n@@ -162,6 +162,7 @@ def __init__(\n             default_user_sid=None,\n             pg_compatible_expirement=False,\n             generic_connector_config=None,  # typing.Optional[TGenericConnectorConfig]\n+            pgwire_port=None,\n     ):\n         if extra_feature_flags is None:\n             extra_feature_flags = []\n@@ -253,6 +254,10 @@ def __init__(\n             self.yaml_config[\"local_pg_wire_config\"] = {}\n             self.yaml_config[\"local_pg_wire_config\"][\"listening_port\"] = os.getenv('PGWIRE_LISTENING_PORT')\n \n+        if pgwire_port:\n+            self.yaml_config[\"local_pg_wire_config\"] = {}\n+            self.yaml_config[\"local_pg_wire_config\"][\"listening_port\"] = pgwire_port\n+\n         if disable_iterator_reads:\n             self.yaml_config[\"table_service_config\"][\"enable_kqp_scan_query_source_read\"] = False\n             self.yaml_config[\"table_service_config\"][\"enable_kqp_data_query_source_read\"] = False\n",
  "problem_statement": "[pg] Smoke test for pgwire\n\n",
  "hints_text": "",
  "created_at": "2024-02-23T15:54:34Z"
}