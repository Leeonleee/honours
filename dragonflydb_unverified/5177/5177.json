{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 5177,
  "instance_id": "dragonflydb__dragonfly-5177",
  "issue_numbers": [
    "5113"
  ],
  "base_commit": "ade10fbdb835293aed13cbf0ee9ebee282ff1d1a",
  "patch": "diff --git a/src/facade/redis_parser.cc b/src/facade/redis_parser.cc\nindex 1ec691d033c5..869b9334686f 100644\n--- a/src/facade/redis_parser.cc\n+++ b/src/facade/redis_parser.cc\n@@ -422,13 +422,18 @@ auto RedisParser::ParseArg(Buffer str) -> ResultConsumed {\n   const char* s = reinterpret_cast<const char*>(str.data());\n   const char* eol = reinterpret_cast<const char*>(memchr(s, '\\n', str.size()));\n \n-  // TODO: in client mode we still may not consume everything (see INPUT_PENDING below).\n-  // It's not a problem, because we need consume all the input only in server mode.\n-\n   if (arg_c_ == '+' || arg_c_ == '-') {  // Simple string or error.\n     DCHECK(!server_mode_);\n     if (!eol) {\n-      Result r = str.size() < 256 ? INPUT_PENDING : BAD_STRING;\n+      // if eol is not found we should still read input as bulk string\n+      cached_expr_->emplace_back(RespExpr::STRING);\n+      cached_expr_->back().u = Buffer{};\n+      bulk_len_ = str.length();\n+      // eol is not found but if '\\r' is present decrease bulk_len\n+      if (s[bulk_len_ - 1] == '\\r')\n+        bulk_len_--;\n+      state_ = BULK_STR_S;\n+      Result r = str.size() < 256 ? OK : BAD_STRING;\n       return {r, 0};\n     }\n \n@@ -479,6 +484,16 @@ auto RedisParser::ConsumeBulk(Buffer str) -> ResultConsumed {\n   uint32_t consumed = 0;\n   auto& bulk_str = get<Buffer>(cached_expr_->back().u);\n \n+  bool extend = false;\n+  // Handle split simple message or error in client mode\n+  if (!server_mode_ && (arg_c_ == '+' || arg_c_ == '-') && !bulk_len_) {\n+    // Search first '\\r' in next partial message which ends bulk string\n+    const char* s = reinterpret_cast<const char*>(str.data());\n+    const char* pos = reinterpret_cast<const char*>(memchr(s, '\\r', str.size()));\n+    bulk_len_ = pos ? pos - s : str.size();\n+    extend = true;\n+  }\n+\n   if (str.size() >= bulk_len_) {\n     consumed = bulk_len_;\n     if (bulk_len_) {\n@@ -487,6 +502,8 @@ auto RedisParser::ConsumeBulk(Buffer str) -> ResultConsumed {\n       if (is_broken_token_) {\n         memcpy(const_cast<uint8_t*>(bulk_str.end()), str.data(), bulk_len_);\n         bulk_str = Buffer{bulk_str.data(), bulk_str.size() + bulk_len_};\n+      } else if (extend) {\n+        ExtendBulkString(Buffer(str.begin(), bulk_len_));\n       } else {\n         bulk_str = str.subspan(0, bulk_len_);\n       }\n@@ -568,6 +585,20 @@ void RedisParser::ExtendLastString(Buffer str) {\n   buf_stash_.back() = std::move(nb);\n }\n \n+void RedisParser::ExtendBulkString(Buffer str) {\n+  DCHECK(!cached_expr_->empty() && cached_expr_->back().type == RespExpr::STRING);\n+\n+  Buffer& bulk_str = get<Buffer>(cached_expr_->back().u);\n+\n+  DCHECK(bulk_str.data() == buf_stash_.back().data());\n+\n+  vector<uint8_t> nb(bulk_str.size() + str.size());\n+  memcpy(nb.data(), bulk_str.data(), bulk_str.size());\n+  memcpy(nb.data() + bulk_str.size(), str.data(), str.size());\n+  bulk_str = RespExpr::Buffer{nb.data(), bulk_str.size() + str.size()};\n+  buf_stash_.back() = std::move(nb);\n+}\n+\n size_t RedisParser::UsedMemory() const {\n   return dfly::HeapSize(parse_stack_) + dfly::HeapSize(stash_) + dfly::HeapSize(buf_stash_);\n }\ndiff --git a/src/facade/redis_parser.h b/src/facade/redis_parser.h\nindex ac3cf9fdc170..c4598d60c690 100644\n--- a/src/facade/redis_parser.h\n+++ b/src/facade/redis_parser.h\n@@ -85,6 +85,7 @@ class RedisParser {\n \n   void HandleFinishArg();\n   void ExtendLastString(Buffer str);\n+  void ExtendBulkString(Buffer str);\n \n   enum State : uint8_t {\n     INLINE_S,\n",
  "test_patch": "diff --git a/src/facade/redis_parser_test.cc b/src/facade/redis_parser_test.cc\nindex 339850c6d206..d1bf19a2a0a6 100644\n--- a/src/facade/redis_parser_test.cc\n+++ b/src/facade/redis_parser_test.cc\n@@ -159,6 +159,44 @@ TEST_F(RedisParserTest, ClientMode) {\n \n   ASSERT_EQ(RedisParser::OK, Parse(\"*3\\r\\n+OK\\r\\n$1\\r\\n1\\r\\n*2\\r\\n$1\\r\\n1\\r\\n$-1\\r\\n\"));\n   ASSERT_THAT(args_, ElementsAre(\"OK\", \"1\", ArrLen(2)));\n+\n+  ASSERT_EQ(RedisParser::INPUT_PENDING, Parse(\"+O\"));\n+  EXPECT_EQ(2, consumed_);\n+  ASSERT_EQ(RedisParser::INPUT_PENDING, Parse(\"K\\r\"));\n+  EXPECT_EQ(2, consumed_);\n+  ASSERT_EQ(RedisParser::OK, Parse(\"\\n\"));\n+  ASSERT_THAT(args_, ElementsAre(\"OK\"));\n+  EXPECT_EQ(1, consumed_);\n+\n+  ASSERT_EQ(RedisParser::INPUT_PENDING, Parse(\"+OK\\r\"));\n+  EXPECT_EQ(4, consumed_);\n+  ASSERT_EQ(RedisParser::OK, Parse(\"\\n\"));\n+  ASSERT_THAT(args_, ElementsAre(\"OK\"));\n+  EXPECT_EQ(1, consumed_);\n+\n+  ASSERT_EQ(RedisParser::INPUT_PENDING, Parse(\"+\"));\n+  EXPECT_EQ(1, consumed_);\n+  ASSERT_EQ(RedisParser::INPUT_PENDING, Parse(\"O\"));\n+  EXPECT_EQ(1, consumed_);\n+  ASSERT_EQ(RedisParser::INPUT_PENDING, Parse(\"K\"));\n+  EXPECT_EQ(1, consumed_);\n+  ASSERT_EQ(RedisParser::INPUT_PENDING, Parse(\"\\r\"));\n+  EXPECT_EQ(1, consumed_);\n+  ASSERT_EQ(RedisParser::OK, Parse(\"\\n\"));\n+  EXPECT_EQ(1, consumed_);\n+  ASSERT_THAT(args_, ElementsAre(\"OK\"));\n+\n+  ASSERT_EQ(RedisParser::INPUT_PENDING, Parse(\"-\"));\n+  EXPECT_EQ(1, consumed_);\n+  ASSERT_EQ(RedisParser::OK, Parse(\"ERR\\r\\n\"));\n+  EXPECT_EQ(5, consumed_);\n+  ASSERT_THAT(args_, ElementsAre(ErrArg(\"ERR\")));\n+\n+  ASSERT_EQ(RedisParser::INPUT_PENDING, Parse(\"-ERR foo\"));\n+  EXPECT_EQ(8, consumed_);\n+  ASSERT_EQ(RedisParser::OK, Parse(\"\\r\\n\"));\n+  EXPECT_EQ(2, consumed_);\n+  ASSERT_THAT(args_, ElementsAre(\"ERR foo\"));\n }\n \n TEST_F(RedisParserTest, Hierarchy) {\n",
  "problem_statement": "dfly_bench crashes on parsing redis response\ncmd: [--h=<> --p=6385 --password=<> --n=1000 --c=20 --d=16 --ratio=1:3 --proactor_threads=16 --test_time=180 --pipeline=10 --key_maximum=312500100 --logtostderr --colorlogtostderr=true --colorlogtostdout=true]\n\n```\nF20250513 13:01:36.395577 71333 redis_parser.cc:95] Check failed: str.empty()\n*** Check failure stack trace: ***\n    @           0x4f176b  google::LogMessage::Fail()\n    @           0x4f16d2  google::LogMessage::SendToLog()\n    @           0x4f0edb  google::LogMessage::Flush()\n    @           0x4f47b2  google::LogMessageFatal::~LogMessageFatal()\n    @           0x459eb3  facade::RedisParser::Parse()\n    @           0x407891  Driver::ParseRESP()\n    @           0x407607  Driver::ReceiveFb()\n    @           0x405c99  _ZZN6Driver7ConnectEjRKN5boost4asio2ip14basic_endpointINS2_3tcpEEEENKUlvE_clEv\n    @           0x41a868  _ZSt13__invoke_implIvZN6Driver7ConnectEjRKN5boost4asio2ip14basic_endpointINS3_3tcpEEEEUlvE_JEET_St14__invoke_otherOT0_DpOT1_\n    @           0x417fc0  _ZSt8__invokeIZN6Driver7ConnectEjRKN5boost4asio2ip14basic_endpointINS3_3tcpEEEEUlvE_JEENSt15__invoke_resultIT_JDpT0_EE4typeEOSB_DpOSC_\n    @           0x415425  _ZSt12__apply_implIZN6Driver7ConnectEjRKN5boost4asio2ip14basic_endpointINS3_3tcpEEEEUlvE_St5tupleIJEEJEEDcOT_OT0_St16integer_sequenceImJXspT1_EEE\n    @           0x41545f  _ZSt5applyIZN6Driver7ConnectEjRKN5boost4asio2ip14basic_endpointINS3_3tcpEEEEUlvE_St5tupleIJEEEDcOT_OT0_\n    @           0x4154cc  _ZN4util3fb26detail15WorkerFiberImplIZN6Driver7ConnectEjRKN5boost4asio2ip14basic_endpointINS6_3tcpEEEEUlvE_JEE4run_EONS4_7context5fiberE\n    @           0x412e9c  _ZZN4util3fb26detail15WorkerFiberImplIZN6Driver7ConnectEjRKN5boost4asio2ip14basic_endpointINS6_3tcpEEEEUlvE_JEEC4INS4_7context21basic_fixedsize_stackINSF_12stack_traitsEEEEESt17basic_string_viewIcSt11char_traitsIcEENS0_13FiberPriorityERKNSF_12preallocatedEOT_OSC_ENKUlONSF_5fiberEE_clESV_\n    @           0x425880  _ZSt13__invoke_implIN5boost7context5fiberERZN4util3fb26detail15WorkerFiberImplIZN6Driver7ConnectEjRKNS0_4asio2ip14basic_endpointINS9_3tcpEEEEUlvE_JEEC4INS1_21basic_fixedsize_stackINS1_12stack_traitsEEEEESt17basic_string_viewIcSt11char_traitsIcEENS4_13FiberPriorityERKNS1_12preallocatedEOT_OSF_EUlOS2_E_JS2_EEST_St14__invoke_otherOT0_DpOT1_\n    @           0x4227e8  _ZSt8__invokeIRZN4util3fb26detail15WorkerFiberImplIZN6Driver7ConnectEjRKN5boost4asio2ip14basic_endpointINS7_3tcpEEEEUlvE_JEEC4INS5_7context21basic_fixedsize_stackINSG_12stack_traitsEEEEESt17basic_string_viewIcSt11char_traitsIcEENS1_13FiberPriorityERKNSG_12preallocatedEOT_OSD_EUlONSG_5fiberEE_JSV_EENSt15__invoke_resultISS_JDpT0_EE4typeEST_DpOS10_\n    @           0x42056c  _ZSt6invokeIRZN4util3fb26detail15WorkerFiberImplIZN6Driver7ConnectEjRKN5boost4asio2ip14basic_endpointINS7_3tcpEEEEUlvE_JEEC4INS5_7context21basic_fixedsize_stackINSG_12stack_traitsEEEEESt17basic_string_viewIcSt11char_traitsIcEENS1_13FiberPriorityERKNSG_12preallocatedEOT_OSD_EUlONSG_5fiberEE_JSV_EENSt13invoke_resultISS_JDpT0_EE4typeEST_DpOS10_\n    @           0x41e3f3  _ZN5boost7context6detail12fiber_recordINS0_5fiberENS0_21basic_fixedsize_stackINS0_12stack_traitsEEEZN4util3fb26detail15WorkerFiberImplIZN6Driver7ConnectEjRKNS_4asio2ip14basic_endpointINSD_3tcpEEEEUlvE_JEEC4IS6_EESt17basic_string_viewIcSt11char_traitsIcEENS8_13FiberPriorityERKNS0_12preallocatedEOT_OSJ_EUlOS3_E_E3runEPv\n    @           0x41ab6e  _ZN5boost7context6detail11fiber_entryINS1_12fiber_recordINS0_5fiberENS0_21basic_fixedsize_stackINS0_12stack_traitsEEEZN4util3fb26detail15WorkerFiberImplIZN6Driver7ConnectEjRKNS_4asio2ip14basic_endpointINSE_3tcpEEEEUlvE_JEEC4IS7_EESt17basic_string_viewIcSt11char_traitsIcEENS9_13FiberPriorityERKNS0_12preallocatedEOT_OSK_EUlOS4_E_EEEEvNS1_10transfer_tE\n    @     0x7f9c99bdb207  make_fcontext\n*** SIGABRT received at time=1747121496 on cpu 11 ***\nPC: @     0x7f9c9967ff54  (unknown)  __pthread_kill_implementation\n    @           0x574bc5         64  absl::lts_20240722::WriteFailureInfo()\n    @           0x574dd2         96  absl::lts_20240722::AbslFailureSignalHandler()\n    @     0x7f9c99627050       3392  (unknown)\n    @     0x7f9c99626f9e         32  gsignal\n    @     0x7f9c9960e942        192  abort\n    @           0x4fb2a4        176  google::DumpStackTraceAndExit()\n    @           0x4f176b         16  google::LogMessage::Fail()\n    @           0x4f16d2        160  google::LogMessage::SendToLog()\n    @           0x4f0edb         64  google::LogMessage::Flush()\n    @           0x4f47b2         32  google::LogMessageFatal::~LogMessageFatal()\n    @           0x459eb3       1248  facade::RedisParser::Parse()\n    @           0x407891       1120  Driver::ParseRESP()\n    @           0x407607        672  Driver::ReceiveFb()\n    @           0x405c99         32  Driver::Connect()::{lambda()#1}::operator()()\n    @           0x41a868         32  std::__invoke_impl<>()\n    @           0x417fc0         32  std::__invoke<>()\n    @           0x415425         32  std::__apply_impl<>()\n    @           0x41545f         48  std::apply<>()\n    @           0x4154cc         80  util::fb2::detail::WorkerFiberImpl<>::run_()\n    @           0x412e9c         64  util::fb2::detail::WorkerFiberImpl<>::WorkerFiberImpl<>()::{lambda()#1}::operator()()\n    @           0x425880         64  std::__invoke_impl<>()\n    @           0x4227e8         64  std::__invoke<>()\n    @           0x42056c         64  std::invoke<>()\n    @           0x41e3f3         80  boost::context::detail::fiber_record<>::run()\n    @           0x41ab6e         48  boost::context::detail::fiber_entry<>()\n    @     0x7f9c99bdb207  (unknown)  make_fcontext\n\n        Error Trace:    /home/abhijat/work/controlplane/dftest/tests/cluster/replication_under_load.go:140\n                                                /usr/lib/golang/src/runtime/asm_amd64.s:1700\n        Error:          Received unexpected error:\n                        signal: aborted (core dumped)\n\npanic: failed\n\ngoroutine 178 [running]:\ngithub.com/dragonflydb/controlplane/dftest.(*T).FailNow(0x23af780?)\n        /home/abhijat/work/controlplane/dftest/testing.go:93 +0x32\ngithub.com/stretchr/testify/require.NoError({0x23cebb0, 0xc0001ef7c0}, {0x23b0280, 0xc000c9b2e0}, {0x0, 0x0, 0x0})\n        /home/abhijat/go/pkg/mod/github.com/stretchr/testify@v1.10.0/require/require.go:1357 +0xca\ngithub.com/dragonflydb/controlplane/dftest/tests/cluster.increaseReplicas.func1()\n        /home/abhijat/work/controlplane/dftest/tests/cluster/replication_under_load.go:140 +0x4b\ncreated by github.com/dragonflydb/controlplane/dftest/tests/cluster.increaseReplicas in goroutine 80\n        /home/abhijat/work/controlplane/dftest/tests/cluster/replication_under_load.go:138 +0xff\n```\n",
  "hints_text": "",
  "created_at": "2025-05-24T20:31:33Z",
  "modified_files": [
    "src/facade/redis_parser.cc",
    "src/facade/redis_parser.h"
  ],
  "modified_test_files": [
    "src/facade/redis_parser_test.cc"
  ]
}