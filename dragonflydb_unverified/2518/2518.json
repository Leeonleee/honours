{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 2518,
  "instance_id": "dragonflydb__dragonfly-2518",
  "issue_numbers": [
    "2509"
  ],
  "base_commit": "adeac6bd27013f49b44467b7e9178aef8d8ba4c5",
  "patch": "diff --git a/src/server/conn_context.cc b/src/server/conn_context.cc\nindex 0eb1d0407270..ce4a57a44ece 100644\n--- a/src/server/conn_context.cc\n+++ b/src/server/conn_context.cc\n@@ -23,14 +23,16 @@ StoredCmd::StoredCmd(const CommandId* cid, CmdArgList args, facade::ReplyMode mo\n     : cid_{cid}, buffer_{}, sizes_(args.size()), reply_mode_{mode} {\n   size_t total_size = 0;\n   for (auto args : args) {\n-    total_size += args.size() + 1;  // +1 for null terminator\n+    total_size += args.size();\n   }\n+\n   buffer_.resize(total_size);\n   char* next = buffer_.data();\n   for (unsigned i = 0; i < args.size(); i++) {\n-    memcpy(next, args[i].data(), args[i].size() + 1);\n-    sizes_[i] = args[i].size();\n+    if (args[i].size() > 0)\n+      memcpy(next, args[i].data(), args[i].size());\n     next += args[i].size();\n+    sizes_[i] = args[i].size();\n   }\n }\n \n",
  "test_patch": "diff --git a/src/server/multi_test.cc b/src/server/multi_test.cc\nindex e66b53ecf5ae..4e734499fa77 100644\n--- a/src/server/multi_test.cc\n+++ b/src/server/multi_test.cc\n@@ -151,15 +151,21 @@ TEST_F(MultiTest, MultiEmpty) {\n   RespExpr resp = Run({\"multi\"});\n   ASSERT_EQ(resp, \"OK\");\n   resp = Run({\"exec\"});\n-\n-  ASSERT_THAT(resp, ArrLen(0));\n-  ASSERT_FALSE(service_->IsShardSetLocked());\n+  EXPECT_THAT(resp, ArrLen(0));\n+  EXPECT_FALSE(service_->IsShardSetLocked());\n \n   Run({\"multi\"});\n   ASSERT_EQ(Run({\"ping\", \"foo\"}), \"QUEUED\");\n   resp = Run({\"exec\"});\n-  // one cell arrays are promoted to respexpr.\n   EXPECT_EQ(resp, \"foo\");\n+\n+  Run({\"multi\"});\n+  Run({\"set\", \"a\", \"\"});\n+  resp = Run({\"exec\"});\n+  EXPECT_EQ(resp, \"OK\");\n+\n+  resp = Run({\"get\", \"a\"});\n+  EXPECT_EQ(resp, \"\");\n }\n \n TEST_F(MultiTest, MultiSeq) {\n",
  "problem_statement": "Dragonfly crashes when setting empty string in transaction\n**Dragonfly version**\r\n```\r\n$ dragonfly --version\r\ndragonfly v1.14.1-25b2713d3a46ba76bf492f93e5f34c4f647855bf\r\nbuild time: 2024-01-25 10:01:17\r\n```\r\n\r\n**Description**\r\nI opened a transaction und tried to set an empty string as the value of a key. Then dragonfly crashed with an error message:\r\n```\r\n*** SIGSEGV received at time=1706708997 on cpu 0 ***\r\nPC: @     0x7fce6393597c  (unknown)  (unknown)\r\n```\r\n\r\n**Steps to reproduce**\r\n```\r\nredis-cli\r\n127.0.0.1:6379> MULTI\r\nOK\r\n127.0.0.1:6379(TX)> SET test ''\r\nError: Server closed the connection\r\n```\n",
  "hints_text": "OMG, this is the most embarrassing bug I saw in dragonfly in the past year! Thank you for reporting this! \r\nCan I buy you a beer? :)",
  "created_at": "2024-02-01T13:01:43Z",
  "modified_files": [
    "src/server/conn_context.cc"
  ],
  "modified_test_files": [
    "src/server/multi_test.cc"
  ]
}