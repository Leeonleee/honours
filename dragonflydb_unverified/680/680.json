{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 680,
  "instance_id": "dragonflydb__dragonfly-680",
  "issue_numbers": [
    "679"
  ],
  "base_commit": "7eff61c9ab4320ba76e68b8fc151d526335478b9",
  "patch": "diff --git a/src/core/compact_object.cc b/src/core/compact_object.cc\nindex e37c62c7a582..341fd0d42956 100644\n--- a/src/core/compact_object.cc\n+++ b/src/core/compact_object.cc\n@@ -576,7 +576,7 @@ robj* CompactObj::AsRObj() const {\n \n void CompactObj::InitRobj(unsigned type, unsigned encoding, void* obj) {\n   DCHECK_NE(type, OBJ_STRING);\n-  SetMeta(ROBJ_TAG);\n+  SetMeta(ROBJ_TAG, mask_);\n   u_.r_obj.Init(type, encoding, obj);\n }\n \n",
  "test_patch": "diff --git a/src/server/dragonfly_test.cc b/src/server/dragonfly_test.cc\nindex 795da2d1bfc2..d8333511505e 100644\n--- a/src/server/dragonfly_test.cc\n+++ b/src/server/dragonfly_test.cc\n@@ -788,7 +788,7 @@ TEST_F(DflyEngineTest, Bug496) {\n   });\n }\n \n-TEST_F(DflyEngineTest, Issue706) {\n+TEST_F(DflyEngineTest, Issue607) {\n   // https://github.com/dragonflydb/dragonfly/issues/607\n \n   Run({\"SET\", \"key\", \"value1\"});\n@@ -803,6 +803,15 @@ TEST_F(DflyEngineTest, Issue706) {\n   EXPECT_EQ(Run({\"GET\", \"key\"}), \"value3\");\n }\n \n+TEST_F(DflyEngineTest, Issue679) {\n+  // https://github.com/dragonflydb/dragonfly/issues/679\n+\n+  Run({\"HMSET\", \"a\", \"key\", \"val\"});\n+  Run({\"EXPIRE\", \"a\", \"1000\"});\n+  Run({\"HMSET\", \"a\", \"key\", \"vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv\"});\n+  Run({\"EXPIRE\", \"a\", \"1001\"});\n+}\n+\n TEST_F(DefragDflyEngineTest, TestDefragOption) {\n   absl::SetFlag(&FLAGS_mem_defrag_threshold, 0.02);\n   //  Fill data into dragonfly and then check if we have\n",
  "problem_statement": "InitRObj resets compact object mask\n```\r\nHMSET a name var\r\nexpire a 1500\r\nHMSET a name vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv\r\nexpire a 1500\r\n```\n",
  "hints_text": "",
  "created_at": "2023-01-15T19:31:59Z",
  "modified_files": [
    "src/core/compact_object.cc"
  ],
  "modified_test_files": [
    "src/server/dragonfly_test.cc"
  ]
}