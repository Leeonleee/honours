{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 2086,
  "instance_id": "dragonflydb__dragonfly-2086",
  "issue_numbers": [
    "2083"
  ],
  "base_commit": "502efd80b2bd9e6b3606f7b5a57d9cb814ce7342",
  "patch": "diff --git a/src/server/transaction.cc b/src/server/transaction.cc\nindex 795de10baf4e..52f95664df93 100644\n--- a/src/server/transaction.cc\n+++ b/src/server/transaction.cc\n@@ -294,7 +294,7 @@ void Transaction::InitByKeys(KeyIndex key_index) {\n   // Validation. Check reverse mapping was built correctly.\n   if (needs_reverse_mapping) {\n     for (size_t i = 0; i < args_.size(); ++i) {\n-      DCHECK_EQ(args_[i], ArgS(args, reverse_index_[i]));\n+      DCHECK_EQ(args_[i], ArgS(args, reverse_index_[i])) << args;\n     }\n   }\n \n@@ -393,7 +393,10 @@ void Transaction::MultiSwitchCmd(const CommandId* cid) {\n     unique_shard_id_ = 0;\n \n   unique_shard_cnt_ = 0;\n+\n   args_.clear();\n+  reverse_index_.clear();\n+\n   cid_ = cid;\n   cb_ptr_ = nullptr;\n \n@@ -1414,7 +1417,7 @@ void Transaction::CancelBlocking() {\n }\n \n OpResult<KeyIndex> DetermineKeys(const CommandId* cid, CmdArgList args) {\n-  if (cid->opt_mask() & CO::GLOBAL_TRANS)\n+  if (cid->opt_mask() & (CO::GLOBAL_TRANS | CO::NO_KEY_TRANSACTIONAL))\n     return KeyIndex::Empty();\n \n   KeyIndex key_index;\n",
  "test_patch": "diff --git a/src/server/multi_test.cc b/src/server/multi_test.cc\nindex 8a6efdacc293..c33e724e9dee 100644\n--- a/src/server/multi_test.cc\n+++ b/src/server/multi_test.cc\n@@ -777,6 +777,14 @@ TEST_F(MultiTest, TestSquashing) {\n \n   done.store(true);\n   f1.Join();\n+\n+  // Test some more unusual commands\n+  Run({\"multi\"});\n+  Run({\"mget\", \"x1\", \"x2\", \"x3\"});\n+  Run({\"mget\", \"x4\"});\n+  Run({\"mget\", \"x5\", \"x6\", \"x7\", \"x8\"});\n+  Run({\"ft.search\", \"i1\", \"*\"});\n+  Run({\"exec\"});\n }\n \n TEST_F(MultiTest, MultiLeavesTxQueue) {\n",
  "problem_statement": "test_parser_while_script_running fails in debug build\n**Describe the bug**\r\nAssertion fails in: \r\n```\r\ntransaction.cc:297] Check failed: args_[i] == ArgS(args, reverse_index_[i]) (m5 vs. m6)\r\n```\r\n\r\n**Reproducible Code Snippet**\r\n\r\nJust run locally on debug build: `python3 -m pytest dragonfly/connection_test.py -k \"test_parser_while_script_running\"`\r\n\r\n\r\n```\r\n41497\u279c Check failure stack trace: ***\r\n41497\u279c    @     0x56000d164115  google::LogMessage::Fail()\r\n41497\u279c    @     0x56000d16405b  google::LogMessage::SendToLog()\r\n41497\u279c    @     0x56000d163830  google::LogMessage::Flush()\r\n41497\u279c    @     0x56000d1676a8  google::LogMessageFatal::~LogMessageFatal()\r\n41497\u279c    @     0x56000c665793  dfly::Transaction::InitByKeys()\r\n41497\u279c    @     0x56000c6668c8  dfly::Transaction::InitByArgs()\r\n41497\u279c    @     0x56000bfefa60  dfly::MultiCommandSquasher::ExecuteStandalone()\r\n41497\u279c    @     0x56000bff353b  dfly::MultiCommandSquasher::Run()\r\n41497\u279c    @     0x56000ba8176c  dfly::MultiCommandSquasher::Execute()\r\n41497\u279c    @     0x56000ba0b634  _ZZN4dfly7Service20DispatchManyCommandsEN4absl12lts_202308024SpanINS3_INS3_IcEEEEEEPN6facade17ConnectionContextEENKUlvE_clEv\r\n41497\u279c    @     0x56000ba0c0fd  dfly::Service::DispatchManyCommands()\r\n41497\u279c    @     0x56000ca06228  facade::Connection::DispatchFiber()\r\n41497\u279c    @     0x56000ca0a0e9  _ZZN6facade10Connection27LaunchDispatchFiberIfNeededEvENKUlvE_clEv\r\n41497\u279c    @     0x56000ca11c22  _ZSt13__invoke_implIvZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_JEET_St14__invoke_otherOT0_DpOT1_\r\n41497\u279c    @     0x56000ca1192a  _ZSt8__invokeIZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_JEENSt15__invoke_resultIT_JDpT0_EE4typeEOS4_DpOS5_\r\n41497\u279c    @     0x56000ca10e35  _ZSt12__apply_implIZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_St5tupleIJEEJEEDcOT_OT0_St16integer_sequenceImJXspT1_EEE\r\n41497\u279c    @     0x56000ca10eb2  _ZSt5applyIZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_St5tupleIJEEEDcOT_OT0_\r\n41497\u279c    @     0x56000ca110c2  _ZN4util3fb26detail15WorkerFiberImplIZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_JEE4run_EON5boost7context5fiberE\r\n41497\u279c    @     0x56000ca10087  _ZZN4util3fb26detail15WorkerFiberImplIZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_JEEC4IN5boost7context21basic_fixedsize_stackINS9_12stack_traitsEEEEESt17basic_string_viewIcSt11char_traitsIcEERKNS9_12preallocatedEOT_OS5_ENKUlONS9_5fiberEE_clESO_\r\n41497\u279c    @     0x56000ca12791  _ZSt13__invoke_implIN5boost7context5fiberERZN4util3fb26detail15WorkerFiberImplIZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_JEEC4INS1_21basic_fixedsize_stackINS1_12stack_traitsEEEEESt17basic_string_viewIcSt11char_traitsIcEERKNS1_12preallocatedEOT_OS9_EUlOS2_E_JS2_EESM_St14__invoke_otherOT0_DpOT1_\r\n41497\u279c    @     0x56000ca12523  _ZSt8__invokeIRZN4util3fb26detail15WorkerFiberImplIZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_JEEC4IN5boost7context21basic_fixedsize_stackINSA_12stack_traitsEEEEESt17basic_string_viewIcSt11char_traitsIcEERKNSA_12preallocatedEOT_OS6_EUlONSA_5fiberEE_JSO_EENSt15__invoke_resultISL_JDpT0_EE4typeESM_DpOST_\r\n41497\u279c    @     0x56000ca123df  _ZSt6invokeIRZN4util3fb26detail15WorkerFiberImplIZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_JEEC4IN5boost7context21basic_fixedsize_stackINSA_12stack_traitsEEEEESt17basic_string_viewIcSt11char_traitsIcEERKNSA_12preallocatedEOT_OS6_EUlONSA_5fiberEE_JSO_EENSt13invoke_resultISL_JDpT0_EE4typeESM_DpOST_\r\n41497\u279c    @     0x56000ca121fd  _ZN5boost7context6detail12fiber_recordINS0_5fiberENS0_21basic_fixedsize_stackINS0_12stack_traitsEEEZN4util3fb26detail15WorkerFiberImplIZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_JEEC4IS6_EESt17basic_string_viewIcSt11char_traitsIcEERKNS0_12preallocatedEOT_OSD_EUlOS3_E_E3runEPv\r\n41497\u279c    @     0x56000ca11f3b  _ZN5boost7context6detail11fiber_entryINS1_12fiber_recordINS0_5fiberENS0_21basic_fixedsize_stackINS0_12stack_traitsEEEZN4util3fb26detail15WorkerFiberImplIZN6facade10Connection27LaunchDispatchFiberIfNeededEvEUlvE_JEEC4IS7_EESt17basic_string_viewIcSt11char_traitsIcEERKNS0_12preallocatedEOT_OSE_EUlOS4_E_EEEEvNS1_10transfer_tE\r\n41497\u279c    @     0x7f6eff36524f  make_fcontext\r\n41497\u279c SIGABRT received at time=1698403447 on cpu 0 ***\r\n41497\u279c @     0x7f6efde969fc  (unknown)  pthread_kill\r\n41497\u279c    @     0x56000d1e9273         64  absl::lts_20230802::WriteFailureInfo()\r\n41497\u279c    @     0x56000d1e94cd         96  absl::lts_20230802::AbslFailureSignalHandler()\r\n41497\u279c    @     0x7f6efde42520  (unknown)  (unknown)\r\n\r\n```\n",
  "hints_text": "",
  "created_at": "2023-10-28T12:35:28Z",
  "modified_files": [
    "src/server/transaction.cc"
  ],
  "modified_test_files": [
    "src/server/multi_test.cc"
  ]
}