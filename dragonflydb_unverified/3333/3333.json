{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 3333,
  "instance_id": "dragonflydb__dragonfly-3333",
  "issue_numbers": [
    "3328"
  ],
  "base_commit": "e3eb8518fd09259f09ba8d97b1bab3540e9701fd",
  "patch": "diff --git a/src/server/engine_shard_set.cc b/src/server/engine_shard_set.cc\nindex 38c62086a012..9fd4ee678085 100644\n--- a/src/server/engine_shard_set.cc\n+++ b/src/server/engine_shard_set.cc\n@@ -396,12 +396,16 @@ void EngineShard::Shutdown() {\n     tiered_storage_.reset();\n   }\n \n+  DCHECK(!fiber_periodic_.IsJoinable());\n+\n+  ProactorBase::me()->RemoveOnIdleTask(defrag_task_);\n+}\n+\n+void EngineShard::StopPeriodicFiber() {\n   fiber_periodic_done_.Notify();\n   if (fiber_periodic_.IsJoinable()) {\n     fiber_periodic_.Join();\n   }\n-\n-  ProactorBase::me()->RemoveOnIdleTask(defrag_task_);\n }\n \n void EngineShard::StartPeriodicFiber(util::ProactorBase* pb) {\n@@ -895,6 +899,10 @@ void EngineShardSet::Init(uint32_t sz, bool update_db_time) {\n   });\n }\n \n+void EngineShardSet::PreShutdown() {\n+  RunBlockingInParallel([](EngineShard* shard) { shard->StopPeriodicFiber(); });\n+}\n+\n void EngineShardSet::Shutdown() {\n   RunBlockingInParallel([](EngineShard*) { EngineShard::DestroyThreadLocal(); });\n }\ndiff --git a/src/server/engine_shard_set.h b/src/server/engine_shard_set.h\nindex b641a3af9144..516e49c75186 100644\n--- a/src/server/engine_shard_set.h\n+++ b/src/server/engine_shard_set.h\n@@ -149,6 +149,8 @@ class EngineShard {\n \n   void TEST_EnableHeartbeat();\n \n+  void StopPeriodicFiber();\n+\n   struct TxQueueInfo {\n     // Armed - those that the coordinator has armed with callbacks and wants them to run.\n     // Runnable - those that could run (they own the locks) but probably can not run due\n@@ -281,6 +283,12 @@ class EngineShardSet {\n   }\n \n   void Init(uint32_t size, bool update_db_time);\n+\n+  // Shutdown sequence:\n+  // - EngineShardSet.PreShutDown()\n+  // - Namespaces.Clear()\n+  // - EngineShardSet.Shutdown()\n+  void PreShutdown();\n   void Shutdown();\n \n   static const std::vector<CachedStats>& GetCachedStats();\ndiff --git a/src/server/main_service.cc b/src/server/main_service.cc\nindex 04796d93a357..0a4bbfd5fc74 100644\n--- a/src/server/main_service.cc\n+++ b/src/server/main_service.cc\n@@ -833,7 +833,6 @@ Service::Service(ProactorPool* pp)\n Service::~Service() {\n   delete shard_set;\n   shard_set = nullptr;\n-  namespaces.Clear();\n }\n \n void Service::Init(util::AcceptServer* acceptor, std::vector<facade::Listener*> listeners,\n@@ -913,8 +912,8 @@ void Service::Shutdown() {\n \n   ChannelStore::Destroy();\n \n+  shard_set->PreShutdown();\n   namespaces.Clear();\n-\n   shard_set->Shutdown();\n \n   pp_.Await([](ProactorBase* pb) { ServerState::tlocal()->Destroy(); });\n",
  "test_patch": "diff --git a/src/server/blocking_controller_test.cc b/src/server/blocking_controller_test.cc\nindex f516c8e53580..d1204095e6c7 100644\n--- a/src/server/blocking_controller_test.cc\n+++ b/src/server/blocking_controller_test.cc\n@@ -70,8 +70,8 @@ void BlockingControllerTest::SetUp() {\n }\n \n void BlockingControllerTest::TearDown() {\n+  shard_set->PreShutdown();\n   namespaces.Clear();\n-\n   shard_set->Shutdown();\n   delete shard_set;\n \n",
  "problem_statement": "Sanitizers crash and namespaces\nRun: https://github.com/dragonflydb/dragonfly/actions/runs/9967990131\r\n\r\nTrace\r\n```\r\n2024-07-17T04:56:33.1423078Z 72: F20240717 04:56:33.140332 25880 namespaces.cc:82] Check failed: default_namespace_ != nullptr \r\n2024-07-17T04:56:33.1569013Z 72: *** SIGSEGV received at time=1721192193 on cpu 0 ***\r\n2024-07-17T04:56:33.1587384Z 72: PC: @     0xe8d76e4d1fa8  (unknown)  (unknown)\r\n2024-07-17T04:56:33.2020285Z 72:     @     0xb0be5d63c1b0        672  absl::lts_20240116::WriteFailureInfo()\r\n2024-07-17T04:56:33.2131099Z 72:     @     0xb0be5d63c820        192  absl::lts_20240116::AbslFailureSignalHandler()\r\n2024-07-17T04:56:33.2135474Z 72:     @     0xe8d76e5a18f8       4944  (unknown)\r\n2024-07-17T04:56:33.8047814Z 51/52 Test #72: search_family_test ...............***Exception: SegFault  5.59 sec\r\n```\n",
  "hints_text": "@chakaz FYI :) ",
  "created_at": "2024-07-17T12:32:40Z",
  "modified_files": [
    "src/server/engine_shard_set.cc",
    "src/server/engine_shard_set.h",
    "src/server/main_service.cc"
  ],
  "modified_test_files": [
    "src/server/blocking_controller_test.cc"
  ]
}