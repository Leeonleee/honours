{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 19788,
  "instance_id": "ClickHouse__ClickHouse-19788",
  "issue_numbers": [
    "19787"
  ],
  "base_commit": "10160e5adf77e0ec0182e0c46a6688780abb5824",
  "patch": "diff --git a/src/Functions/array/arrayEnumerateExtended.h b/src/Functions/array/arrayEnumerateExtended.h\nindex 412fe9e78586..39bdd2a515e8 100644\n--- a/src/Functions/array/arrayEnumerateExtended.h\n+++ b/src/Functions/array/arrayEnumerateExtended.h\n@@ -353,6 +353,9 @@ bool FunctionArrayEnumerateExtended<Derived>::execute128bit(\n         keys_bytes += key_sizes[j];\n     }\n \n+    if (keys_bytes > 16)\n+        return false;\n+\n     executeMethod<MethodFixed>(offsets, columns, key_sizes, nullptr, res_values);\n     return true;\n }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01677_array_enumerate_bug.reference b/tests/queries/0_stateless/01677_array_enumerate_bug.reference\nnew file mode 100644\nindex 000000000000..9c0e526801fd\n--- /dev/null\n+++ b/tests/queries/0_stateless/01677_array_enumerate_bug.reference\n@@ -0,0 +1,2 @@\n+[1,1,2]\n+[1,1,1]\ndiff --git a/tests/queries/0_stateless/01677_array_enumerate_bug.sql b/tests/queries/0_stateless/01677_array_enumerate_bug.sql\nnew file mode 100644\nindex 000000000000..0db0c51fe5b4\n--- /dev/null\n+++ b/tests/queries/0_stateless/01677_array_enumerate_bug.sql\n@@ -0,0 +1,13 @@\n+-- there was a bug - missing check of the total size of keys for the case with hash table with 128bit key.\n+\n+SELECT arrayEnumerateUniq(arrayEnumerateUniq([toInt256(10), toInt256(100), toInt256(2)]), [toInt256(123), toInt256(1023), toInt256(123)]);\n+\n+SELECT arrayEnumerateUniq(\n+    [111111, 222222, 333333],\n+    [444444, 555555, 666666],\n+    [111111, 222222, 333333],\n+    [444444, 555555, 666666],\n+    [111111, 222222, 333333],\n+    [444444, 555555, 666666],\n+    [111111, 222222, 333333],\n+    [444444, 555555, 666666]);\n",
  "problem_statement": "Unusual arguments for function arrayEnumerateUniq may cause crash or infinite loop\n**Describe the bug**\r\nhttps://clickhouse-test-reports.s3.yandex.net/19758/b9b573976e465670990c041ec303b59df1ee3919/fuzzer_asan/server.log\r\n\n",
  "hints_text": "",
  "created_at": "2021-01-29T01:42:51Z",
  "modified_files": [
    "src/Functions/array/arrayEnumerateExtended.h"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01677_array_enumerate_bug.reference",
    "b/tests/queries/0_stateless/01677_array_enumerate_bug.sql"
  ]
}