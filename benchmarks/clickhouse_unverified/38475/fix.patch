diff --git a/programs/disks/CommandCopy.cpp b/programs/disks/CommandCopy.cpp
index f9cd74442874..1e5852fe651e 100644
--- a/programs/disks/CommandCopy.cpp
+++ b/programs/disks/CommandCopy.cpp
@@ -1,6 +1,7 @@
 #pragma once
 
 #include "ICommand.h"
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/programs/disks/CommandLink.cpp b/programs/disks/CommandLink.cpp
index 6e9a7e64324d..af48f0de0971 100644
--- a/programs/disks/CommandLink.cpp
+++ b/programs/disks/CommandLink.cpp
@@ -1,6 +1,7 @@
 #pragma once
 
 #include "ICommand.h"
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/programs/disks/CommandList.cpp b/programs/disks/CommandList.cpp
index 8c6bfac3a9b7..e76bb9e65fba 100644
--- a/programs/disks/CommandList.cpp
+++ b/programs/disks/CommandList.cpp
@@ -1,6 +1,7 @@
 #pragma once
 
 #include "ICommand.h"
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/programs/disks/CommandListDisks.cpp b/programs/disks/CommandListDisks.cpp
index 2bcbb045d678..22cffdd21fd9 100644
--- a/programs/disks/CommandListDisks.cpp
+++ b/programs/disks/CommandListDisks.cpp
@@ -1,6 +1,7 @@
 #pragma once
 
 #include "ICommand.h"
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/programs/disks/CommandMove.cpp b/programs/disks/CommandMove.cpp
index 4a377cc7225f..6322cf4b47dc 100644
--- a/programs/disks/CommandMove.cpp
+++ b/programs/disks/CommandMove.cpp
@@ -1,6 +1,7 @@
 #pragma once
 
 #include "ICommand.h"
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/programs/disks/CommandRead.cpp b/programs/disks/CommandRead.cpp
index aa472fa217e6..6b77a27e918e 100644
--- a/programs/disks/CommandRead.cpp
+++ b/programs/disks/CommandRead.cpp
@@ -1,6 +1,7 @@
 #pragma once
 
 #include "ICommand.h"
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/programs/disks/CommandRemove.cpp b/programs/disks/CommandRemove.cpp
index d9925fbd93eb..c1d3129bb8db 100644
--- a/programs/disks/CommandRemove.cpp
+++ b/programs/disks/CommandRemove.cpp
@@ -1,6 +1,7 @@
 #pragma once
 
 #include "ICommand.h"
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/programs/disks/CommandWrite.cpp b/programs/disks/CommandWrite.cpp
index c8ae91ea8d51..0b1c5823c812 100644
--- a/programs/disks/CommandWrite.cpp
+++ b/programs/disks/CommandWrite.cpp
@@ -1,6 +1,7 @@
 #pragma once
 
 #include "ICommand.h"
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/src/Access/DiskAccessStorage.cpp b/src/Access/DiskAccessStorage.cpp
index 994abc7b53ac..0cbe420f3451 100644
--- a/src/Access/DiskAccessStorage.cpp
+++ b/src/Access/DiskAccessStorage.cpp
@@ -15,6 +15,7 @@
 #include <Poco/JSON/Stringifier.h>
 #include <boost/algorithm/string/case_conv.hpp>
 #include <boost/range/adaptor/map.hpp>
+#include <base/range.h>
 #include <filesystem>
 #include <fstream>
 
diff --git a/src/AggregateFunctions/parseAggregateFunctionParameters.h b/src/AggregateFunctions/parseAggregateFunctionParameters.h
index a67bc081303b..41a04324f6d0 100644
--- a/src/AggregateFunctions/parseAggregateFunctionParameters.h
+++ b/src/AggregateFunctions/parseAggregateFunctionParameters.h
@@ -8,6 +8,8 @@
 namespace DB
 {
 
+struct Array;
+
 Array getAggregateFunctionParametersArray(
     const ASTPtr & expression_list,
     const std::string & error_context,
diff --git a/src/Backups/registerBackupEnginesFileAndDisk.cpp b/src/Backups/registerBackupEnginesFileAndDisk.cpp
index 050a51939b60..380ae36a8e34 100644
--- a/src/Backups/registerBackupEnginesFileAndDisk.cpp
+++ b/src/Backups/registerBackupEnginesFileAndDisk.cpp
@@ -7,6 +7,7 @@
 #include <IO/Archives/hasRegisteredArchiveFileExtension.h>
 #include <Poco/Util/AbstractConfiguration.h>
 #include <filesystem>
+#include <Interpreters/Context.h>
 
 
 namespace DB
diff --git a/src/Common/ShellCommand.h b/src/Common/ShellCommand.h
index 190b5bc664ef..dfc4a826f620 100644
--- a/src/Common/ShellCommand.h
+++ b/src/Common/ShellCommand.h
@@ -3,6 +3,7 @@
 #include <memory>
 #include <IO/ReadBufferFromFile.h>
 #include <IO/WriteBufferFromFile.h>
+#include <unordered_map>
 
 
 namespace DB
diff --git a/src/Coordination/CoordinationSettings.cpp b/src/Coordination/CoordinationSettings.cpp
index 34d69967828a..4733adcf67a0 100644
--- a/src/Coordination/CoordinationSettings.cpp
+++ b/src/Coordination/CoordinationSettings.cpp
@@ -1,5 +1,4 @@
 #include <Coordination/CoordinationSettings.h>
-#include <Core/Settings.h>
 #include <Common/logger_useful.h>
 #include <filesystem>
 #include <Coordination/Defines.h>
diff --git a/src/Coordination/KeeperServer.cpp b/src/Coordination/KeeperServer.cpp
index 7c6ed227a067..864bb477786f 100644
--- a/src/Coordination/KeeperServer.cpp
+++ b/src/Coordination/KeeperServer.cpp
@@ -21,6 +21,7 @@
 #include <Poco/Util/AbstractConfiguration.h>
 #include <Poco/Util/Application.h>
 #include <Common/ZooKeeper/ZooKeeperIO.h>
+#include <Common/Stopwatch.h>
 
 namespace DB
 {
diff --git a/src/Core/Settings.h b/src/Core/Settings.h
index 8a1f47ec00ef..09d888a26aa4 100644
--- a/src/Core/Settings.h
+++ b/src/Core/Settings.h
@@ -607,6 +607,9 @@ static constexpr UInt64 operator""_GiB(unsigned long long value)
     \
     M(String, compatibility, "", "Changes other settings according to provided ClickHouse version. If we know that we changed some behaviour in ClickHouse by changing some settings in some version, this compatibility setting will control these settings", 0) \
     \
+    M(Map, additional_table_filters, "", "Additional filter expression which would be applied after reading from specified table. Syntax: {'table1': 'expression', 'database.table2': 'expression'}", 0) \
+    M(String, additional_result_filter, "", "Additional filter expression which would be applied to query result", 0) \
+    \
     /** Experimental functions */ \
     M(Bool, allow_experimental_funnel_functions, false, "Enable experimental functions for funnel analysis.", 0) \
     M(Bool, allow_experimental_nlp_functions, false, "Enable experimental functions for natural language processing.", 0) \
diff --git a/src/Core/SettingsFields.cpp b/src/Core/SettingsFields.cpp
index 827a457a5dc5..d77a510d7f9c 100644
--- a/src/Core/SettingsFields.cpp
+++ b/src/Core/SettingsFields.cpp
@@ -4,6 +4,8 @@
 #include <Common/getNumberOfPhysicalCPUCores.h>
 #include <Common/FieldVisitorConvertToNumber.h>
 #include <Common/logger_useful.h>
+#include <DataTypes/DataTypeMap.h>
+#include <DataTypes/DataTypeString.h>
 #include <IO/ReadHelpers.h>
 #include <IO/ReadBufferFromString.h>
 #include <IO/WriteHelpers.h>
@@ -51,6 +53,37 @@ namespace
         else
             return applyVisitor(FieldVisitorConvertToNumber<T>(), f);
     }
+
+#ifndef KEEPER_STANDALONE_BUILD
+    Map stringToMap(const String & str)
+    {
+        /// Allow empty string as an empty map
+        if (str.empty())
+            return {};
+
+        auto type_string = std::make_shared<DataTypeString>();
+        DataTypeMap type_map(type_string, type_string);
+        auto serialization = type_map.getSerialization(ISerialization::Kind::DEFAULT);
+        auto column = type_map.createColumn();
+
+        ReadBufferFromString buf(str);
+        serialization->deserializeTextEscaped(*column, buf, {});
+        return (*column)[0].safeGet<Map>();
+    }
+
+    Map fieldToMap(const Field & f)
+    {
+        if (f.getType() == Field::Types::String)
+        {
+            /// Allow to parse Map from string field. For the convenience.
+            const auto & str = f.get<const String &>();
+            return stringToMap(str);
+        }
+
+        return f.safeGet<const Map &>();
+    }
+#endif
+
 }
 
 template <typename T>
@@ -291,6 +324,48 @@ void SettingFieldString::readBinary(ReadBuffer & in)
     *this = std::move(str);
 }
 
+#ifndef KEEPER_STANDALONE_BUILD
+
+SettingFieldMap::SettingFieldMap(const Field & f) : value(fieldToMap(f)) {}
+
+String SettingFieldMap::toString() const
+{
+    auto type_string = std::make_shared<DataTypeString>();
+    DataTypeMap type_map(type_string, type_string);
+    auto serialization = type_map.getSerialization(ISerialization::Kind::DEFAULT);
+    auto column = type_map.createColumn();
+    column->insert(value);
+
+    WriteBufferFromOwnString out;
+    serialization->serializeTextEscaped(*column, 0, out, {});
+    return out.str();
+}
+
+
+SettingFieldMap & SettingFieldMap::operator =(const Field & f)
+{
+    *this = fieldToMap(f);
+    return *this;
+}
+
+void SettingFieldMap::parseFromString(const String & str)
+{
+    *this = stringToMap(str);
+}
+
+void SettingFieldMap::writeBinary(WriteBuffer & out) const
+{
+    DB::writeBinary(value, out);
+}
+
+void SettingFieldMap::readBinary(ReadBuffer & in)
+{
+    Map map;
+    DB::readBinary(map, in);
+    *this = map;
+}
+
+#endif
 
 namespace
 {
diff --git a/src/Core/SettingsFields.h b/src/Core/SettingsFields.h
index 4033eb2b5982..20f2b34084e8 100644
--- a/src/Core/SettingsFields.h
+++ b/src/Core/SettingsFields.h
@@ -168,6 +168,32 @@ struct SettingFieldString
     void readBinary(ReadBuffer & in);
 };
 
+#ifndef KEEPER_STANDALONE_BUILD
+
+struct SettingFieldMap
+{
+public:
+    Map value;
+    bool changed = false;
+
+    explicit SettingFieldMap(const Map & map = {}) : value(map) {}
+    explicit SettingFieldMap(Map && map) : value(std::move(map)) {}
+    explicit SettingFieldMap(const Field & f);
+
+    SettingFieldMap & operator =(const Map & map) { value = map; changed = true; return *this; }
+    SettingFieldMap & operator =(const Field & f);
+
+    operator const Map &() const { return value; } /// NOLINT
+    explicit operator Field() const { return value; }
+
+    String toString() const;
+    void parseFromString(const String & str);
+
+    void writeBinary(WriteBuffer & out) const;
+    void readBinary(ReadBuffer & in);
+};
+
+#endif
 
 struct SettingFieldChar
 {
diff --git a/src/Disks/DiskEncrypted.cpp b/src/Disks/DiskEncrypted.cpp
index 8edb00e5a67b..e6479727aad8 100644
--- a/src/Disks/DiskEncrypted.cpp
+++ b/src/Disks/DiskEncrypted.cpp
@@ -8,6 +8,8 @@
 #include <IO/ReadBufferFromString.h>
 #include <IO/WriteBufferFromEncryptedFile.h>
 #include <boost/algorithm/hex.hpp>
+#include <Common/quoteString.h>
+#include <Common/typeid_cast.h>
 
 
 namespace DB
diff --git a/src/Disks/IDisk.h b/src/Disks/IDisk.h
index 941df99298b3..2337fa00af5c 100644
--- a/src/Disks/IDisk.h
+++ b/src/Disks/IDisk.h
@@ -1,7 +1,6 @@
 #pragma once
 
 #include <Interpreters/Context_fwd.h>
-#include <Interpreters/Context.h>
 #include <Core/Defines.h>
 #include <base/types.h>
 #include <Common/CurrentMetrics.h>
@@ -41,6 +40,10 @@ namespace ErrorCodes
     extern const int NOT_IMPLEMENTED;
 }
 
+class IDisk;
+using DiskPtr = std::shared_ptr<IDisk>;
+using DisksMap = std::map<String, DiskPtr>;
+
 class IReservation;
 using ReservationPtr = std::unique_ptr<IReservation>;
 using Reservations = std::vector<ReservationPtr>;
@@ -363,7 +366,6 @@ class IDisk : public Space
     std::unique_ptr<Executor> executor;
 };
 
-using DiskPtr = std::shared_ptr<IDisk>;
 using Disks = std::vector<DiskPtr>;
 
 /**
diff --git a/src/Disks/IO/CachedReadBufferFromRemoteFS.cpp b/src/Disks/IO/CachedReadBufferFromRemoteFS.cpp
index b929cea02360..a3d5cfc408d0 100644
--- a/src/Disks/IO/CachedReadBufferFromRemoteFS.cpp
+++ b/src/Disks/IO/CachedReadBufferFromRemoteFS.cpp
@@ -6,6 +6,7 @@
 #include <Common/assert_cast.h>
 #include <Common/hex.h>
 #include <Common/getRandomASCIIString.h>
+#include <Interpreters/Context.h>
 
 
 namespace ProfileEvents
diff --git a/src/Disks/ObjectStorages/AzureBlobStorage/AzureObjectStorage.h b/src/Disks/ObjectStorages/AzureBlobStorage/AzureObjectStorage.h
index 6df093ebd433..34b3d86b3556 100644
--- a/src/Disks/ObjectStorages/AzureBlobStorage/AzureObjectStorage.h
+++ b/src/Disks/ObjectStorages/AzureBlobStorage/AzureObjectStorage.h
@@ -10,6 +10,7 @@
 #include <Disks/IO/WriteIndirectBufferFromRemoteFS.h>
 #include <Disks/ObjectStorages/IObjectStorage.h>
 #include <Common/getRandomASCIIString.h>
+#include <Common/MultiVersion.h>
 
 
 namespace DB
diff --git a/src/Disks/ObjectStorages/AzureBlobStorage/registerDiskAzureBlobStorage.cpp b/src/Disks/ObjectStorages/AzureBlobStorage/registerDiskAzureBlobStorage.cpp
index 44976b7cf2d6..dc70008649e4 100644
--- a/src/Disks/ObjectStorages/AzureBlobStorage/registerDiskAzureBlobStorage.cpp
+++ b/src/Disks/ObjectStorages/AzureBlobStorage/registerDiskAzureBlobStorage.cpp
@@ -12,6 +12,7 @@
 #include <Disks/ObjectStorages/AzureBlobStorage/AzureBlobStorageAuth.h>
 #include <Disks/ObjectStorages/AzureBlobStorage/AzureObjectStorage.h>
 #include <Disks/ObjectStorages/MetadataStorageFromDisk.h>
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/src/Disks/ObjectStorages/DiskObjectStorage.cpp b/src/Disks/ObjectStorages/DiskObjectStorage.cpp
index ca414a7ee72f..0b7d16bd895d 100644
--- a/src/Disks/ObjectStorages/DiskObjectStorage.cpp
+++ b/src/Disks/ObjectStorages/DiskObjectStorage.cpp
@@ -18,6 +18,7 @@
 #include <Disks/ObjectStorages/DiskObjectStorageTransaction.h>
 #include <Disks/FakeDiskTransaction.h>
 #include <Poco/Util/AbstractConfiguration.h>
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/src/Disks/ObjectStorages/DiskObjectStorageCommon.cpp b/src/Disks/ObjectStorages/DiskObjectStorageCommon.cpp
index 99606a185174..b8ab2f49202e 100644
--- a/src/Disks/ObjectStorages/DiskObjectStorageCommon.cpp
+++ b/src/Disks/ObjectStorages/DiskObjectStorageCommon.cpp
@@ -3,6 +3,7 @@
 #include <Common/FileCacheFactory.h>
 #include <Common/IFileCache.h>
 #include <Common/FileCacheSettings.h>
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/src/Disks/ObjectStorages/FakeMetadataStorageFromDisk.h b/src/Disks/ObjectStorages/FakeMetadataStorageFromDisk.h
index b6426df1e9af..6d5ae12a1575 100644
--- a/src/Disks/ObjectStorages/FakeMetadataStorageFromDisk.h
+++ b/src/Disks/ObjectStorages/FakeMetadataStorageFromDisk.h
@@ -1,5 +1,6 @@
 #pragma once
 
+#include <Disks/IDisk.h>
 #include <Disks/ObjectStorages/IMetadataStorage.h>
 #include <Disks/ObjectStorages/MetadataFromDiskTransactionState.h>
 #include <Disks/ObjectStorages/MetadataStorageFromDiskTransactionOperations.h>
diff --git a/src/Disks/ObjectStorages/IObjectStorage.cpp b/src/Disks/ObjectStorages/IObjectStorage.cpp
index f9c5c139b953..f3ac94768d80 100644
--- a/src/Disks/ObjectStorages/IObjectStorage.cpp
+++ b/src/Disks/ObjectStorages/IObjectStorage.cpp
@@ -2,6 +2,7 @@
 #include <Disks/IO/ThreadPoolRemoteFSReader.h>
 #include <IO/WriteBufferFromFileBase.h>
 #include <IO/copyData.h>
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/src/Disks/ObjectStorages/IObjectStorage.h b/src/Disks/ObjectStorages/IObjectStorage.h
index 06398b11aec5..1ab2d75ff866 100644
--- a/src/Disks/ObjectStorages/IObjectStorage.h
+++ b/src/Disks/ObjectStorages/IObjectStorage.h
@@ -7,6 +7,7 @@
 #include <optional>
 
 #include <Poco/Timestamp.h>
+#include <Poco/Util/AbstractConfiguration.h>
 #include <Core/Defines.h>
 #include <Common/Exception.h>
 #include <IO/ReadSettings.h>
diff --git a/src/Disks/ObjectStorages/S3/S3ObjectStorage.cpp b/src/Disks/ObjectStorages/S3/S3ObjectStorage.cpp
index 55c466d45f6c..d36bf655c023 100644
--- a/src/Disks/ObjectStorages/S3/S3ObjectStorage.cpp
+++ b/src/Disks/ObjectStorages/S3/S3ObjectStorage.cpp
@@ -28,6 +28,7 @@
 #include <Common/FileCacheFactory.h>
 #include <Common/getRandomASCIIString.h>
 #include <Common/logger_useful.h>
+#include <Common/MultiVersion.h>
 
 namespace DB
 {
diff --git a/src/Disks/ObjectStorages/S3/S3ObjectStorage.h b/src/Disks/ObjectStorages/S3/S3ObjectStorage.h
index 983972246296..8f20671d8413 100644
--- a/src/Disks/ObjectStorages/S3/S3ObjectStorage.h
+++ b/src/Disks/ObjectStorages/S3/S3ObjectStorage.h
@@ -11,6 +11,7 @@
 #include <aws/s3/model/HeadObjectResult.h>
 #include <aws/s3/model/ListObjectsV2Result.h>
 #include <Storages/StorageS3Settings.h>
+#include <Common/MultiVersion.h>
 
 
 namespace DB
diff --git a/src/IO/ReadBufferFromFileDescriptor.cpp b/src/IO/ReadBufferFromFileDescriptor.cpp
index 406b519df794..920e76cd7d0d 100644
--- a/src/IO/ReadBufferFromFileDescriptor.cpp
+++ b/src/IO/ReadBufferFromFileDescriptor.cpp
@@ -10,6 +10,7 @@
 #include <IO/Progress.h>
 #include <Common/filesystemHelpers.h>
 #include <sys/stat.h>
+#include <Interpreters/Context.h>
 
 
 #ifdef HAS_RESERVED_IDENTIFIER
diff --git a/src/IO/ReadBufferFromFileDescriptor.h b/src/IO/ReadBufferFromFileDescriptor.h
index 40b0717c8b15..73c651189cdf 100644
--- a/src/IO/ReadBufferFromFileDescriptor.h
+++ b/src/IO/ReadBufferFromFileDescriptor.h
@@ -1,7 +1,7 @@
 #pragma once
 
 #include <IO/ReadBufferFromFileBase.h>
-#include <Interpreters/Context.h>
+#include <Interpreters/Context_fwd.h>
 
 #include <unistd.h>
 
diff --git a/src/Interpreters/ExpressionAnalyzer.cpp b/src/Interpreters/ExpressionAnalyzer.cpp
index a4bdc4ed2523..8a14c09819a6 100644
--- a/src/Interpreters/ExpressionAnalyzer.cpp
+++ b/src/Interpreters/ExpressionAnalyzer.cpp
@@ -1842,6 +1842,7 @@ ExpressionAnalysisResult::ExpressionAnalysisResult(
     bool second_stage_,
     bool only_types,
     const FilterDAGInfoPtr & filter_info_,
+    const FilterDAGInfoPtr & additional_filter,
     const Block & source_header)
     : first_stage(first_stage_)
     , second_stage(second_stage_)
@@ -1908,6 +1909,13 @@ ExpressionAnalysisResult::ExpressionAnalysisResult(
                 columns_for_final.begin(), columns_for_final.end());
         }
 
+        if (storage && additional_filter)
+        {
+            Names columns_for_additional_filter = additional_filter->actions->getRequiredColumnsNames();
+            additional_required_columns_after_prewhere.insert(additional_required_columns_after_prewhere.end(),
+                columns_for_additional_filter.begin(), columns_for_additional_filter.end());
+        }
+
         if (storage && filter_info_)
         {
             filter_info = filter_info_;
diff --git a/src/Interpreters/ExpressionAnalyzer.h b/src/Interpreters/ExpressionAnalyzer.h
index 10c11499f14b..da92bc108322 100644
--- a/src/Interpreters/ExpressionAnalyzer.h
+++ b/src/Interpreters/ExpressionAnalyzer.h
@@ -281,6 +281,7 @@ struct ExpressionAnalysisResult
         bool second_stage,
         bool only_types,
         const FilterDAGInfoPtr & filter_info,
+        const FilterDAGInfoPtr & additional_filter, /// for setting additional_filters
         const Block & source_header);
 
     /// Filter for row-level security.
diff --git a/src/Interpreters/IInterpreterUnionOrSelectQuery.cpp b/src/Interpreters/IInterpreterUnionOrSelectQuery.cpp
index 4ac1d33468fa..05486f65da5c 100644
--- a/src/Interpreters/IInterpreterUnionOrSelectQuery.cpp
+++ b/src/Interpreters/IInterpreterUnionOrSelectQuery.cpp
@@ -4,6 +4,13 @@
 #include <Processors/QueryPlan/BuildQueryPipelineSettings.h>
 #include <Processors/QueryPlan/Optimizations/QueryPlanOptimizationSettings.h>
 #include <QueryPipeline/QueryPipelineBuilder.h>
+#include <Parsers/ExpressionListParsers.h>
+#include <Parsers/parseQuery.h>
+#include <Interpreters/TreeRewriter.h>
+#include <Interpreters/ActionsDAG.h>
+#include <Interpreters/ExpressionAnalyzer.h>
+#include <Processors/QueryPlan/IQueryPlanStep.h>
+#include <Processors/QueryPlan/FilterStep.h>
 
 namespace DB
 {
@@ -81,6 +88,53 @@ void IInterpreterUnionOrSelectQuery::setQuota(QueryPipeline & pipeline) const
     pipeline.setQuota(quota);
 }
 
+static ASTPtr parseAdditionalPostFilter(const Context & context)
+{
+    const auto & settings = context.getSettingsRef();
+    const String & filter = settings.additional_result_filter;
+    if (filter.empty())
+        return nullptr;
+
+    ParserExpression parser;
+    return parseQuery(
+                parser, filter.data(), filter.data() + filter.size(),
+                "additional filter", settings.max_query_size, settings.max_parser_depth);
+}
+
+static ActionsDAGPtr makeAdditionalPostFilter(ASTPtr & ast, ContextPtr context, const Block & header)
+{
+    auto syntax_result = TreeRewriter(context).analyze(ast, header.getNamesAndTypesList());
+    String result_column_name = ast->getColumnName();
+    auto dag = ExpressionAnalyzer(ast, syntax_result, context).getActionsDAG(false, false);
+    const ActionsDAG::Node * result_node = &dag->findInIndex(result_column_name);
+    auto & index = dag->getIndex();
+    index.clear();
+    index.reserve(dag->getInputs().size() + 1);
+    for (const auto * node : dag->getInputs())
+        index.push_back(node);
+
+    index.push_back(result_node);
+
+    return dag;
+}
+
+void IInterpreterUnionOrSelectQuery::addAdditionalPostFilter(QueryPlan & plan) const
+{
+    if (options.subquery_depth != 0)
+        return;
+
+    auto ast = parseAdditionalPostFilter(*context);
+    if (!ast)
+        return;
+
+    auto dag = makeAdditionalPostFilter(ast, context, plan.getCurrentDataStream().header);
+    std::string filter_name = dag->getIndex().back()->result_name;
+    auto filter_step = std::make_unique<FilterStep>(
+        plan.getCurrentDataStream(), std::move(dag), std::move(filter_name), true);
+    filter_step->setStepDescription("Additional result filter");
+    plan.addStep(std::move(filter_step));
+}
+
 void IInterpreterUnionOrSelectQuery::addStorageLimits(const StorageLimitsList & limits)
 {
     for (const auto & val : limits)
diff --git a/src/Interpreters/IInterpreterUnionOrSelectQuery.h b/src/Interpreters/IInterpreterUnionOrSelectQuery.h
index 98e0432f3d55..a1c86f9de857 100644
--- a/src/Interpreters/IInterpreterUnionOrSelectQuery.h
+++ b/src/Interpreters/IInterpreterUnionOrSelectQuery.h
@@ -72,6 +72,8 @@ class IInterpreterUnionOrSelectQuery : public IInterpreter
 
     /// Set quotas to query pipeline.
     void setQuota(QueryPipeline & pipeline) const;
+    /// Add filter from additional_post_filter setting.
+    void addAdditionalPostFilter(QueryPlan & plan) const;
 
     static StorageLimits getStorageLimits(const Context & context, const SelectQueryOptions & options);
 };
diff --git a/src/Interpreters/InterpreterSelectIntersectExceptQuery.cpp b/src/Interpreters/InterpreterSelectIntersectExceptQuery.cpp
index 4d0c82d33453..d6add3f77a9d 100644
--- a/src/Interpreters/InterpreterSelectIntersectExceptQuery.cpp
+++ b/src/Interpreters/InterpreterSelectIntersectExceptQuery.cpp
@@ -138,6 +138,7 @@ void InterpreterSelectIntersectExceptQuery::buildQueryPlan(QueryPlan & query_pla
     auto step = std::make_unique<IntersectOrExceptStep>(std::move(data_streams), final_operator, max_threads);
     query_plan.unitePlans(std::move(step), std::move(plans));
 
+    addAdditionalPostFilter(query_plan);
     query_plan.addInterpreterContext(context);
 }
 
diff --git a/src/Interpreters/InterpreterSelectQuery.cpp b/src/Interpreters/InterpreterSelectQuery.cpp
index a05d353ac733..56b6cd3c1362 100644
--- a/src/Interpreters/InterpreterSelectQuery.cpp
+++ b/src/Interpreters/InterpreterSelectQuery.cpp
@@ -109,8 +109,17 @@ namespace ErrorCodes
 }
 
 /// Assumes `storage` is set and the table filter (row-level security) is not empty.
-String InterpreterSelectQuery::generateFilterActions(ActionsDAGPtr & actions, const Names & prerequisite_columns) const
+FilterDAGInfoPtr generateFilterActions(
+    const StorageID & table_id,
+    const ASTPtr & row_policy_filter,
+    const ContextPtr & context,
+    const StoragePtr & storage,
+    const StorageSnapshotPtr & storage_snapshot,
+    const StorageMetadataPtr & metadata_snapshot,
+    Names & prerequisite_columns)
 {
+    auto filter_info = std::make_shared<FilterDAGInfo>();
+
     const auto & db_name = table_id.getDatabaseName();
     const auto & table_name = table_id.getTableName();
 
@@ -146,16 +155,24 @@ String InterpreterSelectQuery::generateFilterActions(ActionsDAGPtr & actions, co
     /// Using separate expression analyzer to prevent any possible alias injection
     auto syntax_result = TreeRewriter(context).analyzeSelect(query_ast, TreeRewriterResult({}, storage, storage_snapshot));
     SelectQueryExpressionAnalyzer analyzer(query_ast, syntax_result, context, metadata_snapshot);
-    actions = analyzer.simpleSelectActions();
+    filter_info->actions = analyzer.simpleSelectActions();
+
+    filter_info->column_name = expr_list->children.at(0)->getColumnName();
+    filter_info->actions->removeUnusedActions(NameSet{filter_info->column_name});
+    filter_info->actions->projectInput(false);
 
-    auto column_name = expr_list->children.at(0)->getColumnName();
-    actions->removeUnusedActions(NameSet{column_name});
-    actions->projectInput(false);
+    for (const auto * node : filter_info->actions->getInputs())
+        filter_info->actions->getIndex().push_back(node);
 
-    for (const auto * node : actions->getInputs())
-        actions->getIndex().push_back(node);
+    auto required_columns_from_filter = filter_info->actions->getRequiredColumns();
+
+    for (const auto & column : required_columns_from_filter)
+    {
+        if (prerequisite_columns.end() == std::find(prerequisite_columns.begin(), prerequisite_columns.end(), column.name))
+            prerequisite_columns.push_back(column.name);
+    }
 
-    return column_name;
+    return filter_info;
 }
 
 InterpreterSelectQuery::InterpreterSelectQuery(
@@ -269,6 +286,32 @@ static void checkAccessRightsForSelect(
     context->checkAccess(AccessType::SELECT, table_id, syntax_analyzer_result.requiredSourceColumnsForAccessCheck());
 }
 
+static ASTPtr parseAdditionalFilterConditionForTable(
+    const Map & setting,
+    const DatabaseAndTableWithAlias & target,
+    const Context & context)
+{
+    for (size_t i = 0; i < setting.size(); ++i)
+    {
+        const auto & tuple = setting[i].safeGet<const Tuple &>();
+        auto & table = tuple.at(0).safeGet<String>();
+        auto & filter = tuple.at(1).safeGet<String>();
+
+        if ((table == target.table && context.getCurrentDatabase() == target.database) ||
+            (table == target.database + '.' + target.table))
+        {
+            /// Try to parse expression
+            ParserExpression parser;
+            const auto & settings = context.getSettingsRef();
+            return parseQuery(
+                parser, filter.data(), filter.data() + filter.size(),
+                "additional filter", settings.max_query_size, settings.max_parser_depth);
+        }
+    }
+
+    return nullptr;
+}
+
 /// Returns true if we should ignore quotas and limits for a specified table in the system database.
 static bool shouldIgnoreQuotaAndLimits(const StorageID & table_id)
 {
@@ -448,6 +491,10 @@ InterpreterSelectQuery::InterpreterSelectQuery(
     if (storage)
         view = dynamic_cast<StorageView *>(storage.get());
 
+    if (!settings.additional_table_filters.value.empty() && storage && !joined_tables.tablesWithColumns().empty())
+        query_info.additional_filter_ast = parseAdditionalFilterConditionForTable(
+            settings.additional_table_filters, joined_tables.tablesWithColumns().front().table, *context);
+
     auto analyze = [&] (bool try_move_to_prewhere)
     {
         /// Allow push down and other optimizations for VIEW: replace with subquery and rewrite it.
@@ -566,16 +613,16 @@ InterpreterSelectQuery::InterpreterSelectQuery(
             /// Fix source_header for filter actions.
             if (row_policy_filter)
             {
-                filter_info = std::make_shared<FilterDAGInfo>();
-                filter_info->column_name = generateFilterActions(filter_info->actions, required_columns);
+                filter_info = generateFilterActions(
+                    table_id, row_policy_filter, context, storage, storage_snapshot, metadata_snapshot, required_columns);
+            }
 
-                auto required_columns_from_filter = filter_info->actions->getRequiredColumns();
+            if (query_info.additional_filter_ast)
+            {
+                additional_filter_info = generateFilterActions(
+                    table_id, query_info.additional_filter_ast, context, storage, storage_snapshot, metadata_snapshot, required_columns);
 
-                for (const auto & column : required_columns_from_filter)
-                {
-                    if (required_columns.end() == std::find(required_columns.begin(), required_columns.end(), column.name))
-                        required_columns.push_back(column.name);
-                }
+                additional_filter_info->do_remove_column = true;
             }
 
             source_header = storage_snapshot->getSampleBlockForColumns(required_columns);
@@ -735,7 +782,7 @@ Block InterpreterSelectQuery::getSampleBlockImpl()
         && options.to_stage > QueryProcessingStage::WithMergeableState;
 
     analysis_result = ExpressionAnalysisResult(
-        *query_analyzer, metadata_snapshot, first_stage, second_stage, options.only_analyze, filter_info, source_header);
+        *query_analyzer, metadata_snapshot, first_stage, second_stage, options.only_analyze, filter_info, additional_filter_info, source_header);
 
     if (options.to_stage == QueryProcessingStage::Enum::FetchColumns)
     {
@@ -1303,6 +1350,18 @@ void InterpreterSelectQuery::executeImpl(QueryPlan & query_plan, std::optional<P
                 query_plan.addStep(std::move(row_level_security_step));
             }
 
+            if (additional_filter_info)
+            {
+                auto additional_filter_step = std::make_unique<FilterStep>(
+                    query_plan.getCurrentDataStream(),
+                    additional_filter_info->actions,
+                    additional_filter_info->column_name,
+                    additional_filter_info->do_remove_column);
+
+                additional_filter_step->setStepDescription("Additional filter");
+                query_plan.addStep(std::move(additional_filter_step));
+            }
+
             if (expressions.before_array_join)
             {
                 QueryPlanStepPtr before_array_join_step
@@ -1945,6 +2004,7 @@ void InterpreterSelectQuery::executeFetchColumns(QueryProcessingStage::Enum proc
         && storage
         && storage->getName() != "MaterializedMySQL"
         && !row_policy_filter
+        && !query_info.additional_filter_ast
         && processing_stage == QueryProcessingStage::FetchColumns
         && query_analyzer->hasAggregation()
         && (query_analyzer->aggregates().size() == 1)
@@ -2044,6 +2104,7 @@ void InterpreterSelectQuery::executeFetchColumns(QueryProcessingStage::Enum proc
         && !query.limit_with_ties
         && !query.prewhere()
         && !query.where()
+        && !query_info.additional_filter_ast
         && !query.groupBy()
         && !query.having()
         && !query.orderBy()
diff --git a/src/Interpreters/InterpreterSelectQuery.h b/src/Interpreters/InterpreterSelectQuery.h
index a95ff00bc0dc..e70490f13ac8 100644
--- a/src/Interpreters/InterpreterSelectQuery.h
+++ b/src/Interpreters/InterpreterSelectQuery.h
@@ -189,8 +189,6 @@ class InterpreterSelectQuery : public IInterpreterUnionOrSelectQuery
     void
     executeMergeSorted(QueryPlan & query_plan, const SortDescription & sort_description, UInt64 limit, const std::string & description);
 
-    String generateFilterActions(ActionsDAGPtr & actions, const Names & prerequisite_columns = {}) const;
-
     enum class Modificator
     {
         ROLLUP = 0,
@@ -217,6 +215,9 @@ class InterpreterSelectQuery : public IInterpreterUnionOrSelectQuery
     ASTPtr row_policy_filter;
     FilterDAGInfoPtr filter_info;
 
+    /// For additional_filter setting.
+    FilterDAGInfoPtr additional_filter_info;
+
     QueryProcessingStage::Enum from_stage = QueryProcessingStage::FetchColumns;
 
     /// List of columns to read to execute the query.
diff --git a/src/Interpreters/InterpreterSelectWithUnionQuery.cpp b/src/Interpreters/InterpreterSelectWithUnionQuery.cpp
index 9f87a47fced0..bdec44b74f7c 100644
--- a/src/Interpreters/InterpreterSelectWithUnionQuery.cpp
+++ b/src/Interpreters/InterpreterSelectWithUnionQuery.cpp
@@ -357,6 +357,7 @@ void InterpreterSelectWithUnionQuery::buildQueryPlan(QueryPlan & query_plan)
         }
     }
 
+    addAdditionalPostFilter(query_plan);
     query_plan.addInterpreterContext(context);
 }
 
diff --git a/src/Parsers/IAST.h b/src/Parsers/IAST.h
index b73919f4f368..1999eff37a8d 100644
--- a/src/Parsers/IAST.h
+++ b/src/Parsers/IAST.h
@@ -5,7 +5,6 @@
 #include <Parsers/IdentifierQuotingStyle.h>
 #include <Common/Exception.h>
 #include <Common/TypePromotion.h>
-#include <Core/Settings.h>
 #include <IO/WriteBufferFromString.h>
 
 #include <algorithm>
@@ -26,7 +25,7 @@ namespace ErrorCodes
 using IdentifierNameSet = std::set<String>;
 
 class WriteBuffer;
-
+using Strings = std::vector<String>;
 
 /** Element of the syntax tree (hereinafter - directed acyclic graph with elements of semantics)
   */
diff --git a/src/Parsers/MySQL/ASTDeclareOption.h b/src/Parsers/MySQL/ASTDeclareOption.h
index a95299245676..c493c49c61bc 100644
--- a/src/Parsers/MySQL/ASTDeclareOption.h
+++ b/src/Parsers/MySQL/ASTDeclareOption.h
@@ -3,6 +3,7 @@
 #include <Parsers/IAST.h>
 #include <Parsers/IParserBase.h>
 #include <Parsers/CommonParsers.h>
+#include <unordered_map>
 
 namespace DB
 {
diff --git a/src/Parsers/ParserSetQuery.cpp b/src/Parsers/ParserSetQuery.cpp
index 5f69db633ac4..0ff437bcfb17 100644
--- a/src/Parsers/ParserSetQuery.cpp
+++ b/src/Parsers/ParserSetQuery.cpp
@@ -12,12 +12,63 @@
 namespace DB
 {
 
+class ParserLiteralOrMap : public IParserBase
+{
+public:
+protected:
+    const char * getName() const override { return "literal or map"; }
+    bool parseImpl(Pos & pos, ASTPtr & node, Expected & expected) override
+    {
+        {
+            ParserLiteral literal;
+            if (literal.parse(pos, node, expected))
+                return true;
+        }
+
+        ParserToken l_br(TokenType::OpeningCurlyBrace);
+        ParserToken r_br(TokenType::ClosingCurlyBrace);
+        ParserToken comma(TokenType::Comma);
+        ParserToken colon(TokenType::Colon);
+        ParserStringLiteral literal;
+
+        if (!l_br.ignore(pos, expected))
+            return false;
+
+        Map map;
+
+        while (!r_br.ignore(pos, expected))
+        {
+            if (!map.empty() && !comma.ignore(pos, expected))
+                return false;
+
+            ASTPtr key;
+            ASTPtr val;
+
+            if (!literal.parse(pos, key, expected))
+                return false;
+
+            if (!colon.ignore(pos, expected))
+                return false;
+
+            if (!literal.parse(pos, val, expected))
+                return false;
+
+            Tuple tuple;
+            tuple.push_back(std::move(key->as<ASTLiteral>()->value));
+            tuple.push_back(std::move(val->as<ASTLiteral>()->value));
+            map.push_back(std::move(tuple));
+        }
+
+        node = std::make_shared<ASTLiteral>(std::move(map));
+        return true;
+    }
+};
 
 /// Parse `name = value`.
 bool ParserSetQuery::parseNameValuePair(SettingChange & change, IParser::Pos & pos, Expected & expected)
 {
     ParserCompoundIdentifier name_p;
-    ParserLiteral value_p;
+    ParserLiteralOrMap value_p;
     ParserToken s_eq(TokenType::Equals);
 
     ASTPtr name;
diff --git a/src/Processors/Formats/Impl/ArrowBufferedStreams.cpp b/src/Processors/Formats/Impl/ArrowBufferedStreams.cpp
index 5232d9166af0..ebd9783b4fd4 100644
--- a/src/Processors/Formats/Impl/ArrowBufferedStreams.cpp
+++ b/src/Processors/Formats/Impl/ArrowBufferedStreams.cpp
@@ -13,6 +13,7 @@
 #include <arrow/buffer.h>
 #include <arrow/io/memory.h>
 #include <arrow/result.h>
+#include <Core/Settings.h>
 
 #include <sys/stat.h>
 
diff --git a/src/Processors/QueryPlan/ReadFromMergeTree.cpp b/src/Processors/QueryPlan/ReadFromMergeTree.cpp
index b4e143cc0027..473798b1a2b9 100644
--- a/src/Processors/QueryPlan/ReadFromMergeTree.cpp
+++ b/src/Processors/QueryPlan/ReadFromMergeTree.cpp
@@ -7,6 +7,7 @@
 #include <IO/Operators.h>
 #include <Interpreters/ExpressionAnalyzer.h>
 #include <Interpreters/TreeRewriter.h>
+#include <Interpreters/Context.h>
 #include <Parsers/ASTFunction.h>
 #include <Parsers/ASTIdentifier.h>
 #include <Parsers/ASTSelectQuery.h>
diff --git a/src/Processors/QueryPlan/ReadFromMergeTree.h b/src/Processors/QueryPlan/ReadFromMergeTree.h
index 5d5c7e9cb2c6..46be5ea1d7d7 100644
--- a/src/Processors/QueryPlan/ReadFromMergeTree.h
+++ b/src/Processors/QueryPlan/ReadFromMergeTree.h
@@ -1,6 +1,7 @@
 #pragma once
 #include <Processors/QueryPlan/ISourceStep.h>
 #include <Storages/MergeTree/RangesInDataPart.h>
+#include <Storages/MergeTree/RequestResponse.h>
 
 namespace DB
 {
@@ -9,6 +10,8 @@ using PartitionIdToMaxBlock = std::unordered_map<String, Int64>;
 
 class Pipe;
 
+using MergeTreeReadTaskCallback = std::function<std::optional<PartitionReadResponse>(PartitionReadRequest)>;
+
 struct MergeTreeDataSelectSamplingData
 {
     bool use_sampling = false;
diff --git a/src/Processors/TTL/TTLAggregationAlgorithm.cpp b/src/Processors/TTL/TTLAggregationAlgorithm.cpp
index d8b022f0acb1..0d160b8d32d6 100644
--- a/src/Processors/TTL/TTLAggregationAlgorithm.cpp
+++ b/src/Processors/TTL/TTLAggregationAlgorithm.cpp
@@ -1,4 +1,5 @@
 #include <Processors/TTL/TTLAggregationAlgorithm.h>
+#include <Interpreters/Context.h>
 
 namespace DB
 {
diff --git a/src/QueryPipeline/RemoteInserter.cpp b/src/QueryPipeline/RemoteInserter.cpp
index ce2ba23576d2..58fed6e54664 100644
--- a/src/QueryPipeline/RemoteInserter.cpp
+++ b/src/QueryPipeline/RemoteInserter.cpp
@@ -7,6 +7,7 @@
 #include <Common/CurrentThread.h>
 #include <Interpreters/InternalTextLogsQueue.h>
 #include <IO/ConnectionTimeouts.h>
+#include <Core/Settings.h>
 
 
 namespace DB
diff --git a/src/Server/KeeperTCPHandler.h b/src/Server/KeeperTCPHandler.h
index 9895c335c96a..ee83c4fa21b7 100644
--- a/src/Server/KeeperTCPHandler.h
+++ b/src/Server/KeeperTCPHandler.h
@@ -9,7 +9,6 @@
 #include <Common/MultiVersion.h>
 #include "IServer.h"
 #include <Common/Stopwatch.h>
-#include <Interpreters/Context.h>
 #include <Common/ZooKeeper/ZooKeeperCommon.h>
 #include <Common/ZooKeeper/ZooKeeperConstants.h>
 #include <Common/ConcurrentBoundedQueue.h>
diff --git a/src/Storages/MergeTree/BackgroundJobsAssignee.cpp b/src/Storages/MergeTree/BackgroundJobsAssignee.cpp
index 81445f40ed6f..9617d16f6f1f 100644
--- a/src/Storages/MergeTree/BackgroundJobsAssignee.cpp
+++ b/src/Storages/MergeTree/BackgroundJobsAssignee.cpp
@@ -2,6 +2,7 @@
 #include <Storages/MergeTree/MergeTreeData.h>
 #include <Common/CurrentMetrics.h>
 #include <Common/randomSeed.h>
+#include <Interpreters/Context.h>
 #include <pcg_random.hpp>
 #include <random>
 
diff --git a/src/Storages/MergeTree/IMergeTreeReader.cpp b/src/Storages/MergeTree/IMergeTreeReader.cpp
index b8aeb8e6a5a5..3acb4910e284 100644
--- a/src/Storages/MergeTree/IMergeTreeReader.cpp
+++ b/src/Storages/MergeTree/IMergeTreeReader.cpp
@@ -4,6 +4,7 @@
 #include <Compression/CachedCompressedReadBuffer.h>
 #include <Columns/ColumnArray.h>
 #include <Interpreters/inplaceBlockConversions.h>
+#include <Interpreters/Context.h>
 #include <Storages/MergeTree/IMergeTreeReader.h>
 #include <Common/typeid_cast.h>
 
diff --git a/src/Storages/MergeTree/MergePlainMergeTreeTask.h b/src/Storages/MergeTree/MergePlainMergeTreeTask.h
index 0f6d38d2cbfa..7488b9655fe2 100644
--- a/src/Storages/MergeTree/MergePlainMergeTreeTask.h
+++ b/src/Storages/MergeTree/MergePlainMergeTreeTask.h
@@ -4,6 +4,7 @@
 #include <Storages/MergeTree/MergeTask.h>
 #include <Storages/MutationCommands.h>
 #include <Storages/MergeTree/MergeMutateSelectedEntry.h>
+#include <Interpreters/MergeTreeTransactionHolder.h>
 
 namespace DB
 {
diff --git a/src/Storages/MergeTree/MergeTreeData.h b/src/Storages/MergeTree/MergeTreeData.h
index 26ac4d362ec5..7c3bc21f3910 100644
--- a/src/Storages/MergeTree/MergeTreeData.h
+++ b/src/Storages/MergeTree/MergeTreeData.h
@@ -56,6 +56,9 @@ struct ZeroCopyLock;
 class IBackupEntry;
 using BackupEntries = std::vector<std::pair<String, std::shared_ptr<const IBackupEntry>>>;
 
+class MergeTreeTransaction;
+using MergeTreeTransactionPtr = std::shared_ptr<MergeTreeTransaction>;
+
 /// Auxiliary struct holding information about the future merged or mutated part.
 struct EmergingPartInfo
 {
diff --git a/src/Storages/MergeTree/MergeTreePartition.cpp b/src/Storages/MergeTree/MergeTreePartition.cpp
index 81026989f955..4ea6ec11ecca 100644
--- a/src/Storages/MergeTree/MergeTreePartition.cpp
+++ b/src/Storages/MergeTree/MergeTreePartition.cpp
@@ -2,6 +2,7 @@
 #include <Storages/MergeTree/MergeTreeData.h>
 #include <Storages/MergeTree/IMergeTreeDataPart.h>
 #include <IO/HashingWriteBuffer.h>
+#include <Interpreters/Context.h>
 #include <Common/FieldVisitors.h>
 #include <DataTypes/DataTypeDate.h>
 #include <DataTypes/DataTypeTuple.h>
diff --git a/src/Storages/MergeTree/MergeTreeWriteAheadLog.cpp b/src/Storages/MergeTree/MergeTreeWriteAheadLog.cpp
index 3eb638d15c08..9ed8fe0ad14a 100644
--- a/src/Storages/MergeTree/MergeTreeWriteAheadLog.cpp
+++ b/src/Storages/MergeTree/MergeTreeWriteAheadLog.cpp
@@ -6,6 +6,7 @@
 #include <IO/MemoryReadWriteBuffer.h>
 #include <IO/ReadHelpers.h>
 #include <IO/copyData.h>
+#include <Interpreters/Context.h>
 #include <Poco/JSON/JSON.h>
 #include <Poco/JSON/Object.h>
 #include <Poco/JSON/Stringifier.h>
diff --git a/src/Storages/ReadInOrderOptimizer.cpp b/src/Storages/ReadInOrderOptimizer.cpp
index 3ff4baa0b11b..b188cef065ef 100644
--- a/src/Storages/ReadInOrderOptimizer.cpp
+++ b/src/Storages/ReadInOrderOptimizer.cpp
@@ -6,6 +6,7 @@
 #include <Interpreters/replaceAliasColumnsInQuery.h>
 #include <Functions/IFunction.h>
 #include <Interpreters/TableJoin.h>
+#include <Interpreters/Context.h>
 #include <Parsers/ASTSelectQuery.h>
 #include <Parsers/ASTFunction.h>
 
diff --git a/src/Storages/SelectQueryInfo.h b/src/Storages/SelectQueryInfo.h
index bdb4c392c480..5046a0b6fe00 100644
--- a/src/Storages/SelectQueryInfo.h
+++ b/src/Storages/SelectQueryInfo.h
@@ -156,6 +156,10 @@ struct SelectQueryInfoBase
 
     PrewhereInfoPtr prewhere_info;
 
+    /// This is an additional filer applied to current table.
+    /// It is needed only for additional PK filtering.
+    ASTPtr additional_filter_ast;
+
     ReadInOrderOptimizerPtr order_optimizer;
     /// Can be modified while reading from storage
     InputOrderInfoPtr input_order_info;
diff --git a/src/Storages/System/StorageSystemParts.cpp b/src/Storages/System/StorageSystemParts.cpp
index 01bba669c0ec..1b207d1d165f 100644
--- a/src/Storages/System/StorageSystemParts.cpp
+++ b/src/Storages/System/StorageSystemParts.cpp
@@ -13,6 +13,7 @@
 #include <Parsers/queryToString.h>
 #include <Common/hex.h>
 #include <Interpreters/TransactionVersionMetadata.h>
+#include <Interpreters/Context.h>
 
 namespace DB
 {
