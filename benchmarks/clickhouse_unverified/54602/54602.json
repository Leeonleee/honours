{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 54602,
  "instance_id": "ClickHouse__ClickHouse-54602",
  "issue_numbers": [
    "49028"
  ],
  "base_commit": "98cddf5312722e403dcea429639ac13dc6cada33",
  "patch": "diff --git a/docs/en/operations/settings/settings.md b/docs/en/operations/settings/settings.md\nindex edc1c9bdfd77..4bbac98a5797 100644\n--- a/docs/en/operations/settings/settings.md\n+++ b/docs/en/operations/settings/settings.md\n@@ -460,6 +460,12 @@ Possible values:\n \n Default value: 1048576.\n \n+## http_make_head_request {#http-make-head-request}\n+\n+The `http_make_head_request` setting allows the execution of a `HEAD` request while reading data from HTTP to retrieve information about the file to be read, such as its size. Since it's enabled by default, it may be desirable to disable this setting in cases where the server does not support `HEAD` requests.\n+\n+Default value: `true`.\n+\n ## table_function_remote_max_addresses {#table_function_remote_max_addresses}\n \n Sets the maximum number of addresses generated from patterns for the [remote](../../sql-reference/table-functions/remote.md) function.\ndiff --git a/src/Core/Settings.h b/src/Core/Settings.h\nindex 448656aa435b..03d5853261c8 100644\n--- a/src/Core/Settings.h\n+++ b/src/Core/Settings.h\n@@ -333,6 +333,7 @@ class IColumn;\n     M(UInt64, http_max_field_value_size, 128 * 1024, \"Maximum length of field value in HTTP header\", 0) \\\n     M(UInt64, http_max_chunk_size, 100_GiB, \"Maximum value of a chunk size in HTTP chunked transfer encoding\", 0) \\\n     M(Bool, http_skip_not_found_url_for_globs, true, \"Skip url's for globs with HTTP_NOT_FOUND error\", 0) \\\n+    M(Bool, http_make_head_request, true, \"Allows the execution of a `HEAD` request while reading data from HTTP to retrieve information about the file to be read, such as its size\", 0) \\\n     M(Bool, optimize_throw_if_noop, false, \"If setting is enabled and OPTIMIZE query didn't actually assign a merge then an explanatory exception is thrown\", 0) \\\n     M(Bool, use_index_for_in_with_subqueries, true, \"Try using an index if there is a subquery or a table expression on the right side of the IN operator.\", 0) \\\n     M(UInt64, use_index_for_in_with_subqueries_max_values, 0, \"The maximum size of set in the right hand side of the IN operator to use table index for filtering. It allows to avoid performance degradation and higher memory usage due to preparation of additional data structures for large queries. Zero means no limit.\", 0) \\\ndiff --git a/src/IO/ReadSettings.h b/src/IO/ReadSettings.h\nindex 4c8a6cb020ac..a8a31d82e56a 100644\n--- a/src/IO/ReadSettings.h\n+++ b/src/IO/ReadSettings.h\n@@ -120,6 +120,7 @@ struct ReadSettings\n     size_t http_retry_initial_backoff_ms = 100;\n     size_t http_retry_max_backoff_ms = 1600;\n     bool http_skip_not_found_url_for_globs = true;\n+    bool http_make_head_request = true;\n \n     /// Monitoring\n     bool for_object_storage = false; // to choose which profile events should be incremented\ndiff --git a/src/IO/ReadWriteBufferFromHTTP.cpp b/src/IO/ReadWriteBufferFromHTTP.cpp\nindex 6dd6269e16fd..96f05889882a 100644\n--- a/src/IO/ReadWriteBufferFromHTTP.cpp\n+++ b/src/IO/ReadWriteBufferFromHTTP.cpp\n@@ -808,6 +808,11 @@ std::optional<time_t> ReadWriteBufferFromHTTPBase<UpdatableSessionPtr>::tryGetLa\n template <typename UpdatableSessionPtr>\n HTTPFileInfo ReadWriteBufferFromHTTPBase<UpdatableSessionPtr>::getFileInfo()\n {\n+    /// May be disabled in case the user knows in advance that the server doesn't support HEAD requests.\n+    /// Allows to avoid making unnecessary requests in such cases.\n+    if (!settings.http_make_head_request)\n+        return HTTPFileInfo{};\n+\n     Poco::Net::HTTPResponse response;\n     try\n     {\ndiff --git a/src/Interpreters/Context.cpp b/src/Interpreters/Context.cpp\nindex 185f9782da57..ba45e7c064e2 100644\n--- a/src/Interpreters/Context.cpp\n+++ b/src/Interpreters/Context.cpp\n@@ -4843,6 +4843,7 @@ ReadSettings Context::getReadSettings() const\n     res.http_retry_initial_backoff_ms = settings.http_retry_initial_backoff_ms;\n     res.http_retry_max_backoff_ms = settings.http_retry_max_backoff_ms;\n     res.http_skip_not_found_url_for_globs = settings.http_skip_not_found_url_for_globs;\n+    res.http_make_head_request = settings.http_make_head_request;\n \n     res.mmap_cache = getMMappedFileCache().get();\n \n",
  "test_patch": "diff --git a/tests/ci/stress.py b/tests/ci/stress.py\nindex ae918363df7f..91b8694623b4 100755\n--- a/tests/ci/stress.py\n+++ b/tests/ci/stress.py\n@@ -68,6 +68,9 @@ def get_options(i: int, upgrade_check: bool) -> str:\n     if random.random() < 0.1:\n         client_options.append(\"optimize_trivial_approximate_count_query=1\")\n \n+    if random.random() < 0.3:\n+        client_options.append(f\"http_make_head_request={random.randint(0, 1)}\")\n+\n     if client_options:\n         options.append(\" --client-option \" + \" \".join(client_options))\n \n",
  "problem_statement": "Propose SETTING make_head_request=0 for engine=URL and url() table function\n**Use case**\r\n\r\nCurrently, clickhouse makes two HTTP requests during SELECT data from `engine=URL()` and `url()` table function\r\nfirst `HEAD` to receive Content-Length header and decide to allow parallel download\r\nsecond `GET` to retrieve whole content body\r\n\r\nFor some dynamic HTTP endpoints, generating data twice maybe a heavy operation. \r\nMoreover, custom HTTP servers may not implement HEAD method support and return error.\r\n\r\n**Describe the solution you'd like**\r\nI propose to add `SETTING make_head_request=0` for `engine=URL()` and `url()` table function\r\n\n",
  "hints_text": "> Moreover, custom HTTP servers may not implement HEAD method support and return error.\r\n\r\nThis case should already be supported.\n> Moreover, custom HTTP servers may not implement HEAD method support and return error.\r\n\r\nYes returning a \"501 NotImplemented\" is fine and CH still works\n@fionera but also HEAD operation could be heavy and server could make work twice",
  "created_at": "2023-09-13T16:52:35Z",
  "modified_files": [
    "docs/en/operations/settings/settings.md",
    "src/Core/Settings.h",
    "src/IO/ReadSettings.h",
    "src/IO/ReadWriteBufferFromHTTP.cpp",
    "src/Interpreters/Context.cpp"
  ],
  "modified_test_files": [
    "tests/ci/stress.py"
  ]
}