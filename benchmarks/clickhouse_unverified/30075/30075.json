{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 30075,
  "instance_id": "ClickHouse__ClickHouse-30075",
  "issue_numbers": [
    "29957"
  ],
  "base_commit": "e95a4a35ef5e718399ae23072da01f4f22b2c6e8",
  "patch": "diff --git a/src/Interpreters/UserDefinedSQLFunctionVisitor.cpp b/src/Interpreters/UserDefinedSQLFunctionVisitor.cpp\nindex 6471f9cbf628..cc5db0203870 100644\n--- a/src/Interpreters/UserDefinedSQLFunctionVisitor.cpp\n+++ b/src/Interpreters/UserDefinedSQLFunctionVisitor.cpp\n@@ -93,6 +93,11 @@ ASTPtr UserDefinedSQLFunctionMatcher::tryToReplaceFunction(const ASTFunction & f\n         }\n     }\n \n+    auto function_alias = function.tryGetAlias();\n+\n+    if (!function_alias.empty())\n+        function_body_to_update->setAlias(function_alias);\n+\n     return function_body_to_update;\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02096_sql_user_defined_function_alias.reference b/tests/queries/0_stateless/02096_sql_user_defined_function_alias.reference\nnew file mode 100644\nindex 000000000000..18bca00293c8\n--- /dev/null\n+++ b/tests/queries/0_stateless/02096_sql_user_defined_function_alias.reference\n@@ -0,0 +1,1 @@\n+a\tUInt16\t\t\t\t\t\ndiff --git a/tests/queries/0_stateless/02096_sql_user_defined_function_alias.sql b/tests/queries/0_stateless/02096_sql_user_defined_function_alias.sql\nnew file mode 100644\nindex 000000000000..70e6572629ec\n--- /dev/null\n+++ b/tests/queries/0_stateless/02096_sql_user_defined_function_alias.sql\n@@ -0,0 +1,5 @@\n+-- Tags: no-parallel\n+\n+CREATE FUNCTION 02096_test_function AS x -> x + 1;\n+DESCRIBE (SELECT 02096_test_function(1) AS a);\n+DROP FUNCTION 02096_test_function;\n",
  "problem_statement": "User function alias\nHi, I may have found a bug. \r\n\r\nClickHouse client version 21.10.1.8013 (official build).\r\n\r\n```\r\nCREATE FUNCTION now_debug AS () -> toDateTime('2021-07-01 12:35:34');\r\n```\r\n\r\n```\r\n:) select now_debug() as _now_debug, now() as _now;\r\n\r\nSELECT\r\n    now_debug() AS _now_debug,\r\n    now() AS _now\r\n\r\nQuery id: 4f7840e9-4a92-4d16-a33e-a307af1316d2\r\n\r\n\u250c\u2500toDateTime('2021-07-01 12:35:34')\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_now\u2500\u2510\r\n\u2502               2021-07-01 12:35:34 \u2502 2021-10-10 19:50:44 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 rows in set. Elapsed: 0.002 sec.\r\n```\r\n\r\nExpected _now_debug, result toDateTime('2021-07-01 12:35:34')\r\n\n",
  "hints_text": "Do you mean that the alias is lost?\nyep. also incorrect work WITH t AS ()\n```\r\nWITH t AS\r\n    (\r\n        SELECT\r\n            now_debug() AS _now_debug,\r\n            now() AS _now\r\n    )\r\nSELECT\r\n    _now,\r\n    _now_debug\r\nFROM t\r\n\r\nQuery id: 3fc45b3f-dd7e-4b5b-9066-86bd4189fdba\r\n\r\n\r\n0 rows in set. Elapsed: 0.002 sec.\r\n\r\nReceived exception from server (version 21.10.1):\r\nCode: 47. DB::Exception: Received from 127.0.0.1:9000. DB::Exception: Missing columns: '_now_debug' while processing query: 'WITH t AS (SELECT toDateTime('2021-07-01 12:35:34'), now() AS _now) SELECT _now, _now_debug FROM t', required columns: '_now' '_now_debug' '_now' '_now_debug'. (UNKNOWN_IDENTIFIER)\r\n```",
  "created_at": "2021-10-12T21:16:41Z",
  "modified_files": [
    "src/Interpreters/UserDefinedSQLFunctionVisitor.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02096_sql_user_defined_function_alias.reference",
    "b/tests/queries/0_stateless/02096_sql_user_defined_function_alias.sql"
  ]
}