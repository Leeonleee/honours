diff --git a/dbms/src/DataStreams/SummingSortedBlockInputStream.cpp b/dbms/src/DataStreams/SummingSortedBlockInputStream.cpp
index 85b8d70f2964..a56b2928fc54 100644
--- a/dbms/src/DataStreams/SummingSortedBlockInputStream.cpp
+++ b/dbms/src/DataStreams/SummingSortedBlockInputStream.cpp
@@ -323,22 +323,24 @@ void SummingSortedBlockInputStream::merge(MutableColumns & merged_columns, std::
 
         if (current_key.empty())    /// The first key encountered.
         {
-            setPrimaryKeyRef(current_key, current);
             key_differs = true;
+            current_row_is_zero = true;
         }
         else
             key_differs = next_key != current_key;
 
-        /// if there are enough rows and the last one is calculated completely
-        if (key_differs && merged_rows >= max_block_size)
-            return;
-
-        queue.pop();
-
         if (key_differs)
         {
-            /// Write the data for the previous group.
-            insertCurrentRowIfNeeded(merged_columns, false);
+            if (!current_key.empty())
+                /// Write the data for the previous group.
+                insertCurrentRowIfNeeded(merged_columns, false);
+
+            if (merged_rows >= max_block_size)
+            {
+                /// The block is now full and the last row is calculated completely.
+                current_key.reset();
+                return;
+            }
 
             current_key.swap(next_key);
 
@@ -375,6 +377,8 @@ void SummingSortedBlockInputStream::merge(MutableColumns & merged_columns, std::
                     current_row_is_zero = false;
         }
 
+        queue.pop();
+
         if (!current->isLast())
         {
             current->next();
@@ -481,6 +485,9 @@ void SummingSortedBlockInputStream::addRow(SortCursor & cursor)
 {
     for (auto & desc : columns_to_aggregate)
     {
+        if (!desc.created)
+            throw Exception("Logical error in SummingSortedBlockInputStream, there are no description", ErrorCodes::LOGICAL_ERROR);
+
         if (desc.is_agg_func_type)
         {
             // desc.state is not used for AggregateFunction types
@@ -489,9 +496,6 @@ void SummingSortedBlockInputStream::addRow(SortCursor & cursor)
         }
         else
         {
-            if (!desc.created)
-                throw Exception("Logical error in SummingSortedBlockInputStream, there are no description", ErrorCodes::LOGICAL_ERROR);
-
             // Specialized case for unary functions
             if (desc.column_numbers.size() == 1)
             {
