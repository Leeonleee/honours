{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 10390,
  "instance_id": "ClickHouse__ClickHouse-10390",
  "issue_numbers": [
    "10259"
  ],
  "base_commit": "4ecc86becab4570e9bff67075f650e688da2e7d5",
  "patch": "diff --git a/src/DataTypes/NestedUtils.cpp b/src/DataTypes/NestedUtils.cpp\nindex e988490a487a..5f8b9f877bf9 100644\n--- a/src/DataTypes/NestedUtils.cpp\n+++ b/src/DataTypes/NestedUtils.cpp\n@@ -86,7 +86,8 @@ Block flatten(const Block & block)\n     {\n         if (const DataTypeArray * type_arr = typeid_cast<const DataTypeArray *>(elem.type.get()))\n         {\n-            if (const DataTypeTuple * type_tuple = typeid_cast<const DataTypeTuple *>(type_arr->getNestedType().get()))\n+            const DataTypeTuple * type_tuple = typeid_cast<const DataTypeTuple *>(type_arr->getNestedType().get());\n+            if (type_tuple && type_tuple->haveExplicitNames())\n             {\n                 const DataTypes & element_types = type_tuple->getElements();\n                 const Strings & names = type_tuple->getElementNames();\ndiff --git a/src/DataTypes/NestedUtils.h b/src/DataTypes/NestedUtils.h\nindex 098d98699e44..3039fd7f118a 100644\n--- a/src/DataTypes/NestedUtils.h\n+++ b/src/DataTypes/NestedUtils.h\n@@ -17,6 +17,7 @@ namespace Nested\n     std::string extractTableName(const std::string & nested_name);\n \n     /// Replace Array(Tuple(...)) columns to a multiple of Array columns in a form of `column_name.element_name`.\n+    /// only for named tuples that actually represent Nested structures.\n     Block flatten(const Block & block);\n \n     /// Collect Array columns in a form of `column_name.element_name` to single Array(Tuple(...)) column.\ndiff --git a/src/Storages/ColumnsDescription.h b/src/Storages/ColumnsDescription.h\nindex 72399a701283..4fbb041d1242 100644\n--- a/src/Storages/ColumnsDescription.h\n+++ b/src/Storages/ColumnsDescription.h\n@@ -61,6 +61,7 @@ class ColumnsDescription\n     /// TODO add ability to rename nested columns\n     void rename(const String & column_from, const String & column_to);\n \n+    /// NOTE Must correspond with Nested::flatten function.\n     void flattenNested(); /// TODO: remove, insert already flattened Nested columns.\n \n     bool operator==(const ColumnsDescription & other) const { return columns == other.columns; }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01254_array_of_unnamed_tuples.reference b/tests/queries/0_stateless/01254_array_of_unnamed_tuples.reference\nnew file mode 100644\nindex 000000000000..0342c7b7310c\n--- /dev/null\n+++ b/tests/queries/0_stateless/01254_array_of_unnamed_tuples.reference\n@@ -0,0 +1,10 @@\n+[(nan,1.1460459347849696e-169)]\t`xbguF\t1493493065813843889\n+[(-2.6774132404843463e217,-1.5941466176583548e-32)]\t?/;UTko\t8163231169061670909\n+[(4.559039863342969e-218,1.1023812988249403e186)]\tk3Igp@\t9512519566588292358\n+[(-6.156499824044965e254,2.125276757267567e176)]\t\t12763761121429990320\n+[]\tTlL\t10781278062399783511\n+[(-1.6511853645079817e-21,-1.5094564365588905e303)]\tUeS}D\t1158449958889177529\n+[(-5.109297304033652e229,-8.565674764550042e219),(-2.163260216301827e-75,-3.771562357185976e285)]\t0Z3|h\t12502841092151487477\n+[]\t-]\t2092132020040612180\n+[(-2.9588901009588613e-146,-6.4241843242744556e268)]\t&b!M-e;7\t10616749141511339887\n+[(3.084905744030789e-98,-4.973771413288743e177),(-1.8198487259356486e114,1.2449864950522508e251)]\tDj7peUH{T\t5992776369613298329\ndiff --git a/tests/queries/0_stateless/01254_array_of_unnamed_tuples.sql b/tests/queries/0_stateless/01254_array_of_unnamed_tuples.sql\nnew file mode 100644\nindex 000000000000..3660d66620c6\n--- /dev/null\n+++ b/tests/queries/0_stateless/01254_array_of_unnamed_tuples.sql\n@@ -0,0 +1,5 @@\n+DROP TABLE IF EXISTS mass_table_457;\n+CREATE TABLE mass_table_457 (key Array(Tuple(Float64, Float64)), name String, value UInt64) ENGINE = Memory;\n+INSERT INTO mass_table_457 SELECT * FROM generateRandom('`key` Array(Tuple(Float64, Float64)),`name` String,`value` UInt64', 1, 10, 2) LIMIT 10;\n+SELECT * FROM mass_table_457;\n+DROP TABLE mass_table_457;\ndiff --git a/tests/queries/0_stateless/01255_geo_types_livace.reference b/tests/queries/0_stateless/01255_geo_types_livace.reference\nnew file mode 100644\nindex 000000000000..3982d6fb18a2\n--- /dev/null\n+++ b/tests/queries/0_stateless/01255_geo_types_livace.reference\n@@ -0,0 +1,2 @@\n+[(123,456),(789,234)]\t[(567,890)]\n+[]\t[(11,22),(33,44),(55,66)]\ndiff --git a/tests/queries/0_stateless/01255_geo_types_livace.sql b/tests/queries/0_stateless/01255_geo_types_livace.sql\nnew file mode 100644\nindex 000000000000..0838f0fa2191\n--- /dev/null\n+++ b/tests/queries/0_stateless/01255_geo_types_livace.sql\n@@ -0,0 +1,9 @@\n+DROP TABLE IF EXISTS tutorial;\n+create table tutorial ( inner_poly  Array(Tuple(Int32, Int32)), outer_poly  Array(Tuple(Int32, Int32)) ) engine = Log();\n+\n+SELECT * FROM tutorial;\n+\n+INSERT INTO tutorial VALUES ([(123, 456), (789, 234)], [(567, 890)]), ([], [(11, 22), (33, 44), (55, 66)]);\n+SELECT * FROM tutorial;\n+\n+DROP TABLE tutorial;\n",
  "problem_statement": "Logical error: 'Invalid number of columns in chunk pushed to OutputPort. Expected 3, found 4\n**Describe the bug**\r\n```\r\n2020.04.14 18:05:13.586410 [ 562595 ] {5a6d54a2-907a-4d3e-aed6-b88e34bec3b7} <Error> : Logical error: 'Invalid number of columns in chunk pushed to OutputPort. Expected 3, found 4\r\nHeader: key Array(Tuple(Float64, Float64)) Array(size = 0, UInt64(size = 0), Tuple(size = 0, Float64(size = 0), Float64(size = 0))), name String String(size = 0), value UInt64 UInt64(size = 0)\r\nChunk:  Array(size = 100, UInt64(size = 100), Float64(size = 98)) Array(size = 100, UInt64(size = 100), Float64(size = 98)) String(size = 100) UInt64(size = 100)\r\n'.\r\nclickhouse-server: ../src/Common/Exception.cpp:37: DB::Exception::Exception(const std::string &, int): Assertion `false' failed.\r\n2020.04.14 18:05:13.587173 [ 561495 ] {} <Trace> BaseDaemon: Received signal 6\r\n2020.04.14 18:05:13.588054 [ 570747 ] {} <Fatal> BaseDaemon: ########################################\r\n2020.04.14 18:05:13.588437 [ 570747 ] {} <Fatal> BaseDaemon: (version 20.4.1.1) (from thread 562595) (query_id: 5a6d54a2-907a-4d3e-aed6-b88e34bec3b7) Received signal Aborted (6).\r\n2020.04.14 18:05:13.588555 [ 570747 ] {} <Fatal> BaseDaemon:\r\n2020.04.14 18:05:13.588711 [ 570747 ] {} <Fatal> BaseDaemon: Stack trace: 0x7f4dc44ede97 0x7f4dc44ef801 0x7f4dc44df39a 0x7f4dc44df412 0xcfa18e9 0x13b86227 0x13be3120 0x13be2784 0x13be6604 0x12e3510d 0x13ea7424 0x12e3510d 0x13ea7424 0x12e3510d 0x12e3b330 0x12e3510d 0x12e3492c 0x12e3510d 0x12e5b42c 0x12e5b3d7 0x1339e51e 0x12e3510d 0x12e2f06d 0x12e30873 0x12e3071d 0x12e306cd 0x12e3069d 0x12e2f6de\r\n2020.04.14 18:05:13.589253 [ 570747 ] {} <Fatal> BaseDaemon: 4. /build/glibc-OTsEL5/glibc-2.27/signal/../sysdeps/unix/sysv/linux/raise.c:51: gsignal @ 0x3ee97 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.27.so\r\n2020.04.14 18:05:13.589466 [ 570747 ] {} <Fatal> BaseDaemon: 5. /build/glibc-OTsEL5/glibc-2.27/stdlib/abort.c:81: __GI_abort @ 0x40801 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.27.so\r\n2020.04.14 18:05:13.589595 [ 570747 ] {} <Fatal> BaseDaemon: 6. /build/glibc-OTsEL5/glibc-2.27/assert/assert.c:89: __assert_fail_base @ 0x3039a in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.27.so\r\n2020.04.14 18:05:13.589854 [ 570747 ] {} <Fatal> BaseDaemon: 7. ? @ 0x30412 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.27.so\r\n2020.04.14 18:05:13.590170 [ 570747 ] {} <Fatal> BaseDaemon: 8. /home/qoega/clickhouse/build/../src/Common/Exception.cpp:40: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0xcfa18e9 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.618653 [ 570747 ] {} <Fatal> BaseDaemon: 9. /home/qoega/clickhouse/build/../src/Processors/Port.h:412: DB::ISource::prepare() @ 0x13b86227 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.648523 [ 570747 ] {} <Fatal> BaseDaemon: 10. /home/qoega/clickhouse/build/../src/Processors/Executors/TreeExecutorBlockInputStream.cpp:158: DB::TreeExecutorBlockInputStream::execute(bool, bool)::$_0::operator()(DB::IProcessor*) const @ 0x13be3120 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.676216 [ 570747 ] {} <Fatal> BaseDaemon: 11. /home/qoega/clickhouse/build/../src/Processors/Executors/TreeExecutorBlockInputStream.cpp:171: DB::TreeExecutorBlockInputStream::execute(bool, bool) @ 0x13be2784 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.704687 [ 570747 ] {} <Fatal> BaseDaemon: 12. /home/qoega/clickhouse/build/../src/Processors/Executors/TreeExecutorBlockInputStream.cpp:298: DB::TreeExecutorBlockInputStream::readImpl() @ 0x13be6604 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.720433 [ 561498 ] {} <Trace> SystemLog (system.trace_log): Flushing system log\r\n2020.04.14 18:05:13.722336 [ 561498 ] {} <Debug> DiskLocal: Reserving 1.00 MiB on disk `default`, having unreserved 94.40 GiB.\r\n2020.04.14 18:05:13.723772 [ 561498 ] {} <Trace> system.trace_log: Renaming temporary part tmp_insert_202004_13_13_0 to 202004_13_13_0.\r\n2020.04.14 18:05:13.729178 [ 570747 ] {} <Fatal> BaseDaemon: 13. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.760320 [ 570747 ] {} <Fatal> BaseDaemon: 14. /home/qoega/clickhouse/build/../src/DataStreams/ExpressionBlockInputStream.cpp:41: DB::ExpressionBlockInputStream::readImpl() @ 0x13ea7424 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.784195 [ 570747 ] {} <Fatal> BaseDaemon: 15. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.814658 [ 570747 ] {} <Fatal> BaseDaemon: 16. /home/qoega/clickhouse/build/../src/DataStreams/ExpressionBlockInputStream.cpp:41: DB::ExpressionBlockInputStream::readImpl() @ 0x13ea7424 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.839155 [ 570747 ] {} <Fatal> BaseDaemon: 17. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.864113 [ 570747 ] {} <Fatal> BaseDaemon: 18. /home/qoega/clickhouse/build/../src/DataStreams/LimitBlockInputStream.cpp:96: DB::LimitBlockInputStream::readImpl() @ 0x12e3b330 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.889343 [ 570747 ] {} <Fatal> BaseDaemon: 19. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.911551 [ 570747 ] {} <Fatal> BaseDaemon: 20. /home/qoega/clickhouse/build/../src/DataStreams/ConvertingBlockInputStream.cpp:95: DB::ConvertingBlockInputStream::readImpl() @ 0x12e3492c in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.913151 [ 561497 ] {} <Trace> SystemLog (system.query_thread_log): Flushing system log\r\n2020.04.14 18:05:13.925049 [ 561497 ] {} <Debug> DiskLocal: Reserving 1.00 MiB on disk `default`, having unreserved 94.40 GiB.\r\n2020.04.14 18:05:13.929372 [ 561497 ] {} <Trace> system.query_thread_log: Renaming temporary part tmp_insert_202004_13_13_0 to 202004_13_13_0.\r\n2020.04.14 18:05:13.934538 [ 570747 ] {} <Fatal> BaseDaemon: 21. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.958926 [ 570747 ] {} <Fatal> BaseDaemon: 22. /home/qoega/clickhouse/build/../src/DataStreams/copyData.cpp:29: void DB::copyDataImpl<DB::copyData(DB::IBlockInputStream&, DB::IBlockOutputStream&, std::__1::atomic<bool>*)::$_0&, void (&)(DB::Block const&)>(DB::IBlockInputStream&, DB::IBlockOutputStream&, DB::copyData(DB::IBlockInputStream&, DB::IBlockOutputStream&, std::__1::atomic<bool>*)::$_0&, void (&)(DB::Block const&)) @ 0x12e5b42c in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:13.983819 [ 570747 ] {} <Fatal> BaseDaemon: 23. /home/qoega/clickhouse/build/../src/DataStreams/copyData.cpp:139: DB::copyData(DB::IBlockInputStream&, DB::IBlockOutputStream&, std::__1::atomic<bool>*) @ 0x12e5b3d7 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:14.011604 [ 570747 ] {} <Fatal> BaseDaemon: 24. /home/qoega/clickhouse/build/../src/DataStreams/NullAndDoCopyBlockInputStream.h:57: DB::NullAndDoCopyBlockInputStream::readImpl() @ 0x1339e51e in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:14.035825 [ 570747 ] {} <Fatal> BaseDaemon: 25. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:14.059049 [ 570747 ] {} <Fatal> BaseDaemon: 26. /home/qoega/clickhouse/build/../src/DataStreams/AsynchronousBlockInputStream.cpp:74: DB::AsynchronousBlockInputStream::calculate() @ 0x12e2f06d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:14.064259 [ 561496 ] {} <Trace> SystemLog (system.query_log): Flushing system log\r\n2020.04.14 18:05:14.082256 [ 570747 ] {} <Fatal> BaseDaemon: 27. /home/qoega/clickhouse/build/../src/DataStreams/AsynchronousBlockInputStream.cpp:59: DB::AsynchronousBlockInputStream::next()::$_0::operator()() const @ 0x12e30873 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:14.087580 [ 561496 ] {} <Debug> DiskLocal: Reserving 1.00 MiB on disk `default`, having unreserved 94.40 GiB.\r\n2020.04.14 18:05:14.092963 [ 561496 ] {} <Trace> system.query_log: Renaming temporary part tmp_insert_202004_13_13_0 to 202004_13_13_0.\r\n2020.04.14 18:05:14.106271 [ 570747 ] {} <Fatal> BaseDaemon: 28. /home/qoega/clickhouse/build/../contrib/libcxx/include/type_traits:3519: decltype(std::__1::forward<DB::AsynchronousBlockInputStream::next()::$_0&>(fp)()) std::__1::__invoke<DB::AsynchronousBlockInputStream::next()::$_0&>(DB::AsynchronousBlockInputStream::next()::$_0&) @ 0x12e3071d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:14.131384 [ 570747 ] {} <Fatal> BaseDaemon: 29. /home/qoega/clickhouse/build/../contrib/libcxx/include/__functional_base:349: void std::__1::__invoke_void_return_wrapper<void>::__call<DB::AsynchronousBlockInputStream::next()::$_0&>(DB::AsynchronousBlockInputStream::next()::$_0&) @ 0x12e306cd in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:14.155745 [ 570747 ] {} <Fatal> BaseDaemon: 30. /home/qoega/clickhouse/build/../contrib/libcxx/include/functional:1540: std::__1::__function::__alloc_func<DB::AsynchronousBlockInputStream::next()::$_0, std::__1::allocator<DB::AsynchronousBlockInputStream::next()::$_0>, void ()>::operator()() @ 0x12e3069d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:05:14.178511 [ 570747 ] {} <Fatal> BaseDaemon: 31. /home/qoega/clickhouse/build/../contrib/libcxx/include/functional:1714: std::__1::__function::__func<DB::AsynchronousBlockInputStream::next()::$_0, std::__1::allocator<DB::AsynchronousBlockInputStream::next()::$_0>, void ()>::operator()() @ 0x12e2f6de in /home/qoega/clickhouse/build/programs/clickhouse\r\nAborted (core dumped)\r\n```\r\n**How to reproduce**\r\n* Which ClickHouse server version to use \r\n20.4\r\n``` sql\r\nCREATE TABLE mass_table_457 (key Array(Tuple(Float64, Float64)), name String, value UInt64) ENGINE = Memory;\r\n\r\nINSERT INTO mass_table_457 SELECT * FROM generateRandom('`key` Array(Tuple(Float64, Float64)),`name` String,`value` UInt64', 1, 10, 2) LIMIT 100\r\n\r\n```\r\n**Expected behavior**\r\nA clear and concise description of what you expected to happen.\r\n\r\n**Error message and/or stacktrace**\r\nIf applicable, add screenshots to help explain your problem.\r\n\r\n**Additional context**\r\nAdd any other context about the problem here.\r\n\n",
  "hints_text": "``` sql\r\nCREATE TABLE mass_table_701 ENGINE = MergeTree ORDER BY number AS SELECT number, arrayMap (x -> (x, [x], [[x]], (x, toString(x))), arrayMap(x -> range(x), range(number % 10))) AS value FROM system.numbers LIMIT 100000;\r\nINSERT INTO mass_table_701 SELECT * FROM generateRandom('`number` UInt64,`value` Array(Tuple(Array(UInt8), Array(Array(UInt8)), Array(Array(Array(UInt8))), Tuple(Array(UInt8), String)))', 1, 10, 2) LIMIT 100\r\n```\r\n\r\n```\r\n2020.04.14 18:40:56.867172 [ 589718 ] {543ac269-9b3c-4db4-ad94-aa30f520a4a2} <Debug> executeQuery: (from [::1]:57070) INSERT INTO mass_table_701 SELECT * FROM generateRandom('`number` UInt64,`value` Array(Tuple(Array(UInt8), Array(Array(UInt8)), Array(Array(Array(UInt8))), Tuple(Array(UInt8), String)))', 1, 10, 2) LIMIT 100\r\n2020.04.14 18:40:56.867607 [ 589718 ] {543ac269-9b3c-4db4-ad94-aa30f520a4a2} <Trace> ContextAccess (default): Access granted: INSERT(number, value) ON tmp1.mass_table_701\r\n2020.04.14 18:40:56.867968 [ 589718 ] {543ac269-9b3c-4db4-ad94-aa30f520a4a2} <Trace> ContextAccess (default): Access granted: CREATE TEMPORARY TABLE ON *.*\r\n2020.04.14 18:40:56.873871 [ 589718 ] {543ac269-9b3c-4db4-ad94-aa30f520a4a2} <Trace> InterpreterSelectQuery: FetchColumns -> Complete\r\n2020.04.14 18:40:56.875359 [ 589718 ] {543ac269-9b3c-4db4-ad94-aa30f520a4a2} <Debug> executeQuery: Query pipeline:\r\nNullAndDoCopy\r\n Converting\r\n  Limit\r\n   Expression\r\n    Expression\r\n     TreeExecutor\r\n\r\n2020.04.14 18:40:56.877452 [ 589291 ] {543ac269-9b3c-4db4-ad94-aa30f520a4a2} <Error> : Logical error: 'Invalid number of columns in chunk pushed to OutputPort. Expected 2, found 5\r\nHeader: number UInt64 UInt64(size = 0), value Array(Tuple(Array(UInt8), Array(Array(UInt8)), Array(Array(Array(UInt8))), Tuple(Array(UInt8), String))) Array(size = 0, UInt64(size = 0), Tuple(size = 0, Array(size = 0, UInt64(size = 0), UInt8(size = 0)), Array(size = 0, UInt64(size = 0), Array(size = 0, UInt64(size = 0), UInt8(size = 0))), Array(size = 0, UInt64(size = 0), Array(size = 0, UInt64(size = 0), Array(size = 0, UInt64(size = 0), UInt8(size = 0)))), Tuple(size = 0, Array(size = 0, UInt64(size = 0), UInt8(size = 0)), String(size = 0))))\r\nChunk:  UInt64(size = 100) Array(size = 100, UInt64(size = 100), Array(size = 100, UInt64(size = 100), UInt8(size = 109))) Array(size = 100, UInt64(size = 100), Array(size = 100, UInt64(size = 100), Array(size = 112, UInt64(size = 112), UInt8(size = 104)))) Array(size = 100, UInt64(size = 100), Array(size = 100, UInt64(size = 100), Array(size = 103, UInt64(size = 103), Array(size = 109, UInt64(size = 109), UInt8(size = 106))))) Array(size = 100, UInt64(size = 100), Tuple(size = 100, Array(size = 100, UInt64(size = 100), UInt8(size = 102)), String(size = 100)))\r\n'.\r\nclickhouse-server: ../src/Common/Exception.cpp:37: DB::Exception::Exception(const std::string &, int): Assertion `false' failed.\r\n2020.04.14 18:40:56.878679 [ 588926 ] {} <Trace> BaseDaemon: Received signal 6\r\n2020.04.14 18:40:56.879293 [ 594093 ] {} <Fatal> BaseDaemon: ########################################\r\n2020.04.14 18:40:56.879516 [ 594093 ] {} <Fatal> BaseDaemon: (version 20.4.1.1) (from thread 589291) (query_id: 543ac269-9b3c-4db4-ad94-aa30f520a4a2) Received signal Aborted (6).\r\n2020.04.14 18:40:56.879606 [ 594093 ] {} <Fatal> BaseDaemon:\r\n2020.04.14 18:40:56.879749 [ 594093 ] {} <Fatal> BaseDaemon: Stack trace: 0x7f960e9fee97 0x7f960ea00801 0x7f960e9f039a 0x7f960e9f0412 0xcfa18e9 0x13b86227 0x13be3120 0x13be2784 0x13be6604 0x12e3510d 0x13ea7424 0x12e3510d 0x13ea7424 0x12e3510d 0x12e3b330 0x12e3510d 0x12e3492c 0x12e3510d 0x12e5b42c 0x12e5b3d7 0x1339e51e 0x12e3510d 0x12e2f06d 0x12e30873 0x12e3071d 0x12e306cd 0x12e3069d 0x12e2f6de\r\n2020.04.14 18:40:56.880103 [ 594093 ] {} <Fatal> BaseDaemon: 4. /build/glibc-OTsEL5/glibc-2.27/signal/../sysdeps/unix/sysv/linux/raise.c:51: gsignal @ 0x3ee97 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.27.so\r\n2020.04.14 18:40:56.880301 [ 594093 ] {} <Fatal> BaseDaemon: 5. /build/glibc-OTsEL5/glibc-2.27/stdlib/abort.c:81: __GI_abort @ 0x40801 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.27.so\r\n2020.04.14 18:40:56.880443 [ 594093 ] {} <Fatal> BaseDaemon: 6. /build/glibc-OTsEL5/glibc-2.27/assert/assert.c:89: __assert_fail_base @ 0x3039a in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.27.so\r\n2020.04.14 18:40:56.880725 [ 594093 ] {} <Fatal> BaseDaemon: 7. ? @ 0x30412 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.27.so\r\n2020.04.14 18:40:56.881050 [ 594093 ] {} <Fatal> BaseDaemon: 8. /home/qoega/clickhouse/build/../src/Common/Exception.cpp:40: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0xcfa18e9 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:56.907975 [ 594093 ] {} <Fatal> BaseDaemon: 9. /home/qoega/clickhouse/build/../src/Processors/Port.h:412: DB::ISource::prepare() @ 0x13b86227 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:56.935001 [ 594093 ] {} <Fatal> BaseDaemon: 10. /home/qoega/clickhouse/build/../src/Processors/Executors/TreeExecutorBlockInputStream.cpp:158: DB::TreeExecutorBlockInputStream::execute(bool, bool)::$_0::operator()(DB::IProcessor*) const @ 0x13be3120 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:56.965381 [ 594093 ] {} <Fatal> BaseDaemon: 11. /home/qoega/clickhouse/build/../src/Processors/Executors/TreeExecutorBlockInputStream.cpp:171: DB::TreeExecutorBlockInputStream::execute(bool, bool) @ 0x13be2784 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:56.994406 [ 594093 ] {} <Fatal> BaseDaemon: 12. /home/qoega/clickhouse/build/../src/Processors/Executors/TreeExecutorBlockInputStream.cpp:298: DB::TreeExecutorBlockInputStream::readImpl() @ 0x13be6604 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.016836 [ 594093 ] {} <Fatal> BaseDaemon: 13. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.045662 [ 594093 ] {} <Fatal> BaseDaemon: 14. /home/qoega/clickhouse/build/../src/DataStreams/ExpressionBlockInputStream.cpp:41: DB::ExpressionBlockInputStream::readImpl() @ 0x13ea7424 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.068670 [ 594093 ] {} <Fatal> BaseDaemon: 15. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.097237 [ 594093 ] {} <Fatal> BaseDaemon: 16. /home/qoega/clickhouse/build/../src/DataStreams/ExpressionBlockInputStream.cpp:41: DB::ExpressionBlockInputStream::readImpl() @ 0x13ea7424 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.122686 [ 594093 ] {} <Fatal> BaseDaemon: 17. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.147093 [ 594093 ] {} <Fatal> BaseDaemon: 18. /home/qoega/clickhouse/build/../src/DataStreams/LimitBlockInputStream.cpp:96: DB::LimitBlockInputStream::readImpl() @ 0x12e3b330 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.171474 [ 594093 ] {} <Fatal> BaseDaemon: 19. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.194136 [ 594093 ] {} <Fatal> BaseDaemon: 20. /home/qoega/clickhouse/build/../src/DataStreams/ConvertingBlockInputStream.cpp:95: DB::ConvertingBlockInputStream::readImpl() @ 0x12e3492c in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.218524 [ 594093 ] {} <Fatal> BaseDaemon: 21. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.243026 [ 594093 ] {} <Fatal> BaseDaemon: 22. /home/qoega/clickhouse/build/../src/DataStreams/copyData.cpp:29: void DB::copyDataImpl<DB::copyData(DB::IBlockInputStream&, DB::IBlockOutputStream&, std::__1::atomic<bool>*)::$_0&, void (&)(DB::Block const&)>(DB::IBlockInputStream&, DB::IBlockOutputStream&, DB::copyData(DB::IBlockInputStream&, DB::IBlockOutputStream&, std::__1::atomic<bool>*)::$_0&, void (&)(DB::Block const&)) @ 0x12e5b42c in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.267407 [ 594093 ] {} <Fatal> BaseDaemon: 23. /home/qoega/clickhouse/build/../src/DataStreams/copyData.cpp:139: DB::copyData(DB::IBlockInputStream&, DB::IBlockOutputStream&, std::__1::atomic<bool>*) @ 0x12e5b3d7 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.295088 [ 594093 ] {} <Fatal> BaseDaemon: 24. /home/qoega/clickhouse/build/../src/DataStreams/NullAndDoCopyBlockInputStream.h:57: DB::NullAndDoCopyBlockInputStream::readImpl() @ 0x1339e51e in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.320408 [ 594093 ] {} <Fatal> BaseDaemon: 25. /home/qoega/clickhouse/build/../src/DataStreams/IBlockInputStream.cpp:60: DB::IBlockInputStream::read() @ 0x12e3510d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.345688 [ 594093 ] {} <Fatal> BaseDaemon: 26. /home/qoega/clickhouse/build/../src/DataStreams/AsynchronousBlockInputStream.cpp:74: DB::AsynchronousBlockInputStream::calculate() @ 0x12e2f06d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.371275 [ 594093 ] {} <Fatal> BaseDaemon: 27. /home/qoega/clickhouse/build/../src/DataStreams/AsynchronousBlockInputStream.cpp:59: DB::AsynchronousBlockInputStream::next()::$_0::operator()() const @ 0x12e30873 in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.395296 [ 594093 ] {} <Fatal> BaseDaemon: 28. /home/qoega/clickhouse/build/../contrib/libcxx/include/type_traits:3519: decltype(std::__1::forward<DB::AsynchronousBlockInputStream::next()::$_0&>(fp)()) std::__1::__invoke<DB::AsynchronousBlockInputStream::next()::$_0&>(DB::AsynchronousBlockInputStream::next()::$_0&) @ 0x12e3071d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.416897 [ 594093 ] {} <Fatal> BaseDaemon: 29. /home/qoega/clickhouse/build/../contrib/libcxx/include/__functional_base:349: void std::__1::__invoke_void_return_wrapper<void>::__call<DB::AsynchronousBlockInputStream::next()::$_0&>(DB::AsynchronousBlockInputStream::next()::$_0&) @ 0x12e306cd in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.438493 [ 594093 ] {} <Fatal> BaseDaemon: 30. /home/qoega/clickhouse/build/../contrib/libcxx/include/functional:1540: std::__1::__function::__alloc_func<DB::AsynchronousBlockInputStream::next()::$_0, std::__1::allocator<DB::AsynchronousBlockInputStream::next()::$_0>, void ()>::operator()() @ 0x12e3069d in /home/qoega/clickhouse/build/programs/clickhouse\r\n2020.04.14 18:40:57.462381 [ 594093 ] {} <Fatal> BaseDaemon: 31. /home/qoega/clickhouse/build/../contrib/libcxx/include/functional:1714: std::__1::__function::__func<DB::AsynchronousBlockInputStream::next()::$_0, std::__1::allocator<DB::AsynchronousBlockInputStream::next()::$_0>, void ()>::operator()() @ 0x12e2f6de in /home/qoega/clickhouse/build/programs/clickhouse\r\nAborted (core dumped)\r\n```\nProbably bug introduced in  #10218\n@qoega Please elaborate.\n@qoega You mixed up with #10219\nIt was \"almost\" fixed in https://github.com/ClickHouse/ClickHouse/pull/8866",
  "created_at": "2020-04-20T23:52:33Z",
  "modified_files": [
    "src/DataTypes/NestedUtils.cpp",
    "src/DataTypes/NestedUtils.h",
    "src/Storages/ColumnsDescription.h"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01254_array_of_unnamed_tuples.reference",
    "b/tests/queries/0_stateless/01254_array_of_unnamed_tuples.sql",
    "b/tests/queries/0_stateless/01255_geo_types_livace.reference",
    "b/tests/queries/0_stateless/01255_geo_types_livace.sql"
  ]
}