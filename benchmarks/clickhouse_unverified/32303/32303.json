{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 32303,
  "instance_id": "ClickHouse__ClickHouse-32303",
  "issue_numbers": [
    "32053"
  ],
  "base_commit": "a2dfa883cbdcacd6c67c40beac04ddf685a4a653",
  "patch": "diff --git a/src/AggregateFunctions/AggregateFunctionAvg.h b/src/AggregateFunctions/AggregateFunctionAvg.h\nindex e2a9220f113b..8ca0ae1dac22 100644\n--- a/src/AggregateFunctions/AggregateFunctionAvg.h\n+++ b/src/AggregateFunctions/AggregateFunctionAvg.h\n@@ -20,6 +20,7 @@\n \n namespace DB\n {\n+\n struct Settings;\n \n template <typename T> constexpr bool DecimalOrExtendedInt =\n@@ -42,39 +43,19 @@ struct AvgFraction\n     /// Invoked only is either Numerator or Denominator are Decimal.\n     Float64 NO_SANITIZE_UNDEFINED divideIfAnyDecimal(UInt32 num_scale, UInt32 denom_scale [[maybe_unused]]) const\n     {\n-        if constexpr (is_decimal<Numerator> && is_decimal<Denominator>)\n-        {\n-            // According to the docs, num(S1) / denom(S2) would have scale S1\n-\n-            if constexpr (std::is_same_v<Numerator, Decimal256> && std::is_same_v<Denominator, Decimal128>)\n-                ///Special case as Decimal256 / Decimal128 = compile error (as Decimal128 is not parametrized by a wide\n-                ///int), but an __int128 instead\n-                return DecimalUtils::convertTo<Float64>(\n-                    numerator / (denominator.template convertTo<Decimal256>()), num_scale);\n-            else\n-                return DecimalUtils::convertTo<Float64>(numerator / denominator, num_scale);\n-        }\n-\n-        /// Numerator is always casted to Float64 to divide correctly if the denominator is not Float64.\n-        Float64 num_converted;\n-\n+        Float64 numerator_float;\n         if constexpr (is_decimal<Numerator>)\n-            num_converted = DecimalUtils::convertTo<Float64>(numerator, num_scale);\n+            numerator_float = DecimalUtils::convertTo<Float64>(numerator, num_scale);\n         else\n-            num_converted = static_cast<Float64>(numerator); /// all other types, including extended integral.\n-\n-        std::conditional_t<DecimalOrExtendedInt<Denominator>,\n-            Float64, Denominator> denom_converted;\n+            numerator_float = numerator;\n \n+        Float64 denominator_float;\n         if constexpr (is_decimal<Denominator>)\n-            denom_converted = DecimalUtils::convertTo<Float64>(denominator, denom_scale);\n-        else if constexpr (DecimalOrExtendedInt<Denominator>)\n-            /// no way to divide Float64 and extended integral type without an explicit cast.\n-            denom_converted = static_cast<Float64>(denominator);\n+            denominator_float = DecimalUtils::convertTo<Float64>(denominator, denom_scale);\n         else\n-            denom_converted = denominator; /// can divide on float, no cast required.\n+            denominator_float = denominator;\n \n-        return num_converted / denom_converted;\n+        return numerator_float / denominator_float;\n     }\n \n     Float64 NO_SANITIZE_UNDEFINED divide() const\ndiff --git a/src/AggregateFunctions/AggregateFunctionAvgWeighted.cpp b/src/AggregateFunctions/AggregateFunctionAvgWeighted.cpp\nindex b7fdb3460e34..ab6fdc8fd7e8 100644\n--- a/src/AggregateFunctions/AggregateFunctionAvgWeighted.cpp\n+++ b/src/AggregateFunctions/AggregateFunctionAvgWeighted.cpp\n@@ -82,17 +82,17 @@ createAggregateFunctionAvgWeighted(const std::string & name, const DataTypes & a\n     const bool left_decimal = isDecimal(data_type);\n     const bool right_decimal = isDecimal(data_type_weight);\n \n+    /// We multiply value by weight, so actual scale of numerator is <scale of value> + <scale of weight>\n     if (left_decimal && right_decimal)\n         ptr.reset(create(*data_type, *data_type_weight,\n             argument_types,\n-            getDecimalScale(*data_type), getDecimalScale(*data_type_weight)));\n+            getDecimalScale(*data_type) + getDecimalScale(*data_type_weight), getDecimalScale(*data_type_weight)));\n     else if (left_decimal)\n         ptr.reset(create(*data_type, *data_type_weight, argument_types,\n             getDecimalScale(*data_type)));\n     else if (right_decimal)\n         ptr.reset(create(*data_type, *data_type_weight, argument_types,\n-            // numerator is not decimal, so its scale is 0\n-            0, getDecimalScale(*data_type_weight)));\n+            getDecimalScale(*data_type_weight), getDecimalScale(*data_type_weight)));\n     else\n         ptr.reset(create(*data_type, *data_type_weight, argument_types));\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01668_avg_weighted_ubsan.reference b/tests/queries/0_stateless/01668_avg_weighted_ubsan.reference\nindex ec064f61ba77..a8921b27cffc 100644\n--- a/tests/queries/0_stateless/01668_avg_weighted_ubsan.reference\n+++ b/tests/queries/0_stateless/01668_avg_weighted_ubsan.reference\n@@ -1,1 +1,14 @@\n -0\n+nan\n+nan\n+1\n+2\n+3\n+4\n+5\n+6\n+7\n+8\n+9\n+nan\n+nan\ndiff --git a/tests/queries/0_stateless/01668_avg_weighted_ubsan.sql b/tests/queries/0_stateless/01668_avg_weighted_ubsan.sql\nindex 24e7dc0cb90d..1c31c23eaee3 100644\n--- a/tests/queries/0_stateless/01668_avg_weighted_ubsan.sql\n+++ b/tests/queries/0_stateless/01668_avg_weighted_ubsan.sql\n@@ -1,1 +1,5 @@\n SELECT round(avgWeighted(x, y)) FROM (SELECT 1023 AS x, 1000000000 AS y UNION ALL SELECT 10 AS x, -9223372036854775808 AS y);\n+select avgWeighted(number, toDecimal128(number, 9)) from numbers(0);\n+SELECT avgWeighted(a, toDecimal64(c, 9)) OVER (PARTITION BY c) FROM (SELECT number AS a, number AS c FROM numbers(10));\n+select avg(toDecimal128(number, 9)) from numbers(0);\n+select avgWeighted(number, toDecimal128(0, 9)) from numbers(10);\n",
  "problem_statement": "Crash in avgWeighted with Decimal\n**Describe what's wrong**\r\n\r\nCrash with avgWeighted + Decimal in window function.\r\n\r\n**Does it reproduce on recent release?**\r\n\r\nYes, 21.8-21.12\r\n\r\n**How to reproduce**\r\n```\r\nSELECT avgWeighted(a, toDecimal64(c, 9)) OVER (PARTITION BY c) \r\nFROM\r\n(\r\n    SELECT\r\n        number AS a,\r\n        number AS c\r\n    FROM numbers(10)\r\n)\r\n\r\n[LAPTOP-] 2021.12.01 15:41:35.721898 [ 8782 ] <Fatal> BaseDaemon: ########################################\r\n[LAPTOP-] 2021.12.01 15:41:35.722020 [ 8782 ] <Fatal> BaseDaemon: (version 21.12.1.8922 (official build), build id: 0C2586E3E51E2F10) (from thread 8753) (query_id: 40d256f5-821d-4839-9510-d9477f430139) Received signal Arithmetic exception (8)\r\n[LAPTOP-] 2021.12.01 15:41:35.722056 [ 8782 ] <Fatal> BaseDaemon: Integer divide by zero.\r\n[LAPTOP-] 2021.12.01 15:41:35.722100 [ 8782 ] <Fatal> BaseDaemon: Stack trace: 0xa0783e8 0xa32a307 0xa473879 0x13f5ff6c 0x13f64d9f 0x13d99e23 0x13d8e0cf 0x13d8d589 0x13d8d31b 0x13d9d8e7 0xa0b9817 0xa0bd21d 0x7faa1cc23609 0x7faa1cb4a293\r\n[LAPTOP-] 2021.12.01 15:41:35.722154 [ 8782 ] <Fatal> BaseDaemon: 2. ? @ 0xa0783e8 in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722212 [ 8782 ] <Fatal> BaseDaemon: 3. DB::AvgFraction<DB::Decimal<wide::integer<128ul, int> >, DB::Decimal<wide::integer<128ul, int> > >::divideIfAnyDecimal(unsigned int, unsigned int) const @ 0xa32a307 in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722246 [ 8782 ] <Fatal> BaseDaemon: 4. DB::AggregateFunctionAvgBase<DB::Decimal<wide::integer<128ul, int> >, DB::Decimal<wide::integer<128ul, int> >, DB::AggregateFunctionAvgWeighted<unsigned long, DB::Decimal<long> > >::insertResultInto(char*, DB::IColumn&, DB::Arena*) const @ 0xa473879 in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722286 [ 8782 ] <Fatal> BaseDaemon: 5. DB::WindowTransform::appendChunk(DB::Chunk&) @ 0x13f5ff6c in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722318 [ 8782 ] <Fatal> BaseDaemon: 6. DB::WindowTransform::work() @ 0x13f64d9f in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722349 [ 8782 ] <Fatal> BaseDaemon: 7. DB::ExecutionThreadContext::executeTask() @ 0x13d99e23 in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722381 [ 8782 ] <Fatal> BaseDaemon: 8. DB::PipelineExecutor::executeStepImpl(unsigned long, std::__1::atomic<bool>*) @ 0x13d8e0cf in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722401 [ 8782 ] <Fatal> BaseDaemon: 9. DB::PipelineExecutor::executeImpl(unsigned long) @ 0x13d8d589 in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722433 [ 8782 ] <Fatal> BaseDaemon: 10. DB::PipelineExecutor::execute(unsigned long) @ 0x13d8d31b in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722461 [ 8782 ] <Fatal> BaseDaemon: 11. ? @ 0x13d9d8e7 in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722497 [ 8782 ] <Fatal> BaseDaemon: 12. ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) @ 0xa0b9817 in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722538 [ 8782 ] <Fatal> BaseDaemon: 13. ? @ 0xa0bd21d in /usr/bin/clickhouse\r\n[LAPTOP-] 2021.12.01 15:41:35.722557 [ 8782 ] <Fatal> BaseDaemon: 14. ? @ 0x7faa1cc23609 in ?\r\n[LAPTOP-] 2021.12.01 15:41:35.722587 [ 8782 ] <Fatal> BaseDaemon: 15. __clone @ 0x7faa1cb4a293 in ?\r\n[LAPTOP-] 2021.12.01 15:41:36.050135 [ 8782 ] <Fatal> BaseDaemon: Calculated checksum of the binary: 88ED9424A7CA5CCF2B8DE36558700120. There is no information about the reference checksum.\r\n\r\nSELECT  avgWeighted(a, toDecimal64(c,9)) OVER (PARTITION BY toDecimal64(c,9)) FROM ( SELECT number as a, number as c FROM numbers(10)); -- also crashes.\r\n```\r\n\r\n**Expected behavior**\r\n\r\nQuery works\r\n\n",
  "hints_text": "It's not related to window functions:\r\n```\r\navtokmakov-dev.sas.yp-c.yandex.net :) select avgWeighted(number, toDecimal64(number, 9)) from numbers(0)\r\n\r\nSELECT avgWeighted(number, toDecimal64(number, 9))\r\nFROM numbers(0)\r\n\r\nQuery id: 63f69883-b44c-4537-bbb1-e5e3a1d2e619\r\n\r\nConnecting to localhost:9000 as user default.\r\nConnected to ClickHouse server version 21.12.1 revision 54451.\r\n\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:48.236199 [ 1418 ] <Fatal> BaseDaemon: ########################################\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:48.237461 [ 1418 ] <Fatal> BaseDaemon: (version 21.12.1.1, build id: 154E8F44338153E3) (from thread 1227) (query_id: 63f69883-b44c-4537-bbb1-e5e3a1d2e619) Received signal Arithmetic exception (8)\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:48.238324 [ 1418 ] <Fatal> BaseDaemon: Integer divide by zero.\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:48.239013 [ 1418 ] <Fatal> BaseDaemon: Stack trace: 0x2a431007 0x1555210f 0x15551eff 0x15551e1d 0x15551ddd 0x15551da2 0x156ef0f3 0x21fa6be4 0x21db6d03 0x21da7366 0x21da6ae9 0x23418939 0x234153bf 0x231007f9 0x231006f5 0x230e4501 0x230e4737 0x230e38eb 0x230e2e53 0x231070c1 0x23106fe0 0x23106f5d 0x23106f01 0x23106e12 0x23106cfb 0x23106bbd 0x23106b7d 0x23106b55 0x23106b20 0x1520ffa6 0x1520f0b5 0x1523b2af 0x15242324 0x1524229d 0x152421c5 0x15241b02 0x7fa6f179c609 0x7fa6f1696103\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:53.579361 [ 1418 ] <Fatal> BaseDaemon: 4. __udivti3 @ 0x2a431007 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:54.392645 [ 1418 ] <Fatal> BaseDaemon: 5. ./build_debug/../base/base/../base/wide_integer_impl.h:830: wide::integer<128ul, unsigned int> wide::integer<128ul, unsigned int>::_impl::divide<128ul>(wide::integer<128ul, unsigned int>&, wide::integer<128ul, unsigned int>) @ 0x1555210f in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:55.234807 [ 1418 ] <Fatal> BaseDaemon: 6. ./build_debug/../base/base/../base/wide_integer_impl.h:877: auto wide::integer<128ul, int>::_impl::operator_slash<wide::integer<128ul, int> >(wide::integer<128ul, int> const&, wide::integer<128ul, int> const&) @ 0x15551eff in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:56.496437 [ 1418 ] <Fatal> BaseDaemon: 7. ./build_debug/../base/base/../base/wide_integer_impl.h:1266: std::__1::common_type<wide::integer<128ul, int>, wide::integer<128ul, int> >::type wide::operator/<128ul, int, 128ul, int>(wide::integer<128ul, int> const&, wide::integer<128ul, int> const&) @ 0x15551e1d in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:57.743428 [ 1418 ] <Fatal> BaseDaemon: 8. ./build_debug/../base/base/../base/Decimal.h:102: DB::Decimal<wide::integer<128ul, int> > DB::operator/<wide::integer<128ul, int> >(DB::Decimal<wide::integer<128ul, int> > const&, DB::Decimal<wide::integer<128ul, int> > const&) @ 0x15551ddd in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:58.587144 [ 1418 ] <Fatal> BaseDaemon: 9. ./build_debug/../src/AggregateFunctions/AggregateFunctionAvg.h:55: DB::AvgFraction<DB::Decimal<wide::integer<128ul, int> >, DB::Decimal<wide::integer<128ul, int> > >::divideIfAnyDecimal(unsigned int, unsigned int) const @ 0x15551da2 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:19:59.654751 [ 1418 ] <Fatal> BaseDaemon: 10. ./build_debug/../src/AggregateFunctions/AggregateFunctionAvg.h:142: DB::AggregateFunctionAvgBase<DB::Decimal<wide::integer<128ul, int> >, DB::Decimal<wide::integer<128ul, int> >, DB::AggregateFunctionAvgWeighted<unsigned long, DB::Decimal<long> > >::insertResultInto(char*, DB::IColumn&, DB::Arena*) const @ 0x156ef0f3 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:00.925553 [ 1418 ] <Fatal> BaseDaemon: 11. ./build_debug/../src/Interpreters/Aggregator.cpp:1332: void DB::Aggregator::insertAggregatesIntoColumns<char*>(char*&, std::__1::vector<COW<DB::IColumn>::mutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::mutable_ptr<DB::IColumn> > >&, DB::Arena*) const @ 0x21fa6be4 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:02.223203 [ 1418 ] <Fatal> BaseDaemon: 12. ./build_debug/../src/Interpreters/Aggregator.cpp:0: DB::Aggregator::prepareBlockAndFillWithoutKey(DB::AggregatedDataVariants&, bool, bool) const::$_1::operator()(std::__1::vector<COW<DB::IColumn>::mutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::mutable_ptr<DB::IColumn> > >&, std::__1::vector<DB::PODArray<char*, 4096ul, Allocator<false, false>, 15ul, 16ul>*, std::__1::allocator<DB::PODArray<char*, 4096ul, Allocator<false, false>, 15ul, 16ul>*> >&, std::__1::vector<COW<DB::IColumn>::mutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::mutable_ptr<DB::IColumn> > >&, bool) const @ 0x21db6d03 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:03.008204 [ 1418 ] <Fatal> BaseDaemon: 13. ./build_debug/../src/Interpreters/Aggregator.cpp:1576: DB::Block DB::Aggregator::prepareBlockAndFill<DB::Aggregator::prepareBlockAndFillWithoutKey(DB::AggregatedDataVariants&, bool, bool) const::$_1&>(DB::AggregatedDataVariants&, bool, unsigned long, DB::Aggregator::prepareBlockAndFillWithoutKey(DB::AggregatedDataVariants&, bool, bool) const::$_1&) const @ 0x21da7366 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:03.786736 [ 1418 ] <Fatal> BaseDaemon: 14. ./build_debug/../src/Interpreters/Aggregator.cpp:1678: DB::Aggregator::prepareBlockAndFillWithoutKey(DB::AggregatedDataVariants&, bool, bool) const @ 0x21da6ae9 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:04.152518 [ 1418 ] <Fatal> BaseDaemon: 15. ./build_debug/../src/Processors/Transforms/AggregatingTransform.cpp:339: DB::ConvertingAggregatedToChunksTransform::initialize() @ 0x23418939 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:04.507934 [ 1418 ] <Fatal> BaseDaemon: 16. ./build_debug/../src/Processors/Transforms/AggregatingTransform.cpp:174: DB::ConvertingAggregatedToChunksTransform::work() @ 0x234153bf in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:04.605067 [ 1418 ] <Fatal> BaseDaemon: 17. ./build_debug/../src/Processors/Executors/ExecutionThreadContext.cpp:45: DB::executeJob(DB::IProcessor*) @ 0x231007f9 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:04.698635 [ 1418 ] <Fatal> BaseDaemon: 18. ./build_debug/../src/Processors/Executors/ExecutionThreadContext.cpp:63: DB::ExecutionThreadContext::executeTask() @ 0x231006f5 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:04.876015 [ 1418 ] <Fatal> BaseDaemon: 19. ./build_debug/../src/Processors/Executors/PipelineExecutor.cpp:187: DB::PipelineExecutor::executeStepImpl(unsigned long, std::__1::atomic<bool>*) @ 0x230e4501 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:05.056246 [ 1418 ] <Fatal> BaseDaemon: 20. ./build_debug/../src/Processors/Executors/PipelineExecutor.cpp:152: DB::PipelineExecutor::executeSingleThread(unsigned long) @ 0x230e4737 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:05.212126 [ 1418 ] <Fatal> BaseDaemon: 21. ./build_debug/../src/Processors/Executors/PipelineExecutor.cpp:300: DB::PipelineExecutor::executeImpl(unsigned long) @ 0x230e38eb in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:05.388543 [ 1418 ] <Fatal> BaseDaemon: 22. ./build_debug/../src/Processors/Executors/PipelineExecutor.cpp:81: DB::PipelineExecutor::execute(unsigned long) @ 0x230e2e53 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:05.557869 [ 1418 ] <Fatal> BaseDaemon: 23. ./build_debug/../src/Processors/Executors/PullingAsyncPipelineExecutor.cpp:85: DB::threadFunction(DB::PullingAsyncPipelineExecutor::Data&, std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long) @ 0x231070c1 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:05.726070 [ 1418 ] <Fatal> BaseDaemon: 24. ./build_debug/../src/Processors/Executors/PullingAsyncPipelineExecutor.cpp:113: DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0::operator()() const @ 0x23106fe0 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:05.895728 [ 1418 ] <Fatal> BaseDaemon: 25. ./build_debug/../contrib/libcxx/include/type_traits:3682: decltype(std::__1::forward<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&>(fp)()) std::__1::__invoke_constexpr<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&) @ 0x23106f5d in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:06.066907 [ 1418 ] <Fatal> BaseDaemon: 26. ./build_debug/../contrib/libcxx/include/tuple:1415: decltype(auto) std::__1::__apply_tuple_impl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&, std::__1::__tuple_indices<>) @ 0x23106f01 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:06.243124 [ 1418 ] <Fatal> BaseDaemon: 27. ./build_debug/../contrib/libcxx/include/tuple:1424: decltype(auto) std::__1::apply<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&) @ 0x23106e12 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:06.392781 [ 1418 ] <Fatal> BaseDaemon: 28. ./build_debug/../src/Common/ThreadPool.h:188: ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()::operator()() @ 0x23106cfb in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:06.562268 [ 1418 ] <Fatal> BaseDaemon: 29. ./build_debug/../contrib/libcxx/include/type_traits:3676: decltype(std::__1::forward<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(fp)()) std::__1::__invoke<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&) @ 0x23106bbd in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:06.731425 [ 1418 ] <Fatal> BaseDaemon: 30. ./build_debug/../contrib/libcxx/include/__functional_base:349: void std::__1::__invoke_void_return_wrapper<void>::__call<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&...) @ 0x23106b7d in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:06.898563 [ 1418 ] <Fatal> BaseDaemon: 31. ./build_debug/../contrib/libcxx/include/functional:1608: std::__1::__function::__default_alloc_func<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'(), void ()>::operator()() @ 0x23106b55 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:07.069522 [ 1418 ] <Fatal> BaseDaemon: 32. ./build_debug/../contrib/libcxx/include/functional:2089: void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<ThreadFromGlobalPool::ThreadFromGlobalPool<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'(), void ()> >(std::__1::__function::__policy_storage const*) @ 0x23106b20 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:07.126455 [ 1418 ] <Fatal> BaseDaemon: 33. ./build_debug/../contrib/libcxx/include/functional:2221: std::__1::__function::__policy_func<void ()>::operator()() const @ 0x1520ffa6 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:07.181546 [ 1418 ] <Fatal> BaseDaemon: 34. ./build_debug/../contrib/libcxx/include/functional:2560: std::__1::function<void ()>::operator()() const @ 0x1520f0b5 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:07.265515 [ 1418 ] <Fatal> BaseDaemon: 35. ./build_debug/../src/Common/ThreadPool.cpp:274: ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) @ 0x1523b2af in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:07.361305 [ 1418 ] <Fatal> BaseDaemon: 36. ./build_debug/../src/Common/ThreadPool.cpp:139: void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda0'()::operator()() const @ 0x15242324 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:07.460553 [ 1418 ] <Fatal> BaseDaemon: 37. ./build_debug/../contrib/libcxx/include/type_traits:3676: decltype(std::__1::forward<void>(fp)(std::__1::forward<void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda0'()>(fp0)...)) std::__1::__invoke<void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda0'()>(void&&, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda0'()&&...) @ 0x1524229d in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:07.561119 [ 1418 ] <Fatal> BaseDaemon: 38. ./build_debug/../contrib/libcxx/include/thread:281: void std::__1::__thread_execute<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda0'()>(std::__1::tuple<void, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda0'()>&, std::__1::__tuple_indices<>) @ 0x152421c5 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:07.659642 [ 1418 ] <Fatal> BaseDaemon: 39. ./build_debug/../contrib/libcxx/include/thread:291: void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda0'()> >(void*) @ 0x15241b02 in /home/avtokmakov/ch/ClickHouse/build_debug/programs/clickhouse\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:07.659970 [ 1418 ] <Fatal> BaseDaemon: 40. ? @ 0x7fa6f179c609 in ?\r\n[avtokmakov-dev.sas.yp-c.yandex.net] 2021.12.01 16:20:07.660267 [ 1418 ] <Fatal> BaseDaemon: 41. clone @ 0x7fa6f1696103 in ?\r\nException on client:\r\nCode: 32. DB::Exception: Attempt to read after eof: while receiving packet from localhost:9000. (ATTEMPT_TO_READ_AFTER_EOF)\r\n\r\n```\nSlightly related to #31768",
  "created_at": "2021-12-06T17:44:18Z",
  "modified_files": [
    "src/AggregateFunctions/AggregateFunctionAvg.h",
    "src/AggregateFunctions/AggregateFunctionAvgWeighted.cpp"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/01668_avg_weighted_ubsan.reference",
    "tests/queries/0_stateless/01668_avg_weighted_ubsan.sql"
  ]
}