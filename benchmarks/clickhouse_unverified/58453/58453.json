{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 58453,
  "instance_id": "ClickHouse__ClickHouse-58453",
  "issue_numbers": [
    "58451"
  ],
  "base_commit": "66d2db52832a81aea43cda66a500d8b3369547ef",
  "patch": "diff --git a/src/Processors/Merges/Algorithms/Graphite.h b/src/Processors/Merges/Algorithms/Graphite.h\nindex 692e36d2eaee..04bb4548c146 100644\n--- a/src/Processors/Merges/Algorithms/Graphite.h\n+++ b/src/Processors/Merges/Algorithms/Graphite.h\n@@ -127,7 +127,12 @@ struct Pattern\n     {\n         hash.update(rule_type);\n         hash.update(regexp_str);\n-        hash.update(function->getName());\n+        if (function)\n+        {\n+            hash.update(function->getName());\n+            for (const auto & p : function->getParameters())\n+                hash.update(toString(p));\n+        }\n         for (const auto & r : retentions)\n         {\n             hash.update(r.age);\n",
  "test_patch": "diff --git a/tests/config/config.d/graphite_alternative.xml b/tests/config/config.d/graphite_alternative.xml\nindex 1a00de52af54..6c0bd13ce43f 100644\n--- a/tests/config/config.d/graphite_alternative.xml\n+++ b/tests/config/config.d/graphite_alternative.xml\n@@ -26,4 +26,28 @@\n             </retention>\n         </default>\n     </graphite_rollup_alternative>\n+    <graphite_rollup_alternative_no_function>\n+        <version_column_name>Version</version_column_name>\n+        <pattern>\n+            <regexp>sum</regexp>\n+            <retention>\n+                <age>0</age>\n+                <precision>600</precision>\n+            </retention>\n+            <retention>\n+                <age>17280</age>\n+                <precision>6000</precision>\n+            </retention>\n+        </pattern>\n+        <default>\n+            <retention>\n+                <age>0</age>\n+                <precision>600</precision>\n+            </retention>\n+            <retention>\n+                <age>17280</age>\n+                <precision>6000</precision>\n+            </retention>\n+        </default>\n+    </graphite_rollup_alternative_no_function>\n </clickhouse>\ndiff --git a/tests/queries/0_stateless/02910_replicated_merge_parameters_must_consistent.sql b/tests/queries/0_stateless/02910_replicated_merge_parameters_must_consistent.sql\nindex 3c1bec4fb3f1..0f452105e6d8 100644\n--- a/tests/queries/0_stateless/02910_replicated_merge_parameters_must_consistent.sql\n+++ b/tests/queries/0_stateless/02910_replicated_merge_parameters_must_consistent.sql\n@@ -8,13 +8,22 @@ CREATE TABLE t\n ENGINE = ReplicatedReplacingMergeTree('/tables/{database}/t/', 'r1', legacy_ver)\n ORDER BY id;\n \n-CREATE TABLE t_r\n+CREATE TABLE t_r_ok\n+(\n+    `id` UInt64,\n+    `val` String,\n+    `legacy_ver` UInt64,\n+)\n+ENGINE = ReplicatedReplacingMergeTree('/tables/{database}/t/', 'r2', legacy_ver)\n+ORDER BY id;\n+\n+CREATE TABLE t_r_error\n (\n     `id` UInt64,\n     `val` String,\n     `legacy_ver` UInt64\n )\n-ENGINE = ReplicatedReplacingMergeTree('/tables/{database}/t/', 'r2')\n+ENGINE = ReplicatedReplacingMergeTree('/tables/{database}/t/', 'r3')\n ORDER BY id; -- { serverError METADATA_MISMATCH }\n \n CREATE TABLE t2\n@@ -27,14 +36,24 @@ CREATE TABLE t2\n ENGINE = ReplicatedReplacingMergeTree('/tables/{database}/t2/', 'r1', legacy_ver)\n ORDER BY id;\n \n-CREATE TABLE t2_r\n+CREATE TABLE t2_r_ok\n (\n     `id` UInt64,\n     `val` String,\n     `legacy_ver` UInt64,\n     `deleted` UInt8\n )\n-ENGINE = ReplicatedReplacingMergeTree('/tables/{database}/t2/', 'r2', legacy_ver, deleted)\n+ENGINE = ReplicatedReplacingMergeTree('/tables/{database}/t2/', 'r2', legacy_ver)\n+ORDER BY id;\n+\n+CREATE TABLE t2_r_error\n+(\n+    `id` UInt64,\n+    `val` String,\n+    `legacy_ver` UInt64,\n+    `deleted` UInt8\n+)\n+ENGINE = ReplicatedReplacingMergeTree('/tables/{database}/t2/', 'r3', legacy_ver, deleted)\n ORDER BY id; -- { serverError METADATA_MISMATCH }\n \n CREATE TABLE t3\n@@ -46,13 +65,23 @@ CREATE TABLE t3\n ENGINE = ReplicatedSummingMergeTree('/tables/{database}/t3/', 'r1', metrics1)\n ORDER BY key;\n \n-CREATE TABLE t3_r\n+CREATE TABLE t3_r_ok\n+(\n+    `key` UInt64,\n+    `metrics1` UInt64,\n+    `metrics2` UInt64\n+)\n+ENGINE = ReplicatedSummingMergeTree('/tables/{database}/t3/', 'r2', metrics1)\n+ORDER BY key;\n+\n+\n+CREATE TABLE t3_r_error\n (\n     `key` UInt64,\n     `metrics1` UInt64,\n     `metrics2` UInt64\n )\n-ENGINE = ReplicatedSummingMergeTree('/tables/{database}/t3/', 'r2', metrics2)\n+ENGINE = ReplicatedSummingMergeTree('/tables/{database}/t3/', 'r3', metrics2)\n ORDER BY key; -- { serverError METADATA_MISMATCH }\n \n CREATE TABLE t4\n@@ -67,7 +96,7 @@ CREATE TABLE t4\n ENGINE = ReplicatedGraphiteMergeTree('/tables/{database}/t4/', 'r1', 'graphite_rollup')\n ORDER BY key;\n \n-CREATE TABLE t4_r\n+CREATE TABLE t4_r_ok\n (\n     `key` UInt32,\n     `Path` String,\n@@ -76,5 +105,30 @@ CREATE TABLE t4_r\n     `Version` UInt32,\n     `col` UInt64\n )\n-ENGINE = ReplicatedGraphiteMergeTree('/tables/{database}/t4/', 'r2', 'graphite_rollup_alternative')\n+ENGINE = ReplicatedGraphiteMergeTree('/tables/{database}/t4/', 'r2', 'graphite_rollup')\n+ORDER BY key;\n+\n+CREATE TABLE t4_r_error\n+(\n+    `key` UInt32,\n+    `Path` String,\n+    `Time` DateTime('UTC'),\n+    `Value` Float64,\n+    `Version` UInt32,\n+    `col` UInt64\n+)\n+ENGINE = ReplicatedGraphiteMergeTree('/tables/{database}/t4/', 'r3', 'graphite_rollup_alternative')\n ORDER BY key; -- { serverError METADATA_MISMATCH }\n+\n+-- https://github.com/ClickHouse/ClickHouse/issues/58451\n+CREATE TABLE t4_r_error_2\n+(\n+    `key` UInt32,\n+    `Path` String,\n+    `Time` DateTime('UTC'),\n+    `Value` Float64,\n+    `Version` UInt32,\n+    `col` UInt64\n+)\n+ENGINE = ReplicatedGraphiteMergeTree('/tables/{database}/t4/', 'r4', 'graphite_rollup_alternative_no_function')\n+ORDER BY key; -- { serverError METADATA_MISMATCH }\n\\ No newline at end of file\n",
  "problem_statement": "Segfault during startup after upgrading to 23.12.1.1368\nHello,\r\nwe are using CH solely as a backend for Graphite Clickhouse [https://github.com/go-graphite/graphite-clickhouse](url), in a 14 node cluster (7 shards with 2 replicas), running on Debian 10. After upgrading from version 23.11.2.11 to version 23.12.1.1368, we get a segfault during startup of clickhouse-server. Upgrading to version 23.11.3.23 works fine.\r\n\r\n**How to reproduce**\r\nUpgrade clickhouse-server to latest version 23.12.1.1368, and restart the service.\r\n\r\n* Which ClickHouse server version to use\r\n23.12.1.1368\r\n\r\n*Stack trace\r\n\r\n```\r\n2024.01.03 10:55:16.257352 [ 5207 ] {} <Fatal> BaseDaemon: ########## Short fault info ############\r\n2024.01.03 10:55:16.257421 [ 5207 ] {} <Fatal> BaseDaemon: (version 23.12.1.1368 (official build), build id: 19BC8CB87C441A86F879D18F5C18F17BA08526EE, git hash: a2faa65b080a587026c86844f3a20c74d23a86f8) (from thread 4678) Received signal 11\r\n2024.01.03 10:55:16.257471 [ 5207 ] {} <Fatal> BaseDaemon: Signal description: Segmentation fault\r\n2024.01.03 10:55:16.257498 [ 5207 ] {} <Fatal> BaseDaemon: Address: NULL pointer. Access: read. Address not mapped to object.\r\n2024.01.03 10:55:16.257520 [ 5207 ] {} <Fatal> BaseDaemon: Stack trace: 0x0000000012429abc 0x00000000124230bb 0x0000000011c1132a 0x000000001237eae9 0x000000001034e13f 0x000000001034f191 0x000000000c7be158 0x00007f6841afffa3 0x00007f6841a3106f\r\n2024.01.03 10:55:16.257577 [ 5207 ] {} <Fatal> BaseDaemon: ########################################\r\n2024.01.03 10:55:16.257609 [ 5207 ] {} <Fatal> BaseDaemon: (version 23.12.1.1368 (official build), build id: 19BC8CB87C441A86F879D18F5C18F17BA08526EE, git hash: a2faa65b080a587026c86844f3a20c74d23a86f8) (from thread 4678) (no query) Received signal Segmentation fault (11)\r\n2024.01.03 10:55:16.257632 [ 5207 ] {} <Fatal> BaseDaemon: Address: NULL pointer. Access: read. Address not mapped to object.\r\n2024.01.03 10:55:16.257647 [ 5207 ] {} <Fatal> BaseDaemon: Stack trace: 0x0000000012429abc 0x00000000124230bb 0x0000000011c1132a 0x000000001237eae9 0x000000001034e13f 0x000000001034f191 0x000000000c7be158 0x00007f6841afffa3 0x00007f6841a3106f\r\n2024.01.03 10:55:16.257763 [ 5207 ] {} <Fatal> BaseDaemon: 2. DB::Graphite::Pattern::updateHash(SipHash&) const @ 0x0000000012429abc in /usr/bin/clickhouse\r\n2024.01.03 10:55:16.257815 [ 5207 ] {} <Fatal> BaseDaemon: 3. DB::ReplicatedMergeTreeTableMetadata::ReplicatedMergeTreeTableMetadata(DB::MergeTreeData const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&) @ 0x00000000124230bb in /usr/bin/clickhouse\r\n2024.01.03 10:55:16.259803 [ 5207 ] {} <Fatal> BaseDaemon: 4. DB::StorageReplicatedMergeTree::checkTableStructure(String const&, std::shared_ptr<DB::StorageInMemoryMetadata const> const&, bool) @ 0x0000000011c1132a in /usr/bin/clickhouse\r\n2024.01.03 10:55:16.259827 [ 5207 ] {} <Fatal> BaseDaemon: 5. DB::ReplicatedMergeTreeAttachThread::run() @ 0x000000001237eae9 in /usr/bin/clickhouse\r\n2024.01.03 10:55:16.259852 [ 5207 ] {} <Fatal> BaseDaemon: 6. DB::BackgroundSchedulePool::threadFunction() @ 0x000000001034e13f in /usr/bin/clickhouse\r\n2024.01.03 10:55:16.259893 [ 5207 ] {} <Fatal> BaseDaemon: 7. void std::__function::__policy_invoker<void ()>::__call_impl<std::__function::__default_alloc_func<ThreadFromGlobalPoolImpl<false>::ThreadFromGlobalPoolImpl<DB::BackgroundSchedulePool::BackgroundSchedulePool(unsigned long, StrongTypedef<unsigned long, CurrentMetrics::MetricTag>, StrongTypedef<unsigned long, CurrentMetrics::MetricTag>, char const*)::$_0>(DB::BackgroundSchedulePool::BackgroundSchedulePool(unsigned long, StrongTypedef<unsigned long, CurrentMetrics::MetricTag>, StrongTypedef<unsigned long, CurrentMetrics::MetricTag>, char const*)::$_0&&)::'lambda'(), void ()>>(std::__function::__policy_storage const*) @ 0x000000001034f191 in /usr/bin/clickhouse\r\n2024.01.03 10:55:16.259931 [ 5207 ] {} <Fatal> BaseDaemon: 8. void* std::__thread_proxy[abi:v15000]<std::tuple<std::unique_ptr<std::__thread_struct, std::default_delete<std::__thread_struct>>, void ThreadPoolImpl<std::thread>::scheduleImpl<void>(std::function<void ()>, Priority, std::optional<unsigned long>, bool)::'lambda0'()>>(void*) @ 0x000000000c7be158 in /usr/bin/clickhouse\r\n2024.01.03 10:55:16.260665 [ 5207 ] {} <Fatal> BaseDaemon: 9. start_thread @ 0x0000000000007fa3 in /lib/x86_64-linux-gnu/libpthread-2.28.so\r\n2024.01.03 10:55:16.260687 [ 5207 ] {} <Fatal> BaseDaemon: 10. ? @ 0x00000000000f906f in /lib/x86_64-linux-gnu/libc-2.28.so\r\n2024.01.03 10:55:16.597142 [ 5207 ] {} <Fatal> BaseDaemon: Integrity check of the executable successfully passed (checksum: E62A564F8077C0AF79E8E5726EE71488)\r\n2024.01.03 10:55:16.600962 [ 5207 ] {} <Fatal> BaseDaemon: Report this error to https://github.com/ClickHouse/ClickHouse/issues\r\n2024.01.03 10:55:20.708171 [ 4444 ] {} <Fatal> Application: Child process was terminated by signal 11.\r\n```\r\n\r\nI have also tried searching through the logs for thread 4678, but there is nothing in the logs. Please let me know if you require any further information.\r\n\n",
  "hints_text": "Relates to my change in #56833, will fix asap",
  "created_at": "2024-01-03T12:22:23Z",
  "modified_files": [
    "src/Processors/Merges/Algorithms/Graphite.h"
  ],
  "modified_test_files": [
    "tests/config/config.d/graphite_alternative.xml",
    "tests/queries/0_stateless/02910_replicated_merge_parameters_must_consistent.sql"
  ]
}