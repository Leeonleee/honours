{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 16677,
  "instance_id": "ClickHouse__ClickHouse-16677",
  "issue_numbers": [
    "14190"
  ],
  "base_commit": "7986dbdfc7a6b57e9924171b46ca9899beb2ad8c",
  "patch": "diff --git a/src/Common/FieldVisitors.h b/src/Common/FieldVisitors.h\nindex 4fcb3091833f..79d5af889041 100644\n--- a/src/Common/FieldVisitors.h\n+++ b/src/Common/FieldVisitors.h\n@@ -3,6 +3,7 @@\n #include <Core/DecimalFunctions.h>\n #include <Core/Field.h>\n #include <common/demangle.h>\n+#include <Common/NaNUtils.h>\n \n \n class SipHash;\n@@ -142,6 +143,19 @@ class FieldVisitorConvertToNumber : public StaticVisitor<T>\n \n     T operator() (const Float64 & x) const\n     {\n+        if constexpr (!std::is_floating_point_v<T>)\n+        {\n+            if (!isFinite(x))\n+            {\n+                /// When converting to bool it's ok (non-zero converts to true, NaN including).\n+                if (std::is_same_v<T, bool>)\n+                    return true;\n+\n+                /// Conversion of infinite values to integer is undefined.\n+                throw Exception(\"Cannot convert infinite value to integer type\", ErrorCodes::CANNOT_CONVERT_TYPE);\n+            }\n+        }\n+\n         if constexpr (std::is_same_v<Decimal256, T>)\n             return Int256(x);\n         else\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01557_field_infinite_convert_to_number.reference b/tests/queries/0_stateless/01557_field_infinite_convert_to_number.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/01557_field_infinite_convert_to_number.sql b/tests/queries/0_stateless/01557_field_infinite_convert_to_number.sql\nnew file mode 100644\nindex 000000000000..edc4d5cbc91f\n--- /dev/null\n+++ b/tests/queries/0_stateless/01557_field_infinite_convert_to_number.sql\n@@ -0,0 +1,1 @@\n+SET max_threads = nan; -- { serverError 70 }\n",
  "problem_statement": "UndefinedBehaviorSanitizer nan is outside the range of representable values of type 'unsigned long'\n``` sql\r\nSELECT NULL, uniqUpTo(2)([[], [], ['', 'aa', NULL], ['\\0\\0', '\\0'], []], x) FROM (SELECT arrayJoin([[uniq(['aaaa', NULL, '', ''], [[], ['', '', NULL, NULL, ''], []])]]) AS x)\r\n```\r\n\r\n```\r\n../src/Common/FieldVisitors.h:148:22: runtime error: nan is outside the range of representable values of type 'unsigned long'\r\nSUMMARY: UndefinedBehaviorSanitizer: undefined-behavior ../src/Common/FieldVisitors.h:148:22 in\r\n```\n",
  "hints_text": "@qoega You have copied the wrong query.\r\nI checked it manually and found that this query cannot lead to this error.\nI can easily reproduce the ubsan issue with the following query:\r\n```\r\nSET max_threads = nan\r\n```",
  "created_at": "2020-11-04T16:49:21Z",
  "modified_files": [
    "src/Common/FieldVisitors.h"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01557_field_infinite_convert_to_number.sql"
  ]
}