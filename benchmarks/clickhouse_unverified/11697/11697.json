{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 11697,
  "instance_id": "ClickHouse__ClickHouse-11697",
  "issue_numbers": [
    "8754"
  ],
  "base_commit": "ceb8775bc1a60b35c0e1b47fd412afd06c32fe57",
  "patch": "diff --git a/src/Processors/Transforms/FillingTransform.cpp b/src/Processors/Transforms/FillingTransform.cpp\nindex 50fac1218196..e8d56389eacd 100644\n--- a/src/Processors/Transforms/FillingTransform.cpp\n+++ b/src/Processors/Transforms/FillingTransform.cpp\n@@ -107,8 +107,9 @@ void FillingTransform::transform(Chunk & chunk)\n     {\n         for (size_t pos : positions)\n         {\n-            new_columns.push_back(old_columns[pos]);\n-            new_mutable_columns.push_back(old_columns[pos]->cloneEmpty()->assumeMutable());\n+            auto old_column = old_columns[pos]->convertToFullColumnIfConst();\n+            new_columns.push_back(old_column);\n+            new_mutable_columns.push_back(old_column->cloneEmpty()->assumeMutable());\n         }\n     };\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01145_with_fill_const.reference b/tests/queries/0_stateless/01145_with_fill_const.reference\nnew file mode 100644\nindex 000000000000..fa72c3c5993b\n--- /dev/null\n+++ b/tests/queries/0_stateless/01145_with_fill_const.reference\n@@ -0,0 +1,20 @@\n+2020-06-16 00:00:00\n+2020-06-16 00:30:00\n+2020-06-16 01:00:00\n+2020-06-16 01:30:00\n+2020-06-16 02:00:00\n+2020-06-16 02:30:00\n+2020-06-16 03:00:00\n+2020-06-16 03:30:00\n+2020-06-16 04:00:00\n+2020-06-16 04:30:00\n+2020-06-16 05:00:00\n+2020-06-16 05:30:00\n+2020-06-16 06:00:00\n+2020-06-16 06:30:00\n+2020-06-16 07:00:00\n+2020-06-16 07:30:00\n+2020-06-16 08:00:00\n+2020-06-16 08:30:00\n+2020-06-16 09:00:00\n+2020-06-16 09:30:00\ndiff --git a/tests/queries/0_stateless/01145_with_fill_const.sql b/tests/queries/0_stateless/01145_with_fill_const.sql\nnew file mode 100644\nindex 000000000000..531d202c02ae\n--- /dev/null\n+++ b/tests/queries/0_stateless/01145_with_fill_const.sql\n@@ -0,0 +1,6 @@\n+WITH toDateTime('2020-06-16 03:00:00') AS date_time\n+SELECT date_time ORDER BY date_time ASC\n+WITH FILL\n+    FROM toDateTime('2020-06-16 00:00:00')\n+    TO toDateTime('2020-06-16 10:00:00')\n+    STEP 1800;\n",
  "problem_statement": "WITH FILL against const columns\n```\r\nselect now()-30 as date_time ORDER BY date_time ASC WITH FILL  FROM now() - 3600  TO now() STEP 600;\r\n\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500date_time\u2500\u2510\r\n\u2502 2020-01-20 22:41:59 \u2502\r\n\u2502 2020-01-20 22:41:59 \u2502\r\n\u2502 2020-01-20 22:41:59 \u2502\r\n\u2502 2020-01-20 22:41:59 \u2502\r\n\u2502 2020-01-20 22:41:59 \u2502\r\n\u2502 2020-01-20 22:41:59 \u2502\r\n\u2502 2020-01-20 22:41:59 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n7 rows in set. Elapsed: 0.004 sec. \r\n```\r\n\r\nworaround:\r\n```\r\nselect materialize(now()-30) as date_time ORDER BY date_time ASC WITH FILL  FROM now() - 3600  TO now() STEP 600;\r\n\r\nSELECT materialize(now() - 30) AS date_time\r\nORDER BY date_time ASC WITH FILL FROM now() - 3600 TO now() STEP 600\r\n\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500date_time\u2500\u2510\r\n\u2502 2020-01-20 21:42:38 \u2502\r\n\u2502 2020-01-20 21:52:38 \u2502\r\n\u2502 2020-01-20 22:02:38 \u2502\r\n\u2502 2020-01-20 22:12:38 \u2502\r\n\u2502 2020-01-20 22:22:38 \u2502\r\n\u2502 2020-01-20 22:32:38 \u2502\r\n\u2502 2020-01-20 22:42:08 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n7 rows in set. Elapsed: 0.004 sec. \r\n```\n",
  "hints_text": "const related issue #7666 ",
  "created_at": "2020-06-16T02:58:16Z",
  "modified_files": [
    "src/Processors/Transforms/FillingTransform.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01145_with_fill_const.reference",
    "b/tests/queries/0_stateless/01145_with_fill_const.sql"
  ]
}