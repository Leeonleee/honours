{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 26428,
  "instance_id": "ClickHouse__ClickHouse-26428",
  "issue_numbers": [
    "22517"
  ],
  "base_commit": "181f20cfe1fd6cd00fb3ccef9998d9bd311e74d7",
  "patch": "diff --git a/src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp b/src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp\nindex 1ce6c4f36d86..29a7a0a4d87b 100644\n--- a/src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp\n+++ b/src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp\n@@ -157,9 +157,14 @@ void ExecuteScalarSubqueriesMatcher::visit(const ASTSubquery & subquery, ASTPtr\n     if (data.only_analyze || !settings.enable_scalar_subquery_optimization || worthConvertingToLiteral(scalar)\n         || !data.getContext()->hasQueryContext())\n     {\n+        /// subquery and ast can be the same object and ast will be moved.\n+        /// Save these fields to avoid use after move.\n+        auto alias = subquery.alias;\n+        auto prefer_alias_to_column_name = subquery.prefer_alias_to_column_name;\n+\n         auto lit = std::make_unique<ASTLiteral>((*scalar.safeGetByPosition(0).column)[0]);\n-        lit->alias = subquery.alias;\n-        lit->prefer_alias_to_column_name = subquery.prefer_alias_to_column_name;\n+        lit->alias = alias;\n+        lit->prefer_alias_to_column_name = prefer_alias_to_column_name;\n         ast = addTypeConversionToAST(std::move(lit), scalar.safeGetByPosition(0).type->getName());\n \n         /// If only analyze was requested the expression is not suitable for constant folding, disable it.\n@@ -167,8 +172,8 @@ void ExecuteScalarSubqueriesMatcher::visit(const ASTSubquery & subquery, ASTPtr\n         {\n             ast->as<ASTFunction>()->alias.clear();\n             auto func = makeASTFunction(\"identity\", std::move(ast));\n-            func->alias = subquery.alias;\n-            func->prefer_alias_to_column_name = subquery.prefer_alias_to_column_name;\n+            func->alias = alias;\n+            func->prefer_alias_to_column_name = prefer_alias_to_column_name;\n             ast = std::move(func);\n         }\n     }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01247_some_msan_crashs_from_22517.reference b/tests/queries/0_stateless/01247_some_msan_crashs_from_22517.reference\nnew file mode 100644\nindex 000000000000..573541ac9702\n--- /dev/null\n+++ b/tests/queries/0_stateless/01247_some_msan_crashs_from_22517.reference\n@@ -0,0 +1,1 @@\n+0\ndiff --git a/tests/queries/0_stateless/01247_some_msan_crashs_from_22517.sql b/tests/queries/0_stateless/01247_some_msan_crashs_from_22517.sql\nnew file mode 100644\nindex 000000000000..8bcbbde63d62\n--- /dev/null\n+++ b/tests/queries/0_stateless/01247_some_msan_crashs_from_22517.sql\n@@ -0,0 +1,3 @@\n+SELECT a FROM (SELECT ignore((SELECT 1)) AS a, a AS b);\n+\n+SELECT x FROM (SELECT dummy AS x, plus(ignore(ignore(ignore(ignore('-922337203.6854775808', ignore(NULL)), ArrLen = 256, ignore(100, Arr.C3, ignore(NULL), (SELECT 10.000100135803223, count(*) FROM system.time_zones) > NULL)))), dummy, 65535) AS dummy ORDER BY ignore(-2) ASC, identity(x) DESC NULLS FIRST) FORMAT Null; -- { serverError 47 }\n",
  "problem_statement": "ASan report in ExecuteScalarSubqueriesMatcher\n**Describe the bug**\r\nhttps://clickhouse-test-reports.s3.yandex.net/22475/2952cb296de0145a458d08dcd55365b0165c0248/fuzzer_asan/server.log\r\n\r\n**How to reproduce**\r\n```\r\nSELECT x FROM (SELECT dummy AS x, plus(ignore(ignore(ignore(ignore('-922337203.6854775808', ignore(NULL)), ArrLen = 256, ignore(100, Arr.C3, ignore(NULL), (SELECT 10.000100135803223, count(*) FROM system.time_zones) > NULL)))), dummy, 65535) AS dummy ORDER BY ignore(-2) ASC, identity(x) DESC NULLS FIRST) FORMAT Null\r\n```\n",
  "hints_text": "Wow, it's reproduced easily also with MSan:\r\n\r\n```\r\n==2899312==WARNING: MemorySanitizer: use-of-uninitialized-value\r\n    #0 0x336e6003 in std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >::operator=(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/string:2379:11\r\n    #1 0x336e6003 in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTSubquery const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:170:25\r\n    #2 0x336db726 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:57:9\r\n    #3 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #4 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #5 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #6 0x336e88ff in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:209:23\r\n    #7 0x336db892 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:59:9\r\n    #8 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #9 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #10 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #11 0x336e88ff in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:209:23\r\n    #12 0x336db892 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:59:9\r\n    #13 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #14 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #15 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #16 0x336e88ff in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:209:23\r\n    #17 0x336db892 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:59:9\r\n    #18 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #19 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #20 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #21 0x336e88ff in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:209:23\r\n    #22 0x336db892 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:59:9\r\n    #23 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #24 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #25 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #26 0x336e88ff in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:209:23\r\n    #27 0x336db892 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:59:9\r\n    #28 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #29 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #30 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #31 0x336e88ff in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:209:23\r\n    #32 0x336db892 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:59:9\r\n    #33 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #34 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #35 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #36 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #37 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #38 0x335b4205 in DB::(anonymous namespace)::executeScalarSubqueries(std::__1::shared_ptr<DB::IAST>&, std::__1::shared_ptr<DB::Context const>, unsigned long, std::__1::map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, DB::Block, std::__1::less<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, DB::Block> > >&, bool) /home/milovidov/work/ClickHouse/build/../src/Interpreters/TreeRewriter.cpp:418:64\r\n    #39 0x335a034d in DB::TreeRewriter::analyzeSelect(std::__1::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::__1::vector<DB::TableWithColumnNamesAndTypes, std::__1::allocator<DB::TableWithColumnNamesAndTypes> > const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::TableJoin>) const /home/milovidov/work/ClickHouse/build/../src/Interpreters/TreeRewriter.cpp:925:5\r\n    #40 0x324dabc5 in DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context const>, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&)::$_1::operator()(bool) const /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterSelectQuery.cpp:384:56\r\n    #41 0x324cdb81 in DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context const>, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterSelectQuery.cpp:508:5\r\n    #42 0x324c7c24 in DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context const>, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterSelectQuery.cpp:159:7\r\n    #43 0x32fc6efb in std::__1::__unique_if<DB::InterpreterSelectQuery>::__unique_single std::__1::make_unique<DB::InterpreterSelectQuery, std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context>&, DB::SelectQueryOptions&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&>(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context>&, DB::SelectQueryOptions&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/memory:2068:32\r\n    #44 0x32fc6efb in DB::InterpreterSelectWithUnionQuery::buildCurrentChildInterpreter(std::__1::shared_ptr<DB::IAST> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:212:16\r\n    #45 0x32fc220c in DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context const>, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:134:13\r\n    #46 0x32fca0f6 in DB::InterpreterSelectWithUnionQuery::getSampleBlock(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context const>, bool) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:229:15\r\n    #47 0x337e7ede in DB::getColumnsFromTableExpression(DB::ASTTableExpression const&, std::__1::shared_ptr<DB::Context const>, DB::NamesAndTypesList&, DB::NamesAndTypesList&, DB::NamesAndTypesList&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/getTableExpressions.cpp:87:31\r\n    #48 0x337e7ede in DB::getDatabaseAndTablesWithColumns(std::__1::vector<DB::ASTTableExpression const*, std::__1::allocator<DB::ASTTableExpression const*> > const&, std::__1::shared_ptr<DB::Context const>, bool, bool) /home/milovidov/work/ClickHouse/build/../src/Interpreters/getTableExpressions.cpp:131:45\r\n    #49 0x330e1fd2 in DB::JoinedTables::resolveTables() /home/milovidov/work/ClickHouse/build/../src/Interpreters/JoinedTables.cpp:227:27\r\n    #50 0x324cad54 in DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context const>, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterSelectQuery.cpp:332:37\r\n    #51 0x324c7c24 in DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context const>, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterSelectQuery.cpp:159:7\r\n    #52 0x32fc6efb in std::__1::__unique_if<DB::InterpreterSelectQuery>::__unique_single std::__1::make_unique<DB::InterpreterSelectQuery, std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context>&, DB::SelectQueryOptions&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&>(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context>&, DB::SelectQueryOptions&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/memory:2068:32\r\n    #53 0x32fc6efb in DB::InterpreterSelectWithUnionQuery::buildCurrentChildInterpreter(std::__1::shared_ptr<DB::IAST> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:212:16\r\n    #54 0x32fc220c in DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::__1::shared_ptr<DB::IAST> const&, std::__1::shared_ptr<DB::Context const>, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:134:13\r\n    #55 0x3189197d in std::__1::__unique_if<DB::InterpreterSelectWithUnionQuery>::__unique_single std::__1::make_unique<DB::InterpreterSelectWithUnionQuery, std::__1::shared_ptr<DB::IAST>&, std::__1::shared_ptr<DB::Context>&, DB::SelectQueryOptions const&>(std::__1::shared_ptr<DB::IAST>&, std::__1::shared_ptr<DB::Context>&, DB::SelectQueryOptions const&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/memory:2068:32\r\n    #56 0x3188bd11 in DB::InterpreterFactory::get(std::__1::shared_ptr<DB::IAST>&, std::__1::shared_ptr<DB::Context>, DB::SelectQueryOptions const&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InterpreterFactory.cpp:110:16\r\n    #57 0x3378c23b in DB::executeQueryImpl(char const*, char const*, std::__1::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, bool, DB::ReadBuffer*) /home/milovidov/work/ClickHouse/build/../src/Interpreters/executeQuery.cpp:524:28\r\n    #58 0x33786ac3 in DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::shared_ptr<DB::Context>, bool, DB::QueryProcessingStage::Enum, bool) /home/milovidov/work/ClickHouse/build/../src/Interpreters/executeQuery.cpp:913:30\r\n    #59 0x35c8bb4c in DB::TCPHandler::runImpl() /home/milovidov/work/ClickHouse/build/../src/Server/TCPHandler.cpp:312:24\r\n    #60 0x35cce0e8 in DB::TCPHandler::run() /home/milovidov/work/ClickHouse/build/../src/Server/TCPHandler.cpp:1622:9\r\n    #61 0x421b840a in Poco::Net::TCPServerConnection::start() /home/milovidov/work/ClickHouse/build/../contrib/poco/Net/src/TCPServerConnection.cpp:43:3\r\n    #62 0x421b9ad8 in Poco::Net::TCPServerDispatcher::run() /home/milovidov/work/ClickHouse/build/../contrib/poco/Net/src/TCPServerDispatcher.cpp:115:20\r\n    #63 0x42685285 in Poco::PooledThread::run() /home/milovidov/work/ClickHouse/build/../contrib/poco/Foundation/src/ThreadPool.cpp:199:14\r\n    #64 0x42680188 in Poco::(anonymous namespace)::RunnableHolder::run() /home/milovidov/work/ClickHouse/build/../contrib/poco/Foundation/src/Thread.cpp:55:11\r\n    #65 0x4267c0db in Poco::ThreadImpl::runnableEntry(void*) /home/milovidov/work/ClickHouse/build/../contrib/poco/Foundation/src/Thread_POSIX.cpp:345:27\r\n    #66 0x7fd256d58608 in start_thread /build/glibc-eX1tMB/glibc-2.31/nptl/pthread_create.c:477:8\r\n    #67 0x7fd256c7f292 in clone /build/glibc-eX1tMB/glibc-2.31/misc/../sysdeps/unix/sysv/linux/x86_64/clone.S:95\r\n\r\n  Uninitialized value was created by a heap deallocation\r\n    #0 0x993af09 in operator delete(void*, unsigned long) /home/milovidov/work/ClickHouse/utils/ci/llvm-project/compiler-rt/lib/msan/msan_new_delete.cpp:84:57\r\n    #1 0x330f6c54 in void std::__1::__libcpp_operator_delete<void*, unsigned long>(void*, unsigned long) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/new:245:3\r\n    #2 0x330f6c54 in void std::__1::__do_deallocate_handle_size<>(void*, unsigned long) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/new:271:10\r\n    #3 0x330f6c54 in std::__1::__libcpp_deallocate(void*, unsigned long, unsigned long) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/new:285:14\r\n    #4 0x330f6c54 in std::__1::allocator<std::__1::__shared_ptr_emplace<DB::ASTSubquery, std::__1::allocator<DB::ASTSubquery> > >::deallocate(std::__1::__shared_ptr_emplace<DB::ASTSubquery, std::__1::allocator<DB::ASTSubquery> >*, unsigned long) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/memory:849:13\r\n    #5 0x330f6c54 in std::__1::allocator_traits<std::__1::allocator<std::__1::__shared_ptr_emplace<DB::ASTSubquery, std::__1::allocator<DB::ASTSubquery> > > >::deallocate(std::__1::allocator<std::__1::__shared_ptr_emplace<DB::ASTSubquery, std::__1::allocator<DB::ASTSubquery> > >&, std::__1::__shared_ptr_emplace<DB::ASTSubquery, std::__1::allocator<DB::ASTSubquery> >*, unsigned long) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/__memory/allocator_traits.h:476:14\r\n    #6 0x330f6c54 in std::__1::__shared_ptr_emplace<DB::ASTSubquery, std::__1::allocator<DB::ASTSubquery> >::__on_zero_shared_weak() /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/memory:2622:9\r\n    #7 0x4b73e969 in std::__1::__shared_weak_count::__release_weak() /home/milovidov/work/ClickHouse/build/../contrib/libcxx/src/memory.cpp\r\n    #8 0x336e20fe in std::__1::__shared_weak_count::__release_shared() /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/memory:2518:9\r\n    #9 0x336e20fe in std::__1::shared_ptr<DB::IAST>::~shared_ptr() /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/memory:3212:19\r\n    #10 0x336e20fe in std::__1::shared_ptr<DB::IAST>::operator=(std::__1::shared_ptr<DB::IAST>&&) /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/memory:3243:5\r\n    #11 0x336e20fe in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTSubquery const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:163:13\r\n    #12 0x336db726 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:57:9\r\n    #13 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #14 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #15 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #16 0x336e88ff in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:209:23\r\n    #17 0x336db892 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:59:9\r\n    #18 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #19 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #20 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #21 0x336e88ff in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:209:23\r\n    #22 0x336db892 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:59:9\r\n    #23 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #24 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #25 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #26 0x336e88ff in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:209:23\r\n    #27 0x336db892 in DB::ExecuteScalarSubqueriesMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:59:9\r\n    #28 0x335da05f in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:34:13\r\n    #29 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:55:17\r\n    #30 0x335da193 in DB::InDepthNodeVisitor<DB::ExecuteScalarSubqueriesMatcher, true, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/InDepthNodeVisitor.h:43:13\r\n    #31 0x336e88ff in DB::ExecuteScalarSubqueriesMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::ExecuteScalarSubqueriesMatcher::Data&) /home/milovidov/work/ClickHouse/build/../src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp:209:23\r\n\r\nSUMMARY: MemorySanitizer: use-of-uninitialized-value /home/milovidov/work/ClickHouse/build/../contrib/libcxx/include/string:2379:11 in std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >::operator=(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&)\r\nExiting\r\n```\n```\r\nSELECT a FROM (SELECT ignore((SELECT 1)) AS a, a AS b)\r\n```",
  "created_at": "2021-07-16T14:24:04Z",
  "modified_files": [
    "src/Interpreters/ExecuteScalarSubqueriesVisitor.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01247_some_msan_crashs_from_22517.reference",
    "b/tests/queries/0_stateless/01247_some_msan_crashs_from_22517.sql"
  ]
}