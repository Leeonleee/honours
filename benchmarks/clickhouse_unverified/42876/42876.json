{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 42876,
  "instance_id": "ClickHouse__ClickHouse-42876",
  "issue_numbers": [
    "42832"
  ],
  "base_commit": "74a1de564e7add52b27a92c3bb6b3550d67f08f8",
  "patch": "diff --git a/src/Interpreters/HashJoin.cpp b/src/Interpreters/HashJoin.cpp\nindex 26b9b8435679..41c7c28a6fa5 100644\n--- a/src/Interpreters/HashJoin.cpp\n+++ b/src/Interpreters/HashJoin.cpp\n@@ -658,7 +658,9 @@ void HashJoin::initRightBlockStructure(Block & saved_block_sample)\n     /// Save non key columns\n     for (auto & column : sample_block_with_columns_to_add)\n     {\n-        if (!saved_block_sample.findByName(column.name))\n+        if (auto * col = saved_block_sample.findByName(column.name))\n+            *col = column;\n+        else\n             saved_block_sample.insert(column);\n     }\n }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02475_join_bug_42832.reference b/tests/queries/0_stateless/02475_join_bug_42832.reference\nnew file mode 100644\nindex 000000000000..e5310261d0ab\n--- /dev/null\n+++ b/tests/queries/0_stateless/02475_join_bug_42832.reference\n@@ -0,0 +1,2 @@\n+4\t6\n+4\t4\ndiff --git a/tests/queries/0_stateless/02475_join_bug_42832.sql b/tests/queries/0_stateless/02475_join_bug_42832.sql\nnew file mode 100644\nindex 000000000000..e383949fb226\n--- /dev/null\n+++ b/tests/queries/0_stateless/02475_join_bug_42832.sql\n@@ -0,0 +1,16 @@\n+DROP TABLE IF EXISTS tab1;\n+DROP TABLE IF EXISTS tab2;\n+\n+SET allow_suspicious_low_cardinality_types = 1;\n+\n+CREATE TABLE tab1 (a1 Int32, b1 Int32, val UInt64) ENGINE = MergeTree ORDER BY a1;\n+CREATE TABLE tab2 (a2 LowCardinality(Int32), b2 Int32) ENGINE = MergeTree ORDER BY a2;\n+\n+INSERT INTO tab1 SELECT number, number, 1 from numbers(4);\n+INSERT INTO tab2 SELECT number + 2, number + 2 from numbers(4);\n+\n+SELECT sum(val), count(val) FROM tab1 FULL OUTER JOIN tab2 ON b1 - 2 = a2 OR a1 = b2 SETTINGS join_use_nulls = 0;\n+SELECT sum(val), count(val) FROM tab1 FULL OUTER JOIN tab2 ON b1 - 2 = a2 OR a1 = b2 SETTINGS join_use_nulls = 1;\n+\n+DROP TABLE IF EXISTS tab1;\n+DROP TABLE IF EXISTS tab2;\n",
  "problem_statement": "MSan report in JoinCommon::tryConvertColumnToNullable\nhttps://s3.amazonaws.com/clickhouse-test-reports/42778/66c179217cdfdee1ba0d4b4b577b1a62655caed0/fuzzer_astfuzzermsan//report.html\r\n\r\nMinimal example\r\n```sql\r\n#!/usr/bin/clickhouse-client --queries-file\r\n\r\nDROP TABLE IF EXISTS tab1;\r\nDROP TABLE IF EXISTS tab2;\r\n\r\nSET allow_suspicious_low_cardinality_types = 1;\r\n\r\ncreate table tab1 (a1 Int32, b1 Int32) engine = MergeTree order by a1;\r\ncreate table tab2 (a2 LowCardinality(Int32), b2 Int32) engine = MergeTree order by a2;\r\n\r\ninsert into tab1 values (1, 2);\r\ninsert into tab2 values (1, 2);\r\n\r\nSET join_use_nulls = 1;\r\n\r\nSELECT 1 FROM tab1 FULL OUTER JOIN tab2 ON b1 - 2 = a2 OR a1 = b2;\r\n\r\n```\n",
  "hints_text": "",
  "created_at": "2022-11-01T18:25:43Z",
  "modified_files": [
    "src/Interpreters/HashJoin.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02475_join_bug_42832.reference",
    "b/tests/queries/0_stateless/02475_join_bug_42832.sql"
  ]
}