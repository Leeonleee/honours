diff --git a/tests/testflows/aes_encryption/docker-compose/clickhouse-service.yml b/tests/testflows/aes_encryption/docker-compose/clickhouse-service.yml
index 9787b37abbba..0789decf022f 100644
--- a/tests/testflows/aes_encryption/docker-compose/clickhouse-service.yml
+++ b/tests/testflows/aes_encryption/docker-compose/clickhouse-service.yml
@@ -18,10 +18,10 @@ services:
     entrypoint: bash -c "clickhouse server --config-file=/etc/clickhouse-server/config.xml --log-file=/var/log/clickhouse-server/clickhouse-server.log --errorlog-file=/var/log/clickhouse-server/clickhouse-server.err.log"
     healthcheck:
       test: clickhouse client --query='select 1'
-      interval: 3s
-      timeout: 2s
-      retries: 40
-      start_period: 2s
+      interval: 10s
+      timeout: 10s
+      retries: 10
+      start_period: 300s
     cap_add:
       - SYS_PTRACE
     security_opt:
diff --git a/tests/testflows/example/docker-compose/clickhouse-service.yml b/tests/testflows/example/docker-compose/clickhouse-service.yml
index 2a56876c72e1..0789decf022f 100644
--- a/tests/testflows/example/docker-compose/clickhouse-service.yml
+++ b/tests/testflows/example/docker-compose/clickhouse-service.yml
@@ -20,7 +20,7 @@ services:
       test: clickhouse client --query='select 1'
       interval: 10s
       timeout: 10s
-      retries: 3
+      retries: 10
       start_period: 300s
     cap_add:
       - SYS_PTRACE
diff --git a/tests/testflows/ldap/authentication/docker-compose/clickhouse-service.yml b/tests/testflows/ldap/authentication/docker-compose/clickhouse-service.yml
index 2a56876c72e1..0789decf022f 100644
--- a/tests/testflows/ldap/authentication/docker-compose/clickhouse-service.yml
+++ b/tests/testflows/ldap/authentication/docker-compose/clickhouse-service.yml
@@ -20,7 +20,7 @@ services:
       test: clickhouse client --query='select 1'
       interval: 10s
       timeout: 10s
-      retries: 3
+      retries: 10
       start_period: 300s
     cap_add:
       - SYS_PTRACE
diff --git a/tests/testflows/ldap/authentication/regression.py b/tests/testflows/ldap/authentication/regression.py
index 50677d78cb8b..ff004a998cac 100755
--- a/tests/testflows/ldap/authentication/regression.py
+++ b/tests/testflows/ldap/authentication/regression.py
@@ -23,11 +23,7 @@
     "connection protocols/starttls with custom port":
      [(Fail, "it seems that starttls is not enabled by default on custom plain-text ports in LDAP server")],
     "connection protocols/tls cipher suite":
-     [(Fail, "can't get it to work")],
-    "external user directory/user authentications/valid verification cooldown value ldap unavailable":
-     [(Fail, "flaky, ask Vitaly Zakaznikov, Telegram @vzakaznikov")],
-    "user authentications/rbac=True/verification cooldown/verification cooldown performance":
-     [(Fail, "flaky, ask Vitaly Zakaznikov, Telegram @vzakaznikov")]
+     [(Fail, "can't get it to work")]
 }
 
 @TestFeature
diff --git a/tests/testflows/ldap/authentication/tests/authentications.py b/tests/testflows/ldap/authentication/tests/authentications.py
index 46bcae000b8c..b54cc880bbc0 100644
--- a/tests/testflows/ldap/authentication/tests/authentications.py
+++ b/tests/testflows/ldap/authentication/tests/authentications.py
@@ -131,7 +131,7 @@ def login_after_user_is_deleted_from_ldap(self, server, rbac=False):
             user = add_user_to_ldap(**user)
 
         with ldap_authenticated_users({"username": user["cn"], "server": server}, config_file=f"ldap_users_{getuid()}.xml",
-            restart=True, rbac=rbac):
+                restart=True, rbac=rbac):
             login_and_execute_query(username=user["cn"], password=user["userpassword"])
 
             with When("I delete this user from LDAP"):
@@ -202,7 +202,7 @@ def login_after_user_cn_changed_in_ldap(self, server, rbac=False):
             user = add_user_to_ldap(**user)
 
         with ldap_authenticated_users({"username": user["cn"], "server": server},
-            config_file=f"ldap_users_{getuid()}.xml", restart=True, rbac=rbac):
+                config_file=f"ldap_users_{getuid()}.xml", restart=True, rbac=rbac):
             login_and_execute_query(username=user["cn"], password=user["userpassword"])
 
             with When("I change user password in LDAP"):
diff --git a/tests/testflows/ldap/external_user_directory/docker-compose/clickhouse-service.yml b/tests/testflows/ldap/external_user_directory/docker-compose/clickhouse-service.yml
index 2a56876c72e1..0789decf022f 100644
--- a/tests/testflows/ldap/external_user_directory/docker-compose/clickhouse-service.yml
+++ b/tests/testflows/ldap/external_user_directory/docker-compose/clickhouse-service.yml
@@ -20,7 +20,7 @@ services:
       test: clickhouse client --query='select 1'
       interval: 10s
       timeout: 10s
-      retries: 3
+      retries: 10
       start_period: 300s
     cap_add:
       - SYS_PTRACE
diff --git a/tests/testflows/ldap/external_user_directory/requirements/requirements.md b/tests/testflows/ldap/external_user_directory/requirements/requirements.md
index cf9650f2cae2..998996c5874c 100644
--- a/tests/testflows/ldap/external_user_directory/requirements/requirements.md
+++ b/tests/testflows/ldap/external_user_directory/requirements/requirements.md
@@ -51,6 +51,7 @@
       * 4.2.2.4 [RQ.SRS-009.LDAP.ExternalUserDirectory.Role.New](#rqsrs-009ldapexternaluserdirectoryrolenew)
       * 4.2.2.5 [RQ.SRS-009.LDAP.ExternalUserDirectory.Role.NewPrivilege](#rqsrs-009ldapexternaluserdirectoryrolenewprivilege)
       * 4.2.2.6 [RQ.SRS-009.LDAP.ExternalUserDirectory.Role.RemovedPrivilege](#rqsrs-009ldapexternaluserdirectoryroleremovedprivilege)
+      * 4.2.2.7 [RQ.SRS-009.LDAP.ExternalUserDirectory.Role.NotPresent.Added](#rqsrs-009ldapexternaluserdirectoryrolenotpresentadded)
     * 4.2.3 [Configuration](#configuration)
       * 4.2.3.1 [RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Server.Invalid](#rqsrs-009ldapexternaluserdirectoryconfigurationserverinvalid)
       * 4.2.3.2 [RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Server.Definition](#rqsrs-009ldapexternaluserdirectoryconfigurationserverdefinition)
@@ -340,12 +341,10 @@ are configured during parallel [LDAP] user logins.
 #### Roles
 
 ##### RQ.SRS-009.LDAP.ExternalUserDirectory.Role.Removed
-version: 1.0
+version: 2.0
 
-[ClickHouse] SHALL reject authentication attempt if any of the roles that are specified in the configuration
-of the external user directory are not defined at the time of the authentication attempt
-with an exception that if a user was able to authenticate in past and its internal user object was created and cached
-then the user SHALL be able to authenticate again, even if one of the roles is missing.
+[ClickHouse] SHALL allow authentication even if the roles that are specified in the configuration
+of the external user directory are not defined at the time of the authentication attempt.
 
 ##### RQ.SRS-009.LDAP.ExternalUserDirectory.Role.Removed.Privileges
 version: 1.0
@@ -383,6 +382,14 @@ version: 1.0
 including cached users when privilege is removed from all the roles specified
 in the configuration of the external user directory.
 
+##### RQ.SRS-009.LDAP.ExternalUserDirectory.Role.NotPresent.Added
+version: 1.0
+
+[ClickHouse] SHALL add a role to the users authenticated using LDAP external user directory
+that did not exist during the time of authentication but are defined in the 
+configuration file as soon as the role with that name becomes
+available.
+
 #### Configuration
 
 ##### RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Server.Invalid
@@ -701,10 +708,10 @@ in the `<ldap>` sub-section in the `<user_directories>`
 if more than one `roles` parameter is defined in the configuration.
 
 ##### RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Users.Parameters.Roles.Invalid
-version: 1.0
+version: 2.0
 
-[ClickHouse] SHALL return an error if the role specified in the `<roles>`
-parameter does not exist locally.
+[ClickHouse] SHALL not return an error if the role specified in the `<roles>`
+parameter does not exist locally. 
 
 ##### RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Users.Parameters.Roles.Empty
 version: 1.0
diff --git a/tests/testflows/ldap/external_user_directory/requirements/requirements.py b/tests/testflows/ldap/external_user_directory/requirements/requirements.py
index 0e9f9320b141..4256ba627161 100644
--- a/tests/testflows/ldap/external_user_directory/requirements/requirements.py
+++ b/tests/testflows/ldap/external_user_directory/requirements/requirements.py
@@ -514,16 +514,14 @@
 
 RQ_SRS_009_LDAP_ExternalUserDirectory_Role_Removed = Requirement(
     name='RQ.SRS-009.LDAP.ExternalUserDirectory.Role.Removed',
-    version='1.0',
+    version='2.0',
     priority=None,
     group=None,
     type=None,
     uid=None,
     description=(
-        '[ClickHouse] SHALL reject authentication attempt if any of the roles that are specified in the configuration
'
-        'of the external user directory are not defined at the time of the authentication attempt
'
-        'with an exception that if a user was able to authenticate in past and its internal user object was created and cached
'
-        'then the user SHALL be able to authenticate again, even if one of the roles is missing.
'
+        '[ClickHouse] SHALL allow authentication even if the roles that are specified in the configuration
'
+        'of the external user directory are not defined at the time of the authentication attempt.
'
         '
'
         ),
     link=None,
@@ -616,6 +614,24 @@
     level=4,
     num='4.2.2.6')
 
+RQ_SRS_009_LDAP_ExternalUserDirectory_Role_NotPresent_Added = Requirement(
+    name='RQ.SRS-009.LDAP.ExternalUserDirectory.Role.NotPresent.Added',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL add a role to the users authenticated using LDAP external user directory
'
+        'that did not exist during the time of authentication but are defined in the 
'
+        'configuration file as soon as the role with that name becomes
'
+        'available.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.2.2.7')
+
 RQ_SRS_009_LDAP_ExternalUserDirectory_Configuration_Server_Invalid = Requirement(
     name='RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Server.Invalid',
     version='1.0',
@@ -1353,14 +1369,14 @@
 
 RQ_SRS_009_LDAP_ExternalUserDirectory_Configuration_Users_Parameters_Roles_Invalid = Requirement(
     name='RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Users.Parameters.Roles.Invalid',
-    version='1.0',
+    version='2.0',
     priority=None,
     group=None,
     type=None,
     uid=None,
     description=(
-        '[ClickHouse] SHALL return an error if the role specified in the `<roles>`
'
-        'parameter does not exist locally.
'
+        '[ClickHouse] SHALL not return an error if the role specified in the `<roles>`
'
+        'parameter does not exist locally. 
'
         '
'
         ),
     link=None,
@@ -1620,6 +1636,7 @@
         Heading(name='RQ.SRS-009.LDAP.ExternalUserDirectory.Role.New', level=4, num='4.2.2.4'),
         Heading(name='RQ.SRS-009.LDAP.ExternalUserDirectory.Role.NewPrivilege', level=4, num='4.2.2.5'),
         Heading(name='RQ.SRS-009.LDAP.ExternalUserDirectory.Role.RemovedPrivilege', level=4, num='4.2.2.6'),
+        Heading(name='RQ.SRS-009.LDAP.ExternalUserDirectory.Role.NotPresent.Added', level=4, num='4.2.2.7'),
         Heading(name='Configuration', level=3, num='4.2.3'),
         Heading(name='RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Server.Invalid', level=4, num='4.2.3.1'),
         Heading(name='RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Server.Definition', level=4, num='4.2.3.2'),
@@ -1716,6 +1733,7 @@
         RQ_SRS_009_LDAP_ExternalUserDirectory_Role_New,
         RQ_SRS_009_LDAP_ExternalUserDirectory_Role_NewPrivilege,
         RQ_SRS_009_LDAP_ExternalUserDirectory_Role_RemovedPrivilege,
+        RQ_SRS_009_LDAP_ExternalUserDirectory_Role_NotPresent_Added,
         RQ_SRS_009_LDAP_ExternalUserDirectory_Configuration_Server_Invalid,
         RQ_SRS_009_LDAP_ExternalUserDirectory_Configuration_Server_Definition,
         RQ_SRS_009_LDAP_ExternalUserDirectory_Configuration_Server_Name,
@@ -1825,6 +1843,7 @@
       * 4.2.2.4 [RQ.SRS-009.LDAP.ExternalUserDirectory.Role.New](#rqsrs-009ldapexternaluserdirectoryrolenew)
       * 4.2.2.5 [RQ.SRS-009.LDAP.ExternalUserDirectory.Role.NewPrivilege](#rqsrs-009ldapexternaluserdirectoryrolenewprivilege)
       * 4.2.2.6 [RQ.SRS-009.LDAP.ExternalUserDirectory.Role.RemovedPrivilege](#rqsrs-009ldapexternaluserdirectoryroleremovedprivilege)
+      * 4.2.2.7 [RQ.SRS-009.LDAP.ExternalUserDirectory.Role.NotPresent.Added](#rqsrs-009ldapexternaluserdirectoryrolenotpresentadded)
     * 4.2.3 [Configuration](#configuration)
       * 4.2.3.1 [RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Server.Invalid](#rqsrs-009ldapexternaluserdirectoryconfigurationserverinvalid)
       * 4.2.3.2 [RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Server.Definition](#rqsrs-009ldapexternaluserdirectoryconfigurationserverdefinition)
@@ -2114,12 +2133,10 @@
 #### Roles
 
 ##### RQ.SRS-009.LDAP.ExternalUserDirectory.Role.Removed
-version: 1.0
+version: 2.0
 
-[ClickHouse] SHALL reject authentication attempt if any of the roles that are specified in the configuration
-of the external user directory are not defined at the time of the authentication attempt
-with an exception that if a user was able to authenticate in past and its internal user object was created and cached
-then the user SHALL be able to authenticate again, even if one of the roles is missing.
+[ClickHouse] SHALL allow authentication even if the roles that are specified in the configuration
+of the external user directory are not defined at the time of the authentication attempt.
 
 ##### RQ.SRS-009.LDAP.ExternalUserDirectory.Role.Removed.Privileges
 version: 1.0
@@ -2157,6 +2174,14 @@
 including cached users when privilege is removed from all the roles specified
 in the configuration of the external user directory.
 
+##### RQ.SRS-009.LDAP.ExternalUserDirectory.Role.NotPresent.Added
+version: 1.0
+
+[ClickHouse] SHALL add a role to the users authenticated using LDAP external user directory
+that did not exist during the time of authentication but are defined in the 
+configuration file as soon as the role with that name becomes
+available.
+
 #### Configuration
 
 ##### RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Server.Invalid
@@ -2475,10 +2500,10 @@
 if more than one `roles` parameter is defined in the configuration.
 
 ##### RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Users.Parameters.Roles.Invalid
-version: 1.0
+version: 2.0
 
-[ClickHouse] SHALL return an error if the role specified in the `<roles>`
-parameter does not exist locally.
+[ClickHouse] SHALL not return an error if the role specified in the `<roles>`
+parameter does not exist locally. 
 
 ##### RQ.SRS-009.LDAP.ExternalUserDirectory.Configuration.Users.Parameters.Roles.Empty
 version: 1.0
diff --git a/tests/testflows/ldap/external_user_directory/tests/common.py b/tests/testflows/ldap/external_user_directory/tests/common.py
index 6d8a97e86110..e5980640721e 100644
--- a/tests/testflows/ldap/external_user_directory/tests/common.py
+++ b/tests/testflows/ldap/external_user_directory/tests/common.py
@@ -77,7 +77,7 @@ def verify_ldap_user_exists(server, username, password):
     with By("searching LDAP database"):
         ldap_node = current().context.cluster.node(server)
         r = ldap_node.command(
-            f"ldapwhoami -H ldap://localhost -D 'cn={username},ou=users,dc=company,dc=com' -w {password}")
+            f"ldapwhoami -H ldap://localhost -D 'cn={user_name},ou=users,dc=company,dc=com' -w {password}")
         assert r.exitcode == 0, error()
 
 def create_ldap_external_user_directory_config_content(server=None, roles=None, **kwargs):
@@ -96,7 +96,10 @@ def create_entries_ldap_external_user_directory_config_content(entries, config_d
         <user_directories>
             <ldap>
                 <server>my_ldap_server</server>
-                <user_template>my_user</user_template>
+                <roles>
+                    <my_local_role1 />
+                    <my_local_role2 />
+                </roles>
             </ldap>
         </user_directories>
     ```
diff --git a/tests/testflows/ldap/external_user_directory/tests/external_user_directory_config.py b/tests/testflows/ldap/external_user_directory/tests/external_user_directory_config.py
index b5677eba4b22..9ff480426bf1 100644
--- a/tests/testflows/ldap/external_user_directory/tests/external_user_directory_config.py
+++ b/tests/testflows/ldap/external_user_directory/tests/external_user_directory_config.py
@@ -220,15 +220,12 @@ def defined_twice_roles(self, timeout=20):
 
 @TestScenario
 @Requirements(
-    RQ_SRS_009_LDAP_ExternalUserDirectory_Configuration_Users_Parameters_Roles_Invalid("1.0")
+    RQ_SRS_009_LDAP_ExternalUserDirectory_Configuration_Users_Parameters_Roles_Invalid("2.0")
 )
 def invalid_role_in_roles(self, timeout=20):
-    """Check that an error is returned when LDAP users try to authenticate
+    """Check that no error is returned when LDAP users try to authenticate
     if an invalid role is specified inside the `roles` section.
     """
-    exitcode = 4
-    message = "DB::Exception: user1: Authentication failed"
-
     servers = {
         "openldap1": {
             "host": "openldap1", "port": "389", "enable_tls": "no",
@@ -241,8 +238,7 @@ def invalid_role_in_roles(self, timeout=20):
         with ldap_external_user_directory("openldap1", roles=["foo"], restart=True):
             with When(f"I login as {user['username']} and execute query"):
                 current().context.node.query("SELECT 1",
-                settings=[("user", user["username"]), ("password", user["password"])],
-                exitcode=exitcode, message=message)
+                    settings=[("user", user["username"]), ("password", user["password"])])
 
 @TestScenario
 @Requirements(
diff --git a/tests/testflows/ldap/external_user_directory/tests/roles.py b/tests/testflows/ldap/external_user_directory/tests/roles.py
index 8a6c6f465d17..2b68c1da36b9 100644
--- a/tests/testflows/ldap/external_user_directory/tests/roles.py
+++ b/tests/testflows/ldap/external_user_directory/tests/roles.py
@@ -139,17 +139,15 @@ def remove_privilege(self, server, timeout=20):
 
 @TestScenario
 @Requirements(
-    RQ_SRS_009_LDAP_ExternalUserDirectory_Role_Removed("1.0")
+    RQ_SRS_009_LDAP_ExternalUserDirectory_Role_Removed("2.0")
 )
 def remove_role(self, server, timeout=20):
     """Check that when a role used in the external user directory configuration
-    is dynamically removed then any non-cached LDAP users should not be authenticated using
+    is dynamically removed then any LDAP users should still be authenticated using
     LDAP external user directory.
     """
     node = self.context.node
     uid = getuid()
-    exitcode = 4
-    message = "DB::Exception: {user}: Authentication failed: password is incorrect or there is no user with such name"
 
     self.context.ldap_node = self.context.cluster.node(server)
 
@@ -174,8 +172,7 @@ def remove_role(self, server, timeout=20):
 
                     with And(f"I try to login again using non-cached LDAP user"):
                         node.query(f"SELECT 1",
-                            settings=[("user", users[1]["username"]), ("password", users[1]["password"])],
-                            exitcode=exitcode, message=message.format(user=users[1]["username"]))
+                            settings=[("user", users[1]["username"]), ("password", users[1]["password"])])
 
 @TestScenario
 @Requirements(
@@ -228,7 +225,7 @@ def readd_privilege_by_readding_role(self, server, timeout=20):
     """Check that when the role used in the external user directory configuration
     is dynamically removed then all the privileges are removed from any
     LDAP users authenticated using external user directory but when the role is re-added
-    then privileges are restored and non-cached users can login again.
+    then privileges are restored.
     """
     node = self.context.node
     uid = getuid()
@@ -265,13 +262,9 @@ def readd_privilege_by_readding_role(self, server, timeout=20):
                                 settings=[("user", users[0]["username"]), ("password", users[0]["password"])],
                                 exitcode=exitcode, message=message.format(user=users[0]["username"]))
 
-                        message = "DB::Exception: {user}: Authentication failed: password is incorrect or there is no user with such name"
-                        exitcode = 4
-
-                        with And(f"I try to login using non-cached LDAP user and expect it to fail"):
+                        with And(f"I try to login using non-cached LDAP user and expect it to succeed"):
                             node.query(f"SELECT 1",
-                                settings=[("user", users[1]["username"]), ("password", users[1]["password"])],
-                                exitcode=exitcode, message=message.format(user=users[1]["username"]))
+                                settings=[("user", users[1]["username"]), ("password", users[1]["password"])])
 
                         with When("I re-add the role"):
                             node.query(f"CREATE ROLE {roles[0]}")
@@ -284,11 +277,65 @@ def readd_privilege_by_readding_role(self, server, timeout=20):
                             node.query(f"SELECT * FROM {table_name} LIMIT 1",
                                 settings=[("user", users[0]["username"]), ("password", users[0]["password"])])
 
-                        with And("I try to login using non-cached LDAP expect it to work "
-                                "with user also having privilege provided by the role"):
+                        with And("I try to login using non-cached LDAP expect it to also work again and expect"
+                                "for the user also to have privilege provided by the role"):
                             node.query(f"SELECT * FROM {table_name} LIMIT 1",
                                 settings=[("user", users[1]["username"]), ("password", users[1]["password"])])
 
+@TestScenario
+@Requirements(
+    RQ_SRS_009_LDAP_ExternalUserDirectory_Role_NotPresent_Added("1.0")
+)
+def not_present_role_added(self, server, timeout=20):
+    """Check that when the role used in the external user directory configuration
+    which was not present during LDAP user authentication
+    is dynamically added then all the privileges granted by the role
+    are given to all users authenticated using external LDAP user directory.
+    """
+    node = self.context.node
+    uid = getuid()
+
+    self.context.ldap_node = self.context.cluster.node(server)
+
+    users = [
+        {"username": f"user0_{uid}", "password": "user0_password"},
+        {"username": f"user1_{uid}", "password": "user1_password"}
+    ]
+
+    roles = [f"role0_{uid}", f"role1_{uid}"]
+
+    with table(f"table_{getuid()}", "CREATE TABLE {name} (d DATE, s String, i UInt8) ENGINE = Memory()") as table_name:
+        with ldap_external_user_directory(server=server, roles=roles, restart=True):
+            with ldap_users(*[{"cn": user["username"], "userpassword": user["password"]} for user in users]):
+                with When(f"I login using clickhouse-client"):
+                    with self.context.cluster.shell(node=node.name) as shell:
+                        with shell(f"TERM=dumb clickhouse client --user {users[0]['username']} --password {users[0]['password']} | tee",
+                                asynchronous=True, name="client") as client:
+                            client.app.expect("clickhouse1 :\) ")
+
+                            with When("I execute select on the table"):
+                                client.app.send(f"SELECT * FROM {table_name} LIMIT 1")
+
+                            with Then("I expect to get not enough privileges error"):
+                                client.app.expect("Not enough privileges")
+                                client.app.expect("clickhouse1 :\) ")
+
+                            try:
+                                with Given("I add the role and grant the select privilege to it for the table"):
+                                    node.query(f"CREATE ROLE {roles[0]}")
+                                    node.query(f"GRANT SELECT ON {table_name} TO {roles[0]}")
+
+                                with When("I re-execute select on the table"):
+                                    client.app.send(f"SELECT * FROM {table_name} LIMIT 1")
+
+                                with Then("I expect to get no errors"):
+                                    client.app.expect("Ok\.")
+                                    client.app.expect("clickhouse1 :\) ")
+
+                            finally:
+                                with Finally("I delete the role"):
+                                    node.query(f"DROP ROLE IF EXISTS {roles[0]}")
+
 @TestFeature
 @Name("roles")
 @Requirements(
diff --git a/tests/testflows/ldap/external_user_directory/tests/server_config.py b/tests/testflows/ldap/external_user_directory/tests/server_config.py
index 617c0ee32e59..4e2e586f77c8 100644
--- a/tests/testflows/ldap/external_user_directory/tests/server_config.py
+++ b/tests/testflows/ldap/external_user_directory/tests/server_config.py
@@ -148,7 +148,7 @@ def invalid_enable_tls_value(self, timeout=60):
     servers = {"openldap1": {"host": "openldap1", "port": "389", "enable_tls": "foo",
         "auth_dn_prefix": "cn=", "auth_dn_suffix": ",ou=users,dc=company,dc=com"
     }}
-    invalid_server_config(servers, message=message, tail=17, timeout=timeout)
+    invalid_server_config(servers, message=message, tail=18, timeout=timeout)
 
 @TestScenario
 @Requirements(
diff --git a/tests/testflows/ldap/regression.py b/tests/testflows/ldap/regression.py
index 9cc9aa85f93d..579223c4b357 100755
--- a/tests/testflows/ldap/regression.py
+++ b/tests/testflows/ldap/regression.py
@@ -16,6 +16,7 @@ def regression(self, local, clickhouse_binary_path, parallel=None, stress=None):
 
     Feature(test=load("ldap.authentication.regression", "regression"))(**args)
     Feature(test=load("ldap.external_user_directory.regression", "regression"))(**args)
+    Feature(test=load("ldap.role_mapping.regression", "regression"))(**args)
 
 if main():
-    regression()
\ No newline at end of file
+    regression()
diff --git a/tests/testflows/ldap/role_mapping/__init__.py b/tests/testflows/ldap/role_mapping/__init__.py
new file mode 100644
index 000000000000..e69de29bb2d1
diff --git a/tests/testflows/ldap/role_mapping/configs/CA/ca.crt b/tests/testflows/ldap/role_mapping/configs/CA/ca.crt
new file mode 100644
index 000000000000..8c71e3afc91d
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/CA/ca.crt
@@ -0,0 +1,22 @@
+-----BEGIN CERTIFICATE-----
+MIIDlTCCAn2gAwIBAgIUJBqw2dHM2DDCZjYSkPOESlvDH6swDQYJKoZIhvcNAQEL
+BQAwWjELMAkGA1UEBhMCQ0ExCzAJBgNVBAgMAk9OMQ8wDQYDVQQHDAZPdHRhd2Ex
+ETAPBgNVBAoMCEFsdGluaXR5MQswCQYDVQQLDAJRQTENMAsGA1UEAwwEcm9vdDAe
+Fw0yMDA2MTExOTAzNDhaFw0zMDA2MDkxOTAzNDhaMFoxCzAJBgNVBAYTAkNBMQsw
+CQYDVQQIDAJPTjEPMA0GA1UEBwwGT3R0YXdhMREwDwYDVQQKDAhBbHRpbml0eTEL
+MAkGA1UECwwCUUExDTALBgNVBAMMBHJvb3QwggEiMA0GCSqGSIb3DQEBAQUAA4IB
+DwAwggEKAoIBAQC9Irr0zGV+HCI2fZ0ht4hR5It4Sbjz4RwZV8ENRP/+TEz8l9eK
+J6ygxhKX7SMYzIs/jS9Gsq4plX1r2ujW1qRf8yLpR4+dGLP+jBRi1drj0XjZXosT
+SERjWzgPauWxL9LN8+l26eBAqz6fw5e0W8WRSTgf5iGiCcKOTmaATIUjP0CdfWKK
+qpktI4vhe++CXZFJ3usR+8KZ/FwwbCLJM/3J2HnbcXfcaYPYvr1tfqLudKSTbG9H
+M3+AVwjctdesc/0sbd51Zsm0ClQptMbuKnDCYauGg61kNkgbgPgRmH9Pzo67DtxF
+/WW+PtOzq8xLOifciQ9Piboy9QBSQZGwf4wzAgMBAAGjUzBRMB0GA1UdDgQWBBSi
+njya0RDozx3OZTLYFpwqYnlpIDAfBgNVHSMEGDAWgBSinjya0RDozx3OZTLYFpwq
+YnlpIDAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBAD7VyFg7F
+U1C25KFvtauchAOjCW6w7U/b3z1dVZvcQ88/kH1VsLUcfGixlSilUEfPTJsi7OA0
+R5BQdh2GGcjUJv4iqEFGU05KvMVmRRKn08P62+ZhJxKMxG26VzcliRZzCMkI6d0W
+lFwI6nM45yeqdHVh5k4xbuJzqpbD9BtXXLI+/Ra9Fx8S9ETA3GdidpZLU5P1VLxq
+UuedfqyAVWZXpr6TAURGxouRmRzul9yFzbSUex+MLEIPrstjtEwV3+tBQZJz9xAS
+TVPj+Nv3LO7GCq54bdwkq1ioWbSL2hEmABkj6kdW/JwmfhGHf/2rirDVMzrTYw07
+dFJfAZC+FEsv
+-----END CERTIFICATE-----
diff --git a/tests/testflows/ldap/role_mapping/configs/CA/ca.key b/tests/testflows/ldap/role_mapping/configs/CA/ca.key
new file mode 100644
index 000000000000..e7a7f664dcf5
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/CA/ca.key
@@ -0,0 +1,30 @@
+-----BEGIN RSA PRIVATE KEY-----
+Proc-Type: 4,ENCRYPTED
+DEK-Info: AES-256-CBC,D06B9754A2069EBB4E77065DC9B605A1
+
+FJT794Z6AUuUB5Vp5W2iR6zzCvQUg2dtKoE+xhFdbgC7lmSfA2W/O9fx15Il67Yj
+Bbpm9Y6yteUSDQpJrvBdkhXeBkYEa5K1CA+0Jdx98nzwP3KBhHNxVVrTWRc5kniB
+LMV3iBQEbAafxgL7gN+EWr3eV7w7ZSqT7D5br/mlBALU62gv2UzwTXLu1CgyNWMC
+HIPjIX50Zga+BnhZhtQvM4Yj1gOsn+X6AaEZ3KjTfCDqthYQf2ldswW4gAlPAq83
++INq9Spx+QG97Z+1XO2DmmGTZL0z+OFLT+3y26/UcftM26ODY09Dcf3gt0n6RIUV
+0KsD1qQL0ppu4CHVnbIkOKMBe86qBl+kG8FVmyhgZ8D9ULlF1tpyTVKvHR82V2B5
+ztbc5EY1Fhb+r7OVVJlbCeo/bWmWybODZrpN49x5gGZpM3+8ApaHupGZ+cRFkQKG
+rDpqC5gflT3WwFNxtP5noWcV+Gzb3riXNM3c8G5aIpLZwmmaTLK9ahKqMcq4Ljf+
+hir8kuCMqIKt3m7Ceoj4wAHSP8xO0y/cc1WYNb3CI0Emk795aR6IPUw4vDEXHG27
+OLoCJTvl/JKRWJGkdQx8wKAs/uw/qwtbhYoQJccTjfvy4NXH3tpSgxCE8OTWuEch
+TAN8ra1PDGAUu+1MeT5gZ9uI1BEU6hXMME4mVRpJdcmw9MVy3V+B6rkUqX3kFAfR
+e2ueF5qgIp+A4/UlVe5cKdWAQxu4BnUESLooA7cbgcLypdao9bRx9bXH8S3aNgxW
+IdgICpc/v8wAX2yqMe191KgR9Vh1p0RCw/kEGVgWfY/IaQpsaYuq5quZbvr/fN5T
+d++ySAMaPysaCadLUdZJLw56uk4Y+PYzR+ygjTX9dCCHedrAU8RYM55FJ/fyD3bQ
+Hn9/n7PZyWy6u/TYt6dhlcYxaS3Opzw4eAQB8tGZJRYQ3AKpHpTEC57lXoMnUPKo
++nBmb0+YulylMZdns0WIBJlcv6qzIaNhDMrjyi18n1ezzPIGH7ivUjoXy2FL23q5
+f3aqJK4UUDEDkC8IeZkS+ykYxnohjFDhUyBe5gjryLqdMdy9EerehCWPf425AztX
+c/EWPzDl46qmxWhugOlz3Fiw95VlYu0MUDRayHuZiYPplgJypChuU4EHJ+q8V2z3
+BwjSo1bD4nfc8f68qEOtdZ1u/ClcolMwlZQYDJz/DiE4JOcd2Gx4QSF5vaInm0/4
+mMj/ZWna4DAYFbH8IGh7xUPDqeIWhBYlgrD69ajKyay5Vu3La/d2QW20BhX35Ro2
+ZJVR+lfioMmxn4y481H2pv+5gOlGwh02Oa8qLhZBb8W+DvFShNk6mk87eCForFFT
+CDgmvfsC/cS2wZkcFTecq6vbjFlt+OF13NCKlcO3wCm44D+bwVPeMrU6HycCVQw7
+SASrnP/th5sJbv11byb2lKgVdVHWk090bqnDwB9H2hGIb9JnPC9ZpaL/mocYyzTi
+H9fcBrMYkL09FJGr3Uff7qEY4XQTMlLadXue3iKd19PRgV8cRyKp37MYI9/3iLwv
+eYHLtMfrifZahf1ksOPeBphnlfzWo9qqfooUCaGxfSlNPUHhrHZ4aMiRyTE8Xeh2
+-----END RSA PRIVATE KEY-----
diff --git a/tests/testflows/ldap/role_mapping/configs/CA/ca.srl b/tests/testflows/ldap/role_mapping/configs/CA/ca.srl
new file mode 100644
index 000000000000..66feb9c8a359
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/CA/ca.srl
@@ -0,0 +1,1 @@
+227B125D27B6B1A4B5955361365DF8EC2D7098C1
diff --git a/tests/testflows/ldap/role_mapping/configs/CA/dhparam.pem b/tests/testflows/ldap/role_mapping/configs/CA/dhparam.pem
new file mode 100644
index 000000000000..554d75696ee1
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/CA/dhparam.pem
@@ -0,0 +1,8 @@
+-----BEGIN DH PARAMETERS-----
+MIIBCAKCAQEA1iatTn4jdw1WIu09qeLj8OEeLhzG/w2lI4RUeJT9nU+WTwegpvLN
+/MvrIMIKHRmItyxgraYFau2moC7RKm7OKLmFt6e34QeMvM1vXpuwQav6mfp8GsYL
+mEIw5riFcB73E32NN3g7qmfmurkTF28BohmqhuQp2et7FNoGBKQ6ePZzGHWil3yG
+nEnCwyK0o3eP2IEytx2N50uUWVdfg3MN34L3wqpUivArrjBkoMpqm3/V3wdfoYG9
+ZQkH0gIxT/2FIixCLGlfBsJ1qA/Apz1BJZbGqVu5M5iiQmq+LWN5JLS3xYai4wJL
+rIY8DhjbciSNVWkwTJHzaLwIQa9a6p6mUwIBAg==
+-----END DH PARAMETERS-----
diff --git a/tests/testflows/ldap/role_mapping/configs/CA/passphrase.txt b/tests/testflows/ldap/role_mapping/configs/CA/passphrase.txt
new file mode 100644
index 000000000000..2cf58b2364c3
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/CA/passphrase.txt
@@ -0,0 +1,1 @@
+altinity
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/common.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse/common.xml
new file mode 100644
index 000000000000..df952b28c82d
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/common.xml
@@ -0,0 +1,6 @@
+<yandex>
+    <timezone>Europe/Moscow</timezone>
+    <listen_host replace="replace">0.0.0.0</listen_host>
+    <path>/var/lib/clickhouse/</path>
+    <tmp_path>/var/lib/clickhouse/tmp/</tmp_path>
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/logs.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/logs.xml
new file mode 100644
index 000000000000..bdf1bbc11c11
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/logs.xml
@@ -0,0 +1,17 @@
+<yandex>
+    <shutdown_wait_unfinished>3</shutdown_wait_unfinished>
+    <logger>
+        <level>trace</level>
+        <log>/var/log/clickhouse-server/log.log</log>
+        <errorlog>/var/log/clickhouse-server/log.err.log</errorlog>
+        <size>1000M</size>
+        <count>10</count>
+        <stderr>/var/log/clickhouse-server/stderr.log</stderr>
+        <stdout>/var/log/clickhouse-server/stdout.log</stdout>
+    </logger>
+    <part_log>
+        <database>system</database>
+        <table>part_log</table>
+        <flush_interval_milliseconds>500</flush_interval_milliseconds>
+    </part_log>
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/ports.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/ports.xml
new file mode 100644
index 000000000000..fbc6cea74c0c
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/ports.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0"?>
+<yandex>
+    <https_port>8443</https_port>
+    <tcp_port_secure>9440</tcp_port_secure>
+</yandex>
\ No newline at end of file
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/remote.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/remote.xml
new file mode 100644
index 000000000000..51be2a6e8e3b
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/remote.xml
@@ -0,0 +1,107 @@
+<?xml version="1.0"?>
+<yandex>
+    <remote_servers>
+        <replicated_cluster>
+            <shard>
+                <internal_replication>true</internal_replication>
+                <replica>
+                    <host>clickhouse1</host>
+                    <port>9000</port>
+                </replica>
+                <replica>
+                    <host>clickhouse2</host>
+                    <port>9000</port>
+                </replica>
+                <replica>
+                    <host>clickhouse3</host>
+                    <port>9000</port>
+                </replica>
+            </shard>
+        </replicated_cluster>
+        <!--
+        <replicated_cluster_readonly>
+            <shard>
+                <internal_replication>true</internal_replication>
+                <replica>
+                    <host>clickhouse1</host>
+                    <port>9000</port>
+                    <user>readonly</user>
+                </replica>
+                <replica>
+                    <host>clickhouse2</host>
+                    <port>9000</port>
+                    <user>readonly</user>
+                </replica>
+                <replica>
+                    <host>clickhouse3</host>
+                    <port>9000</port>
+                    <user>readonly</user>
+                </replica>
+            </shard>
+        </replicated_cluster_readonly>
+        -->
+        <replicated_cluster_secure>
+            <shard>
+                <internal_replication>true</internal_replication>
+                <replica>
+                    <host>clickhouse1</host>
+                    <port>9440</port>
+                    <secure>1</secure>
+                </replica>
+                <replica>
+                    <host>clickhouse2</host>
+                    <port>9440</port>
+                    <secure>1</secure>
+                </replica>
+                <replica>
+                    <host>clickhouse3</host>
+                    <port>9440</port>
+                    <secure>1</secure>
+                </replica>
+            </shard>
+        </replicated_cluster_secure>
+        <sharded_cluster>
+            <shard>
+                <replica>
+                    <host>clickhouse1</host>
+                    <port>9000</port>
+                </replica>
+            </shard>
+            <shard>
+                <replica>
+                    <host>clickhouse2</host>
+                    <port>9000</port>
+                </replica>
+            </shard>
+            <shard>
+                <replica>
+                    <host>clickhouse3</host>
+                    <port>9000</port>
+                </replica>
+            </shard>
+        </sharded_cluster>
+        <sharded_cluster_secure>
+            <shard>
+                <replica>
+                    <host>clickhouse1</host>
+                    <port>9440</port>
+                    <secure>1</secure>
+                </replica>
+            </shard>
+            <shard>
+                <replica>
+                    <host>clickhouse2</host>
+                    <port>9440</port>
+                    <secure>1</secure>
+                </replica>
+            </shard>
+            <shard>
+                <replica>
+                    <host>clickhouse3</host>
+                    <port>9440</port>
+                    <secure>1</secure>
+                </replica>
+            </shard>
+        </sharded_cluster_secure>
+    </remote_servers>
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/ssl.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/ssl.xml
new file mode 100644
index 000000000000..ca65ffd5e043
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/ssl.xml
@@ -0,0 +1,17 @@
+<yandex>
+    <openSSL>
+        <server>
+            <certificateFile>/etc/clickhouse-server/ssl/server.crt</certificateFile>
+            <privateKeyFile>/etc/clickhouse-server/ssl/server.key</privateKeyFile>
+            <verificationMode>none</verificationMode>
+            <cacheSessions>true</cacheSessions>
+        </server>
+        <client>
+            <cacheSessions>true</cacheSessions>
+            <verificationMode>none</verificationMode>
+            <invalidCertificateHandler>
+                <name>AcceptCertificateHandler</name>
+            </invalidCertificateHandler>
+        </client>
+    </openSSL>
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/storage.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/storage.xml
new file mode 100644
index 000000000000..618fd6b6d24a
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/storage.xml
@@ -0,0 +1,20 @@
+<yandex>
+
+<storage_configuration>
+    <disks>
+        <default>
+            <keep_free_space_bytes>1024</keep_free_space_bytes>
+        </default>
+    </disks>
+    <policies>
+        <default>
+            <volumes>
+                <default>
+                    <disk>default</disk>
+                </default>
+            </volumes>
+        </default>
+    </policies>
+</storage_configuration>
+
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/zookeeper.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/zookeeper.xml
new file mode 100644
index 000000000000..96270e7b645a
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.d/zookeeper.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0"?>
+<yandex>
+    <zookeeper>
+	    <node index="1">
+		    <host>zookeeper</host>
+		    <port>2181</port>
+	    </node>
+        <session_timeout_ms>15000</session_timeout_ms>
+    </zookeeper>
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/config.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.xml
new file mode 100644
index 000000000000..e28a0c8e255b
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/config.xml
@@ -0,0 +1,442 @@
+<?xml version="1.0"?>
+<!--
+  NOTE: User and query level settings are set up in "users.xml" file.
+-->
+<yandex>
+    <logger>
+        <!-- Possible levels: https://github.com/pocoproject/poco/blob/develop/Foundation/include/Poco/Logger.h#L105 -->
+        <level>trace</level>
+        <log>/var/log/clickhouse-server/clickhouse-server.log</log>
+        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
+        <size>1000M</size>
+        <count>10</count>
+        <!-- <console>1</console> --> <!-- Default behavior is autodetection (log to console if not daemon mode and is tty) -->
+    </logger>
+    <!--display_name>production</display_name--> <!-- It is the name that will be shown in the client -->
+    <http_port>8123</http_port>
+    <tcp_port>9000</tcp_port>
+
+    <!-- For HTTPS and SSL over native protocol. -->
+    <!--
+    <https_port>8443</https_port>
+    <tcp_port_secure>9440</tcp_port_secure>
+    -->
+
+    <!-- Used with https_port and tcp_port_secure. Full ssl options list: https://github.com/ClickHouse-Extras/poco/blob/master/NetSSL_OpenSSL/include/Poco/Net/SSLManager.h#L71 -->
+    <openSSL>
+        <server> <!-- Used for https server AND secure tcp port -->
+            <!-- openssl req -subj "/CN=localhost" -new -newkey rsa:2048 -days 365 -nodes -x509 -keyout /etc/clickhouse-server/server.key -out /etc/clickhouse-server/server.crt -->
+            <certificateFile>/etc/clickhouse-server/server.crt</certificateFile>
+            <privateKeyFile>/etc/clickhouse-server/server.key</privateKeyFile>
+            <!-- openssl dhparam -out /etc/clickhouse-server/dhparam.pem 4096 -->
+            <dhParamsFile>/etc/clickhouse-server/dhparam.pem</dhParamsFile>
+            <verificationMode>none</verificationMode>
+            <loadDefaultCAFile>true</loadDefaultCAFile>
+            <cacheSessions>true</cacheSessions>
+            <disableProtocols>sslv2,sslv3</disableProtocols>
+            <preferServerCiphers>true</preferServerCiphers>
+        </server>
+
+        <client> <!-- Used for connecting to https dictionary source -->
+            <loadDefaultCAFile>true</loadDefaultCAFile>
+            <cacheSessions>true</cacheSessions>
+            <disableProtocols>sslv2,sslv3</disableProtocols>
+            <preferServerCiphers>true</preferServerCiphers>
+            <!-- Use for self-signed: <verificationMode>none</verificationMode> -->
+            <invalidCertificateHandler>
+                <!-- Use for self-signed: <name>AcceptCertificateHandler</name> -->
+                <name>RejectCertificateHandler</name>
+            </invalidCertificateHandler>
+        </client>
+    </openSSL>
+
+    <!-- Default root page on http[s] server. For example load UI from https://tabix.io/ when opening http://localhost:8123 -->
+    <!--
+    <http_server_default_response><![CDATA[<html ng-app="SMI2"><head><base href="http://ui.tabix.io/"></head><body><div ui-view="" class="content-ui"></div><script src="http://loader.tabix.io/master.js"></script></body></html>]]></http_server_default_response>
+    -->
+
+    <!-- Port for communication between replicas. Used for data exchange. -->
+    <interserver_http_port>9009</interserver_http_port>
+
+    <!-- Hostname that is used by other replicas to request this server.
+         If not specified, than it is determined analoguous to 'hostname -f' command.
+         This setting could be used to switch replication to another network interface.
+      -->
+    <!--
+    <interserver_http_host>example.yandex.ru</interserver_http_host>
+    -->
+
+    <!-- Listen specified host. use :: (wildcard IPv6 address), if you want to accept connections both with IPv4 and IPv6 from everywhere. -->
+    <!-- <listen_host>::</listen_host> -->
+    <!-- Same for hosts with disabled ipv6: -->
+    <!-- <listen_host>0.0.0.0</listen_host> -->
+
+    <!-- Default values - try listen localhost on ipv4 and ipv6: -->
+    <!--
+    <listen_host>::1</listen_host>
+    <listen_host>127.0.0.1</listen_host>
+    -->
+    <!-- Don't exit if ipv6 or ipv4 unavailable, but listen_host with this protocol specified -->
+    <!-- <listen_try>0</listen_try> -->
+
+    <!-- Allow listen on same address:port -->
+    <!-- <listen_reuse_port>0</listen_reuse_port> -->
+
+    <!-- <listen_backlog>64</listen_backlog> -->
+
+    <max_connections>4096</max_connections>
+    <keep_alive_timeout>3</keep_alive_timeout>
+
+    <!-- Maximum number of concurrent queries. -->
+    <max_concurrent_queries>100</max_concurrent_queries>
+
+    <!-- Set limit on number of open files (default: maximum). This setting makes sense on Mac OS X because getrlimit() fails to retrieve
+         correct maximum value. -->
+    <!-- <max_open_files>262144</max_open_files> -->
+
+    <!-- Size of cache of uncompressed blocks of data, used in tables of MergeTree family.
+         In bytes. Cache is single for server. Memory is allocated only on demand.
+         Cache is used when 'use_uncompressed_cache' user setting turned on (off by default).
+         Uncompressed cache is advantageous only for very short queries and in rare cases.
+      -->
+    <uncompressed_cache_size>8589934592</uncompressed_cache_size>
+
+    <!-- Approximate size of mark cache, used in tables of MergeTree family.
+         In bytes. Cache is single for server. Memory is allocated only on demand.
+         You should not lower this value.
+      -->
+    <mark_cache_size>5368709120</mark_cache_size>
+
+
+    <!-- Path to data directory, with trailing slash. -->
+    <path>/var/lib/clickhouse/</path>
+
+    <!-- Path to temporary data for processing hard queries. -->
+    <tmp_path>/var/lib/clickhouse/tmp/</tmp_path>
+
+    <!-- Directory with user provided files that are accessible by 'file' table function. -->
+    <user_files_path>/var/lib/clickhouse/user_files/</user_files_path>
+
+    <!-- Sources to read users, roles, access rights, profiles of settings, quotas. -->
+    <user_directories>
+        <users_xml>
+            <!-- Path to configuration file with predefined users. -->
+            <path>users.xml</path>
+        </users_xml>
+        <local_directory>
+            <!-- Path to folder where users created by SQL commands are stored. -->
+            <path>/var/lib/clickhouse/access/</path>
+        </local_directory>
+    </user_directories>
+
+    <!-- Default profile of settings. -->
+    <default_profile>default</default_profile>
+
+    <!-- System profile of settings. This settings are used by internal processes (Buffer storage, Distibuted DDL worker and so on). -->
+    <!-- <system_profile>default</system_profile> -->
+
+    <!-- Default database. -->
+    <default_database>default</default_database>
+
+    <!-- Server time zone could be set here.
+
+         Time zone is used when converting between String and DateTime types,
+          when printing DateTime in text formats and parsing DateTime from text,
+          it is used in date and time related functions, if specific time zone was not passed as an argument.
+
+         Time zone is specified as identifier from IANA time zone database, like UTC or Africa/Abidjan.
+         If not specified, system time zone at server startup is used.
+
+         Please note, that server could display time zone alias instead of specified name.
+         Example: W-SU is an alias for Europe/Moscow and Zulu is an alias for UTC.
+    -->
+    <!-- <timezone>Europe/Moscow</timezone> -->
+
+    <!-- You can specify umask here (see "man umask"). Server will apply it on startup.
+         Number is always parsed as octal. Default umask is 027 (other users cannot read logs, data files, etc; group can only read).
+    -->
+    <!-- <umask>022</umask> -->
+
+    <!-- Perform mlockall after startup to lower first queries latency
+          and to prevent clickhouse executable from being paged out under high IO load.
+         Enabling this option is recommended but will lead to increased startup time for up to a few seconds.
+    -->
+    <mlock_executable>false</mlock_executable>
+
+    <!-- Configuration of clusters that could be used in Distributed tables.
+         https://clickhouse.yandex/docs/en/table_engines/distributed/
+      -->
+    <remote_servers incl="remote" >
+        <!-- Test only shard config for testing distributed storage -->
+        <test_shard_localhost>
+            <shard>
+                <replica>
+                    <host>localhost</host>
+                    <port>9000</port>
+                </replica>
+            </shard>
+        </test_shard_localhost>
+        <test_cluster_two_shards_localhost>
+             <shard>
+                 <replica>
+                     <host>localhost</host>
+                     <port>9000</port>
+                 </replica>
+             </shard>
+             <shard>
+                 <replica>
+                     <host>localhost</host>
+                     <port>9000</port>
+                 </replica>
+             </shard>
+         </test_cluster_two_shards_localhost>
+        <test_shard_localhost_secure>
+            <shard>
+                <replica>
+                    <host>localhost</host>
+                    <port>9440</port>
+                    <secure>1</secure>
+                </replica>
+            </shard>
+        </test_shard_localhost_secure>
+        <test_unavailable_shard>
+            <shard>
+                <replica>
+                    <host>localhost</host>
+                    <port>9000</port>
+                </replica>
+            </shard>
+            <shard>
+                <replica>
+                    <host>localhost</host>
+                    <port>1</port>
+                </replica>
+            </shard>
+        </test_unavailable_shard>
+    </remote_servers>
+
+
+    <!-- If element has 'incl' attribute, then for it's value will be used corresponding substitution from another file.
+         By default, path to file with substitutions is /etc/metrika.xml. It could be changed in config in 'include_from' element.
+         Values for substitutions are specified in /yandex/name_of_substitution elements in that file.
+      -->
+
+    <!-- ZooKeeper is used to store metadata about replicas, when using Replicated tables.
+         Optional. If you don't use replicated tables, you could omit that.
+
+         See https://clickhouse.yandex/docs/en/table_engines/replication/
+      -->
+    <zookeeper incl="zookeeper" optional="true" />
+
+    <!-- Substitutions for parameters of replicated tables.
+          Optional. If you don't use replicated tables, you could omit that.
+
+         See https://clickhouse.yandex/docs/en/table_engines/replication/#creating-replicated-tables
+      -->
+    <macros incl="macros" optional="true" />
+
+
+    <!-- Reloading interval for embedded dictionaries, in seconds. Default: 3600. -->
+    <builtin_dictionaries_reload_interval>3600</builtin_dictionaries_reload_interval>
+
+
+    <!-- Maximum session timeout, in seconds. Default: 3600. -->
+    <max_session_timeout>3600</max_session_timeout>
+
+    <!-- Default session timeout, in seconds. Default: 60. -->
+    <default_session_timeout>60</default_session_timeout>
+
+    <!-- Sending data to Graphite for monitoring. Several sections can be defined. -->
+    <!--
+        interval - send every X second
+        root_path - prefix for keys
+        hostname_in_path - append hostname to root_path (default = true)
+        metrics - send data from table system.metrics
+        events - send data from table system.events
+        asynchronous_metrics - send data from table system.asynchronous_metrics
+    -->
+    <!--
+    <graphite>
+        <host>localhost</host>
+        <port>42000</port>
+        <timeout>0.1</timeout>
+        <interval>60</interval>
+        <root_path>one_min</root_path>
+        <hostname_in_path>true</hostname_in_path>
+
+        <metrics>true</metrics>
+        <events>true</events>
+        <asynchronous_metrics>true</asynchronous_metrics>
+    </graphite>
+    <graphite>
+        <host>localhost</host>
+        <port>42000</port>
+        <timeout>0.1</timeout>
+        <interval>1</interval>
+        <root_path>one_sec</root_path>
+
+        <metrics>true</metrics>
+        <events>true</events>
+        <asynchronous_metrics>false</asynchronous_metrics>
+    </graphite>
+    -->
+
+
+    <!-- Query log. Used only for queries with setting log_queries = 1. -->
+    <query_log>
+        <!-- What table to insert data. If table is not exist, it will be created.
+             When query log structure is changed after system update,
+              then old table will be renamed and new table will be created automatically.
+        -->
+        <database>system</database>
+        <table>query_log</table>
+        <!--
+            PARTITION BY expr https://clickhouse.yandex/docs/en/table_engines/custom_partitioning_key/
+            Example:
+                event_date
+                toMonday(event_date)
+                toYYYYMM(event_date)
+                toStartOfHour(event_time)
+        -->
+        <partition_by>toYYYYMM(event_date)</partition_by>
+        <!-- Interval of flushing data. -->
+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>
+    </query_log>
+
+    <!-- Trace log. Stores stack traces collected by query profilers.
+         See query_profiler_real_time_period_ns and query_profiler_cpu_time_period_ns settings. -->
+    <trace_log>
+        <database>system</database>
+        <table>trace_log</table>
+
+        <partition_by>toYYYYMM(event_date)</partition_by>
+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>
+    </trace_log>
+
+    <!-- Query thread log. Has information about all threads participated in query execution.
+         Used only for queries with setting log_query_threads = 1. -->
+    <query_thread_log>
+        <database>system</database>
+        <table>query_thread_log</table>
+        <partition_by>toYYYYMM(event_date)</partition_by>
+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>
+    </query_thread_log>
+
+    <!-- Uncomment if use part log.
+         Part log contains information about all actions with parts in MergeTree tables (creation, deletion, merges, downloads).
+    <part_log>
+        <database>system</database>
+        <table>part_log</table>
+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>
+    </part_log>
+    -->
+
+    <!-- Uncomment to write text log into table.
+         Text log contains all information from usual server log but stores it in structured and efficient way.
+    <text_log>
+        <database>system</database>
+        <table>text_log</table>
+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>
+    </text_log>
+    -->
+
+    <!-- Parameters for embedded dictionaries, used in Yandex.Metrica.
+         See https://clickhouse.yandex/docs/en/dicts/internal_dicts/
+    -->
+
+    <!-- Path to file with region hierarchy. -->
+    <!-- <path_to_regions_hierarchy_file>/opt/geo/regions_hierarchy.txt</path_to_regions_hierarchy_file> -->
+
+    <!-- Path to directory with files containing names of regions -->
+    <!-- <path_to_regions_names_files>/opt/geo/</path_to_regions_names_files> -->
+
+
+    <!-- Configuration of external dictionaries. See:
+         https://clickhouse.yandex/docs/en/dicts/external_dicts/
+    -->
+    <dictionaries_config>*_dictionary.xml</dictionaries_config>
+
+    <!-- Uncomment if you want data to be compressed 30-100% better.
+         Don't do that if you just started using ClickHouse.
+      -->
+    <compression incl="compression">
+    <!--
+        <!- - Set of variants. Checked in order. Last matching case wins. If nothing matches, lz4 will be used. - ->
+        <case>
+
+            <!- - Conditions. All must be satisfied. Some conditions may be omitted. - ->
+            <min_part_size>10000000000</min_part_size>        <!- - Min part size in bytes. - ->
+            <min_part_size_ratio>0.01</min_part_size_ratio>   <!- - Min size of part relative to whole table size. - ->
+
+            <!- - What compression method to use. - ->
+            <method>zstd</method>
+        </case>
+    -->
+    </compression>
+
+    <!-- Allow to execute distributed DDL queries (CREATE, DROP, ALTER, RENAME) on cluster.
+         Works only if ZooKeeper is enabled. Comment it if such functionality isn't required. -->
+    <distributed_ddl>
+        <!-- Path in ZooKeeper to queue with DDL queries -->
+        <path>/clickhouse/task_queue/ddl</path>
+
+        <!-- Settings from this profile will be used to execute DDL queries -->
+        <!-- <profile>default</profile> -->
+    </distributed_ddl>
+
+    <!-- Settings to fine tune MergeTree tables. See documentation in source code, in MergeTreeSettings.h -->
+    <!--
+    <merge_tree>
+        <max_suspicious_broken_parts>5</max_suspicious_broken_parts>
+    </merge_tree>
+    -->
+
+    <!-- Protection from accidental DROP.
+         If size of a MergeTree table is greater than max_table_size_to_drop (in bytes) than table could not be dropped with any DROP query.
+         If you want do delete one table and don't want to restart clickhouse-server, you could create special file <clickhouse-path>/flags/force_drop_table and make DROP once.
+         By default max_table_size_to_drop is 50GB; max_table_size_to_drop=0 allows to DROP any tables.
+         The same for max_partition_size_to_drop.
+         Uncomment to disable protection.
+    -->
+    <!-- <max_table_size_to_drop>0</max_table_size_to_drop> -->
+    <!-- <max_partition_size_to_drop>0</max_partition_size_to_drop> -->
+
+    <!-- Example of parameters for GraphiteMergeTree table engine -->
+    <graphite_rollup_example>
+        <pattern>
+            <regexp>click_cost</regexp>
+            <function>any</function>
+            <retention>
+                <age>0</age>
+                <precision>3600</precision>
+            </retention>
+            <retention>
+                <age>86400</age>
+                <precision>60</precision>
+            </retention>
+        </pattern>
+        <default>
+            <function>max</function>
+            <retention>
+                <age>0</age>
+                <precision>60</precision>
+            </retention>
+            <retention>
+                <age>3600</age>
+                <precision>300</precision>
+            </retention>
+            <retention>
+                <age>86400</age>
+                <precision>3600</precision>
+            </retention>
+        </default>
+    </graphite_rollup_example>
+
+    <!-- Directory in <clickhouse-path> containing schema files for various input formats.
+         The directory will be created if it doesn't exist.
+      -->
+    <format_schema_path>/var/lib/clickhouse/format_schemas/</format_schema_path>
+
+    <!-- Uncomment to disable ClickHouse internal DNS caching. -->
+    <!-- <disable_internal_dns_cache>1</disable_internal_dns_cache> -->
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/ssl/dhparam.pem b/tests/testflows/ldap/role_mapping/configs/clickhouse/ssl/dhparam.pem
new file mode 100644
index 000000000000..2e6cee0798d7
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/ssl/dhparam.pem
@@ -0,0 +1,8 @@
+-----BEGIN DH PARAMETERS-----
+MIIBCAKCAQEAua92DDli13gJ+//ZXyGaggjIuidqB0crXfhUlsrBk9BV1hH3i7fR
+XGP9rUdk2ubnB3k2ejBStL5oBrkHm9SzUFSQHqfDjLZjKoUpOEmuDc4cHvX1XTR5
+Pr1vf5cd0yEncJWG5W4zyUB8k++SUdL2qaeslSs+f491HBLDYn/h8zCgRbBvxhxb
+9qeho1xcbnWeqkN6Kc9bgGozA16P9NLuuLttNnOblkH+lMBf42BSne/TWt3AlGZf
+slKmmZcySUhF8aKfJnLKbkBCFqOtFRh8zBA9a7g+BT/lSANATCDPaAk1YVih2EKb
+dpc3briTDbRsiqg2JKMI7+VdULY9bh3EawIBAg==
+-----END DH PARAMETERS-----
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/ssl/server.crt b/tests/testflows/ldap/role_mapping/configs/clickhouse/ssl/server.crt
new file mode 100644
index 000000000000..7ade2d962733
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/ssl/server.crt
@@ -0,0 +1,19 @@
+-----BEGIN CERTIFICATE-----
+MIIC/TCCAeWgAwIBAgIJANjx1QSR77HBMA0GCSqGSIb3DQEBCwUAMBQxEjAQBgNV
+BAMMCWxvY2FsaG9zdDAgFw0xODA3MzAxODE2MDhaGA8yMjkyMDUxNDE4MTYwOFow
+FDESMBAGA1UEAwwJbG9jYWxob3N0MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
+CgKCAQEAs9uSo6lJG8o8pw0fbVGVu0tPOljSWcVSXH9uiJBwlZLQnhN4SFSFohfI
+4K8U1tBDTnxPLUo/V1K9yzoLiRDGMkwVj6+4+hE2udS2ePTQv5oaMeJ9wrs+5c9T
+4pOtlq3pLAdm04ZMB1nbrEysceVudHRkQbGHzHp6VG29Fw7Ga6YpqyHQihRmEkTU
+7UCYNA+Vk7aDPdMS/khweyTpXYZimaK9f0ECU3/VOeG3fH6Sp2X6FN4tUj/aFXEj
+sRmU5G2TlYiSIUMF2JPdhSihfk1hJVALrHPTU38SOL+GyyBRWdNcrIwVwbpvsvPg
+pryMSNxnpr0AK0dFhjwnupIv5hJIOQIDAQABo1AwTjAdBgNVHQ4EFgQUjPLb3uYC
+kcamyZHK4/EV8jAP0wQwHwYDVR0jBBgwFoAUjPLb3uYCkcamyZHK4/EV8jAP0wQw
+DAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAM/ocuDvfPus/KpMVD51j
+4IdlU8R0vmnYLQ+ygzOAo7+hUWP5j0yvq4ILWNmQX6HNvUggCgFv9bjwDFhb/5Vr
+85ieWfTd9+LTjrOzTw4avdGwpX9G+6jJJSSq15tw5ElOIFb/qNA9O4dBiu8vn03C
+L/zRSXrARhSqTW5w/tZkUcSTT+M5h28+Lgn9ysx4Ff5vi44LJ1NnrbJbEAIYsAAD
++UA+4MBFKx1r6hHINULev8+lCfkpwIaeS8RL+op4fr6kQPxnULw8wT8gkuc8I4+L
+P9gg/xDHB44T3ADGZ5Ib6O0DJaNiToO6rnoaaxs0KkotbvDWvRoxEytSbXKoYjYp
+0g==
+-----END CERTIFICATE-----
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/ssl/server.key b/tests/testflows/ldap/role_mapping/configs/clickhouse/ssl/server.key
new file mode 100644
index 000000000000..f0fb61ac443f
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/ssl/server.key
@@ -0,0 +1,28 @@
+-----BEGIN PRIVATE KEY-----
+MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCz25KjqUkbyjyn
+DR9tUZW7S086WNJZxVJcf26IkHCVktCeE3hIVIWiF8jgrxTW0ENOfE8tSj9XUr3L
+OguJEMYyTBWPr7j6ETa51LZ49NC/mhox4n3Cuz7lz1Pik62WreksB2bThkwHWdus
+TKxx5W50dGRBsYfMenpUbb0XDsZrpimrIdCKFGYSRNTtQJg0D5WTtoM90xL+SHB7
+JOldhmKZor1/QQJTf9U54bd8fpKnZfoU3i1SP9oVcSOxGZTkbZOViJIhQwXYk92F
+KKF+TWElUAusc9NTfxI4v4bLIFFZ01ysjBXBum+y8+CmvIxI3GemvQArR0WGPCe6
+ki/mEkg5AgMBAAECggEATrbIBIxwDJOD2/BoUqWkDCY3dGevF8697vFuZKIiQ7PP
+TX9j4vPq0DfsmDjHvAPFkTHiTQXzlroFik3LAp+uvhCCVzImmHq0IrwvZ9xtB43f
+7Pkc5P6h1l3Ybo8HJ6zRIY3TuLtLxuPSuiOMTQSGRL0zq3SQ5DKuGwkz+kVjHXUN
+MR2TECFwMHKQ5VLrC+7PMpsJYyOMlDAWhRfUalxC55xOXTpaN8TxNnwQ8K2ISVY5
+212Jz/a4hn4LdwxSz3Tiu95PN072K87HLWx3EdT6vW4Ge5P/A3y+smIuNAlanMnu
+plHBRtpATLiTxZt/n6npyrfQVbYjSH7KWhB8hBHtaQKBgQDh9Cq1c/KtqDtE0Ccr
+/r9tZNTUwBE6VP+3OJeKdEdtsfuxjOCkS1oAjgBJiSDOiWPh1DdoDeVZjPKq6pIu
+Mq12OE3Doa8znfCXGbkSzEKOb2unKZMJxzrz99kXt40W5DtrqKPNb24CNqTiY8Aa
+CjtcX+3weat82VRXvph6U8ltMwKBgQDLxjiQQzNoY7qvg7CwJCjf9qq8jmLK766g
+1FHXopqS+dTxDLM8eJSRrpmxGWJvNeNc1uPhsKsKgotqAMdBUQTf7rSTbt4MyoH5
+bUcRLtr+0QTK9hDWMOOvleqNXha68vATkohWYfCueNsC60qD44o8RZAS6UNy3ENq
+cM1cxqe84wKBgQDKkHutWnooJtajlTxY27O/nZKT/HA1bDgniMuKaz4R4Gr1PIez
+on3YW3V0d0P7BP6PWRIm7bY79vkiMtLEKdiKUGWeyZdo3eHvhDb/3DCawtau8L2K
+GZsHVp2//mS1Lfz7Qh8/L/NedqCQ+L4iWiPnZ3THjjwn3CoZ05ucpvrAMwKBgB54
+nay039MUVq44Owub3KDg+dcIU62U+cAC/9oG7qZbxYPmKkc4oL7IJSNecGHA5SbU
+2268RFdl/gLz6tfRjbEOuOHzCjFPdvAdbysanpTMHLNc6FefJ+zxtgk9sJh0C4Jh
+vxFrw9nTKKzfEl12gQ1SOaEaUIO0fEBGbe8ZpauRAoGAMAlGV+2/K4ebvAJKOVTa
+dKAzQ+TD2SJmeR1HZmKDYddNqwtZlzg3v4ZhCk4eaUmGeC1Bdh8MDuB3QQvXz4Dr
+vOIP4UVaOr+uM+7TgAgVnP4/K6IeJGzUDhX93pmpWhODfdu/oojEKVcpCojmEmS1
+KCBtmIrQLqzMpnBpLNuSY+Q=
+-----END PRIVATE KEY-----
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse/users.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse/users.xml
new file mode 100644
index 000000000000..86b2cd9e1e3d
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse/users.xml
@@ -0,0 +1,133 @@
+<?xml version="1.0"?>
+<yandex>
+    <!-- Profiles of settings. -->
+    <profiles>
+        <!-- Default settings. -->
+        <default>
+            <!-- Maximum memory usage for processing single query, in bytes. -->
+            <max_memory_usage>10000000000</max_memory_usage>
+
+            <!-- Use cache of uncompressed blocks of data. Meaningful only for processing many of very short queries. -->
+            <use_uncompressed_cache>0</use_uncompressed_cache>
+
+            <!-- How to choose between replicas during distributed query processing.
+                 random - choose random replica from set of replicas with minimum number of errors
+                 nearest_hostname - from set of replicas with minimum number of errors, choose replica
+                  with minimum number of different symbols between replica's hostname and local hostname
+                  (Hamming distance).
+                 in_order - first live replica is chosen in specified order.
+                 first_or_random - if first replica one has higher number of errors, pick a random one from replicas with minimum number of errors.
+            -->
+            <load_balancing>random</load_balancing>
+        </default>
+
+        <!-- Profile that allows only read queries. -->
+        <readonly>
+            <readonly>1</readonly>
+        </readonly>
+    </profiles>
+
+    <!-- Users and ACL. -->
+    <users>
+        <!-- If user name was not specified, 'default' user is used. -->
+        <default>
+            <!-- Password could be specified in plaintext or in SHA256 (in hex format).
+
+                 If you want to specify password in plaintext (not recommended), place it in 'password' element.
+                 Example: <password>qwerty</password>.
+                 Password could be empty.
+
+                 If you want to specify SHA256, place it in 'password_sha256_hex' element.
+                 Example: <password_sha256_hex>65e84be33532fb784c48129675f9eff3a682b27168c0ea744b2cf58ee02337c5</password_sha256_hex>
+                 Restrictions of SHA256: impossibility to connect to ClickHouse using MySQL JS client (as of July 2019).
+
+                 If you want to specify double SHA1, place it in 'password_double_sha1_hex' element.
+                 Example: <password_double_sha1_hex>e395796d6546b1b65db9d665cd43f0e858dd4303</password_double_sha1_hex>
+
+                 How to generate decent password:
+                 Execute: PASSWORD=$(base64 < /dev/urandom | head -c8); echo "$PASSWORD"; echo -n "$PASSWORD" | sha256sum | tr -d '-'
+                 In first line will be password and in second - corresponding SHA256.
+
+                 How to generate double SHA1:
+                 Execute: PASSWORD=$(base64 < /dev/urandom | head -c8); echo "$PASSWORD"; echo -n "$PASSWORD" | openssl dgst -sha1 -binary | openssl dgst -sha1
+                 In first line will be password and in second - corresponding double SHA1.
+            -->
+            <password></password>
+
+            <!-- List of networks with open access.
+
+                 To open access from everywhere, specify:
+                    <ip>::/0</ip>
+
+                 To open access only from localhost, specify:
+                    <ip>::1</ip>
+                    <ip>127.0.0.1</ip>
+
+                 Each element of list has one of the following forms:
+                 <ip> IP-address or network mask. Examples: 213.180.204.3 or 10.0.0.1/8 or 10.0.0.1/255.255.255.0
+                     2a02:6b8::3 or 2a02:6b8::3/64 or 2a02:6b8::3/ffff:ffff:ffff:ffff::.
+                 <host> Hostname. Example: server01.yandex.ru.
+                     To check access, DNS query is performed, and all received addresses compared to peer address.
+                 <host_regexp> Regular expression for host names. Example, ^server\d\d-\d\d-\d\.yandex\.ru$
+                     To check access, DNS PTR query is performed for peer address and then regexp is applied.
+                     Then, for result of PTR query, another DNS query is performed and all received addresses compared to peer address.
+                     Strongly recommended that regexp is ends with $
+                 All results of DNS requests are cached till server restart.
+            -->
+            <networks incl="networks" replace="replace">
+                <ip>::/0</ip>
+            </networks>
+
+            <!-- Settings profile for user. -->
+            <profile>default</profile>
+
+            <!-- Quota for user. -->
+            <quota>default</quota>
+
+            <!-- Allow access management -->
+            <access_management>1</access_management>
+
+            <!-- Example of row level security policy. -->
+            <!-- <databases>
+                <test>
+                    <filtered_table1>
+                        <filter>a = 1</filter>
+                    </filtered_table1>
+                    <filtered_table2>
+                        <filter>a + b &lt; 1 or c - d &gt; 5</filter>
+                    </filtered_table2>
+                </test>
+            </databases> -->
+        </default>
+
+        <!-- Example of user with readonly access. -->
+        <!-- <readonly>
+            <password></password>
+            <networks incl="networks" replace="replace">
+                <ip>::1</ip>
+                <ip>127.0.0.1</ip>
+            </networks>
+            <profile>readonly</profile>
+            <quota>default</quota>
+        </readonly> -->
+    </users>
+
+    <!-- Quotas. -->
+    <quotas>
+        <!-- Name of quota. -->
+        <default>
+            <!-- Limits for time interval. You could specify many intervals with different limits. -->
+            <interval>
+                <!-- Length of interval. -->
+                <duration>3600</duration>
+
+                <!-- No limits. Just calculate resource usage for time interval. -->
+                <queries>0</queries>
+                <errors>0</errors>
+                <result_rows>0</result_rows>
+                <read_rows>0</read_rows>
+                <execution_time>0</execution_time>
+            </interval>
+        </default>
+    </quotas>
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse1/config.d/macros.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse1/config.d/macros.xml
new file mode 100644
index 000000000000..6cdcc1b440c3
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse1/config.d/macros.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0"?>
+<yandex>
+    <macros>
+        <replica>clickhouse1</replica>
+        <shard>01</shard>
+        <shard2>01</shard2>
+    </macros>
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse2/config.d/macros.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse2/config.d/macros.xml
new file mode 100644
index 000000000000..a114a9ce4ab1
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse2/config.d/macros.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0"?>
+<yandex>
+    <macros>
+        <replica>clickhouse2</replica>
+        <shard>01</shard>
+        <shard2>02</shard2>
+    </macros>
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/clickhouse3/config.d/macros.xml b/tests/testflows/ldap/role_mapping/configs/clickhouse3/config.d/macros.xml
new file mode 100644
index 000000000000..904a27b01723
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/clickhouse3/config.d/macros.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0"?>
+<yandex>
+    <macros>
+        <replica>clickhouse3</replica>
+        <shard>01</shard>
+        <shard2>03</shard2>
+    </macros>
+</yandex>
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap1/config/export.ldif b/tests/testflows/ldap/role_mapping/configs/ldap1/config/export.ldif
new file mode 100644
index 000000000000..621dd32ca0c0
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap1/config/export.ldif
@@ -0,0 +1,64 @@
+# LDIF Export for dc=company,dc=com
+# Server: openldap (openldap)
+# Search Scope: sub
+# Search Filter: (objectClass=*)
+# Total Entries: 7
+#
+# Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on May 22, 2020 5:51 pm
+# Version: 1.2.5
+
+# Entry 1: dc=company,dc=com
+#dn: dc=company,dc=com
+#dc: company
+#o: company
+#objectclass: top
+#objectclass: dcObject
+#objectclass: organization
+
+# Entry 2: cn=admin,dc=company,dc=com
+#dn: cn=admin,dc=company,dc=com
+#cn: admin
+#description: LDAP administrator
+#objectclass: simpleSecurityObject
+#objectclass: organizationalRole
+#userpassword: {SSHA}eUEupkQCTvq9SkrxfWGSe5rX+orrjVbF
+
+# Entry 3: ou=groups,dc=company,dc=com
+dn: ou=groups,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: groups
+
+# Entry 4: cn=admin,ou=groups,dc=company,dc=com
+dn: cn=admin,ou=groups,dc=company,dc=com
+cn: admin
+gidnumber: 500
+objectclass: posixGroup
+objectclass: top
+
+# Entry 5: cn=users,ou=groups,dc=company,dc=com
+dn: cn=users,ou=groups,dc=company,dc=com
+cn: users
+gidnumber: 501
+objectclass: posixGroup
+objectclass: top
+
+# Entry 6: ou=users,dc=company,dc=com
+dn: ou=users,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: users
+
+# Entry 7: cn=user1,ou=users,dc=company,dc=com
+dn: cn=user1,ou=users,dc=company,dc=com
+cn: user1
+gidnumber: 501
+givenname: John
+homedirectory: /home/users/user1
+objectclass: inetOrgPerson
+objectclass: posixAccount
+objectclass: top
+sn: User
+uid: user1
+uidnumber: 1101
+userpassword: user1
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ca.crt b/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ca.crt
new file mode 100644
index 000000000000..8c71e3afc91d
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ca.crt
@@ -0,0 +1,22 @@
+-----BEGIN CERTIFICATE-----
+MIIDlTCCAn2gAwIBAgIUJBqw2dHM2DDCZjYSkPOESlvDH6swDQYJKoZIhvcNAQEL
+BQAwWjELMAkGA1UEBhMCQ0ExCzAJBgNVBAgMAk9OMQ8wDQYDVQQHDAZPdHRhd2Ex
+ETAPBgNVBAoMCEFsdGluaXR5MQswCQYDVQQLDAJRQTENMAsGA1UEAwwEcm9vdDAe
+Fw0yMDA2MTExOTAzNDhaFw0zMDA2MDkxOTAzNDhaMFoxCzAJBgNVBAYTAkNBMQsw
+CQYDVQQIDAJPTjEPMA0GA1UEBwwGT3R0YXdhMREwDwYDVQQKDAhBbHRpbml0eTEL
+MAkGA1UECwwCUUExDTALBgNVBAMMBHJvb3QwggEiMA0GCSqGSIb3DQEBAQUAA4IB
+DwAwggEKAoIBAQC9Irr0zGV+HCI2fZ0ht4hR5It4Sbjz4RwZV8ENRP/+TEz8l9eK
+J6ygxhKX7SMYzIs/jS9Gsq4plX1r2ujW1qRf8yLpR4+dGLP+jBRi1drj0XjZXosT
+SERjWzgPauWxL9LN8+l26eBAqz6fw5e0W8WRSTgf5iGiCcKOTmaATIUjP0CdfWKK
+qpktI4vhe++CXZFJ3usR+8KZ/FwwbCLJM/3J2HnbcXfcaYPYvr1tfqLudKSTbG9H
+M3+AVwjctdesc/0sbd51Zsm0ClQptMbuKnDCYauGg61kNkgbgPgRmH9Pzo67DtxF
+/WW+PtOzq8xLOifciQ9Piboy9QBSQZGwf4wzAgMBAAGjUzBRMB0GA1UdDgQWBBSi
+njya0RDozx3OZTLYFpwqYnlpIDAfBgNVHSMEGDAWgBSinjya0RDozx3OZTLYFpwq
+YnlpIDAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBAD7VyFg7F
+U1C25KFvtauchAOjCW6w7U/b3z1dVZvcQ88/kH1VsLUcfGixlSilUEfPTJsi7OA0
+R5BQdh2GGcjUJv4iqEFGU05KvMVmRRKn08P62+ZhJxKMxG26VzcliRZzCMkI6d0W
+lFwI6nM45yeqdHVh5k4xbuJzqpbD9BtXXLI+/Ra9Fx8S9ETA3GdidpZLU5P1VLxq
+UuedfqyAVWZXpr6TAURGxouRmRzul9yFzbSUex+MLEIPrstjtEwV3+tBQZJz9xAS
+TVPj+Nv3LO7GCq54bdwkq1ioWbSL2hEmABkj6kdW/JwmfhGHf/2rirDVMzrTYw07
+dFJfAZC+FEsv
+-----END CERTIFICATE-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap2/certs/dhparam.pem b/tests/testflows/ldap/role_mapping/configs/ldap2/certs/dhparam.pem
new file mode 100644
index 000000000000..0a96faffd627
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap2/certs/dhparam.pem
@@ -0,0 +1,5 @@
+-----BEGIN DH PARAMETERS-----
+MIGHAoGBAJitt2hhnpDViQ5ko2ipBMdjy+bZ6FR/WdZ987R7lQvBkKehPXmxtEyV
+AO6ofv5CZSDJokc5bUeBOAtg0EhMTCH82uPdwQvt58jRXcxXBg4JTjkx+oW9LBv2
+FdZsbaX8+SYivmiZ0Jp8T/HBm/4DA9VBS0O5GFRS4C7dHhmSTPfDAgEC
+-----END DH PARAMETERS-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ldap.crt b/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ldap.crt
new file mode 100644
index 000000000000..9167cbf861d0
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ldap.crt
@@ -0,0 +1,20 @@
+-----BEGIN CERTIFICATE-----
+MIIDQDCCAigCFCJ7El0ntrGktZVTYTZd+OwtcJjBMA0GCSqGSIb3DQEBCwUAMFox
+CzAJBgNVBAYTAkNBMQswCQYDVQQIDAJPTjEPMA0GA1UEBwwGT3R0YXdhMREwDwYD
+VQQKDAhBbHRpbml0eTELMAkGA1UECwwCUUExDTALBgNVBAMMBHJvb3QwHhcNMjAw
+NjExMTkxMTQzWhcNMzAwNjA5MTkxMTQzWjBfMQswCQYDVQQGEwJDQTELMAkGA1UE
+CAwCT04xDzANBgNVBAcMBk90dGF3YTERMA8GA1UECgwIQWx0aW5pdHkxCzAJBgNV
+BAsMAlFBMRIwEAYDVQQDDAlvcGVubGRhcDIwggEiMA0GCSqGSIb3DQEBAQUAA4IB
+DwAwggEKAoIBAQC0Mbn//U56URavMgXm82FWP6vBdKuRydFX/L0M5XLlnAtk/IXG
+/T+4t7nOBJxWmTp/xpsPtSMALE4eFJpEUEqlpVbG5DfBzVWcYOWoMeRAcHWCDkzr
+PkB6I0dfF0Mm5hoaDhn+ZXjBWvoh/IlJdAnPg5mlejflJBQ7xtFC9eN6WjldXuRO
+vyntGNuMfVLgITHwXuH2yZ98G0mFO6TU/9dRY/Z3D6RTSzKdb17Yk/VnG+ry92u2
+0sgXIBvhuJuC3ksWLArwwFoMl8DVa05D4O2H76goGdCcQ0KzqBV8RPXAh3UcgP2e
+Zu90p2EGIhIk+sZTCkPd4dorxjL9nkRR86HdAgMBAAEwDQYJKoZIhvcNAQELBQAD
+ggEBAJWiCxJaTksv/BTsh/etxlDY5eHwqStqIuiovEQ8bhGAcKJ3bfWd/YTb8DUS
+hrLvXrXdOVC+U8PqPFXBpdOqcm5Dc233z52VgUCb+0EKv3lAzgKXRIo32h52skdK
+NnRrCHDeDzgfEIXR4MEJ99cLEaxWyXQhremmTYWHYznry9/4NYz40gCDxHn9dJAi
+KxFyDNxhtuKs58zp4PrBoo+542JurAoLPtRGOhdXpU2RkQVU/ho38HsAXDStAB5D
+vAoSxPuMHKgo17ffrb0oqU3didwaA9fIsz7Mr6RxmI7X03s7hLzNBq9FCqu0U3RR
+CX4zWGFNJu/ieSGVWLYKQzbYxp8=
+-----END CERTIFICATE-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ldap.csr b/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ldap.csr
new file mode 100644
index 000000000000..bf569f727d63
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ldap.csr
@@ -0,0 +1,17 @@
+-----BEGIN CERTIFICATE REQUEST-----
+MIICpDCCAYwCAQAwXzELMAkGA1UEBhMCQ0ExCzAJBgNVBAgMAk9OMQ8wDQYDVQQH
+DAZPdHRhd2ExETAPBgNVBAoMCEFsdGluaXR5MQswCQYDVQQLDAJRQTESMBAGA1UE
+AwwJb3BlbmxkYXAyMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtDG5
+//1OelEWrzIF5vNhVj+rwXSrkcnRV/y9DOVy5ZwLZPyFxv0/uLe5zgScVpk6f8ab
+D7UjACxOHhSaRFBKpaVWxuQ3wc1VnGDlqDHkQHB1gg5M6z5AeiNHXxdDJuYaGg4Z
+/mV4wVr6IfyJSXQJz4OZpXo35SQUO8bRQvXjelo5XV7kTr8p7RjbjH1S4CEx8F7h
+9smffBtJhTuk1P/XUWP2dw+kU0synW9e2JP1Zxvq8vdrttLIFyAb4bibgt5LFiwK
+8MBaDJfA1WtOQ+Dth++oKBnQnENCs6gVfET1wId1HID9nmbvdKdhBiISJPrGUwpD
+3eHaK8Yy/Z5EUfOh3QIDAQABoAAwDQYJKoZIhvcNAQELBQADggEBAEzIjZQOT5R7
+mEJg+RFpCSIoPn3xJ4/VMMyWqA3bTGZKpb4S6GxgsierY/87kPL7jZrMdGYB4Dc3
+2M3VWZGXlYo8vctH1zLE9VW6CzosUpl20lhdgydoCMz3RQqdJyK8aGeFTeLtk7G/
+TRCCUFUE6jaA+VtaCPCnOJSff3jUf76xguEu7dgTZgCKV7dtBqald8gIzF3D+AJJ
+7pEN2UrC3UR0xpe2cj2GhndQJ+WsIyft3zpNFzAO13j8ZPibuVP7oDWcW3ixNCWC
+213aeRVplJGof8Eo6llDxP+6Fwp1YmOoQmwB1Xm3t4ADn7FLJ14LONLB7q40KviG
+RyLyqu3IVOI=
+-----END CERTIFICATE REQUEST-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ldap.key b/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ldap.key
new file mode 100644
index 000000000000..5ab3a3f8b590
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap2/certs/ldap.key
@@ -0,0 +1,27 @@
+-----BEGIN RSA PRIVATE KEY-----
+MIIEogIBAAKCAQEAtDG5//1OelEWrzIF5vNhVj+rwXSrkcnRV/y9DOVy5ZwLZPyF
+xv0/uLe5zgScVpk6f8abD7UjACxOHhSaRFBKpaVWxuQ3wc1VnGDlqDHkQHB1gg5M
+6z5AeiNHXxdDJuYaGg4Z/mV4wVr6IfyJSXQJz4OZpXo35SQUO8bRQvXjelo5XV7k
+Tr8p7RjbjH1S4CEx8F7h9smffBtJhTuk1P/XUWP2dw+kU0synW9e2JP1Zxvq8vdr
+ttLIFyAb4bibgt5LFiwK8MBaDJfA1WtOQ+Dth++oKBnQnENCs6gVfET1wId1HID9
+nmbvdKdhBiISJPrGUwpD3eHaK8Yy/Z5EUfOh3QIDAQABAoIBADugMMIKWcuTxYPX
+c6iGZHEbxIPRTWyCcalB0nTQAAMGbabPAJ1l8432DZ+kWu806OybFXhPIfPOtVKy
+0pFEWE8TtPE/V0vj3C5Qye2sBLFmBRwyCzXUdZV00wseMXRPs9dnTyalAR5KMnbI
+j80kfpKSI2dkV9aU57UYBuq3Xrx/TCGItwL769D4ZZW9BvbpiTZApQQFZ0gwUFFn
+btPXGU9Ti8H4mfBuZWL+5CaZdqOo76+CXvMPaUK0F9MJp4yX3XxQLRNH3qz/Tyn7
+h7QOOo0XTqoUmzRw0N9QRVH5LRdSE5yq3aF9aFKjNW59exz+62pufOFadngzkpkn
+OKCzgWkCgYEA4mOWWMzdYwMn3GtfG7whqlqy7wOmMkNb81zTDQejHBV98dnj0AHr
+deurfKWzHrAh3DXo6tFeqUIgXabhBPS/0dEx/S5sgLFmuUZP05EUYahfWBgzzmM9
+C6Oe5xIMLzxsZCJczolsfkEsoFe4o0vkvuLYoQrQL7InzewcDy8cUxsCgYEAy8Na
+YCnanSNDY03Bulcni+5sF+opaHseeki1pv3nlw8TwsWuZF9ApS+yL7ck9jJjxBRR
+RC3KGmpoqIr0vTmUYS946ngQWXPE90zfuhJfM+NRv/q0oCjH0qAcxRbTkls5On9v
+oxJ8rO7gD6K85eHqasWdbCVzdZrobOXzay37tmcCgYBfyUUmw190cjReZauzH3Gb
+E48b5A5gu/Fe0cqWe8G+szU7rDZgnz9SAGnpbm6QMHPTKZgoKngD42+wUFhq8Wdr
+zjh5aDgOZ4EQKTjDSmI2Q7g7nNnmnESK9SrZl+BB6C3wXD2qQaj+7nKEUTlVFlpt
+jaucz+dwFtASp7Djl8pDOwKBgEtr2c3ycArt/ImLRIP2spqm+7e2YvFbcSKOOz6+
+iLRvTj8v8KcSYtlB2FC1F6dRa4AujQ4RbNduP6LzHDfWUkfOzJDtNBAIPAXVnJJB
+LqAEKkRHRghqT9x0i3GgS1vHDF3MwcO4mhFgserXr9ffUWeIEgbvrdcAKbv1Oa6Y
+bK1NAoGAGPm8ISmboDJynjBl9wMrkcy23Pwg9kmyocdWUHh0zMLDKriZNKYB6u/U
+C+/RTfkohPoHPzkeqWiHp7z3JhMItYUfTkNW6vMCxEGc0NEN6ZyMIjtiDPGN1n6O
+E7jmODFmj1AQICQGdV5SHp+yKvKyb0YHKyDwETbs4SZBXxVvjEw=
+-----END RSA PRIVATE KEY-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap2/config/export.ldif b/tests/testflows/ldap/role_mapping/configs/ldap2/config/export.ldif
new file mode 100644
index 000000000000..6766aaae6f10
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap2/config/export.ldif
@@ -0,0 +1,64 @@
+# LDIF Export for dc=company,dc=com
+# Server: openldap (openldap)
+# Search Scope: sub
+# Search Filter: (objectClass=*)
+# Total Entries: 7
+#
+# Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on May 22, 2020 5:51 pm
+# Version: 1.2.5
+
+# Entry 1: dc=company,dc=com
+#dn: dc=company,dc=com
+#dc: company
+#o: company
+#objectclass: top
+#objectclass: dcObject
+#objectclass: organization
+
+# Entry 2: cn=admin,dc=company,dc=com
+#dn: cn=admin,dc=company,dc=com
+#cn: admin
+#description: LDAP administrator
+#objectclass: simpleSecurityObject
+#objectclass: organizationalRole
+#userpassword: {SSHA}eUEupkQCTvq9SkrxfWGSe5rX+orrjVbF
+
+# Entry 3: ou=groups,dc=company,dc=com
+dn: ou=groups,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: groups
+
+# Entry 4: cn=admin,ou=groups,dc=company,dc=com
+dn: cn=admin,ou=groups,dc=company,dc=com
+cn: admin
+gidnumber: 500
+objectclass: posixGroup
+objectclass: top
+
+# Entry 5: cn=users,ou=groups,dc=company,dc=com
+dn: cn=users,ou=groups,dc=company,dc=com
+cn: users
+gidnumber: 501
+objectclass: posixGroup
+objectclass: top
+
+# Entry 6: ou=users,dc=company,dc=com
+dn: ou=users,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: users
+
+# Entry 7: cn=user2,ou=users,dc=company,dc=com
+dn: cn=user2,ou=users,dc=company,dc=com
+cn: user2
+gidnumber: 501
+givenname: John
+homedirectory: /home/users/user2
+objectclass: inetOrgPerson
+objectclass: posixAccount
+objectclass: top
+sn: User
+uid: user2
+uidnumber: 1002
+userpassword: user2
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ca.crt b/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ca.crt
new file mode 100644
index 000000000000..8c71e3afc91d
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ca.crt
@@ -0,0 +1,22 @@
+-----BEGIN CERTIFICATE-----
+MIIDlTCCAn2gAwIBAgIUJBqw2dHM2DDCZjYSkPOESlvDH6swDQYJKoZIhvcNAQEL
+BQAwWjELMAkGA1UEBhMCQ0ExCzAJBgNVBAgMAk9OMQ8wDQYDVQQHDAZPdHRhd2Ex
+ETAPBgNVBAoMCEFsdGluaXR5MQswCQYDVQQLDAJRQTENMAsGA1UEAwwEcm9vdDAe
+Fw0yMDA2MTExOTAzNDhaFw0zMDA2MDkxOTAzNDhaMFoxCzAJBgNVBAYTAkNBMQsw
+CQYDVQQIDAJPTjEPMA0GA1UEBwwGT3R0YXdhMREwDwYDVQQKDAhBbHRpbml0eTEL
+MAkGA1UECwwCUUExDTALBgNVBAMMBHJvb3QwggEiMA0GCSqGSIb3DQEBAQUAA4IB
+DwAwggEKAoIBAQC9Irr0zGV+HCI2fZ0ht4hR5It4Sbjz4RwZV8ENRP/+TEz8l9eK
+J6ygxhKX7SMYzIs/jS9Gsq4plX1r2ujW1qRf8yLpR4+dGLP+jBRi1drj0XjZXosT
+SERjWzgPauWxL9LN8+l26eBAqz6fw5e0W8WRSTgf5iGiCcKOTmaATIUjP0CdfWKK
+qpktI4vhe++CXZFJ3usR+8KZ/FwwbCLJM/3J2HnbcXfcaYPYvr1tfqLudKSTbG9H
+M3+AVwjctdesc/0sbd51Zsm0ClQptMbuKnDCYauGg61kNkgbgPgRmH9Pzo67DtxF
+/WW+PtOzq8xLOifciQ9Piboy9QBSQZGwf4wzAgMBAAGjUzBRMB0GA1UdDgQWBBSi
+njya0RDozx3OZTLYFpwqYnlpIDAfBgNVHSMEGDAWgBSinjya0RDozx3OZTLYFpwq
+YnlpIDAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBAD7VyFg7F
+U1C25KFvtauchAOjCW6w7U/b3z1dVZvcQ88/kH1VsLUcfGixlSilUEfPTJsi7OA0
+R5BQdh2GGcjUJv4iqEFGU05KvMVmRRKn08P62+ZhJxKMxG26VzcliRZzCMkI6d0W
+lFwI6nM45yeqdHVh5k4xbuJzqpbD9BtXXLI+/Ra9Fx8S9ETA3GdidpZLU5P1VLxq
+UuedfqyAVWZXpr6TAURGxouRmRzul9yFzbSUex+MLEIPrstjtEwV3+tBQZJz9xAS
+TVPj+Nv3LO7GCq54bdwkq1ioWbSL2hEmABkj6kdW/JwmfhGHf/2rirDVMzrTYw07
+dFJfAZC+FEsv
+-----END CERTIFICATE-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap3/certs/dhparam.pem b/tests/testflows/ldap/role_mapping/configs/ldap3/certs/dhparam.pem
new file mode 100644
index 000000000000..0a96faffd627
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap3/certs/dhparam.pem
@@ -0,0 +1,5 @@
+-----BEGIN DH PARAMETERS-----
+MIGHAoGBAJitt2hhnpDViQ5ko2ipBMdjy+bZ6FR/WdZ987R7lQvBkKehPXmxtEyV
+AO6ofv5CZSDJokc5bUeBOAtg0EhMTCH82uPdwQvt58jRXcxXBg4JTjkx+oW9LBv2
+FdZsbaX8+SYivmiZ0Jp8T/HBm/4DA9VBS0O5GFRS4C7dHhmSTPfDAgEC
+-----END DH PARAMETERS-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ldap.crt b/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ldap.crt
new file mode 100644
index 000000000000..9167cbf861d0
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ldap.crt
@@ -0,0 +1,20 @@
+-----BEGIN CERTIFICATE-----
+MIIDQDCCAigCFCJ7El0ntrGktZVTYTZd+OwtcJjBMA0GCSqGSIb3DQEBCwUAMFox
+CzAJBgNVBAYTAkNBMQswCQYDVQQIDAJPTjEPMA0GA1UEBwwGT3R0YXdhMREwDwYD
+VQQKDAhBbHRpbml0eTELMAkGA1UECwwCUUExDTALBgNVBAMMBHJvb3QwHhcNMjAw
+NjExMTkxMTQzWhcNMzAwNjA5MTkxMTQzWjBfMQswCQYDVQQGEwJDQTELMAkGA1UE
+CAwCT04xDzANBgNVBAcMBk90dGF3YTERMA8GA1UECgwIQWx0aW5pdHkxCzAJBgNV
+BAsMAlFBMRIwEAYDVQQDDAlvcGVubGRhcDIwggEiMA0GCSqGSIb3DQEBAQUAA4IB
+DwAwggEKAoIBAQC0Mbn//U56URavMgXm82FWP6vBdKuRydFX/L0M5XLlnAtk/IXG
+/T+4t7nOBJxWmTp/xpsPtSMALE4eFJpEUEqlpVbG5DfBzVWcYOWoMeRAcHWCDkzr
+PkB6I0dfF0Mm5hoaDhn+ZXjBWvoh/IlJdAnPg5mlejflJBQ7xtFC9eN6WjldXuRO
+vyntGNuMfVLgITHwXuH2yZ98G0mFO6TU/9dRY/Z3D6RTSzKdb17Yk/VnG+ry92u2
+0sgXIBvhuJuC3ksWLArwwFoMl8DVa05D4O2H76goGdCcQ0KzqBV8RPXAh3UcgP2e
+Zu90p2EGIhIk+sZTCkPd4dorxjL9nkRR86HdAgMBAAEwDQYJKoZIhvcNAQELBQAD
+ggEBAJWiCxJaTksv/BTsh/etxlDY5eHwqStqIuiovEQ8bhGAcKJ3bfWd/YTb8DUS
+hrLvXrXdOVC+U8PqPFXBpdOqcm5Dc233z52VgUCb+0EKv3lAzgKXRIo32h52skdK
+NnRrCHDeDzgfEIXR4MEJ99cLEaxWyXQhremmTYWHYznry9/4NYz40gCDxHn9dJAi
+KxFyDNxhtuKs58zp4PrBoo+542JurAoLPtRGOhdXpU2RkQVU/ho38HsAXDStAB5D
+vAoSxPuMHKgo17ffrb0oqU3didwaA9fIsz7Mr6RxmI7X03s7hLzNBq9FCqu0U3RR
+CX4zWGFNJu/ieSGVWLYKQzbYxp8=
+-----END CERTIFICATE-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ldap.csr b/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ldap.csr
new file mode 100644
index 000000000000..bf569f727d63
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ldap.csr
@@ -0,0 +1,17 @@
+-----BEGIN CERTIFICATE REQUEST-----
+MIICpDCCAYwCAQAwXzELMAkGA1UEBhMCQ0ExCzAJBgNVBAgMAk9OMQ8wDQYDVQQH
+DAZPdHRhd2ExETAPBgNVBAoMCEFsdGluaXR5MQswCQYDVQQLDAJRQTESMBAGA1UE
+AwwJb3BlbmxkYXAyMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtDG5
+//1OelEWrzIF5vNhVj+rwXSrkcnRV/y9DOVy5ZwLZPyFxv0/uLe5zgScVpk6f8ab
+D7UjACxOHhSaRFBKpaVWxuQ3wc1VnGDlqDHkQHB1gg5M6z5AeiNHXxdDJuYaGg4Z
+/mV4wVr6IfyJSXQJz4OZpXo35SQUO8bRQvXjelo5XV7kTr8p7RjbjH1S4CEx8F7h
+9smffBtJhTuk1P/XUWP2dw+kU0synW9e2JP1Zxvq8vdrttLIFyAb4bibgt5LFiwK
+8MBaDJfA1WtOQ+Dth++oKBnQnENCs6gVfET1wId1HID9nmbvdKdhBiISJPrGUwpD
+3eHaK8Yy/Z5EUfOh3QIDAQABoAAwDQYJKoZIhvcNAQELBQADggEBAEzIjZQOT5R7
+mEJg+RFpCSIoPn3xJ4/VMMyWqA3bTGZKpb4S6GxgsierY/87kPL7jZrMdGYB4Dc3
+2M3VWZGXlYo8vctH1zLE9VW6CzosUpl20lhdgydoCMz3RQqdJyK8aGeFTeLtk7G/
+TRCCUFUE6jaA+VtaCPCnOJSff3jUf76xguEu7dgTZgCKV7dtBqald8gIzF3D+AJJ
+7pEN2UrC3UR0xpe2cj2GhndQJ+WsIyft3zpNFzAO13j8ZPibuVP7oDWcW3ixNCWC
+213aeRVplJGof8Eo6llDxP+6Fwp1YmOoQmwB1Xm3t4ADn7FLJ14LONLB7q40KviG
+RyLyqu3IVOI=
+-----END CERTIFICATE REQUEST-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ldap.key b/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ldap.key
new file mode 100644
index 000000000000..5ab3a3f8b590
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap3/certs/ldap.key
@@ -0,0 +1,27 @@
+-----BEGIN RSA PRIVATE KEY-----
+MIIEogIBAAKCAQEAtDG5//1OelEWrzIF5vNhVj+rwXSrkcnRV/y9DOVy5ZwLZPyF
+xv0/uLe5zgScVpk6f8abD7UjACxOHhSaRFBKpaVWxuQ3wc1VnGDlqDHkQHB1gg5M
+6z5AeiNHXxdDJuYaGg4Z/mV4wVr6IfyJSXQJz4OZpXo35SQUO8bRQvXjelo5XV7k
+Tr8p7RjbjH1S4CEx8F7h9smffBtJhTuk1P/XUWP2dw+kU0synW9e2JP1Zxvq8vdr
+ttLIFyAb4bibgt5LFiwK8MBaDJfA1WtOQ+Dth++oKBnQnENCs6gVfET1wId1HID9
+nmbvdKdhBiISJPrGUwpD3eHaK8Yy/Z5EUfOh3QIDAQABAoIBADugMMIKWcuTxYPX
+c6iGZHEbxIPRTWyCcalB0nTQAAMGbabPAJ1l8432DZ+kWu806OybFXhPIfPOtVKy
+0pFEWE8TtPE/V0vj3C5Qye2sBLFmBRwyCzXUdZV00wseMXRPs9dnTyalAR5KMnbI
+j80kfpKSI2dkV9aU57UYBuq3Xrx/TCGItwL769D4ZZW9BvbpiTZApQQFZ0gwUFFn
+btPXGU9Ti8H4mfBuZWL+5CaZdqOo76+CXvMPaUK0F9MJp4yX3XxQLRNH3qz/Tyn7
+h7QOOo0XTqoUmzRw0N9QRVH5LRdSE5yq3aF9aFKjNW59exz+62pufOFadngzkpkn
+OKCzgWkCgYEA4mOWWMzdYwMn3GtfG7whqlqy7wOmMkNb81zTDQejHBV98dnj0AHr
+deurfKWzHrAh3DXo6tFeqUIgXabhBPS/0dEx/S5sgLFmuUZP05EUYahfWBgzzmM9
+C6Oe5xIMLzxsZCJczolsfkEsoFe4o0vkvuLYoQrQL7InzewcDy8cUxsCgYEAy8Na
+YCnanSNDY03Bulcni+5sF+opaHseeki1pv3nlw8TwsWuZF9ApS+yL7ck9jJjxBRR
+RC3KGmpoqIr0vTmUYS946ngQWXPE90zfuhJfM+NRv/q0oCjH0qAcxRbTkls5On9v
+oxJ8rO7gD6K85eHqasWdbCVzdZrobOXzay37tmcCgYBfyUUmw190cjReZauzH3Gb
+E48b5A5gu/Fe0cqWe8G+szU7rDZgnz9SAGnpbm6QMHPTKZgoKngD42+wUFhq8Wdr
+zjh5aDgOZ4EQKTjDSmI2Q7g7nNnmnESK9SrZl+BB6C3wXD2qQaj+7nKEUTlVFlpt
+jaucz+dwFtASp7Djl8pDOwKBgEtr2c3ycArt/ImLRIP2spqm+7e2YvFbcSKOOz6+
+iLRvTj8v8KcSYtlB2FC1F6dRa4AujQ4RbNduP6LzHDfWUkfOzJDtNBAIPAXVnJJB
+LqAEKkRHRghqT9x0i3GgS1vHDF3MwcO4mhFgserXr9ffUWeIEgbvrdcAKbv1Oa6Y
+bK1NAoGAGPm8ISmboDJynjBl9wMrkcy23Pwg9kmyocdWUHh0zMLDKriZNKYB6u/U
+C+/RTfkohPoHPzkeqWiHp7z3JhMItYUfTkNW6vMCxEGc0NEN6ZyMIjtiDPGN1n6O
+E7jmODFmj1AQICQGdV5SHp+yKvKyb0YHKyDwETbs4SZBXxVvjEw=
+-----END RSA PRIVATE KEY-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap3/config/export.ldif b/tests/testflows/ldap/role_mapping/configs/ldap3/config/export.ldif
new file mode 100644
index 000000000000..6ac9a995efd0
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap3/config/export.ldif
@@ -0,0 +1,64 @@
+# LDIF Export for dc=company,dc=com
+# Server: openldap (openldap)
+# Search Scope: sub
+# Search Filter: (objectClass=*)
+# Total Entries: 7
+#
+# Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on May 22, 2020 5:51 pm
+# Version: 1.2.5
+
+# Entry 1: dc=company,dc=com
+#dn: dc=company,dc=com
+#dc: company
+#o: company
+#objectclass: top
+#objectclass: dcObject
+#objectclass: organization
+
+# Entry 2: cn=admin,dc=company,dc=com
+#dn: cn=admin,dc=company,dc=com
+#cn: admin
+#description: LDAP administrator
+#objectclass: simpleSecurityObject
+#objectclass: organizationalRole
+#userpassword: {SSHA}eUEupkQCTvq9SkrxfWGSe5rX+orrjVbF
+
+# Entry 3: ou=groups,dc=company,dc=com
+dn: ou=groups,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: groups
+
+# Entry 4: cn=admin,ou=groups,dc=company,dc=com
+dn: cn=admin,ou=groups,dc=company,dc=com
+cn: admin
+gidnumber: 500
+objectclass: posixGroup
+objectclass: top
+
+# Entry 5: cn=users,ou=groups,dc=company,dc=com
+dn: cn=users,ou=groups,dc=company,dc=com
+cn: users
+gidnumber: 501
+objectclass: posixGroup
+objectclass: top
+
+# Entry 6: ou=users,dc=company,dc=com
+dn: ou=users,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: users
+
+# Entry 7: cn=user3,ou=users,dc=company,dc=com
+dn: cn=user3,ou=users,dc=company,dc=com
+cn: user3
+gidnumber: 501
+givenname: John
+homedirectory: /home/users/user3
+objectclass: inetOrgPerson
+objectclass: posixAccount
+objectclass: top
+sn: User
+uid: user3
+uidnumber: 1003
+userpassword: user3
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ca.crt b/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ca.crt
new file mode 100644
index 000000000000..8c71e3afc91d
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ca.crt
@@ -0,0 +1,22 @@
+-----BEGIN CERTIFICATE-----
+MIIDlTCCAn2gAwIBAgIUJBqw2dHM2DDCZjYSkPOESlvDH6swDQYJKoZIhvcNAQEL
+BQAwWjELMAkGA1UEBhMCQ0ExCzAJBgNVBAgMAk9OMQ8wDQYDVQQHDAZPdHRhd2Ex
+ETAPBgNVBAoMCEFsdGluaXR5MQswCQYDVQQLDAJRQTENMAsGA1UEAwwEcm9vdDAe
+Fw0yMDA2MTExOTAzNDhaFw0zMDA2MDkxOTAzNDhaMFoxCzAJBgNVBAYTAkNBMQsw
+CQYDVQQIDAJPTjEPMA0GA1UEBwwGT3R0YXdhMREwDwYDVQQKDAhBbHRpbml0eTEL
+MAkGA1UECwwCUUExDTALBgNVBAMMBHJvb3QwggEiMA0GCSqGSIb3DQEBAQUAA4IB
+DwAwggEKAoIBAQC9Irr0zGV+HCI2fZ0ht4hR5It4Sbjz4RwZV8ENRP/+TEz8l9eK
+J6ygxhKX7SMYzIs/jS9Gsq4plX1r2ujW1qRf8yLpR4+dGLP+jBRi1drj0XjZXosT
+SERjWzgPauWxL9LN8+l26eBAqz6fw5e0W8WRSTgf5iGiCcKOTmaATIUjP0CdfWKK
+qpktI4vhe++CXZFJ3usR+8KZ/FwwbCLJM/3J2HnbcXfcaYPYvr1tfqLudKSTbG9H
+M3+AVwjctdesc/0sbd51Zsm0ClQptMbuKnDCYauGg61kNkgbgPgRmH9Pzo67DtxF
+/WW+PtOzq8xLOifciQ9Piboy9QBSQZGwf4wzAgMBAAGjUzBRMB0GA1UdDgQWBBSi
+njya0RDozx3OZTLYFpwqYnlpIDAfBgNVHSMEGDAWgBSinjya0RDozx3OZTLYFpwq
+YnlpIDAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBAD7VyFg7F
+U1C25KFvtauchAOjCW6w7U/b3z1dVZvcQ88/kH1VsLUcfGixlSilUEfPTJsi7OA0
+R5BQdh2GGcjUJv4iqEFGU05KvMVmRRKn08P62+ZhJxKMxG26VzcliRZzCMkI6d0W
+lFwI6nM45yeqdHVh5k4xbuJzqpbD9BtXXLI+/Ra9Fx8S9ETA3GdidpZLU5P1VLxq
+UuedfqyAVWZXpr6TAURGxouRmRzul9yFzbSUex+MLEIPrstjtEwV3+tBQZJz9xAS
+TVPj+Nv3LO7GCq54bdwkq1ioWbSL2hEmABkj6kdW/JwmfhGHf/2rirDVMzrTYw07
+dFJfAZC+FEsv
+-----END CERTIFICATE-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap4/certs/dhparam.pem b/tests/testflows/ldap/role_mapping/configs/ldap4/certs/dhparam.pem
new file mode 100644
index 000000000000..0a96faffd627
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap4/certs/dhparam.pem
@@ -0,0 +1,5 @@
+-----BEGIN DH PARAMETERS-----
+MIGHAoGBAJitt2hhnpDViQ5ko2ipBMdjy+bZ6FR/WdZ987R7lQvBkKehPXmxtEyV
+AO6ofv5CZSDJokc5bUeBOAtg0EhMTCH82uPdwQvt58jRXcxXBg4JTjkx+oW9LBv2
+FdZsbaX8+SYivmiZ0Jp8T/HBm/4DA9VBS0O5GFRS4C7dHhmSTPfDAgEC
+-----END DH PARAMETERS-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ldap.crt b/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ldap.crt
new file mode 100644
index 000000000000..9167cbf861d0
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ldap.crt
@@ -0,0 +1,20 @@
+-----BEGIN CERTIFICATE-----
+MIIDQDCCAigCFCJ7El0ntrGktZVTYTZd+OwtcJjBMA0GCSqGSIb3DQEBCwUAMFox
+CzAJBgNVBAYTAkNBMQswCQYDVQQIDAJPTjEPMA0GA1UEBwwGT3R0YXdhMREwDwYD
+VQQKDAhBbHRpbml0eTELMAkGA1UECwwCUUExDTALBgNVBAMMBHJvb3QwHhcNMjAw
+NjExMTkxMTQzWhcNMzAwNjA5MTkxMTQzWjBfMQswCQYDVQQGEwJDQTELMAkGA1UE
+CAwCT04xDzANBgNVBAcMBk90dGF3YTERMA8GA1UECgwIQWx0aW5pdHkxCzAJBgNV
+BAsMAlFBMRIwEAYDVQQDDAlvcGVubGRhcDIwggEiMA0GCSqGSIb3DQEBAQUAA4IB
+DwAwggEKAoIBAQC0Mbn//U56URavMgXm82FWP6vBdKuRydFX/L0M5XLlnAtk/IXG
+/T+4t7nOBJxWmTp/xpsPtSMALE4eFJpEUEqlpVbG5DfBzVWcYOWoMeRAcHWCDkzr
+PkB6I0dfF0Mm5hoaDhn+ZXjBWvoh/IlJdAnPg5mlejflJBQ7xtFC9eN6WjldXuRO
+vyntGNuMfVLgITHwXuH2yZ98G0mFO6TU/9dRY/Z3D6RTSzKdb17Yk/VnG+ry92u2
+0sgXIBvhuJuC3ksWLArwwFoMl8DVa05D4O2H76goGdCcQ0KzqBV8RPXAh3UcgP2e
+Zu90p2EGIhIk+sZTCkPd4dorxjL9nkRR86HdAgMBAAEwDQYJKoZIhvcNAQELBQAD
+ggEBAJWiCxJaTksv/BTsh/etxlDY5eHwqStqIuiovEQ8bhGAcKJ3bfWd/YTb8DUS
+hrLvXrXdOVC+U8PqPFXBpdOqcm5Dc233z52VgUCb+0EKv3lAzgKXRIo32h52skdK
+NnRrCHDeDzgfEIXR4MEJ99cLEaxWyXQhremmTYWHYznry9/4NYz40gCDxHn9dJAi
+KxFyDNxhtuKs58zp4PrBoo+542JurAoLPtRGOhdXpU2RkQVU/ho38HsAXDStAB5D
+vAoSxPuMHKgo17ffrb0oqU3didwaA9fIsz7Mr6RxmI7X03s7hLzNBq9FCqu0U3RR
+CX4zWGFNJu/ieSGVWLYKQzbYxp8=
+-----END CERTIFICATE-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ldap.csr b/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ldap.csr
new file mode 100644
index 000000000000..bf569f727d63
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ldap.csr
@@ -0,0 +1,17 @@
+-----BEGIN CERTIFICATE REQUEST-----
+MIICpDCCAYwCAQAwXzELMAkGA1UEBhMCQ0ExCzAJBgNVBAgMAk9OMQ8wDQYDVQQH
+DAZPdHRhd2ExETAPBgNVBAoMCEFsdGluaXR5MQswCQYDVQQLDAJRQTESMBAGA1UE
+AwwJb3BlbmxkYXAyMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtDG5
+//1OelEWrzIF5vNhVj+rwXSrkcnRV/y9DOVy5ZwLZPyFxv0/uLe5zgScVpk6f8ab
+D7UjACxOHhSaRFBKpaVWxuQ3wc1VnGDlqDHkQHB1gg5M6z5AeiNHXxdDJuYaGg4Z
+/mV4wVr6IfyJSXQJz4OZpXo35SQUO8bRQvXjelo5XV7kTr8p7RjbjH1S4CEx8F7h
+9smffBtJhTuk1P/XUWP2dw+kU0synW9e2JP1Zxvq8vdrttLIFyAb4bibgt5LFiwK
+8MBaDJfA1WtOQ+Dth++oKBnQnENCs6gVfET1wId1HID9nmbvdKdhBiISJPrGUwpD
+3eHaK8Yy/Z5EUfOh3QIDAQABoAAwDQYJKoZIhvcNAQELBQADggEBAEzIjZQOT5R7
+mEJg+RFpCSIoPn3xJ4/VMMyWqA3bTGZKpb4S6GxgsierY/87kPL7jZrMdGYB4Dc3
+2M3VWZGXlYo8vctH1zLE9VW6CzosUpl20lhdgydoCMz3RQqdJyK8aGeFTeLtk7G/
+TRCCUFUE6jaA+VtaCPCnOJSff3jUf76xguEu7dgTZgCKV7dtBqald8gIzF3D+AJJ
+7pEN2UrC3UR0xpe2cj2GhndQJ+WsIyft3zpNFzAO13j8ZPibuVP7oDWcW3ixNCWC
+213aeRVplJGof8Eo6llDxP+6Fwp1YmOoQmwB1Xm3t4ADn7FLJ14LONLB7q40KviG
+RyLyqu3IVOI=
+-----END CERTIFICATE REQUEST-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ldap.key b/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ldap.key
new file mode 100644
index 000000000000..5ab3a3f8b590
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap4/certs/ldap.key
@@ -0,0 +1,27 @@
+-----BEGIN RSA PRIVATE KEY-----
+MIIEogIBAAKCAQEAtDG5//1OelEWrzIF5vNhVj+rwXSrkcnRV/y9DOVy5ZwLZPyF
+xv0/uLe5zgScVpk6f8abD7UjACxOHhSaRFBKpaVWxuQ3wc1VnGDlqDHkQHB1gg5M
+6z5AeiNHXxdDJuYaGg4Z/mV4wVr6IfyJSXQJz4OZpXo35SQUO8bRQvXjelo5XV7k
+Tr8p7RjbjH1S4CEx8F7h9smffBtJhTuk1P/XUWP2dw+kU0synW9e2JP1Zxvq8vdr
+ttLIFyAb4bibgt5LFiwK8MBaDJfA1WtOQ+Dth++oKBnQnENCs6gVfET1wId1HID9
+nmbvdKdhBiISJPrGUwpD3eHaK8Yy/Z5EUfOh3QIDAQABAoIBADugMMIKWcuTxYPX
+c6iGZHEbxIPRTWyCcalB0nTQAAMGbabPAJ1l8432DZ+kWu806OybFXhPIfPOtVKy
+0pFEWE8TtPE/V0vj3C5Qye2sBLFmBRwyCzXUdZV00wseMXRPs9dnTyalAR5KMnbI
+j80kfpKSI2dkV9aU57UYBuq3Xrx/TCGItwL769D4ZZW9BvbpiTZApQQFZ0gwUFFn
+btPXGU9Ti8H4mfBuZWL+5CaZdqOo76+CXvMPaUK0F9MJp4yX3XxQLRNH3qz/Tyn7
+h7QOOo0XTqoUmzRw0N9QRVH5LRdSE5yq3aF9aFKjNW59exz+62pufOFadngzkpkn
+OKCzgWkCgYEA4mOWWMzdYwMn3GtfG7whqlqy7wOmMkNb81zTDQejHBV98dnj0AHr
+deurfKWzHrAh3DXo6tFeqUIgXabhBPS/0dEx/S5sgLFmuUZP05EUYahfWBgzzmM9
+C6Oe5xIMLzxsZCJczolsfkEsoFe4o0vkvuLYoQrQL7InzewcDy8cUxsCgYEAy8Na
+YCnanSNDY03Bulcni+5sF+opaHseeki1pv3nlw8TwsWuZF9ApS+yL7ck9jJjxBRR
+RC3KGmpoqIr0vTmUYS946ngQWXPE90zfuhJfM+NRv/q0oCjH0qAcxRbTkls5On9v
+oxJ8rO7gD6K85eHqasWdbCVzdZrobOXzay37tmcCgYBfyUUmw190cjReZauzH3Gb
+E48b5A5gu/Fe0cqWe8G+szU7rDZgnz9SAGnpbm6QMHPTKZgoKngD42+wUFhq8Wdr
+zjh5aDgOZ4EQKTjDSmI2Q7g7nNnmnESK9SrZl+BB6C3wXD2qQaj+7nKEUTlVFlpt
+jaucz+dwFtASp7Djl8pDOwKBgEtr2c3ycArt/ImLRIP2spqm+7e2YvFbcSKOOz6+
+iLRvTj8v8KcSYtlB2FC1F6dRa4AujQ4RbNduP6LzHDfWUkfOzJDtNBAIPAXVnJJB
+LqAEKkRHRghqT9x0i3GgS1vHDF3MwcO4mhFgserXr9ffUWeIEgbvrdcAKbv1Oa6Y
+bK1NAoGAGPm8ISmboDJynjBl9wMrkcy23Pwg9kmyocdWUHh0zMLDKriZNKYB6u/U
+C+/RTfkohPoHPzkeqWiHp7z3JhMItYUfTkNW6vMCxEGc0NEN6ZyMIjtiDPGN1n6O
+E7jmODFmj1AQICQGdV5SHp+yKvKyb0YHKyDwETbs4SZBXxVvjEw=
+-----END RSA PRIVATE KEY-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap4/config/export.ldif b/tests/testflows/ldap/role_mapping/configs/ldap4/config/export.ldif
new file mode 100644
index 000000000000..36afdb4e350e
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap4/config/export.ldif
@@ -0,0 +1,64 @@
+# LDIF Export for dc=company,dc=com
+# Server: openldap (openldap)
+# Search Scope: sub
+# Search Filter: (objectClass=*)
+# Total Entries: 7
+#
+# Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on May 22, 2020 5:51 pm
+# Version: 1.2.5
+
+# Entry 1: dc=company,dc=com
+#dn: dc=company,dc=com
+#dc: company
+#o: company
+#objectclass: top
+#objectclass: dcObject
+#objectclass: organization
+
+# Entry 2: cn=admin,dc=company,dc=com
+#dn: cn=admin,dc=company,dc=com
+#cn: admin
+#description: LDAP administrator
+#objectclass: simpleSecurityObject
+#objectclass: organizationalRole
+#userpassword: {SSHA}eUEupkQCTvq9SkrxfWGSe5rX+orrjVbF
+
+# Entry 3: ou=groups,dc=company,dc=com
+dn: ou=groups,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: groups
+
+# Entry 4: cn=admin,ou=groups,dc=company,dc=com
+dn: cn=admin,ou=groups,dc=company,dc=com
+cn: admin
+gidnumber: 500
+objectclass: posixGroup
+objectclass: top
+
+# Entry 5: cn=users,ou=groups,dc=company,dc=com
+dn: cn=users,ou=groups,dc=company,dc=com
+cn: users
+gidnumber: 501
+objectclass: posixGroup
+objectclass: top
+
+# Entry 6: ou=users,dc=company,dc=com
+dn: ou=users,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: users
+
+# Entry 7: cn=user4,ou=users,dc=company,dc=com
+dn: cn=user4,ou=users,dc=company,dc=com
+cn: user4
+gidnumber: 501
+givenname: John
+homedirectory: /home/users/user4
+objectclass: inetOrgPerson
+objectclass: posixAccount
+objectclass: top
+sn: User
+uid: user4
+uidnumber: 1004
+userpassword: user4
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap5/config/export.ldif b/tests/testflows/ldap/role_mapping/configs/ldap5/config/export.ldif
new file mode 100644
index 000000000000..bc3d2ff75fc7
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap5/config/export.ldif
@@ -0,0 +1,64 @@
+# LDIF Export for dc=company,dc=com
+# Server: openldap (openldap)
+# Search Scope: sub
+# Search Filter: (objectClass=*)
+# Total Entries: 7
+#
+# Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on May 22, 2020 5:51 pm
+# Version: 1.2.5
+
+# Entry 1: dc=company,dc=com
+#dn: dc=company,dc=com
+#dc: company
+#o: company
+#objectclass: top
+#objectclass: dcObject
+#objectclass: organization
+
+# Entry 2: cn=admin,dc=company,dc=com
+#dn: cn=admin,dc=company,dc=com
+#cn: admin
+#description: LDAP administrator
+#objectclass: simpleSecurityObject
+#objectclass: organizationalRole
+#userpassword: {SSHA}eUEupkQCTvq9SkrxfWGSe5rX+orrjVbF
+
+# Entry 3: ou=groups,dc=company,dc=com
+dn: ou=groups,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: groups
+
+# Entry 4: cn=admin,ou=groups,dc=company,dc=com
+dn: cn=admin,ou=groups,dc=company,dc=com
+cn: admin
+gidnumber: 500
+objectclass: posixGroup
+objectclass: top
+
+# Entry 5: cn=users,ou=groups,dc=company,dc=com
+dn: cn=users,ou=groups,dc=company,dc=com
+cn: users
+gidnumber: 501
+objectclass: posixGroup
+objectclass: top
+
+# Entry 6: ou=users,dc=company,dc=com
+dn: ou=users,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: users
+
+# Entry 7: cn=user5,ou=users,dc=company,dc=com
+dn: cn=user5,ou=users,dc=company,dc=com
+cn: user5
+gidnumber: 501
+givenname: John
+homedirectory: /home/users/user5
+objectclass: inetOrgPerson
+objectclass: posixAccount
+objectclass: top
+sn: User
+uid: user5
+uidnumber: 1005
+userpassword: user5
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ca.crt b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ca.crt
new file mode 100644
index 000000000000..8c71e3afc91d
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ca.crt
@@ -0,0 +1,22 @@
+-----BEGIN CERTIFICATE-----
+MIIDlTCCAn2gAwIBAgIUJBqw2dHM2DDCZjYSkPOESlvDH6swDQYJKoZIhvcNAQEL
+BQAwWjELMAkGA1UEBhMCQ0ExCzAJBgNVBAgMAk9OMQ8wDQYDVQQHDAZPdHRhd2Ex
+ETAPBgNVBAoMCEFsdGluaXR5MQswCQYDVQQLDAJRQTENMAsGA1UEAwwEcm9vdDAe
+Fw0yMDA2MTExOTAzNDhaFw0zMDA2MDkxOTAzNDhaMFoxCzAJBgNVBAYTAkNBMQsw
+CQYDVQQIDAJPTjEPMA0GA1UEBwwGT3R0YXdhMREwDwYDVQQKDAhBbHRpbml0eTEL
+MAkGA1UECwwCUUExDTALBgNVBAMMBHJvb3QwggEiMA0GCSqGSIb3DQEBAQUAA4IB
+DwAwggEKAoIBAQC9Irr0zGV+HCI2fZ0ht4hR5It4Sbjz4RwZV8ENRP/+TEz8l9eK
+J6ygxhKX7SMYzIs/jS9Gsq4plX1r2ujW1qRf8yLpR4+dGLP+jBRi1drj0XjZXosT
+SERjWzgPauWxL9LN8+l26eBAqz6fw5e0W8WRSTgf5iGiCcKOTmaATIUjP0CdfWKK
+qpktI4vhe++CXZFJ3usR+8KZ/FwwbCLJM/3J2HnbcXfcaYPYvr1tfqLudKSTbG9H
+M3+AVwjctdesc/0sbd51Zsm0ClQptMbuKnDCYauGg61kNkgbgPgRmH9Pzo67DtxF
+/WW+PtOzq8xLOifciQ9Piboy9QBSQZGwf4wzAgMBAAGjUzBRMB0GA1UdDgQWBBSi
+njya0RDozx3OZTLYFpwqYnlpIDAfBgNVHSMEGDAWgBSinjya0RDozx3OZTLYFpwq
+YnlpIDAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBAD7VyFg7F
+U1C25KFvtauchAOjCW6w7U/b3z1dVZvcQ88/kH1VsLUcfGixlSilUEfPTJsi7OA0
+R5BQdh2GGcjUJv4iqEFGU05KvMVmRRKn08P62+ZhJxKMxG26VzcliRZzCMkI6d0W
+lFwI6nM45yeqdHVh5k4xbuJzqpbD9BtXXLI+/Ra9Fx8S9ETA3GdidpZLU5P1VLxq
+UuedfqyAVWZXpr6TAURGxouRmRzul9yFzbSUex+MLEIPrstjtEwV3+tBQZJz9xAS
+TVPj+Nv3LO7GCq54bdwkq1ioWbSL2hEmABkj6kdW/JwmfhGHf/2rirDVMzrTYw07
+dFJfAZC+FEsv
+-----END CERTIFICATE-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/dhparam.pem b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/dhparam.pem
new file mode 100644
index 000000000000..0a96faffd627
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/dhparam.pem
@@ -0,0 +1,5 @@
+-----BEGIN DH PARAMETERS-----
+MIGHAoGBAJitt2hhnpDViQ5ko2ipBMdjy+bZ6FR/WdZ987R7lQvBkKehPXmxtEyV
+AO6ofv5CZSDJokc5bUeBOAtg0EhMTCH82uPdwQvt58jRXcxXBg4JTjkx+oW9LBv2
+FdZsbaX8+SYivmiZ0Jp8T/HBm/4DA9VBS0O5GFRS4C7dHhmSTPfDAgEC
+-----END DH PARAMETERS-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ldap.crt b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ldap.crt
new file mode 100644
index 000000000000..9167cbf861d0
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ldap.crt
@@ -0,0 +1,20 @@
+-----BEGIN CERTIFICATE-----
+MIIDQDCCAigCFCJ7El0ntrGktZVTYTZd+OwtcJjBMA0GCSqGSIb3DQEBCwUAMFox
+CzAJBgNVBAYTAkNBMQswCQYDVQQIDAJPTjEPMA0GA1UEBwwGT3R0YXdhMREwDwYD
+VQQKDAhBbHRpbml0eTELMAkGA1UECwwCUUExDTALBgNVBAMMBHJvb3QwHhcNMjAw
+NjExMTkxMTQzWhcNMzAwNjA5MTkxMTQzWjBfMQswCQYDVQQGEwJDQTELMAkGA1UE
+CAwCT04xDzANBgNVBAcMBk90dGF3YTERMA8GA1UECgwIQWx0aW5pdHkxCzAJBgNV
+BAsMAlFBMRIwEAYDVQQDDAlvcGVubGRhcDIwggEiMA0GCSqGSIb3DQEBAQUAA4IB
+DwAwggEKAoIBAQC0Mbn//U56URavMgXm82FWP6vBdKuRydFX/L0M5XLlnAtk/IXG
+/T+4t7nOBJxWmTp/xpsPtSMALE4eFJpEUEqlpVbG5DfBzVWcYOWoMeRAcHWCDkzr
+PkB6I0dfF0Mm5hoaDhn+ZXjBWvoh/IlJdAnPg5mlejflJBQ7xtFC9eN6WjldXuRO
+vyntGNuMfVLgITHwXuH2yZ98G0mFO6TU/9dRY/Z3D6RTSzKdb17Yk/VnG+ry92u2
+0sgXIBvhuJuC3ksWLArwwFoMl8DVa05D4O2H76goGdCcQ0KzqBV8RPXAh3UcgP2e
+Zu90p2EGIhIk+sZTCkPd4dorxjL9nkRR86HdAgMBAAEwDQYJKoZIhvcNAQELBQAD
+ggEBAJWiCxJaTksv/BTsh/etxlDY5eHwqStqIuiovEQ8bhGAcKJ3bfWd/YTb8DUS
+hrLvXrXdOVC+U8PqPFXBpdOqcm5Dc233z52VgUCb+0EKv3lAzgKXRIo32h52skdK
+NnRrCHDeDzgfEIXR4MEJ99cLEaxWyXQhremmTYWHYznry9/4NYz40gCDxHn9dJAi
+KxFyDNxhtuKs58zp4PrBoo+542JurAoLPtRGOhdXpU2RkQVU/ho38HsAXDStAB5D
+vAoSxPuMHKgo17ffrb0oqU3didwaA9fIsz7Mr6RxmI7X03s7hLzNBq9FCqu0U3RR
+CX4zWGFNJu/ieSGVWLYKQzbYxp8=
+-----END CERTIFICATE-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ldap.csr b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ldap.csr
new file mode 100644
index 000000000000..bf569f727d63
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ldap.csr
@@ -0,0 +1,17 @@
+-----BEGIN CERTIFICATE REQUEST-----
+MIICpDCCAYwCAQAwXzELMAkGA1UEBhMCQ0ExCzAJBgNVBAgMAk9OMQ8wDQYDVQQH
+DAZPdHRhd2ExETAPBgNVBAoMCEFsdGluaXR5MQswCQYDVQQLDAJRQTESMBAGA1UE
+AwwJb3BlbmxkYXAyMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtDG5
+//1OelEWrzIF5vNhVj+rwXSrkcnRV/y9DOVy5ZwLZPyFxv0/uLe5zgScVpk6f8ab
+D7UjACxOHhSaRFBKpaVWxuQ3wc1VnGDlqDHkQHB1gg5M6z5AeiNHXxdDJuYaGg4Z
+/mV4wVr6IfyJSXQJz4OZpXo35SQUO8bRQvXjelo5XV7kTr8p7RjbjH1S4CEx8F7h
+9smffBtJhTuk1P/XUWP2dw+kU0synW9e2JP1Zxvq8vdrttLIFyAb4bibgt5LFiwK
+8MBaDJfA1WtOQ+Dth++oKBnQnENCs6gVfET1wId1HID9nmbvdKdhBiISJPrGUwpD
+3eHaK8Yy/Z5EUfOh3QIDAQABoAAwDQYJKoZIhvcNAQELBQADggEBAEzIjZQOT5R7
+mEJg+RFpCSIoPn3xJ4/VMMyWqA3bTGZKpb4S6GxgsierY/87kPL7jZrMdGYB4Dc3
+2M3VWZGXlYo8vctH1zLE9VW6CzosUpl20lhdgydoCMz3RQqdJyK8aGeFTeLtk7G/
+TRCCUFUE6jaA+VtaCPCnOJSff3jUf76xguEu7dgTZgCKV7dtBqald8gIzF3D+AJJ
+7pEN2UrC3UR0xpe2cj2GhndQJ+WsIyft3zpNFzAO13j8ZPibuVP7oDWcW3ixNCWC
+213aeRVplJGof8Eo6llDxP+6Fwp1YmOoQmwB1Xm3t4ADn7FLJ14LONLB7q40KviG
+RyLyqu3IVOI=
+-----END CERTIFICATE REQUEST-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ldap.key b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ldap.key
new file mode 100644
index 000000000000..5ab3a3f8b590
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/certs/ldap.key
@@ -0,0 +1,27 @@
+-----BEGIN RSA PRIVATE KEY-----
+MIIEogIBAAKCAQEAtDG5//1OelEWrzIF5vNhVj+rwXSrkcnRV/y9DOVy5ZwLZPyF
+xv0/uLe5zgScVpk6f8abD7UjACxOHhSaRFBKpaVWxuQ3wc1VnGDlqDHkQHB1gg5M
+6z5AeiNHXxdDJuYaGg4Z/mV4wVr6IfyJSXQJz4OZpXo35SQUO8bRQvXjelo5XV7k
+Tr8p7RjbjH1S4CEx8F7h9smffBtJhTuk1P/XUWP2dw+kU0synW9e2JP1Zxvq8vdr
+ttLIFyAb4bibgt5LFiwK8MBaDJfA1WtOQ+Dth++oKBnQnENCs6gVfET1wId1HID9
+nmbvdKdhBiISJPrGUwpD3eHaK8Yy/Z5EUfOh3QIDAQABAoIBADugMMIKWcuTxYPX
+c6iGZHEbxIPRTWyCcalB0nTQAAMGbabPAJ1l8432DZ+kWu806OybFXhPIfPOtVKy
+0pFEWE8TtPE/V0vj3C5Qye2sBLFmBRwyCzXUdZV00wseMXRPs9dnTyalAR5KMnbI
+j80kfpKSI2dkV9aU57UYBuq3Xrx/TCGItwL769D4ZZW9BvbpiTZApQQFZ0gwUFFn
+btPXGU9Ti8H4mfBuZWL+5CaZdqOo76+CXvMPaUK0F9MJp4yX3XxQLRNH3qz/Tyn7
+h7QOOo0XTqoUmzRw0N9QRVH5LRdSE5yq3aF9aFKjNW59exz+62pufOFadngzkpkn
+OKCzgWkCgYEA4mOWWMzdYwMn3GtfG7whqlqy7wOmMkNb81zTDQejHBV98dnj0AHr
+deurfKWzHrAh3DXo6tFeqUIgXabhBPS/0dEx/S5sgLFmuUZP05EUYahfWBgzzmM9
+C6Oe5xIMLzxsZCJczolsfkEsoFe4o0vkvuLYoQrQL7InzewcDy8cUxsCgYEAy8Na
+YCnanSNDY03Bulcni+5sF+opaHseeki1pv3nlw8TwsWuZF9ApS+yL7ck9jJjxBRR
+RC3KGmpoqIr0vTmUYS946ngQWXPE90zfuhJfM+NRv/q0oCjH0qAcxRbTkls5On9v
+oxJ8rO7gD6K85eHqasWdbCVzdZrobOXzay37tmcCgYBfyUUmw190cjReZauzH3Gb
+E48b5A5gu/Fe0cqWe8G+szU7rDZgnz9SAGnpbm6QMHPTKZgoKngD42+wUFhq8Wdr
+zjh5aDgOZ4EQKTjDSmI2Q7g7nNnmnESK9SrZl+BB6C3wXD2qQaj+7nKEUTlVFlpt
+jaucz+dwFtASp7Djl8pDOwKBgEtr2c3ycArt/ImLRIP2spqm+7e2YvFbcSKOOz6+
+iLRvTj8v8KcSYtlB2FC1F6dRa4AujQ4RbNduP6LzHDfWUkfOzJDtNBAIPAXVnJJB
+LqAEKkRHRghqT9x0i3GgS1vHDF3MwcO4mhFgserXr9ffUWeIEgbvrdcAKbv1Oa6Y
+bK1NAoGAGPm8ISmboDJynjBl9wMrkcy23Pwg9kmyocdWUHh0zMLDKriZNKYB6u/U
+C+/RTfkohPoHPzkeqWiHp7z3JhMItYUfTkNW6vMCxEGc0NEN6ZyMIjtiDPGN1n6O
+E7jmODFmj1AQICQGdV5SHp+yKvKyb0YHKyDwETbs4SZBXxVvjEw=
+-----END RSA PRIVATE KEY-----
diff --git a/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/config/export.ldif b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/config/export.ldif
new file mode 100644
index 000000000000..c6470176a5e7
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/configs/ldap5/ldap2/config/export.ldif
@@ -0,0 +1,64 @@
+# LDIF Export for dc=company,dc=com
+# Server: openldap (openldap)
+# Search Scope: sub
+# Search Filter: (objectClass=*)
+# Total Entries: 7
+#
+# Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on May 22, 2020 5:51 pm
+# Version: 1.2.5
+
+# Entry 1: dc=company,dc=com
+#dn: dc=company,dc=com
+#dc: company
+#o: company
+#objectclass: top
+#objectclass: dcObject
+#objectclass: organization
+
+# Entry 2: cn=admin,dc=company,dc=com
+#dn: cn=admin,dc=company,dc=com
+#cn: admin
+#description: LDAP administrator
+#objectclass: simpleSecurityObject
+#objectclass: organizationalRole
+#userpassword: {SSHA}eUEupkQCTvq9SkrxfWGSe5rX+orrjVbF
+
+# Entry 3: ou=groups,dc=company,dc=com
+dn: ou=groups,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: groups
+
+# Entry 4: cn=admin,ou=groups,dc=company,dc=com
+dn: cn=admin,ou=groups,dc=company,dc=com
+cn: admin
+gidnumber: 500
+objectclass: posixGroup
+objectclass: top
+
+# Entry 5: cn=users,ou=groups,dc=company,dc=com
+dn: cn=users,ou=groups,dc=company,dc=com
+cn: users
+gidnumber: 501
+objectclass: posixGroup
+objectclass: top
+
+# Entry 6: ou=users,dc=company,dc=com
+dn: ou=users,dc=company,dc=com
+objectclass: organizationalUnit
+objectclass: top
+ou: users
+
+# Entry 7: cn=user1,ou=users,dc=company,dc=com
+dn: cn=user1,ou=users,dc=company,dc=com
+cn: user1
+gidnumber: 501
+givenname: John1
+homedirectory: /home/users/user1
+objectclass: inetOrgPerson
+objectclass: posixAccount
+objectclass: top
+sn: User1
+uid: user1
+uidnumber: 1001
+userpassword: user1
diff --git a/tests/testflows/ldap/role_mapping/docker-compose/clickhouse-service.yml b/tests/testflows/ldap/role_mapping/docker-compose/clickhouse-service.yml
new file mode 100644
index 000000000000..0789decf022f
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/docker-compose/clickhouse-service.yml
@@ -0,0 +1,28 @@
+version: '2.3'
+
+services:
+  clickhouse:
+    image: yandex/clickhouse-integration-test
+    expose:
+      - "9000"
+      - "9009"
+      - "8123"
+    volumes:
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse/config.d:/etc/clickhouse-server/config.d"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse/users.d/:/etc/clickhouse-server/users.d"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse/ssl:/etc/clickhouse-server/ssl"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse/config.xml:/etc/clickhouse-server/config.xml"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse/users.xml:/etc/clickhouse-server/users.xml"
+      - "${CLICKHOUSE_TESTS_SERVER_BIN_PATH:-/usr/bin/clickhouse}:/usr/bin/clickhouse"
+      - "${CLICKHOUSE_TESTS_ODBC_BRIDGE_BIN_PATH:-/usr/bin/clickhouse-odbc-bridge}:/usr/bin/clickhouse-odbc-bridge"
+    entrypoint: bash -c "clickhouse server --config-file=/etc/clickhouse-server/config.xml --log-file=/var/log/clickhouse-server/clickhouse-server.log --errorlog-file=/var/log/clickhouse-server/clickhouse-server.err.log"
+    healthcheck:
+      test: clickhouse client --query='select 1'
+      interval: 10s
+      timeout: 10s
+      retries: 10
+      start_period: 300s
+    cap_add:
+      - SYS_PTRACE
+    security_opt:
+      - label:disable
diff --git a/tests/testflows/ldap/role_mapping/docker-compose/docker-compose.yml b/tests/testflows/ldap/role_mapping/docker-compose/docker-compose.yml
new file mode 100644
index 000000000000..c8ff683df587
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/docker-compose/docker-compose.yml
@@ -0,0 +1,162 @@
+version: '2.3'
+
+services:
+  openldap1:
+    # plain text
+    extends:
+      file: openldap-service.yml
+      service: openldap
+    volumes:
+      - "${CLICKHOUSE_TESTS_DIR}/configs/ldap1/config:/container/service/slapd/assets/config/bootstrap/ldif/custom"
+
+  openldap2:
+    # TLS - never
+    extends:
+      file: openldap-service.yml
+      service: openldap
+    environment:
+      LDAP_TLS: "true"
+      LDAP_TLS_CRT_FILENAME: "ldap.crt"
+      LDAP_TLS_KEY_FILENAME: "ldap.key"
+      LDAP_TLS_DH_PARAM_FILENAME: "dhparam.pem"
+      LDAP_TLS_CA_CRT_FILENAME: "ca.crt"
+      LDAP_TLS_ENFORCE: "false"
+      LDAP_TLS_VERIFY_CLIENT: "never"
+    volumes:
+      - "${CLICKHOUSE_TESTS_DIR}/configs/ldap2/config:/container/service/slapd/assets/config/bootstrap/ldif/custom"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/ldap2/certs:/container/service/slapd/assets/certs/"
+
+  openldap3:
+    # plain text - custom port
+    extends:
+      file: openldap-service.yml
+      service: openldap
+    expose:
+      - "3089"
+    environment:
+      LDAP_PORT: "3089"
+    volumes:
+      - "${CLICKHOUSE_TESTS_DIR}/configs/ldap3/config:/container/service/slapd/assets/config/bootstrap/ldif/custom"
+
+  openldap4:
+    # TLS - never custom port
+    extends:
+      file: openldap-service.yml
+      service: openldap
+    expose:
+      - "3089"
+      - "6036"
+    environment:
+      LDAP_PORT: "3089"
+      LDAPS_PORT: "6036"
+      LDAP_TLS: "true"
+      LDAP_TLS_CRT_FILENAME: "ldap.crt"
+      LDAP_TLS_KEY_FILENAME: "ldap.key"
+      LDAP_TLS_DH_PARAM_FILENAME: "dhparam.pem"
+      LDAP_TLS_CA_CRT_FILENAME: "ca.crt"
+      LDAP_TLS_ENFORCE: "false"
+      LDAP_TLS_VERIFY_CLIENT: "never"
+      LDAP_TLS_CIPHER_SUITE: "SECURE256:+SECURE128:-VERS-TLS-ALL:+VERS-TLS1.2:-RSA:-DHE-DSS:-CAMELLIA-128-CBC:-CAMELLIA-256-CBC"
+    volumes:
+      - "${CLICKHOUSE_TESTS_DIR}/configs/ldap4/config:/container/service/slapd/assets/config/bootstrap/ldif/custom"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/ldap4/certs:/container/service/slapd/assets/certs/"
+
+  openldap5:
+    # TLS - try
+    extends:
+      file: openldap-service.yml
+      service: openldap
+    environment:
+      LDAP_TLS: "true"
+      LDAP_TLS_CRT_FILENAME: "ldap.crt"
+      LDAP_TLS_KEY_FILENAME: "ldap.key"
+      LDAP_TLS_DH_PARAM_FILENAME: "dhparam.pem"
+      LDAP_TLS_CA_CRT_FILENAME: "ca.crt"
+      LDAP_TLS_ENFORCE: "false"
+      LDAP_TLS_VERIFY_CLIENT: "try"
+    volumes:
+      - "${CLICKHOUSE_TESTS_DIR}/configs/ldap5/config:/container/service/slapd/assets/config/bootstrap/ldif/custom"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/ldap5/certs:/container/service/slapd/assets/certs/"
+
+  phpldapadmin:
+    extends:
+      file: openldap-service.yml
+      service: phpldapadmin
+    environment:
+      PHPLDAPADMIN_LDAP_HOSTS: "openldap1"
+    depends_on:
+      openldap1:
+        condition: service_healthy
+
+  zookeeper:
+    extends:
+      file: zookeeper-service.yml
+      service: zookeeper
+
+  clickhouse1:
+    extends:
+      file: clickhouse-service.yml
+      service: clickhouse
+    hostname: clickhouse1
+    volumes:
+      - "${CLICKHOUSE_TESTS_DIR}/_instances/clickhouse1/database/:/var/lib/clickhouse/"
+      - "${CLICKHOUSE_TESTS_DIR}/_instances/clickhouse1/logs/:/var/log/clickhouse-server/"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse1/config.d:/etc/clickhouse-server/config.d"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse1/users.d:/etc/clickhouse-server/users.d"
+    depends_on:
+      zookeeper:
+        condition: service_healthy
+
+  clickhouse2:
+    extends:
+      file: clickhouse-service.yml
+      service: clickhouse
+    hostname: clickhouse2
+    volumes:
+      - "${CLICKHOUSE_TESTS_DIR}/_instances/clickhouse2/database/:/var/lib/clickhouse/"
+      - "${CLICKHOUSE_TESTS_DIR}/_instances/clickhouse2/logs/:/var/log/clickhouse-server/"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse2/config.d:/etc/clickhouse-server/config.d"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse2/users.d:/etc/clickhouse-server/users.d"
+    depends_on:
+      zookeeper:
+        condition: service_healthy
+
+  clickhouse3:
+    extends:
+      file: clickhouse-service.yml
+      service: clickhouse
+    hostname: clickhouse3
+    volumes:
+      - "${CLICKHOUSE_TESTS_DIR}/_instances/clickhouse3/database/:/var/lib/clickhouse/"
+      - "${CLICKHOUSE_TESTS_DIR}/_instances/clickhouse3/logs/:/var/log/clickhouse-server/"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse3/config.d:/etc/clickhouse-server/config.d"
+      - "${CLICKHOUSE_TESTS_DIR}/configs/clickhouse3/users.d:/etc/clickhouse-server/users.d"
+    depends_on:
+      zookeeper:
+        condition: service_healthy
+
+  # dummy service which does nothing, but allows to postpone 
+  # 'docker-compose up -d' till all dependecies will go healthy
+  all_services_ready:
+    image: hello-world
+    depends_on:
+      clickhouse1:
+        condition: service_healthy
+      clickhouse2:
+        condition: service_healthy
+      clickhouse3:
+        condition: service_healthy
+      zookeeper:
+        condition: service_healthy
+      openldap1:
+        condition: service_healthy
+      openldap2:
+        condition: service_healthy
+      openldap3:
+        condition: service_healthy
+      openldap4:
+        condition: service_healthy
+      openldap5:
+        condition: service_healthy
+      phpldapadmin:
+        condition: service_healthy
diff --git a/tests/testflows/ldap/role_mapping/docker-compose/openldap-service.yml b/tests/testflows/ldap/role_mapping/docker-compose/openldap-service.yml
new file mode 100644
index 000000000000..139907c513cf
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/docker-compose/openldap-service.yml
@@ -0,0 +1,40 @@
+version: '2.3'
+
+services:
+  openldap:
+    image: osixia/openldap:1.4.0
+    command: "--copy-service --loglevel debug"
+    environment:
+      LDAP_ORGANIZATION: "company"
+      LDAP_DOMAIN: "company.com"
+      LDAP_ADMIN_PASSWORD: "admin"
+      LDAP_TLS: "false"
+    expose:
+      - "389"
+      - "636"
+    healthcheck:
+      test: ldapsearch -x -H ldap://localhost:$${LDAP_PORT:-389} -b "dc=company,dc=com" -D "cn=admin,dc=company,dc=com" -w admin
+      interval: 10s
+      timeout: 10s
+      retries: 3
+      start_period: 300s
+    security_opt:
+      - label:disable
+
+
+  phpldapadmin:
+    image: osixia/phpldapadmin:0.9.0
+    container_name: phpldapadmin
+    environment:
+      PHPLDAPADMIN_HTTPS=false:
+    ports:
+      - "8080:80"      
+    healthcheck:
+      test: echo 1
+      interval: 10s
+      timeout: 10s
+      retries: 3
+      start_period: 300s
+    security_opt:
+      - label:disable
+
diff --git a/tests/testflows/ldap/role_mapping/docker-compose/zookeeper-service.yml b/tests/testflows/ldap/role_mapping/docker-compose/zookeeper-service.yml
new file mode 100644
index 000000000000..6691a2df31c1
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/docker-compose/zookeeper-service.yml
@@ -0,0 +1,18 @@
+version: '2.3'
+
+services:
+  zookeeper:
+    image: zookeeper:3.4.12
+    expose:
+      - "2181"
+    environment:
+      ZOO_TICK_TIME: 500
+      ZOO_MY_ID: 1
+    healthcheck:
+      test: echo stat | nc localhost 2181
+      interval: 10s
+      timeout: 10s
+      retries: 3
+      start_period: 300s
+    security_opt:
+      - label:disable
diff --git a/tests/testflows/ldap/role_mapping/regression.py b/tests/testflows/ldap/role_mapping/regression.py
new file mode 100755
index 000000000000..fff1e72a945f
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/regression.py
@@ -0,0 +1,47 @@
+#!/usr/bin/env python3
+import sys
+from testflows.core import *
+
+append_path(sys.path, "..", "..")
+
+from helpers.cluster import Cluster
+from helpers.argparser import argparser
+from ldap.role_mapping.requirements import *
+
+# Cross-outs of known fails
+xfails = {
+   "mapping/roles removed and added in parallel":
+       [(Fail, "known bug")]
+}
+
+@TestFeature
+@Name("role mapping")
+@ArgumentParser(argparser)
+@Specifications(
+    QA_SRS014_ClickHouse_LDAP_Role_Mapping
+)
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping("1.0")
+)
+@XFails(xfails)
+def regression(self, local, clickhouse_binary_path, stress=None, parallel=None):
+    """ClickHouse LDAP role mapping regression module.
+    """
+    nodes = {
+        "clickhouse": ("clickhouse1", "clickhouse2", "clickhouse3"),
+    }
+
+    with Cluster(local, clickhouse_binary_path, nodes=nodes) as cluster:
+        self.context.cluster = cluster
+        
+        if stress is not None or not hasattr(self.context, "stress"):
+            self.context.stress = stress
+        if parallel is not None or not hasattr(self.context, "parallel"):
+            self.context.parallel = parallel
+
+        Scenario(run=load("ldap.authentication.tests.sanity", "scenario"), name="ldap sanity")
+        Feature(run=load("ldap.role_mapping.tests.server_config", "feature"))
+        Feature(run=load("ldap.role_mapping.tests.mapping", "feature"))
+
+if main():
+    regression()
diff --git a/tests/testflows/ldap/role_mapping/requirements/__init__.py b/tests/testflows/ldap/role_mapping/requirements/__init__.py
new file mode 100644
index 000000000000..02f7d4301544
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/requirements/__init__.py
@@ -0,0 +1,1 @@
+from .requirements import *
diff --git a/tests/testflows/ldap/role_mapping/requirements/requirements.py b/tests/testflows/ldap/role_mapping/requirements/requirements.py
new file mode 100644
index 000000000000..ca7192e9dadb
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/requirements/requirements.py
@@ -0,0 +1,1475 @@
+# These requirements were auto generated
+# from software requirements specification (SRS)
+# document by TestFlows v1.6.210101.1235930.
+# Do not edit by hand but re-generate instead
+# using 'tfs requirements generate' command.
+from testflows.core import Specification
+from testflows.core import Requirement
+
+Heading = Specification.Heading
+
+RQ_SRS_014_LDAP_RoleMapping = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support mapping of [LDAP] groups to [RBAC] roles
'
+        'for users authenticated using [LDAP] external user directory.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.1.1')
+
+RQ_SRS_014_LDAP_RoleMapping_WithFixedRoles = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.WithFixedRoles',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support mapping of [LDAP] groups to [RBAC] roles
'
+        'for users authenticated using [LDAP] external user directory when
'
+        'one or more roles are specified in the `<roles>` section.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.1.2')
+
+RQ_SRS_014_LDAP_RoleMapping_Search = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Search',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL perform search on the [LDAP] server and map the results to [RBAC] role names 
'
+        'when authenticating users using the [LDAP] external user directory if the `<role_mapping>` section is configured
'
+        'as part of the [LDAP] external user directory. The matched roles SHALL be assigned to the user.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.1.3')
+
+RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_WithUTF8Characters = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithUTF8Characters',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support mapping [LDAP] search results for users authenticated using [LDAP] external user directory
'
+        'to an [RBAC] role that contains UTF-8 characters.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.2.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_Long = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.Long',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support mapping [LDAP] search results for users authenticated using [LDAP] external user directory
'
+        'to an [RBAC] role that has a name with more than 128 characters.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.2.2')
+
+RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_WithSpecialXMLCharacters = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithSpecialXMLCharacters',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support mapping [LDAP] search results for users authenticated using [LDAP] external user directory
'
+        'to an [RBAC] role that has a name that contains special characters that need to be escaped in XML.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.2.3')
+
+RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_WithSpecialRegexCharacters = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithSpecialRegexCharacters',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support mapping [LDAP] search results for users authenticated using [LDAP] external user directory
'
+        'to an [RBAC] role that has a name that contains special characters that need to be escaped in regex.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.2.4')
+
+RQ_SRS_014_LDAP_RoleMapping_Map_MultipleRoles = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Map.MultipleRoles',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support mapping one or more [LDAP] search results for users authenticated using 
'
+        '[LDAP] external user directory to one or more [RBAC] role.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.3.1')
+
+RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_Removed = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.Removed',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL not assign [RBAC] role(s) for any users authenticated using [LDAP] external user directory
'
+        'if the corresponding [LDAP] group(s) that map those role(s) are removed. Any users that have active sessions SHALL still
'
+        'have privileges provided by the role(s) until the next time they are authenticated.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.4.1')
+
+RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_RemovedAndAdded_Parallel = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.RemovedAndAdded.Parallel',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support authenticating users using [LDAP] external user directory 
'
+        'when [LDAP] groups are removed and added 
'
+        'at the same time as [LDAP] user authentications are performed in parallel.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.4.2')
+
+RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_UserRemoved = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.UserRemoved',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL not assign [RBAC] role(s) for the user authenticated using [LDAP] external user directory
'
+        'if the user has been removed from the corresponding [LDAP] group(s) that map those role(s). 
'
+        'Any active user sessions SHALL have privileges provided by the role(s) until the next time the user is authenticated.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.4.3')
+
+RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_UserRemovedAndAdded_Parallel = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.UserRemovedAndAdded.Parallel',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support authenticating users using [LDAP] external user directory
'
+        'when [LDAP] users are added and removed from [LDAP] groups used to map to [RBAC] roles
'
+        'at the same time as [LDAP] user authentications are performed in parallel.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.4.4')
+
+RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_NotPresent = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.NotPresent',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL not reject authentication attempt using [LDAP] external user directory if any of the roles that are 
'
+        'are mapped from [LDAP] but are not present locally.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.5.1')
+
+RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_Added = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Added',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL add the privileges provided by the [LDAP] mapped role when the
'
+        'role is not present during user authentication using [LDAP] external user directory
'
+        'as soon as the role is added.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.5.2')
+
+RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_Removed = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Removed',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL remove the privileges provided by the role from all the
'
+        'users authenticated using [LDAP] external user directory if the [RBAC] role that was mapped
'
+        'as a result of [LDAP] search is removed.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.5.3')
+
+RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_Readded = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Readded',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL reassign the [RBAC] role and add all the privileges provided by the role
'
+        'when it is re-added after removal for all [LDAP] users authenticated using external user directory
'
+        'for any role that was mapped as a result of [LDAP] search.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.5.4')
+
+RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_RemovedAndAdded_Parallel = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.RemovedAndAdded.Parallel',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support authenticating users using [LDAP] external user directory
'
+        'when [RBAC] roles that are mapped by [LDAP] groups
'
+        'are added and removed at the same time as [LDAP] user authentications are performed in parallel.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.5.5')
+
+RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_New = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.New',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL not allow any new roles to be assigned to any
'
+        'users authenticated using [LDAP] external user directory unless the role is specified
'
+        'in the configuration of the external user directory or was mapped as a result of [LDAP] search.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.5.6')
+
+RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_NewPrivilege = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.NewPrivilege',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL add new privilege to all the users authenticated using [LDAP] external user directory
'
+        'when new privilege is added to one of the roles that were mapped as a result of [LDAP] search.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.5.7')
+
+RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_RemovedPrivilege = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.RemovedPrivilege',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL remove privilege from all the users authenticated using [LDAP] external user directory
'
+        'when the privilege that was provided by the mapped role is removed from all the roles 
'
+        'that were mapped as a result of [LDAP] search.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.5.8')
+
+RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support parallel authentication of users using [LDAP] server
'
+        'when using [LDAP] external user directory that has role mapping enabled.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.6.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_ValidAndInvalid = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.ValidAndInvalid',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support authentication of valid users and
'
+        'prohibit authentication of invalid users using [LDAP] server
'
+        'in parallel without having invalid attempts affecting valid authentications
'
+        'when using [LDAP] external user directory that has role mapping enabled.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.6.2')
+
+RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_MultipleServers = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.MultipleServers',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support parallel authentication of external [LDAP] users
'
+        'authenticated using multiple [LDAP] external user directories that have
'
+        'role mapping enabled.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.6.3')
+
+RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_LocalOnly = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.LocalOnly',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support parallel authentication of users defined only locally
'
+        'when one or more [LDAP] external user directories with role mapping
'
+        'are specified in the configuration file.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.6.4')
+
+RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_LocalAndMultipleLDAP = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.LocalAndMultipleLDAP',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support parallel authentication of local and external [LDAP] users
'
+        'authenticated using multiple [LDAP] external user directories with role mapping enabled.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.6.5')
+
+RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_SameUser = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.SameUser',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support parallel authentication of the same external [LDAP] user
'
+        'authenticated using the same [LDAP] external user directory with role mapping enabled.
'
+        '
'
+        ),
+    link=None,
+    level=3,
+    num='4.6.6')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_Server_BindDN = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.Server.BindDN',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `<bind_dn>` parameter in the `<ldap_servers><server_name>` section
'
+        'of the `config.xml` that SHALL be used to construct the `DN` to bind to.
'
+        'The resulting `DN` SHALL be constructed by replacing all `{user_name}` substrings of the template 
'
+        'with the actual user name during each authentication attempt.
'
+        '
'
+        'For example, 
'
+        '
'
+        '```xml
'
+        '<yandex>
'
+        '    <ldap_servers>
'
+        '        <my_ldap_server>
'
+        '            <!-- ... -->
'
+        '            <bind_dn>uid={user_name},ou=users,dc=example,dc=com</bind_dn>
'
+        '            <!-- ... -->
'
+        '        </my_ldap_server>
'
+        '    </ldap_servers>
'
+        '</yandex>
'
+        '```
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.7.1.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_Server_BindDN_ConflictWith_AuthDN = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.Server.BindDN.ConflictWith.AuthDN',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL return an error if both `<bind_dn>` and `<auth_dn_prefix>` or `<auth_dn_suffix>` parameters
'
+        'are specified as part of [LDAP] server description in the `<ldap_servers>` section of the `config.xml`.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.7.1.2')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Syntax = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Syntax',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `role_mapping` sub-section in the `<user_directories><ldap>` section
'
+        'of the `config.xml`.
'
+        '
'
+        'For example,
'
+        '
'
+        '```xml
'
+        '<yandex>
'
+        '    <user_directories>
'
+        '        <ldap>
'
+        '            <!-- ... -->
'
+        '            <role_mapping>
'
+        '                <base_dn>ou=groups,dc=example,dc=com</base_dn>
'
+        '                <attribute>cn</attribute>
'
+        '                <scope>subtree</scope>
'
+        '                <search_filter>(&amp;(objectClass=groupOfNames)(member={bind_dn}))</search_filter>
'
+        '                <prefix>clickhouse_</prefix>
'
+        '            </role_mapping>
'
+        '        </ldap>
'
+        '    </user_directories>
'
+        '</yandex>
'
+        '```
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.1.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_SpecialCharactersEscaping = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.SpecialCharactersEscaping',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support properly escaped special XML characters that can be present
'
+        'as part of the values for different configuration parameters inside the
'
+        '`<user_directories><ldap><role_mapping>` section of the `config.xml` such as
'
+        '
'
+        '* `<search_filter>` parameter
'
+        '* `<prefix>` parameter
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.2.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_MultipleSections = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.MultipleSections',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support multiple `<role_mapping>` sections defined inside the same `<user_directories><ldap>` section 
'
+        'of the `config.xml` and all of the `<role_mapping>` sections SHALL be applied.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.3.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_MultipleSections_IdenticalParameters = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.MultipleSections.IdenticalParameters',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL not duplicate mapped roles when multiple `<role_mapping>` sections 
'
+        'with identical parameters are defined inside the `<user_directories><ldap>` section 
'
+        'of the `config.xml`.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.3.2')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_BaseDN = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.BaseDN',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `<base_dn>` parameter in the `<user_directories><ldap><role_mapping>` section 
'
+        'of the `config.xml` that SHALL specify the template to be used to construct the base `DN` for the [LDAP] search.
'
+        '
'
+        'The resulting `DN` SHALL be constructed by replacing all the `{user_name}` and `{bind_dn}` substrings of 
'
+        'the template with the actual user name and bind `DN` during each [LDAP] search.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.4.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Attribute = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Attribute',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `<attribute>` parameter in the `<user_directories><ldap><role_mapping>` section of 
'
+        'the `config.xml` that SHALL specify the name of the attribute whose values SHALL be returned by the [LDAP] search.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.5.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `<scope>` parameter in the `<user_directories><ldap><role_mapping>` section of 
'
+        'the `config.xml` that SHALL define the scope of the LDAP search as defined 
'
+        'by the https://ldapwiki.com/wiki/LDAP%20Search%20Scopes.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.6.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope_Value_Base = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Base',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `base` value for the the `<scope>` parameter in the 
'
+        '`<user_directories><ldap><role_mapping>` section of the `config.xml` that SHALL
'
+        'limit the scope as specified by the https://ldapwiki.com/wiki/BaseObject.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.6.2')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope_Value_OneLevel = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.OneLevel',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `one_level` value for the the `<scope>` parameter in the 
'
+        '`<user_directories><ldap><role_mapping>` section of the `config.xml` that SHALL
'
+        'limit the scope as specified by the https://ldapwiki.com/wiki/SingleLevel.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.6.3')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope_Value_Children = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Children',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `children` value for the the `<scope>` parameter in the 
'
+        '`<user_directories><ldap><role_mapping>` section of the `config.xml` that SHALL
'
+        'limit the scope as specified by the https://ldapwiki.com/wiki/SubordinateSubtree.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.6.4')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope_Value_Subtree = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Subtree',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `children` value for the the `<scope>` parameter in the 
'
+        '`<user_directories><ldap><role_mapping>` section of the `config.xml` that SHALL
'
+        'limit the scope as specified by the https://ldapwiki.com/wiki/WholeSubtree.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.6.5')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope_Value_Default = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Default',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `subtree` as the default value for the the `<scope>` parameter in the 
'
+        '`<user_directories><ldap><role_mapping>` section of the `config.xml` when the `<scope>` parameter is not specified.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.6.6')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_SearchFilter = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.SearchFilter',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `<search_filter>` parameter in the `<user_directories><ldap><role_mapping>`
'
+        'section of the `config.xml` that SHALL specify the template used to construct 
'
+        'the [LDAP filter](https://ldap.com/ldap-filters/) for the search.
'
+        '
'
+        'The resulting filter SHALL be constructed by replacing all `{user_name}`, `{bind_dn}`, and `{base_dn}` substrings 
'
+        'of the template with the actual user name, bind `DN`, and base `DN` during each the [LDAP] search.
'
+        ' 
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.7.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support the `<prefix>` parameter in the `<user directories><ldap><role_mapping>`
'
+        'section of the `config.xml` that SHALL be expected to be in front of each string in 
'
+        'the original list of strings returned by the [LDAP] search. 
'
+        'Prefix SHALL be removed from the original strings and resulting strings SHALL be treated as [RBAC] role names. 
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.8.1')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_Default = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.Default',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support empty string as the default value of the `<prefix>` parameter in 
'
+        'the `<user directories><ldap><role_mapping>` section of the `config.xml`.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.8.2')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_WithUTF8Characters = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithUTF8Characters',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support UTF8 characters as the value of the `<prefix>` parameter in
'
+        'the `<user directories><ldap><role_mapping>` section of the `config.xml`.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.8.3')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_WithSpecialXMLCharacters = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithSpecialXMLCharacters',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support XML special characters as the value of the `<prefix>` parameter in
'
+        'the `<user directories><ldap><role_mapping>` section of the `config.xml`.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.8.4')
+
+RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_WithSpecialRegexCharacters = Requirement(
+    name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithSpecialRegexCharacters',
+    version='1.0',
+    priority=None,
+    group=None,
+    type=None,
+    uid=None,
+    description=(
+        '[ClickHouse] SHALL support regex special characters as the value of the `<prefix>` parameter in
'
+        'the `<user directories><ldap><role_mapping>` section of the `config.xml`.
'
+        '
'
+        ),
+    link=None,
+    level=4,
+    num='4.8.8.5')
+
+QA_SRS014_ClickHouse_LDAP_Role_Mapping = Specification(
+    name='QA-SRS014 ClickHouse LDAP Role Mapping', 
+    description=None,
+    author='vzakaznikov',
+    date='December 4, 2020', 
+    status='-', 
+    approved_by='-',
+    approved_date='-',
+    approved_version='-',
+    version=None,
+    group=None,
+    type=None,
+    link=None,
+    uid=None,
+    parent=None,
+    children=None,
+    headings=(
+        Heading(name='Revision History', level=1, num='1'),
+        Heading(name='Introduction', level=1, num='2'),
+        Heading(name='Terminology', level=1, num='3'),
+        Heading(name='LDAP', level=2, num='3.1'),
+        Heading(name='Requirements', level=1, num='4'),
+        Heading(name='General', level=2, num='4.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping', level=3, num='4.1.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.WithFixedRoles', level=3, num='4.1.2'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Search', level=3, num='4.1.3'),
+        Heading(name='Mapped Role Names', level=2, num='4.2'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithUTF8Characters', level=3, num='4.2.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.Long', level=3, num='4.2.2'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithSpecialXMLCharacters', level=3, num='4.2.3'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithSpecialRegexCharacters', level=3, num='4.2.4'),
+        Heading(name='Multiple Roles', level=2, num='4.3'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Map.MultipleRoles', level=3, num='4.3.1'),
+        Heading(name='LDAP Groups', level=2, num='4.4'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.Removed', level=3, num='4.4.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.RemovedAndAdded.Parallel', level=3, num='4.4.2'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.UserRemoved', level=3, num='4.4.3'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.UserRemovedAndAdded.Parallel', level=3, num='4.4.4'),
+        Heading(name='RBAC Roles', level=2, num='4.5'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.NotPresent', level=3, num='4.5.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Added', level=3, num='4.5.2'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Removed', level=3, num='4.5.3'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Readded', level=3, num='4.5.4'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.RemovedAndAdded.Parallel', level=3, num='4.5.5'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.New', level=3, num='4.5.6'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.NewPrivilege', level=3, num='4.5.7'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.RemovedPrivilege', level=3, num='4.5.8'),
+        Heading(name='Authentication', level=2, num='4.6'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel', level=3, num='4.6.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.ValidAndInvalid', level=3, num='4.6.2'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.MultipleServers', level=3, num='4.6.3'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.LocalOnly', level=3, num='4.6.4'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.LocalAndMultipleLDAP', level=3, num='4.6.5'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.SameUser', level=3, num='4.6.6'),
+        Heading(name='Server Configuration', level=2, num='4.7'),
+        Heading(name='BindDN Parameter', level=3, num='4.7.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.Server.BindDN', level=4, num='4.7.1.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.Server.BindDN.ConflictWith.AuthDN', level=4, num='4.7.1.2'),
+        Heading(name='External User Directory Configuration', level=2, num='4.8'),
+        Heading(name='Syntax', level=3, num='4.8.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Syntax', level=4, num='4.8.1.1'),
+        Heading(name='Special Characters Escaping', level=3, num='4.8.2'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.SpecialCharactersEscaping', level=4, num='4.8.2.1'),
+        Heading(name='Multiple Sections', level=3, num='4.8.3'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.MultipleSections', level=4, num='4.8.3.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.MultipleSections.IdenticalParameters', level=4, num='4.8.3.2'),
+        Heading(name='BaseDN Parameter', level=3, num='4.8.4'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.BaseDN', level=4, num='4.8.4.1'),
+        Heading(name='Attribute Parameter', level=3, num='4.8.5'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Attribute', level=4, num='4.8.5.1'),
+        Heading(name='Scope Parameter', level=3, num='4.8.6'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope', level=4, num='4.8.6.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Base', level=4, num='4.8.6.2'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.OneLevel', level=4, num='4.8.6.3'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Children', level=4, num='4.8.6.4'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Subtree', level=4, num='4.8.6.5'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Default', level=4, num='4.8.6.6'),
+        Heading(name='Search Filter Parameter', level=3, num='4.8.7'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.SearchFilter', level=4, num='4.8.7.1'),
+        Heading(name='Prefix Parameter', level=3, num='4.8.8'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix', level=4, num='4.8.8.1'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.Default', level=4, num='4.8.8.2'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithUTF8Characters', level=4, num='4.8.8.3'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithSpecialXMLCharacters', level=4, num='4.8.8.4'),
+        Heading(name='RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithSpecialRegexCharacters', level=4, num='4.8.8.5'),
+        Heading(name='References', level=1, num='5'),
+        ),
+    requirements=(
+        RQ_SRS_014_LDAP_RoleMapping,
+        RQ_SRS_014_LDAP_RoleMapping_WithFixedRoles,
+        RQ_SRS_014_LDAP_RoleMapping_Search,
+        RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_WithUTF8Characters,
+        RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_Long,
+        RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_WithSpecialXMLCharacters,
+        RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_WithSpecialRegexCharacters,
+        RQ_SRS_014_LDAP_RoleMapping_Map_MultipleRoles,
+        RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_Removed,
+        RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_RemovedAndAdded_Parallel,
+        RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_UserRemoved,
+        RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_UserRemovedAndAdded_Parallel,
+        RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_NotPresent,
+        RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_Added,
+        RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_Removed,
+        RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_Readded,
+        RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_RemovedAndAdded_Parallel,
+        RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_New,
+        RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_NewPrivilege,
+        RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_RemovedPrivilege,
+        RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel,
+        RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_ValidAndInvalid,
+        RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_MultipleServers,
+        RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_LocalOnly,
+        RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_LocalAndMultipleLDAP,
+        RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_SameUser,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_Server_BindDN,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_Server_BindDN_ConflictWith_AuthDN,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Syntax,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_SpecialCharactersEscaping,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_MultipleSections,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_MultipleSections_IdenticalParameters,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_BaseDN,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Attribute,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope_Value_Base,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope_Value_OneLevel,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope_Value_Children,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope_Value_Subtree,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Scope_Value_Default,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_SearchFilter,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_Default,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_WithUTF8Characters,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_WithSpecialXMLCharacters,
+        RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_WithSpecialRegexCharacters,
+        ),
+    content='''
+# QA-SRS014 ClickHouse LDAP Role Mapping
+# Software Requirements Specification
+
+(c) 2020 Altinity LTD. All Rights Reserved.
+
+**Document status:** Confidential
+
+**Author:** vzakaznikov
+
+**Date:** December 4, 2020
+
+## Approval
+
+**Status:** -
+
+**Version:** -
+
+**Approved by:** -
+
+**Date:** -
+
+## Table of Contents
+
+* 1 [Revision History](#revision-history)
+* 2 [Introduction](#introduction)
+* 3 [Terminology](#terminology)
+  * 3.1 [LDAP](#ldap)
+* 4 [Requirements](#requirements)
+  * 4.1 [General](#general)
+    * 4.1.1 [RQ.SRS-014.LDAP.RoleMapping](#rqsrs-014ldaprolemapping)
+    * 4.1.2 [RQ.SRS-014.LDAP.RoleMapping.WithFixedRoles](#rqsrs-014ldaprolemappingwithfixedroles)
+    * 4.1.3 [RQ.SRS-014.LDAP.RoleMapping.Search](#rqsrs-014ldaprolemappingsearch)
+  * 4.2 [Mapped Role Names](#mapped-role-names)
+    * 4.2.1 [RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithUTF8Characters](#rqsrs-014ldaprolemappingmaprolenamewithutf8characters)
+    * 4.2.2 [RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.Long](#rqsrs-014ldaprolemappingmaprolenamelong)
+    * 4.2.3 [RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithSpecialXMLCharacters](#rqsrs-014ldaprolemappingmaprolenamewithspecialxmlcharacters)
+    * 4.2.4 [RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithSpecialRegexCharacters](#rqsrs-014ldaprolemappingmaprolenamewithspecialregexcharacters)
+  * 4.3 [Multiple Roles](#multiple-roles)
+    * 4.3.1 [RQ.SRS-014.LDAP.RoleMapping.Map.MultipleRoles](#rqsrs-014ldaprolemappingmapmultipleroles)
+  * 4.4 [LDAP Groups](#ldap-groups)
+    * 4.4.1 [RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.Removed](#rqsrs-014ldaprolemappingldapgroupremoved)
+    * 4.4.2 [RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.RemovedAndAdded.Parallel](#rqsrs-014ldaprolemappingldapgroupremovedandaddedparallel)
+    * 4.4.3 [RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.UserRemoved](#rqsrs-014ldaprolemappingldapgroupuserremoved)
+    * 4.4.4 [RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.UserRemovedAndAdded.Parallel](#rqsrs-014ldaprolemappingldapgroupuserremovedandaddedparallel)
+  * 4.5 [RBAC Roles](#rbac-roles)
+    * 4.5.1 [RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.NotPresent](#rqsrs-014ldaprolemappingrbacrolenotpresent)
+    * 4.5.2 [RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Added](#rqsrs-014ldaprolemappingrbacroleadded)
+    * 4.5.3 [RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Removed](#rqsrs-014ldaprolemappingrbacroleremoved)
+    * 4.5.4 [RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Readded](#rqsrs-014ldaprolemappingrbacrolereadded)
+    * 4.5.5 [RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.RemovedAndAdded.Parallel](#rqsrs-014ldaprolemappingrbacroleremovedandaddedparallel)
+    * 4.5.6 [RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.New](#rqsrs-014ldaprolemappingrbacrolenew)
+    * 4.5.7 [RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.NewPrivilege](#rqsrs-014ldaprolemappingrbacrolenewprivilege)
+    * 4.5.8 [RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.RemovedPrivilege](#rqsrs-014ldaprolemappingrbacroleremovedprivilege)
+  * 4.6 [Authentication](#authentication)
+    * 4.6.1 [RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel](#rqsrs-014ldaprolemappingauthenticationparallel)
+    * 4.6.2 [RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.ValidAndInvalid](#rqsrs-014ldaprolemappingauthenticationparallelvalidandinvalid)
+    * 4.6.3 [RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.MultipleServers](#rqsrs-014ldaprolemappingauthenticationparallelmultipleservers)
+    * 4.6.4 [RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.LocalOnly](#rqsrs-014ldaprolemappingauthenticationparallellocalonly)
+    * 4.6.5 [RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.LocalAndMultipleLDAP](#rqsrs-014ldaprolemappingauthenticationparallellocalandmultipleldap)
+    * 4.6.6 [RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.SameUser](#rqsrs-014ldaprolemappingauthenticationparallelsameuser)
+  * 4.7 [Server Configuration](#server-configuration)
+    * 4.7.1 [BindDN Parameter](#binddn-parameter)
+      * 4.7.1.1 [RQ.SRS-014.LDAP.RoleMapping.Configuration.Server.BindDN](#rqsrs-014ldaprolemappingconfigurationserverbinddn)
+      * 4.7.1.2 [RQ.SRS-014.LDAP.RoleMapping.Configuration.Server.BindDN.ConflictWith.AuthDN](#rqsrs-014ldaprolemappingconfigurationserverbinddnconflictwithauthdn)
+  * 4.8 [External User Directory Configuration](#external-user-directory-configuration)
+    * 4.8.1 [Syntax](#syntax)
+      * 4.8.1.1 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Syntax](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingsyntax)
+    * 4.8.2 [Special Characters Escaping](#special-characters-escaping)
+      * 4.8.2.1 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.SpecialCharactersEscaping](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingspecialcharactersescaping)
+    * 4.8.3 [Multiple Sections](#multiple-sections)
+      * 4.8.3.1 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.MultipleSections](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingmultiplesections)
+      * 4.8.3.2 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.MultipleSections.IdenticalParameters](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingmultiplesectionsidenticalparameters)
+    * 4.8.4 [BaseDN Parameter](#basedn-parameter)
+      * 4.8.4.1 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.BaseDN](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingbasedn)
+    * 4.8.5 [Attribute Parameter](#attribute-parameter)
+      * 4.8.5.1 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Attribute](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingattribute)
+    * 4.8.6 [Scope Parameter](#scope-parameter)
+      * 4.8.6.1 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingscope)
+      * 4.8.6.2 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Base](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingscopevaluebase)
+      * 4.8.6.3 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.OneLevel](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingscopevalueonelevel)
+      * 4.8.6.4 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Children](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingscopevaluechildren)
+      * 4.8.6.5 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Subtree](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingscopevaluesubtree)
+      * 4.8.6.6 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Default](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingscopevaluedefault)
+    * 4.8.7 [Search Filter Parameter](#search-filter-parameter)
+      * 4.8.7.1 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.SearchFilter](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingsearchfilter)
+    * 4.8.8 [Prefix Parameter](#prefix-parameter)
+      * 4.8.8.1 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingprefix)
+      * 4.8.8.2 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.Default](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingprefixdefault)
+      * 4.8.8.3 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithUTF8Characters](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingprefixwithutf8characters)
+      * 4.8.8.4 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithSpecialXMLCharacters](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingprefixwithspecialxmlcharacters)
+      * 4.8.8.5 [RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithSpecialRegexCharacters](#rqsrs-014ldaprolemappingconfigurationuserdirectoryrolemappingprefixwithspecialregexcharacters)
+* 5 [References](#references)
+
+## Revision History
+
+This document is stored in an electronic form using [Git] source control management software
+hosted in a [GitLab Repository].
+All the updates are tracked using the [Revision History].
+
+## Introduction
+
+The [QA-SRS007 ClickHouse Authentication of Users via LDAP] added support for authenticating
+users using an [LDAP] server and the [QA-SRS009 ClickHouse LDAP External User Directory] added
+support for authenticating users using an [LDAP] external user directory. 
+
+This requirements specification adds additional functionality for mapping [LDAP] groups to 
+the corresponding [ClickHouse] [RBAC] roles when [LDAP] external user directory is configured.
+This functionality will enable easier access management for [LDAP] authenticated users
+as the privileges granted by the roles can be granted or revoked by granting or revoking
+a corresponding [LDAP] group to one or more [LDAP] users.
+
+For the use case when only [LDAP] user authentication is used, the roles can be
+managed using [RBAC] in the same way as for non-[LDAP] authenticated users.
+
+## Terminology
+
+### LDAP
+
+* Lightweight Directory Access Protocol
+
+## Requirements
+
+### General
+
+#### RQ.SRS-014.LDAP.RoleMapping
+version: 1.0
+
+[ClickHouse] SHALL support mapping of [LDAP] groups to [RBAC] roles
+for users authenticated using [LDAP] external user directory.
+
+#### RQ.SRS-014.LDAP.RoleMapping.WithFixedRoles
+version: 1.0
+
+[ClickHouse] SHALL support mapping of [LDAP] groups to [RBAC] roles
+for users authenticated using [LDAP] external user directory when
+one or more roles are specified in the `<roles>` section.
+
+#### RQ.SRS-014.LDAP.RoleMapping.Search
+version: 1.0
+
+[ClickHouse] SHALL perform search on the [LDAP] server and map the results to [RBAC] role names 
+when authenticating users using the [LDAP] external user directory if the `<role_mapping>` section is configured
+as part of the [LDAP] external user directory. The matched roles SHALL be assigned to the user.
+
+### Mapped Role Names
+
+#### RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithUTF8Characters
+version: 1.0
+
+[ClickHouse] SHALL support mapping [LDAP] search results for users authenticated using [LDAP] external user directory
+to an [RBAC] role that contains UTF-8 characters.
+
+#### RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.Long
+version: 1.0
+
+[ClickHouse] SHALL support mapping [LDAP] search results for users authenticated using [LDAP] external user directory
+to an [RBAC] role that has a name with more than 128 characters.
+
+#### RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithSpecialXMLCharacters
+version: 1.0
+
+[ClickHouse] SHALL support mapping [LDAP] search results for users authenticated using [LDAP] external user directory
+to an [RBAC] role that has a name that contains special characters that need to be escaped in XML.
+
+#### RQ.SRS-014.LDAP.RoleMapping.Map.Role.Name.WithSpecialRegexCharacters
+version: 1.0
+
+[ClickHouse] SHALL support mapping [LDAP] search results for users authenticated using [LDAP] external user directory
+to an [RBAC] role that has a name that contains special characters that need to be escaped in regex.
+
+### Multiple Roles
+
+#### RQ.SRS-014.LDAP.RoleMapping.Map.MultipleRoles
+version: 1.0
+
+[ClickHouse] SHALL support mapping one or more [LDAP] search results for users authenticated using 
+[LDAP] external user directory to one or more [RBAC] role.
+
+### LDAP Groups
+
+#### RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.Removed
+version: 1.0
+
+[ClickHouse] SHALL not assign [RBAC] role(s) for any users authenticated using [LDAP] external user directory
+if the corresponding [LDAP] group(s) that map those role(s) are removed. Any users that have active sessions SHALL still
+have privileges provided by the role(s) until the next time they are authenticated.
+
+#### RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.RemovedAndAdded.Parallel
+version: 1.0
+
+[ClickHouse] SHALL support authenticating users using [LDAP] external user directory 
+when [LDAP] groups are removed and added 
+at the same time as [LDAP] user authentications are performed in parallel.
+
+#### RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.UserRemoved
+version: 1.0
+
+[ClickHouse] SHALL not assign [RBAC] role(s) for the user authenticated using [LDAP] external user directory
+if the user has been removed from the corresponding [LDAP] group(s) that map those role(s). 
+Any active user sessions SHALL have privileges provided by the role(s) until the next time the user is authenticated.
+
+#### RQ.SRS-014.LDAP.RoleMapping.LDAP.Group.UserRemovedAndAdded.Parallel
+version: 1.0
+
+[ClickHouse] SHALL support authenticating users using [LDAP] external user directory
+when [LDAP] users are added and removed from [LDAP] groups used to map to [RBAC] roles
+at the same time as [LDAP] user authentications are performed in parallel.
+
+### RBAC Roles
+
+#### RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.NotPresent
+version: 1.0
+
+[ClickHouse] SHALL not reject authentication attempt using [LDAP] external user directory if any of the roles that are 
+are mapped from [LDAP] but are not present locally.
+
+#### RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Added
+version: 1.0
+
+[ClickHouse] SHALL add the privileges provided by the [LDAP] mapped role when the
+role is not present during user authentication using [LDAP] external user directory
+as soon as the role is added.
+
+#### RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Removed
+version: 1.0
+
+[ClickHouse] SHALL remove the privileges provided by the role from all the
+users authenticated using [LDAP] external user directory if the [RBAC] role that was mapped
+as a result of [LDAP] search is removed.
+
+#### RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.Readded
+version: 1.0
+
+[ClickHouse] SHALL reassign the [RBAC] role and add all the privileges provided by the role
+when it is re-added after removal for all [LDAP] users authenticated using external user directory
+for any role that was mapped as a result of [LDAP] search.
+
+#### RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.RemovedAndAdded.Parallel
+version: 1.0
+
+[ClickHouse] SHALL support authenticating users using [LDAP] external user directory
+when [RBAC] roles that are mapped by [LDAP] groups
+are added and removed at the same time as [LDAP] user authentications are performed in parallel.
+
+#### RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.New
+version: 1.0
+
+[ClickHouse] SHALL not allow any new roles to be assigned to any
+users authenticated using [LDAP] external user directory unless the role is specified
+in the configuration of the external user directory or was mapped as a result of [LDAP] search.
+
+#### RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.NewPrivilege
+version: 1.0
+
+[ClickHouse] SHALL add new privilege to all the users authenticated using [LDAP] external user directory
+when new privilege is added to one of the roles that were mapped as a result of [LDAP] search.
+
+#### RQ.SRS-014.LDAP.RoleMapping.RBAC.Role.RemovedPrivilege
+version: 1.0
+
+[ClickHouse] SHALL remove privilege from all the users authenticated using [LDAP] external user directory
+when the privilege that was provided by the mapped role is removed from all the roles 
+that were mapped as a result of [LDAP] search.
+
+### Authentication
+
+#### RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel
+version: 1.0
+
+[ClickHouse] SHALL support parallel authentication of users using [LDAP] server
+when using [LDAP] external user directory that has role mapping enabled.
+
+#### RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.ValidAndInvalid
+version: 1.0
+
+[ClickHouse] SHALL support authentication of valid users and
+prohibit authentication of invalid users using [LDAP] server
+in parallel without having invalid attempts affecting valid authentications
+when using [LDAP] external user directory that has role mapping enabled.
+
+#### RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.MultipleServers
+version: 1.0
+
+[ClickHouse] SHALL support parallel authentication of external [LDAP] users
+authenticated using multiple [LDAP] external user directories that have
+role mapping enabled.
+
+#### RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.LocalOnly
+version: 1.0
+
+[ClickHouse] SHALL support parallel authentication of users defined only locally
+when one or more [LDAP] external user directories with role mapping
+are specified in the configuration file.
+
+#### RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.LocalAndMultipleLDAP
+version: 1.0
+
+[ClickHouse] SHALL support parallel authentication of local and external [LDAP] users
+authenticated using multiple [LDAP] external user directories with role mapping enabled.
+
+#### RQ.SRS-014.LDAP.RoleMapping.Authentication.Parallel.SameUser
+version: 1.0
+
+[ClickHouse] SHALL support parallel authentication of the same external [LDAP] user
+authenticated using the same [LDAP] external user directory with role mapping enabled.
+
+### Server Configuration
+
+#### BindDN Parameter
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.Server.BindDN
+version: 1.0
+
+[ClickHouse] SHALL support the `<bind_dn>` parameter in the `<ldap_servers><server_name>` section
+of the `config.xml` that SHALL be used to construct the `DN` to bind to.
+The resulting `DN` SHALL be constructed by replacing all `{user_name}` substrings of the template 
+with the actual user name during each authentication attempt.
+
+For example, 
+
+```xml
+<yandex>
+    <ldap_servers>
+        <my_ldap_server>
+            <!-- ... -->
+            <bind_dn>uid={user_name},ou=users,dc=example,dc=com</bind_dn>
+            <!-- ... -->
+        </my_ldap_server>
+    </ldap_servers>
+</yandex>
+```
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.Server.BindDN.ConflictWith.AuthDN
+version: 1.0
+
+[ClickHouse] SHALL return an error if both `<bind_dn>` and `<auth_dn_prefix>` or `<auth_dn_suffix>` parameters
+are specified as part of [LDAP] server description in the `<ldap_servers>` section of the `config.xml`.
+
+### External User Directory Configuration
+
+#### Syntax
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Syntax
+version: 1.0
+
+[ClickHouse] SHALL support the `role_mapping` sub-section in the `<user_directories><ldap>` section
+of the `config.xml`.
+
+For example,
+
+```xml
+<yandex>
+    <user_directories>
+        <ldap>
+            <!-- ... -->
+            <role_mapping>
+                <base_dn>ou=groups,dc=example,dc=com</base_dn>
+                <attribute>cn</attribute>
+                <scope>subtree</scope>
+                <search_filter>(&amp;(objectClass=groupOfNames)(member={bind_dn}))</search_filter>
+                <prefix>clickhouse_</prefix>
+            </role_mapping>
+        </ldap>
+    </user_directories>
+</yandex>
+```
+
+#### Special Characters Escaping
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.SpecialCharactersEscaping
+version: 1.0
+
+[ClickHouse] SHALL support properly escaped special XML characters that can be present
+as part of the values for different configuration parameters inside the
+`<user_directories><ldap><role_mapping>` section of the `config.xml` such as
+
+* `<search_filter>` parameter
+* `<prefix>` parameter
+
+#### Multiple Sections
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.MultipleSections
+version: 1.0
+
+[ClickHouse] SHALL support multiple `<role_mapping>` sections defined inside the same `<user_directories><ldap>` section 
+of the `config.xml` and all of the `<role_mapping>` sections SHALL be applied.
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.MultipleSections.IdenticalParameters
+version: 1.0
+
+[ClickHouse] SHALL not duplicate mapped roles when multiple `<role_mapping>` sections 
+with identical parameters are defined inside the `<user_directories><ldap>` section 
+of the `config.xml`.
+
+#### BaseDN Parameter
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.BaseDN
+version: 1.0
+
+[ClickHouse] SHALL support the `<base_dn>` parameter in the `<user_directories><ldap><role_mapping>` section 
+of the `config.xml` that SHALL specify the template to be used to construct the base `DN` for the [LDAP] search.
+
+The resulting `DN` SHALL be constructed by replacing all the `{user_name}` and `{bind_dn}` substrings of 
+the template with the actual user name and bind `DN` during each [LDAP] search.
+
+#### Attribute Parameter
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Attribute
+version: 1.0
+
+[ClickHouse] SHALL support the `<attribute>` parameter in the `<user_directories><ldap><role_mapping>` section of 
+the `config.xml` that SHALL specify the name of the attribute whose values SHALL be returned by the [LDAP] search.
+
+#### Scope Parameter
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope
+version: 1.0
+
+[ClickHouse] SHALL support the `<scope>` parameter in the `<user_directories><ldap><role_mapping>` section of 
+the `config.xml` that SHALL define the scope of the LDAP search as defined 
+by the https://ldapwiki.com/wiki/LDAP%20Search%20Scopes.
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Base
+version: 1.0
+
+[ClickHouse] SHALL support the `base` value for the the `<scope>` parameter in the 
+`<user_directories><ldap><role_mapping>` section of the `config.xml` that SHALL
+limit the scope as specified by the https://ldapwiki.com/wiki/BaseObject.
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.OneLevel
+version: 1.0
+
+[ClickHouse] SHALL support the `one_level` value for the the `<scope>` parameter in the 
+`<user_directories><ldap><role_mapping>` section of the `config.xml` that SHALL
+limit the scope as specified by the https://ldapwiki.com/wiki/SingleLevel.
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Children
+version: 1.0
+
+[ClickHouse] SHALL support the `children` value for the the `<scope>` parameter in the 
+`<user_directories><ldap><role_mapping>` section of the `config.xml` that SHALL
+limit the scope as specified by the https://ldapwiki.com/wiki/SubordinateSubtree.
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Subtree
+version: 1.0
+
+[ClickHouse] SHALL support the `children` value for the the `<scope>` parameter in the 
+`<user_directories><ldap><role_mapping>` section of the `config.xml` that SHALL
+limit the scope as specified by the https://ldapwiki.com/wiki/WholeSubtree.
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Scope.Value.Default
+version: 1.0
+
+[ClickHouse] SHALL support the `subtree` as the default value for the the `<scope>` parameter in the 
+`<user_directories><ldap><role_mapping>` section of the `config.xml` when the `<scope>` parameter is not specified.
+
+#### Search Filter Parameter
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.SearchFilter
+version: 1.0
+
+[ClickHouse] SHALL support the `<search_filter>` parameter in the `<user_directories><ldap><role_mapping>`
+section of the `config.xml` that SHALL specify the template used to construct 
+the [LDAP filter](https://ldap.com/ldap-filters/) for the search.
+
+The resulting filter SHALL be constructed by replacing all `{user_name}`, `{bind_dn}`, and `{base_dn}` substrings 
+of the template with the actual user name, bind `DN`, and base `DN` during each the [LDAP] search.
+ 
+#### Prefix Parameter
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix
+version: 1.0
+
+[ClickHouse] SHALL support the `<prefix>` parameter in the `<user directories><ldap><role_mapping>`
+section of the `config.xml` that SHALL be expected to be in front of each string in 
+the original list of strings returned by the [LDAP] search. 
+Prefix SHALL be removed from the original strings and resulting strings SHALL be treated as [RBAC] role names. 
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.Default
+version: 1.0
+
+[ClickHouse] SHALL support empty string as the default value of the `<prefix>` parameter in 
+the `<user directories><ldap><role_mapping>` section of the `config.xml`.
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithUTF8Characters
+version: 1.0
+
+[ClickHouse] SHALL support UTF8 characters as the value of the `<prefix>` parameter in
+the `<user directories><ldap><role_mapping>` section of the `config.xml`.
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithSpecialXMLCharacters
+version: 1.0
+
+[ClickHouse] SHALL support XML special characters as the value of the `<prefix>` parameter in
+the `<user directories><ldap><role_mapping>` section of the `config.xml`.
+
+##### RQ.SRS-014.LDAP.RoleMapping.Configuration.UserDirectory.RoleMapping.Prefix.WithSpecialRegexCharacters
+version: 1.0
+
+[ClickHouse] SHALL support regex special characters as the value of the `<prefix>` parameter in
+the `<user directories><ldap><role_mapping>` section of the `config.xml`.
+
+## References
+
+* **Access Control and Account Management**: https://clickhouse.tech/docs/en/operations/access-rights/
+* **LDAP**: https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol
+* **ClickHouse:** https://clickhouse.tech
+* **GitLab Repository**: https://gitlab.com/altinity-qa/documents/qa-srs014-clickhouse-ldap-role-mapping/-/blob/master/QA_SRS014_ClickHouse_LDAP_Role_Mapping.md
+* **Revision History**: https://gitlab.com/altinity-qa/documents/qa-srs014-clickhouse-ldap-role-mapping/-/commits/master/QA_SRS014_ClickHouse_LDAP_Role_Mapping.md
+* **Git:** https://git-scm.com/
+
+[RBAC]: https://clickhouse.tech/docs/en/operations/access-rights/
+[SRS]: #srs
+[Access Control and Account Management]: https://clickhouse.tech/docs/en/operations/access-rights/
+[QA-SRS009 ClickHouse LDAP External User Directory]: https://gitlab.com/altinity-qa/documents/qa-srs009-clickhouse-ldap-external-user-directory/-/blob/master/QA_SRS009_ClickHouse_LDAP_External_User_Directory.md
+[QA-SRS007 ClickHouse Authentication of Users via LDAP]: https://gitlab.com/altinity-qa/documents/qa-srs007-clickhouse-athentication-of-users-via-ldap/-/blob/master/QA_SRS007_ClickHouse_Authentication_of_Users_via_LDAP.md
+[LDAP]: https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol
+[ClickHouse]: https://clickhouse.tech
+[GitLab Repository]: https://gitlab.com/altinity-qa/documents/qa-srs014-clickhouse-ldap-role-mapping/-/blob/master/QA_SRS014_ClickHouse_LDAP_Role_Mapping.md
+[Revision History]: https://gitlab.com/altinity-qa/documents/qa-srs014-clickhouse-ldap-role-mapping/-/commits/master/QA_SRS014_ClickHouse_LDAP_Role_Mapping.md
+[Git]: https://git-scm.com/
+[GitLab]: https://gitlab.com
+''')
diff --git a/tests/testflows/ldap/role_mapping/tests/common.py b/tests/testflows/ldap/role_mapping/tests/common.py
new file mode 100644
index 000000000000..33ad4a46f526
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/tests/common.py
@@ -0,0 +1,252 @@
+import os
+
+from testflows.core import *
+from testflows.asserts import error
+
+from ldap.authentication.tests.common import getuid, create_ldap_servers_config_content, add_config, Config
+from ldap.external_user_directory.tests.common import rbac_roles, rbac_users, ldap_users
+from ldap.authentication.tests.common import xmltree, xml_indent, xml_append, xml_with_utf8
+
+@TestStep(Given)
+def create_table(self, name, create_statement, on_cluster=False):
+    """Create table.
+    """
+    node = current().context.node
+    try:
+        with Given(f"I have a {name} table"):
+            node.query(create_statement.format(name=name))
+        yield name
+    finally:
+        with Finally("I drop the table"):
+            if on_cluster:
+                node.query(f"DROP TABLE IF EXISTS {name} ON CLUSTER {on_cluster}")
+            else:
+                node.query(f"DROP TABLE IF EXISTS {name}")
+
+@TestStep(Given)
+def add_ldap_servers_configuration(self, servers, config_d_dir="/etc/clickhouse-server/config.d",
+        config_file="ldap_servers.xml", timeout=60, restart=False):
+    """Add LDAP servers configuration to config.xml.
+    """
+    config = create_ldap_servers_config_content(servers, config_d_dir, config_file)
+    return add_config(config, restart=restart)
+
+@TestStep(Given)
+def add_ldap_groups(self, groups, node=None):
+    """Add multiple new groups to the LDAP server.
+    """
+    try:
+        _groups = []
+        for group in groups:
+            with By(f"adding group {group['cn']}"):
+                _groups.append(add_group_to_ldap(**group, node=node))
+        yield _groups
+    finally:
+        with Finally(f"I delete groups from LDAP"):
+            for _group in _groups:
+                delete_group_from_ldap(_group, node=node)
+
+@TestStep(Given)
+def add_ldap_external_user_directory(self, server, roles=None, role_mappings=None,
+        config_d_dir="/etc/clickhouse-server/config.d",
+        config_file=None, timeout=60, restart=True, config=None):
+    """Add LDAP external user directory.
+    """
+    if config_file is None:
+        config_file = f"ldap_external_user_directory_with_role_mapping_{getuid()}.xml"
+
+    if config is None:
+        config = create_ldap_external_user_directory_config_content(server=server, roles=roles,
+            role_mappings=role_mappings, config_d_dir=config_d_dir, config_file=config_file)
+
+    return add_config(config, restart=restart)
+
+@TestStep(Given)
+def add_rbac_roles(self, roles):
+    """Add RBAC roles.
+    """
+    with rbac_roles(*roles) as _roles:
+        yield _roles
+
+@TestStep(Given)
+def add_rbac_users(self, users):
+    """Add RBAC users.
+    """
+    with rbac_users(*users) as _users:
+        yield _users
+
+@TestStep(Given)
+def add_ldap_users(self, users, node=None):
+    """Add LDAP users.
+    """
+    with ldap_users(*users, node=node) as _users:
+        yield _users
+
+def add_group_to_ldap(cn, gidnumber=None, node=None, _gidnumber=[600], exitcode=0):
+    """Add new group entry to LDAP.
+    """
+    _gidnumber[0] += 1
+
+    if node is None:
+        node = current().context.ldap_node
+
+    if gidnumber is None:
+        gidnumber = _gidnumber[0]
+
+    group = {
+        "dn": f"cn={cn},ou=groups,dc=company,dc=com",
+        "objectclass": ["top", "groupOfUniqueNames"],
+        "uniquemember": "cn=admin,dc=company,dc=com",
+        "_server": node.name
+    }
+
+    lines = []
+
+    for key, value in list(group.items()):
+        if key.startswith("_"):
+            continue
+        elif type(value) is list:
+            for v in value:
+                lines.append(f"{key}: {v}")
+        else:
+            lines.append(f"{key}: {value}")
+
+    ldif = "
".join(lines)
+
+    r = node.command(
+        f"echo -e \"{ldif}\" | ldapadd -x -H ldap://localhost -D \"cn=admin,dc=company,dc=com\" -w admin")
+
+    if exitcode is not None:
+        assert r.exitcode == exitcode, error()
+
+    return group
+
+def delete_group_from_ldap(group, node=None, exitcode=0):
+    """Delete group entry from LDAP.
+    """
+    if node is None:
+        node = current().context.ldap_node
+
+    with By(f"deleting group {group['dn']}"):
+        r = node.command(
+            f"ldapdelete -x -H ldap://localhost -D \"cn=admin,dc=company,dc=com\" -w admin \"{group['dn']}\"")
+
+    if exitcode is not None:
+        assert r.exitcode == exitcode, error()
+
+def fix_ldap_permissions(node=None, exitcode=0):
+    """Fix LDAP access permissions.
+    """
+    if node is None:
+        node = current().context.ldap_node
+
+    ldif = (
+        "dn: olcDatabase={1}mdb,cn=config
"
+        "changetype: modify
"
+        "delete: olcAccess
"
+        "-
"
+        "add: olcAccess
"
+        "olcAccess: to attrs=userPassword,shadowLastChange by self write by dn=\\\"cn=admin,dc=company,dc=com\\\" write by anonymous auth by * none
"
+        "olcAccess: to * by self write by dn=\\\"cn=admin,dc=company,dc=com\\\" read by users read by * none"
+    )
+
+    r = node.command(
+        f"echo -e \"{ldif}\" | ldapmodify -Y EXTERNAL -Q -H ldapi:///")
+
+    if exitcode is not None:
+        assert r.exitcode == exitcode, error()
+
+def add_user_to_group_in_ldap(user, group, node=None, exitcode=0):
+    """Add user to a group in LDAP.
+    """
+    if node is None:
+        node = current().context.ldap_node
+
+    ldif = (f"dn: {group['dn']}
"
+        "changetype: modify
"
+        "add: uniquemember
"
+        f"uniquemember: {user['dn']}")
+
+    with By(f"adding user {user['dn']} to group {group['dn']}"):
+        r = node.command(
+            f"echo -e \"{ldif}\" | ldapmodify -x -H ldap://localhost -D \"cn=admin,dc=company,dc=com\" -w admin")
+
+    if exitcode is not None:
+        assert r.exitcode == exitcode, error()
+
+def delete_user_from_group_in_ldap(user, group, node=None, exitcode=0):
+    """Delete user from a group in LDAP.
+    """
+    if node is None:
+        node = current().context.ldap_node
+
+    ldif = (f"dn: {group['dn']}
"
+        "changetype: modify
"
+        "delete: uniquemember
"
+        f"uniquemember: {user['dn']}")
+
+    with By(f"deleting user {user['dn']} from group {group['dn']}"):
+        r = node.command(
+            f"echo -e \"{ldif}\" | ldapmodify -x -H ldap://localhost -D \"cn=admin,dc=company,dc=com\" -w admin")
+
+    if exitcode is not None:
+        assert r.exitcode == exitcode, error()
+
+def create_xml_config_content(entries, config_d_dir="/etc/clickhouse-server/config.d",
+        config_file="ldap_external_user_directories.xml"):
+    """Create XML configuration file from a dictionary.
+    """
+    uid = getuid()
+    path = os.path.join(config_d_dir, config_file)
+    name = config_file
+    root = xmltree.Element("yandex")
+    root.append(xmltree.Comment(text=f"config uid: {uid}"))
+
+    def create_xml_tree(entries, root):
+        for k,v in entries.items():
+            if type(v) is dict:
+                xml_element = xmltree.Element(k)
+                create_xml_tree(v, xml_element)
+                root.append(xml_element)
+            elif type(v) in (list, tuple):
+                xml_element = xmltree.Element(k)
+                for e in v:
+                    create_xml_tree(e, xml_element)
+                root.append(xml_element)
+            else:
+                xml_append(root, k, v)
+
+    create_xml_tree(entries, root)
+    xml_indent(root)
+    content = xml_with_utf8 + str(xmltree.tostring(root, short_empty_elements=False, encoding="utf-8"), "utf-8")
+
+    return Config(content, path, name, uid, "config.xml")
+
+def create_ldap_external_user_directory_config_content(server=None, roles=None, role_mappings=None, **kwargs):
+    """Create LDAP external user directory configuration file content.
+    """
+    entries = {
+        "user_directories": {
+            "ldap": {
+            }
+        }
+    }
+
+    entries["user_directories"]["ldap"] = []
+
+    if server:
+        entries["user_directories"]["ldap"].append({"server": server})
+
+    if roles:
+        entries["user_directories"]["ldap"].append({"roles": [{r: None} for r in roles]})
+
+    if role_mappings:
+        for role_mapping in role_mappings:
+            entries["user_directories"]["ldap"].append({"role_mapping": role_mapping})
+
+    return create_xml_config_content(entries, **kwargs)
+
+def create_entries_ldap_external_user_directory_config_content(entries, **kwargs):
+    """Create LDAP external user directory configuration file content.
+    """
+    return create_xml_config_content(entries, **kwargs)
\ No newline at end of file
diff --git a/tests/testflows/ldap/role_mapping/tests/mapping.py b/tests/testflows/ldap/role_mapping/tests/mapping.py
new file mode 100644
index 000000000000..971881997821
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/tests/mapping.py
@@ -0,0 +1,1372 @@
+# -*- coding: utf-8 -*-
+from testflows.core import *
+from testflows.asserts import error
+
+from multiprocessing.dummy import Pool
+
+from ldap.role_mapping.requirements import *
+from ldap.role_mapping.tests.common import *
+from ldap.external_user_directory.tests.common import join, randomword
+
+from ldap.external_user_directory.tests.authentications import login_with_valid_username_and_password
+from ldap.external_user_directory.tests.authentications import login_with_invalid_username_and_valid_password
+from ldap.external_user_directory.tests.authentications import login_with_valid_username_and_invalid_password
+
+def remove_ldap_groups_in_parallel(groups, i, iterations=10):
+    """Remove LDAP groups.
+    """
+    with When(f"LDAP groups are removed #{i}"):
+        for j in range(iterations):
+            for group in groups:
+                with When(f"I delete group #{j}", description=f"{group}"):
+                    delete_group_from_ldap(group, exitcode=None)
+
+def add_ldap_groups_in_parallel(ldap_user, names, i, iterations=10):
+    """Add LDAP groups.
+    """
+    with When(f"LDAP groups are added #{i}"):
+        for j in range(iterations):
+            for name in names:
+                with When(f"I add group {name} #{j}", description=f"{name}"):
+                    group = add_group_to_ldap(cn=name, exitcode=None)
+
+                    with When(f"I add user to the group"):
+                        add_user_to_group_in_ldap(user=ldap_user, group=group, exitcode=None)
+
+def add_user_to_ldap_groups_in_parallel(ldap_user, groups, i, iterations=10):
+    """Add user to LDAP groups.
+    """
+    with When(f"user is added to LDAP groups #{i}"):
+        for j in range(iterations):
+            for group in groups:
+                with When(f"I add user to the group {group['dn']} #{j}"):
+                    add_user_to_group_in_ldap(user=ldap_user, group=group, exitcode=None)
+
+def remove_user_from_ldap_groups_in_parallel(ldap_user, groups, i, iterations=10):
+    """Remove user from LDAP groups.
+    """
+    with When(f"user is removed from LDAP groups #{i}"):
+        for j in range(iterations):
+            for group in groups:
+                with When(f"I remove user from the group {group['dn']} #{j}"):
+                    delete_user_from_group_in_ldap(user=ldap_user, group=group, exitcode=None)
+
+def add_roles_in_parallel(role_names, i, iterations=10):
+    """Add roles.
+    """
+    with When(f"roles are added #{i}"):
+        for j in range(iterations):
+            for role_name in role_names:
+                with When(f"I add role {role_name} #{j}"):
+                    current().context.node.query(f"CREATE ROLE OR REPLACE {role_name}")
+
+def remove_roles_in_parallel(role_names, i, iterations=10):
+    """Remove roles.
+    """
+    with When(f"roles are removed #{i}"):
+        for j in range(iterations):
+            for role_name in role_names:
+                with When(f"I remove role {role_name} #{j}"):
+                    current().context.node.query(f"DROP ROLE IF EXISTS {role_name}")
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Map_MultipleRoles("1.0")
+)
+def multiple_roles(self, ldap_server, ldap_user):
+    """Check that users authenticated using LDAP external user directory
+    can be assigned multiple LDAP mapped roles.
+    """
+    uid = getuid()
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix":""
+        }
+    ]
+
+    with Given("I add LDAP groups"):
+        groups = add_ldap_groups(groups=({"cn": f"role0_{uid}"}, {"cn": f"role1_{uid}"}))
+
+    with And("I add LDAP user to each LDAP group"):
+        add_user_to_group_in_ldap(user=ldap_user, group=groups[0])
+        add_user_to_group_in_ldap(user=ldap_user, group=groups[1])
+
+    with And("I add RBAC roles"):
+        roles = add_rbac_roles(roles=(f"role0_{uid}", f"role1_{uid}"))
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    with When(f"I login as an LDAP user"):
+        r = self.context.node.query(f"SHOW GRANTS", settings=[
+            ("user", ldap_user["username"]), ("password", ldap_user["password"])])
+
+    with Then("I expect the user to have mapped LDAP roles"):
+        with By(f"checking that first role is assigned", description=f"{roles[0]}"):
+            assert roles[0] in r.output, error()
+        with And(f"checking that second role is also assigned", description=f"{roles[1]}"):
+            assert roles[1] in r.output, error()
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_WithFixedRoles("1.0")
+)
+def with_fixed_roles(self, ldap_server, ldap_user):
+    """Check that LDAP users can be assigned roles dynamically
+    and statically using the `<roles>` section.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}"
+    fixed_role_name = f"role_fixed_{uid}"
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+
+    with Given("I add LDAP group"):
+        groups = add_ldap_groups(groups=({"cn": role_name},))
+
+    with And("I add LDAP user to the group"):
+        add_user_to_group_in_ldap(user=ldap_user, group=groups[0])
+
+    with And("I add matching RBAC role"):
+        mapped_roles = add_rbac_roles(roles=(f"{role_name}",))
+
+    with And("I add an RBAC role that will be added statically"):
+        roles = add_rbac_roles(roles=(f"{fixed_role_name}",))
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, roles=roles, restart=True)
+
+    with When(f"I login as an LDAP user"):
+        r = self.context.node.query(f"SHOW GRANTS", settings=[
+            ("user", ldap_user["username"]), ("password", ldap_user["password"])])
+
+    with Then("I expect the user to have mapped and fixed roles"):
+        with By("checking that mapped role is assigned"):
+            assert mapped_roles[0].strip("'") in r.output, error()
+        with And("checking that fixed role is assigned"):
+            assert roles[0] in r.output, error()
+
+@TestOutline
+def map_role(self, role_name, ldap_server, ldap_user, rbac_role_name=None, role_mappings=None):
+    """Check that we can map a role with a given name.
+    """
+    if role_mappings is None:
+        role_mappings = [
+            {
+                "base_dn": "ou=groups,dc=company,dc=com",
+                "attribute": "cn",
+                "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+                "prefix": ""
+            }
+        ]
+
+    if rbac_role_name is None:
+        rbac_role_name = role_name
+
+    with Given("I add LDAP group"):
+        groups = add_ldap_groups(groups=({"cn": role_name},))
+
+    with And("I add LDAP user to the group"):
+        add_user_to_group_in_ldap(user=ldap_user, group=groups[0])
+
+    with And("I add matching RBAC role"):
+        roles = add_rbac_roles(roles=(f"'{rbac_role_name}'",))
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    with When(f"I login as an LDAP user"):
+        r = self.context.node.query(f"SHOW GRANTS", settings=[
+            ("user", ldap_user["username"]), ("password", ldap_user["password"])])
+
+    with Then("I expect the user to have mapped LDAP role"):
+        with By(f"checking that the role is assigned", description=f"{role_name}"):
+            assert roles[0].strip("'") in r.output, error()
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_WithUTF8Characters("1.0")
+)
+def role_name_with_utf8_characters(self, ldap_server, ldap_user):
+    """Check that we can map a role that contains UTF8 characters.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}_Gãńdåłf_Thê_Gręât"
+
+    map_role(role_name=role_name, ldap_server=ldap_server, ldap_user=ldap_user)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_Long("1.0")
+)
+def role_name_with_more_than_128_characters(self, ldap_server, ldap_user):
+    """Check that we can map a role that contains more than 128 characters.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}_{'r'*128}"
+
+    map_role(role_name=role_name, ldap_server=ldap_server, ldap_user=ldap_user)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_WithSpecialXMLCharacters("1.0")
+)
+def role_name_with_special_xml_characters(self, ldap_server, ldap_user):
+    """Check that we can map a role that contains special XML
+    characters that must be escaped.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}_\\<\\>"
+    rbac_role_name = f"role_{uid}_<>"
+
+    map_role(role_name=role_name, ldap_server=ldap_server, ldap_user=ldap_user, rbac_role_name=rbac_role_name)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Map_Role_Name_WithSpecialRegexCharacters("1.0")
+)
+def role_name_with_special_regex_characters(self, ldap_server, ldap_user):
+    """Check that we can map a role that contains special regex
+    characters that must be escaped.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}_\\+.?$"
+    rbac_role_name = f"role_{uid}_+.?$"
+
+    map_role(role_name=role_name, ldap_server=ldap_server, ldap_user=ldap_user, rbac_role_name=rbac_role_name)
+
+@TestOutline
+def map_groups_with_prefixes(self, prefixes, group_names, role_names,
+        expected, not_expected, ldap_server, ldap_user):
+    """Check that we can map multiple groups to roles whith one or more prefixes.
+    """
+    role_mappings = []
+
+    for prefix in prefixes:
+        role_mappings.append({
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": prefix
+        })
+
+    with Given("I add LDAP group"):
+        groups = add_ldap_groups(groups=({"cn": name} for name in group_names))
+
+    with And("I add LDAP user to the group"):
+        for group in groups:
+            add_user_to_group_in_ldap(user=ldap_user, group=group)
+
+    with And("I add RBAC roles"):
+        roles = add_rbac_roles(roles=(f"'{name}'" for name in role_names))
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    with When(f"I login as an LDAP user"):
+        r = self.context.node.query(f"SHOW GRANTS", settings=[
+            ("user", ldap_user["username"]), ("password", ldap_user["password"])])
+
+    with Then("I expect the user to have mapped roles"):
+        with By(f"checking that the roles are assigned", description=f"{', '.join(expected)}"):
+            for name in expected:
+                assert name in r.output, error()
+
+    with And("I expect the user not to have mapped roles"):
+        with By(f"checking that the roles are not assigned", description=f"{', '.join(not_expected)}"):
+            for name in not_expected:
+                assert name not in r.output, error()
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Syntax("1.0"),
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix("1.0")
+)
+def prefix_non_empty(self, ldap_server, ldap_user):
+    """Check that only group names with specified prefix are mapped to roles
+    when prefix is not empty.
+    """
+    uid = getuid()
+
+    with Given("I define group names"):
+        group_names=[
+            f"clickhouse_role_{uid}",
+            f"role0_{uid}"
+        ]
+
+    with And("I define role names"):
+        role_names=[
+            f"role_{uid}",
+            f"role0_{uid}"
+        ]
+
+    with And("I define group prefixes to be mapped"):
+        prefixes = ["clickhouse_"]
+
+    with And("I define the expected mapped and not mapped roles"):
+        expected=[f"role_{uid}"]
+        not_expected=[f"role0_{uid}"]
+
+    map_groups_with_prefixes(ldap_server=ldap_server, ldap_user=ldap_user,
+        prefixes=prefixes, group_names=group_names, role_names=role_names,
+        expected=expected, not_expected=not_expected)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_Default("1.0")
+)
+def prefix_default_value(self, ldap_server, ldap_user):
+    """Check that when prefix is not specified the default value of prefix
+    is empty and therefore ldap groups are mapped directly to roles.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}"
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+        }
+    ]
+
+    map_role(role_name=role_name, ldap_server=ldap_server, ldap_user=ldap_user, role_mappings=role_mappings)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_WithUTF8Characters("1.0")
+)
+def prefix_with_utf8_characters(self, ldap_server, ldap_user):
+    """Check that we can map a role when prefix contains UTF8 characters.
+    """
+    uid = getuid()
+
+    with Given("I define group names"):
+        group_names=[
+            f"Gãńdåłf_Thê_Gręât_role_{uid}",
+            f"role0_{uid}"
+        ]
+
+    with And("I define role names"):
+        role_names=[
+            f"role_{uid}",
+            f"role0_{uid}"
+        ]
+
+    with And("I define group prefixes to be mapped"):
+        prefixes = ["Gãńdåłf_Thê_Gręât_"]
+
+    with And("I define the expected mapped and not mapped roles"):
+        expected=[f"role_{uid}"]
+        not_expected=[f"role0_{uid}"]
+
+    map_groups_with_prefixes(ldap_server=ldap_server, ldap_user=ldap_user,
+        prefixes=prefixes, group_names=group_names, role_names=role_names,
+        expected=expected, not_expected=not_expected)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_SpecialCharactersEscaping("1.0"),
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_WithSpecialXMLCharacters("1.0")
+)
+def prefix_with_special_xml_characters(self, ldap_server, ldap_user):
+    """Check that we can map a role when prefix contains special XML characters.
+    """
+    uid = getuid()
+
+    with Given("I define group names"):
+        group_names=[
+            f"clickhouse\\<\\>_role_{uid}",
+            f"role0_{uid}"
+        ]
+
+    with And("I define role names"):
+        role_names=[
+            f"role_{uid}",
+            f"role0_{uid}"
+        ]
+
+    with And("I define group prefixes to be mapped"):
+        prefixes = ["clickhouse<>_"]
+
+    with And("I define the expected mapped and not mapped roles"):
+        expected=[f"role_{uid}"]
+        not_expected=[f"role0_{uid}"]
+
+    map_groups_with_prefixes(ldap_server=ldap_server, ldap_user=ldap_user,
+        prefixes=prefixes, group_names=group_names, role_names=role_names,
+        expected=expected, not_expected=not_expected)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_Prefix_WithSpecialRegexCharacters("1.0")
+)
+def prefix_with_special_regex_characters(self, ldap_server, ldap_user):
+    """Check that we can map a role when prefix contains special regex characters.
+    """
+    uid = getuid()
+
+    with Given("I define group names"):
+        group_names=[
+            f"clickhouse\\+.?\\$_role_{uid}",
+            f"role0_{uid}"
+        ]
+
+    with And("I define role names"):
+        role_names=[
+            f"role_{uid}",
+            f"role0_{uid}"
+        ]
+
+    with And("I define group prefixes to be mapped"):
+        prefixes = ["clickhouse+.?\\$_"]
+
+    with And("I define the expected mapped and not mapped roles"):
+        expected=[f"role_{uid}"]
+        not_expected=[f"role0_{uid}"]
+
+    map_groups_with_prefixes(ldap_server=ldap_server, ldap_user=ldap_user,
+        prefixes=prefixes, group_names=group_names, role_names=role_names,
+        expected=expected, not_expected=not_expected)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_MultipleSections("1.0")
+)
+def multiple_sections_with_different_prefixes(self, ldap_server, ldap_user):
+    """Check that we can map multiple roles with multiple role mapping sections
+    that use different prefixes.
+    """
+    uid = getuid()
+
+    with Given("I define group names"):
+        group_names=[
+            f"clickhouse0_role0_{uid}",
+            f"clickhouse1_role1_{uid}",
+            f"role2_{uid}"
+        ]
+
+    with And("I define role names"):
+        role_names=[
+            f"role0_{uid}",
+            f"role1_{uid}",
+            f"role2_{uid}"
+        ]
+
+    with And("I define group prefixes to be mapped"):
+        prefixes = ["clickhouse0_", "clickhouse1_"]
+
+    with And("I define the expected mapped and not mapped roles"):
+        expected=[f"role0_{uid}", f"role1_{uid}"]
+        not_expected=[f"role2_{uid}"]
+
+    map_groups_with_prefixes(ldap_server=ldap_server, ldap_user=ldap_user,
+        prefixes=prefixes, group_names=group_names, role_names=role_names,
+        expected=expected, not_expected=not_expected)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_Removed("1.0")
+)
+def group_removed(self, ldap_server, ldap_user):
+    """Check that roles are not mapped after the corresponding LDAP group
+    is removed.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}"
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+
+    try:
+        with Given("I add LDAP group"):
+            group = add_group_to_ldap(**{"cn": role_name})
+
+        with And("I add LDAP user to the group"):
+            add_user_to_group_in_ldap(user=ldap_user, group=group)
+
+        with And("I add matching RBAC role"):
+            roles = add_rbac_roles(roles=(f"{role_name}",))
+
+        with And("I add LDAP external user directory configuration"):
+            add_ldap_external_user_directory(server=ldap_server,
+                role_mappings=role_mappings, restart=True)
+
+        with When(f"I login as an LDAP user"):
+            r = self.context.node.query(f"SHOW GRANTS", settings=[
+                ("user", ldap_user["username"]), ("password", ldap_user["password"])])
+
+        with Then("I expect the user to have mapped LDAP role"):
+            with By(f"checking that the role is assigned", description=f"{role_name}"):
+                assert role_name in r.output, error()
+    finally:
+        with Finally("I remove LDAP group"):
+            delete_group_from_ldap(group)
+
+    with When(f"I login as an LDAP user after LDAP group is removed"):
+        r = self.context.node.query(f"SHOW GRANTS", settings=[
+            ("user", ldap_user["username"]), ("password", ldap_user["password"])])
+
+    with Then("I expect the user not to have mapped LDAP role"):
+        with By(f"checking that the role is not assigned", description=f"{role_name}"):
+            assert role_name not in r.output, error()
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_UserRemoved("1.0")
+)
+def user_removed_from_group(self, ldap_server, ldap_user):
+    """Check that roles are not mapped after the user has been removed
+    from the corresponding LDAP group.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}"
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+
+    with Given("I add LDAP group"):
+        groups = add_ldap_groups(groups=({"cn": role_name},))
+
+    with And("I add LDAP user to the group"):
+        add_user_to_group_in_ldap(user=ldap_user, group=groups[0])
+
+    with And("I add matching RBAC role"):
+        roles = add_rbac_roles(roles=(f"{role_name}",))
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    with When(f"I login as an LDAP user"):
+        r = self.context.node.query(f"SHOW GRANTS", settings=[
+            ("user", ldap_user["username"]), ("password", ldap_user["password"])])
+
+    with Then("I expect the user to have mapped LDAP role"):
+        with By(f"checking that the role is assigned", description=f"{role_name}"):
+            assert role_name in r.output, error()
+
+    with When("I remove user from the LDAP group"):
+        delete_user_from_group_in_ldap(user=ldap_user, group=groups[0])
+
+    with And(f"I login as an LDAP user after user has been removed from the group"):
+        r = self.context.node.query(f"SHOW GRANTS", settings=[
+            ("user", ldap_user["username"]), ("password", ldap_user["password"])])
+
+    with Then("I expect the user not to have mapped LDAP role"):
+        with By(f"checking that the role is not assigned", description=f"{role_name}"):
+            assert role_name not in r.output, error()
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_NotPresent("1.0")
+)
+def role_not_present(self, ldap_server, ldap_user):
+    """Check that LDAP users can still be authenticated even if
+    the mapped role is not present.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}"
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+
+    with Given("I add LDAP group"):
+        groups = add_ldap_groups(groups=({"cn": role_name},))
+
+    with And("I add LDAP user to the group for which no matching roles are present"):
+        add_user_to_group_in_ldap(user=ldap_user, group=groups[0])
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    with When(f"I login as an LDAP user"):
+        r = self.context.node.query(f"SHOW GRANTS", settings=[
+            ("user", ldap_user["username"]), ("password", ldap_user["password"])], no_checks=True)
+
+    with Then("I expect the login to succeed"):
+        assert r.exitcode == 0, error()
+
+    with And("the user not to have any mapped LDAP role"):
+        assert r.output == "", error()
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_Removed("1.0"),
+    RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_Readded("1.0")
+)
+def role_removed_and_readded(self, ldap_server, ldap_user):
+    """Check that when a mapped role is removed the privileges provided by the role
+    are revoked from all the authenticated LDAP users and when the role
+    is added back the privileges to the authenticated LDAP users are re-granted.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}"
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+    with Given("I add LDAP group"):
+        groups = add_ldap_groups(groups=({"cn": role_name},))
+
+    with And("I add LDAP user to the group"):
+        add_user_to_group_in_ldap(user=ldap_user, group=groups[0])
+
+    with And("I add matching RBAC role"):
+        roles = add_rbac_roles(roles=(f"{role_name}",))
+
+    with And("I create a table for which the role will provide privilege"):
+        table_name = create_table(name=f"table_{uid}",
+            create_statement="CREATE TABLE {name} (d DATE, s String, i UInt8) ENGINE = Memory()")
+
+    with And("I grant select privilege on the table to the role"):
+        self.context.node.query(f"GRANT SELECT ON {table_name} TO {role_name}")
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    with When(f"I login as LDAP user using clickhouse-client"):
+        with self.context.cluster.shell(node=self.context.node.name) as shell:
+            with shell(
+                    f"TERM=dumb clickhouse client --user {ldap_user['username']} --password {ldap_user['password']}",
+                    asynchronous=True, name="client") as client:
+                client.app.expect("clickhouse1 :\) ")
+
+                with When("I execute SHOW GRANTS"):
+                    client.app.send(f"SHOW GRANTS")
+
+                    with Then("I expect the user to have the mapped role"):
+                        client.app.expect(f"{role_name}")
+                        client.app.expect("clickhouse1 :\) ")
+
+                with When("I execute select on the table"):
+                    client.app.send(f"SELECT * FROM {table_name} LIMIT 1")
+
+                    with Then("I expect to get no errors"):
+                        client.app.expect("Ok\.")
+                        client.app.expect("clickhouse1 :\) ")
+
+                with When("I remove the role that grants the privilege"):
+                    self.context.node.query(f"DROP ROLE {role_name}")
+
+                with And("I re-execute select on the table"):
+                    client.app.send(f"SELECT * FROM {table_name} LIMIT 1")
+
+                    with Then("I expect to get not enough privileges error"):
+                        client.app.expect(f"DB::Exception: {ldap_user['username']}: Not enough privileges.")
+                        client.app.expect("clickhouse1 :\) ")
+
+                with When("I add the role that grant the privilege back"):
+                    self.context.node.query(f"CREATE ROLE {role_name}")
+                    self.context.node.query(f"GRANT SELECT ON {table_name} TO {role_name}")
+
+                with And("I execute select on the table after role is added back"):
+                    client.app.send(f"SELECT * FROM {table_name} LIMIT 1")
+
+                    with Then("I expect to get no errors"):
+                        client.app.expect("Ok\.")
+                        client.app.expect("clickhouse1 :\) ")
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_NewPrivilege("1.0"),
+    RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_RemovedPrivilege("1.0")
+)
+def privilege_new_and_removed(self, ldap_server, ldap_user):
+    """Check that when a new privilege is added to the mapped role
+    it is granted to all authenticated LDAP users and when
+    the privilege is removed from the role it is also revoked
+    from all authenticated LDAP users.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}"
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+    with Given("I add LDAP group"):
+        groups = add_ldap_groups(groups=({"cn": role_name},))
+
+    with And("I add LDAP user to the group"):
+        add_user_to_group_in_ldap(user=ldap_user, group=groups[0])
+
+    with And("I add matching RBAC role"):
+        roles = add_rbac_roles(roles=(f"{role_name}",))
+
+    with And("I create a table for which the role will provide privilege"):
+        table_name = create_table(name=f"table_{uid}",
+            create_statement="CREATE TABLE {name} (d DATE, s String, i UInt8) ENGINE = Memory()")
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    with When(f"I login as LDAP user using clickhouse-client"):
+        with self.context.cluster.shell(node=self.context.node.name) as shell:
+            with shell(
+                    f"TERM=dumb clickhouse client --user {ldap_user['username']} --password {ldap_user['password']}",
+                    asynchronous=True, name="client") as client:
+                client.app.expect("clickhouse1 :\) ")
+
+                with When("I execute SHOW GRANTS"):
+                    client.app.send(f"SHOW GRANTS")
+
+                    with Then("I expect the user to have the mapped role"):
+                        client.app.expect(f"{role_name}")
+                        client.app.expect("clickhouse1 :\) ")
+
+                with And("I execute select on the table when the mapped role does not provide this privilege"):
+                    client.app.send(f"SELECT * FROM {table_name} LIMIT 1")
+
+                    with Then("I expect to get not enough privileges error"):
+                        client.app.expect(f"DB::Exception: {ldap_user['username']}: Not enough privileges.")
+                        client.app.expect("clickhouse1 :\) ")
+
+                with When("I grant select privilege on the table to the mapped role"):
+                    self.context.node.query(f"GRANT SELECT ON {table_name} TO {role_name}")
+
+                with And("I execute select on the table"):
+                    client.app.send(f"SELECT * FROM {table_name} LIMIT 1")
+
+                    with Then("I expect to get no errors"):
+                        client.app.expect("Ok\.")
+                        client.app.expect("clickhouse1 :\) ")
+
+                with When("I remove the privilege from the mapped role"):
+                    self.context.node.query(f"REVOKE SELECT ON {table_name} FROM {role_name}")
+
+                with And("I re-execute select on the table"):
+                    client.app.send(f"SELECT * FROM {table_name} LIMIT 1")
+
+                    with Then("I expect to get not enough privileges error"):
+                        client.app.expect(f"DB::Exception: {ldap_user['username']}: Not enough privileges.")
+                        client.app.expect("clickhouse1 :\) ")
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_Added("1.0")
+)
+def role_added(self, ldap_server, ldap_user):
+    """Check that when the mapped role is not present during LDAP user authentication but
+    is later added then the authenticated LDAP users is granted the privileges provided
+    by the mapped role.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}"
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+    with Given("I add LDAP group"):
+        groups = add_ldap_groups(groups=({"cn": role_name},))
+
+    with And("I add LDAP user to the group"):
+        add_user_to_group_in_ldap(user=ldap_user, group=groups[0])
+
+    with And("I create a table for which the role will provide privilege"):
+        table_name = create_table(name=f"table_{uid}",
+            create_statement="CREATE TABLE {name} (d DATE, s String, i UInt8) ENGINE = Memory()")
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    with When(f"I login as LDAP user using clickhouse-client"):
+        with self.context.cluster.shell(node=self.context.node.name) as shell:
+            with shell(
+                    f"TERM=dumb clickhouse client --user {ldap_user['username']} --password {ldap_user['password']}",
+                    asynchronous=True, name="client") as client:
+                client.app.expect("clickhouse1 :\) ")
+
+                with When("I execute SHOW GRANTS"):
+                    client.app.send(f"SHOW GRANTS")
+
+                    with Then("I expect the user not to have any mapped role"):
+                        client.app.expect(f"Ok\.")
+                        client.app.expect("clickhouse1 :\) ")
+
+                with And("I execute select on the table"):
+                    client.app.send(f"SELECT * FROM {table_name} LIMIT 1")
+
+                    with Then("I expect to get not enough privileges error"):
+                        client.app.expect(f"DB::Exception: {ldap_user['username']}: Not enough privileges.")
+                        client.app.expect("clickhouse1 :\) ")
+
+                with When("I add the role that grant the privilege"):
+                    self.context.node.query(f"CREATE ROLE {role_name}")
+                    self.context.node.query(f"GRANT SELECT ON {table_name} TO {role_name}")
+
+                with And("I execute select on the table after role is added"):
+                    client.app.send(f"SELECT * FROM {table_name} LIMIT 1")
+
+                    with Then("I expect to get no errors"):
+                        client.app.expect("Ok\.")
+                        client.app.expect("clickhouse1 :\) ")
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_New("1.0")
+)
+def role_new(self, ldap_server, ldap_user):
+    """Check that no new roles can be granted to LDAP authenticated users.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}"
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+
+    message = f"DB::Exception: Cannot update user `{ldap_user['username']}` in ldap because this storage is readonly"
+    exitcode = 239
+
+    with Given("I a have RBAC role that is not mapped"):
+        roles = add_rbac_roles(roles=(f"{role_name}",))
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    with When(f"I login as LDAP user using clickhouse-client"):
+        with self.context.cluster.shell(node=self.context.node.name) as shell:
+            with shell(
+                    f"TERM=dumb clickhouse client --user {ldap_user['username']} --password {ldap_user['password']}",
+                    asynchronous=True, name="client") as client:
+                client.app.expect("clickhouse1 :\) ")
+
+                with When("I try to grant new role to user"):
+                    self.context.node.query(f"GRANT {role_name} TO {ldap_user['username']}",
+                        message=message, exitcode=exitcode)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_UserDirectory_RoleMapping_MultipleSections_IdenticalParameters("1.0")
+)
+def multiple_sections_with_identical_parameters(self, ldap_server, ldap_user):
+    """Check behaviour when multiple role mapping sections
+    have exactly the same parameters.
+    """
+    uid = getuid()
+    role_name = f"role_{uid}"
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ] * 4
+
+    with Given("I add LDAP group"):
+        groups = add_ldap_groups(groups=({"cn": role_name},))
+
+    with And("I add LDAP user to the group"):
+        add_user_to_group_in_ldap(user=ldap_user, group=groups[0])
+
+    with And("I add matching RBAC role"):
+        roles = add_rbac_roles(roles=(f"{role_name}",))
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    with When(f"I login as an LDAP user"):
+        r = self.context.node.query(f"SHOW GRANTS", settings=[
+            ("user", ldap_user["username"]), ("password", ldap_user["password"])])
+
+    with Then("I expect the user to have mapped LDAP role"):
+        with By(f"checking that the role is assigned", description=f"{role_name}"):
+            assert roles[0].strip("'") in r.output, error()
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_RemovedAndAdded_Parallel("1.0")
+)
+def group_removed_and_added_in_parallel(self, ldap_server, ldap_user, count=20, timeout=200):
+    """Check that user can be authenticated successfully when LDAP groups
+    are removed and added in parallel.
+    """
+    uid = getuid()
+    role_names = [f"role{i}_{uid}" for i in range(count)]
+    users = [{"cn": ldap_user["username"], "userpassword": ldap_user["password"]}]
+    groups = []
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+
+    try:
+        with Given("I initially add all LDAP groups"):
+            for role_name in role_names:
+                with When(f"I add LDAP groop {role_name}"):
+                    group = add_group_to_ldap(**{"cn": role_name})
+                with And(f"I add LDAP user to the group {role_name}"):
+                    add_user_to_group_in_ldap(user=ldap_user, group=group)
+                groups.append(group)
+
+        with And("I add RBAC roles"):
+            add_rbac_roles(roles=role_names)
+
+        with And("I add LDAP external user directory configuration"):
+            add_ldap_external_user_directory(server=ldap_server,
+                role_mappings=role_mappings, restart=True)
+
+        tasks = []
+        try:
+            with When("user try to login while LDAP groups are added and removed in parallel"):
+                p = Pool(15)
+                for i in range(15):
+                    tasks.append(p.apply_async(login_with_valid_username_and_password, (users, i, 50,)))
+                    tasks.append(p.apply_async(remove_ldap_groups_in_parallel, (groups, i, 10,)))
+                    tasks.append(p.apply_async(add_ldap_groups_in_parallel,(ldap_user, role_names, i, 10,)))
+
+        finally:
+            with Finally("it should work", flags=TE):
+                join(tasks, timeout)
+    finally:
+        with Finally("I clean up all LDAP groups"):
+            for group in groups:
+                delete_group_from_ldap(group, exitcode=None)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_LDAP_Group_UserRemovedAndAdded_Parallel("1.0")
+)
+def user_removed_and_added_in_ldap_groups_in_parallel(self, ldap_server, ldap_user, count=20, timeout=200):
+    """Check that user can be authenticated successfully when it is
+    removed and added from mapping LDAP groups in parallel.
+    """
+    uid = getuid()
+    role_names = [f"role{i}_{uid}" for i in range(count)]
+    users = [{"cn": ldap_user["username"], "userpassword": ldap_user["password"]}]
+    groups = [{"cn": role_name} for role_name in role_names]
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+
+    with Given("I add all LDAP groups"):
+        groups = add_ldap_groups(groups=groups)
+
+        for group in groups:
+            with And(f"I add LDAP user to the group {group['dn']}"):
+                add_user_to_group_in_ldap(user=ldap_user, group=group)
+
+    with And("I add RBAC roles"):
+        add_rbac_roles(roles=role_names)
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    tasks = []
+    try:
+        with When("user try to login while user is added and removed from LDAP groups in parallel"):
+            p = Pool(15)
+            for i in range(15):
+                tasks.append(p.apply_async(login_with_valid_username_and_password, (users, i, 50,)))
+                tasks.append(p.apply_async(remove_user_from_ldap_groups_in_parallel, (ldap_user, groups, i, 1,)))
+                tasks.append(p.apply_async(add_user_to_ldap_groups_in_parallel, (ldap_user, groups, i, 1,)))
+
+    finally:
+        with Finally("it should work", flags=TE):
+            join(tasks, timeout)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_RBAC_Role_RemovedAndAdded_Parallel("1.0")
+)
+def roles_removed_and_added_in_parallel(self, ldap_server, ldap_user, count=20, timeout=200):
+    """Check that user can be authenticated successfully when roles that are mapped
+    by the LDAP groups are removed and added in parallel.
+    """
+    uid = getuid()
+    role_names = [f"role{i}_{uid}" for i in range(count)]
+    users = [{"cn": ldap_user["username"], "userpassword": ldap_user["password"]}]
+    groups = [{"cn": role_name} for role_name in role_names]
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": ""
+        }
+    ]
+
+    fail("known bug that needs to be investigated")
+
+    with Given("I add all LDAP groups"):
+        groups = add_ldap_groups(groups=groups)
+        for group in groups:
+            with And(f"I add LDAP user to the group {group['dn']}"):
+                add_user_to_group_in_ldap(user=ldap_user, group=group)
+
+    with And("I add RBAC roles"):
+        add_rbac_roles(roles=role_names)
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    tasks = []
+    try:
+        with When("user try to login while mapped roles are added and removed in parallel"):
+            p = Pool(15)
+            for i in range(15):
+                tasks.append(p.apply_async(login_with_valid_username_and_password, (users, i, 50,)))
+                tasks.append(p.apply_async(remove_roles_in_parallel, (role_names, i, 10,)))
+                tasks.append(p.apply_async(add_roles_in_parallel, (role_names, i, 10,)))
+
+    finally:
+        with Finally("it should work", flags=TE):
+            join(tasks, timeout)
+
+        with And("I clean up all the roles"):
+            for role_name in role_names:
+                with By(f"dropping role {role_name}", flags=TE):
+                    self.context.node.query(f"DROP ROLE IF EXISTS {role_name}")
+
+@TestOutline
+def parallel_login(self, ldap_server, ldap_user, user_count=10, timeout=200, role_count=10):
+    """Check that login of valid and invalid LDAP authenticated users
+    with mapped roles works in parallel.
+    """
+    uid = getuid()
+
+    role_names = [f"role{i}_{uid}" for i in range(role_count)]
+    users = [{"cn": f"parallel_user{i}", "userpassword": randomword(20)} for i in range(user_count)]
+    groups = [{"cn": f"clickhouse_{role_name}"} for role_name in role_names]
+
+    role_mappings = [
+        {
+            "base_dn": "ou=groups,dc=company,dc=com",
+            "attribute": "cn",
+            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+            "prefix": "clickhouse_"
+        }
+    ]
+
+    with Given("I add LDAP users"):
+        users = add_ldap_users(users=users)
+
+    with And("I add all LDAP groups"):
+        groups = add_ldap_groups(groups=groups)
+
+    for group in groups:
+        for user in users:
+            with And(f"I add LDAP user {user['dn']} to the group {group['dn']}"):
+                add_user_to_group_in_ldap(user=user, group=group)
+
+    with And("I add RBAC roles"):
+        add_rbac_roles(roles=role_names)
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=ldap_server,
+            role_mappings=role_mappings, restart=True)
+
+    tasks = []
+    try:
+        with When("users try to login in parallel", description="""
+            * with valid username and password
+            * with invalid username and valid password
+            * with valid username and invalid password
+            """):
+            p = Pool(15)
+            for i in range(25):
+                tasks.append(p.apply_async(login_with_valid_username_and_password, (users, i, 50,)))
+                tasks.append(p.apply_async(login_with_valid_username_and_invalid_password, (users, i, 50,)))
+                tasks.append(p.apply_async(login_with_invalid_username_and_valid_password, (users, i, 50,)))
+
+    finally:
+        with Then("it should work"):
+            join(tasks, timeout)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel("1.0"),
+    RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_ValidAndInvalid("1.0")
+)
+def parallel_login_of_multiple_users(self, ldap_server, ldap_user, timeout=200, role_count=10):
+    """Check that valid and invalid logins of multiple LDAP authenticated users
+    with mapped roles works in parallel.
+    """
+    parallel_login(user_count=10, ldap_user=ldap_user,ldap_server=ldap_server,
+        timeout=timeout, role_count=role_count)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_SameUser("1.0"),
+    RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_ValidAndInvalid("1.0")
+)
+def parallel_login_of_the_same_user(self, ldap_server, ldap_user, timeout=200, role_count=10):
+    """Check that valid and invalid logins of the same LDAP authenticated user
+    with mapped roles works in parallel.
+    """
+    parallel_login(user_count=10, ldap_user=ldap_user,ldap_server=ldap_server,
+        timeout=timeout, role_count=role_count)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_MultipleServers("1.0"),
+    RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_ValidAndInvalid("1.0")
+)
+def parallel_login_of_ldap_users_with_multiple_servers(self, ldap_server, ldap_user, timeout=200):
+    """Check that valid and invalid logins of multiple LDAP users that have mapped roles
+    works in parallel using multiple LDAP external user directories.
+    """
+    parallel_login_with_multiple_servers(ldap_server=ldap_server, ldap_user=ldap_user,
+        user_count=10, role_count=10,timeout=timeout, with_ldap_users=True, with_local_users=False)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_LocalAndMultipleLDAP("1.0"),
+    RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_ValidAndInvalid("1.0")
+)
+def parallel_login_of_local_and_ldap_users_with_multiple_servers(self, ldap_server, ldap_user, timeout=200):
+    """Check that valid and invalid logins of local users and LDAP users that have mapped roles
+    works in parallel using multiple LDAP external user directories.
+    """
+    parallel_login_with_multiple_servers(ldap_server=ldap_server, ldap_user=ldap_user,
+        user_count=10, role_count=10, timeout=timeout, with_local_users=True, with_ldap_users=True)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Authentication_Parallel_LocalOnly("1.0")
+)
+def parallel_login_of_local_users(self, ldap_server, ldap_user, timeout=200):
+    """Check that valid and invalid logins of local users
+    works in parallel when multiple LDAP external user directories
+    with role mapping are configured.
+    """
+    parallel_login_with_multiple_servers(ldap_server=ldap_server, ldap_user=ldap_user,
+        user_count=10, role_count=10, timeout=timeout, with_local_users=True, with_ldap_users=False)
+
+@TestOutline
+def parallel_login_with_multiple_servers(self, ldap_server, ldap_user, user_count=10,
+        role_count=10, timeout=200, with_ldap_users=True, with_local_users=False):
+    """Check that login of valid and invalid local users or LDAP users that have mapped roles
+    works in parallel using multiple LDAP external user directories.
+    """
+    uid = getuid()
+
+    cluster = self.context.cluster
+    user_groups = {}
+
+    with Given("I define role names"):
+        role_names = [f"role{i}_{uid}" for i in range(role_count)]
+
+    with And("I define corresponding group names"):
+        groups = [{"cn": f"clickhouse_{role_name}"} for role_name in role_names]
+
+    if with_ldap_users:
+        with And("I define a group of users to be created on each LDAP server"):
+            user_groups["openldap1_users"] = [
+                {"cn": f"openldap1_parallel_user{i}_{uid}", "userpassword": randomword(20)} for i in range(user_count)
+            ]
+            user_groups["openldap2_users"] = [
+                {"cn": f"openldap2_parallel_user{i}_{uid}", "userpassword": randomword(20)} for i in range(user_count)
+            ]
+
+    if with_local_users:
+        with And("I define a group of local users to be created"):
+            user_groups["local_users"] = [
+                {"cn": f"local_parallel_user{i}_{uid}", "userpassword": randomword(20)} for i in range(user_count)
+            ]
+
+    with And("I have a list of checks that I want to run for each user group"):
+        checks = [
+            login_with_valid_username_and_password,
+            login_with_valid_username_and_invalid_password,
+            login_with_invalid_username_and_valid_password
+        ]
+
+    with And("I create config file to define LDAP external user directory for each LDAP server"):
+        entries = {
+            "user_directories": [
+                {"ldap": [
+                    {"server": "openldap1"},
+                    {"role_mappings" : [
+                        {
+                            "base_dn": "ou=groups,dc=company,dc=com",
+                            "attribute": "cn",
+                            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+                            "prefix": "clickhouse_"
+                        }
+                    ]}
+                ]},
+                {"ldap": [
+                    {"server": "openldap2"},
+                    {"role_mappings": [
+                        {
+                            "base_dn": "ou=groups,dc=company,dc=com",
+                            "attribute": "cn",
+                            "search_filter": "(&(objectClass=groupOfUniqueNames)(uniquemember={bind_dn}))",
+                            "prefix": "clickhouse_"
+                        }
+                    ]}
+                ]}
+            ]
+        }
+        config = create_entries_ldap_external_user_directory_config_content(entries)
+
+    with And("I add LDAP external user directory configuration"):
+        add_ldap_external_user_directory(server=None, restart=True, config=config)
+
+    if with_ldap_users:
+        with And("I add LDAP users to each LDAP server"):
+            openldap1_users = add_ldap_users(users=user_groups["openldap1_users"], node=cluster.node("openldap1"))
+            openldap2_users = add_ldap_users(users=user_groups["openldap2_users"], node=cluster.node("openldap2"))
+
+        with And("I add all LDAP groups to each LDAP server"):
+            openldap1_groups = add_ldap_groups(groups=groups, node=cluster.node("openldap1"))
+            openldap2_groups = add_ldap_groups(groups=groups, node=cluster.node("openldap2"))
+
+        with And("I add all users to LDAP groups on the first LDAP server"):
+            for group in openldap1_groups:
+                for user in openldap1_users:
+                    with By(f"adding LDAP user {user['dn']} to the group {group['dn']}"):
+                        add_user_to_group_in_ldap(user=user, group=group, node=cluster.node("openldap1"))
+
+        with And("I add all users to LDAP groups on the second LDAP server"):
+            for group in openldap2_groups:
+                for user in openldap2_users:
+                    with By(f"adding LDAP user {user['dn']} to the group {group['dn']}"):
+                        add_user_to_group_in_ldap(user=user, group=group, node=cluster.node("openldap2"))
+
+    with And("I add RBAC roles"):
+        add_rbac_roles(roles=role_names)
+
+    if with_local_users:
+        with And("I add local users"):
+            add_rbac_users(users=user_groups["local_users"])
+
+        with And("I grant the same RBAC roles to local users"):
+            for user in user_groups["local_users"]:
+                for role_name in role_names:
+                    self.context.node.query(f"GRANT {role_name} TO {user['cn']}")
+
+    tasks = []
+
+    try:
+        with When("users in each group try to login in parallel", description="""
+            * with valid username and password
+            * with invalid username and valid password
+            * with valid username and invalid password
+            """):
+            p = Pool(15)
+            for i in range(25):
+                for users in user_groups.values():
+                    for check in checks:
+                        tasks.append(p.apply_async(check, (users, i, 50,)))
+
+    finally:
+        with Then("it should work"):
+            join(tasks, timeout)
+
+@TestFeature
+@Name("mapping")
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Search("1.0")
+)
+def feature(self):
+    """Check role LDAP role mapping.
+    """
+    self.context.node = self.context.cluster.node("clickhouse1")
+    self.context.ldap_node = self.context.cluster.node("openldap1")
+
+    servers = {
+        "openldap1": {
+            "host": "openldap1",
+            "port": "389",
+            "enable_tls": "no",
+            "bind_dn": "cn={user_name},ou=users,dc=company,dc=com"
+        },
+        "openldap2": {
+            "host": "openldap2",
+            "port": "636",
+            "enable_tls": "yes",
+            "bind_dn": "cn={user_name},ou=users,dc=company,dc=com",
+            "tls_require_cert": "never",
+        }
+    }
+
+    users = [
+        {"server": "openldap1", "username": "user1", "password": "user1", "login": True,
+         "dn": "cn=user1,ou=users,dc=company,dc=com"},
+    ]
+
+    with Given("I fix LDAP access permissions"):
+        fix_ldap_permissions()
+
+    with And("I add LDAP servers configuration", description=f"{servers}"):
+        add_ldap_servers_configuration(servers=servers)
+
+    for scenario in loads(current_module(), Scenario):
+        scenario(ldap_server="openldap1", ldap_user=users[0])
diff --git a/tests/testflows/ldap/role_mapping/tests/server_config.py b/tests/testflows/ldap/role_mapping/tests/server_config.py
new file mode 100644
index 000000000000..85fe33f43881
--- /dev/null
+++ b/tests/testflows/ldap/role_mapping/tests/server_config.py
@@ -0,0 +1,78 @@
+from testflows.core import *
+from testflows.asserts import error
+
+from ldap.role_mapping.requirements import *
+
+from ldap.authentication.tests.common import invalid_server_config
+from ldap.external_user_directory.tests.common import login
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_Server_BindDN("1.0")
+)
+def valid_bind_dn(self):
+    """Check that LDAP users can login when `bind_dn` is valid.
+    """
+    servers = {
+        "openldap1": {
+            "host": "openldap1", "port": "389", "enable_tls": "no",
+            "bind_dn": "cn={user_name},ou=users,dc=company,dc=com"
+        }
+    }
+
+    user = {
+        "server": "openldap1", "username": "user1", "password": "user1", "login": True,
+    }
+
+    login(servers, "openldap1", user)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_Server_BindDN("1.0")
+)
+def invalid_bind_dn(self):
+    """Check that LDAP users can't login when `bind_dn` is invalid.
+    """
+    servers = {
+        "openldap1": {
+            "host": "openldap1", "port": "389", "enable_tls": "no",
+            "bind_dn": "cn={user_name},ou=users,dc=company2,dc=com"
+        }}
+
+    user = {
+        "server": "openldap1", "username": "user1", "password": "user1", "login": True,
+        "exitcode": 4,
+        "message": "DB::Exception: user1: Authentication failed: password is incorrect or there is no user with such name."
+    }
+
+    login(servers, "openldap1", user)
+
+@TestScenario
+@Requirements(
+    RQ_SRS_014_LDAP_RoleMapping_Configuration_Server_BindDN_ConflictWith_AuthDN("1.0")
+)
+def bind_dn_conflict_with_auth_dn(self, timeout=60):
+    """Check that an error is returned with both `bind_dn` and
+    `auth_dn_prefix` and `auth_dn_suffix` are specified at the same time.
+    """
+    message = "DB::Exception: Deprecated 'auth_dn_prefix' and 'auth_dn_suffix' entries cannot be used with 'bind_dn' entry"
+    servers = {
+        "openldap1": {
+            "host": "openldap1", "port": "389", "enable_tls": "no",
+            "bind_dn": "cn={user_name},ou=users,dc=company,dc=com",
+            "auth_dn_prefix": "cn=",
+            "auth_dn_suffix": ",ou=users,dc=company,dc=com"
+        }
+    }
+
+    invalid_server_config(servers, message=message, tail=18, timeout=timeout)
+
+
+@TestFeature
+@Name("server config")
+def feature(self, node="clickhouse1"):
+    """Check LDAP server configuration.
+    """
+    self.context.node = self.context.cluster.node(node)
+    for scenario in loads(current_module(), Scenario):
+        scenario()
\ No newline at end of file
diff --git a/tests/testflows/rbac/docker-compose/clickhouse-service.yml b/tests/testflows/rbac/docker-compose/clickhouse-service.yml
index 2d79443dcbbd..d5f981ca8b77 100755
--- a/tests/testflows/rbac/docker-compose/clickhouse-service.yml
+++ b/tests/testflows/rbac/docker-compose/clickhouse-service.yml
@@ -20,7 +20,7 @@ services:
       test: clickhouse client --query='select 1'
       interval: 10s
       timeout: 10s
-      retries: 3
+      retries: 10
       start_period: 300s
     cap_add:
       - SYS_PTRACE
diff --git a/tests/testflows/regression.py b/tests/testflows/regression.py
index 6e19e4e49e10..0e9a821cae0f 100755
--- a/tests/testflows/regression.py
+++ b/tests/testflows/regression.py
@@ -14,11 +14,10 @@ def regression(self, local, clickhouse_binary_path, stress=None, parallel=None):
     """
     args = {"local": local, "clickhouse_binary_path": clickhouse_binary_path, "stress": stress, "parallel": parallel}
 
-#    Feature(test=load("example.regression", "regression"))(**args)
-#    Feature(test=load("ldap.regression", "regression"))(**args)
-#    for i in range(10):
-#        Feature(test=load("rbac.regression", "regression"))(**args)
-#    Feature(test=load("aes_encryption.regression", "regression"))(**args)
+    Feature(test=load("example.regression", "regression"))(**args)
+    Feature(test=load("ldap.regression", "regression"))(**args)
+    Feature(test=load("rbac.regression", "regression"))(**args)
+    Feature(test=load("aes_encryption.regression", "regression"))(**args)
 
 if main():
     regression()
