diff --git a/tests/queries/0_stateless/00857_global_joinsavel_table_alias.sql b/tests/queries/0_stateless/00857_global_joinsavel_table_alias.sql
index 2044a9b8d224..092b071cb48b 100644
--- a/tests/queries/0_stateless/00857_global_joinsavel_table_alias.sql
+++ b/tests/queries/0_stateless/00857_global_joinsavel_table_alias.sql
@@ -1,4 +1,3 @@
-
 DROP TABLE IF EXISTS local_table;
 DROP TABLE IF EXISTS other_table;
 
diff --git a/tests/queries/0_stateless/01401_FORMAT_SETTINGS.reference b/tests/queries/0_stateless/01401_FORMAT_SETTINGS.reference
index 22405bf1866d..a8b99666654e 100644
--- a/tests/queries/0_stateless/01401_FORMAT_SETTINGS.reference
+++ b/tests/queries/0_stateless/01401_FORMAT_SETTINGS.reference
@@ -1,7 +1,7 @@
 1
 1
 1
-1
+2
 1
 2
 2
diff --git a/tests/queries/0_stateless/01401_FORMAT_SETTINGS.sh b/tests/queries/0_stateless/01401_FORMAT_SETTINGS.sh
index b70c28422c93..173cc949500c 100755
--- a/tests/queries/0_stateless/01401_FORMAT_SETTINGS.sh
+++ b/tests/queries/0_stateless/01401_FORMAT_SETTINGS.sh
@@ -13,7 +13,7 @@ ${CLICKHOUSE_CURL} -sS "${CLICKHOUSE_URL}" -d 'SELECT DISTINCT blockSize() FROM
 ${CLICKHOUSE_CURL} -sS "${CLICKHOUSE_URL}" -d 'SELECT DISTINCT blockSize() FROM numbers(2) FORMAT CSV SETTINGS max_block_size = 1'
 # push down append
 ${CLICKHOUSE_CURL} -sS "${CLICKHOUSE_URL}" -d 'SELECT DISTINCT blockSize() FROM numbers(2) SETTINGS max_compress_block_size = 1 FORMAT CSV SETTINGS max_block_size = 1'
-# overwrite on push down (since these settings goes latest)
+# not overwrite on push down
 ${CLICKHOUSE_CURL} -sS "${CLICKHOUSE_URL}" -d 'SELECT DISTINCT blockSize() FROM numbers(2) SETTINGS max_block_size = 2 FORMAT CSV SETTINGS max_block_size = 1'
 # on push-down
 ${CLICKHOUSE_CURL} -sS "${CLICKHOUSE_URL}" -d 'SELECT DISTINCT blockSize() FROM numbers(2) SETTINGS max_block_size = 1 FORMAT CSV'
diff --git a/tests/queries/0_stateless/03003_compatibility_setting_bad_value.sql b/tests/queries/0_stateless/03003_compatibility_setting_bad_value.sql
index 48e98798c512..3a09eec74527 100644
--- a/tests/queries/0_stateless/03003_compatibility_setting_bad_value.sql
+++ b/tests/queries/0_stateless/03003_compatibility_setting_bad_value.sql
@@ -1,2 +1,1 @@
-select 42 settings compatibility=NULL;  -- {clientError BAD_ARGUMENTS}
-
+select 42 settings compatibility=NULL;  -- {clientError BAD_GET}
diff --git a/tests/queries/0_stateless/03172_format_settings_clauses.reference b/tests/queries/0_stateless/03172_format_settings_clauses.reference
new file mode 100644
index 000000000000..8a98b137f4b1
--- /dev/null
+++ b/tests/queries/0_stateless/03172_format_settings_clauses.reference
@@ -0,0 +1,14 @@
+1
+2
+1
+2
+1
+2
+1
+1
+3
+3
+3
+3
+3
+1
diff --git a/tests/queries/0_stateless/03172_format_settings_clauses.sql b/tests/queries/0_stateless/03172_format_settings_clauses.sql
new file mode 100644
index 000000000000..0d1aa4dcfbb8
--- /dev/null
+++ b/tests/queries/0_stateless/03172_format_settings_clauses.sql
@@ -0,0 +1,30 @@
+SET max_block_size = 10, max_threads = 1;
+
+-- Take the following example:
+SELECT 1 UNION ALL SELECT 2 FORMAT TSV;
+
+-- Each subquery can be put in parentheses and have its own settings:
+(SELECT getSetting('max_block_size') SETTINGS max_block_size = 1) UNION ALL (SELECT getSetting('max_block_size') SETTINGS max_block_size = 2) FORMAT TSV;
+
+-- And the whole query can have settings:
+(SELECT getSetting('max_block_size') SETTINGS max_block_size = 1) UNION ALL (SELECT getSetting('max_block_size') SETTINGS max_block_size = 2) FORMAT TSV SETTINGS max_block_size = 3;
+
+-- A single query with output is parsed in the same way as the UNION ALL chain:
+SELECT getSetting('max_block_size') SETTINGS max_block_size = 1 FORMAT TSV SETTINGS max_block_size = 3;
+
+-- So while these forms have a slightly different meaning, they both exist:
+SELECT getSetting('max_block_size') SETTINGS max_block_size = 1 FORMAT TSV;
+SELECT getSetting('max_block_size') FORMAT TSV SETTINGS max_block_size = 3;
+
+-- And due to this effect, the users expect that the FORMAT and SETTINGS may go in an arbitrary order.
+-- But while this work:
+(SELECT getSetting('max_block_size')) UNION ALL (SELECT getSetting('max_block_size')) FORMAT TSV SETTINGS max_block_size = 3;
+
+-- This does not work automatically, unless we explicitly allow different orders:
+(SELECT getSetting('max_block_size')) UNION ALL (SELECT getSetting('max_block_size')) SETTINGS max_block_size = 3 FORMAT TSV;
+
+-- Inevitably, we allow this:
+SELECT getSetting('max_block_size') SETTINGS max_block_size = 1 SETTINGS max_block_size = 3 FORMAT TSV;
+/*^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^*/
+-- Because this part is consumed into ASTSelectWithUnionQuery
+-- and the rest into ASTQueryWithOutput.
