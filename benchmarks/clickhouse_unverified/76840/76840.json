{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 76840,
  "instance_id": "ClickHouse__ClickHouse-76840",
  "issue_numbers": [
    "70518"
  ],
  "base_commit": "d82d559b151c05c0f7a4404284a2d1a81e1a3648",
  "patch": "diff --git a/src/Functions/lgamma.cpp b/src/Functions/lgamma.cpp\nindex 93b013e8da6a..1708308f70b6 100644\n--- a/src/Functions/lgamma.cpp\n+++ b/src/Functions/lgamma.cpp\n@@ -16,6 +16,9 @@ namespace\n /// Use wrapper and use lgamma_r version because std::lgamma is not threadsafe.\n Float64 lgamma_wrapper(Float64 arg)\n {\n+    if (arg < 0 && arg == std::floor(arg))\n+        return std::numeric_limits<Float64>::quiet_NaN();\n+\n     int signp;\n     return lgamma_r(arg, &signp);\n }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/00087_math_functions.reference b/tests/queries/0_stateless/00087_math_functions.reference\nindex e02aac11fafc..6181d46cf119 100644\n--- a/tests/queries/0_stateless/00087_math_functions.reference\n+++ b/tests/queries/0_stateless/00087_math_functions.reference\n@@ -112,3 +112,10 @@\n 1\n 1\n 1\n+1\n+1\n+1\n+1\n+1\n+1\n+1\ndiff --git a/tests/queries/0_stateless/00087_math_functions.sql b/tests/queries/0_stateless/00087_math_functions.sql\nindex e40acfb3481d..b3a9c3ab4824 100644\n--- a/tests/queries/0_stateless/00087_math_functions.sql\n+++ b/tests/queries/0_stateless/00087_math_functions.sql\n@@ -26,6 +26,14 @@ select pow(2, 1) = 2;\n select sum(abs(pow(x, 1) - x) < 1.0e-9) / count() from system.one array join range(1000000) as x;\n select sum(pow(x, 2) = x * x) / count() from system.one array join range(10000) as x;\n \n+select isNaN(lgamma(-2));\n+select isNaN(lgamma(-1));\n+select lgamma(0) = inf;\n+select lgamma(1) = 0;\n+select lgamma(2) = 0;\n+select abs(lgamma(3) - 0.693147181) < 1.0e-8;\n+select abs(lgamma(4) - 1.791759469) < 1.0e-8;\n+\n select tgamma(0) = inf;\n select tgamma(1) = 1;\n select tgamma(2) = 1;\n",
  "problem_statement": "lgamma wrong result with negative integers \n```sql\r\nSELECT lgamma(-1)\r\n```\r\n\r\nlatest (24.9.2.42) output:\r\n```\r\n37.78343889855838\r\n```\r\n\r\n24.10.1.1198 with asan:\r\n```\r\ninf\r\n```\r\n\r\nExpected result:\r\nNaN or an error since the gamma function is not defined for negative integers. \n",
  "hints_text": "",
  "created_at": "2025-02-26T23:18:12Z",
  "modified_files": [
    "src/Functions/lgamma.cpp"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/00087_math_functions.reference",
    "tests/queries/0_stateless/00087_math_functions.sql"
  ]
}