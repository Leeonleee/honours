{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 21858,
  "instance_id": "ClickHouse__ClickHouse-21858",
  "issue_numbers": [
    "3607"
  ],
  "base_commit": "95a053ee72abac31fbbfebfc76f07465e2336942",
  "patch": "diff --git a/.gitmodules b/.gitmodules\nindex 66a2370f0da6..2ccce88e5e46 100644\n--- a/.gitmodules\n+++ b/.gitmodules\n@@ -228,3 +228,7 @@\n [submodule \"contrib/datasketches-cpp\"]\n \tpath = contrib/datasketches-cpp\n \turl = https://github.com/ClickHouse-Extras/datasketches-cpp.git\n+\n+[submodule \"contrib/yaml-cpp\"]\n+\tpath = contrib/yaml-cpp\n+\turl = https://github.com/ClickHouse-Extras/yaml-cpp.git\ndiff --git a/CMakeLists.txt b/CMakeLists.txt\nindex 2c3fa0889957..866d9f542e11 100644\n--- a/CMakeLists.txt\n+++ b/CMakeLists.txt\n@@ -527,6 +527,7 @@ include (cmake/find/nanodbc.cmake)\n include (cmake/find/rocksdb.cmake)\n include (cmake/find/libpqxx.cmake)\n include (cmake/find/nuraft.cmake)\n+include (cmake/find/yaml-cpp.cmake)\n \n \n if(NOT USE_INTERNAL_PARQUET_LIBRARY)\ndiff --git a/base/bridge/CMakeLists.txt b/base/bridge/CMakeLists.txt\nindex 20b0b6516777..bcba43e8c2e4 100644\n--- a/base/bridge/CMakeLists.txt\n+++ b/base/bridge/CMakeLists.txt\n@@ -3,5 +3,11 @@ add_library (bridge\n )\n \n target_include_directories (daemon PUBLIC ..)\n-target_link_libraries (bridge PRIVATE daemon dbms Poco::Data Poco::Data::ODBC)\n+target_link_libraries (bridge \n+    PRIVATE \n+\tdaemon\n+\tdbms\n+\tPoco::Data\n+\tPoco::Data::ODBC\n+)\n \ndiff --git a/cmake/find/yaml-cpp.cmake b/cmake/find/yaml-cpp.cmake\nnew file mode 100644\nindex 000000000000..9b9d9bd39d60\n--- /dev/null\n+++ b/cmake/find/yaml-cpp.cmake\n@@ -0,0 +1,9 @@\n+option(USE_YAML_CPP \"Enable yaml-cpp\" ${ENABLE_LIBRARIES})\n+\n+if (NOT USE_YAML_CPP)\n+    return()\n+endif()\n+\n+if (NOT EXISTS \"${ClickHouse_SOURCE_DIR}/contrib/yaml-cpp\")\n+    message (ERROR \"submodule contrib/yaml-cpp is missing. to fix try run: \\n git submodule update --init --recursive\")\n+endif()\ndiff --git a/contrib/CMakeLists.txt b/contrib/CMakeLists.txt\nindex 9eafec23f515..a9438aa4b769 100644\n--- a/contrib/CMakeLists.txt\n+++ b/contrib/CMakeLists.txt\n@@ -50,6 +50,10 @@ add_subdirectory (replxx-cmake)\n add_subdirectory (unixodbc-cmake)\n add_subdirectory (nanodbc-cmake)\n \n+if (USE_YAML_CPP)\n+    add_subdirectory (yaml-cpp-cmake)\n+endif()\n+\n if (USE_INTERNAL_XZ_LIBRARY)\n     add_subdirectory (xz)\n endif()\ndiff --git a/contrib/yaml-cpp b/contrib/yaml-cpp\nnew file mode 160000\nindex 000000000000..0c86adac6d11\n--- /dev/null\n+++ b/contrib/yaml-cpp\n@@ -0,0 +1,1 @@\n+Subproject commit 0c86adac6d117ee2b4afcedb8ade19036ca0327d\ndiff --git a/contrib/yaml-cpp-cmake/CMakeLists.txt b/contrib/yaml-cpp-cmake/CMakeLists.txt\nnew file mode 100644\nindex 000000000000..ed0287de1103\n--- /dev/null\n+++ b/contrib/yaml-cpp-cmake/CMakeLists.txt\n@@ -0,0 +1,39 @@\n+set (LIBRARY_DIR ${ClickHouse_SOURCE_DIR}/contrib/yaml-cpp)\n+\n+set (SRCS\n+\t${LIBRARY_DIR}/src/binary.cpp\n+\t${LIBRARY_DIR}/src/emitterutils.cpp\n+\t${LIBRARY_DIR}/src/null.cpp\n+\t${LIBRARY_DIR}/src/scantoken.cpp\n+\t${LIBRARY_DIR}/src/convert.cpp\n+\t${LIBRARY_DIR}/src/exceptions.cpp\n+\t${LIBRARY_DIR}/src/ostream_wrapper.cpp\n+\t${LIBRARY_DIR}/src/simplekey.cpp\n+\t${LIBRARY_DIR}/src/depthguard.cpp \n+\t${LIBRARY_DIR}/src/exp.cpp\n+\t${LIBRARY_DIR}/src/parse.cpp\n+\t${LIBRARY_DIR}/src/singledocparser.cpp\n+\t${LIBRARY_DIR}/src/directives.cpp\n+\t${LIBRARY_DIR}/src/memory.cpp\n+\t${LIBRARY_DIR}/src/parser.cpp\n+\t${LIBRARY_DIR}/src/stream.cpp\n+\t${LIBRARY_DIR}/src/emit.cpp\n+\t${LIBRARY_DIR}/src/nodebuilder.cpp\n+\t${LIBRARY_DIR}/src/regex_yaml.cpp\n+\t${LIBRARY_DIR}/src/tag.cpp\n+\t${LIBRARY_DIR}/src/emitfromevents.cpp\n+\t${LIBRARY_DIR}/src/node.cpp\n+\t${LIBRARY_DIR}/src/scanner.cpp\n+\t${LIBRARY_DIR}/src/emitter.cpp\n+\t${LIBRARY_DIR}/src/node_data.cpp\n+\t${LIBRARY_DIR}/src/scanscalar.cpp\n+\t${LIBRARY_DIR}/src/emitterstate.cpp\n+\t${LIBRARY_DIR}/src/nodeevents.cpp\n+\t${LIBRARY_DIR}/src/scantag.cpp\n+)\n+\n+add_library (yaml-cpp ${SRCS})\n+\n+\n+target_include_directories(yaml-cpp PRIVATE ${LIBRARY_DIR}/include/yaml-cpp)\n+target_include_directories(yaml-cpp SYSTEM BEFORE PUBLIC ${LIBRARY_DIR}/include)\ndiff --git a/programs/server/config-example.yaml.disabled b/programs/server/config-example.yaml.disabled\nnew file mode 100644\nindex 000000000000..a83acf50de00\n--- /dev/null\n+++ b/programs/server/config-example.yaml.disabled\n@@ -0,0 +1,86 @@\n+# We can use 3 main node types in YAML: Scalar, Map and Sequence.\n+\n+\n+\n+# A Scalar is a simple key-value pair:\n+\n+scalar: 123\n+\n+# Here we have a key \"scalar\" and value \"123\"\n+# If we rewrite this in XML, we will get <scalar>123</scalar>\n+\n+# We can also represent an empty value with '':\n+\n+key: ''\n+\n+\n+\n+# A Map is a node, which contains other nodes:\n+\n+map:\n+  key1: value1\n+  key2: value2\n+  small_map:\n+    key3: value3\n+    \n+# This map can be converted into:\n+# <map>\n+#     <key1>value1</key1>\n+#     <key2>value2</key2>\n+#     <small_map>\n+#         <key3>value3</key3>\n+#     </small_map>\n+# </map>\n+\n+\n+\n+# A Sequence is a node, which contains also other nodes.\n+# The main difference from Map is that Sequence can also contain simple values.\n+\n+sequence:\n+  - val1\n+  - val2\n+  - key: 123\n+  - map:\n+      mkey1: foo\n+      mkey2: bar\n+      \n+# We can represent it in XML this way:\n+# <sequence>val1</sequence>\n+# <sequence>val2</sequence>\n+# <sequence>\n+#     <key>123</key>\n+# </sequence>\n+# <sequence>\n+#     <map>\n+#         <mkey1>foo</mkey1>\n+#         <mkey2>bar</mkey2>\n+#     </map>\n+# </sequence>\n+\n+\n+\n+# YAML does not have direct support for structures like XML attributes.\n+# We represent them as nodes with @ prefix in key. Note, that @ is reserved by YAML standard,\n+# so you will need to write double quotes around the key. Both Map and Sequence can have\n+# attributes as children nodes\n+\n+map:\n+  \"@attr1\": value1\n+  \"@attr2\": value2\n+  key: 123\n+  \n+# This gives us:\n+# <map attr1=\"value1\" attr2=\"value2\">\n+#     <key>123</key>\n+# </map>\n+\n+sequence:\n+  - \"@attr1\": value1\n+  - \"@attr2\": value2\n+  - 123\n+  - abc\n+  \n+# And this gives us:\n+# <map attr1=\"value1\" attr2=\"value2\">123</map>\n+# <map attr1=\"value1\" attr2=\"value2\">abc</map>\ndiff --git a/src/Common/Config/CMakeLists.txt b/src/Common/Config/CMakeLists.txt\nindex a7914fb17ecf..3da44be2af67 100644\n--- a/src/Common/Config/CMakeLists.txt\n+++ b/src/Common/Config/CMakeLists.txt\n@@ -3,6 +3,7 @@ set (SRCS\n     ConfigProcessor.cpp\n     configReadClient.cpp\n     ConfigReloader.cpp\n+    YAMLParser.cpp\n )\n \n add_library(clickhouse_common_config ${SRCS})\n@@ -15,3 +16,10 @@ target_link_libraries(clickhouse_common_config\n     PRIVATE\n         string_utils\n )\n+\n+if (USE_YAML_CPP)\n+target_link_libraries(clickhouse_common_config\n+    PRIVATE\n+        yaml-cpp\n+)\n+endif()\ndiff --git a/src/Common/Config/ConfigProcessor.cpp b/src/Common/Config/ConfigProcessor.cpp\nindex bc2a8a279438..fa9e9b720874 100644\n--- a/src/Common/Config/ConfigProcessor.cpp\n+++ b/src/Common/Config/ConfigProcessor.cpp\n@@ -1,4 +1,8 @@\n+#if !defined(ARCADIA_BUILD)\n+    #include <Common/config.h>\n+#endif\n #include \"ConfigProcessor.h\"\n+#include \"YAMLParser.h\"\n \n #include <sys/utsname.h>\n #include <cerrno>\n@@ -20,10 +24,8 @@\n #include <IO/WriteBufferFromString.h>\n #include <IO/Operators.h>\n \n-\n #define PREPROCESSED_SUFFIX \"-preprocessed\"\n \n-\n namespace fs = std::filesystem;\n \n using namespace Poco::XML;\n@@ -438,8 +440,10 @@ ConfigProcessor::Files ConfigProcessor::getConfigMergeFiles(const std::string &\n             std::string base_name = path.getBaseName();\n \n             // Skip non-config and temporary files\n-            if (file.isFile() && (extension == \"xml\" || extension == \"conf\") && !startsWith(base_name, \".\"))\n-                files.push_back(file.path());\n+            if (file.isFile() && (extension == \"xml\" || extension == \"conf\" || extension == \"yaml\" || extension == \"yml\") && !startsWith(base_name, \".\"))\n+            {\n+               files.push_back(file.path());\n+            }\n         }\n     }\n \n@@ -453,12 +457,21 @@ XMLDocumentPtr ConfigProcessor::processConfig(\n     zkutil::ZooKeeperNodeCache * zk_node_cache,\n     const zkutil::EventPtr & zk_changed_event)\n {\n-    XMLDocumentPtr config;\n     LOG_DEBUG(log, \"Processing configuration file '{}'.\", path);\n \n+    XMLDocumentPtr config;\n+\n     if (fs::exists(path))\n     {\n-        config = dom_parser.parse(path);\n+        fs::path p(path);\n+        if (p.extension() == \".xml\")\n+        {\n+            config = dom_parser.parse(path);\n+        }\n+        else if (p.extension() == \".yaml\" || p.extension() == \".yml\")\n+        {\n+            config = YAMLParser::parse(path);\n+        }\n     }\n     else\n     {\n@@ -493,8 +506,20 @@ XMLDocumentPtr ConfigProcessor::processConfig(\n         {\n             LOG_DEBUG(log, \"Merging configuration file '{}'.\", merge_file);\n \n-            XMLDocumentPtr with = dom_parser.parse(merge_file);\n+            XMLDocumentPtr with;\n+\n+            fs::path p(merge_file);\n+            if (p.extension() == \".yaml\" || p.extension() == \".yml\")\n+            {\n+                with = YAMLParser::parse(merge_file);\n+            }\n+            else\n+            {\n+                with = dom_parser.parse(merge_file);\n+            }\n+\n             merge(config, with);\n+\n             contributing_files.push_back(merge_file);\n         }\n         catch (Exception & e)\ndiff --git a/src/Common/Config/ConfigProcessor.h b/src/Common/Config/ConfigProcessor.h\nindex 7a4102140d99..5b16bc0cb1b7 100644\n--- a/src/Common/Config/ConfigProcessor.h\n+++ b/src/Common/Config/ConfigProcessor.h\n@@ -1,5 +1,9 @@\n #pragma once\n \n+#if !defined(ARCADIA_BUILD)\n+    #include <Common/config.h>\n+#endif\n+\n #include <string>\n #include <unordered_set>\n #include <vector>\n@@ -141,3 +145,4 @@ class ConfigProcessor\n };\n \n }\n+\ndiff --git a/src/Common/Config/YAMLParser.cpp b/src/Common/Config/YAMLParser.cpp\nnew file mode 100644\nindex 000000000000..9eaf1cdc1adf\n--- /dev/null\n+++ b/src/Common/Config/YAMLParser.cpp\n@@ -0,0 +1,166 @@\n+#if !defined(ARCADIA_BUILD)\n+    #include <Common/config.h>\n+#endif\n+\n+#if USE_YAML_CPP\n+#include \"YAMLParser.h\"\n+\n+#include <string>\n+#include <cstring>\n+#include <vector>\n+\n+#include <Poco/DOM/Document.h>\n+#include <Poco/DOM/DOMParser.h>\n+#include <Poco/DOM/DOMWriter.h>\n+#include <Poco/DOM/NodeList.h>\n+#include <Poco/DOM/Element.h>\n+#include <Poco/DOM/AutoPtr.h>\n+#include <Poco/DOM/NamedNodeMap.h>\n+#include <Poco/DOM/Text.h>\n+#include <Common/Exception.h>\n+\n+#include <yaml-cpp/yaml.h> // Y_IGNORE\n+\n+#include <common/logger_useful.h>\n+\n+using namespace Poco::XML;\n+\n+namespace DB\n+{\n+\n+namespace ErrorCodes\n+{\n+    extern const int CANNOT_OPEN_FILE;\n+    extern const int CANNOT_PARSE_YAML;\n+}\n+\n+/// A prefix symbol in yaml key\n+/// We add attributes to nodes by using a prefix symbol in the key part.\n+/// Currently we use @ as a prefix symbol. Note, that @ is reserved\n+/// by YAML standard, so we need to write a key-value pair like this: \"@attribute\": attr_value\n+const char YAML_ATTRIBUTE_PREFIX = '@';\n+\n+namespace\n+{\n+\n+Poco::AutoPtr<Poco::XML::Element> createCloneNode(Poco::XML::Element & original_node)\n+{\n+    Poco::AutoPtr<Poco::XML::Element> clone_node = original_node.ownerDocument()->createElement(original_node.nodeName());\n+    original_node.parentNode()->appendChild(clone_node);\n+    return clone_node;\n+}\n+\n+void processNode(const YAML::Node & node, Poco::XML::Element & parent_xml_element)\n+{\n+    auto * xml_document = parent_xml_element.ownerDocument();\n+    switch (node.Type())\n+    {\n+        case YAML::NodeType::Scalar:\n+        {\n+            auto value = node.as<std::string>();\n+            Poco::AutoPtr<Poco::XML::Text> xml_value = xml_document->createTextNode(value);\n+            parent_xml_element.appendChild(xml_value);\n+            break;\n+        }\n+\n+        /// We process YAML Sequences as a\n+        /// list of <key>value</key> tags with same key and different values.\n+        /// For example, we translate this sequence\n+        /// seq:\n+        ///     - val1\n+        ///     - val2\n+        ///\n+        /// into this:\n+        /// <seq>val1</seq>\n+        /// <seq>val2</seq>\n+        case YAML::NodeType::Sequence:\n+        {\n+            for (const auto & child_node : node)\n+                if (parent_xml_element.hasChildNodes())\n+                {\n+                    /// We want to process sequences like that:\n+                    /// seq:\n+                    ///     - val1\n+                    ///     - k2: val2\n+                    ///     - val3\n+                    ///     - k4: val4\n+                    ///     - val5\n+                    /// into xml like this:\n+                    /// <seq>val1</seq>\n+                    /// <seq>\n+                    ///     <k2>val2</k2>\n+                    /// </seq>\n+                    /// <seq>val3</seq>\n+                    /// <seq>\n+                    ///     <k4>val4</k4>\n+                    /// </seq>\n+                    /// <seq>val5</seq>\n+                    /// So, we create a new parent node with same tag for each child node\n+                    processNode(child_node, *createCloneNode(parent_xml_element));\n+                }\n+                else\n+                {\n+                    processNode(child_node, parent_xml_element);\n+                }\n+            break;\n+        }\n+        case YAML::NodeType::Map:\n+        {\n+            for (const auto & key_value_pair : node)\n+            {\n+                const auto & key_node = key_value_pair.first;\n+                const auto & value_node = key_value_pair.second;\n+                auto key = key_node.as<std::string>();\n+                bool is_attribute = (key.starts_with(YAML_ATTRIBUTE_PREFIX) && value_node.IsScalar());\n+                if (is_attribute)\n+                {\n+                    /// we use substr(1) here to remove YAML_ATTRIBUTE_PREFIX from key\n+                    auto attribute_name = key.substr(1);\n+                    auto value = value_node.as<std::string>();\n+                    parent_xml_element.setAttribute(attribute_name, value);\n+                }\n+                else\n+                {\n+                    Poco::AutoPtr<Poco::XML::Element> xml_key = xml_document->createElement(key);\n+                    parent_xml_element.appendChild(xml_key);\n+                    processNode(value_node, *xml_key);\n+                }\n+            }\n+            break;\n+        }\n+        case YAML::NodeType::Null: break;\n+        case YAML::NodeType::Undefined:\n+        {\n+            throw Exception(ErrorCodes::CANNOT_PARSE_YAML, \"YAMLParser has encountered node with undefined type and cannot continue parsing of the file\");\n+        }\n+    }\n+}\n+\n+}\n+\n+Poco::AutoPtr<Poco::XML::Document> YAMLParser::parse(const String& path)\n+{\n+    YAML::Node node_yml;\n+    try\n+    {\n+        node_yml = YAML::LoadFile(path);\n+    }\n+    catch (const YAML::ParserException& e)\n+    {\n+        /// yaml-cpp cannot parse the file because its contents are incorrect\n+        throw Exception(ErrorCodes::CANNOT_PARSE_YAML, \"Unable to parse YAML configuration file {}\", path, e.what());\n+    }\n+    catch (const YAML::BadFile&)\n+    {\n+        /// yaml-cpp cannot open the file even though it exists\n+        throw Exception(ErrorCodes::CANNOT_OPEN_FILE, \"Unable to open YAML configuration file {}\", path);\n+    }\n+    Poco::AutoPtr<Poco::XML::Document> xml = new Document;\n+    Poco::AutoPtr<Poco::XML::Element> root_node = xml->createElement(\"yandex\");\n+    xml->appendChild(root_node);\n+    processNode(node_yml, *root_node);\n+    return xml;\n+}\n+\n+}\n+#endif\ndiff --git a/src/Common/Config/YAMLParser.h b/src/Common/Config/YAMLParser.h\nnew file mode 100644\nindex 000000000000..a716f3de9b11\n--- /dev/null\n+++ b/src/Common/Config/YAMLParser.h\n@@ -0,0 +1,55 @@\n+#pragma once\n+\n+#if !defined(ARCADIA_BUILD)\n+    #include <Common/config.h>\n+#endif\n+\n+#include <string>\n+\n+#include <Poco/DOM/Document.h>\n+#include \"Poco/DOM/AutoPtr.h\"\n+#include <common/logger_useful.h>\n+\n+#if USE_YAML_CPP\n+\n+namespace DB\n+{\n+\n+/// Real YAML parser: loads yaml file into a YAML::Node\n+class YAMLParserImpl\n+{\n+public:\n+    static Poco::AutoPtr<Poco::XML::Document> parse(const String& path);\n+};\n+\n+using YAMLParser = YAMLParserImpl;\n+\n+}\n+\n+#else\n+\n+namespace DB\n+{\n+\n+namespace ErrorCodes\n+{\n+    extern const int CANNOT_PARSE_YAML;\n+}\n+\n+/// Fake YAML parser: throws an exception if we try to parse YAML configs in a build without yaml-cpp\n+class DummyYAMLParser\n+{\n+public:\n+    static Poco::AutoPtr<Poco::XML::Document> parse(const String& path)\n+    {\n+        Poco::AutoPtr<Poco::XML::Document> xml = new Poco::XML::Document;\n+        throw Exception(ErrorCodes::CANNOT_PARSE_YAML, \"Unable to parse YAML configuration file {} without usage of yaml-cpp library\", path);\n+        return xml;\n+    }\n+};\n+\n+using YAMLParser = DummyYAMLParser;\n+\n+}\n+\n+#endif\ndiff --git a/src/Common/ErrorCodes.cpp b/src/Common/ErrorCodes.cpp\nindex b1efd791bf89..330a193212bd 100644\n--- a/src/Common/ErrorCodes.cpp\n+++ b/src/Common/ErrorCodes.cpp\n@@ -552,6 +552,7 @@\n     M(582, NO_SUCH_PROJECTION_IN_TABLE) \\\n     M(583, ILLEGAL_PROJECTION) \\\n     M(584, PROJECTION_NOT_USED) \\\n+    M(585, CANNOT_PARSE_YAML) \\\n     \\\n     M(998, POSTGRESQL_CONNECTION_FAILURE) \\\n     M(999, KEEPER_EXCEPTION) \\\ndiff --git a/src/Common/config.h.in b/src/Common/config.h.in\nindex 28a21ea77646..6844f0fa9e30 100644\n--- a/src/Common/config.h.in\n+++ b/src/Common/config.h.in\n@@ -16,3 +16,4 @@\n #cmakedefine01 USE_STATS\n #cmakedefine01 CLICKHOUSE_SPLIT_BINARY\n #cmakedefine01 USE_DATASKETCHES\n+#cmakedefine01 USE_YAML_CPP\n",
  "test_patch": "diff --git a/tests/integration/helpers/cluster.py b/tests/integration/helpers/cluster.py\nindex 5bd608ef758e..6287064b6168 100644\n--- a/tests/integration/helpers/cluster.py\n+++ b/tests/integration/helpers/cluster.py\n@@ -126,7 +126,8 @@ class ClickHouseCluster:\n     \"\"\"\n \n     def __init__(self, base_path, name=None, base_config_dir=None, server_bin_path=None, client_bin_path=None,\n-                 odbc_bridge_bin_path=None, library_bridge_bin_path=None, zookeeper_config_path=None, custom_dockerd_host=None):\n+                 odbc_bridge_bin_path=None, library_bridge_bin_path=None, zookeeper_config_path=None, \n+                 custom_dockerd_host=None):\n         for param in list(os.environ.keys()):\n             print(\"ENV %40s %s\" % (param, os.environ[param]))\n         self.base_dir = p.dirname(base_path)\n@@ -219,7 +220,9 @@ def add_instance(self, name, base_config_dir=None, main_configs=None, user_confi\n                      with_redis=False, with_minio=False, with_cassandra=False,\n                      hostname=None, env_variables=None, image=\"yandex/clickhouse-integration-test\", tag=None,\n                      stay_alive=False, ipv4_address=None, ipv6_address=None, with_installed_binary=False, tmpfs=None,\n-                     zookeeper_docker_compose_path=None, zookeeper_use_tmpfs=True, minio_certs_dir=None, use_keeper=True):\n+                     zookeeper_docker_compose_path=None, zookeeper_use_tmpfs=True, minio_certs_dir=None, use_keeper=True,\n+                     main_config_name=\"config.xml\", users_config_name=\"users.xml\", copy_common_configs=True):\n+\n         \"\"\"Add an instance to the cluster.\n \n         name - the name of the instance directory and the value of the 'instance' macro in ClickHouse.\n@@ -280,6 +283,9 @@ def add_instance(self, name, base_config_dir=None, main_configs=None, user_confi\n             ipv4_address=ipv4_address,\n             ipv6_address=ipv6_address,\n             with_installed_binary=with_installed_binary,\n+            main_config_name=main_config_name,\n+            users_config_name=users_config_name,\n+            copy_common_configs=copy_common_configs,\n             tmpfs=tmpfs or [])\n \n         docker_compose_yml_dir = get_docker_compose_path()\n@@ -944,7 +950,7 @@ def start_zookeeper_nodes(self, zk_nodes):\n             subprocess_check_call(self.base_zookeeper_cmd + [\"start\", n])\n \n \n-CLICKHOUSE_START_COMMAND = \"clickhouse server --config-file=/etc/clickhouse-server/config.xml --log-file=/var/log/clickhouse-server/clickhouse-server.log --errorlog-file=/var/log/clickhouse-server/clickhouse-server.err.log\"\n+CLICKHOUSE_START_COMMAND = \"clickhouse server --config-file=/etc/clickhouse-server/{main_config_file} --log-file=/var/log/clickhouse-server/clickhouse-server.log --errorlog-file=/var/log/clickhouse-server/clickhouse-server.err.log\"\n \n CLICKHOUSE_STAY_ALIVE_COMMAND = 'bash -c \"{} --daemon; tail -f /dev/null\"'.format(CLICKHOUSE_START_COMMAND)\n \n@@ -1000,6 +1006,8 @@ def __init__(\n             macros, with_zookeeper, zookeeper_config_path, with_mysql, with_mysql_cluster, with_kafka, with_kerberized_kafka, with_rabbitmq, with_kerberized_hdfs,\n             with_mongo, with_redis, with_minio,\n             with_cassandra, server_bin_path, odbc_bridge_bin_path, library_bridge_bin_path, clickhouse_path_dir, with_odbc_drivers,\n+            clickhouse_start_command=CLICKHOUSE_START_COMMAND,\n+            main_config_name=\"config.xml\", users_config_name=\"users.xml\", copy_common_configs=True,\n             hostname=None, env_variables=None,\n             image=\"yandex/clickhouse-integration-test\", tag=\"latest\",\n             stay_alive=False, ipv4_address=None, ipv6_address=None, with_installed_binary=False, tmpfs=None):\n@@ -1036,6 +1044,12 @@ def __init__(\n         self.with_minio = with_minio\n         self.with_cassandra = with_cassandra\n \n+        self.main_config_name = main_config_name\n+        self.users_config_name = users_config_name\n+        self.copy_common_configs = copy_common_configs\n+\n+        self.clickhouse_start_command = clickhouse_start_command.replace(\"{main_config_file}\", self.main_config_name)\n+\n         self.path = p.join(self.cluster.instances_dir, name)\n         self.docker_compose_path = p.join(self.path, 'docker-compose.yml')\n         self.env_variables = env_variables or {}\n@@ -1177,7 +1191,7 @@ def start_clickhouse(self, start_wait_sec=30):\n         if not self.stay_alive:\n             raise Exception(\"clickhouse can be started again only with stay_alive=True instance\")\n \n-        self.exec_in_container([\"bash\", \"-c\", \"{} --daemon\".format(CLICKHOUSE_START_COMMAND)], user=str(os.getuid()))\n+        self.exec_in_container([\"bash\", \"-c\", \"{} --daemon\".format(self.clickhouse_start_command)], user=str(os.getuid()))\n         # wait start\n         from helpers.test_tools import assert_eq_with_retry\n         assert_eq_with_retry(self, \"select 1\", \"1\", retry_count=int(start_wait_sec / 0.5), sleep_time=0.5)\n@@ -1263,7 +1277,7 @@ def restart_with_latest_version(self, stop_start_wait_sec=10, callback_onstop=No\n         self.exec_in_container([\"bash\", \"-c\",\n                                 \"cp /usr/share/clickhouse-odbc-bridge_fresh /usr/bin/clickhouse-odbc-bridge && chmod 777 /usr/bin/clickhouse\"],\n                                user='root')\n-        self.exec_in_container([\"bash\", \"-c\", \"{} --daemon\".format(CLICKHOUSE_START_COMMAND)], user=str(os.getuid()))\n+        self.exec_in_container([\"bash\", \"-c\", \"{} --daemon\".format(self.clickhouse_start_command)], user=str(os.getuid()))\n         from helpers.test_tools import assert_eq_with_retry\n         # wait start\n         assert_eq_with_retry(self, \"select 1\", \"1\", retry_count=retries)\n@@ -1404,8 +1418,10 @@ def create_dir(self, destroy_dir=True):\n         os.makedirs(instance_config_dir)\n \n         print(\"Copy common default production configuration from {}\".format(self.base_config_dir))\n-        shutil.copyfile(p.join(self.base_config_dir, 'config.xml'), p.join(instance_config_dir, 'config.xml'))\n-        shutil.copyfile(p.join(self.base_config_dir, 'users.xml'), p.join(instance_config_dir, 'users.xml'))\n+\n+        shutil.copyfile(p.join(self.base_config_dir, self.main_config_name), p.join(instance_config_dir, self.main_config_name))\n+\n+        shutil.copyfile(p.join(self.base_config_dir, self.users_config_name), p.join(instance_config_dir, self.users_config_name))\n \n         print(\"Create directory for configuration generated in this helper\")\n         # used by all utils with any config\n@@ -1423,7 +1439,9 @@ def create_dir(self, destroy_dir=True):\n \n         print(\"Copy common configuration from helpers\")\n         # The file is named with 0_ prefix to be processed before other configuration overloads.\n-        shutil.copy(p.join(HELPERS_DIR, '0_common_instance_config.xml'), self.config_d_dir)\n+        if self.copy_common_configs:\n+            shutil.copy(p.join(HELPERS_DIR, '0_common_instance_config.xml'), self.config_d_dir)\n+\n         shutil.copy(p.join(HELPERS_DIR, '0_common_instance_users.xml'), users_d_dir)\n         if len(self.custom_dictionaries_paths):\n             shutil.copy(p.join(HELPERS_DIR, '0_common_enable_dictionaries.xml'), self.config_d_dir)\n@@ -1502,11 +1520,11 @@ def create_dir(self, destroy_dir=True):\n             self._create_odbc_config_file()\n             odbc_ini_path = '- ' + self.odbc_ini_path\n \n-        entrypoint_cmd = CLICKHOUSE_START_COMMAND\n+        entrypoint_cmd = self.clickhouse_start_command\n \n         if self.stay_alive:\n-            entrypoint_cmd = CLICKHOUSE_STAY_ALIVE_COMMAND\n-\n+            entrypoint_cmd = CLICKHOUSE_STAY_ALIVE_COMMAND.replace(\"{main_config_file}\", self.main_config_name)\n+        \n         print(\"Entrypoint cmd: {}\".format(entrypoint_cmd))\n \n         networks = app_net = ipv4_address = ipv6_address = net_aliases = net_alias1 = \"\"\ndiff --git a/tests/integration/runner b/tests/integration/runner\nindex ee116c29aa5e..16eb31dfd5e0 100755\n--- a/tests/integration/runner\n+++ b/tests/integration/runner\n@@ -70,11 +70,11 @@ def check_args_and_update_paths(args):\n         if not os.path.exists(path):\n             raise Exception(\"Path {} doesn't exist\".format(path))\n \n-    if not os.path.exists(os.path.join(args.base_configs_dir, \"config.xml\")):\n-        raise Exception(\"No configs.xml in {}\".format(args.base_configs_dir))\n+    if (not os.path.exists(os.path.join(args.base_configs_dir, \"config.xml\"))) and (not os.path.exists(os.path.join(args.base_configs_dir, \"config.yaml\"))):\n+        raise Exception(\"No configs.xml or configs.yaml in {}\".format(args.base_configs_dir))\n \n-    if not os.path.exists(os.path.join(args.base_configs_dir, \"users.xml\")):\n-        raise Exception(\"No users.xml in {}\".format(args.base_configs_dir))\n+    if (not os.path.exists(os.path.join(args.base_configs_dir, \"users.xml\"))) and (not os.path.exists(os.path.join(args.base_configs_dir, \"users.yaml\"))):\n+        raise Exception(\"No users.xml or users.yaml in {}\".format(args.base_configs_dir))\n \n def docker_kill_handler_handler(signum, frame):\n     subprocess.check_call('docker kill $(docker ps -a -q --filter name={name} --format=\"{{{{.ID}}}}\")'.format(name=CONTAINER_NAME), shell=True)\ndiff --git a/tests/integration/test_config_xml_full/__init__.py b/tests/integration/test_config_xml_full/__init__.py\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/access_control.xml b/tests/integration/test_config_xml_full/configs/config.d/access_control.xml\nnew file mode 100644\nindex 000000000000..6567c39f171a\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/access_control.xml\n@@ -0,0 +1,13 @@\n+<yandex>\n+    <!-- Sources to read users, roles, access rights, profiles of settings, quotas. -->\n+    <user_directories replace=\"replace\">\n+        <users_xml>\n+            <!-- Path to configuration file with predefined users. -->\n+            <path>users.xml</path>\n+        </users_xml>\n+        <local_directory>\n+            <!-- Path to folder where users created by SQL commands are stored. -->\n+            <path>access/</path>\n+        </local_directory>\n+    </user_directories>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/keeper_port.xml b/tests/integration/test_config_xml_full/configs/config.d/keeper_port.xml\nnew file mode 100644\nindex 000000000000..b21df47bc850\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/keeper_port.xml\n@@ -0,0 +1,23 @@\n+<yandex>\n+    <keeper_server>\n+        <tcp_port>9181</tcp_port>\n+        <server_id>1</server_id>\n+\n+        <coordination_settings>\n+            <operation_timeout_ms>10000</operation_timeout_ms>\n+            <session_timeout_ms>30000</session_timeout_ms>\n+            <force_sync>false</force_sync>\n+            <startup_timeout>60000</startup_timeout>\n+            <!-- we want all logs for complex problems investigation -->\n+            <reserved_log_items>1000000000000000</reserved_log_items>\n+        </coordination_settings>\n+\n+        <raft_configuration>\n+            <server>\n+                <id>1</id>\n+                <hostname>localhost</hostname>\n+                <port>44444</port>\n+            </server>\n+        </raft_configuration>\n+    </keeper_server>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/log_to_console.xml b/tests/integration/test_config_xml_full/configs/config.d/log_to_console.xml\nnew file mode 100644\nindex 000000000000..227c53647f32\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/log_to_console.xml\n@@ -0,0 +1,7 @@\n+<yandex>\n+    <logger>\n+        <console>true</console>\n+        <log remove=\"remove\"/>\n+        <errorlog remove=\"remove\"/>\n+    </logger>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/logging_no_rotate.xml b/tests/integration/test_config_xml_full/configs/config.d/logging_no_rotate.xml\nnew file mode 100644\nindex 000000000000..2c34585437bf\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/logging_no_rotate.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <logger>\n+        <!-- Disable rotation\n+             https://pocoproject.org/docs/Poco.FileChannel.html\n+        -->\n+        <size>never</size>\n+    </logger>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/macros.xml b/tests/integration/test_config_xml_full/configs/config.d/macros.xml\nnew file mode 100644\nindex 000000000000..4902b12bc819\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/macros.xml\n@@ -0,0 +1,9 @@\n+<yandex>\n+    <macros>\n+        <test>Hello, world!</test>\n+        <shard>s1</shard>\n+        <replica>r1</replica>\n+        <default_path_test>/clickhouse/tables/{database}/{shard}/</default_path_test>\n+        <default_name_test>table_{table}</default_name_test>\n+    </macros>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/metric_log.xml b/tests/integration/test_config_xml_full/configs/config.d/metric_log.xml\nnew file mode 100644\nindex 000000000000..0ca9f1624169\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/metric_log.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <metric_log>\n+        <database>system</database>\n+        <table>metric_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+        <collect_interval_milliseconds>1000</collect_interval_milliseconds>\n+    </metric_log>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/more_clusters.xml b/tests/integration/test_config_xml_full/configs/config.d/more_clusters.xml\nnew file mode 100644\nindex 000000000000..aecbf9e0ba7b\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/more_clusters.xml\n@@ -0,0 +1,49 @@\n+<yandex>\n+    <remote_servers>\n+\n+        <![CDATA[\n+            You can run additional servers simply as\n+             ./clickhouse-server -- --path=9001 --tcp_port=9001\n+        ]]>\n+\n+        <single_remote_shard_at_port_9001>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9001</port>\n+                </replica>\n+            </shard>\n+        </single_remote_shard_at_port_9001>\n+\n+        <two_remote_shards_at_port_9001_9002>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9001</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9002</port>\n+                </replica>\n+            </shard>\n+        </two_remote_shards_at_port_9001_9002>\n+\n+        <two_shards_one_local_one_remote_at_port_9001>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9001</port>\n+                </replica>\n+            </shard>\n+        </two_shards_one_local_one_remote_at_port_9001>\n+\n+    </remote_servers>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/part_log.xml b/tests/integration/test_config_xml_full/configs/config.d/part_log.xml\nnew file mode 100644\nindex 000000000000..6c6fc9c69823\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/part_log.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <part_log>\n+        <database>system</database>\n+        <table>part_log</table>\n+\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </part_log>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/path.xml b/tests/integration/test_config_xml_full/configs/config.d/path.xml\nnew file mode 100644\nindex 000000000000..466ed0d16637\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/path.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <path replace=\"replace\">./</path>\n+    <tmp_path replace=\"replace\">./tmp/</tmp_path>\n+    <user_files_path replace=\"replace\">./user_files/</user_files_path>\n+    <format_schema_path replace=\"replace\">./format_schemas/</format_schema_path>\n+    <access_control_path replace=\"replace\">./access/</access_control_path>\n+    <top_level_domains_path replace=\"replace\">./top_level_domains/</top_level_domains_path>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/query_masking_rules.xml b/tests/integration/test_config_xml_full/configs/config.d/query_masking_rules.xml\nnew file mode 100644\nindex 000000000000..5a854848f3d7\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/query_masking_rules.xml\n@@ -0,0 +1,10 @@\n+<?xml version=\"1.0\"?>\n+<!-- Config for test server -->\n+<yandex>\n+    <query_masking_rules>\n+        <rule>\n+            <regexp>TOPSECRET.TOPSECRET</regexp>\n+            <replace>[hidden]</replace>\n+        </rule>\n+    </query_masking_rules>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/tcp_with_proxy.xml b/tests/integration/test_config_xml_full/configs/config.d/tcp_with_proxy.xml\nnew file mode 100644\nindex 000000000000..19046054c166\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/tcp_with_proxy.xml\n@@ -0,0 +1,3 @@\n+<yandex>\n+    <tcp_with_proxy_port>9010</tcp_with_proxy_port>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/text_log.xml b/tests/integration/test_config_xml_full/configs/config.d/text_log.xml\nnew file mode 100644\nindex 000000000000..3699a23578cd\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/text_log.xml\n@@ -0,0 +1,7 @@\n+<yandex>\n+    <text_log>\n+        <database>system</database>\n+        <table>text_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </text_log>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.d/zookeeper.xml b/tests/integration/test_config_xml_full/configs/config.d/zookeeper.xml\nnew file mode 100644\nindex 000000000000..06ed7fcd39f3\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.d/zookeeper.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <zookeeper>\n+        <node index=\"1\">\n+            <host>localhost</host>\n+            <port>9181</port>\n+        </node>\n+    </zookeeper>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/config.xml b/tests/integration/test_config_xml_full/configs/config.xml\nnew file mode 100644\nindex 000000000000..a7bb9d49e95c\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/config.xml\n@@ -0,0 +1,1118 @@\n+<?xml version=\"1.0\"?>\n+<!--\n+  NOTE: User and query level settings are set up in \"users.xml\" file.\n+  If you have accidentally specified user-level settings here, server won't start.\n+  You can either move the settings to the right place inside \"users.xml\" file\n+   or add <skip_check_for_incorrect_settings>1</skip_check_for_incorrect_settings> here.\n+-->\n+<yandex>\n+    <logger>\n+        <!-- Possible levels [1]:\n+\n+          - none (turns off logging)\n+          - fatal\n+          - critical\n+          - error\n+          - warning\n+          - notice\n+          - information\n+          - debug\n+          - trace\n+\n+            [1]: https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/Logger.h#L105-L114\n+        -->\n+        <level>trace</level>\n+        <log>/var/log/clickhouse-server/clickhouse-server.log</log>\n+        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>\n+        <!-- Rotation policy\n+             See https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/FileChannel.h#L54-L85\n+          -->\n+        <size>1000M</size>\n+        <count>10</count>\n+        <!-- <console>1</console> --> <!-- Default behavior is autodetection (log to console if not daemon mode and is tty) -->\n+\n+        <!-- Per level overrides (legacy):\n+\n+        For example to suppress logging of the ConfigReloader you can use:\n+        NOTE: levels.logger is reserved, see below.\n+        -->\n+        <!--\n+        <levels>\n+          <ConfigReloader>none</ConfigReloader>\n+        </levels>\n+        -->\n+\n+        <!-- Per level overrides:\n+\n+        For example to suppress logging of the RBAC for default user you can use:\n+        (But please note that the logger name maybe changed from version to version, even after minor upgrade)\n+        -->\n+        <!--\n+        <levels>\n+          <logger>\n+            <name>ContextAccess (default)</name>\n+            <level>none</level>\n+          </logger>\n+          <logger>\n+            <name>DatabaseOrdinary (test)</name>\n+            <level>none</level>\n+          </logger>\n+        </levels>\n+        -->\n+    </logger>\n+\n+    <!-- It is the name that will be shown in the clickhouse-client.\n+         By default, anything with \"production\" will be highlighted in red in query prompt.\n+    -->\n+    <!--display_name>production</display_name-->\n+\n+    <!-- Port for HTTP API. See also 'https_port' for secure connections.\n+         This interface is also used by ODBC and JDBC drivers (DataGrip, Dbeaver, ...)\n+         and by most of web interfaces (embedded UI, Grafana, Redash, ...).\n+      -->\n+    <http_port>8123</http_port>\n+\n+    <!-- Port for interaction by native protocol with:\n+         - clickhouse-client and other native ClickHouse tools (clickhouse-benchmark, clickhouse-copier);\n+         - clickhouse-server with other clickhouse-servers for distributed query processing;\n+         - ClickHouse drivers and applications supporting native protocol\n+         (this protocol is also informally called as \"the TCP protocol\");\n+         See also 'tcp_port_secure' for secure connections.\n+    -->\n+    <tcp_port>9000</tcp_port>\n+\n+    <!-- Compatibility with MySQL protocol.\n+         ClickHouse will pretend to be MySQL for applications connecting to this port.\n+    -->\n+    <mysql_port>9004</mysql_port>\n+\n+    <!-- Compatibility with PostgreSQL protocol.\n+         ClickHouse will pretend to be PostgreSQL for applications connecting to this port.\n+    -->\n+    <postgresql_port>9005</postgresql_port>\n+\n+    <!-- HTTP API with TLS (HTTPS).\n+         You have to configure certificate to enable this interface.\n+         See the openSSL section below.\n+    -->\n+    <!-- <https_port>8443</https_port> -->\n+\n+    <!-- Native interface with TLS.\n+         You have to configure certificate to enable this interface.\n+         See the openSSL section below.\n+    -->\n+    <!-- <tcp_port_secure>9440</tcp_port_secure> -->\n+\n+    <!-- Native interface wrapped with PROXYv1 protocol\n+         PROXYv1 header sent for every connection.\n+         ClickHouse will extract information about proxy-forwarded client address from the header.\n+    -->\n+    <!-- <tcp_with_proxy_port>9011</tcp_with_proxy_port> -->\n+\n+    <!-- Port for communication between replicas. Used for data exchange.\n+         It provides low-level data access between servers.\n+         This port should not be accessible from untrusted networks.\n+         See also 'interserver_http_credentials'.\n+         Data transferred over connections to this port should not go through untrusted networks.\n+         See also 'interserver_https_port'.\n+      -->\n+    <interserver_http_port>9009</interserver_http_port>\n+\n+    <!-- Port for communication between replicas with TLS.\n+         You have to configure certificate to enable this interface.\n+         See the openSSL section below.\n+         See also 'interserver_http_credentials'.\n+      -->\n+    <!-- <interserver_https_port>9010</interserver_https_port> -->\n+\n+    <!-- Hostname that is used by other replicas to request this server.\n+         If not specified, than it is determined analogous to 'hostname -f' command.\n+         This setting could be used to switch replication to another network interface\n+         (the server may be connected to multiple networks via multiple addresses)\n+      -->\n+    <!--\n+    <interserver_http_host>example.yandex.ru</interserver_http_host>\n+    -->\n+\n+    <!-- You can specify credentials for authenthication between replicas.\n+         This is required when interserver_https_port is accessible from untrusted networks,\n+         and also recommended to avoid SSRF attacks from possibly compromised services in your network.\n+      -->\n+    <!--<interserver_http_credentials>\n+        <user>interserver</user>\n+        <password></password>\n+    </interserver_http_credentials>-->\n+\n+    <!-- Listen specified address.\n+         Use :: (wildcard IPv6 address), if you want to accept connections both with IPv4 and IPv6 from everywhere.\n+         Notes:\n+         If you open connections from wildcard address, make sure that at least one of the following measures applied:\n+         - server is protected by firewall and not accessible from untrusted networks;\n+         - all users are restricted to subset of network addresses (see users.xml);\n+         - all users have strong passwords, only secure (TLS) interfaces are accessible, or connections are only made via TLS interfaces.\n+         - users without password have readonly access.\n+         See also: https://www.shodan.io/search?query=clickhouse\n+      -->\n+    <!-- <listen_host>::</listen_host> -->\n+\n+    <!-- Same for hosts without support for IPv6: -->\n+    <!-- <listen_host>0.0.0.0</listen_host> -->\n+\n+    <!-- Default values - try listen localhost on IPv4 and IPv6. -->\n+    <!--\n+    <listen_host>::1</listen_host>\n+    <listen_host>127.0.0.1</listen_host>\n+    -->\n+\n+    <!-- Don't exit if IPv6 or IPv4 networks are unavailable while trying to listen. -->\n+    <!-- <listen_try>0</listen_try> -->\n+\n+    <!-- Allow multiple servers to listen on the same address:port. This is not recommended.\n+      -->\n+    <!-- <listen_reuse_port>0</listen_reuse_port> -->\n+\n+    <!-- <listen_backlog>64</listen_backlog> -->\n+\n+    <max_connections>4096</max_connections>\n+\n+    <!-- For 'Connection: keep-alive' in HTTP 1.1 -->\n+    <keep_alive_timeout>3</keep_alive_timeout>\n+\n+    <!-- gRPC protocol (see src/Server/grpc_protos/clickhouse_grpc.proto for the API) -->\n+    <!-- <grpc_port>9100</grpc_port> -->\n+    <grpc>\n+        <enable_ssl>false</enable_ssl>\n+\n+        <!-- The following two files are used only if enable_ssl=1 -->\n+        <ssl_cert_file>/path/to/ssl_cert_file</ssl_cert_file>\n+        <ssl_key_file>/path/to/ssl_key_file</ssl_key_file>\n+\n+        <!-- Whether server will request client for a certificate -->\n+        <ssl_require_client_auth>false</ssl_require_client_auth>\n+\n+        <!-- The following file is used only if ssl_require_client_auth=1 -->\n+        <ssl_ca_cert_file>/path/to/ssl_ca_cert_file</ssl_ca_cert_file>\n+\n+        <!-- Default compression algorithm (applied if client doesn't specify another algorithm).\n+             Supported algorithms: none, deflate, gzip, stream_gzip -->\n+        <compression>deflate</compression>\n+\n+        <!-- Default compression level (applied if client doesn't specify another level).\n+             Supported levels: none, low, medium, high -->\n+        <compression_level>medium</compression_level>\n+\n+        <!-- Send/receive message size limits in bytes. -1 means unlimited -->\n+        <max_send_message_size>-1</max_send_message_size>\n+        <max_receive_message_size>-1</max_receive_message_size>\n+\n+        <!-- Enable if you want very detailed logs -->\n+        <verbose_logs>false</verbose_logs>\n+    </grpc>\n+\n+    <!-- Used with https_port and tcp_port_secure. Full ssl options list: https://github.com/ClickHouse-Extras/poco/blob/master/NetSSL_OpenSSL/include/Poco/Net/SSLManager.h#L71 -->\n+    <openSSL>\n+        <server> <!-- Used for https server AND secure tcp port -->\n+            <!-- openssl req -subj \"/CN=localhost\" -new -newkey rsa:2048 -days 365 -nodes -x509 -keyout /etc/clickhouse-server/server.key -out /etc/clickhouse-server/server.crt -->\n+            <certificateFile>/etc/clickhouse-server/server.crt</certificateFile>\n+            <privateKeyFile>/etc/clickhouse-server/server.key</privateKeyFile>\n+            <!-- dhparams are optional. You can delete the <dhParamsFile> element.\n+                 To generate dhparams, use the following command:\n+                  openssl dhparam -out /etc/clickhouse-server/dhparam.pem 4096\n+                 Only file format with BEGIN DH PARAMETERS is supported.\n+              -->\n+            <dhParamsFile>/etc/clickhouse-server/dhparam.pem</dhParamsFile>\n+            <verificationMode>none</verificationMode>\n+            <loadDefaultCAFile>true</loadDefaultCAFile>\n+            <cacheSessions>true</cacheSessions>\n+            <disableProtocols>sslv2,sslv3</disableProtocols>\n+            <preferServerCiphers>true</preferServerCiphers>\n+        </server>\n+\n+        <client> <!-- Used for connecting to https dictionary source and secured Zookeeper communication -->\n+            <loadDefaultCAFile>true</loadDefaultCAFile>\n+            <cacheSessions>true</cacheSessions>\n+            <disableProtocols>sslv2,sslv3</disableProtocols>\n+            <preferServerCiphers>true</preferServerCiphers>\n+            <!-- Use for self-signed: <verificationMode>none</verificationMode> -->\n+            <invalidCertificateHandler>\n+                <!-- Use for self-signed: <name>AcceptCertificateHandler</name> -->\n+                <name>RejectCertificateHandler</name>\n+            </invalidCertificateHandler>\n+        </client>\n+    </openSSL>\n+\n+    <!-- Default root page on http[s] server. For example load UI from https://tabix.io/ when opening http://localhost:8123 -->\n+    <!--\n+    <http_server_default_response><![CDATA[<html ng-app=\"SMI2\"><head><base href=\"http://ui.tabix.io/\"></head><body><div ui-view=\"\" class=\"content-ui\"></div><script src=\"http://loader.tabix.io/master.js\"></script></body></html>]]></http_server_default_response>\n+    -->\n+\n+    <!-- Maximum number of concurrent queries. -->\n+    <max_concurrent_queries>100</max_concurrent_queries>\n+\n+    <!-- Maximum memory usage (resident set size) for server process.\n+         Zero value or unset means default. Default is \"max_server_memory_usage_to_ram_ratio\" of available physical RAM.\n+         If the value is larger than \"max_server_memory_usage_to_ram_ratio\" of available physical RAM, it will be cut down.\n+\n+         The constraint is checked on query execution time.\n+         If a query tries to allocate memory and the current memory usage plus allocation is greater\n+          than specified threshold, exception will be thrown.\n+\n+         It is not practical to set this constraint to small values like just a few gigabytes,\n+          because memory allocator will keep this amount of memory in caches and the server will deny service of queries.\n+      -->\n+    <max_server_memory_usage>0</max_server_memory_usage>\n+\n+    <!-- Maximum number of threads in the Global thread pool.\n+    This will default to a maximum of 10000 threads if not specified.\n+    This setting will be useful in scenarios where there are a large number\n+    of distributed queries that are running concurrently but are idling most\n+    of the time, in which case a higher number of threads might be required.\n+    -->\n+\n+    <max_thread_pool_size>10000</max_thread_pool_size>\n+\n+    <!-- On memory constrained environments you may have to set this to value larger than 1.\n+      -->\n+    <max_server_memory_usage_to_ram_ratio>0.9</max_server_memory_usage_to_ram_ratio>\n+\n+    <!-- Simple server-wide memory profiler. Collect a stack trace at every peak allocation step (in bytes).\n+         Data will be stored in system.trace_log table with query_id = empty string.\n+         Zero means disabled.\n+      -->\n+    <total_memory_profiler_step>4194304</total_memory_profiler_step>\n+\n+    <!-- Collect random allocations and deallocations and write them into system.trace_log with 'MemorySample' trace_type.\n+         The probability is for every alloc/free regardless to the size of the allocation.\n+         Note that sampling happens only when the amount of untracked memory exceeds the untracked memory limit,\n+          which is 4 MiB by default but can be lowered if 'total_memory_profiler_step' is lowered.\n+         You may want to set 'total_memory_profiler_step' to 1 for extra fine grained sampling.\n+      -->\n+    <total_memory_tracker_sample_probability>0</total_memory_tracker_sample_probability>\n+\n+    <!-- Set limit on number of open files (default: maximum). This setting makes sense on Mac OS X because getrlimit() fails to retrieve\n+         correct maximum value. -->\n+    <!-- <max_open_files>262144</max_open_files> -->\n+\n+    <!-- Size of cache of uncompressed blocks of data, used in tables of MergeTree family.\n+         In bytes. Cache is single for server. Memory is allocated only on demand.\n+         Cache is used when 'use_uncompressed_cache' user setting turned on (off by default).\n+         Uncompressed cache is advantageous only for very short queries and in rare cases.\n+\n+         Note: uncompressed cache can be pointless for lz4, because memory bandwidth\n+         is slower than multi-core decompression on some server configurations.\n+         Enabling it can sometimes paradoxically make queries slower.\n+      -->\n+    <uncompressed_cache_size>8589934592</uncompressed_cache_size>\n+\n+    <!-- Approximate size of mark cache, used in tables of MergeTree family.\n+         In bytes. Cache is single for server. Memory is allocated only on demand.\n+         You should not lower this value.\n+      -->\n+    <mark_cache_size>5368709120</mark_cache_size>\n+\n+\n+    <!-- If you enable the `min_bytes_to_use_mmap_io` setting,\n+         the data in MergeTree tables can be read with mmap to avoid copying from kernel to userspace.\n+         It makes sense only for large files and helps only if data reside in page cache.\n+         To avoid frequent open/mmap/munmap/close calls (which are very expensive due to consequent page faults)\n+         and to reuse mappings from several threads and queries,\n+         the cache of mapped files is maintained. Its size is the number of mapped regions (usually equal to the number of mapped files).\n+         The amount of data in mapped files can be monitored\n+         in system.metrics, system.metric_log by the MMappedFiles, MMappedFileBytes metrics\n+         and in system.asynchronous_metrics, system.asynchronous_metrics_log by the MMapCacheCells metric,\n+         and also in system.events, system.processes, system.query_log, system.query_thread_log by the\n+         CreatedReadBufferMMap, CreatedReadBufferMMapFailed, MMappedFileCacheHits, MMappedFileCacheMisses events.\n+         Note that the amount of data in mapped files does not consume memory directly and is not accounted\n+         in query or server memory usage - because this memory can be discarded similar to OS page cache.\n+         The cache is dropped (the files are closed) automatically on removal of old parts in MergeTree,\n+         also it can be dropped manually by the SYSTEM DROP MMAP CACHE query.\n+      -->\n+    <mmap_cache_size>1000</mmap_cache_size>\n+\n+\n+    <!-- Path to data directory, with trailing slash. -->\n+    <path>/var/lib/clickhouse/</path>\n+\n+    <!-- Path to temporary data for processing hard queries. -->\n+    <tmp_path>/var/lib/clickhouse/tmp/</tmp_path>\n+\n+    <!-- Policy from the <storage_configuration> for the temporary files.\n+         If not set <tmp_path> is used, otherwise <tmp_path> is ignored.\n+\n+         Notes:\n+         - move_factor              is ignored\n+         - keep_free_space_bytes    is ignored\n+         - max_data_part_size_bytes is ignored\n+         - you must have exactly one volume in that policy\n+    -->\n+    <!-- <tmp_policy>tmp</tmp_policy> -->\n+\n+    <!-- Directory with user provided files that are accessible by 'file' table function. -->\n+    <user_files_path>/var/lib/clickhouse/user_files/</user_files_path>\n+\n+    <!-- LDAP server definitions. -->\n+    <ldap_servers>\n+        <!-- List LDAP servers with their connection parameters here to later 1) use them as authenticators for dedicated local users,\n+              who have 'ldap' authentication mechanism specified instead of 'password', or to 2) use them as remote user directories.\n+             Parameters:\n+                host - LDAP server hostname or IP, this parameter is mandatory and cannot be empty.\n+                port - LDAP server port, default is 636 if enable_tls is set to true, 389 otherwise.\n+                bind_dn - template used to construct the DN to bind to.\n+                        The resulting DN will be constructed by replacing all '{user_name}' substrings of the template with the actual\n+                         user name during each authentication attempt.\n+                verification_cooldown - a period of time, in seconds, after a successful bind attempt, during which a user will be assumed\n+                         to be successfully authenticated for all consecutive requests without contacting the LDAP server.\n+                        Specify 0 (the default) to disable caching and force contacting the LDAP server for each authentication request.\n+                enable_tls - flag to trigger use of secure connection to the LDAP server.\n+                        Specify 'no' for plain text (ldap://) protocol (not recommended).\n+                        Specify 'yes' for LDAP over SSL/TLS (ldaps://) protocol (recommended, the default).\n+                        Specify 'starttls' for legacy StartTLS protocol (plain text (ldap://) protocol, upgraded to TLS).\n+                tls_minimum_protocol_version - the minimum protocol version of SSL/TLS.\n+                        Accepted values are: 'ssl2', 'ssl3', 'tls1.0', 'tls1.1', 'tls1.2' (the default).\n+                tls_require_cert - SSL/TLS peer certificate verification behavior.\n+                        Accepted values are: 'never', 'allow', 'try', 'demand' (the default).\n+                tls_cert_file - path to certificate file.\n+                tls_key_file - path to certificate key file.\n+                tls_ca_cert_file - path to CA certificate file.\n+                tls_ca_cert_dir - path to the directory containing CA certificates.\n+                tls_cipher_suite - allowed cipher suite (in OpenSSL notation).\n+             Example:\n+                <my_ldap_server>\n+                    <host>localhost</host>\n+                    <port>636</port>\n+                    <bind_dn>uid={user_name},ou=users,dc=example,dc=com</bind_dn>\n+                    <verification_cooldown>300</verification_cooldown>\n+                    <enable_tls>yes</enable_tls>\n+                    <tls_minimum_protocol_version>tls1.2</tls_minimum_protocol_version>\n+                    <tls_require_cert>demand</tls_require_cert>\n+                    <tls_cert_file>/path/to/tls_cert_file</tls_cert_file>\n+                    <tls_key_file>/path/to/tls_key_file</tls_key_file>\n+                    <tls_ca_cert_file>/path/to/tls_ca_cert_file</tls_ca_cert_file>\n+                    <tls_ca_cert_dir>/path/to/tls_ca_cert_dir</tls_ca_cert_dir>\n+                    <tls_cipher_suite>ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:AES256-GCM-SHA384</tls_cipher_suite>\n+                </my_ldap_server>\n+        -->\n+    </ldap_servers>\n+\n+    <!-- To enable Kerberos authentication support for HTTP requests (GSS-SPNEGO), for those users who are explicitly configured\n+          to authenticate via Kerberos, define a single 'kerberos' section here.\n+         Parameters:\n+            principal - canonical service principal name, that will be acquired and used when accepting security contexts.\n+                    This parameter is optional, if omitted, the default principal will be used.\n+                    This parameter cannot be specified together with 'realm' parameter.\n+            realm - a realm, that will be used to restrict authentication to only those requests whose initiator's realm matches it.\n+                    This parameter is optional, if omitted, no additional filtering by realm will be applied.\n+                    This parameter cannot be specified together with 'principal' parameter.\n+         Example:\n+            <kerberos />\n+         Example:\n+            <kerberos>\n+                <principal>HTTP/clickhouse.example.com@EXAMPLE.COM</principal>\n+            </kerberos>\n+         Example:\n+            <kerberos>\n+                <realm>EXAMPLE.COM</realm>\n+            </kerberos>\n+    -->\n+\n+    <!-- Sources to read users, roles, access rights, profiles of settings, quotas. -->\n+    <user_directories>\n+        <users_xml>\n+            <!-- Path to configuration file with predefined users. -->\n+            <path>users.xml</path>\n+        </users_xml>\n+        <local_directory>\n+            <!-- Path to folder where users created by SQL commands are stored. -->\n+            <path>/var/lib/clickhouse/access/</path>\n+        </local_directory>\n+\n+        <!-- To add an LDAP server as a remote user directory of users that are not defined locally, define a single 'ldap' section\n+              with the following parameters:\n+                server - one of LDAP server names defined in 'ldap_servers' config section above.\n+                        This parameter is mandatory and cannot be empty.\n+                roles - section with a list of locally defined roles that will be assigned to each user retrieved from the LDAP server.\n+                        If no roles are specified here or assigned during role mapping (below), user will not be able to perform any\n+                         actions after authentication.\n+                role_mapping - section with LDAP search parameters and mapping rules.\n+                        When a user authenticates, while still bound to LDAP, an LDAP search is performed using search_filter and the\n+                         name of the logged in user. For each entry found during that search, the value of the specified attribute is\n+                         extracted. For each attribute value that has the specified prefix, the prefix is removed, and the rest of the\n+                         value becomes the name of a local role defined in ClickHouse, which is expected to be created beforehand by\n+                         CREATE ROLE command.\n+                        There can be multiple 'role_mapping' sections defined inside the same 'ldap' section. All of them will be\n+                         applied.\n+                    base_dn - template used to construct the base DN for the LDAP search.\n+                            The resulting DN will be constructed by replacing all '{user_name}' and '{bind_dn}' substrings\n+                             of the template with the actual user name and bind DN during each LDAP search.\n+                    scope - scope of the LDAP search.\n+                            Accepted values are: 'base', 'one_level', 'children', 'subtree' (the default).\n+                    search_filter - template used to construct the search filter for the LDAP search.\n+                            The resulting filter will be constructed by replacing all '{user_name}', '{bind_dn}', and '{base_dn}'\n+                             substrings of the template with the actual user name, bind DN, and base DN during each LDAP search.\n+                            Note, that the special characters must be escaped properly in XML.\n+                    attribute - attribute name whose values will be returned by the LDAP search.\n+                    prefix - prefix, that will be expected to be in front of each string in the original list of strings returned by\n+                             the LDAP search. Prefix will be removed from the original strings and resulting strings will be treated\n+                             as local role names. Empty, by default.\n+             Example:\n+                <ldap>\n+                    <server>my_ldap_server</server>\n+                    <roles>\n+                        <my_local_role1 />\n+                        <my_local_role2 />\n+                    </roles>\n+                    <role_mapping>\n+                        <base_dn>ou=groups,dc=example,dc=com</base_dn>\n+                        <scope>subtree</scope>\n+                        <search_filter>(&amp;(objectClass=groupOfNames)(member={bind_dn}))</search_filter>\n+                        <attribute>cn</attribute>\n+                        <prefix>clickhouse_</prefix>\n+                    </role_mapping>\n+                </ldap>\n+        -->\n+    </user_directories>\n+\n+    <!-- Default profile of settings. -->\n+    <default_profile>default</default_profile>\n+\n+    <!-- Comma-separated list of prefixes for user-defined settings. -->\n+    <custom_settings_prefixes></custom_settings_prefixes>\n+\n+    <!-- System profile of settings. This settings are used by internal processes (Distributed DDL worker and so on). -->\n+    <!-- <system_profile>default</system_profile> -->\n+\n+    <!-- Buffer profile of settings.\n+         This settings are used by Buffer storage to flush data to the underlying table.\n+         Default: used from system_profile directive.\n+    -->\n+    <!-- <buffer_profile>default</buffer_profile> -->\n+\n+    <!-- Default database. -->\n+    <default_database>default</default_database>\n+\n+    <!-- Server time zone could be set here.\n+\n+         Time zone is used when converting between String and DateTime types,\n+          when printing DateTime in text formats and parsing DateTime from text,\n+          it is used in date and time related functions, if specific time zone was not passed as an argument.\n+\n+         Time zone is specified as identifier from IANA time zone database, like UTC or Africa/Abidjan.\n+         If not specified, system time zone at server startup is used.\n+\n+         Please note, that server could display time zone alias instead of specified name.\n+         Example: W-SU is an alias for Europe/Moscow and Zulu is an alias for UTC.\n+    -->\n+    <!-- <timezone>Europe/Moscow</timezone> -->\n+\n+    <!-- You can specify umask here (see \"man umask\"). Server will apply it on startup.\n+         Number is always parsed as octal. Default umask is 027 (other users cannot read logs, data files, etc; group can only read).\n+    -->\n+    <!-- <umask>022</umask> -->\n+\n+    <!-- Perform mlockall after startup to lower first queries latency\n+          and to prevent clickhouse executable from being paged out under high IO load.\n+         Enabling this option is recommended but will lead to increased startup time for up to a few seconds.\n+    -->\n+    <mlock_executable>true</mlock_executable>\n+\n+    <!-- Reallocate memory for machine code (\"text\") using huge pages. Highly experimental. -->\n+    <remap_executable>false</remap_executable>\n+\n+    <![CDATA[\n+         Uncomment below in order to use JDBC table engine and function.\n+\n+         To install and run JDBC bridge in background:\n+         * [Debian/Ubuntu]\n+           export MVN_URL=https://repo1.maven.org/maven2/ru/yandex/clickhouse/clickhouse-jdbc-bridge\n+           export PKG_VER=$(curl -sL $MVN_URL/maven-metadata.xml | grep '<release>' | sed -e 's|.*>\\(.*\\)<.*|\\1|')\n+           wget https://github.com/ClickHouse/clickhouse-jdbc-bridge/releases/download/v$PKG_VER/clickhouse-jdbc-bridge_$PKG_VER-1_all.deb\n+           apt install --no-install-recommends -f ./clickhouse-jdbc-bridge_$PKG_VER-1_all.deb\n+           clickhouse-jdbc-bridge &\n+\n+         * [CentOS/RHEL]\n+           export MVN_URL=https://repo1.maven.org/maven2/ru/yandex/clickhouse/clickhouse-jdbc-bridge\n+           export PKG_VER=$(curl -sL $MVN_URL/maven-metadata.xml | grep '<release>' | sed -e 's|.*>\\(.*\\)<.*|\\1|')\n+           wget https://github.com/ClickHouse/clickhouse-jdbc-bridge/releases/download/v$PKG_VER/clickhouse-jdbc-bridge-$PKG_VER-1.noarch.rpm\n+           yum localinstall -y clickhouse-jdbc-bridge-$PKG_VER-1.noarch.rpm\n+           clickhouse-jdbc-bridge &\n+\n+         Please refer to https://github.com/ClickHouse/clickhouse-jdbc-bridge#usage for more information.\n+    ]]>\n+    <!--\n+    <jdbc_bridge>\n+        <host>127.0.0.1</host>\n+        <port>9019</port>\n+    </jdbc_bridge>\n+    -->\n+  \n+    <!-- Configuration of clusters that could be used in Distributed tables.\n+         https://clickhouse.tech/docs/en/operations/table_engines/distributed/\n+      -->\n+    <remote_servers>\n+        <!-- Test only shard config for testing distributed storage -->\n+        <test_shard_localhost>\n+            <!-- Inter-server per-cluster secret for Distributed queries\n+                 default: no secret (no authentication will be performed)\n+\n+                 If set, then Distributed queries will be validated on shards, so at least:\n+                 - such cluster should exist on the shard,\n+                 - such cluster should have the same secret.\n+\n+                 And also (and which is more important), the initial_user will\n+                 be used as current user for the query.\n+\n+                 Right now the protocol is pretty simple and it only takes into account:\n+                 - cluster name\n+                 - query\n+\n+                 Also it will be nice if the following will be implemented:\n+                 - source hostname (see interserver_http_host), but then it will depends from DNS,\n+                   it can use IP address instead, but then the you need to get correct on the initiator node.\n+                 - target hostname / ip address (same notes as for source hostname)\n+                 - time-based security tokens\n+            -->\n+            <!-- <secret></secret> -->\n+\n+            <shard>\n+                <!-- Optional. Whether to write data to just one of the replicas. Default: false (write data to all replicas). -->\n+                <!-- <internal_replication>false</internal_replication> -->\n+                <!-- Optional. Shard weight when writing data. Default: 1. -->\n+                <!-- <weight>1</weight> -->\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9000</port>\n+                    <!-- Optional. Priority of the replica for load_balancing. Default: 1 (less value has more priority). -->\n+                    <!-- <priority>1</priority> -->\n+                </replica>\n+            </shard>\n+        </test_shard_localhost>\n+        <test_cluster_two_shards_localhost>\n+             <shard>\n+                 <replica>\n+                     <host>localhost</host>\n+                     <port>9000</port>\n+                 </replica>\n+             </shard>\n+             <shard>\n+                 <replica>\n+                     <host>localhost</host>\n+                     <port>9000</port>\n+                 </replica>\n+             </shard>\n+        </test_cluster_two_shards_localhost>\n+        <test_cluster_two_shards>\n+            <shard>\n+                <replica>\n+                    <host>127.0.0.1</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <replica>\n+                    <host>127.0.0.2</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+        </test_cluster_two_shards>\n+        <test_cluster_two_shards_internal_replication>\n+            <shard>\n+                <internal_replication>true</internal_replication>\n+                <replica>\n+                    <host>127.0.0.1</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <internal_replication>true</internal_replication>\n+                <replica>\n+                    <host>127.0.0.2</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+        </test_cluster_two_shards_internal_replication>\n+        <test_shard_localhost_secure>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9440</port>\n+                    <secure>1</secure>\n+                </replica>\n+            </shard>\n+        </test_shard_localhost_secure>\n+        <test_unavailable_shard>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>1</port>\n+                </replica>\n+            </shard>\n+        </test_unavailable_shard>\n+    </remote_servers>\n+\n+    <!-- The list of hosts allowed to use in URL-related storage engines and table functions.\n+        If this section is not present in configuration, all hosts are allowed.\n+    -->\n+    <!--<remote_url_allow_hosts>-->\n+        <!-- Host should be specified exactly as in URL. The name is checked before DNS resolution.\n+            Example: \"yandex.ru\", \"yandex.ru.\" and \"www.yandex.ru\" are different hosts.\n+                    If port is explicitly specified in URL, the host:port is checked as a whole.\n+                    If host specified here without port, any port with this host allowed.\n+                    \"yandex.ru\" -> \"yandex.ru:443\", \"yandex.ru:80\" etc. is allowed, but \"yandex.ru:80\" -> only \"yandex.ru:80\" is allowed.\n+            If the host is specified as IP address, it is checked as specified in URL. Example: \"[2a02:6b8:a::a]\".\n+            If there are redirects and support for redirects is enabled, every redirect (the Location field) is checked.\n+        -->\n+\n+        <!-- Regular expression can be specified. RE2 engine is used for regexps.\n+            Regexps are not aligned: don't forget to add ^ and $. Also don't forget to escape dot (.) metacharacter\n+            (forgetting to do so is a common source of error).\n+        -->\n+    <!--</remote_url_allow_hosts>-->\n+\n+    <!-- If element has 'incl' attribute, then for it's value will be used corresponding substitution from another file.\n+         By default, path to file with substitutions is /etc/metrika.xml. It could be changed in config in 'include_from' element.\n+         Values for substitutions are specified in /yandex/name_of_substitution elements in that file.\n+      -->\n+\n+    <!-- ZooKeeper is used to store metadata about replicas, when using Replicated tables.\n+         Optional. If you don't use replicated tables, you could omit that.\n+\n+         See https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/replication/\n+      -->\n+\n+    <!--\n+    <zookeeper>\n+        <node>\n+            <host>example1</host>\n+            <port>2181</port>\n+        </node>\n+        <node>\n+            <host>example2</host>\n+            <port>2181</port>\n+        </node>\n+        <node>\n+            <host>example3</host>\n+            <port>2181</port>\n+        </node>\n+    </zookeeper>\n+    -->\n+\n+    <!-- Substitutions for parameters of replicated tables.\n+          Optional. If you don't use replicated tables, you could omit that.\n+\n+         See https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/replication/#creating-replicated-tables\n+      -->\n+    <!--\n+    <macros>\n+        <shard>01</shard>\n+        <replica>example01-01-1</replica>\n+    </macros>\n+    -->\n+\n+\n+    <!-- Reloading interval for embedded dictionaries, in seconds. Default: 3600. -->\n+    <builtin_dictionaries_reload_interval>3600</builtin_dictionaries_reload_interval>\n+\n+\n+    <!-- Maximum session timeout, in seconds. Default: 3600. -->\n+    <max_session_timeout>3600</max_session_timeout>\n+\n+    <!-- Default session timeout, in seconds. Default: 60. -->\n+    <default_session_timeout>60</default_session_timeout>\n+\n+    <!-- Sending data to Graphite for monitoring. Several sections can be defined. -->\n+    <!--\n+        interval - send every X second\n+        root_path - prefix for keys\n+        hostname_in_path - append hostname to root_path (default = true)\n+        metrics - send data from table system.metrics\n+        events - send data from table system.events\n+        asynchronous_metrics - send data from table system.asynchronous_metrics\n+    -->\n+    <!--\n+    <graphite>\n+        <host>localhost</host>\n+        <port>42000</port>\n+        <timeout>0.1</timeout>\n+        <interval>60</interval>\n+        <root_path>one_min</root_path>\n+        <hostname_in_path>true</hostname_in_path>\n+\n+        <metrics>true</metrics>\n+        <events>true</events>\n+        <events_cumulative>false</events_cumulative>\n+        <asynchronous_metrics>true</asynchronous_metrics>\n+    </graphite>\n+    <graphite>\n+        <host>localhost</host>\n+        <port>42000</port>\n+        <timeout>0.1</timeout>\n+        <interval>1</interval>\n+        <root_path>one_sec</root_path>\n+\n+        <metrics>true</metrics>\n+        <events>true</events>\n+        <events_cumulative>false</events_cumulative>\n+        <asynchronous_metrics>false</asynchronous_metrics>\n+    </graphite>\n+    -->\n+\n+    <!-- Serve endpoint for Prometheus monitoring. -->\n+    <!--\n+        endpoint - mertics path (relative to root, statring with \"/\")\n+        port - port to setup server. If not defined or 0 than http_port used\n+        metrics - send data from table system.metrics\n+        events - send data from table system.events\n+        asynchronous_metrics - send data from table system.asynchronous_metrics\n+        status_info - send data from different component from CH, ex: Dictionaries status\n+    -->\n+    <!--\n+    <prometheus>\n+        <endpoint>/metrics</endpoint>\n+        <port>9363</port>\n+\n+        <metrics>true</metrics>\n+        <events>true</events>\n+        <asynchronous_metrics>true</asynchronous_metrics>\n+        <status_info>true</status_info>\n+    </prometheus>\n+    -->\n+\n+    <!-- Query log. Used only for queries with setting log_queries = 1. -->\n+    <query_log>\n+        <!-- What table to insert data. If table is not exist, it will be created.\n+             When query log structure is changed after system update,\n+              then old table will be renamed and new table will be created automatically.\n+        -->\n+        <database>system</database>\n+        <table>query_log</table>\n+        <!--\n+            PARTITION BY expr: https://clickhouse.yandex/docs/en/table_engines/mergetree-family/custom_partitioning_key/\n+            Example:\n+                event_date\n+                toMonday(event_date)\n+                toYYYYMM(event_date)\n+                toStartOfHour(event_time)\n+        -->\n+        <partition_by>toYYYYMM(event_date)</partition_by>\n+        <!--\n+            Table TTL specification: https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl\n+            Example:\n+                event_date + INTERVAL 1 WEEK\n+                event_date + INTERVAL 7 DAY DELETE\n+                event_date + INTERVAL 2 WEEK TO DISK 'bbb'\n+\n+        <ttl>event_date + INTERVAL 30 DAY DELETE</ttl>\n+        -->\n+\n+        <!-- Instead of partition_by, you can provide full engine expression (starting with ENGINE = ) with parameters,\n+             Example: <engine>ENGINE = MergeTree PARTITION BY toYYYYMM(event_date) ORDER BY (event_date, event_time) SETTINGS index_granularity = 1024</engine>\n+          -->\n+\n+        <!-- Interval of flushing data. -->\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </query_log>\n+\n+    <!-- Trace log. Stores stack traces collected by query profilers.\n+         See query_profiler_real_time_period_ns and query_profiler_cpu_time_period_ns settings. -->\n+    <trace_log>\n+        <database>system</database>\n+        <table>trace_log</table>\n+\n+        <partition_by>toYYYYMM(event_date)</partition_by>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </trace_log>\n+\n+    <!-- Query thread log. Has information about all threads participated in query execution.\n+         Used only for queries with setting log_query_threads = 1. -->\n+    <query_thread_log>\n+        <database>system</database>\n+        <table>query_thread_log</table>\n+        <partition_by>toYYYYMM(event_date)</partition_by>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </query_thread_log>\n+\n+    <!-- Uncomment if use part log.\n+         Part log contains information about all actions with parts in MergeTree tables (creation, deletion, merges, downloads).\n+    <part_log>\n+        <database>system</database>\n+        <table>part_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </part_log>\n+    -->\n+\n+    <!-- Uncomment to write text log into table.\n+         Text log contains all information from usual server log but stores it in structured and efficient way.\n+         The level of the messages that goes to the table can be limited (<level>), if not specified all messages will go to the table.\n+    <text_log>\n+        <database>system</database>\n+        <table>text_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+        <level></level>\n+    </text_log>\n+    -->\n+\n+    <!-- Metric log contains rows with current values of ProfileEvents, CurrentMetrics collected with \"collect_interval_milliseconds\" interval. -->\n+    <metric_log>\n+        <database>system</database>\n+        <table>metric_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+        <collect_interval_milliseconds>1000</collect_interval_milliseconds>\n+    </metric_log>\n+\n+    <!--\n+        Asynchronous metric log contains values of metrics from\n+        system.asynchronous_metrics.\n+    -->\n+    <asynchronous_metric_log>\n+        <database>system</database>\n+        <table>asynchronous_metric_log</table>\n+        <!--\n+            Asynchronous metrics are updated once a minute, so there is\n+            no need to flush more often.\n+        -->\n+        <flush_interval_milliseconds>60000</flush_interval_milliseconds>\n+    </asynchronous_metric_log>\n+\n+    <!--\n+        OpenTelemetry log contains OpenTelemetry trace spans.\n+    -->\n+    <opentelemetry_span_log>\n+        <!--\n+            The default table creation code is insufficient, this <engine> spec\n+            is a workaround. There is no 'event_time' for this log, but two times,\n+            start and finish. It is sorted by finish time, to avoid inserting\n+            data too far away in the past (probably we can sometimes insert a span\n+            that is seconds earlier than the last span in the table, due to a race\n+            between several spans inserted in parallel). This gives the spans a\n+            global order that we can use to e.g. retry insertion into some external\n+            system.\n+        -->\n+        <engine>\n+            engine MergeTree\n+            partition by toYYYYMM(finish_date)\n+            order by (finish_date, finish_time_us, trace_id)\n+        </engine>\n+        <database>system</database>\n+        <table>opentelemetry_span_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </opentelemetry_span_log>\n+\n+\n+    <!-- Crash log. Stores stack traces for fatal errors.\n+         This table is normally empty. -->\n+    <crash_log>\n+        <database>system</database>\n+        <table>crash_log</table>\n+\n+        <partition_by />\n+        <flush_interval_milliseconds>1000</flush_interval_milliseconds>\n+    </crash_log>\n+\n+    <!-- Parameters for embedded dictionaries, used in Yandex.Metrica.\n+         See https://clickhouse.yandex/docs/en/dicts/internal_dicts/\n+    -->\n+\n+    <!-- Path to file with region hierarchy. -->\n+    <!-- <path_to_regions_hierarchy_file>/opt/geo/regions_hierarchy.txt</path_to_regions_hierarchy_file> -->\n+\n+    <!-- Path to directory with files containing names of regions -->\n+    <!-- <path_to_regions_names_files>/opt/geo/</path_to_regions_names_files> -->\n+\n+\n+    <!-- <top_level_domains_path>/var/lib/clickhouse/top_level_domains/</top_level_domains_path> -->\n+    <!-- Custom TLD lists.\n+         Format: <name>/path/to/file</name>\n+\n+         Changes will not be applied w/o server restart.\n+         Path to the list is under top_level_domains_path (see above).\n+    -->\n+    <top_level_domains_lists>\n+        <!--\n+        <public_suffix_list>/path/to/public_suffix_list.dat</public_suffix_list>\n+        -->\n+    </top_level_domains_lists>\n+\n+    <!-- Configuration of external dictionaries. See:\n+         https://clickhouse.tech/docs/en/sql-reference/dictionaries/external-dictionaries/external-dicts\n+    -->\n+    <dictionaries_config>*_dictionary.xml</dictionaries_config>\n+\n+    <!-- Uncomment if you want data to be compressed 30-100% better.\n+         Don't do that if you just started using ClickHouse.\n+      -->\n+    <!--\n+    <compression>\n+        <!- - Set of variants. Checked in order. Last matching case wins. If nothing matches, lz4 will be used. - ->\n+        <case>\n+\n+            <!- - Conditions. All must be satisfied. Some conditions may be omitted. - ->\n+            <min_part_size>10000000000</min_part_size>        <!- - Min part size in bytes. - ->\n+            <min_part_size_ratio>0.01</min_part_size_ratio>   <!- - Min size of part relative to whole table size. - ->\n+\n+            <!- - What compression method to use. - ->\n+            <method>zstd</method>\n+        </case>\n+    </compression>\n+    -->\n+\n+    <!-- Allow to execute distributed DDL queries (CREATE, DROP, ALTER, RENAME) on cluster.\n+         Works only if ZooKeeper is enabled. Comment it if such functionality isn't required. -->\n+    <distributed_ddl>\n+        <!-- Path in ZooKeeper to queue with DDL queries -->\n+        <path>/clickhouse/task_queue/ddl</path>\n+\n+        <!-- Settings from this profile will be used to execute DDL queries -->\n+        <!-- <profile>default</profile> -->\n+\n+        <!-- Controls how much ON CLUSTER queries can be run simultaneously. -->\n+        <!-- <pool_size>1</pool_size> -->\n+\n+        <!--\n+             Cleanup settings (active tasks will not be removed)\n+        -->\n+\n+        <!-- Controls task TTL (default 1 week) -->\n+        <!-- <task_max_lifetime>604800</task_max_lifetime> -->\n+\n+        <!-- Controls how often cleanup should be performed (in seconds) -->\n+        <!-- <cleanup_delay_period>60</cleanup_delay_period> -->\n+\n+        <!-- Controls how many tasks could be in the queue -->\n+        <!-- <max_tasks_in_queue>1000</max_tasks_in_queue> -->\n+    </distributed_ddl>\n+\n+    <!-- Settings to fine tune MergeTree tables. See documentation in source code, in MergeTreeSettings.h -->\n+    <!--\n+    <merge_tree>\n+        <max_suspicious_broken_parts>5</max_suspicious_broken_parts>\n+    </merge_tree>\n+    -->\n+\n+    <!-- Protection from accidental DROP.\n+         If size of a MergeTree table is greater than max_table_size_to_drop (in bytes) than table could not be dropped with any DROP query.\n+         If you want do delete one table and don't want to change clickhouse-server config, you could create special file <clickhouse-path>/flags/force_drop_table and make DROP once.\n+         By default max_table_size_to_drop is 50GB; max_table_size_to_drop=0 allows to DROP any tables.\n+         The same for max_partition_size_to_drop.\n+         Uncomment to disable protection.\n+    -->\n+    <!-- <max_table_size_to_drop>0</max_table_size_to_drop> -->\n+    <!-- <max_partition_size_to_drop>0</max_partition_size_to_drop> -->\n+\n+    <!-- Example of parameters for GraphiteMergeTree table engine -->\n+    <graphite_rollup_example>\n+        <pattern>\n+            <regexp>click_cost</regexp>\n+            <function>any</function>\n+            <retention>\n+                <age>0</age>\n+                <precision>3600</precision>\n+            </retention>\n+            <retention>\n+                <age>86400</age>\n+                <precision>60</precision>\n+            </retention>\n+        </pattern>\n+        <default>\n+            <function>max</function>\n+            <retention>\n+                <age>0</age>\n+                <precision>60</precision>\n+            </retention>\n+            <retention>\n+                <age>3600</age>\n+                <precision>300</precision>\n+            </retention>\n+            <retention>\n+                <age>86400</age>\n+                <precision>3600</precision>\n+            </retention>\n+        </default>\n+    </graphite_rollup_example>\n+\n+    <!-- Directory in <clickhouse-path> containing schema files for various input formats.\n+         The directory will be created if it doesn't exist.\n+      -->\n+    <format_schema_path>/var/lib/clickhouse/format_schemas/</format_schema_path>\n+\n+    <!-- Default query masking rules, matching lines would be replaced with something else in the logs\n+        (both text logs and system.query_log).\n+        name - name for the rule (optional)\n+        regexp - RE2 compatible regular expression (mandatory)\n+        replace - substitution string for sensitive data (optional, by default - six asterisks)\n+    -->\n+    <query_masking_rules>\n+        <rule>\n+            <name>hide encrypt/decrypt arguments</name>\n+            <regexp>((?:aes_)?(?:encrypt|decrypt)(?:_mysql)?)\\s*\\(\\s*(?:'(?:\\\\'|.)+'|.*?)\\s*\\)</regexp>\n+            <!-- or more secure, but also more invasive:\n+                (aes_\\w+)\\s*\\(.*\\)\n+            -->\n+            <replace>\\1(???)</replace>\n+        </rule>\n+    </query_masking_rules>\n+\n+    <!-- Uncomment to use custom http handlers.\n+        rules are checked from top to bottom, first match runs the handler\n+            url - to match request URL, you can use 'regex:' prefix to use regex match(optional)\n+            methods - to match request method, you can use commas to separate multiple method matches(optional)\n+            headers - to match request headers, match each child element(child element name is header name), you can use 'regex:' prefix to use regex match(optional)\n+        handler is request handler\n+            type - supported types: static, dynamic_query_handler, predefined_query_handler\n+            query - use with predefined_query_handler type, executes query when the handler is called\n+            query_param_name - use with dynamic_query_handler type, extracts and executes the value corresponding to the <query_param_name> value in HTTP request params\n+            status - use with static type, response status code\n+            content_type - use with static type, response content-type\n+            response_content - use with static type, Response content sent to client, when using the prefix 'file://' or 'config://', find the content from the file or configuration send to client.\n+\n+    <http_handlers>\n+        <rule>\n+            <url>/</url>\n+            <methods>POST,GET</methods>\n+            <headers><pragma>no-cache</pragma></headers>\n+            <handler>\n+                <type>dynamic_query_handler</type>\n+                <query_param_name>query</query_param_name>\n+            </handler>\n+        </rule>\n+\n+        <rule>\n+            <url>/predefined_query</url>\n+            <methods>POST,GET</methods>\n+            <handler>\n+                <type>predefined_query_handler</type>\n+                <query>SELECT * FROM system.settings</query>\n+            </handler>\n+        </rule>\n+\n+        <rule>\n+            <handler>\n+                <type>static</type>\n+                <status>200</status>\n+                <content_type>text/plain; charset=UTF-8</content_type>\n+                <response_content>config://http_server_default_response</response_content>\n+            </handler>\n+        </rule>\n+    </http_handlers>\n+    -->\n+\n+    <send_crash_reports>\n+        <!-- Changing <enabled> to true allows sending crash reports to -->\n+        <!-- the ClickHouse core developers team via Sentry https://sentry.io -->\n+        <!-- Doing so at least in pre-production environments is highly appreciated -->\n+        <enabled>false</enabled>\n+        <!-- Change <anonymize> to true if you don't feel comfortable attaching the server hostname to the crash report -->\n+        <anonymize>false</anonymize>\n+        <!-- Default endpoint should be changed to different Sentry DSN only if you have -->\n+        <!-- some in-house engineers or hired consultants who're going to debug ClickHouse issues for you -->\n+        <endpoint>https://6f33034cfe684dd7a3ab9875e57b1c8d@o388870.ingest.sentry.io/5226277</endpoint>\n+    </send_crash_reports>\n+\n+    <!-- Uncomment to disable ClickHouse internal DNS caching. -->\n+    <!-- <disable_internal_dns_cache>1</disable_internal_dns_cache> -->\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/embedded.xml b/tests/integration/test_config_xml_full/configs/embedded.xml\nnew file mode 100644\nindex 000000000000..a66f57d1eb70\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/embedded.xml\n@@ -0,0 +1,40 @@\n+<?xml version=\"1.0\"?>\n+<!-- Config that is used when server is run without config file. -->\n+<yandex>\n+    <logger>\n+        <level>trace</level>\n+        <console>true</console>\n+    </logger>\n+\n+    <http_port>8123</http_port>\n+    <tcp_port>9000</tcp_port>\n+    <mysql_port>9004</mysql_port>\n+\n+    <path>./</path>\n+\n+    <uncompressed_cache_size>8589934592</uncompressed_cache_size>\n+    <mark_cache_size>5368709120</mark_cache_size>\n+    <mlock_executable>true</mlock_executable>\n+\n+    <users>\n+        <default>\n+            <password></password>\n+\n+            <networks>\n+                <ip>::/0</ip>\n+            </networks>\n+\n+            <profile>default</profile>\n+            <quota>default</quota>\n+            <access_management>1</access_management>\n+        </default>\n+    </users>\n+\n+    <profiles>\n+        <default/>\n+    </profiles>\n+\n+    <quotas>\n+        <default />\n+    </quotas>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/users.d/allow_introspection_functions.xml b/tests/integration/test_config_xml_full/configs/users.d/allow_introspection_functions.xml\nnew file mode 100644\nindex 000000000000..b94e95bc043d\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/users.d/allow_introspection_functions.xml\n@@ -0,0 +1,8 @@\n+<?xml version=\"1.0\"?>\n+<yandex>\n+    <profiles>\n+        <default>\n+            <allow_introspection_functions>1</allow_introspection_functions>\n+        </default>\n+    </profiles>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/users.d/log_queries.xml b/tests/integration/test_config_xml_full/configs/users.d/log_queries.xml\nnew file mode 100644\nindex 000000000000..25261072ade6\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/users.d/log_queries.xml\n@@ -0,0 +1,7 @@\n+<yandex>\n+    <profiles>\n+        <default>\n+            <log_queries>1</log_queries>\n+        </default>\n+    </profiles>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/configs/users.xml b/tests/integration/test_config_xml_full/configs/users.xml\nnew file mode 100644\nindex 000000000000..829748dafb14\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/configs/users.xml\n@@ -0,0 +1,120 @@\n+<?xml version=\"1.0\"?>\n+<yandex>\n+    <!-- Profiles of settings. -->\n+    <profiles>\n+        <!-- Default settings. -->\n+        <default>\n+            <!-- Maximum memory usage for processing single query, in bytes. -->\n+            <max_memory_usage>10000000000</max_memory_usage>\n+            <max_block_size>64999</max_block_size>\n+\n+            <!-- How to choose between replicas during distributed query processing.\n+                 random - choose random replica from set of replicas with minimum number of errors\n+                 nearest_hostname - from set of replicas with minimum number of errors, choose replica\n+                  with minimum number of different symbols between replica's hostname and local hostname\n+                  (Hamming distance).\n+                 in_order - first live replica is chosen in specified order.\n+                 first_or_random - if first replica one has higher number of errors, pick a random one from replicas with minimum number of errors.\n+            -->\n+            <load_balancing>random</load_balancing>\n+        </default>\n+\n+        <!-- Profile that allows only read queries. -->\n+        <readonly>\n+            <readonly>1</readonly>\n+        </readonly>\n+    </profiles>\n+\n+    <!-- Users and ACL. -->\n+    <users>\n+        <!-- If user name was not specified, 'default' user is used. -->\n+        <default>\n+            <!-- Password could be specified in plaintext or in SHA256 (in hex format).\n+\n+                 If you want to specify password in plaintext (not recommended), place it in 'password' element.\n+                 Example: <password>qwerty</password>.\n+                 Password could be empty.\n+\n+                 If you want to specify SHA256, place it in 'password_sha256_hex' element.\n+                 Example: <password_sha256_hex>65e84be33532fb784c48129675f9eff3a682b27168c0ea744b2cf58ee02337c5</password_sha256_hex>\n+                 Restrictions of SHA256: impossibility to connect to ClickHouse using MySQL JS client (as of July 2019).\n+\n+                 If you want to specify double SHA1, place it in 'password_double_sha1_hex' element.\n+                 Example: <password_double_sha1_hex>e395796d6546b1b65db9d665cd43f0e858dd4303</password_double_sha1_hex>\n+\n+                 If you want to specify a previously defined LDAP server (see 'ldap_servers' in the main config) for authentication,\n+                  place its name in 'server' element inside 'ldap' element.\n+                 Example: <ldap><server>my_ldap_server</server></ldap>\n+\n+                 If you want to authenticate the user via Kerberos (assuming Kerberos is enabled, see 'kerberos' in the main config),\n+                  place 'kerberos' element instead of 'password' (and similar) elements.\n+                 The name part of the canonical principal name of the initiator must match the user name for authentication to succeed.\n+                 You can also place 'realm' element inside 'kerberos' element to further restrict authentication to only those requests\n+                  whose initiator's realm matches it. \n+                 Example: <kerberos />\n+                 Example: <kerberos><realm>EXAMPLE.COM</realm></kerberos>\n+\n+                 How to generate decent password:\n+                 Execute: PASSWORD=$(base64 < /dev/urandom | head -c8); echo \"$PASSWORD\"; echo -n \"$PASSWORD\" | sha256sum | tr -d '-'\n+                 In first line will be password and in second - corresponding SHA256.\n+\n+                 How to generate double SHA1:\n+                 Execute: PASSWORD=$(base64 < /dev/urandom | head -c8); echo \"$PASSWORD\"; echo -n \"$PASSWORD\" | sha1sum | tr -d '-' | xxd -r -p | sha1sum | tr -d '-'\n+                 In first line will be password and in second - corresponding double SHA1.\n+            -->\n+            <password></password>\n+\n+            <!-- List of networks with open access.\n+\n+                 To open access from everywhere, specify:\n+                    <ip>::/0</ip>\n+\n+                 To open access only from localhost, specify:\n+                    <ip>::1</ip>\n+                    <ip>127.0.0.1</ip>\n+\n+                 Each element of list has one of the following forms:\n+                 <ip> IP-address or network mask. Examples: 213.180.204.3 or 10.0.0.1/8 or 10.0.0.1/255.255.255.0\n+                     2a02:6b8::3 or 2a02:6b8::3/64 or 2a02:6b8::3/ffff:ffff:ffff:ffff::.\n+                 <host> Hostname. Example: server01.yandex.ru.\n+                     To check access, DNS query is performed, and all received addresses compared to peer address.\n+                 <host_regexp> Regular expression for host names. Example, ^server\\d\\d-\\d\\d-\\d\\.yandex\\.ru$\n+                     To check access, DNS PTR query is performed for peer address and then regexp is applied.\n+                     Then, for result of PTR query, another DNS query is performed and all received addresses compared to peer address.\n+                     Strongly recommended that regexp is ends with $\n+                 All results of DNS requests are cached till server restart.\n+            -->\n+            <networks>\n+                <ip>::/0</ip>\n+            </networks>\n+\n+            <!-- Settings profile for user. -->\n+            <profile>default</profile>\n+\n+            <!-- Quota for user. -->\n+            <quota>default</quota>\n+\n+            <!-- User can create other users and grant rights to them. -->\n+            <!-- <access_management>1</access_management> -->\n+        </default>\n+    </users>\n+\n+    <!-- Quotas. -->\n+    <quotas>\n+        <!-- Name of quota. -->\n+        <default>\n+            <!-- Limits for time interval. You could specify many intervals with different limits. -->\n+            <interval>\n+                <!-- Length of interval. -->\n+                <duration>3600</duration>\n+\n+                <!-- No limits. Just calculate resource usage for time interval. -->\n+                <queries>0</queries>\n+                <errors>0</errors>\n+                <result_rows>0</result_rows>\n+                <read_rows>0</read_rows>\n+                <execution_time>0</execution_time>\n+            </interval>\n+        </default>\n+    </quotas>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_full/test.py b/tests/integration/test_config_xml_full/test.py\nnew file mode 100644\nindex 000000000000..a8650a0dc553\n--- /dev/null\n+++ b/tests/integration/test_config_xml_full/test.py\n@@ -0,0 +1,40 @@\n+import time\n+import threading\n+from os import path as p, unlink\n+from tempfile import NamedTemporaryFile\n+\n+import helpers\n+import pytest\n+from helpers.cluster import ClickHouseCluster\n+\n+\n+def test_xml_full_conf():\n+    # all configs are in XML\n+    cluster = ClickHouseCluster(__file__, zookeeper_config_path='configs/config.d/zookeeper.xml')\n+\n+    all_confd = ['configs/config.d/access_control.xml',\n+                'configs/config.d/keeper_port.xml',\n+                'configs/config.d/logging_no_rotate.xml',\n+                'configs/config.d/log_to_console.xml',\n+                'configs/config.d/macros.xml',\n+                'configs/config.d/metric_log.xml',\n+                'configs/config.d/more_clusters.xml',\n+                'configs/config.d/part_log.xml',\n+                'configs/config.d/path.xml',\n+                'configs/config.d/query_masking_rules.xml',\n+                'configs/config.d/tcp_with_proxy.xml',\n+                'configs/config.d/text_log.xml',\n+                'configs/config.d/zookeeper.xml']\n+\n+    all_userd = ['configs/users.d/allow_introspection_functions.xml',\n+                'configs/users.d/log_queries.xml']\n+\n+    node = cluster.add_instance('node', base_config_dir='configs', main_configs=all_confd, user_configs=all_userd, with_zookeeper=False)\n+\n+    try:\n+        cluster.start()\n+        assert(node.query(\"select value from system.settings where name = 'max_memory_usage'\") == \"10000000000\\n\")\n+        assert(node.query(\"select value from system.settings where name = 'max_block_size'\") == \"64999\\n\")\n+\n+    finally:\n+        cluster.shutdown()\ndiff --git a/tests/integration/test_config_xml_main/__init__.py b/tests/integration/test_config_xml_main/__init__.py\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/access_control.yaml b/tests/integration/test_config_xml_main/configs/config.d/access_control.yaml\nnew file mode 100644\nindex 000000000000..d8ead517c862\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/access_control.yaml\n@@ -0,0 +1,7 @@\n+user_directories:\n+  users_xml:\n+    path: users.xml\n+  local_directory:\n+    path: access/\n+  \"@replace\": replace\n+\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/keeper_port.yaml b/tests/integration/test_config_xml_main/configs/config.d/keeper_port.yaml\nnew file mode 100644\nindex 000000000000..91723bc372f1\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/keeper_port.yaml\n@@ -0,0 +1,15 @@\n+keeper_server:\n+  tcp_port: 9181\n+  server_id: 1\n+  coordination_settings:\n+    operation_timeout_ms: 10000\n+    session_timeout_ms: 30000\n+    force_sync: false\n+    startup_timeout: 60000\n+    reserved_log_items: 1000000000000000\n+  raft_configuration:\n+    server:\n+      id: 1\n+      hostname: localhost\n+      port: 44444\n+\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/log_to_console.yaml b/tests/integration/test_config_xml_main/configs/config.d/log_to_console.yaml\nnew file mode 100644\nindex 000000000000..7b59339800b9\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/log_to_console.yaml\n@@ -0,0 +1,7 @@\n+logger:\n+  console: true\n+  log:\n+    \"@remove\": remove\n+  errorlog:\n+    \"@remove\": remove\n+\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/logging_no_rotate.yaml b/tests/integration/test_config_xml_main/configs/config.d/logging_no_rotate.yaml\nnew file mode 100644\nindex 000000000000..513cd3f7dc51\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/logging_no_rotate.yaml\n@@ -0,0 +1,2 @@\n+logger:\n+  size: never\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/macros.yaml b/tests/integration/test_config_xml_main/configs/config.d/macros.yaml\nnew file mode 100644\nindex 000000000000..a9c61e270ab3\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/macros.yaml\n@@ -0,0 +1,7 @@\n+macros:\n+  test: 'Hello, world!'\n+  shard: s1\n+  replica: r1\n+  default_path_test: '/clickhouse/tables/{database}/{shard}/'\n+  default_name_test: 'table_{table}'\n+\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/metric_log.yaml b/tests/integration/test_config_xml_main/configs/config.d/metric_log.yaml\nnew file mode 100644\nindex 000000000000..aafad939c377\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/metric_log.yaml\n@@ -0,0 +1,6 @@\n+metric_log:\n+  database: system\n+  table: metric_log\n+  flush_interval_milliseconds: 7500\n+  collect_interval_milliseconds: 1000\n+\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/more_clusters.yaml b/tests/integration/test_config_xml_main/configs/config.d/more_clusters.yaml\nnew file mode 100644\nindex 000000000000..7da071908945\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/more_clusters.yaml\n@@ -0,0 +1,23 @@\n+remote_servers:\n+  single_remote_shard_at_port_9001:\n+    shard:\n+      replica:\n+        host: localhost\n+        port: 9001\n+  two_remote_shards_at_port_9001_9002:\n+    shard:\n+      - replica:\n+          host: localhost\n+          port: 9001\n+      - replica:\n+          host: localhost\n+          port: 9002\n+  two_shards_one_local_one_remote_at_port_9001:\n+    shard:\n+      - replica:\n+          host: localhost\n+          port: 9000\n+      - replica:\n+          host: localhost\n+          port: 9001\n+\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/part_log.yaml b/tests/integration/test_config_xml_main/configs/config.d/part_log.yaml\nnew file mode 100644\nindex 000000000000..43f60146dca1\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/part_log.yaml\n@@ -0,0 +1,5 @@\n+part_log:\n+  database: system\n+  table: part_log\n+  flush_interval_milliseconds: 7500\n+\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/path.yaml b/tests/integration/test_config_xml_main/configs/config.d/path.yaml\nnew file mode 100644\nindex 000000000000..3e26e8906eef\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/path.yaml\n@@ -0,0 +1,18 @@\n+path:\n+  - ./\n+  - \"@replace\": replace\n+tmp_path:\n+  - ./tmp/\n+  - \"@replace\": replace\n+user_files_path:\n+  - ./user_files/\n+  - \"@replace\": replace\n+format_schema_path:\n+  - ./format_schemas/\n+  - \"@replace\": replace\n+access_control_path:\n+  - ./access/\n+  - \"@replace\": replace\n+top_level_domains_path:\n+  - ./top_level_domains/\n+  - \"@replace\": replace\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/query_masking_rules.yaml b/tests/integration/test_config_xml_main/configs/config.d/query_masking_rules.yaml\nnew file mode 100644\nindex 000000000000..38163429d810\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/query_masking_rules.yaml\n@@ -0,0 +1,4 @@\n+query_masking_rules:\n+  rule:\n+    regexp: TOPSECRET.TOPSECRET\n+    replace: '[hidden]'\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/tcp_with_proxy.yaml b/tests/integration/test_config_xml_main/configs/config.d/tcp_with_proxy.yaml\nnew file mode 100644\nindex 000000000000..b0349f5a9b99\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/tcp_with_proxy.yaml\n@@ -0,0 +1,1 @@\n+tcp_with_proxy_port: 9010\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/test_cluster_with_incorrect_pw.yaml b/tests/integration/test_config_xml_main/configs/config.d/test_cluster_with_incorrect_pw.yaml\nnew file mode 100644\nindex 000000000000..309a7daa81d1\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/test_cluster_with_incorrect_pw.yaml\n@@ -0,0 +1,11 @@\n+remote_servers:\n+  test_cluster_with_incorrect_pw:\n+    shard:\n+      internal_replication: true\n+      replica:\n+        - host: 127.0.0.1\n+          port: 9000\n+          password: foo\n+        - host: 127.0.0.2\n+          port: 9000\n+          password: foo\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/text_log.yaml b/tests/integration/test_config_xml_main/configs/config.d/text_log.yaml\nnew file mode 100644\nindex 000000000000..4d188020e374\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/text_log.yaml\n@@ -0,0 +1,4 @@\n+text_log:\n+  database: system\n+  table: text_log\n+  flush_interval_milliseconds: 7500\ndiff --git a/tests/integration/test_config_xml_main/configs/config.d/zookeeper.yaml b/tests/integration/test_config_xml_main/configs/config.d/zookeeper.yaml\nnew file mode 100644\nindex 000000000000..be02c516798a\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.d/zookeeper.yaml\n@@ -0,0 +1,5 @@\n+zookeeper:\n+  node:\n+    host: localhost\n+    port: 9181\n+    \"@index\": 1\ndiff --git a/tests/integration/test_config_xml_main/configs/config.xml b/tests/integration/test_config_xml_main/configs/config.xml\nnew file mode 100644\nindex 000000000000..3b5dab50ffe0\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/config.xml\n@@ -0,0 +1,277 @@\n+<?xml version=\"1.0\"?>\n+<yandex>\n+    <logger>\n+        <level>trace</level>\n+        <log>/var/log/clickhouse-server/clickhouse-server.log</log>\n+        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>\n+        <size>1000M</size>\n+        <count>10</count>\n+    </logger>\n+    <http_port>8123</http_port>\n+    <tcp_port>9000</tcp_port>\n+    <mysql_port>9004</mysql_port>\n+    <postgresql_port>9005</postgresql_port>\n+    <interserver_http_port>9009</interserver_http_port>\n+    <max_connections>4096</max_connections>\n+    <keep_alive_timeout>3</keep_alive_timeout>\n+    <grpc>\n+        <enable_ssl>false</enable_ssl>\n+        <ssl_cert_file>/path/to/ssl_cert_file</ssl_cert_file>\n+        <ssl_key_file>/path/to/ssl_key_file</ssl_key_file>\n+        <ssl_require_client_auth>false</ssl_require_client_auth>\n+        <ssl_ca_cert_file>/path/to/ssl_ca_cert_file</ssl_ca_cert_file>\n+        <compression>deflate</compression>\n+        <compression_level>medium</compression_level>\n+        <max_send_message_size>-1</max_send_message_size>\n+        <max_receive_message_size>-1</max_receive_message_size>\n+        <verbose_logs>false</verbose_logs>\n+    </grpc>\n+    <openSSL>\n+        <server> \n+            <certificateFile>/etc/clickhouse-server/server.crt</certificateFile>\n+            <privateKeyFile>/etc/clickhouse-server/server.key</privateKeyFile>\n+            <dhParamsFile>/etc/clickhouse-server/dhparam.pem</dhParamsFile>\n+            <verificationMode>none</verificationMode>\n+            <loadDefaultCAFile>true</loadDefaultCAFile>\n+            <cacheSessions>true</cacheSessions>\n+            <disableProtocols>sslv2,sslv3</disableProtocols>\n+            <preferServerCiphers>true</preferServerCiphers>\n+        </server>\n+\n+        <client>\n+            <loadDefaultCAFile>true</loadDefaultCAFile>\n+            <cacheSessions>true</cacheSessions>\n+            <disableProtocols>sslv2,sslv3</disableProtocols>\n+            <preferServerCiphers>true</preferServerCiphers>\n+            <invalidCertificateHandler>\n+                <name>RejectCertificateHandler</name>\n+            </invalidCertificateHandler>\n+        </client>\n+    </openSSL>\n+    <max_concurrent_queries>100</max_concurrent_queries>\n+    <max_server_memory_usage>0</max_server_memory_usage>\n+    <max_thread_pool_size>10000</max_thread_pool_size>\n+\n+    <max_server_memory_usage_to_ram_ratio>0.9</max_server_memory_usage_to_ram_ratio>\n+\n+    <total_memory_profiler_step>4194304</total_memory_profiler_step>\n+\n+    <total_memory_tracker_sample_probability>0</total_memory_tracker_sample_probability>\n+\n+    <uncompressed_cache_size>8589934592</uncompressed_cache_size>\n+\n+    <mark_cache_size>5368709120</mark_cache_size>\n+\n+    <mmap_cache_size>1000</mmap_cache_size>\n+\n+    <path>/var/lib/clickhouse/</path>\n+\n+    <tmp_path>/var/lib/clickhouse/tmp/</tmp_path>\n+    <user_files_path>/var/lib/clickhouse/user_files/</user_files_path>\n+    <ldap_servers>\n+    </ldap_servers>\n+    <user_directories>\n+        <users_xml>\n+            <path>users.xml</path>\n+        </users_xml>\n+        <local_directory>\n+            <path>/var/lib/clickhouse/access/</path>\n+        </local_directory>\n+    </user_directories>\n+    <default_profile>default</default_profile>\n+    <custom_settings_prefixes></custom_settings_prefixes>\n+    <default_database>default</default_database>\n+    <mlock_executable>true</mlock_executable>\n+\n+    <remap_executable>false</remap_executable>\n+    <remote_servers>\n+        <test_shard_localhost>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+        </test_shard_localhost>\n+        <test_cluster_two_shards_localhost>\n+             <shard>\n+                 <replica>\n+                     <host>localhost</host>\n+                     <port>9000</port>\n+                 </replica>\n+             </shard>\n+             <shard>\n+                 <replica>\n+                     <host>localhost</host>\n+                     <port>9000</port>\n+                 </replica>\n+             </shard>\n+        </test_cluster_two_shards_localhost>\n+        <test_cluster_two_shards>\n+            <shard>\n+                <replica>\n+                    <host>127.0.0.1</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <replica>\n+                    <host>127.0.0.2</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+        </test_cluster_two_shards>\n+        <test_cluster_two_shards_internal_replication>\n+            <shard>\n+                <internal_replication>true</internal_replication>\n+                <replica>\n+                    <host>127.0.0.1</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <internal_replication>true</internal_replication>\n+                <replica>\n+                    <host>127.0.0.2</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+        </test_cluster_two_shards_internal_replication>\n+        <test_shard_localhost_secure>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9440</port>\n+                    <secure>1</secure>\n+                </replica>\n+            </shard>\n+        </test_shard_localhost_secure>\n+        <test_unavailable_shard>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>1</port>\n+                </replica>\n+            </shard>\n+        </test_unavailable_shard>\n+    </remote_servers>\n+\n+    <builtin_dictionaries_reload_interval>3600</builtin_dictionaries_reload_interval>\n+\n+    <max_session_timeout>3600</max_session_timeout>\n+\n+    <default_session_timeout>60</default_session_timeout>\n+\n+    <query_log>\n+        <database>system</database>\n+        <table>query_log</table>\n+        \n+        <partition_by>toYYYYMM(event_date)</partition_by>\n+        \n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </query_log>\n+\n+    <trace_log>\n+        <database>system</database>\n+        <table>trace_log</table>\n+\n+        <partition_by>toYYYYMM(event_date)</partition_by>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </trace_log>\n+\n+    <query_thread_log>\n+        <database>system</database>\n+        <table>query_thread_log</table>\n+        <partition_by>toYYYYMM(event_date)</partition_by>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </query_thread_log>\n+\n+    <metric_log>\n+        <database>system</database>\n+        <table>metric_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+        <collect_interval_milliseconds>1000</collect_interval_milliseconds>\n+    </metric_log>\n+\n+    <asynchronous_metric_log>\n+        <database>system</database>\n+        <table>asynchronous_metric_log</table>\n+\n+        <flush_interval_milliseconds>60000</flush_interval_milliseconds>\n+    </asynchronous_metric_log>\n+\n+    <opentelemetry_span_log>\n+        <engine>\n+            engine MergeTree\n+            partition by toYYYYMM(finish_date)\n+            order by (finish_date, finish_time_us, trace_id)\n+        </engine>\n+        <database>system</database>\n+        <table>opentelemetry_span_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </opentelemetry_span_log>\n+\n+    <crash_log>\n+        <database>system</database>\n+        <table>crash_log</table>\n+\n+        <partition_by />\n+        <flush_interval_milliseconds>1000</flush_interval_milliseconds>\n+    </crash_log>\n+\n+    <top_level_domains_lists>\n+    </top_level_domains_lists>\n+\n+    <dictionaries_config>*_dictionary.xml</dictionaries_config>\n+    <distributed_ddl>\n+        <path>/clickhouse/task_queue/ddl</path>\n+    </distributed_ddl>\n+    <graphite_rollup_example>\n+        <pattern>\n+            <regexp>click_cost</regexp>\n+            <function>any</function>\n+            <retention>\n+                <age>0</age>\n+                <precision>3600</precision>\n+            </retention>\n+            <retention>\n+                <age>86400</age>\n+                <precision>60</precision>\n+            </retention>\n+        </pattern>\n+        <default>\n+            <function>max</function>\n+            <retention>\n+                <age>0</age>\n+                <precision>60</precision>\n+            </retention>\n+            <retention>\n+                <age>3600</age>\n+                <precision>300</precision>\n+            </retention>\n+            <retention>\n+                <age>86400</age>\n+                <precision>3600</precision>\n+            </retention>\n+        </default>\n+    </graphite_rollup_example>\n+    <format_schema_path>/var/lib/clickhouse/format_schemas/</format_schema_path>\n+    <query_masking_rules>\n+        <rule>\n+            <name>hide encrypt/decrypt arguments</name>\n+            <regexp>((?:aes_)?(?:encrypt|decrypt)(?:_mysql)?)\\s*\\(\\s*(?:'(?:\\\\'|.)+'|.*?)\\s*\\)</regexp>\n+            <replace>\\1(???)</replace>\n+        </rule>\n+    </query_masking_rules>\n+    <send_crash_reports>\n+        <enabled>false</enabled>\n+        <anonymize>false</anonymize>\n+        <endpoint>https://6f33034cfe684dd7a3ab9875e57b1c8d@o388870.ingest.sentry.io/5226277</endpoint>\n+    </send_crash_reports>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_main/configs/embedded.xml b/tests/integration/test_config_xml_main/configs/embedded.xml\nnew file mode 100644\nindex 000000000000..a66f57d1eb70\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/embedded.xml\n@@ -0,0 +1,40 @@\n+<?xml version=\"1.0\"?>\n+<!-- Config that is used when server is run without config file. -->\n+<yandex>\n+    <logger>\n+        <level>trace</level>\n+        <console>true</console>\n+    </logger>\n+\n+    <http_port>8123</http_port>\n+    <tcp_port>9000</tcp_port>\n+    <mysql_port>9004</mysql_port>\n+\n+    <path>./</path>\n+\n+    <uncompressed_cache_size>8589934592</uncompressed_cache_size>\n+    <mark_cache_size>5368709120</mark_cache_size>\n+    <mlock_executable>true</mlock_executable>\n+\n+    <users>\n+        <default>\n+            <password></password>\n+\n+            <networks>\n+                <ip>::/0</ip>\n+            </networks>\n+\n+            <profile>default</profile>\n+            <quota>default</quota>\n+            <access_management>1</access_management>\n+        </default>\n+    </users>\n+\n+    <profiles>\n+        <default/>\n+    </profiles>\n+\n+    <quotas>\n+        <default />\n+    </quotas>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_main/configs/users.d/allow_introspection_functions.yaml b/tests/integration/test_config_xml_main/configs/users.d/allow_introspection_functions.yaml\nnew file mode 100644\nindex 000000000000..84612c198c9d\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/users.d/allow_introspection_functions.yaml\n@@ -0,0 +1,3 @@\n+profiles:\n+  default:\n+    allow_introspection_functions: 1\ndiff --git a/tests/integration/test_config_xml_main/configs/users.d/log_queries.yaml b/tests/integration/test_config_xml_main/configs/users.d/log_queries.yaml\nnew file mode 100644\nindex 000000000000..88574e8f764c\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/users.d/log_queries.yaml\n@@ -0,0 +1,3 @@\n+profiles:\n+  default:\n+    log_queries: 1\ndiff --git a/tests/integration/test_config_xml_main/configs/users.xml b/tests/integration/test_config_xml_main/configs/users.xml\nnew file mode 100644\nindex 000000000000..b473413bdfab\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/configs/users.xml\n@@ -0,0 +1,19 @@\n+<?xml version=\"1.0\"?>\n+<yandex>\n+    <profiles>\n+        <default>\n+            <max_memory_usage>10000000000</max_memory_usage>\n+            <max_block_size>64999</max_block_size>\n+        </default>\n+    </profiles>\n+\n+    <users>\n+        <default>\n+            <password></password>\n+            <networks replace=\"replace\">\n+                <ip>::/0</ip>\n+            </networks>\n+            <profile>default</profile>\n+        </default>\n+    </users>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_main/test.py b/tests/integration/test_config_xml_main/test.py\nnew file mode 100644\nindex 000000000000..052f9adb01f8\n--- /dev/null\n+++ b/tests/integration/test_config_xml_main/test.py\n@@ -0,0 +1,43 @@\n+\n+\n+import time\n+import threading\n+from os import path as p, unlink\n+from tempfile import NamedTemporaryFile\n+\n+import helpers\n+import pytest\n+from helpers.cluster import ClickHouseCluster\n+\n+\n+def test_xml_main_conf():\n+    # main configs are in XML; config.d and users.d are in YAML\n+    cluster = ClickHouseCluster(__file__, zookeeper_config_path='configs/config.d/zookeeper.yaml')\n+\n+    all_confd = ['configs/config.d/access_control.yaml',\n+                'configs/config.d/keeper_port.yaml',\n+                'configs/config.d/logging_no_rotate.yaml',\n+                'configs/config.d/log_to_console.yaml',\n+                'configs/config.d/macros.yaml',\n+                'configs/config.d/metric_log.yaml',\n+                'configs/config.d/more_clusters.yaml',\n+                'configs/config.d/part_log.yaml',\n+                'configs/config.d/path.yaml',\n+                'configs/config.d/query_masking_rules.yaml',\n+                'configs/config.d/tcp_with_proxy.yaml',\n+                'configs/config.d/test_cluster_with_incorrect_pw.yaml',\n+                'configs/config.d/text_log.yaml',\n+                'configs/config.d/zookeeper.yaml']\n+\n+    all_userd = ['configs/users.d/allow_introspection_functions.yaml',\n+                'configs/users.d/log_queries.yaml']\n+\n+    node = cluster.add_instance('node', base_config_dir='configs', main_configs=all_confd, user_configs=all_userd, with_zookeeper=False)\n+\n+    try:\n+        cluster.start()\n+        assert(node.query(\"select value from system.settings where name = 'max_memory_usage'\") == \"10000000000\\n\")\n+        assert(node.query(\"select value from system.settings where name = 'max_block_size'\") == \"64999\\n\")\n+\n+    finally:\n+        cluster.shutdown()\ndiff --git a/tests/integration/test_config_xml_yaml_mix/__init__.py b/tests/integration/test_config_xml_yaml_mix/__init__.py\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/0_common_instance_config.yaml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/0_common_instance_config.yaml\nnew file mode 100644\nindex 000000000000..62e4ba8c7442\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/0_common_instance_config.yaml\n@@ -0,0 +1,6 @@\n+timezone: Europe/Moscow\n+listen_host: 0.0.0.0\n+custom_settings_prefixes: custom_\n+path: /var/lib/clickhouse/\n+tmp_path: /var/lib/clickhouse/tmp/\n+users_config: users.yaml\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/access_control.yaml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/access_control.yaml\nnew file mode 100644\nindex 000000000000..ce2e23839ef3\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/access_control.yaml\n@@ -0,0 +1,7 @@\n+user_directories:\n+  users_xml:\n+    path: users.yaml\n+  local_directory:\n+    path: access/\n+  \"@replace\": replace\n+\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/keeper_port.xml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/keeper_port.xml\nnew file mode 100644\nindex 000000000000..b21df47bc850\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/keeper_port.xml\n@@ -0,0 +1,23 @@\n+<yandex>\n+    <keeper_server>\n+        <tcp_port>9181</tcp_port>\n+        <server_id>1</server_id>\n+\n+        <coordination_settings>\n+            <operation_timeout_ms>10000</operation_timeout_ms>\n+            <session_timeout_ms>30000</session_timeout_ms>\n+            <force_sync>false</force_sync>\n+            <startup_timeout>60000</startup_timeout>\n+            <!-- we want all logs for complex problems investigation -->\n+            <reserved_log_items>1000000000000000</reserved_log_items>\n+        </coordination_settings>\n+\n+        <raft_configuration>\n+            <server>\n+                <id>1</id>\n+                <hostname>localhost</hostname>\n+                <port>44444</port>\n+            </server>\n+        </raft_configuration>\n+    </keeper_server>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/log_to_console.yaml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/log_to_console.yaml\nnew file mode 100644\nindex 000000000000..7b59339800b9\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/log_to_console.yaml\n@@ -0,0 +1,7 @@\n+logger:\n+  console: true\n+  log:\n+    \"@remove\": remove\n+  errorlog:\n+    \"@remove\": remove\n+\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/logging_no_rotate.xml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/logging_no_rotate.xml\nnew file mode 100644\nindex 000000000000..2c34585437bf\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/logging_no_rotate.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <logger>\n+        <!-- Disable rotation\n+             https://pocoproject.org/docs/Poco.FileChannel.html\n+        -->\n+        <size>never</size>\n+    </logger>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/macros.yaml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/macros.yaml\nnew file mode 100644\nindex 000000000000..a9c61e270ab3\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/macros.yaml\n@@ -0,0 +1,7 @@\n+macros:\n+  test: 'Hello, world!'\n+  shard: s1\n+  replica: r1\n+  default_path_test: '/clickhouse/tables/{database}/{shard}/'\n+  default_name_test: 'table_{table}'\n+\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/metric_log.xml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/metric_log.xml\nnew file mode 100644\nindex 000000000000..0ca9f1624169\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/metric_log.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <metric_log>\n+        <database>system</database>\n+        <table>metric_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+        <collect_interval_milliseconds>1000</collect_interval_milliseconds>\n+    </metric_log>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/more_clusters.yaml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/more_clusters.yaml\nnew file mode 100644\nindex 000000000000..7da071908945\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/more_clusters.yaml\n@@ -0,0 +1,23 @@\n+remote_servers:\n+  single_remote_shard_at_port_9001:\n+    shard:\n+      replica:\n+        host: localhost\n+        port: 9001\n+  two_remote_shards_at_port_9001_9002:\n+    shard:\n+      - replica:\n+          host: localhost\n+          port: 9001\n+      - replica:\n+          host: localhost\n+          port: 9002\n+  two_shards_one_local_one_remote_at_port_9001:\n+    shard:\n+      - replica:\n+          host: localhost\n+          port: 9000\n+      - replica:\n+          host: localhost\n+          port: 9001\n+\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/part_log.xml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/part_log.xml\nnew file mode 100644\nindex 000000000000..6c6fc9c69823\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/part_log.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <part_log>\n+        <database>system</database>\n+        <table>part_log</table>\n+\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </part_log>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/path.yaml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/path.yaml\nnew file mode 100644\nindex 000000000000..3e26e8906eef\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/path.yaml\n@@ -0,0 +1,18 @@\n+path:\n+  - ./\n+  - \"@replace\": replace\n+tmp_path:\n+  - ./tmp/\n+  - \"@replace\": replace\n+user_files_path:\n+  - ./user_files/\n+  - \"@replace\": replace\n+format_schema_path:\n+  - ./format_schemas/\n+  - \"@replace\": replace\n+access_control_path:\n+  - ./access/\n+  - \"@replace\": replace\n+top_level_domains_path:\n+  - ./top_level_domains/\n+  - \"@replace\": replace\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/query_masking_rules.xml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/query_masking_rules.xml\nnew file mode 100644\nindex 000000000000..5a854848f3d7\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/query_masking_rules.xml\n@@ -0,0 +1,10 @@\n+<?xml version=\"1.0\"?>\n+<!-- Config for test server -->\n+<yandex>\n+    <query_masking_rules>\n+        <rule>\n+            <regexp>TOPSECRET.TOPSECRET</regexp>\n+            <replace>[hidden]</replace>\n+        </rule>\n+    </query_masking_rules>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/tcp_with_proxy.yaml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/tcp_with_proxy.yaml\nnew file mode 100644\nindex 000000000000..b0349f5a9b99\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/tcp_with_proxy.yaml\n@@ -0,0 +1,1 @@\n+tcp_with_proxy_port: 9010\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/test_cluster_with_incorrect_pw.xml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/test_cluster_with_incorrect_pw.xml\nnew file mode 100644\nindex 000000000000..109e35afc37b\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/test_cluster_with_incorrect_pw.xml\n@@ -0,0 +1,21 @@\n+<yandex>\n+    <remote_servers>\n+        <test_cluster_with_incorrect_pw>\n+             <shard>\n+                 <internal_replication>true</internal_replication>\n+                 <replica>\n+                     <host>127.0.0.1</host>\n+                     <port>9000</port>\n+                     <!-- password is incorrect -->\n+                     <password>foo</password>\n+                 </replica>\n+                 <replica>\n+                     <host>127.0.0.2</host>\n+                     <port>9000</port>\n+                     <!-- password is incorrect -->\n+                     <password>foo</password>\n+                 </replica>\n+             </shard>\n+         </test_cluster_with_incorrect_pw>\n+    </remote_servers>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/text_log.yaml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/text_log.yaml\nnew file mode 100644\nindex 000000000000..4d188020e374\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/text_log.yaml\n@@ -0,0 +1,4 @@\n+text_log:\n+  database: system\n+  table: text_log\n+  flush_interval_milliseconds: 7500\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.d/zookeeper.xml b/tests/integration/test_config_xml_yaml_mix/configs/config.d/zookeeper.xml\nnew file mode 100644\nindex 000000000000..06ed7fcd39f3\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.d/zookeeper.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <zookeeper>\n+        <node index=\"1\">\n+            <host>localhost</host>\n+            <port>9181</port>\n+        </node>\n+    </zookeeper>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/config.xml b/tests/integration/test_config_xml_yaml_mix/configs/config.xml\nnew file mode 100644\nindex 000000000000..e6a2b6d53245\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/config.xml\n@@ -0,0 +1,277 @@\n+<?xml version=\"1.0\"?>\n+<yandex>\n+    <logger>\n+        <level>trace</level>\n+        <log>/var/log/clickhouse-server/clickhouse-server.log</log>\n+        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>\n+        <size>1000M</size>\n+        <count>10</count>\n+    </logger>\n+    <http_port>8123</http_port>\n+    <tcp_port>9000</tcp_port>\n+    <mysql_port>9004</mysql_port>\n+    <postgresql_port>9005</postgresql_port>\n+    <interserver_http_port>9009</interserver_http_port>\n+    <max_connections>4096</max_connections>\n+    <keep_alive_timeout>3</keep_alive_timeout>\n+    <grpc>\n+        <enable_ssl>false</enable_ssl>\n+        <ssl_cert_file>/path/to/ssl_cert_file</ssl_cert_file>\n+        <ssl_key_file>/path/to/ssl_key_file</ssl_key_file>\n+        <ssl_require_client_auth>false</ssl_require_client_auth>\n+        <ssl_ca_cert_file>/path/to/ssl_ca_cert_file</ssl_ca_cert_file>\n+        <compression>deflate</compression>\n+        <compression_level>medium</compression_level>\n+        <max_send_message_size>-1</max_send_message_size>\n+        <max_receive_message_size>-1</max_receive_message_size>\n+        <verbose_logs>false</verbose_logs>\n+    </grpc>\n+    <openSSL>\n+        <server> \n+            <certificateFile>/etc/clickhouse-server/server.crt</certificateFile>\n+            <privateKeyFile>/etc/clickhouse-server/server.key</privateKeyFile>\n+            <dhParamsFile>/etc/clickhouse-server/dhparam.pem</dhParamsFile>\n+            <verificationMode>none</verificationMode>\n+            <loadDefaultCAFile>true</loadDefaultCAFile>\n+            <cacheSessions>true</cacheSessions>\n+            <disableProtocols>sslv2,sslv3</disableProtocols>\n+            <preferServerCiphers>true</preferServerCiphers>\n+        </server>\n+\n+        <client>\n+            <loadDefaultCAFile>true</loadDefaultCAFile>\n+            <cacheSessions>true</cacheSessions>\n+            <disableProtocols>sslv2,sslv3</disableProtocols>\n+            <preferServerCiphers>true</preferServerCiphers>\n+            <invalidCertificateHandler>\n+                <name>RejectCertificateHandler</name>\n+            </invalidCertificateHandler>\n+        </client>\n+    </openSSL>\n+    <max_concurrent_queries>100</max_concurrent_queries>\n+    <max_server_memory_usage>0</max_server_memory_usage>\n+    <max_thread_pool_size>10000</max_thread_pool_size>\n+\n+    <max_server_memory_usage_to_ram_ratio>0.9</max_server_memory_usage_to_ram_ratio>\n+\n+    <total_memory_profiler_step>4194304</total_memory_profiler_step>\n+\n+    <total_memory_tracker_sample_probability>0</total_memory_tracker_sample_probability>\n+\n+    <uncompressed_cache_size>8589934592</uncompressed_cache_size>\n+\n+    <mark_cache_size>5368709120</mark_cache_size>\n+\n+    <mmap_cache_size>1000</mmap_cache_size>\n+\n+    <path>/var/lib/clickhouse/</path>\n+\n+    <tmp_path>/var/lib/clickhouse/tmp/</tmp_path>\n+    <user_files_path>/var/lib/clickhouse/user_files/</user_files_path>\n+    <ldap_servers>\n+    </ldap_servers>\n+    <user_directories>\n+        <users_xml>\n+            <path>users.yaml</path>\n+        </users_xml>\n+        <local_directory>\n+            <path>/var/lib/clickhouse/access/</path>\n+        </local_directory>\n+    </user_directories>\n+    <default_profile>default</default_profile>\n+    <custom_settings_prefixes></custom_settings_prefixes>\n+    <default_database>default</default_database>\n+    <mlock_executable>true</mlock_executable>\n+\n+    <remap_executable>false</remap_executable>\n+    <remote_servers>\n+        <test_shard_localhost>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+        </test_shard_localhost>\n+        <test_cluster_two_shards_localhost>\n+             <shard>\n+                 <replica>\n+                     <host>localhost</host>\n+                     <port>9000</port>\n+                 </replica>\n+             </shard>\n+             <shard>\n+                 <replica>\n+                     <host>localhost</host>\n+                     <port>9000</port>\n+                 </replica>\n+             </shard>\n+        </test_cluster_two_shards_localhost>\n+        <test_cluster_two_shards>\n+            <shard>\n+                <replica>\n+                    <host>127.0.0.1</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <replica>\n+                    <host>127.0.0.2</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+        </test_cluster_two_shards>\n+        <test_cluster_two_shards_internal_replication>\n+            <shard>\n+                <internal_replication>true</internal_replication>\n+                <replica>\n+                    <host>127.0.0.1</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <internal_replication>true</internal_replication>\n+                <replica>\n+                    <host>127.0.0.2</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+        </test_cluster_two_shards_internal_replication>\n+        <test_shard_localhost_secure>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9440</port>\n+                    <secure>1</secure>\n+                </replica>\n+            </shard>\n+        </test_shard_localhost_secure>\n+        <test_unavailable_shard>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>1</port>\n+                </replica>\n+            </shard>\n+        </test_unavailable_shard>\n+    </remote_servers>\n+\n+    <builtin_dictionaries_reload_interval>3600</builtin_dictionaries_reload_interval>\n+\n+    <max_session_timeout>3600</max_session_timeout>\n+\n+    <default_session_timeout>60</default_session_timeout>\n+\n+    <query_log>\n+        <database>system</database>\n+        <table>query_log</table>\n+        \n+        <partition_by>toYYYYMM(event_date)</partition_by>\n+        \n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </query_log>\n+\n+    <trace_log>\n+        <database>system</database>\n+        <table>trace_log</table>\n+\n+        <partition_by>toYYYYMM(event_date)</partition_by>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </trace_log>\n+\n+    <query_thread_log>\n+        <database>system</database>\n+        <table>query_thread_log</table>\n+        <partition_by>toYYYYMM(event_date)</partition_by>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </query_thread_log>\n+\n+    <metric_log>\n+        <database>system</database>\n+        <table>metric_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+        <collect_interval_milliseconds>1000</collect_interval_milliseconds>\n+    </metric_log>\n+\n+    <asynchronous_metric_log>\n+        <database>system</database>\n+        <table>asynchronous_metric_log</table>\n+\n+        <flush_interval_milliseconds>60000</flush_interval_milliseconds>\n+    </asynchronous_metric_log>\n+\n+    <opentelemetry_span_log>\n+        <engine>\n+            engine MergeTree\n+            partition by toYYYYMM(finish_date)\n+            order by (finish_date, finish_time_us, trace_id)\n+        </engine>\n+        <database>system</database>\n+        <table>opentelemetry_span_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </opentelemetry_span_log>\n+\n+    <crash_log>\n+        <database>system</database>\n+        <table>crash_log</table>\n+\n+        <partition_by />\n+        <flush_interval_milliseconds>1000</flush_interval_milliseconds>\n+    </crash_log>\n+\n+    <top_level_domains_lists>\n+    </top_level_domains_lists>\n+\n+    <dictionaries_config>*_dictionary.xml</dictionaries_config>\n+    <distributed_ddl>\n+        <path>/clickhouse/task_queue/ddl</path>\n+    </distributed_ddl>\n+    <graphite_rollup_example>\n+        <pattern>\n+            <regexp>click_cost</regexp>\n+            <function>any</function>\n+            <retention>\n+                <age>0</age>\n+                <precision>3600</precision>\n+            </retention>\n+            <retention>\n+                <age>86400</age>\n+                <precision>60</precision>\n+            </retention>\n+        </pattern>\n+        <default>\n+            <function>max</function>\n+            <retention>\n+                <age>0</age>\n+                <precision>60</precision>\n+            </retention>\n+            <retention>\n+                <age>3600</age>\n+                <precision>300</precision>\n+            </retention>\n+            <retention>\n+                <age>86400</age>\n+                <precision>3600</precision>\n+            </retention>\n+        </default>\n+    </graphite_rollup_example>\n+    <format_schema_path>/var/lib/clickhouse/format_schemas/</format_schema_path>\n+    <query_masking_rules>\n+        <rule>\n+            <name>hide encrypt/decrypt arguments</name>\n+            <regexp>((?:aes_)?(?:encrypt|decrypt)(?:_mysql)?)\\s*\\(\\s*(?:'(?:\\\\'|.)+'|.*?)\\s*\\)</regexp>\n+            <replace>\\1(???)</replace>\n+        </rule>\n+    </query_masking_rules>\n+    <send_crash_reports>\n+        <enabled>false</enabled>\n+        <anonymize>false</anonymize>\n+        <endpoint>https://6f33034cfe684dd7a3ab9875e57b1c8d@o388870.ingest.sentry.io/5226277</endpoint>\n+    </send_crash_reports>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/embedded.xml b/tests/integration/test_config_xml_yaml_mix/configs/embedded.xml\nnew file mode 100644\nindex 000000000000..a66f57d1eb70\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/embedded.xml\n@@ -0,0 +1,40 @@\n+<?xml version=\"1.0\"?>\n+<!-- Config that is used when server is run without config file. -->\n+<yandex>\n+    <logger>\n+        <level>trace</level>\n+        <console>true</console>\n+    </logger>\n+\n+    <http_port>8123</http_port>\n+    <tcp_port>9000</tcp_port>\n+    <mysql_port>9004</mysql_port>\n+\n+    <path>./</path>\n+\n+    <uncompressed_cache_size>8589934592</uncompressed_cache_size>\n+    <mark_cache_size>5368709120</mark_cache_size>\n+    <mlock_executable>true</mlock_executable>\n+\n+    <users>\n+        <default>\n+            <password></password>\n+\n+            <networks>\n+                <ip>::/0</ip>\n+            </networks>\n+\n+            <profile>default</profile>\n+            <quota>default</quota>\n+            <access_management>1</access_management>\n+        </default>\n+    </users>\n+\n+    <profiles>\n+        <default/>\n+    </profiles>\n+\n+    <quotas>\n+        <default />\n+    </quotas>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/users.d/allow_introspection_functions.xml b/tests/integration/test_config_xml_yaml_mix/configs/users.d/allow_introspection_functions.xml\nnew file mode 100644\nindex 000000000000..b94e95bc043d\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/users.d/allow_introspection_functions.xml\n@@ -0,0 +1,8 @@\n+<?xml version=\"1.0\"?>\n+<yandex>\n+    <profiles>\n+        <default>\n+            <allow_introspection_functions>1</allow_introspection_functions>\n+        </default>\n+    </profiles>\n+</yandex>\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/users.d/log_queries.yaml b/tests/integration/test_config_xml_yaml_mix/configs/users.d/log_queries.yaml\nnew file mode 100644\nindex 000000000000..88574e8f764c\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/users.d/log_queries.yaml\n@@ -0,0 +1,3 @@\n+profiles:\n+  default:\n+    log_queries: 1\ndiff --git a/tests/integration/test_config_xml_yaml_mix/configs/users.yaml b/tests/integration/test_config_xml_yaml_mix/configs/users.yaml\nnew file mode 100644\nindex 000000000000..a87a8c828191\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/configs/users.yaml\n@@ -0,0 +1,12 @@\n+profiles:\n+  default:\n+    max_memory_usage: 10000000000\n+    max_block_size: 64999\n+users:\n+  default:\n+    password: ''\n+    networks:\n+      \"@replace\": replace\n+      ip: '::/0'\n+    profile: default\n+\ndiff --git a/tests/integration/test_config_xml_yaml_mix/test.py b/tests/integration/test_config_xml_yaml_mix/test.py\nnew file mode 100644\nindex 000000000000..90ee8a2dea58\n--- /dev/null\n+++ b/tests/integration/test_config_xml_yaml_mix/test.py\n@@ -0,0 +1,43 @@\n+import time\n+import threading\n+from os import path as p, unlink\n+from tempfile import NamedTemporaryFile\n+\n+import helpers\n+import pytest\n+from helpers.cluster import ClickHouseCluster\n+\n+\n+def test_extra_yaml_mix():\n+    # some configs are written in XML, others are written in YAML\n+    cluster = ClickHouseCluster(__file__, zookeeper_config_path='configs/config.d/zookeeper.xml')\n+\n+    all_confd = ['configs/config.d/0_common_instance_config.yaml',\n+                'configs/config.d/access_control.yaml',\n+                'configs/config.d/keeper_port.xml',\n+                'configs/config.d/logging_no_rotate.xml',\n+                'configs/config.d/log_to_console.yaml',\n+                'configs/config.d/macros.yaml',\n+                'configs/config.d/metric_log.xml',\n+                'configs/config.d/more_clusters.yaml',\n+                'configs/config.d/part_log.xml',\n+                'configs/config.d/path.yaml',\n+                'configs/config.d/query_masking_rules.xml',\n+                'configs/config.d/tcp_with_proxy.yaml',\n+                'configs/config.d/test_cluster_with_incorrect_pw.xml',\n+                'configs/config.d/text_log.yaml',\n+                'configs/config.d/zookeeper.xml']\n+\n+    all_userd = ['configs/users.d/allow_introspection_functions.xml',\n+                'configs/users.d/log_queries.yaml']\n+\n+    node = cluster.add_instance('node', base_config_dir='configs', main_configs=all_confd, user_configs=all_userd, with_zookeeper=False,\n+    users_config_name=\"users.yaml\", copy_common_configs=False)\n+\n+    try:\n+        cluster.start()\n+        assert(node.query(\"select value from system.settings where name = 'max_memory_usage'\") == \"10000000000\\n\")\n+        assert(node.query(\"select value from system.settings where name = 'max_block_size'\") == \"64999\\n\")\n+\n+    finally:\n+        cluster.shutdown()\ndiff --git a/tests/integration/test_config_yaml_full/__init__.py b/tests/integration/test_config_yaml_full/__init__.py\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/0_common_instance_config.yaml b/tests/integration/test_config_yaml_full/configs/config.d/0_common_instance_config.yaml\nnew file mode 100644\nindex 000000000000..62e4ba8c7442\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/0_common_instance_config.yaml\n@@ -0,0 +1,6 @@\n+timezone: Europe/Moscow\n+listen_host: 0.0.0.0\n+custom_settings_prefixes: custom_\n+path: /var/lib/clickhouse/\n+tmp_path: /var/lib/clickhouse/tmp/\n+users_config: users.yaml\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/access_control.yaml b/tests/integration/test_config_yaml_full/configs/config.d/access_control.yaml\nnew file mode 100644\nindex 000000000000..ce2e23839ef3\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/access_control.yaml\n@@ -0,0 +1,7 @@\n+user_directories:\n+  users_xml:\n+    path: users.yaml\n+  local_directory:\n+    path: access/\n+  \"@replace\": replace\n+\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/keeper_port.yaml b/tests/integration/test_config_yaml_full/configs/config.d/keeper_port.yaml\nnew file mode 100644\nindex 000000000000..91723bc372f1\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/keeper_port.yaml\n@@ -0,0 +1,15 @@\n+keeper_server:\n+  tcp_port: 9181\n+  server_id: 1\n+  coordination_settings:\n+    operation_timeout_ms: 10000\n+    session_timeout_ms: 30000\n+    force_sync: false\n+    startup_timeout: 60000\n+    reserved_log_items: 1000000000000000\n+  raft_configuration:\n+    server:\n+      id: 1\n+      hostname: localhost\n+      port: 44444\n+\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/log_to_console.yaml b/tests/integration/test_config_yaml_full/configs/config.d/log_to_console.yaml\nnew file mode 100644\nindex 000000000000..7b59339800b9\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/log_to_console.yaml\n@@ -0,0 +1,7 @@\n+logger:\n+  console: true\n+  log:\n+    \"@remove\": remove\n+  errorlog:\n+    \"@remove\": remove\n+\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/logging_no_rotate.yaml b/tests/integration/test_config_yaml_full/configs/config.d/logging_no_rotate.yaml\nnew file mode 100644\nindex 000000000000..513cd3f7dc51\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/logging_no_rotate.yaml\n@@ -0,0 +1,2 @@\n+logger:\n+  size: never\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/macros.yaml b/tests/integration/test_config_yaml_full/configs/config.d/macros.yaml\nnew file mode 100644\nindex 000000000000..a9c61e270ab3\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/macros.yaml\n@@ -0,0 +1,7 @@\n+macros:\n+  test: 'Hello, world!'\n+  shard: s1\n+  replica: r1\n+  default_path_test: '/clickhouse/tables/{database}/{shard}/'\n+  default_name_test: 'table_{table}'\n+\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/metric_log.yaml b/tests/integration/test_config_yaml_full/configs/config.d/metric_log.yaml\nnew file mode 100644\nindex 000000000000..aafad939c377\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/metric_log.yaml\n@@ -0,0 +1,6 @@\n+metric_log:\n+  database: system\n+  table: metric_log\n+  flush_interval_milliseconds: 7500\n+  collect_interval_milliseconds: 1000\n+\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/more_clusters.yaml b/tests/integration/test_config_yaml_full/configs/config.d/more_clusters.yaml\nnew file mode 100644\nindex 000000000000..7da071908945\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/more_clusters.yaml\n@@ -0,0 +1,23 @@\n+remote_servers:\n+  single_remote_shard_at_port_9001:\n+    shard:\n+      replica:\n+        host: localhost\n+        port: 9001\n+  two_remote_shards_at_port_9001_9002:\n+    shard:\n+      - replica:\n+          host: localhost\n+          port: 9001\n+      - replica:\n+          host: localhost\n+          port: 9002\n+  two_shards_one_local_one_remote_at_port_9001:\n+    shard:\n+      - replica:\n+          host: localhost\n+          port: 9000\n+      - replica:\n+          host: localhost\n+          port: 9001\n+\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/part_log.yaml b/tests/integration/test_config_yaml_full/configs/config.d/part_log.yaml\nnew file mode 100644\nindex 000000000000..43f60146dca1\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/part_log.yaml\n@@ -0,0 +1,5 @@\n+part_log:\n+  database: system\n+  table: part_log\n+  flush_interval_milliseconds: 7500\n+\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/path.yaml b/tests/integration/test_config_yaml_full/configs/config.d/path.yaml\nnew file mode 100644\nindex 000000000000..3e26e8906eef\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/path.yaml\n@@ -0,0 +1,18 @@\n+path:\n+  - ./\n+  - \"@replace\": replace\n+tmp_path:\n+  - ./tmp/\n+  - \"@replace\": replace\n+user_files_path:\n+  - ./user_files/\n+  - \"@replace\": replace\n+format_schema_path:\n+  - ./format_schemas/\n+  - \"@replace\": replace\n+access_control_path:\n+  - ./access/\n+  - \"@replace\": replace\n+top_level_domains_path:\n+  - ./top_level_domains/\n+  - \"@replace\": replace\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/query_masking_rules.yaml b/tests/integration/test_config_yaml_full/configs/config.d/query_masking_rules.yaml\nnew file mode 100644\nindex 000000000000..38163429d810\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/query_masking_rules.yaml\n@@ -0,0 +1,4 @@\n+query_masking_rules:\n+  rule:\n+    regexp: TOPSECRET.TOPSECRET\n+    replace: '[hidden]'\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/tcp_with_proxy.yaml b/tests/integration/test_config_yaml_full/configs/config.d/tcp_with_proxy.yaml\nnew file mode 100644\nindex 000000000000..b0349f5a9b99\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/tcp_with_proxy.yaml\n@@ -0,0 +1,1 @@\n+tcp_with_proxy_port: 9010\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/test_cluster_with_incorrect_pw.yaml b/tests/integration/test_config_yaml_full/configs/config.d/test_cluster_with_incorrect_pw.yaml\nnew file mode 100644\nindex 000000000000..309a7daa81d1\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/test_cluster_with_incorrect_pw.yaml\n@@ -0,0 +1,11 @@\n+remote_servers:\n+  test_cluster_with_incorrect_pw:\n+    shard:\n+      internal_replication: true\n+      replica:\n+        - host: 127.0.0.1\n+          port: 9000\n+          password: foo\n+        - host: 127.0.0.2\n+          port: 9000\n+          password: foo\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/text_log.yaml b/tests/integration/test_config_yaml_full/configs/config.d/text_log.yaml\nnew file mode 100644\nindex 000000000000..4d188020e374\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/text_log.yaml\n@@ -0,0 +1,4 @@\n+text_log:\n+  database: system\n+  table: text_log\n+  flush_interval_milliseconds: 7500\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.d/zookeeper.yaml b/tests/integration/test_config_yaml_full/configs/config.d/zookeeper.yaml\nnew file mode 100644\nindex 000000000000..be02c516798a\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.d/zookeeper.yaml\n@@ -0,0 +1,5 @@\n+zookeeper:\n+  node:\n+    host: localhost\n+    port: 9181\n+    \"@index\": 1\ndiff --git a/tests/integration/test_config_yaml_full/configs/config.yaml b/tests/integration/test_config_yaml_full/configs/config.yaml\nnew file mode 100644\nindex 000000000000..619a3735269a\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/config.yaml\n@@ -0,0 +1,183 @@\n+logger:\n+  level: trace\n+  log: /var/log/clickhouse-server/clickhouse-server.log\n+  errorlog: /var/log/clickhouse-server/clickhouse-server.err.log\n+  size: 1000M\n+  count: 10\n+http_port: 8123\n+tcp_port: 9000\n+mysql_port: 9004\n+postgresql_port: 9005\n+interserver_http_port: 9009\n+max_connections: 4096\n+keep_alive_timeout: 3\n+grpc:\n+  enable_ssl: false\n+  ssl_cert_file: /path/to/ssl_cert_file\n+  ssl_key_file: /path/to/ssl_key_file\n+  ssl_require_client_auth: false\n+  ssl_ca_cert_file: /path/to/ssl_ca_cert_file\n+  compression: deflate\n+  compression_level: medium\n+  max_send_message_size: -1\n+  max_receive_message_size: -1\n+  verbose_logs: false\n+openSSL:\n+  server:\n+    certificateFile: /etc/clickhouse-server/server.crt\n+    privateKeyFile: /etc/clickhouse-server/server.key\n+    dhParamsFile: /etc/clickhouse-server/dhparam.pem\n+    verificationMode: none\n+    loadDefaultCAFile: true\n+    cacheSessions: true\n+    disableProtocols: 'sslv2,sslv3'\n+    preferServerCiphers: true\n+  client:\n+    loadDefaultCAFile: true\n+    cacheSessions: true\n+    disableProtocols: 'sslv2,sslv3'\n+    preferServerCiphers: true\n+    invalidCertificateHandler:\n+      name: RejectCertificateHandler\n+max_concurrent_queries: 100\n+max_server_memory_usage: 0\n+max_thread_pool_size: 10000\n+max_server_memory_usage_to_ram_ratio: 0.9\n+total_memory_profiler_step: 4194304\n+total_memory_tracker_sample_probability: 0\n+uncompressed_cache_size: 8589934592\n+mark_cache_size: 5368709120\n+mmap_cache_size: 1000\n+path: /var/lib/clickhouse/\n+tmp_path: /var/lib/clickhouse/tmp/\n+user_files_path: /var/lib/clickhouse/user_files/\n+ldap_servers: ''\n+user_directories:\n+  users_xml:\n+    path: users.yaml\n+  local_directory:\n+    path: /var/lib/clickhouse/access/\n+default_profile: default\n+custom_settings_prefixes: ''\n+default_database: default\n+mlock_executable: true\n+remap_executable: false\n+remote_servers:\n+  test_shard_localhost:\n+    shard:\n+      replica:\n+        host: localhost\n+        port: 9000\n+  test_cluster_two_shards_localhost:\n+    shard:\n+      - replica:\n+          host: localhost\n+          port: 9000\n+      - replica:\n+          host: localhost\n+          port: 9000\n+  test_cluster_two_shards:\n+    shard:\n+      - replica:\n+          host: 127.0.0.1\n+          port: 9000\n+      - replica:\n+          host: 127.0.0.2\n+          port: 9000\n+  test_cluster_two_shards_internal_replication:\n+    shard:\n+      - internal_replication: true\n+        replica:\n+          host: 127.0.0.1\n+          port: 9000\n+      - internal_replication: true\n+        replica:\n+          host: 127.0.0.2\n+          port: 9000\n+  test_shard_localhost_secure:\n+    shard:\n+      replica:\n+        host: localhost\n+        port: 9440\n+        secure: 1\n+  test_unavailable_shard:\n+    shard:\n+      - replica:\n+          host: localhost\n+          port: 9000\n+      - replica:\n+          host: localhost\n+          port: 1\n+builtin_dictionaries_reload_interval: 3600\n+max_session_timeout: 3600\n+default_session_timeout: 60\n+query_log:\n+  database: system\n+  table: query_log\n+  partition_by: toYYYYMM(event_date)\n+  flush_interval_milliseconds: 7500\n+trace_log:\n+  database: system\n+  table: trace_log\n+  partition_by: toYYYYMM(event_date)\n+  flush_interval_milliseconds: 7500\n+query_thread_log:\n+  database: system\n+  table: query_thread_log\n+  partition_by: toYYYYMM(event_date)\n+  flush_interval_milliseconds: 7500\n+metric_log:\n+  database: system\n+  table: metric_log\n+  flush_interval_milliseconds: 7500\n+  collect_interval_milliseconds: 1000\n+asynchronous_metric_log:\n+  database: system\n+  table: asynchronous_metric_log\n+  flush_interval_milliseconds: 60000\n+opentelemetry_span_log:\n+  engine: |-\n+    engine MergeTree\n+                partition by toYYYYMM(finish_date)\n+                order by (finish_date, finish_time_us, trace_id)\n+  database: system\n+  table: opentelemetry_span_log\n+  flush_interval_milliseconds: 7500\n+crash_log:\n+  database: system\n+  table: crash_log\n+  partition_by: ''\n+  flush_interval_milliseconds: 1000\n+top_level_domains_lists: ''\n+dictionaries_config: '*_dictionary.xml'\n+distributed_ddl:\n+  path: /clickhouse/task_queue/ddl\n+graphite_rollup_example:\n+  pattern:\n+    regexp: click_cost\n+    function: any\n+    retention:\n+      - age: 0\n+        precision: 3600\n+      - age: 86400\n+        precision: 60\n+  default:\n+    function: max\n+    retention:\n+      - age: 0\n+        precision: 60\n+      - age: 3600\n+        precision: 300\n+      - age: 86400\n+        precision: 3600\n+format_schema_path: /var/lib/clickhouse/format_schemas/\n+query_masking_rules:\n+  rule:\n+    name: hide encrypt/decrypt arguments\n+    regexp: '((?:aes_)?(?:encrypt|decrypt)(?:_mysql)?)\\s*\\(\\s*(?:''(?:\\\\''|.)+''|.*?)\\s*\\)'\n+    replace: \\1(???)\n+send_crash_reports:\n+  enabled: false\n+  anonymize: false\n+  endpoint: 'https://6f33034cfe684dd7a3ab9875e57b1c8d@o388870.ingest.sentry.io/5226277'\n+\ndiff --git a/tests/integration/test_config_yaml_full/configs/embedded.xml b/tests/integration/test_config_yaml_full/configs/embedded.xml\nnew file mode 100644\nindex 000000000000..a66f57d1eb70\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/embedded.xml\n@@ -0,0 +1,40 @@\n+<?xml version=\"1.0\"?>\n+<!-- Config that is used when server is run without config file. -->\n+<yandex>\n+    <logger>\n+        <level>trace</level>\n+        <console>true</console>\n+    </logger>\n+\n+    <http_port>8123</http_port>\n+    <tcp_port>9000</tcp_port>\n+    <mysql_port>9004</mysql_port>\n+\n+    <path>./</path>\n+\n+    <uncompressed_cache_size>8589934592</uncompressed_cache_size>\n+    <mark_cache_size>5368709120</mark_cache_size>\n+    <mlock_executable>true</mlock_executable>\n+\n+    <users>\n+        <default>\n+            <password></password>\n+\n+            <networks>\n+                <ip>::/0</ip>\n+            </networks>\n+\n+            <profile>default</profile>\n+            <quota>default</quota>\n+            <access_management>1</access_management>\n+        </default>\n+    </users>\n+\n+    <profiles>\n+        <default/>\n+    </profiles>\n+\n+    <quotas>\n+        <default />\n+    </quotas>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_full/configs/users.d/allow_introspection_functions.yaml b/tests/integration/test_config_yaml_full/configs/users.d/allow_introspection_functions.yaml\nnew file mode 100644\nindex 000000000000..84612c198c9d\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/users.d/allow_introspection_functions.yaml\n@@ -0,0 +1,3 @@\n+profiles:\n+  default:\n+    allow_introspection_functions: 1\ndiff --git a/tests/integration/test_config_yaml_full/configs/users.d/log_queries.yaml b/tests/integration/test_config_yaml_full/configs/users.d/log_queries.yaml\nnew file mode 100644\nindex 000000000000..88574e8f764c\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/users.d/log_queries.yaml\n@@ -0,0 +1,3 @@\n+profiles:\n+  default:\n+    log_queries: 1\ndiff --git a/tests/integration/test_config_yaml_full/configs/users.yaml b/tests/integration/test_config_yaml_full/configs/users.yaml\nnew file mode 100644\nindex 000000000000..a87a8c828191\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/configs/users.yaml\n@@ -0,0 +1,12 @@\n+profiles:\n+  default:\n+    max_memory_usage: 10000000000\n+    max_block_size: 64999\n+users:\n+  default:\n+    password: ''\n+    networks:\n+      \"@replace\": replace\n+      ip: '::/0'\n+    profile: default\n+\ndiff --git a/tests/integration/test_config_yaml_full/test.py b/tests/integration/test_config_yaml_full/test.py\nnew file mode 100644\nindex 000000000000..bc4fa40384c0\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_full/test.py\n@@ -0,0 +1,42 @@\n+import time\n+import threading\n+from os import path as p, unlink\n+from tempfile import NamedTemporaryFile\n+\n+import helpers\n+import pytest\n+from helpers.cluster import ClickHouseCluster\n+\n+def test_yaml_full_conf():\n+    # all configs are in YAML\n+    cluster = ClickHouseCluster(__file__, zookeeper_config_path='configs/config.d/zookeeper.yaml')\n+\n+    all_confd = ['configs/config.d/0_common_instance_config.yaml',\n+                'configs/config.d/access_control.yaml',\n+                'configs/config.d/keeper_port.yaml',\n+                'configs/config.d/logging_no_rotate.yaml',\n+                'configs/config.d/log_to_console.yaml',\n+                'configs/config.d/macros.yaml',\n+                'configs/config.d/metric_log.yaml',\n+                'configs/config.d/more_clusters.yaml',\n+                'configs/config.d/part_log.yaml',\n+                'configs/config.d/path.yaml',\n+                'configs/config.d/query_masking_rules.yaml',\n+                'configs/config.d/tcp_with_proxy.yaml',\n+                'configs/config.d/test_cluster_with_incorrect_pw.yaml',\n+                'configs/config.d/text_log.yaml',\n+                'configs/config.d/zookeeper.yaml']\n+\n+    all_userd = ['configs/users.d/allow_introspection_functions.yaml',\n+                'configs/users.d/log_queries.yaml']\n+\n+    node = cluster.add_instance('node', base_config_dir='configs', main_configs=all_confd, user_configs=all_userd,\n+                                with_zookeeper=False, main_config_name=\"config.yaml\", users_config_name=\"users.yaml\", copy_common_configs=False)\n+\n+    try:\n+        cluster.start()\n+        assert(node.query(\"select value from system.settings where name = 'max_memory_usage'\") == \"10000000000\\n\")\n+        assert(node.query(\"select value from system.settings where name = 'max_block_size'\") == \"64999\\n\")\n+\n+    finally:\n+        cluster.shutdown()\ndiff --git a/tests/integration/test_config_yaml_main/__init__.py b/tests/integration/test_config_yaml_main/__init__.py\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/0_common_instance_config.yaml b/tests/integration/test_config_yaml_main/configs/config.d/0_common_instance_config.yaml\nnew file mode 100644\nindex 000000000000..62e4ba8c7442\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/0_common_instance_config.yaml\n@@ -0,0 +1,6 @@\n+timezone: Europe/Moscow\n+listen_host: 0.0.0.0\n+custom_settings_prefixes: custom_\n+path: /var/lib/clickhouse/\n+tmp_path: /var/lib/clickhouse/tmp/\n+users_config: users.yaml\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/access_control.xml b/tests/integration/test_config_yaml_main/configs/config.d/access_control.xml\nnew file mode 100644\nindex 000000000000..b61f89bd9044\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/access_control.xml\n@@ -0,0 +1,13 @@\n+<yandex>\n+    <!-- Sources to read users, roles, access rights, profiles of settings, quotas. -->\n+    <user_directories replace=\"replace\">\n+        <users_xml>\n+            <!-- Path to configuration file with predefined users. -->\n+            <path>users.yaml</path>\n+        </users_xml>\n+        <local_directory>\n+            <!-- Path to folder where users created by SQL commands are stored. -->\n+            <path>access/</path>\n+        </local_directory>\n+    </user_directories>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/keeper_port.xml b/tests/integration/test_config_yaml_main/configs/config.d/keeper_port.xml\nnew file mode 100644\nindex 000000000000..b21df47bc850\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/keeper_port.xml\n@@ -0,0 +1,23 @@\n+<yandex>\n+    <keeper_server>\n+        <tcp_port>9181</tcp_port>\n+        <server_id>1</server_id>\n+\n+        <coordination_settings>\n+            <operation_timeout_ms>10000</operation_timeout_ms>\n+            <session_timeout_ms>30000</session_timeout_ms>\n+            <force_sync>false</force_sync>\n+            <startup_timeout>60000</startup_timeout>\n+            <!-- we want all logs for complex problems investigation -->\n+            <reserved_log_items>1000000000000000</reserved_log_items>\n+        </coordination_settings>\n+\n+        <raft_configuration>\n+            <server>\n+                <id>1</id>\n+                <hostname>localhost</hostname>\n+                <port>44444</port>\n+            </server>\n+        </raft_configuration>\n+    </keeper_server>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/log_to_console.xml b/tests/integration/test_config_yaml_main/configs/config.d/log_to_console.xml\nnew file mode 100644\nindex 000000000000..227c53647f32\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/log_to_console.xml\n@@ -0,0 +1,7 @@\n+<yandex>\n+    <logger>\n+        <console>true</console>\n+        <log remove=\"remove\"/>\n+        <errorlog remove=\"remove\"/>\n+    </logger>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/logging_no_rotate.xml b/tests/integration/test_config_yaml_main/configs/config.d/logging_no_rotate.xml\nnew file mode 100644\nindex 000000000000..2c34585437bf\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/logging_no_rotate.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <logger>\n+        <!-- Disable rotation\n+             https://pocoproject.org/docs/Poco.FileChannel.html\n+        -->\n+        <size>never</size>\n+    </logger>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/macros.xml b/tests/integration/test_config_yaml_main/configs/config.d/macros.xml\nnew file mode 100644\nindex 000000000000..4902b12bc819\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/macros.xml\n@@ -0,0 +1,9 @@\n+<yandex>\n+    <macros>\n+        <test>Hello, world!</test>\n+        <shard>s1</shard>\n+        <replica>r1</replica>\n+        <default_path_test>/clickhouse/tables/{database}/{shard}/</default_path_test>\n+        <default_name_test>table_{table}</default_name_test>\n+    </macros>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/metric_log.xml b/tests/integration/test_config_yaml_main/configs/config.d/metric_log.xml\nnew file mode 100644\nindex 000000000000..0ca9f1624169\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/metric_log.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <metric_log>\n+        <database>system</database>\n+        <table>metric_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+        <collect_interval_milliseconds>1000</collect_interval_milliseconds>\n+    </metric_log>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/more_clusters.xml b/tests/integration/test_config_yaml_main/configs/config.d/more_clusters.xml\nnew file mode 100644\nindex 000000000000..aecbf9e0ba7b\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/more_clusters.xml\n@@ -0,0 +1,49 @@\n+<yandex>\n+    <remote_servers>\n+\n+        <![CDATA[\n+            You can run additional servers simply as\n+             ./clickhouse-server -- --path=9001 --tcp_port=9001\n+        ]]>\n+\n+        <single_remote_shard_at_port_9001>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9001</port>\n+                </replica>\n+            </shard>\n+        </single_remote_shard_at_port_9001>\n+\n+        <two_remote_shards_at_port_9001_9002>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9001</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9002</port>\n+                </replica>\n+            </shard>\n+        </two_remote_shards_at_port_9001_9002>\n+\n+        <two_shards_one_local_one_remote_at_port_9001>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9000</port>\n+                </replica>\n+            </shard>\n+            <shard>\n+                <replica>\n+                    <host>localhost</host>\n+                    <port>9001</port>\n+                </replica>\n+            </shard>\n+        </two_shards_one_local_one_remote_at_port_9001>\n+\n+    </remote_servers>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/part_log.xml b/tests/integration/test_config_yaml_main/configs/config.d/part_log.xml\nnew file mode 100644\nindex 000000000000..6c6fc9c69823\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/part_log.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <part_log>\n+        <database>system</database>\n+        <table>part_log</table>\n+\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </part_log>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/path.xml b/tests/integration/test_config_yaml_main/configs/config.d/path.xml\nnew file mode 100644\nindex 000000000000..466ed0d16637\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/path.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <path replace=\"replace\">./</path>\n+    <tmp_path replace=\"replace\">./tmp/</tmp_path>\n+    <user_files_path replace=\"replace\">./user_files/</user_files_path>\n+    <format_schema_path replace=\"replace\">./format_schemas/</format_schema_path>\n+    <access_control_path replace=\"replace\">./access/</access_control_path>\n+    <top_level_domains_path replace=\"replace\">./top_level_domains/</top_level_domains_path>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/query_masking_rules.xml b/tests/integration/test_config_yaml_main/configs/config.d/query_masking_rules.xml\nnew file mode 100644\nindex 000000000000..5a854848f3d7\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/query_masking_rules.xml\n@@ -0,0 +1,10 @@\n+<?xml version=\"1.0\"?>\n+<!-- Config for test server -->\n+<yandex>\n+    <query_masking_rules>\n+        <rule>\n+            <regexp>TOPSECRET.TOPSECRET</regexp>\n+            <replace>[hidden]</replace>\n+        </rule>\n+    </query_masking_rules>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/tcp_with_proxy.xml b/tests/integration/test_config_yaml_main/configs/config.d/tcp_with_proxy.xml\nnew file mode 100644\nindex 000000000000..19046054c166\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/tcp_with_proxy.xml\n@@ -0,0 +1,3 @@\n+<yandex>\n+    <tcp_with_proxy_port>9010</tcp_with_proxy_port>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/test_cluster_with_incorrect_pw.xml b/tests/integration/test_config_yaml_main/configs/config.d/test_cluster_with_incorrect_pw.xml\nnew file mode 100644\nindex 000000000000..109e35afc37b\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/test_cluster_with_incorrect_pw.xml\n@@ -0,0 +1,21 @@\n+<yandex>\n+    <remote_servers>\n+        <test_cluster_with_incorrect_pw>\n+             <shard>\n+                 <internal_replication>true</internal_replication>\n+                 <replica>\n+                     <host>127.0.0.1</host>\n+                     <port>9000</port>\n+                     <!-- password is incorrect -->\n+                     <password>foo</password>\n+                 </replica>\n+                 <replica>\n+                     <host>127.0.0.2</host>\n+                     <port>9000</port>\n+                     <!-- password is incorrect -->\n+                     <password>foo</password>\n+                 </replica>\n+             </shard>\n+         </test_cluster_with_incorrect_pw>\n+    </remote_servers>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/text_log.xml b/tests/integration/test_config_yaml_main/configs/config.d/text_log.xml\nnew file mode 100644\nindex 000000000000..3699a23578cd\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/text_log.xml\n@@ -0,0 +1,7 @@\n+<yandex>\n+    <text_log>\n+        <database>system</database>\n+        <table>text_log</table>\n+        <flush_interval_milliseconds>7500</flush_interval_milliseconds>\n+    </text_log>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.d/zookeeper.xml b/tests/integration/test_config_yaml_main/configs/config.d/zookeeper.xml\nnew file mode 100644\nindex 000000000000..06ed7fcd39f3\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.d/zookeeper.xml\n@@ -0,0 +1,8 @@\n+<yandex>\n+    <zookeeper>\n+        <node index=\"1\">\n+            <host>localhost</host>\n+            <port>9181</port>\n+        </node>\n+    </zookeeper>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/config.yaml b/tests/integration/test_config_yaml_main/configs/config.yaml\nnew file mode 100644\nindex 000000000000..e5a36b1e49b7\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/config.yaml\n@@ -0,0 +1,183 @@\n+logger:\n+  level: trace\n+  log: /var/log/clickhouse-server/clickhouse-server.log\n+  errorlog: /var/log/clickhouse-server/clickhouse-server.err.log\n+  size: 1000M\n+  count: 10\n+http_port: 8123\n+tcp_port: 9000\n+mysql_port: 9004\n+postgresql_port: 9005\n+interserver_http_port: 9009\n+max_connections: 4096\n+keep_alive_timeout: 3\n+grpc:\n+  enable_ssl: false\n+  ssl_cert_file: /path/to/ssl_cert_file\n+  ssl_key_file: /path/to/ssl_key_file\n+  ssl_require_client_auth: false\n+  ssl_ca_cert_file: /path/to/ssl_ca_cert_file\n+  compression: deflate\n+  compression_level: medium\n+  max_send_message_size: -1\n+  max_receive_message_size: -1\n+  verbose_logs: false\n+openSSL:\n+  server:\n+    certificateFile: /etc/clickhouse-server/server.crt\n+    privateKeyFile: /etc/clickhouse-server/server.key\n+    dhParamsFile: /etc/clickhouse-server/dhparam.pem\n+    verificationMode: none\n+    loadDefaultCAFile: true\n+    cacheSessions: true\n+    disableProtocols: 'sslv2,sslv3'\n+    preferServerCiphers: true\n+  client:\n+    loadDefaultCAFile: true\n+    cacheSessions: true\n+    disableProtocols: 'sslv2,sslv3'\n+    preferServerCiphers: true\n+    invalidCertificateHandler:\n+      name: RejectCertificateHandler\n+max_concurrent_queries: 100\n+max_server_memory_usage: 0\n+max_thread_pool_size: 10000\n+max_server_memory_usage_to_ram_ratio: 0.9\n+total_memory_profiler_step: 4194304\n+total_memory_tracker_sample_probability: 0\n+uncompressed_cache_size: 8589934592\n+mark_cache_size: 5368709120\n+mmap_cache_size: 1000\n+path: /var/lib/clickhouse/\n+tmp_path: /var/lib/clickhouse/tmp/\n+user_files_path: /var/lib/clickhouse/user_files/\n+ldap_servers: ''\n+user_directories:\n+  users_xml:\n+    path: users.yml\n+  local_directory:\n+    path: /var/lib/clickhouse/access/\n+default_profile: default\n+custom_settings_prefixes: ''\n+default_database: default\n+mlock_executable: true\n+remap_executable: false\n+remote_servers:\n+  test_shard_localhost:\n+    shard:\n+      replica:\n+        host: localhost\n+        port: 9000\n+  test_cluster_two_shards_localhost:\n+    shard:\n+      - replica:\n+          host: localhost\n+          port: 9000\n+      - replica:\n+          host: localhost\n+          port: 9000\n+  test_cluster_two_shards:\n+    shard:\n+      - replica:\n+          host: 127.0.0.1\n+          port: 9000\n+      - replica:\n+          host: 127.0.0.2\n+          port: 9000\n+  test_cluster_two_shards_internal_replication:\n+    shard:\n+      - internal_replication: true\n+        replica:\n+          host: 127.0.0.1\n+          port: 9000\n+      - internal_replication: true\n+        replica:\n+          host: 127.0.0.2\n+          port: 9000\n+  test_shard_localhost_secure:\n+    shard:\n+      replica:\n+        host: localhost\n+        port: 9440\n+        secure: 1\n+  test_unavailable_shard:\n+    shard:\n+      - replica:\n+          host: localhost\n+          port: 9000\n+      - replica:\n+          host: localhost\n+          port: 1\n+builtin_dictionaries_reload_interval: 3600\n+max_session_timeout: 3600\n+default_session_timeout: 60\n+query_log:\n+  database: system\n+  table: query_log\n+  partition_by: toYYYYMM(event_date)\n+  flush_interval_milliseconds: 7500\n+trace_log:\n+  database: system\n+  table: trace_log\n+  partition_by: toYYYYMM(event_date)\n+  flush_interval_milliseconds: 7500\n+query_thread_log:\n+  database: system\n+  table: query_thread_log\n+  partition_by: toYYYYMM(event_date)\n+  flush_interval_milliseconds: 7500\n+metric_log:\n+  database: system\n+  table: metric_log\n+  flush_interval_milliseconds: 7500\n+  collect_interval_milliseconds: 1000\n+asynchronous_metric_log:\n+  database: system\n+  table: asynchronous_metric_log\n+  flush_interval_milliseconds: 60000\n+opentelemetry_span_log:\n+  engine: |-\n+    engine MergeTree\n+                partition by toYYYYMM(finish_date)\n+                order by (finish_date, finish_time_us, trace_id)\n+  database: system\n+  table: opentelemetry_span_log\n+  flush_interval_milliseconds: 7500\n+crash_log:\n+  database: system\n+  table: crash_log\n+  partition_by: ''\n+  flush_interval_milliseconds: 1000\n+top_level_domains_lists: ''\n+dictionaries_config: '*_dictionary.xml'\n+distributed_ddl:\n+  path: /clickhouse/task_queue/ddl\n+graphite_rollup_example:\n+  pattern:\n+    regexp: click_cost\n+    function: any\n+    retention:\n+      - age: 0\n+        precision: 3600\n+      - age: 86400\n+        precision: 60\n+  default:\n+    function: max\n+    retention:\n+      - age: 0\n+        precision: 60\n+      - age: 3600\n+        precision: 300\n+      - age: 86400\n+        precision: 3600\n+format_schema_path: /var/lib/clickhouse/format_schemas/\n+query_masking_rules:\n+  rule:\n+    name: hide encrypt/decrypt arguments\n+    regexp: '((?:aes_)?(?:encrypt|decrypt)(?:_mysql)?)\\s*\\(\\s*(?:''(?:\\\\''|.)+''|.*?)\\s*\\)'\n+    replace: \\1(???)\n+send_crash_reports:\n+  enabled: false\n+  anonymize: false\n+  endpoint: 'https://6f33034cfe684dd7a3ab9875e57b1c8d@o388870.ingest.sentry.io/5226277'\n+\ndiff --git a/tests/integration/test_config_yaml_main/configs/embedded.xml b/tests/integration/test_config_yaml_main/configs/embedded.xml\nnew file mode 100644\nindex 000000000000..a66f57d1eb70\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/embedded.xml\n@@ -0,0 +1,40 @@\n+<?xml version=\"1.0\"?>\n+<!-- Config that is used when server is run without config file. -->\n+<yandex>\n+    <logger>\n+        <level>trace</level>\n+        <console>true</console>\n+    </logger>\n+\n+    <http_port>8123</http_port>\n+    <tcp_port>9000</tcp_port>\n+    <mysql_port>9004</mysql_port>\n+\n+    <path>./</path>\n+\n+    <uncompressed_cache_size>8589934592</uncompressed_cache_size>\n+    <mark_cache_size>5368709120</mark_cache_size>\n+    <mlock_executable>true</mlock_executable>\n+\n+    <users>\n+        <default>\n+            <password></password>\n+\n+            <networks>\n+                <ip>::/0</ip>\n+            </networks>\n+\n+            <profile>default</profile>\n+            <quota>default</quota>\n+            <access_management>1</access_management>\n+        </default>\n+    </users>\n+\n+    <profiles>\n+        <default/>\n+    </profiles>\n+\n+    <quotas>\n+        <default />\n+    </quotas>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/users.d/allow_introspection_functions.xml b/tests/integration/test_config_yaml_main/configs/users.d/allow_introspection_functions.xml\nnew file mode 100644\nindex 000000000000..b94e95bc043d\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/users.d/allow_introspection_functions.xml\n@@ -0,0 +1,8 @@\n+<?xml version=\"1.0\"?>\n+<yandex>\n+    <profiles>\n+        <default>\n+            <allow_introspection_functions>1</allow_introspection_functions>\n+        </default>\n+    </profiles>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/users.d/log_queries.xml b/tests/integration/test_config_yaml_main/configs/users.d/log_queries.xml\nnew file mode 100644\nindex 000000000000..25261072ade6\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/users.d/log_queries.xml\n@@ -0,0 +1,7 @@\n+<yandex>\n+    <profiles>\n+        <default>\n+            <log_queries>1</log_queries>\n+        </default>\n+    </profiles>\n+</yandex>\ndiff --git a/tests/integration/test_config_yaml_main/configs/users.yaml b/tests/integration/test_config_yaml_main/configs/users.yaml\nnew file mode 100644\nindex 000000000000..a87a8c828191\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/configs/users.yaml\n@@ -0,0 +1,12 @@\n+profiles:\n+  default:\n+    max_memory_usage: 10000000000\n+    max_block_size: 64999\n+users:\n+  default:\n+    password: ''\n+    networks:\n+      \"@replace\": replace\n+      ip: '::/0'\n+    profile: default\n+\ndiff --git a/tests/integration/test_config_yaml_main/test.py b/tests/integration/test_config_yaml_main/test.py\nnew file mode 100644\nindex 000000000000..f4de16c35a2b\n--- /dev/null\n+++ b/tests/integration/test_config_yaml_main/test.py\n@@ -0,0 +1,43 @@\n+import time\n+import threading\n+from os import path as p, unlink\n+from tempfile import NamedTemporaryFile\n+\n+import helpers\n+import pytest\n+from helpers.cluster import ClickHouseCluster\n+\n+\n+def test_yaml_main_conf():\n+    # main configs are in YAML; config.d and users.d are in XML\n+    cluster = ClickHouseCluster(__file__, zookeeper_config_path='configs/config.d/zookeeper.xml')\n+\n+    all_confd = ['configs/config.d/0_common_instance_config.yaml',\n+                'configs/config.d/access_control.xml',\n+                'configs/config.d/keeper_port.xml',\n+                'configs/config.d/logging_no_rotate.xml',\n+                'configs/config.d/log_to_console.xml',\n+                'configs/config.d/macros.xml',\n+                'configs/config.d/metric_log.xml',\n+                'configs/config.d/more_clusters.xml',\n+                'configs/config.d/part_log.xml',\n+                'configs/config.d/path.xml',\n+                'configs/config.d/query_masking_rules.xml',\n+                'configs/config.d/tcp_with_proxy.xml',\n+                'configs/config.d/test_cluster_with_incorrect_pw.xml',\n+                'configs/config.d/text_log.xml',\n+                'configs/config.d/zookeeper.xml']\n+\n+    all_userd = ['configs/users.d/allow_introspection_functions.xml',\n+                'configs/users.d/log_queries.xml']\n+\n+    node = cluster.add_instance('node', base_config_dir='configs', main_configs=all_confd, user_configs=all_userd,\n+    with_zookeeper=False, main_config_name=\"config.yaml\", users_config_name=\"users.yaml\", copy_common_configs=False)\n+\n+    try:\n+        cluster.start()\n+        assert(node.query(\"select value from system.settings where name = 'max_memory_usage'\") == \"10000000000\\n\")\n+        assert(node.query(\"select value from system.settings where name = 'max_block_size'\") == \"64999\\n\")\n+\n+    finally:\n+        cluster.shutdown()\n",
  "problem_statement": "Add a way to configure ClickHouse through YAML \nAs was discussed on meet-up at 2018.11.15 it would be great to manage configs with not only XML but also with YAML (and json as a [proper subset of YAML](http://yaml.org/spec/1.2/spec.html#id2759572))\r\n\r\nThe problem here is that no one of salt, ansible or puppet could serialize data from objects to XML and force to make strange templates like [this](https://github.com/icann-dns/puppet-clickhouse/blob/master/templates/etc/config.xml.erb) or (*see internal saltstack jinja2 templates). And with json or YAML, there are out of the box ways to generate configs.\r\n\r\nSo, basically, for saltstack with pillar structure:\r\n```\r\nclickhouse:\r\n  shards:\r\n    cluster_configs:\r\n    - cluster: cluster1\r\n      shard_user: user1\r\n      nodes:\r\n        1:\r\n          - example01\r\n          - example02\r\n        2:\r\n          - example03\r\n          - example04\r\n        3:\r\n          - example05\r\n          - example06\r\n    - cluster: cluster2\r\n      shard_user: user2\r\n      nodes:\r\n        1:\r\n          - example01\r\n          - example02\r\n          - example03\r\n        2:\r\n          - example04\r\n          - example05\r\n          - example06\r\n```\r\nI have to create jinja template:\r\n```\r\n<yandex>\r\n{% if pillar['clickhouse'] is defined -%}\r\n{% if pillar['clickhouse']['shards'] is defined -%}\r\n\t<remote_servers>\r\n{%- for cluster_config in pillar['clickhouse']['shards']['cluster_configs'] %}\r\n\t\t<{{cluster_config['cluster']}}>\r\n{%- for shard in cluster_config['nodes'] %}\r\n\t\t\t<shard>\r\n\t\t\t\t<internal_replication>true</internal_replication>\r\n{%- for replica in cluster_config['nodes'][shard] %}\r\n\t\t\t\t<replica>\r\n\t\t\t\t\t<host>{{ replica }}</host>\r\n\t\t\t\t\t<port>9000</port>\r\n\t\t\t\t\t<user>{{cluster_config['shard_user']}}</user>\r\n\t\t\t\t</replica>\r\n{%- endfor %}\r\n\t\t\t</shard>\r\n{%- endfor %}\r\n\t\t</{{cluster_config['cluster']}}>\r\n{%- endfor %}\r\n\t</remote_servers>\r\n{%- endif %}\r\n{%- endif %}\r\n</yandex>\r\n```\r\nAnd instead of it it would be pillar (first iteration):\r\n```\r\nclickhouse:\r\n  clusters:\r\n    yandex:\r\n      remote_servers:\r\n        cluster1:\r\n          shard:\r\n          - internal_replication: true\r\n            replica:\r\n            - host: example01\r\n              port: 9000\r\n              user: user1\r\n            - host: example02\r\n              port: 9000\r\n              user: user1\r\n          - internal_replication: true\r\n            replica:\r\n            - host: example03\r\n              port: 9000\r\n              user: user1\r\n            - host: example04\r\n              port: 9000\r\n              user: user1\r\n          - internal_replication: true\r\n            replica:\r\n            - host: example05\r\n              port: 9000\r\n              user: user1\r\n            - host: example06\r\n              port: 9000\r\n              user: user1\r\n        cluster2:\r\n          shard:\r\n          - internal_replication: true\r\n            replica:\r\n            - host: example01\r\n              port: 9000\r\n              user: user1\r\n            - host: example02\r\n              port: 9000\r\n              user: user1\r\n            - host: example03\r\n              port: 9000\r\n              user: user1\r\n          - internal_replication: true\r\n            replica:\r\n            - host: example04\r\n              port: 9000\r\n              user: user1\r\n            - host: example05\r\n              port: 9000\r\n              user: user1\r\n            - host: example06\r\n              port: 9000\r\n              user: user1\r\n```\r\nand in shards.yaml just:\r\n```\r\n{% if pillar['clickhouse'] is defined -%}\r\n{% if pillar['clickhouse']['clusters'] is defined -%}\r\n{{ pillar['clikhouse']['clusters']|yaml }}\r\n{%- endif %}\r\n{%- endif %}\r\n```\n",
  "hints_text": "YAML would be nice.  But actually configuration management in ClickHouse is quite flexible and mature. It's not really obvious sometimes and sometimes you need to find proper 'ClickHouse-way' to solve the problems, but it's doable with XMLs.\r\n\r\nClickHouse has quite a lot of options and it's quite hard (and usually there is no need) to map all of them into some objects. It's better to have all servers in cluster pretty the same, and the only thing you need to adjust per server - is macroses, may be interserver host name.\r\n\r\nMy own summary of 'best practices' for ClickHouse configs:\r\n\r\n1. don't edit/overwrite default configuration files, sometimes newer version introduces some new settings or change the defaults and you can miss that if you will used fixed config.xml and users.xml. \r\n\r\n2. instead of that it's quite easy to do any modification of configurations via extra files in conf.d directory, for example, if you want to overwrite interface put a file `conf.d/listen.xml`, like that: \r\n```xml\r\n<?xml version=\"1.0\"?>\r\n<yandex>\r\n    <listen_host replace=\"replace\">::</listen_host>\r\n</yandex>\r\n```\r\n3. same for users: you can for example change default profile by putting file `users.d/profile_default.xml`\r\n```xml\r\n<?xml version=\"1.0\"?>\r\n<yandex>\r\n    <profiles>\r\n        <default replace=\"replace\">\r\n            <max_memory_usage>15000000000</max_memory_usage>\r\n            <max_bytes_before_external_group_by>12000000000</max_bytes_before_external_group_by>\r\n            <max_bytes_before_external_sort>12000000000</max_bytes_before_external_sort>\r\n            <distributed_aggregation_memory_efficient>1</distributed_aggregation_memory_efficient>\r\n            <use_uncompressed_cache>0</use_uncompressed_cache>\r\n            <load_balancing>random</load_balancing>\r\n            <log_queries>1</log_queries>\r\n            <max_execution_time>600</max_execution_time>\r\n        </default>\r\n    </profiles>\r\n</yandex>\r\n```\r\n4. or you can create a user by putting a file `users.d/user_xxx.xml`\r\n```xml\r\n<?xml version=\"1.0\"?>\r\n<yandex>\r\n    <users>\r\n        <xxx>\r\n            <!-- PASSWORD=$(base64 < /dev/urandom | head -c8); echo \"$PASSWORD\"; echo -n \"$PASSWORD\" | sha256sum | tr -d '-' -->\r\n            <password_sha256_hex>...</password_sha256_hex>\r\n            <networks incl=\"networks\" />\r\n            <profile>readonly</profile>\r\n            <quota>default</quota>\r\n            <allow_databases incl=\"allowed_databases\" />\r\n        </xxx>\r\n    </users>\r\n</yandex>\r\n```\r\n5. some parts of configuratuion will contain repeated elements (like allowed ips for all the users). To avoid repeating that - use **substitutions file**. By default its `/etc/metrika.xml`, but you can change it for example to `/etc/clickhouse-server/substitutions.xml` (<include_from> section of main config). Put that repeated parts into substitutions file, like that \r\n```xml\r\n<?xml version=\"1.0\"?>\r\n<yandex>\r\n    <networks>\r\n        <ip>::1</ip>\r\n        <ip>127.0.0.1</ip>\r\n        <ip>10.42.0.0/16</ip>\r\n        <ip>192.168.0.0/24</ip>\r\n    </networks>\r\n\r\n   <clickhouse_remote_servers>\r\n<!-- cluster definition -->\r\n    </clickhouse_remote_servers>\r\n\r\n    <zookeeper-servers>\r\n        <node>\r\n            <host>zookeeper1</host>\r\n            <port>2181</port>\r\n        </node>\r\n        <node>\r\n            <host>zookeeper2</host>\r\n            <port>2181</port>\r\n        </node>\r\n        <node>\r\n            <host>zookeeper3</host>\r\n            <port>2181</port>\r\n        </node>\r\n    </zookeeper-servers>\r\n\r\n    <clickhouse_compression></clickhouse_compression>\r\n</yandex>\r\n```\r\nthat file can be common for all the servers inside the cluster / datacenter or individual per server, that is the only part (ideally) that should be generated/controlled by puppet / chef. If you will go to use one substitutions file per cluster (not per node) you will also need to generate file with macros (if you use macroses).\r\n\r\nIn that way you have full flexibility (you're not limited to the settings described in template), you can change any settings per server / datacenter just by assigning file with some settings to that server / server group. It's really easy to navigate throuth / edit / assign those files.\r\n\r\n\nI know how to do it properly. And did use everything which you suggested. This would be a good advise, BTW, but the problem definitely in XML by itself. As was described, you have to write ugly templates to generate them instead of just objects serializing like https://docs.saltstack.com/en/latest/ref/renderers/all/salt.renderers.jinja.html or https://gist.github.com/WhatsARanjit/12bdcce78ef07641a2a7c6d37d4b369d\n> I know how to do it properly. And did use everything which you suggested. This would be a good advise, BTW, but the problem definitely in XML by itself.\r\n\r\nI wasn't aware of your background, quite often newbies want to change something just because they don't know yet how to use the stuff which already exists. So @Felixoid, sorry and you can read only the first sentence of my previous answer :) \nhttps://github.com/pocoproject/poco/issues/1308\nWe do such thing with saltstack formula. [check out](https://github.com/sergiustheblack/clickhouse-saltstack-formula).\r\nDefinitely not what you are asking for, but... It just generates xml config from yaml pillar. \nThank you, but it looks still more or less the same to me.\r\n\r\nWe use puppet though, and it looks more native. Here's an example https://github.com/innogames/puppet-clickhouse/blob/master/manifests/server/config.pp#L18\nAt this moment I've already written the tests for YAML configs and fixed most bugs in the code. I think, after solving all problems found during last code review, new feature will be ready to use.",
  "created_at": "2021-03-18T11:18:43Z",
  "modified_files": [
    ".gitmodules",
    "CMakeLists.txt",
    "base/bridge/CMakeLists.txt",
    "b/cmake/find/yaml-cpp.cmake",
    "contrib/CMakeLists.txt",
    "b/contrib/yaml-cpp",
    "b/contrib/yaml-cpp-cmake/CMakeLists.txt",
    "b/programs/server/config-example.yaml.disabled",
    "src/Common/Config/CMakeLists.txt",
    "src/Common/Config/ConfigProcessor.cpp",
    "src/Common/Config/ConfigProcessor.h",
    "b/src/Common/Config/YAMLParser.cpp",
    "b/src/Common/Config/YAMLParser.h",
    "src/Common/ErrorCodes.cpp",
    "src/Common/config.h.in"
  ],
  "modified_test_files": [
    "tests/integration/helpers/cluster.py",
    "tests/integration/runner",
    "b/tests/integration/test_config_xml_full/configs/config.d/access_control.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/keeper_port.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/log_to_console.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/logging_no_rotate.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/macros.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/metric_log.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/more_clusters.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/part_log.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/path.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/query_masking_rules.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/tcp_with_proxy.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/text_log.xml",
    "b/tests/integration/test_config_xml_full/configs/config.d/zookeeper.xml",
    "b/tests/integration/test_config_xml_full/configs/config.xml",
    "b/tests/integration/test_config_xml_full/configs/embedded.xml",
    "b/tests/integration/test_config_xml_full/configs/users.d/allow_introspection_functions.xml",
    "b/tests/integration/test_config_xml_full/configs/users.d/log_queries.xml",
    "b/tests/integration/test_config_xml_full/configs/users.xml",
    "b/tests/integration/test_config_xml_full/test.py",
    "b/tests/integration/test_config_xml_main/configs/config.d/access_control.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/keeper_port.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/log_to_console.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/logging_no_rotate.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/macros.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/metric_log.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/more_clusters.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/part_log.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/path.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/query_masking_rules.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/tcp_with_proxy.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/test_cluster_with_incorrect_pw.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/text_log.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.d/zookeeper.yaml",
    "b/tests/integration/test_config_xml_main/configs/config.xml",
    "b/tests/integration/test_config_xml_main/configs/embedded.xml",
    "b/tests/integration/test_config_xml_main/configs/users.d/allow_introspection_functions.yaml",
    "b/tests/integration/test_config_xml_main/configs/users.d/log_queries.yaml",
    "b/tests/integration/test_config_xml_main/configs/users.xml",
    "b/tests/integration/test_config_xml_main/test.py",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/0_common_instance_config.yaml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/access_control.yaml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/keeper_port.xml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/log_to_console.yaml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/logging_no_rotate.xml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/macros.yaml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/metric_log.xml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/more_clusters.yaml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/part_log.xml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/path.yaml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/query_masking_rules.xml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/tcp_with_proxy.yaml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/test_cluster_with_incorrect_pw.xml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/text_log.yaml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.d/zookeeper.xml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/config.xml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/embedded.xml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/users.d/allow_introspection_functions.xml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/users.d/log_queries.yaml",
    "b/tests/integration/test_config_xml_yaml_mix/configs/users.yaml",
    "b/tests/integration/test_config_xml_yaml_mix/test.py",
    "b/tests/integration/test_config_yaml_full/configs/config.d/0_common_instance_config.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/access_control.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/keeper_port.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/log_to_console.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/logging_no_rotate.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/macros.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/metric_log.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/more_clusters.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/part_log.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/path.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/query_masking_rules.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/tcp_with_proxy.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/test_cluster_with_incorrect_pw.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/text_log.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.d/zookeeper.yaml",
    "b/tests/integration/test_config_yaml_full/configs/config.yaml",
    "b/tests/integration/test_config_yaml_full/configs/embedded.xml",
    "b/tests/integration/test_config_yaml_full/configs/users.d/allow_introspection_functions.yaml",
    "b/tests/integration/test_config_yaml_full/configs/users.d/log_queries.yaml",
    "b/tests/integration/test_config_yaml_full/configs/users.yaml",
    "b/tests/integration/test_config_yaml_full/test.py",
    "b/tests/integration/test_config_yaml_main/configs/config.d/0_common_instance_config.yaml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/access_control.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/keeper_port.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/log_to_console.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/logging_no_rotate.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/macros.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/metric_log.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/more_clusters.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/part_log.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/path.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/query_masking_rules.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/tcp_with_proxy.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/test_cluster_with_incorrect_pw.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/text_log.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.d/zookeeper.xml",
    "b/tests/integration/test_config_yaml_main/configs/config.yaml",
    "b/tests/integration/test_config_yaml_main/configs/embedded.xml",
    "b/tests/integration/test_config_yaml_main/configs/users.d/allow_introspection_functions.xml",
    "b/tests/integration/test_config_yaml_main/configs/users.d/log_queries.xml",
    "b/tests/integration/test_config_yaml_main/configs/users.yaml",
    "b/tests/integration/test_config_yaml_main/test.py"
  ]
}