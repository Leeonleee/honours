diff --git a/tests/queries/0_stateless/01380_nullable_state.reference b/tests/queries/0_stateless/01380_nullable_state.reference
new file mode 100644
index 000000000000..f87ff0a3f1f4
--- /dev/null
+++ b/tests/queries/0_stateless/01380_nullable_state.reference
@@ -0,0 +1,64 @@
+0100012CCBC234
+
+0100012CCBC234
+---
+0100012CCBC234
+
+0100012CCBC234
+---
+0100012CCBC234
+
+0100012CCBC234
+---
+0100012CCBC234
+
+0100012CCBC234
+---
+0100012CCBC234
+
+0100012CCBC234
+---
+0100012CCBC234
+
+0100012CCBC234
+---
+1
+
+1
+---
+0	1
+1	1
+2	1
+3	1
+4	1
+
+0	1
+---
+0	1
+1	1
+2	1
+3	1
+4	1
+
+0	1
+---
+0	[0]
+1	[0]
+2	[0]
+3	[0]
+4	[0]
+
+0	[0]
+---
+0	[0]
+1	[0]
+2	[0]
+3	[0]
+4	[0]
+
+\N	[0]
+---
+0100012CCBC234
+---
+0100012CCBC234
+---
diff --git a/tests/queries/0_stateless/01380_nullable_state.sql b/tests/queries/0_stateless/01380_nullable_state.sql
new file mode 100644
index 000000000000..6841a6ce6368
--- /dev/null
+++ b/tests/queries/0_stateless/01380_nullable_state.sql
@@ -0,0 +1,26 @@
+SELECT hex(toString(uniqState(toNullable(1)))) WITH TOTALS;
+SELECT '---';
+SELECT hex(toString(uniqState(x))) FROM (SELECT toNullable(1) AS x) WITH TOTALS;
+SELECT '---';
+SELECT DISTINCT hex(toString(uniqState(x))) FROM (SELECT materialize(1) AS k, toNullable(1) AS x FROM numbers(1)) GROUP BY k WITH TOTALS ORDER BY k;
+SELECT '---';
+SELECT DISTINCT hex(toString(uniqState(x))) FROM (SELECT materialize(1) AS k, toNullable(1) AS x FROM numbers(10)) GROUP BY k WITH TOTALS ORDER BY k;
+SELECT '---';
+SELECT DISTINCT hex(toString(uniqState(x))) FROM (SELECT intDiv(number, 3) AS k, toNullable(1) AS x FROM numbers(10)) GROUP BY k WITH TOTALS ORDER BY k;
+SELECT '---';
+SELECT DISTINCT hex(toString(uniqState(x))) FROM (SELECT intDiv(number, 3) AS k, toNullable(1) AS x FROM system.numbers LIMIT 100000) GROUP BY k WITH TOTALS ORDER BY k;
+SELECT '---';
+SELECT DISTINCT arrayUniq(finalizeAggregation(groupArrayState(x))) FROM (SELECT intDiv(number, 3) AS k, toNullable(1) AS x FROM system.numbers LIMIT 100000) GROUP BY k WITH TOTALS ORDER BY k;
+SELECT '---';
+SELECT k, finalizeAggregation(uniqState(x)) FROM (SELECT intDiv(number, 3) AS k, toNullable(1) AS x FROM system.numbers LIMIT 100000) GROUP BY k WITH TOTALS ORDER BY k LIMIT 5;
+SELECT '---';
+SELECT k, finalizeAggregation(uniqState(x)) FROM (WITH toNullable(number = 3 ? 3 : 1) AS d SELECT intDiv(number, 3) AS k, number % d AS x FROM system.numbers LIMIT 100000) GROUP BY k WITH TOTALS ORDER BY k LIMIT 5;
+SELECT '---';
+SELECT k, finalizeAggregation(quantilesTimingState(0.5)(x)) FROM (WITH toNullable(number = 3 ? 3 : 1) AS d SELECT intDiv(number, 3) AS k, number % d AS x FROM system.numbers LIMIT 100000) GROUP BY k WITH TOTALS ORDER BY k LIMIT 5;
+SELECT '---';
+SELECT k, finalizeAggregation(quantilesTimingState(0.5)(x)) FROM (SELECT intDiv(number, if(number = 9223372036854775807, -2, if(number = 3, number = if(number = 1, NULL, 3), 1)) AS d) AS k, number % d AS x FROM system.numbers LIMIT 100000) GROUP BY k WITH TOTALS ORDER BY k ASC LIMIT 5;
+SELECT '---';
+SELECT DISTINCT hex(toString(uniqState(x))) FROM (SELECT materialize(1) AS k, toNullable(1) AS x FROM numbers(1)) GROUP BY k WITH ROLLUP ORDER BY k;
+SELECT '---';
+SELECT DISTINCT hex(toString(uniqState(x))) FROM (SELECT materialize(1) AS k, toNullable(1) AS x FROM numbers(1)) GROUP BY k WITH CUBE ORDER BY k;
+SELECT '---';
diff --git a/tests/queries/0_stateless/01381_for_each_with_states.reference b/tests/queries/0_stateless/01381_for_each_with_states.reference
new file mode 100644
index 000000000000..3d1732f9d5da
--- /dev/null
+++ b/tests/queries/0_stateless/01381_for_each_with_states.reference
@@ -0,0 +1,16 @@
+5B27015C30012CCBC234272C27015C305C30275D
+02000000000000000100012CCBC234010000
+['0100012CCBC234','010000']
+[1,0]
+5B27015C30012CCBC234272C27015C305C30275D
+
+5B27015C30012CCBC234272C27015C305C30275D
+02000000000000000100012CCBC234010000
+
+02000000000000000100012CCBC234010000
+['0100012CCBC234','010000']
+
+['0100012CCBC234','010000']
+[1,0]
+
+[1,0]
diff --git a/tests/queries/0_stateless/01381_for_each_with_states.sql b/tests/queries/0_stateless/01381_for_each_with_states.sql
new file mode 100644
index 000000000000..7286ef2cb27e
--- /dev/null
+++ b/tests/queries/0_stateless/01381_for_each_with_states.sql
@@ -0,0 +1,9 @@
+SELECT hex(toString(uniqStateForEach([1, NULL])));
+SELECT hex(toString(uniqStateForEachState([1, NULL])));
+SELECT arrayMap(x -> hex(toString(x)), finalizeAggregation(uniqStateForEachState([1, NULL])));
+SELECT arrayMap(x -> finalizeAggregation(x), finalizeAggregation(uniqStateForEachState([1, NULL])));
+
+SELECT hex(toString(uniqStateForEach([1, NULL]))) WITH TOTALS;
+SELECT hex(toString(uniqStateForEachState([1, NULL]))) WITH TOTALS;
+SELECT arrayMap(x -> hex(toString(x)), finalizeAggregation(uniqStateForEachState([1, NULL]))) WITH TOTALS;
+SELECT arrayMap(x -> finalizeAggregation(x), finalizeAggregation(uniqStateForEachState([1, NULL]))) WITH TOTALS;
