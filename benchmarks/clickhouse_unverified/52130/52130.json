{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 52130,
  "instance_id": "ClickHouse__ClickHouse-52130",
  "issue_numbers": [
    "42138"
  ],
  "base_commit": "2ad7d121ae78df94132076a3673de2e2bd074f5c",
  "patch": "diff --git a/src/IO/ReadHelpers.h b/src/IO/ReadHelpers.h\nindex b8ce162ec91a..2636898c1b3c 100644\n--- a/src/IO/ReadHelpers.h\n+++ b/src/IO/ReadHelpers.h\n@@ -1005,8 +1005,8 @@ inline ReturnType readDateTimeTextImpl(DateTime64 & datetime64, UInt32 scale, Re\n             }\n         }\n     }\n-    /// 9908870400 is time_t value for 2184-01-01 UTC (a bit over the last year supported by DateTime64)\n-    else if (whole >= 9908870400LL)\n+    /// 10413792000 is time_t value for 2300-01-01 UTC (a bit over the last year supported by DateTime64)\n+    else if (whole >= 10413792000LL)\n     {\n         /// Unix timestamp with subsecond precision, already scaled to integer.\n         /// For disambiguation we support only time since 2001-09-09 01:46:40 UTC and less than 30 000 years in future.\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01802_toDateTime64_large_values.reference b/tests/queries/0_stateless/01802_toDateTime64_large_values.reference\nindex e60b1c303141..f3810cc3d4b0 100644\n--- a/tests/queries/0_stateless/01802_toDateTime64_large_values.reference\n+++ b/tests/queries/0_stateless/01802_toDateTime64_large_values.reference\n@@ -8,3 +8,7 @@ SELECT toDateTime64('2205-12-12 12:12:12', 6, 'Asia/Istanbul');\n 2205-12-12 12:12:12.000000\n SELECT toDateTime64('2205-12-12 12:12:12', 6, 'Asia/Istanbul');\n 2205-12-12 12:12:12.000000\n+SELECT toDateTime64('2299-12-31 23:59:59', 3, 'UTC');\n+2299-12-31 23:59:59.000\n+SELECT toDateTime64('2299-12-31 23:59:59', 3, 'UTC');\n+2299-12-31 23:59:59.000\ndiff --git a/tests/queries/0_stateless/01802_toDateTime64_large_values.sql b/tests/queries/0_stateless/01802_toDateTime64_large_values.sql\nindex d82d4433b2d6..5c2e65188c3e 100644\n--- a/tests/queries/0_stateless/01802_toDateTime64_large_values.sql\n+++ b/tests/queries/0_stateless/01802_toDateTime64_large_values.sql\n@@ -4,4 +4,7 @@ SELECT toDateTime64('2205-12-12 12:12:12', 0, 'UTC');\n SELECT toDateTime64('2205-12-12 12:12:12', 0, 'Asia/Istanbul');\n \n SELECT toDateTime64('2205-12-12 12:12:12', 6, 'Asia/Istanbul');\n-SELECT toDateTime64('2205-12-12 12:12:12', 6, 'Asia/Istanbul');\n\\ No newline at end of file\n+SELECT toDateTime64('2205-12-12 12:12:12', 6, 'Asia/Istanbul');\n+\n+SELECT toDateTime64('2299-12-31 23:59:59', 3, 'UTC');\n+SELECT toDateTime64('2299-12-31 23:59:59', 3, 'UTC');\n\\ No newline at end of file\n",
  "problem_statement": "toDateTime64 unexpected behaviour for dates around 2299-01-01\n```sql\r\nSELECT\r\n    toDate32('2299-01-01') AS x,\r\n    toDateTime64(x, 3),\r\n    toDateTime64('2299-01-01 00:00:00', 0);\r\n\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500x\u2500\u252c\u2500toDateTime64(toDate32('2299-01-01'), 3)\u2500\u252c\u2500toDateTime64('2299-01-01 00:00:00', 0)\u2500\u2510\r\n\u2502 2299-01-01 \u2502                 2299-01-01 00:00:00.000 \u2502                    2299-01-01 00:00:00 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\nOK.\r\n\r\n\r\nSELECT\r\n    toDateTime64('2299-01-01 00:00:00', 0) AS _0,\r\n    toDateTime64('2299-01-01 00:00:00', 1) AS _1,\r\n    toDateTime64('2299-01-01 00:00:00', 2) AS _2,\r\n    toDateTime64('2299-01-01 00:00:00', 3) AS _3;\r\n\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_0\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_1\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_2\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_3\u2500\u2510\r\n\u2502 2299-01-01 00:00:00 \u2502 2002-11-25 12:00:00.0 \u2502 1973-04-16 15:36:00.00 \u2502 1970-05-01 03:57:36.000 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\nNot OK.\r\n```\r\n\r\n@rvasin\n",
  "hints_text": "Denis, thank you for noticing it. I will take a look on it in debugger later on Today.\nhttps://github.com/ClickHouse/ClickHouse/issues/39249  https://github.com/ClickHouse/ClickHouse/issues/39248 ?\r\n\nhm, it's a minor issue, I've missed that strings does not have fractions.\r\n\r\n```\r\nSELECT\r\n    toDateTime64('2299-01-01 00:00:00', 0) AS _0,\r\n    toDateTime64('2299-01-01 00:00:00.0', 1) AS _1,\r\n    toDateTime64('2299-01-01 00:00:00.00', 2) AS _2,\r\n    toDateTime64('2299-01-01 00:00:00.000', 3) AS _3\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_0\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_1\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_2\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_3\u2500\u2510\r\n\u2502 2299-01-01 00:00:00 \u2502 2299-01-01 00:00:00.0 \u2502 2299-01-01 00:00:00.00 \u2502 2299-01-01 00:00:00.000 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\nSELECT\r\n    toDateTime64('2000-01-01 00:00:00', 0) AS _0,\r\n    toDateTime64('2000-01-01 00:00:00', 1) AS _1,\r\n    toDateTime64('2000-01-01 00:00:00', 2) AS _2,\r\n    toDateTime64('2000-01-01 00:00:00', 3) AS _3\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_0\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_1\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_2\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500_3\u2500\u2510\r\n\u2502 2000-01-01 00:00:00 \u2502 2000-01-01 00:00:00.0 \u2502 2000-01-01 00:00:00.00 \u2502 2000-01-01 00:00:00.000 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518",
  "created_at": "2023-07-15T01:12:51Z",
  "modified_files": [
    "src/IO/ReadHelpers.h"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/01802_toDateTime64_large_values.reference",
    "tests/queries/0_stateless/01802_toDateTime64_large_values.sql"
  ]
}