{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 72902,
  "instance_id": "ClickHouse__ClickHouse-72902",
  "issue_numbers": [
    "72756"
  ],
  "base_commit": "95b9dc065b895f3b17e9f7c122789ae99ed9bf06",
  "patch": "diff --git a/src/Core/SettingsChangesHistory.cpp b/src/Core/SettingsChangesHistory.cpp\nindex 2e350afb387b..97353d03c347 100644\n--- a/src/Core/SettingsChangesHistory.cpp\n+++ b/src/Core/SettingsChangesHistory.cpp\n@@ -98,7 +98,7 @@ static std::initializer_list<std::pair<ClickHouseVersion, SettingsChangesHistory\n             {\"read_in_order_use_virtual_row\", false, false, \"Use virtual row while reading in order of primary key or its monotonic function fashion. It is useful when searching over multiple parts as only relevant ones are touched.\"},\n             {\"s3_skip_empty_files\", false, true, \"We hope it will provide better UX\"},\n             {\"filesystem_cache_boundary_alignment\", 0, 0, \"New setting\"},\n-            {\"push_external_roles_in_interserver_queries\", false, false, \"New setting.\"},\n+            {\"push_external_roles_in_interserver_queries\", false, true, \"New setting.\"},\n             {\"enable_variant_type\", false, false, \"Add alias to allow_experimental_variant_type\"},\n             {\"enable_dynamic_type\", false, false, \"Add alias to allow_experimental_dynamic_type\"},\n             {\"enable_json_type\", false, false, \"Add alias to allow_experimental_json_type\"},\ndiff --git a/src/QueryPipeline/RemoteQueryExecutor.cpp b/src/QueryPipeline/RemoteQueryExecutor.cpp\nindex 41ab87e1a18b..851b31165712 100644\n--- a/src/QueryPipeline/RemoteQueryExecutor.cpp\n+++ b/src/QueryPipeline/RemoteQueryExecutor.cpp\n@@ -407,7 +407,7 @@ void RemoteQueryExecutor::sendQueryUnlocked(ClientInfo::QueryKind query_kind, As\n     std::vector<String> local_granted_roles;\n     if (context->getSettingsRef()[Setting::push_external_roles_in_interserver_queries] && !modified_client_info.initial_user.empty())\n     {\n-        auto user = context->getAccessControl().read<User>(modified_client_info.initial_user, true);\n+        auto user = context->getAccessControl().read<User>(modified_client_info.initial_user, false);\n         boost::container::flat_set<String> granted_roles;\n         if (user)\n         {\n",
  "test_patch": "diff --git a/tests/integration/test_ldap_external_user_directory/test.py b/tests/integration/test_ldap_external_user_directory/test.py\nindex ce16d7ad2862..e7884b8ae3fb 100644\n--- a/tests/integration/test_ldap_external_user_directory/test.py\n+++ b/tests/integration/test_ldap_external_user_directory/test.py\n@@ -183,3 +183,24 @@ def test_push_role_to_other_nodes(ldap_cluster):\n     instance2.query(\"DROP ROLE IF EXISTS role_read\")\n \n     delete_ldap_group(ldap_cluster, group_cn=\"clickhouse-role_read\")\n+\n+\n+def test_remote_query_user_does_not_exist_locally(ldap_cluster):\n+    \"\"\"\n+    Check that even if user does not exist locally, using it to execute remote queries is still possible\n+    \"\"\"\n+    instance2.query(\"DROP USER IF EXISTS non_local\")\n+    instance2.query(\"DROP TABLE IF EXISTS test_table sync\")\n+\n+    instance2.query(\"CREATE USER non_local\")\n+    instance2.query(\"CREATE TABLE test_table (id Int16) ENGINE=Memory\")\n+    instance2.query(\"INSERT INTO test_table VALUES (123)\")\n+    instance2.query(\"GRANT SELECT ON default.test_table TO non_local\")\n+\n+    result = instance1.query(\n+        \"SELECT * FROM remote('instance2', 'default.test_table', 'non_local')\"\n+    )\n+    assert result.strip() == \"123\"\n+\n+    instance2.query(\"DROP USER IF EXISTS non_local\")\n+    instance2.query(\"DROP TABLE IF EXISTS test_table SYNC\")\n",
  "problem_statement": "secureRemote: There is no user `demo` in user directories: While executing Remote.\nIf I try this query on at least `ClickHouse local version 24.11.1.2557` until the current version, I get this error:\r\n\r\n```\r\nSELECT *\r\nFROM remoteSecure('sql-clickhouse.clickhouse.com', 'uk.uk_price_paid', 'demo')\r\nLIMIT 10\r\n```\r\n\r\n```\r\nReceived exception from server (version 24.12.1):\r\nCode: 192. DB::Exception: Received from localhost:9000. DB::Exception: There is no user `demo` in user directories: While executing Remote. (UNKNOWN_USER)\r\n```\r\n\r\nIt works on `ClickHouse client version 24.11.1.1113 (official build).`\n",
  "hints_text": "this works on 24.11.1.1113\r\n\r\n```sql\r\nClickHouse client version 24.11.1.1113 (official build).\r\nConnecting to localhost:9000 as user default.\r\nConnected to ClickHouse server version 24.11.1.\r\n\r\nWarnings:\r\n * Delay accounting is not enabled, OSIOWaitMicroseconds will not be gathered. You can enable it using `echo 1 > /proc/sys/kernel/task_delayacct` or by using sysctl.\r\n\r\nplay-eu-clickhouse-client.localdomain :) SELECT *\r\nFROM remoteSecure('sql-clickhouse.clickhouse.com', 'uk.uk_price_paid', 'demo')\r\nLIMIT 10\r\n\r\nSELECT *\r\nFROM remoteSecure('sql-clickhouse.clickhouse.com', 'uk.uk_price_paid', 'demo')\r\nLIMIT 10\r\n\r\nQuery id: 46d9d3b3-24c8-4fd3-8343-29e42a42c87c\r\n\r\n    \u250c\u2500\u2500price\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500date\u2500\u252c\u2500postcode1\u2500\u252c\u2500postcode2\u2500\u252c\u2500type\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500is_new\u2500\u252c\u2500duration\u2500\u2500\u252c\u2500addr1\u2500\u252c\u2500addr2\u2500\u2500\u252c\u2500street\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500locality\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500town\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500district\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500county\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500category\u2500\u2510\r\n 1. \u2502 145000 \u2502 2008-11-19 \u2502           \u2502           \u2502 semi-detached \u2502      0 \u2502 leasehold \u2502       \u2502        \u2502 CURLEW DRIVE       \u2502 SCARBOROUGH   \u2502 SCARBOROUGH      \u2502 SCARBOROUGH         \u2502 NORTH YORKSHIRE \u2502        0 \u2502\r\n 2. \u2502   5000 \u2502 2020-06-28 \u2502           \u2502           \u2502 other         \u2502      1 \u2502 freehold  \u2502 -     \u2502 PLOT 8 \u2502 CHURCH FARM MEADOW \u2502               \u2502 BUNTINGFORD      \u2502 NORTH HERTFORDSHIRE \u2502 HERTFORDSHIRE   \u2502        1 \u2502\r\n 3. \u2502  11000 \u2502 1995-09-29 \u2502           \u2502           \u2502 terraced      \u2502      0 \u2502 freehold  \u2502 1     \u2502        \u2502 BLAKEY STREET      \u2502 BURNLEY       \u2502 BURNLEY          \u2502 BURNLEY             \u2502 LANCASHIRE      \u2502        0 \u2502\r\n 4. \u2502  15000 \u2502 1995-08-16 \u2502           \u2502           \u2502 semi-detached \u2502      0 \u2502 freehold  \u2502 1     \u2502        \u2502 KINGSLAND ROAD     \u2502 BIRKENHEAD    \u2502 BIRKENHEAD       \u2502 WIRRAL              \u2502 MERSEYSIDE      \u2502        0 \u2502\r\n 5. \u2502  12500 \u2502 1995-06-23 \u2502           \u2502           \u2502 terraced      \u2502      0 \u2502 freehold  \u2502 1     \u2502        \u2502 RHOSGOCH           \u2502 CWM PENMACHNO \u2502 BETWS-Y-COED     \u2502 CONWY               \u2502 CONWY           \u2502        0 \u2502\r\n 6. \u2502  60000 \u2502 1995-01-27 \u2502           \u2502           \u2502 semi-detached \u2502      0 \u2502 freehold  \u2502 1     \u2502        \u2502 PONDSIDE COTTAGES  \u2502 GRAVELEY      \u2502 HITCHIN          \u2502 NORTH HERTFORDSHIRE \u2502 HERTFORDSHIRE   \u2502        0 \u2502\r\n 7. \u2502  54000 \u2502 1995-08-04 \u2502           \u2502           \u2502 detached      \u2502      0 \u2502 freehold  \u2502 1     \u2502        \u2502 DUKE STREET        \u2502 STANTON       \u2502 BURY ST. EDMUNDS \u2502 ST EDMUNDSBURY      \u2502 SUFFOLK         \u2502        0 \u2502\r\n 8. \u2502  70000 \u2502 1995-08-04 \u2502           \u2502           \u2502 terraced      \u2502      0 \u2502 freehold  \u2502 1     \u2502        \u2502 PARKHAM ROAD       \u2502 BRIXHAM       \u2502 BRIXHAM          \u2502 TORBAY              \u2502 TORBAY          \u2502        0 \u2502\r\n 9. \u2502  43000 \u2502 1995-04-21 \u2502           \u2502           \u2502 terraced      \u2502      0 \u2502 freehold  \u2502 1     \u2502        \u2502 ZAGGY LANE         \u2502 CALLINGTON    \u2502 CALLINGTON       \u2502 CARADON             \u2502 CORNWALL        \u2502        0 \u2502\r\n10. \u2502  31000 \u2502 1995-02-06 \u2502           \u2502           \u2502 terraced      \u2502      0 \u2502 freehold  \u2502 1     \u2502        \u2502 BEACH ROAD         \u2502 PERRANPORTH   \u2502 PERRANPORTH      \u2502 CARRICK             \u2502 CORNWALL        \u2502        0 \u2502\r\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n10 rows in set. Elapsed: 0.790 sec. Processed 8.19 thousand rows, 374.67 KB (10.38 thousand rows/s., 474.52 KB/s.)\r\nPeak memory usage: 18.21 MiB.\r\n```\n```\r\ngit bisect start '--first-parent'\r\n# status: waiting for both good and bad commits\r\n# good: [1f253c7b3af3f4a981a7fda5b34f25eb1ba6c857] Merge pull request #71341 from ClickHouse/ci_remove_old_release_script\r\ngit bisect good 1f253c7b3af3f4a981a7fda5b34f25eb1ba6c857\r\n# status: waiting for bad commit, 1 good commit known\r\n# bad: [1aceb608f3863822277fed9f34021178118e4c5b] Merge pull request #71785 from Avogar/fix-json-parsing\r\ngit bisect bad 1aceb608f3863822277fed9f34021178118e4c5b\r\n# good: [b68315e5941ca6862c78a07fa87f2c5db0e61952] Merge pull request #71820 from ClickHouse/chesema-fix-00755\r\ngit bisect good b68315e5941ca6862c78a07fa87f2c5db0e61952\r\n# skip: [fc77a01de8d204988e7164ddbc1765274e7bccac] Merge pull request #71994 from linhgiang24/patch-4\r\ngit bisect skip fc77a01de8d204988e7164ddbc1765274e7bccac\r\n# bad: [f711005eaa50de2834150723a2f5e398fc867166] Merge pull request #71976 from ClickHouse/revert-71974-revert-71081-ci_paktika_integration_4\r\ngit bisect bad f711005eaa50de2834150723a2f5e398fc867166\r\n# skip: [d61e2e1c2853a4c6f1260732a9091dbdec0f45fa] Merge pull request #72016 from petern48/fix_typo_agg_funcs_doc\r\ngit bisect skip d61e2e1c2853a4c6f1260732a9091dbdec0f45fa\r\n# skip: [1fb1bfe6f9d42c6268d2dae0ac0bbc53188f0ddb] Merge pull request #71974 from ClickHouse/revert-71081-ci_paktika_integration_4\r\ngit bisect skip 1fb1bfe6f9d42c6268d2dae0ac0bbc53188f0ddb\r\n# good: [e1901fa7395e7287a082a84f6be6a8b55f43b039] Merge pull request #71529 from ClickHouse/chesema-remove-if-exists\r\ngit bisect good e1901fa7395e7287a082a84f6be6a8b55f43b039\r\n# good: [61b3231a72a9719984e5275f61a4c0b8f97afc91] Merge pull request #71993 from rschu1ze/followup-71581\r\ngit bisect good 61b3231a72a9719984e5275f61a4c0b8f97afc91\r\n# skip: [7785a9b15e004c841a5114ccfd256fc20050afba] Merge pull request #72042 from ClickHouse/auto/v24.3.14.35-lts\r\ngit bisect skip 7785a9b15e004c841a5114ccfd256fc20050afba\r\n# good: [e27fbc79d01af82847ab7c5e13ea9254c63f1614] Merge pull request #72049 from evillique/another-highlighting-fix\r\ngit bisect good e27fbc79d01af82847ab7c5e13ea9254c63f1614\r\n# good: [353ff951aab88d0231bf12cf72f9d630f800a0e7] Merge pull request #68885 from Unalian/feat-67772\r\ngit bisect good 353ff951aab88d0231bf12cf72f9d630f800a0e7\r\n# bad: [e83d5317728c05f752497a9759600970f227572d] Merge pull request #71498 from ClickHouse/backtracks-check\r\ngit bisect bad e83d5317728c05f752497a9759600970f227572d\r\n# good: [456a41ee4249ace28e36ad65a42c320bb1fdd144] Merge pull request #71845 from aalexfvk/acquire_zero_copy_shared_lock_before_swap\r\ngit bisect good 456a41ee4249ace28e36ad65a42c320bb1fdd144\r\n# bad: [07be02d2972d9876cbebc4597d4e9b0a48c1334a] Merge pull request #70332 from zvonand/ldap-remote-roles\r\ngit bisect bad 07be02d2972d9876cbebc4597d4e9b0a48c1334a\r\n# first bad commit: [07be02d2972d9876cbebc4597d4e9b0a48c1334a] Merge pull request #70332 from zvonand/ldap-remote-roles\r\n```\r\n\r\n```\r\n07be02d2972d9876cbebc4597d4e9b0a48c1334a is the first bad commit\r\ncommit 07be02d2972d9876cbebc4597d4e9b0a48c1334a (HEAD)\r\nMerge: 456a41ee424 e785bb908ec\r\nAuthor: pufit <pufit@yandex.ru>\r\nDate:   Tue Nov 19 23:06:45 2024 +0000\r\n\r\n    Merge pull request #70332 from zvonand/ldap-remote-roles\r\n    \r\n    Passing external user roles from query originator to other nodes\r\n\r\n docs/ru/operations/settings/settings.md                                        |  6 ++++++\r\n programs/client/Client.cpp                                                     |  2 +-\r\n src/Access/ContextAccess.cpp                                                   |  8 +++++++-\r\n src/Access/ContextAccessParams.cpp                                             | 15 +++++++++++++++\r\n src/Access/ContextAccessParams.h                                               |  2 ++\r\n src/Access/LDAPAccessStorage.cpp                                               |  5 ++++-\r\n src/Client/ClientBase.cpp                                                      |  2 ++\r\n src/Client/Connection.cpp                                                      | 19 ++++++++++++++++++-\r\n src/Client/Connection.h                                                        |  1 +\r\n src/Client/HedgedConnections.cpp                                               |  8 +++++---\r\n src/Client/HedgedConnections.h                                                 |  3 ++-\r\n src/Client/IConnections.h                                                      |  3 ++-\r\n src/Client/IServerConnection.h                                                 |  1 +\r\n src/Client/LocalConnection.cpp                                                 |  1 +\r\n src/Client/LocalConnection.h                                                   |  1 +\r\n src/Client/MultiplexedConnections.cpp                                          |  7 ++++---\r\n src/Client/MultiplexedConnections.h                                            |  3 ++-\r\n src/Client/Suggest.cpp                                                         |  2 +-\r\n src/Core/ProtocolDefines.h                                                     |  5 ++++-\r\n src/Core/Settings.cpp                                                          |  3 +++\r\n src/Core/SettingsChangesHistory.cpp                                            |  1 +\r\n src/Interpreters/Context.cpp                                                   | 18 +++++++++++++++---\r\n src/Interpreters/Context.h                                                     |  5 ++++-\r\n src/Interpreters/Session.cpp                                                   | 42 ++++++++++++++++++++++++++----------------\r\n src/Interpreters/Session.h                                                     |  9 +++++++--\r\n src/QueryPipeline/RemoteInserter.cpp                                           |  3 ++-\r\n src/QueryPipeline/RemoteQueryExecutor.cpp                                      | 27 +++++++++++++++++++++++++--\r\n src/Server/TCPHandler.cpp                                                      | 27 ++++++++++++++++++++++++++-\r\n tests/integration/test_ldap_external_user_directory/configs/remote_servers.xml | 18 ++++++++++++++++++\r\n tests/integration/test_ldap_external_user_directory/test.py                    | 87 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-----------------\r\n 30 files changed, 276 insertions(+), 58 deletions(-)\r\n create mode 100644 tests/integration/test_ldap_external_user_directory/configs/remote_servers.xml\r\n```\r\n\r\nCaused by https://github.com/ClickHouse/ClickHouse/pull/70332 cc @pufit @zvonand Let's fix or revert, this is a major bug\nLooking into it. If I don't fix it today -- let's revert, and I fix it later\r\n\r\nUPD I think I fixed the problem -- will check it properly and introduce a new PR asap\nI will make a pr today",
  "created_at": "2024-12-06T19:06:38Z"
}