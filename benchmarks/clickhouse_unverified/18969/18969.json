{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 18969,
  "instance_id": "ClickHouse__ClickHouse-18969",
  "issue_numbers": [
    "18874"
  ],
  "base_commit": "2c71b997de3f49de80802ced4dd19787f344486a",
  "patch": "diff --git a/src/Storages/StorageReplicatedMergeTree.cpp b/src/Storages/StorageReplicatedMergeTree.cpp\nindex ebf1e43ca04e..e4a1c04f4143 100644\n--- a/src/Storages/StorageReplicatedMergeTree.cpp\n+++ b/src/Storages/StorageReplicatedMergeTree.cpp\n@@ -5561,9 +5561,9 @@ void StorageReplicatedMergeTree::getClearBlocksInPartitionOps(\n             continue;\n \n         ReadBufferFromString buf(result.data);\n-        Int64 block_num = 0;\n-        bool parsed = tryReadIntText(block_num, buf) && buf.eof();\n-        if (!parsed || (min_block_num <= block_num && block_num <= max_block_num))\n+        MergeTreePartInfo part_info;\n+        bool parsed = MergeTreePartInfo::tryParsePartName(result.data, &part_info, format_version);\n+        if (!parsed || (min_block_num <= part_info.min_block && part_info.max_block <= max_block_num))\n             ops.emplace_back(zkutil::makeRemoveRequest(path, -1));\n     }\n }\n@@ -6150,7 +6150,7 @@ bool StorageReplicatedMergeTree::dropPart(\n \n         Coordination::Requests ops;\n         getClearBlocksInPartitionOps(ops, *zookeeper, part_info.partition_id, part_info.min_block, part_info.max_block);\n-        size_t clean_block_ops_size = ops.size();\n+        size_t clear_block_ops_size = ops.size();\n \n         /// Set fake level to treat this part as virtual in queue.\n         auto drop_part_info = part->info;\n@@ -6178,7 +6178,7 @@ bool StorageReplicatedMergeTree::dropPart(\n         else\n             zkutil::KeeperMultiException::check(rc, ops, responses);\n \n-        String log_znode_path = dynamic_cast<const Coordination::CreateResponse &>(*responses[clean_block_ops_size + 1]).path_created;\n+        String log_znode_path = dynamic_cast<const Coordination::CreateResponse &>(*responses[clear_block_ops_size + 1]).path_created;\n         entry.znode_name = log_znode_path.substr(log_znode_path.find_last_of('/') + 1);\n \n         return true;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01650_drop_part_and_deduplication_zookeeper.reference b/tests/queries/0_stateless/01650_drop_part_and_deduplication_zookeeper.reference\nnew file mode 100644\nindex 000000000000..ebb0b033d5b6\n--- /dev/null\n+++ b/tests/queries/0_stateless/01650_drop_part_and_deduplication_zookeeper.reference\n@@ -0,0 +1,46 @@\n+1\t1_0_0_0\n+1\t1_1_1_0\n+2\t2_0_0_0\n+2\t2_1_1_0\n+3\t3_0_0_0\n+3\t3_1_1_0\n+1_\t1_0_0_0\n+1_\t1_1_1_0\n+2_\t2_0_0_0\n+2_\t2_1_1_0\n+3_\t3_0_0_0\n+3_\t3_1_1_0\n+1\t1_0_0_0\n+1\t1_1_1_0\n+2\t2_0_0_0\n+2\t2_1_1_0\n+3\t3_0_0_0\n+3\t3_1_1_0\n+1_\t1_0_0_0\n+1_\t1_1_1_0\n+2_\t2_0_0_0\n+2_\t2_1_1_0\n+3_\t3_0_0_0\n+3_\t3_1_1_0\n+1\t1_0_0_0\n+1\t1_1_1_0\n+2\t2_0_0_0\n+2\t2_1_1_0\n+3\t3_0_0_0\n+1_\t1_0_0_0\n+1_\t1_1_1_0\n+2_\t2_0_0_0\n+2_\t2_1_1_0\n+3_\t3_0_0_0\n+1\t1_0_0_0\n+1\t1_1_1_0\n+2\t2_0_0_0\n+2\t2_1_1_0\n+3\t3_0_0_0\n+3\t3_2_2_0\n+1_\t1_0_0_0\n+1_\t1_1_1_0\n+2_\t2_0_0_0\n+2_\t2_1_1_0\n+3_\t3_0_0_0\n+3_\t3_2_2_0\ndiff --git a/tests/queries/0_stateless/01650_drop_part_and_deduplication_zookeeper.sql b/tests/queries/0_stateless/01650_drop_part_and_deduplication_zookeeper.sql\nnew file mode 100644\nindex 000000000000..505966806188\n--- /dev/null\n+++ b/tests/queries/0_stateless/01650_drop_part_and_deduplication_zookeeper.sql\n@@ -0,0 +1,39 @@\n+DROP TABLE IF EXISTS partitioned_table;\n+\n+CREATE TABLE partitioned_table (\n+    key UInt64,\n+    partitioner UInt8,\n+    value String\n+)\n+ENGINE ReplicatedMergeTree('/clickhouse/test/01650_drop_part_and_deduplication/partitioned_table', '1')\n+ORDER BY key\n+PARTITION BY partitioner;\n+\n+SYSTEM STOP MERGES partitioned_table;\n+\n+INSERT INTO partitioned_table VALUES (1, 1, 'A'), (2, 2, 'B'), (3, 3, 'C');\n+INSERT INTO partitioned_table VALUES (11, 1, 'AA'), (22, 2, 'BB'), (33, 3, 'CC');\n+\n+SELECT partition_id, name FROM system.parts WHERE table = 'partitioned_table' AND database = currentDatabase() ORDER BY name;\n+\n+SELECT substring(name, 1, 2), value FROM system.zookeeper WHERE path='/clickhouse/test/01650_drop_part_and_deduplication/partitioned_table/blocks/' ORDER BY value;\n+\n+INSERT INTO partitioned_table VALUES (33, 3, 'CC'); -- must be deduplicated\n+\n+SELECT partition_id, name FROM system.parts WHERE table = 'partitioned_table' AND database = currentDatabase() ORDER BY name;\n+\n+SELECT substring(name, 1, 2), value FROM system.zookeeper WHERE path='/clickhouse/test/01650_drop_part_and_deduplication/partitioned_table/blocks/' ORDER BY value;\n+\n+ALTER TABLE partitioned_table DROP PART '3_1_1_0';\n+\n+SELECT partition_id, name FROM system.parts WHERE table = 'partitioned_table' AND database = currentDatabase() ORDER BY name;\n+\n+SELECT substring(name, 1, 2), value FROM system.zookeeper WHERE path='/clickhouse/test/01650_drop_part_and_deduplication/partitioned_table/blocks/' ORDER BY value;\n+\n+INSERT INTO partitioned_table VALUES (33, 3, 'CC'); -- mustn't be deduplicated\n+\n+SELECT partition_id, name FROM system.parts WHERE table = 'partitioned_table' AND database = currentDatabase() ORDER BY name;\n+\n+SELECT substring(name, 1, 2), value FROM system.zookeeper WHERE path='/clickhouse/test/01650_drop_part_and_deduplication/partitioned_table/blocks/' ORDER BY value;\n+\n+DROP TABLE IF EXISTS partitioned_table;\n",
  "problem_statement": "Dropping of a part breaks deduplication of data blocks\n20.12.5.14 `alter table ... drop part ...` removes from ZooKeeper all blocks for the partition.\r\nThe same thing happens when CH cleans empty parts:\r\n```\r\nCREATE TABLE empty_parts \r\n(\r\n  `k`   Int8,\r\n  `v`   Int8\r\n)\r\nENGINE = ReplicatedSummingMergeTree ('/clickhouse/empty_parts','replica1')\r\nORDER BY k;\r\n\r\ninsert into empty_parts values (1, 15);\r\ninsert into empty_parts values (1, -15);\r\noptimize table empty_parts;\r\ninsert into empty_parts values (2, -15);\r\n\r\nselect name, active, rows, modification_time from system.parts where table like 'empty_parts'\r\n\r\nname        | active | rows | modification_time  \r\n------------+--------+------+--------------------\r\nall_15_15_0 |      0 |    1 | 2021-01-07 21:54:05\r\nall_16_16_0 |      0 |    1 | 2021-01-08 20:13:00\r\nall_15_16_1 |      1 |    0 | 2021-01-08 20:13:46\r\nall_17_17_0 |      1 |    1 | 2021-01-08 20:13:47\r\n\r\n\r\nselect name, value from system.zookeeper where path='/clickhouse/empty_parts/blocks/'\r\n\r\nname                                         | value      \r\n---------------------------------------------+------------\r\nall_9295045124109325217_14756667786308374723 | all_16_16_0\r\nall_18396465411487747783_4385790938943258888 | all_17_17_0\r\n```\r\nThe next insert of the same block is deduplicated:\r\n```\r\ninsert into empty_parts values (2, -15);\r\n\r\n2021.01.08 20:13:53.267392 <Information> empty_parts (Replicated OutputStream): Block with ID all_18396465411487747783_4385790938943258888 already exists locally as part all_17_17_0; ignoring it.\r\n```\r\nThe empty part is getting dropped in background\r\n```\r\n2021.01.08 20:14:19.103462 <Trace> empty_parts: Will try to insert a log entry to DROP_RANGE for part: all_15_16_1\r\n```\r\nThe next insert of the same block is NOT deduplicated:\r\n```\r\ninsert into empty_parts values (2, -15);\r\n\r\n2021.01.08 20:16:19.145203 <Debug> executeQuery: (from [::1]:40824) insert into empty_parts values\r\n2021.01.08 20:16:19.146681 <Debug> empty_parts (Replicated OutputStream): Wrote block with ID 'all_18396465411487747783_4385790938943258888', 1 rows\r\n2021.01.08 20:16:19.181508 <Trace> empty_parts: Renaming temporary part tmp_insert_all_23_23_0 to all_18_18_0.\r\n\r\n\r\nselect name, active, rows, modification_time from system.parts where table like 'empty_parts'\r\n\r\nname        | active | rows | modification_time  \r\n------------+--------+------+--------------------\r\nall_17_17_0 |      1 |    1 | 2021-01-08 16:13:47\r\nall_18_18_0 |      1 |    1 | 2021-01-08 16:16:19\r\n\r\n\r\nselect name, value from system.zookeeper where path='/clickhouse/empty_parts/blocks/'\r\n\r\nname                                         | value      \r\n---------------------------------------------+------------\r\nall_18396465411487747783_4385790938943258888 | all_18_18_0\r\n\r\nSELECT _part, * FROM empty_parts\r\n\r\n\u250c\u2500_part\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500k\u2500\u252c\u2500\u2500v\u2500\u2510\r\n\u2502 all_17_17_0 \u2502 1 \u2502 15 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2518\r\n\u250c\u2500_part\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500k\u2500\u252c\u2500\u2500v\u2500\u2510\r\n\u2502 all_18_18_0 \u2502 1 \u2502 15 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\n",
  "hints_text": "A 'drop part' example:\r\n```\r\nSELECT partition_id, name, active, rows FROM system.parts WHERE table = 'empty_parts'\r\n\r\n\u250c\u2500partition_id\u2500\u252c\u2500name\u2500\u2500\u2500\u2500\u252c\u2500active\u2500\u252c\u2500rows\u2500\u2510\r\n\u2502 1            \u2502 1_0_2_1 \u2502      1 \u2502    1 \u2502\r\n\u2502 3            \u2502 3_4_4_0 \u2502      1 \u2502    1 \u2502\r\n\u2502 3            \u2502 3_5_5_0 \u2502      1 \u2502    1 \u2502\r\n\u2502 3            \u2502 3_6_6_0 \u2502      1 \u2502    1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n\r\nselect name, value from system.zookeeper where path='/clickhouse/empty_parts/blocks/'\r\n\r\nname                                       | value  \r\n-------------------------------------------+--------\r\n1_11399136439445260560_7973921282756393715 | 1_0_0_0\r\n1_8654143307411682360_14116233956237804319 | 1_1_1_0\r\n1_11053027890533430589_2616610988686935987 | 1_2_2_0\r\n3_10502016800340611441_7425679243188499961 | 3_4_4_0\r\n3_7883607166341972256_3064835063613120631  | 3_5_5_0\r\n3_13241712918946842254_5361179378334027442 | 3_6_6_0\r\n\r\n\r\n\r\nALTER TABLE empty_parts DROP PART '3_6_6_0'\r\nOk.\r\n\r\n\r\n\r\nSELECT partition_id, name, active, rows FROM system.parts WHERE table = 'empty_parts'\r\n\r\n\u250c\u2500partition_id\u2500\u252c\u2500name\u2500\u2500\u2500\u2500\u252c\u2500active\u2500\u252c\u2500rows\u2500\u2510\r\n\u2502 1            \u2502 1_0_2_1 \u2502      1 \u2502    1 \u2502\r\n\u2502 3            \u2502 3_4_4_0 \u2502      1 \u2502    1 \u2502\r\n\u2502 3            \u2502 3_5_5_0 \u2502      1 \u2502    1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n\r\n\r\nselect name, value from system.zookeeper where path='/clickhouse/empty_parts/blocks/'\r\n\r\nname                                       | value  \r\n-------------------------------------------+--------\r\n1_11399136439445260560_7973921282756393715 | 1_0_0_0\r\n1_8654143307411682360_14116233956237804319 | 1_1_1_0\r\n1_11053027890533430589_2616610988686935987 | 1_2_2_0\r\n```",
  "created_at": "2021-01-12T10:59:33Z",
  "modified_files": [
    "src/Storages/StorageReplicatedMergeTree.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01650_drop_part_and_deduplication_zookeeper.reference",
    "b/tests/queries/0_stateless/01650_drop_part_and_deduplication_zookeeper.sql"
  ]
}