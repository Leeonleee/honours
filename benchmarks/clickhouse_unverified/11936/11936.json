{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 11936,
  "instance_id": "ClickHouse__ClickHouse-11936",
  "issue_numbers": [
    "11918"
  ],
  "base_commit": "3e6da7d7932a8d6ac63138d3b69e3c593f295526",
  "patch": "diff --git a/src/Interpreters/ReplaceQueryParameterVisitor.cpp b/src/Interpreters/ReplaceQueryParameterVisitor.cpp\nindex 5c29c722f88e..2a629cefb01f 100644\n--- a/src/Interpreters/ReplaceQueryParameterVisitor.cpp\n+++ b/src/Interpreters/ReplaceQueryParameterVisitor.cpp\n@@ -25,14 +25,18 @@ namespace ErrorCodes\n \n \n void ReplaceQueryParameterVisitor::visit(ASTPtr & ast)\n+{\n+    if (ast->as<ASTQueryParameter>())\n+        visitQueryParameter(ast);\n+    else\n+        visitChildren(ast);\n+}\n+\n+\n+void ReplaceQueryParameterVisitor::visitChildren(ASTPtr & ast)\n {\n     for (auto & child : ast->children)\n-    {\n-        if (child->as<ASTQueryParameter>())\n-            visitQueryParameter(child);\n-        else\n-            visit(child);\n-    }\n+        visit(child);\n }\n \n const String & ReplaceQueryParameterVisitor::getParamValue(const String & name)\ndiff --git a/src/Interpreters/ReplaceQueryParameterVisitor.h b/src/Interpreters/ReplaceQueryParameterVisitor.h\nindex 1931d4c0ba8c..3a84cd22acd9 100644\n--- a/src/Interpreters/ReplaceQueryParameterVisitor.h\n+++ b/src/Interpreters/ReplaceQueryParameterVisitor.h\n@@ -22,6 +22,7 @@ class ReplaceQueryParameterVisitor\n     const NameToNameMap & query_parameters;\n     const String & getParamValue(const String & name);\n     void visitQueryParameter(ASTPtr & ast);\n+    void visitChildren(ASTPtr & ast);\n };\n \n }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01015_insert_values_parametrized.reference b/tests/queries/0_stateless/01015_insert_values_parametrized.reference\nindex c887e5feb5f0..fc04eb5bc225 100644\n--- a/tests/queries/0_stateless/01015_insert_values_parametrized.reference\n+++ b/tests/queries/0_stateless/01015_insert_values_parametrized.reference\n@@ -3,3 +3,4 @@\n 2\ttestparam\t[0.3]\n 3\tparamparam\t[]\n 4\tevaluateparam\t[0.2]\n+5\tparam\t[0.2,0.3]\ndiff --git a/tests/queries/0_stateless/01015_insert_values_parametrized.sh b/tests/queries/0_stateless/01015_insert_values_parametrized.sh\nindex 8edda6629b05..ac3833016632 100755\n--- a/tests/queries/0_stateless/01015_insert_values_parametrized.sh\n+++ b/tests/queries/0_stateless/01015_insert_values_parametrized.sh\n@@ -15,6 +15,9 @@ $CLICKHOUSE_CLIENT --input_format_values_deduce_templates_of_expressions=1 --inp\n $CLICKHOUSE_CLIENT --input_format_values_deduce_templates_of_expressions=0 --input_format_values_interpret_expressions=1 --param_p_n=\"-1\" --param_p_s=\"param\" --param_p_a=\"[0.2,0.3]\" --query=\"INSERT INTO insert_values_parametrized  VALUES \\\n (5 + {p_n:Int8}, lower(concat('Evaluate', {p_s:String})), arrayIntersect([0, 0.2, 0.6], {p_a:Array(Nullable(Float32))}))\"\n \n+$CLICKHOUSE_CLIENT --param_p_n=\"5\" --param_p_s=\"param\" --param_p_a=\"[0.2,0.3]\" --query=\"INSERT INTO insert_values_parametrized  VALUES \\\n+({p_n:Int8}, {p_s:String}, {p_a:Array(Nullable(Float32))})\"\n+\n $CLICKHOUSE_CLIENT --query=\"SELECT * FROM insert_values_parametrized ORDER BY n\";\n \n $CLICKHOUSE_CLIENT --query=\"DROP TABLE insert_values_parametrized\";\n",
  "problem_statement": "Query parameters in Values\n```\r\nclickhouse-client -q 'create table typed_nulls( str Nullable(String) ) Engine=Log'\r\n\r\nclickhouse-client --param_n='\\N' --query='insert into typed_nulls(str) values ( {n:Nullable(String)} )' --format=Vertical\r\nCode: 456. DB::Exception: Query parameter `n` was not set\r\n\r\nclickhouse-client --param_n='aa' --query='insert into typed_nulls(str) values ( {n:Nullable(String)} )' --format=Vertical\r\nCode: 456. DB::Exception: Query parameter `n` was not set\r\n```\r\n\r\nSee also https://github.com/ClickHouse/ClickHouse/commit/a58996817ff0f639686f4248ac0be43a000aac85\r\n/cc @tavplubix \n",
  "hints_text": "",
  "created_at": "2020-06-24T21:41:49Z",
  "modified_files": [
    "src/Interpreters/ReplaceQueryParameterVisitor.cpp",
    "src/Interpreters/ReplaceQueryParameterVisitor.h"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/01015_insert_values_parametrized.reference",
    "tests/queries/0_stateless/01015_insert_values_parametrized.sh"
  ]
}