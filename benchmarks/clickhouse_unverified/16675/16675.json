{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 16675,
  "instance_id": "ClickHouse__ClickHouse-16675",
  "issue_numbers": [
    "5733"
  ],
  "base_commit": "7986dbdfc7a6b57e9924171b46ca9899beb2ad8c",
  "patch": "diff --git a/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp b/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp\nindex f06bfb97b2c5..2ca989e12e6d 100644\n--- a/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp\n+++ b/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp\n@@ -366,6 +366,15 @@ Pipe MergeTreeDataSelectExecutor::readFromParts(\n       * It is also important that the entire universe can be covered using SAMPLE 0.1 OFFSET 0, ... OFFSET 0.9 and similar decimals.\n       */\n \n+    /// Parallel replicas has been requested but there is no way to sample data.\n+    /// Select all data from first replica and no data from other replicas.\n+    if (settings.parallel_replicas_count > 1 && !data.supportsSampling() && settings.parallel_replica_offset > 0)\n+    {\n+        LOG_DEBUG(log, \"Will use no data on this replica because parallel replicas processing has been requested\"\n+            \" (the setting 'max_parallel_replicas') but the table does not support sampling and this replica is not the first.\");\n+        return {};\n+    }\n+\n     bool use_sampling = relative_sample_size > 0 || (settings.parallel_replicas_count > 1 && data.supportsSampling());\n     bool no_data = false;   /// There is nothing left after sampling.\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01557_max_parallel_replicas_no_sample.reference b/tests/queries/0_stateless/01557_max_parallel_replicas_no_sample.reference\nnew file mode 100644\nindex 000000000000..2715babfff20\n--- /dev/null\n+++ b/tests/queries/0_stateless/01557_max_parallel_replicas_no_sample.reference\n@@ -0,0 +1,4 @@\n+Hello\n+1000\n+1000\n+1000\ndiff --git a/tests/queries/0_stateless/01557_max_parallel_replicas_no_sample.sql b/tests/queries/0_stateless/01557_max_parallel_replicas_no_sample.sql\nnew file mode 100644\nindex 000000000000..d86f692a1eaa\n--- /dev/null\n+++ b/tests/queries/0_stateless/01557_max_parallel_replicas_no_sample.sql\n@@ -0,0 +1,22 @@\n+DROP TABLE IF EXISTS t;\n+CREATE TABLE t (x String) ENGINE = MergeTree ORDER BY x;\n+INSERT INTO t VALUES ('Hello');\n+\n+SET max_parallel_replicas = 3;\n+SELECT * FROM remote('127.0.0.{2|3|4}', currentDatabase(), t);\n+\n+DROP TABLE t;\n+\n+CREATE TABLE t (x String) ENGINE = MergeTree ORDER BY cityHash64(x) SAMPLE BY cityHash64(x);\n+INSERT INTO t SELECT toString(number) FROM numbers(1000);\n+\n+SET max_parallel_replicas = 1;\n+SELECT count() FROM remote('127.0.0.{2|3|4}', currentDatabase(), t);\n+\n+SET max_parallel_replicas = 2;\n+SELECT count() FROM remote('127.0.0.{2|3|4}', currentDatabase(), t);\n+\n+SET max_parallel_replicas = 3;\n+SELECT count() FROM remote('127.0.0.{2|3|4}', currentDatabase(), t);\n+\n+DROP TABLE t;\ndiff --git a/tests/queries/0_stateless/arcadia_skip_list.txt b/tests/queries/0_stateless/arcadia_skip_list.txt\nindex 8ece63c419cc..900cc82b33f8 100644\n--- a/tests/queries/0_stateless/arcadia_skip_list.txt\n+++ b/tests/queries/0_stateless/arcadia_skip_list.txt\n@@ -159,3 +159,4 @@\n 01547_query_log_current_database\n 01548_query_log_query_execution_ms\n 01552_dict_fixedstring\n+01557_max_parallel_replicas_no_sample.sql\n",
  "problem_statement": "max_parallel_replicas delivers incorrect result for tables without sampling.\n19.8.3.8\r\n\r\nI have a cluster configured as 1 shard with 6 replicas.\r\n\r\n```\r\n<replicated>\r\n    <shard>\r\n        <internal_replication>true</internal_replication>\r\n        <replica><host>host1</host><port>9000</port></replica>\r\n        <replica><host>host2</host><port>9000</port></replica>\r\n        <replica><host>host3</host><port>9000</port></replica>\r\n        <replica><host>host4</host><port>9000</port></replica>\r\n        <replica><host>host5</host><port>9000</port></replica>\r\n        <replica><host>host6</host><port>9000</port></replica>\r\n    </shard>\r\n</replicated>\r\n```\r\n\r\nAt each node\r\n```\r\ncreate table max_p_test(a Int64) Engine=MergeTree order by a;\r\ninsert into max_p_test values(1);\r\n```\r\nAt the first node\r\n```\r\nCREATE TABLE max_p_test_d as max_p_test\r\nENGINE = Distributed (replicated,currentDatabase(),'max_p_test');\r\n```\r\n\r\n```\r\nSELECT *\r\nFROM max_p_test_d\r\n\r\n\u250c\u2500a\u2500\u2510\r\n\u2502 1 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n\r\nSET max_parallel_replicas = 10, prefer_localhost_replica = 0\r\n\r\nSELECT *\r\nFROM max_p_test_d\r\n\r\n\u250c\u2500a\u2500\u2510\r\n\u2502 1 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n\u250c\u2500a\u2500\u2510\r\n\u2502 1 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n\u250c\u2500a\u2500\u2510\r\n\u2502 1 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n\u250c\u2500a\u2500\u2510\r\n\u2502 1 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n\u250c\u2500a\u2500\u2510\r\n\u2502 1 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n\u250c\u2500a\u2500\u2510\r\n\u2502 1 \u2502\r\n\u2514\u2500\u2500\u2500\u2518\r\n\r\n6 rows in set. Elapsed: 0.009 sec.\r\n```\n",
  "hints_text": "It should not work without sampling at all.\nthe same behavior 19.13.7.57",
  "created_at": "2020-11-04T16:00:55Z",
  "modified_files": [
    "src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01557_max_parallel_replicas_no_sample.reference",
    "b/tests/queries/0_stateless/01557_max_parallel_replicas_no_sample.sql",
    "tests/queries/0_stateless/arcadia_skip_list.txt"
  ]
}