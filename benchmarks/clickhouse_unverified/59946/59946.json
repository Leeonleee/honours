{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 59946,
  "instance_id": "ClickHouse__ClickHouse-59946",
  "issue_numbers": [
    "54902"
  ],
  "base_commit": "4fb76a6e2584971daa3b633493501b3befe0fe9c",
  "patch": "diff --git a/src/Storages/StorageReplicatedMergeTree.cpp b/src/Storages/StorageReplicatedMergeTree.cpp\nindex 6119541ff522..8e1598a1eef5 100644\n--- a/src/Storages/StorageReplicatedMergeTree.cpp\n+++ b/src/Storages/StorageReplicatedMergeTree.cpp\n@@ -513,8 +513,15 @@ StorageReplicatedMergeTree::StorageReplicatedMergeTree(\n             if (same_structure)\n             {\n                 Coordination::Stat metadata_stat;\n-                current_zookeeper->get(zookeeper_path + \"/metadata\", &metadata_stat);\n+                current_zookeeper->get(fs::path(zookeeper_path) / \"metadata\", &metadata_stat);\n+\n+                /** We change metadata_snapshot so that `createReplica` method will create `metadata_version` node in ZooKeeper\n+                  * with version of table '/metadata' node in Zookeeper.\n+                  *\n+                  * Otherwise `metadata_version` for not first replica will be initialized with 0 by default.\n+                  */\n                 setInMemoryMetadata(metadata_snapshot->withMetadataVersion(metadata_stat.version));\n+                metadata_snapshot = getInMemoryMetadataPtr();\n             }\n         }\n         catch (Coordination::Exception & e)\n@@ -5817,6 +5824,7 @@ bool StorageReplicatedMergeTree::executeMetadataAlter(const StorageReplicatedMer\n     Coordination::Requests requests;\n     requests.emplace_back(zkutil::makeSetRequest(fs::path(replica_path) / \"columns\", entry.columns_str, -1));\n     requests.emplace_back(zkutil::makeSetRequest(fs::path(replica_path) / \"metadata\", entry.metadata_str, -1));\n+    requests.emplace_back(zkutil::makeSetRequest(fs::path(replica_path) / \"metadata_version\", std::to_string(entry.alter_version), -1));\n \n     auto table_id = getStorageID();\n     auto alter_context = getContext();\n@@ -5863,10 +5871,6 @@ bool StorageReplicatedMergeTree::executeMetadataAlter(const StorageReplicatedMer\n         resetObjectColumnsFromActiveParts(parts_lock);\n     }\n \n-    /// This transaction may not happen, but it's OK, because on the next retry we will eventually create/update this node\n-    /// TODO Maybe do in in one transaction for Replicated database?\n-    zookeeper->createOrUpdate(fs::path(replica_path) / \"metadata_version\", std::to_string(current_metadata->getMetadataVersion()), zkutil::CreateMode::Persistent);\n-\n     return true;\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02989_replicated_merge_tree_invalid_metadata_version.reference b/tests/queries/0_stateless/02989_replicated_merge_tree_invalid_metadata_version.reference\nnew file mode 100644\nindex 000000000000..128e3adcc0a1\n--- /dev/null\n+++ b/tests/queries/0_stateless/02989_replicated_merge_tree_invalid_metadata_version.reference\n@@ -0,0 +1,14 @@\n+Row 1:\n+\u2500\u2500\u2500\u2500\u2500\u2500\n+name:    metadata\n+version: 1\n+--\n+Row 1:\n+\u2500\u2500\u2500\u2500\u2500\u2500\n+name:  metadata_version\n+value: 1\n+--\n+id\tUInt64\t\t\t\t\t\n+value\tString\t\t\t\t\t\n+insert_time\tDateTime\t\t\t\t\t\n+insert_time_updated\tDateTime\t\t\t\t\t\ndiff --git a/tests/queries/0_stateless/02989_replicated_merge_tree_invalid_metadata_version.sql b/tests/queries/0_stateless/02989_replicated_merge_tree_invalid_metadata_version.sql\nnew file mode 100644\nindex 000000000000..3e37f368fd8a\n--- /dev/null\n+++ b/tests/queries/0_stateless/02989_replicated_merge_tree_invalid_metadata_version.sql\n@@ -0,0 +1,40 @@\n+-- Tags: zookeeper\n+\n+DROP TABLE IF EXISTS test_table_replicated;\n+CREATE TABLE test_table_replicated\n+(\n+    id UInt64,\n+    value String\n+) ENGINE=ReplicatedMergeTree('/clickhouse/tables/{database}/test_table_replicated', '1_replica') ORDER BY id;\n+\n+ALTER TABLE test_table_replicated ADD COLUMN insert_time DateTime;\n+\n+SELECT name, version FROM system.zookeeper\n+WHERE path = '/clickhouse/tables/' || currentDatabase() ||'/test_table_replicated/'\n+AND name = 'metadata' FORMAT Vertical;\n+\n+DROP TABLE IF EXISTS test_table_replicated_second;\n+CREATE TABLE test_table_replicated_second\n+(\n+    id UInt64,\n+    value String,\n+    insert_time DateTime\n+) ENGINE=ReplicatedMergeTree('/clickhouse/tables/{database}/test_table_replicated', '2_replica') ORDER BY id;\n+\n+DROP TABLE test_table_replicated;\n+\n+SELECT '--';\n+\n+SELECT name, value FROM system.zookeeper\n+WHERE path = '/clickhouse/tables/' || currentDatabase() ||'/test_table_replicated/replicas/2_replica'\n+AND name = 'metadata_version' FORMAT Vertical;\n+\n+SYSTEM RESTART REPLICA test_table_replicated_second;\n+\n+ALTER TABLE test_table_replicated_second ADD COLUMN insert_time_updated DateTime;\n+\n+SELECT '--';\n+\n+DESCRIBE test_table_replicated_second;\n+\n+DROP TABLE test_table_replicated_second;\n",
  "problem_statement": "Metadata on replica is not up to date with common metadata in Zookeeper\n```sql\r\nalter table test add column x Int32;\r\n\r\nReceived exception from server (version 23.8.2):\r\nCode: 517. DB::Exception: Received from localhost:9000. \r\nDB::Exception: Metadata on replica is not up to date with common metadata in Zookeeper. \r\nIt means that this replica still not applied some of previous alters. \r\nProbably too many alters executing concurrently (highly not recommended). You can retry this error. (CANNOT_ASSIGN_ALTER)\r\n```\r\n\r\nI tried table detach/attach, no changes.\r\n\r\n```\r\nSELECT\r\n    name,\r\n    substr(replace(value, '\\n', ' '), 1, 50) AS value_s,\r\n    cityHash64(value)\r\nFROM system.zookeeper\r\nWHERE path = (\r\n    SELECT zookeeper_path\r\n    FROM system.replicas\r\n    WHERE table = 'test'\r\n)\r\n\r\n\u250c\u2500name\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500value_s\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500cityHash64(value)\u2500\u2510\r\n\u2502 alter_partition_version    \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 metadata                   \u2502 metadata format version: 1 date column:  sampling  \u2502  4322393711038923972 \u2502\r\n\u2502 temp                       \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 table_shared_id            \u2502 fc28061c-c819-4a0b-bc28-061cc8194a0b               \u2502  7914521819417058279 \u2502\r\n\u2502 log                        \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 leader_election            \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 columns                    \u2502 columns format version: 1 243 columns: `access_tim \u2502   594710015478039907 \u2502\r\n\u2502 blocks                     \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 nonincrement_block_numbers \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 replicas                   \u2502 last added replica: chdw1-1.sde10186               \u2502  4784695667935888577 \u2502\r\n\u2502 async_blocks               \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 quorum                     \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 pinned_part_uuids          \u2502 {\"part_uuids\":\"[]\"}                                \u2502 16899393181724385792 \u2502\r\n\u2502 block_numbers              \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 mutations                  \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 zero_copy_s3               \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 part_moves_shard           \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 zero_copy_hdfs             \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 lost_part_count            \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\n```\r\nSELECT\r\n    name,\r\n    substr(replace(value, '\\n', ' '), 1, 50) AS value_s,\r\n    cityHash64(value)\r\nFROM system.zookeeper\r\nWHERE path = (\r\n    SELECT replica_path\r\n    FROM system.replicas\r\n    WHERE table = 'test'\r\n)\r\n\r\n\u250c\u2500name\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500value_s\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500cityHash64(value)\u2500\u2510\r\n\u2502 is_lost                     \u2502 0                                                  \u2502 10408321403207385874 \u2502\r\n\u2502 metadata                    \u2502 metadata format version: 1 date column:  sampling  \u2502  4322393711038923972 \u2502\r\n\u2502 is_active                   \u2502 UUID_'a57446f7-2cb9-47f9-b1b6-65573c29067c'        \u2502  1870750756359300609 \u2502\r\n\u2502 mutation_pointer            \u2502 0000000047                                         \u2502 10517147932185828611 \u2502\r\n\u2502 columns                     \u2502 columns format version: 1 243 columns: `access_tim \u2502   594710015478039907 \u2502\r\n\u2502 max_processed_insert_time   \u2502 1695306428                                         \u2502  5882609297731162392 \u2502\r\n\u2502 flags                       \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 log_pointer                 \u2502 547980                                             \u2502 18155853374234986669 \u2502\r\n\u2502 min_unprocessed_insert_time \u2502 0                                                  \u2502 10408321403207385874 \u2502\r\n\u2502 host                        \u2502 host: chdw1-1.sde10186.mycmdb.net port: 9009 tcp_p \u2502 16322273289710190182 \u2502\r\n\u2502 parts                       \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 queue                       \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 metadata_version            \u2502 0                                                  \u2502 10408321403207385874 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\nI wonder what I should check else, to find the cause of the issue ?\n",
  "hints_text": "If I create a new table \r\n\r\n```\r\ncreate table test_new   as test\r\nENGINE = ReplicatedMergeTree('/clickhouse/{cluster}/tables/{shard}/test', '{replica}')\r\nPARTITION BY (account_id, toYYYYMM(access_day))\r\nORDER BY (ad_rotation_key, ad_key, event_key, time_key, batch_id)\r\nSETTINGS index_granularity = 8192;\r\n```\r\n\r\n```\r\nSELECT\r\n    name,\r\n    substr(replace(value, '\\n', ' '), 1, 50) AS value_s,\r\n    cityHash64(value)\r\nFROM system.zookeeper\r\nWHERE path = (\r\n    SELECT zookeeper_path\r\n    FROM system.replicas\r\n    WHERE table = 'test_new'\r\n)\r\n\r\n\u250c\u2500name\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500value_s\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500cityHash64(value)\u2500\u2510\r\n\u2502 alter_partition_version    \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 metadata                   \u2502 metadata format version: 1 date column:  sampling  \u2502  4322393711038923972 \u2502\r\n\u2502 temp                       \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 table_shared_id            \u2502 c2091fc4-9444-4976-92e5-d14a5ea17538               \u2502 15428865724794527968 \u2502\r\n\u2502 log                        \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 leader_election            \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 columns                    \u2502 columns format version: 1 243 columns: `access_tim \u2502   594710015478039907 \u2502\r\n\u2502 blocks                     \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 async_blocks               \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 nonincrement_block_numbers \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 replicas                   \u2502 last added replica: chdw1-1.sde10186               \u2502  4784695667935888577 \u2502\r\n\u2502 quorum                     \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 pinned_part_uuids          \u2502 {\"part_uuids\":\"[]\"}                                \u2502 16899393181724385792 \u2502\r\n\u2502 block_numbers              \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 mutations                  \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 part_moves_shard           \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 lost_part_count            \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\n```\r\nSELECT\r\n    name,\r\n    substr(replace(value, '\\n', ' '), 1, 50) AS value_s,\r\n    cityHash64(value)\r\nFROM system.zookeeper\r\nWHERE path = (\r\n    SELECT replica_path\r\n    FROM system.replicas\r\n    WHERE table = 'test_new'\r\n)\r\n\r\n\u250c\u2500name\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500value_s\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500cityHash64(value)\u2500\u2510\r\n\u2502 is_lost                     \u2502 0                                                  \u2502 10408321403207385874 \u2502\r\n\u2502 metadata                    \u2502 metadata format version: 1 date column:  sampling  \u2502  4322393711038923972 \u2502\r\n\u2502 is_active                   \u2502 UUID_'a57446f7-2cb9-47f9-b1b6-65573c29067c'        \u2502  1870750756359300609 \u2502\r\n\u2502 mutation_pointer            \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 columns                     \u2502 columns format version: 1 243 columns: `access_tim \u2502   594710015478039907 \u2502\r\n\u2502 max_processed_insert_time   \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 flags                       \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 log_pointer                 \u2502 0                                                  \u2502 10408321403207385874 \u2502\r\n\u2502 min_unprocessed_insert_time \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 host                        \u2502 host: chdw1-1.sde10186.mycmdb.net port: 9009 tcp_p \u2502  3931567119684115879 \u2502\r\n\u2502 parts                       \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 queue                       \u2502                                                    \u2502 11160318154034397263 \u2502\r\n\u2502 metadata_version            \u2502 0                                                  \u2502 10408321403207385874 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\n```\r\ndiff test.sql test_new.sql\r\n1c1\r\n< ATTACH TABLE _ UUID '22a311de-aa68-4551-a524-538f069f0c8e'\r\n---\r\n> ATTACH TABLE _ UUID 'c2091fc4-9444-4976-92e5-d14a5ea17538'\r\n247c247\r\n< ENGINE = ReplicatedMergeTree('/clickhouse/{cluster}/tables/{shard}/csp_ad_fact_event_shard_3', '{replica}')\r\n---\r\n> ENGINE = ReplicatedMergeTree('/clickhouse/{cluster}/tables/{shard}/test', '{replica}')\r\n```\n@den-crane You need to check zookeeper `version` of node `/table/replicas/your_replica/metadata_version` and version of node `/table/metadata`. Also make sense to show full content of `/table/metadata` and `/table/replicas/your_replica/metadata`.\nInteresting that many tables have the same issue and all shards are affected.\r\n\r\nHere is an example with a small/narrow table `dim_tag_new`\r\n\r\n```\r\nalter table dw.dim_tag_new add column c String;\r\n\r\nReceived exception from server (version 23.8.2):\r\nCode: 517. DB::Exception: Received from localhost:9000. DB::Exception: Metadata on replica is not up to date with common metadata in Zookeeper. It means that this replica still not applied some of previous alters. Probably too many alters executing concurrently (highly not recommended). You can retry this error. (CANNOT_ASSIGN_ALTER)\r\n```\r\n\r\n```\r\nSELECT *\r\nFROM system.replicas\r\nWHERE table = 'dim_tag_new'\r\n\r\ndatabase:                    dw\r\ntable:                       dim_tag_new\r\nengine:                      ReplicatedReplacingMergeTree\r\nis_leader:                   1\r\ncan_become_leader:           1\r\nis_readonly:                 0\r\nis_session_expired:          0\r\nfuture_parts:                0\r\nparts_to_check:              0\r\nzookeeper_name:              default\r\nzookeeper_path:              /clickhouse/oCHDWcsp1/tables/dim_tag1\r\nreplica_name:                chdw1-1.sde10186\r\nreplica_path:                /clickhouse/oCHDWcsp1/tables/dim_tag1/replicas/chdw1-1.sde10186\r\ncolumns_version:             -1\r\nqueue_size:                  0\r\ninserts_in_queue:            0\r\nmerges_in_queue:             0\r\npart_mutations_in_queue:     0\r\nqueue_oldest_time:           1970-01-01 00:00:00\r\ninserts_oldest_time:         1970-01-01 00:00:00\r\nmerges_oldest_time:          1970-01-01 00:00:00\r\npart_mutations_oldest_time:  1970-01-01 00:00:00\r\noldest_part_to_get:\r\noldest_part_to_merge_to:\r\noldest_part_to_mutate_to:\r\nlog_max_index:               5892\r\nlog_pointer:                 5893\r\nlast_queue_update:           2023-09-22 17:50:02\r\nabsolute_delay:              0\r\ntotal_replicas:              2\r\nactive_replicas:             2\r\nlost_part_count:             0\r\nlast_queue_update_exception:\r\nzookeeper_exception:\r\nreplica_is_active:           {'chdw1-1.sde10186':1,'chdw1-1.sde10190':1}\r\n```\r\n\r\n```\r\nselect * from system.zookeeper \r\nwhere path = '/clickhouse/oCHDWcsp1/tables/dim_tag1' and  name = 'metadata'; \\G;\r\n\r\nname:  metadata\r\nvalue: metadata format version: 1\r\ndate column:\r\nsampling expression:\r\nindex granularity: 512\r\nmode: 5\r\nsign column:\r\nprimary key: tag_key\r\ndata format version: 1\r\npartition key:\r\ngranularity bytes: 10485760\r\n```\r\n\r\n```\r\nselect * from system.zookeeper \r\nwhere path = '/clickhouse/oCHDWcsp1/tables/dim_tag1/replicas/chdw1-1.sde10186' and  name = 'metadata'; \\G;\r\n\r\nname:  metadata\r\nvalue: metadata format version: 1\r\ndate column:\r\nsampling expression:\r\nindex granularity: 512\r\nmode: 5\r\nsign column:\r\nprimary key: tag_key\r\ndata format version: 1\r\npartition key:\r\ngranularity bytes: 10485760\r\n```\r\n\r\nhttps://pastila.nl/?001937cb/1d268e7ce495f0e198eff4f5a2f7a326#IYa+jX24UJSoN0h9BBuIgw==\nHey,\r\n\r\n@den-crane - Have you managed to find any workaround for that issue? \r\n\r\nI encountered the same issue multiple times in the past months (currently on 23.7). Sometimes changing the metdata_version in the zookeeper, restarting and executing the ALTER statement from different replicas (ones that failed before) did the trick. But today I had to create a new table, copy all of the existing data and drop the old one after nothing else worked.\r\n\r\nThanks.\nThere is no workaround. \r\n\r\nI still don't understand what is going on\r\n\r\n```\r\nalter table dw.dim_tag_new add column c String;\r\n\r\nReceived exception from server (version 23.8.2):\r\nCode: 517. DB::Exception: Received from localhost:9000. DB::Exception: \r\nMetadata on replica is not up to date with common metadata in Zookeeper. \r\nIt means that this replica still not applied some of previous alters. \r\nProbably too many alters executing concurrently (highly not recommended). You can retry this error. (CANNOT_ASSIGN_ALTER)\r\n```\r\n\r\nreal puzzle.\r\n\nAny news about this issue? I'm getting this on a 24.1 instance and the only option I see so far is to recreate the table.\r\n\r\n```sql\r\nALTER TABLE d_847c8c.t_5aa6b8f3aef84f18ab09dad679cdb4a3\r\n    MODIFY TTL at + toIntervalDay(8)\r\n\r\nQuery id: 3d78a79e-cc35-4377-8403-3f0cfd2f7da9\r\n\r\n\r\nElapsed: 0.081 sec.\r\n\r\nReceived exception from server (version 24.1.3):\r\nCode: 517. DB::Exception: Received from localhost:9000. DB::Exception: Metadata on replica is not up to date with common metadata in Zookeeper. It means that this replica still not applied some of previous alters. Probably too many alters executing concurrently (highly not recommended). You can retry this error. (CANNOT_ASSIGN_ALTER)\r\n```\r\n\r\n@alesapin, since you're assigned to this issue. Are there any details I can share to ease the debugging process?",
  "created_at": "2024-02-13T15:15:47Z",
  "modified_files": [
    "src/Storages/StorageReplicatedMergeTree.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02989_replicated_merge_tree_invalid_metadata_version.reference",
    "b/tests/queries/0_stateless/02989_replicated_merge_tree_invalid_metadata_version.sql"
  ]
}