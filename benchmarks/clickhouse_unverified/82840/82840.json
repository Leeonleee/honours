{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 82840,
  "instance_id": "ClickHouse__ClickHouse-82840",
  "issue_numbers": [
    "82826"
  ],
  "base_commit": "53edaed76ea4674d6c2b9b152a537dcb673ef4e5",
  "patch": "diff --git a/src/Parsers/ASTQueryWithOutput.cpp b/src/Parsers/ASTQueryWithOutput.cpp\nindex b98122bdb821..a7a6a0ec9c8a 100644\n--- a/src/Parsers/ASTQueryWithOutput.cpp\n+++ b/src/Parsers/ASTQueryWithOutput.cpp\n@@ -97,5 +97,9 @@ bool ASTQueryWithOutput::resetOutputASTIfExist(IAST & ast)\n     return false;\n }\n \n+bool ASTQueryWithOutput::hasOutputOptions() const\n+{\n+    return out_file || format_ast || settings_ast || compression || compression_level;\n+}\n \n }\ndiff --git a/src/Parsers/ASTQueryWithOutput.h b/src/Parsers/ASTQueryWithOutput.h\nindex 87bc4420995a..33d2cac62f64 100644\n--- a/src/Parsers/ASTQueryWithOutput.h\n+++ b/src/Parsers/ASTQueryWithOutput.h\n@@ -26,6 +26,8 @@ class ASTQueryWithOutput : public IAST\n     /// Remove 'FORMAT <fmt> and INTO OUTFILE <file>' if exists\n     static bool resetOutputASTIfExist(IAST & ast);\n \n+    bool hasOutputOptions() const;\n+\n protected:\n     /// NOTE: call this helper at the end of the clone() method of descendant class.\n     void cloneOutputOptions(ASTQueryWithOutput & cloned) const;\ndiff --git a/src/Parsers/ExpressionElementParsers.cpp b/src/Parsers/ExpressionElementParsers.cpp\nindex 29ca7ff1e4f2..acb938be1dd9 100644\n--- a/src/Parsers/ExpressionElementParsers.cpp\n+++ b/src/Parsers/ExpressionElementParsers.cpp\n@@ -125,6 +125,11 @@ bool ParserSubquery::parseImpl(Pos & pos, ASTPtr & node, Expected & expected)\n         if (explain_query.getTableFunction() || explain_query.getTableOverride())\n             throw Exception(ErrorCodes::BAD_ARGUMENTS, \"EXPLAIN in a subquery cannot have a table function or table override\");\n \n+        if (ASTPtr explained_query = explain_query.getExplainedQuery())\n+            if (const auto * explained_query_with_output = dynamic_cast<const ASTQueryWithOutput *>(explained_query.get()))\n+                if (explained_query_with_output->hasOutputOptions())\n+                    throw Exception(ErrorCodes::BAD_ARGUMENTS, \"EXPLAIN in a subquery cannot have output options, such as FORMAT or INTO OUTFILE\");\n+\n         /// Replace subquery `(EXPLAIN <kind> <explain_settings> SELECT ...)`\n         /// with `(SELECT * FROM viewExplain('<kind>', '<explain_settings>', (SELECT ...)))`\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03559_explain_ast_in_subquery.reference b/tests/queries/0_stateless/03559_explain_ast_in_subquery.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/03559_explain_ast_in_subquery.sql b/tests/queries/0_stateless/03559_explain_ast_in_subquery.sql\nnew file mode 100644\nindex 000000000000..638bac1ba61e\n--- /dev/null\n+++ b/tests/queries/0_stateless/03559_explain_ast_in_subquery.sql\n@@ -0,0 +1,1 @@\n+SELECT (EXPLAIN AST SELECT 1 INTO OUTFILE 'a') FROM numbers(0); -- { clientError BAD_ARGUMENTS }\n",
  "problem_statement": "Inconsistent formatting of EXPLAIN AST in a subquery\n> More:\n> \n> ```sql\n> SELECT (EXPLAIN AST SELECT 1 INTO OUTFILE 'a') FROM numbers(0);\n> ``` \n\n _Originally posted by @PedroTadim in [#82105](https://github.com/ClickHouse/ClickHouse/issues/82105#issuecomment-2984197429)_\n",
  "hints_text": "",
  "created_at": "2025-06-29T08:42:35Z",
  "modified_files": [
    "src/Parsers/ASTQueryWithOutput.cpp",
    "src/Parsers/ASTQueryWithOutput.h",
    "src/Parsers/ExpressionElementParsers.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/03559_explain_ast_in_subquery.sql"
  ]
}