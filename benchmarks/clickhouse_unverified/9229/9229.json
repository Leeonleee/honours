{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 9229,
  "instance_id": "ClickHouse__ClickHouse-9229",
  "issue_numbers": [
    "9191"
  ],
  "base_commit": "28528db85ba9cd2fe2e3cdf30bb319f0564d6491",
  "patch": "diff --git a/dbms/src/Interpreters/CrossToInnerJoinVisitor.cpp b/dbms/src/Interpreters/CrossToInnerJoinVisitor.cpp\nindex 596819dcde9d..54d5205c4c29 100644\n--- a/dbms/src/Interpreters/CrossToInnerJoinVisitor.cpp\n+++ b/dbms/src/Interpreters/CrossToInnerJoinVisitor.cpp\n@@ -124,6 +124,10 @@ class CheckExpressionVisitorData\n         {\n             /// leave other comparisons as is\n         }\n+        else if (functionIsLikeOperator(node.name)) /// LIKE, NOT LIKE\n+        {\n+            /// leave as is\n+        }\n         else if (functionIsInOperator(node.name)) /// IN, NOT IN\n         {\n             if (auto ident = node.arguments->children.at(0)->as<ASTIdentifier>())\ndiff --git a/dbms/src/Interpreters/misc.h b/dbms/src/Interpreters/misc.h\nindex d5e2894bb4cf..e2f34375dc02 100644\n--- a/dbms/src/Interpreters/misc.h\n+++ b/dbms/src/Interpreters/misc.h\n@@ -13,4 +13,9 @@ inline bool functionIsInOrGlobalInOperator(const std::string & name)\n     return functionIsInOperator(name) || name == \"globalIn\" || name == \"globalNotIn\";\n }\n \n+inline bool functionIsLikeOperator(const std::string & name)\n+{\n+    return name == \"like\" || name == \"notLike\";\n+}\n+\n }\n",
  "test_patch": "diff --git a/dbms/tests/queries/0_stateless/01083_cross_to_inner_with_like.reference b/dbms/tests/queries/0_stateless/01083_cross_to_inner_with_like.reference\nnew file mode 100644\nindex 000000000000..92b51afb5444\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/01083_cross_to_inner_with_like.reference\n@@ -0,0 +1,3 @@\n+SELECT \\n    k, \\n    r.k, \\n    name\\nFROM n\\nALL INNER JOIN r ON k = r.k\\nWHERE (k = r.k) AND (name = \\'A\\')\n+SELECT \\n    k, \\n    r.k, \\n    name\\nFROM n\\nALL INNER JOIN r ON k = r.k\\nWHERE (k = r.k) AND (name LIKE \\'A%\\')\n+SELECT \\n    k, \\n    r.k, \\n    name\\nFROM n\\nALL INNER JOIN r ON k = r.k\\nWHERE (k = r.k) AND (name NOT LIKE \\'A%\\')\ndiff --git a/dbms/tests/queries/0_stateless/01083_cross_to_inner_with_like.sql b/dbms/tests/queries/0_stateless/01083_cross_to_inner_with_like.sql\nnew file mode 100644\nindex 000000000000..9e03502c11b8\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/01083_cross_to_inner_with_like.sql\n@@ -0,0 +1,15 @@\n+DROP TABLE IF EXISTS n;\n+DROP TABLE IF EXISTS r;\n+\n+CREATE TABLE n (k UInt32) ENGINE = Memory;\n+CREATE TABLE r (k UInt32, name String) ENGINE = Memory;\n+\n+SET enable_debug_queries = 1;\n+SET enable_optimize_predicate_expression = 0;\n+\n+ANALYZE SELECT * FROM n, r WHERE n.k = r.k AND r.name = 'A';\n+ANALYZE SELECT * FROM n, r WHERE n.k = r.k AND r.name LIKE 'A%';\n+ANALYZE SELECT * FROM n, r WHERE n.k = r.k AND r.name NOT LIKE 'A%';\n+\n+DROP TABLE n;\n+DROP TABLE r;\n",
  "problem_statement": "LIKE does not allow to rewrite CROSS JOIN to INNER JOIN\n**Describe the bug or unexpected behaviour**\r\nLIKE does not allow to rewrite CROSS JOIN to INNER JOIN\r\n\r\n**How to reproduce**\r\n```\r\nANALYZE SELECT *\r\nFROM nation AS n2\r\n, region AS r2\r\nWHERE (n2.n_regionkey = r2.r_regionkey) AND (toString(r2.r_name) LIKE 'EUROPE')\r\n\r\n\u250c\u2500explain\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n SELECT\r\n    n_nationkey,\r\n    n_name,\r\n    n_regionkey,\r\n    n_comment,\r\n    r_regionkey,\r\n    r_name,\r\n    r_comment\r\nFROM nation AS n2\r\nCROSS JOIN region AS r2\r\nWHERE (n_regionkey = r_regionkey) AND (toString(r_name) LIKE 'EUROPE') \r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n\r\nANALYZE SELECT *\r\nFROM nation AS n2\r\n, region AS r2\r\nWHERE (n2.n_regionkey = r2.r_regionkey) AND (toString(r2.r_name) = 'EUROPE')\r\n\r\n\u250c\u2500explain\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\nSELECT\r\n    n_nationkey,\r\n    n_name,\r\n    n_regionkey,\r\n    n_comment,\r\n    r_regionkey,\r\n    r_name,\r\n    r_comment\r\nFROM nation AS n2\r\nALL INNER JOIN region AS r2 ON n_regionkey = r_regionkey\r\nWHERE (n_regionkey = r_regionkey) AND (toString(r_name) = 'EUROPE') \r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n```\r\n\n",
  "hints_text": "",
  "created_at": "2020-02-19T17:24:50Z",
  "modified_files": [
    "dbms/src/Interpreters/CrossToInnerJoinVisitor.cpp",
    "dbms/src/Interpreters/misc.h"
  ],
  "modified_test_files": [
    "b/dbms/tests/queries/0_stateless/01083_cross_to_inner_with_like.reference",
    "b/dbms/tests/queries/0_stateless/01083_cross_to_inner_with_like.sql"
  ]
}