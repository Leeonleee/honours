{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 81895,
  "instance_id": "ClickHouse__ClickHouse-81895",
  "issue_numbers": [
    "61890"
  ],
  "base_commit": "47542262454c5d6837cab9e0c850a51e6732ddbc",
  "patch": "diff --git a/src/Server/WebUIRequestHandler.cpp b/src/Server/WebUIRequestHandler.cpp\nindex 86b1f1c582b6..44d3d2b4ab8b 100644\n--- a/src/Server/WebUIRequestHandler.cpp\n+++ b/src/Server/WebUIRequestHandler.cpp\n@@ -91,8 +91,6 @@ void JavaScriptWebUIRequestHandler::handleRequest(HTTPServerRequest & request, H\n         response.setStatusAndReason(Poco::Net::HTTPResponse::HTTP_NOT_FOUND);\n         *response.send() << \"Not found.\\n\";\n     }\n-\n-    handle(request, response, {reinterpret_cast<const char *>(gresource_binary_htmlData), gresource_binary_htmlSize}, http_response_headers_override);\n }\n \n }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03545_http_content_leftovers.reference b/tests/queries/0_stateless/03545_http_content_leftovers.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/03545_http_content_leftovers.sh b/tests/queries/0_stateless/03545_http_content_leftovers.sh\nnew file mode 100755\nindex 000000000000..d926ebf39644\n--- /dev/null\n+++ b/tests/queries/0_stateless/03545_http_content_leftovers.sh\n@@ -0,0 +1,7 @@\n+#!/usr/bin/env bash\n+\n+CUR_DIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CUR_DIR\"/../shell_config.sh\n+\n+${CLICKHOUSE_CURL} --raw -sS \"${CLICKHOUSE_PORT_HTTP_PROTO}://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT_HTTP}/js/uplot.js\" | grep -F 'HTTP/' ||:\n",
  "problem_statement": "Wrong response to `/js/uplot.js` and `/js/lz-string.js` while NGINX proxying\n**Wrong response to `/js/uplot.js` and `/js/lz-string.js` while NGINX proxying**\r\n\r\nStatic `/js/uplot.js` and `/js/lz-string.js` used by default dashboard on `/dashboard` url. When i send request it directly to CH all works fine, but when between client and CH exists fully proxing Nginx, Clickhouse successfully return wrong files. \r\n\r\n\r\n**Reproducing**\r\n- `24.2.2.71` latest stable\r\n- `24.2.1.2248`\r\n- `head`\r\n\r\n**Working correctly**\r\n- `24.1.7.18`\r\n\r\n\r\nNginx and Clickhouse logs are empty (nothing unusual) \r\n\r\n\r\nCorrect response body for `/js/lz-string.js`\r\n\r\n```\r\nvar LZString=function(){ <...> LONG MINIFIED JS MODULE <...> }\r\n```\r\n\r\nReceiving after proxy:\r\n\r\n```\r\nvar LZString=function(){ <...> LONG MINIFIED JS MODULE <...> }\r\n\r\nHTTP/1.0 200 OK\r\nDate: Mon, 25 Mar 2024 22:42:32 GMT\r\nConnection: Close\r\nContent-Type: text/html; charset=UTF-8\r\nX-ClickHouse-Summary: {\"read_rows\":\"0\",\"read_bytes\":\"0\",\"written_rows\":\"0\",\"written_bytes\":\"0\",\"total_rows_to_read\":\"0\",\"result_rows\":\"0\",\"result_bytes\":\"0\",\"elapsed_ns\":\"9292\"}\r\n\r\n<!doctype html>\r\n<html>\r\n<head>\r\n <...> CONTENTS OF binary.html (ClickHouse Binary Viewer) <...>\r\n</body>\r\n</html>\r\n```\r\n\r\n**How to reproduce**\r\n1. Create `docker-compose.yaml` config\r\n``` yaml\r\n# docker-compose.yaml\r\nversion: '3.7'\r\n\r\nservices:\r\n  clickhouse:\r\n    image: clickhouse/clickhouse-server:24.2.2.71-alpine\r\n    ports:\r\n      - 8123:8123\r\n\r\n  nginx:\r\n    image: nginx:stable-alpine3.17\r\n    volumes:\r\n      - ./nginx.conf:/etc/nginx/conf.d/default.conf\r\n    ports:\r\n      - 9999:80\r\n```\r\n2. Create nginx config in same folder:\r\n``` nginx\r\n# nginx.conf\r\nserver {\r\n  location / {\r\n    proxy_pass http://clickhouse:8123;\r\n  }\r\n\r\n  listen 80;\r\n}\r\n```\r\n3. `docker compose up`\r\n4. `curl localhost:9999/js/lz-string.js` vs `curl localhost:8123/js/lz-string.js` returns different responses\r\n\r\n\r\n**Additional context**\r\n\r\nI think problem around this factory [src/Server/HTTPHandlerFactory.cpp#L254](https://github.com/ClickHouse/ClickHouse/blob/c7e4d97e5a1c5e58a0bd5a04e4aa5adce630d06b/src/Server/HTTPHandlerFactory.cpp#L254) which changed in #60389 and new handlers implementation. Also i don't found any places which can broken by proxy (like routing by browser agent)\r\n\r\nUnfortunately i haven't time to build CH and try to fix it. \r\n\r\n_And last: Why you issues's template use **bold** for header instead header for header. Its looks ugly_ \r\n\n",
  "hints_text": "Reproduced.",
  "created_at": "2025-06-15T22:39:45Z",
  "modified_files": [
    "src/Server/WebUIRequestHandler.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/03545_http_content_leftovers.sh"
  ]
}