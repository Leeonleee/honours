{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 10217,
  "instance_id": "ClickHouse__ClickHouse-10217",
  "issue_numbers": [
    "10180"
  ],
  "base_commit": "bc00e6463a58ad4253e6b63e92bf4371b05fc453",
  "patch": "diff --git a/src/Storages/StorageView.cpp b/src/Storages/StorageView.cpp\nindex 05feeb7d786c..78e3c50a8795 100644\n--- a/src/Storages/StorageView.cpp\n+++ b/src/Storages/StorageView.cpp\n@@ -12,13 +12,12 @@\n #include <Storages/StorageView.h>\n #include <Storages/StorageFactory.h>\n \n-#include <DataStreams/MaterializingBlockInputStream.h>\n-\n #include <Common/typeid_cast.h>\n \n #include <Processors/Pipe.h>\n #include <Processors/Sources/SourceFromInputStream.h>\n #include <Processors/Transforms/MaterializingTransform.h>\n+#include <Processors/Transforms/ConvertingTransform.h>\n \n \n namespace DB\n@@ -78,8 +77,15 @@ Pipes StorageView::read(\n     /// It's expected that the columns read from storage are not constant.\n     /// Because method 'getSampleBlockForColumns' is used to obtain a structure of result in InterpreterSelectQuery.\n     for (auto & pipe : pipes)\n+    {\n         pipe.addSimpleTransform(std::make_shared<MaterializingTransform>(pipe.getHeader()));\n \n+        /// And also convert to expected structure.\n+        pipe.addSimpleTransform(std::make_shared<ConvertingTransform>(\n+            pipe.getHeader(), getSampleBlockForColumns(column_names),\n+            ConvertingTransform::MatchColumnsMode::Name, context));\n+    }\n+\n     return pipes;\n }\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01124_view_bad_types.reference b/tests/queries/0_stateless/01124_view_bad_types.reference\nnew file mode 100644\nindex 000000000000..af98bcd63975\n--- /dev/null\n+++ b/tests/queries/0_stateless/01124_view_bad_types.reference\n@@ -0,0 +1,10 @@\n+0\t0\n+1\t1\n+2\t2\n+3\t3\n+4\t4\n+5\t5\n+6\t6\n+7\t7\n+8\t8\n+9\t9\ndiff --git a/tests/queries/bugs/view_bad_types.sql b/tests/queries/0_stateless/01124_view_bad_types.sql\nsimilarity index 84%\nrename from tests/queries/bugs/view_bad_types.sql\nrename to tests/queries/0_stateless/01124_view_bad_types.sql\nindex 38daabfd6b8e..81fc53930c19 100644\n--- a/tests/queries/bugs/view_bad_types.sql\n+++ b/tests/queries/0_stateless/01124_view_bad_types.sql\n@@ -5,7 +5,7 @@ INSERT INTO test.table SELECT * FROM system.numbers LIMIT 10;\n DROP TABLE IF EXISTS test.view;\n CREATE VIEW test.view (x UInt64) AS SELECT * FROM test.table;\n \n-SELECT x, any(x) FROM test.view GROUP BY x;\n+SELECT x, any(x) FROM test.view GROUP BY x ORDER BY x;\n \n DROP TABLE test.view;\n DROP TABLE test.table;\n",
  "problem_statement": "Incorrect results if view and table have different types for a column.\n**Describe the bug**\r\nIncorrect results if view and table have different types for a column.\r\n``` sql\r\nCREATE TABLE test.table (x UInt16) ENGINE = TinyLog;\r\nINSERT INTO test.table SELECT * FROM system.numbers LIMIT 10;\r\nCREATE VIEW test.view (x UInt64) AS SELECT * FROM test.table;\r\n\r\nSELECT\r\n    x,\r\n    any(x)\r\nFROM test.view\r\nGROUP BY x\r\n\r\n\u250c\u2500x\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500any(x)\u2500\u2510\r\n\u2502 0 \u2502     844433520132096 \u2502\r\n\u2502 1 \u2502    1970350607106052 \u2502\r\n\u2502 2 \u2502 7310600470316777480 \u2502\r\n\u2502 3 \u2502                   0 \u2502\r\n\u2502 4 \u2502                   0 \u2502\r\n\u2502 5 \u2502                   0 \u2502\r\n\u2502 6 \u2502                   0 \u2502\r\n\u2502 7 \u2502                   0 \u2502\r\n\u2502 8 \u2502                   0 \u2502\r\n\u2502 9 \u2502                   0 \u2502\r\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\n**How to reproduce**\r\nhttps://github.com/ClickHouse/ClickHouse/blob/master/tests/queries/bugs/view_bad_types.sql\r\n\r\n**Expected behavior**\r\n``` sql\r\nCREATE VIEW test.view3\r\n(\r\n    `x` UInt16\r\n) AS\r\nSELECT *\r\nFROM test.table\r\n\r\nSELECT\r\n    x,\r\n    any(x)\r\nFROM test.view2\r\nGROUP BY x\r\n\r\n\u250c\u2500x\u2500\u252c\u2500any(x)\u2500\u2510\r\n\u2502 0 \u2502      0 \u2502\r\n\u2502 1 \u2502      1 \u2502\r\n\u2502 2 \u2502      2 \u2502\r\n\u2502 3 \u2502      3 \u2502\r\n\u2502 4 \u2502      4 \u2502\r\n\u2502 5 \u2502      5 \u2502\r\n\u2502 6 \u2502      6 \u2502\r\n\u2502 7 \u2502      7 \u2502\r\n\u2502 8 \u2502      8 \u2502\r\n\u2502 9 \u2502      9 \u2502\r\n\u2514\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\n",
  "hints_text": "May be related: https://github.com/ClickHouse/ClickHouse/issues/10022",
  "created_at": "2020-04-12T21:08:27Z",
  "modified_files": [
    "src/Storages/StorageView.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/01124_view_bad_types.reference",
    "tests/queries/bugs/view_bad_types.sql"
  ]
}