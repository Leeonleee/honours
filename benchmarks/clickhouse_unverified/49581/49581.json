{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 49581,
  "instance_id": "ClickHouse__ClickHouse-49581",
  "issue_numbers": [
    "49567"
  ],
  "base_commit": "3f0c3602bf0b39d72d85a6fb875ba093763222a1",
  "patch": "diff --git a/src/AggregateFunctions/AggregateFunctionNothing.h b/src/AggregateFunctions/AggregateFunctionNothing.h\nindex 8491e8edfaad..8280d72c0854 100644\n--- a/src/AggregateFunctions/AggregateFunctionNothing.h\n+++ b/src/AggregateFunctions/AggregateFunctionNothing.h\n@@ -13,6 +13,11 @@ namespace DB\n {\n struct Settings;\n \n+namespace ErrorCodes\n+{\n+    extern const int INCORRECT_DATA;\n+}\n+\n \n /** Aggregate function that takes arbitrary number of arbitrary arguments and does nothing.\n   */\n@@ -69,7 +74,8 @@ class AggregateFunctionNothing final : public IAggregateFunctionHelper<Aggregate\n     {\n         [[maybe_unused]] char symbol;\n         readChar(symbol, buf);\n-        assert(symbol == '\\0');\n+        if (symbol != '\\0')\n+            throw Exception(ErrorCodes::INCORRECT_DATA, \"Incorrect state of aggregate function 'nothing', it should contain exactly one zero byte.\");\n     }\n \n     void insertResultInto(AggregateDataPtr __restrict, IColumn & to, Arena *) const override\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02731_nothing_deserialization.reference b/tests/queries/0_stateless/02731_nothing_deserialization.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02731_nothing_deserialization.sql b/tests/queries/0_stateless/02731_nothing_deserialization.sql\nnew file mode 100644\nindex 000000000000..7526bce3578f\n--- /dev/null\n+++ b/tests/queries/0_stateless/02731_nothing_deserialization.sql\n@@ -0,0 +1,1 @@\n+SELECT CAST('\\x01\\x00' AS AggregateFunction(nothingArrayIf, Array(Nullable(Nothing)), Nullable(Nothing))); -- { serverError INCORRECT_DATA }\n",
  "problem_statement": "Assertion `symbol == '\\0'' failed.\nhttps://s3.amazonaws.com/clickhouse-test-reports/0/38b2f94bfa225b21749d0ffab0185b03f9fec417/fuzzer_astfuzzerdebug/report.html\r\n\r\n```\r\nWITH NULL AS a\r\nSELECT\r\n    [1023, -2147483648],\r\n    quantilesState(0.0001)(1024),\r\n    countArrayIfState([NULL], NULL),\r\n    [1048577, 100000000000000000000., -2147483647],\r\n    countArrayState([NULL]),\r\n    identity(1048575),\r\n    a\r\nFROM numbers(257)\r\n    WITH TOTALS\r\n\r\n**clickhouse-client**: /build/src/AggregateFunctions/AggregateFunctionNothing.h:72: virtual void DB::AggregateFunctionNothing::deserialize(__restrict DB::AggregateDataPtr, DB::ReadBuffer &, std::optional<size_t>, DB::Arena *) const: Assertion `symbol == '\\0'' failed.\r\n```\n",
  "hints_text": "core is strange\r\n```\r\n(gdb) bt\r\n#0  0x00007f1c5d3a700b in __GI_raise (sig=0, sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:44\r\n#1  0x00007f1c5d386859 in __GI_abort () at abort.c:79\r\n#2  0x00007f1c5d386729 in __assert_fail_base (fmt=0x7f1c5d51c588 \"%s%s%s:%u: %s%sAssertion `%s' failed.\\n%n\", assertion=0xfd65910 \"symbol == '\\\\0'\", file=0xfd6591f \"/build/src/AggregateFunctions/AggregateFunctionNothing.h\", line=72, function=<optimized out>) at assert.c:92\r\n#3  0x00007f1c5d397fd6 in __GI___assert_fail (assertion=0x2 <error: Cannot access memory at address 0x2>, file=0x7fffe79e8dd0 \"\", line=72, function=0x7f1c5d3a700b <__GI_raise+155> \"\\017\\005\\211\\306D\\211\", <incomplete sequence \\352>) at assert.c:101\r\n#4  0x00007fffe79e90e0 in ?? ()\r\n#5  0x000000001a2a9d00 in ?? ()\r\n#6  0x00007fffe79f2c80 in ?? ()\r\n#7  0x00000000267e12e4 in DB::AggregateFunctionNothing::deserialize (this=0x2c736e6f69746172, buf=...) at /build/src/AggregateFunctions/AggregateFunctionNothing.h:72\r\nBacktrace stopped: previous frame inner to this frame (corrupt stack?)\r\n```\nGood finding:\r\n\r\n```\r\nmilovidov-desktop :) SELECT countArrayIfState([NULL], NULL), 'Hello'\r\n\r\nException on client:\r\nCode: 62. DB::Exception: Syntax error (data type): failed at position 1 (''Hello''): 'Hello'. Expected one of: data type, nested table, identifier: while receiving packet from localhost:9000. (SYNTAX_ERROR)\r\n```\r\n\r\n```\r\nSELECT CAST('\\x01\\x00' AS AggregateFunction(nothingArrayIf, Array(Nullable(Nothing)), Nullable(Nothing)))\r\n```\r\n\r\nAssertion failed.\r\n\r\n> core is strange\r\n\r\nIt is not strange for `gdb`. We build code with the latest clang and LLVM; older gdb can be confused with the debug info.\r\nYou can use LLDB-16 instead.",
  "created_at": "2023-05-06T00:20:31Z",
  "modified_files": [
    "src/AggregateFunctions/AggregateFunctionNothing.h"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02731_nothing_deserialization.sql"
  ]
}