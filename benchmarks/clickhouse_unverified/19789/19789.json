{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 19789,
  "instance_id": "ClickHouse__ClickHouse-19789",
  "issue_numbers": [
    "19769"
  ],
  "base_commit": "10160e5adf77e0ec0182e0c46a6688780abb5824",
  "patch": "diff --git a/src/Functions/greatCircleDistance.cpp b/src/Functions/greatCircleDistance.cpp\nindex 8b9df91e1175..801f8b3da7f3 100644\n--- a/src/Functions/greatCircleDistance.cpp\n+++ b/src/Functions/greatCircleDistance.cpp\n@@ -95,7 +95,7 @@ void geodistInit()\n \n         sphere_metric_meters_lut[i] = static_cast<float>(sqr((EARTH_DIAMETER * PI / 360) * cos(latitude)));\n \n-        sphere_metric_lut[i] = cosf(latitude);\n+        sphere_metric_lut[i] = sqrf(cosf(latitude));\n     }\n }\n \n@@ -182,7 +182,7 @@ float distance(float lon1deg, float lat1deg, float lon2deg, float lat2deg)\n         ///  (Remember how a plane flies from Moscow to New York)\n         /// But if longitude is close but latitude is different enough, there is no difference between meridian and great circle line.\n \n-        float latitude_midpoint = (lat1deg + lat2deg + 180) * METRIC_LUT_SIZE / 360; // [-90, 90] degrees -> [0, KTABLE] indexes\n+        float latitude_midpoint = (lat1deg + lat2deg + 180) * METRIC_LUT_SIZE / 360; // [-90, 90] degrees -> [0, METRIC_LUT_SIZE] indexes\n         size_t latitude_midpoint_index = floatToIndex(latitude_midpoint) & (METRIC_LUT_SIZE - 1);\n \n         /// This is linear interpolation between two table items at index \"latitude_midpoint_index\" and \"latitude_midpoint_index + 1\".\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/01044_great_circle_angle.reference b/tests/queries/0_stateless/01044_great_circle_angle.reference\nindex 60a616c71870..ebdeaa10067e 100644\n--- a/tests/queries/0_stateless/01044_great_circle_angle.reference\n+++ b/tests/queries/0_stateless/01044_great_circle_angle.reference\n@@ -17,11 +17,11 @@\n \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258e\n \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258d\n \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258d\n-\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c\n+\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258d\n \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c\n-\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258b\n-\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258b\n-\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258b\n+\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c\n+\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c\n+\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c\n \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c\n \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258d\n \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258d\ndiff --git a/tests/queries/0_stateless/01678_great_circle_angle.reference b/tests/queries/0_stateless/01678_great_circle_angle.reference\nnew file mode 100644\nindex 000000000000..0373970e3bda\n--- /dev/null\n+++ b/tests/queries/0_stateless/01678_great_circle_angle.reference\n@@ -0,0 +1,5 @@\n+0.1224\n+0.7071\n+0.7135\n+10007554\n+10007554\ndiff --git a/tests/queries/0_stateless/01678_great_circle_angle.sql b/tests/queries/0_stateless/01678_great_circle_angle.sql\nnew file mode 100644\nindex 000000000000..124c7bfadf22\n--- /dev/null\n+++ b/tests/queries/0_stateless/01678_great_circle_angle.sql\n@@ -0,0 +1,6 @@\n+SELECT round(greatCircleAngle(0, 45, 0.1, 45.1), 4);\n+SELECT round(greatCircleAngle(0, 45, 1, 45), 4);\n+SELECT round(greatCircleAngle(0, 45, 1, 45.1), 4);\n+\n+SELECT round(greatCircleDistance(0, 0, 0, 90), 4);\n+SELECT round(greatCircleDistance(0, 0, 90, 0), 4);\n",
  "problem_statement": "greatCircleAngle is very inaccurate\n**Describe the bug**\r\n`greatCircleAngle` function is very inaccurate for some arguments. Examples:\r\n\r\n```\r\n\u250c\u2500greatCircleAngle(0, 45, 0.1, 45.1)\u2500\u2510\r\n\u2502                         0.13063148 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\nBut must be 0.1224388\r\n\r\n\u250c\u2500greatCircleAngle(0, 45, 1, 45)\u2500\u2510\r\n\u2502                      0.8408964 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\nMust be 0.7071023\r\n\r\n\u250c\u2500greatCircleAngle(0, 45, 1, 45.1)\u2500\u2510\r\n\u2502                       0.84645635 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\nMust be 0.7135268\r\n```\n",
  "hints_text": "It contains a bug.",
  "created_at": "2021-01-29T02:06:35Z",
  "modified_files": [
    "src/Functions/greatCircleDistance.cpp"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/01044_great_circle_angle.reference",
    "b/tests/queries/0_stateless/01678_great_circle_angle.reference",
    "b/tests/queries/0_stateless/01678_great_circle_angle.sql"
  ]
}