{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 32508,
  "instance_id": "ClickHouse__ClickHouse-32508",
  "issue_numbers": [
    "32458"
  ],
  "base_commit": "6cfb1177325fea43f043aa5f60aebf20bba20082",
  "patch": "diff --git a/src/Interpreters/join_common.cpp b/src/Interpreters/join_common.cpp\nindex bf20bef69920..b571a8e8e103 100644\n--- a/src/Interpreters/join_common.cpp\n+++ b/src/Interpreters/join_common.cpp\n@@ -225,7 +225,13 @@ void removeColumnNullability(ColumnWithTypeAndName & column)\n \n         if (column.column && column.column->isNullable())\n         {\n+            column.column = column.column->convertToFullColumnIfConst();\n             const auto * nullable_col = checkAndGetColumn<ColumnNullable>(*column.column);\n+            if (!nullable_col)\n+            {\n+                throw DB::Exception(ErrorCodes::LOGICAL_ERROR, \"Column '{}' is expected to be nullable\", column.dumpStructure());\n+            }\n+\n             MutableColumnPtr mutable_column = nullable_col->getNestedColumn().cloneEmpty();\n             insertFromNullableOrDefault(mutable_column, nullable_col);\n             column.column = std::move(mutable_column);\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02133_issue_32458.reference b/tests/queries/0_stateless/02133_issue_32458.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02133_issue_32458.sql b/tests/queries/0_stateless/02133_issue_32458.sql\nnew file mode 100644\nindex 000000000000..16af361db7a6\n--- /dev/null\n+++ b/tests/queries/0_stateless/02133_issue_32458.sql\n@@ -0,0 +1,13 @@\n+DROP TABLE IF EXISTS t1;\n+DROP TABLE IF EXISTS t2;\n+\n+CREATE TABLE t1 (`id` Int32, `key` String) ENGINE = Memory;\n+CREATE TABLE t2 (`id` Int32, `key` String) ENGINE = Memory;\n+\n+INSERT INTO t1 VALUES (0, '');\n+INSERT INTO t2 VALUES (0, '');\n+\n+SELECT * FROM t1 ANY INNER JOIN t2 ON ((NULL = t1.key) = t2.id) AND (('' = t1.key) = t2.id);\n+\n+DROP TABLE IF EXISTS t1;\n+DROP TABLE IF EXISTS t2;\n",
  "problem_statement": "Segmentation fault in JoinCommon::removeColumnNullability\n\r\n**Describe the bug**\r\n[A link to the report](https://s3.amazonaws.com/clickhouse-test-reports/32291/2f43445a34c91beb1104422308ba5abfdf7be5bb/fuzzer_astfuzzertsan,actions//report.html)\r\n\r\n**How to reproduce**\r\n\r\n```SQL\r\nCREATE TABLE t1 (`id` Int32, `key` String, `key2` String) ENGINE = TinyLog;\r\nCREATE TABLE t2 (`id` Int32, `key` String, `key2` String) ENGINE = TinyLog;\r\nSELECT (t1.id = t2.id) AND (t2.key = t2.key2) AND ((t1.id = t2.id) AND (t2.key = t2.key2) AND (t1.key = t1.key2) AND (t2.key2 = NULL)) AND (t1.key = t1.key2) AND (t2.key2 = NULL), NULL FROM t1 ANY INNER JOIN t2 ON (t1.key = t1\r\n.key2) AND (NULL = t1.key) AND (t2.key = t2.key2) AND ((NULL = t1.key) = t2.id) AND (('' = t1.key) = t2.id) AND (t2.key2 = NULL);\r\n```\r\n\n",
  "hints_text": "the `t2.id` was passed to here\r\n https://github.com/ClickHouse/ClickHouse/blob/ef42cd6821719f272f6de13f1cd0f476a45793b8/src/Interpreters/join_common.cpp#L226-L233\r\n\r\nand `nullable_col`  is null.",
  "created_at": "2021-12-10T12:58:49Z",
  "modified_files": [
    "src/Interpreters/join_common.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02133_issue_32458.sql"
  ]
}