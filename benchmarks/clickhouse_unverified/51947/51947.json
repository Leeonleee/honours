{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 51947,
  "instance_id": "ClickHouse__ClickHouse-51947",
  "issue_numbers": [
    "50669"
  ],
  "base_commit": "aac8eda40a1ef610970e4a6eb35c84fff145d262",
  "patch": "diff --git a/src/Interpreters/ActionsDAG.cpp b/src/Interpreters/ActionsDAG.cpp\nindex 906875dd314d..e68e2580231b 100644\n--- a/src/Interpreters/ActionsDAG.cpp\n+++ b/src/Interpreters/ActionsDAG.cpp\n@@ -465,8 +465,12 @@ void ActionsDAG::removeUnusedActions(const Names & required_names, bool allow_re\n void ActionsDAG::removeUnusedActions(bool allow_remove_inputs, bool allow_constant_folding)\n {\n     std::unordered_set<const Node *> visited_nodes;\n+    std::unordered_set<const Node *> used_inputs;\n     std::stack<Node *> stack;\n \n+    for (const auto * input : inputs)\n+        used_inputs.insert(input);\n+\n     for (const auto * node : outputs)\n     {\n         visited_nodes.insert(node);\n@@ -484,7 +488,7 @@ void ActionsDAG::removeUnusedActions(bool allow_remove_inputs, bool allow_consta\n             stack.push(&node);\n         }\n \n-        if (node.type == ActionType::INPUT && !allow_remove_inputs)\n+        if (node.type == ActionType::INPUT && !allow_remove_inputs && used_inputs.contains(&node))\n             visited_nodes.insert(&node);\n     }\n \n@@ -1365,8 +1369,8 @@ ActionsDAGPtr ActionsDAG::merge(ActionsDAG && first, ActionsDAG && second)\n {\n     first.mergeInplace(std::move(second));\n \n-    /// Drop unused inputs and, probably, some actions.\n-    first.removeUnusedActions();\n+    /// Some actions could become unused. Do not drop inputs to preserve the header.\n+    first.removeUnusedActions(false);\n \n     return std::make_shared<ActionsDAG>(std::move(first));\n }\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02812_bug_with_unused_join_columns.reference b/tests/queries/0_stateless/02812_bug_with_unused_join_columns.reference\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/queries/0_stateless/02812_bug_with_unused_join_columns.sql b/tests/queries/0_stateless/02812_bug_with_unused_join_columns.sql\nnew file mode 100644\nindex 000000000000..6c801b5b73ec\n--- /dev/null\n+++ b/tests/queries/0_stateless/02812_bug_with_unused_join_columns.sql\n@@ -0,0 +1,1 @@\n+SELECT concat(func.name, comb.name) AS x FROM system.functions AS func JOIN system.aggregate_function_combinators AS comb using name WHERE is_aggregate settings allow_experimental_analyzer=1;\n",
  "problem_statement": "LOGICAL_ERROR when use DROP unused join columns and filter push down at the same time in new analyzer\nreproduce it on master by a very easy SQL\r\n```\r\n        SELECT \r\n          concat(func.name, comb.name) AS x \r\n        FROM \r\n          system.functions AS func \r\n          JOIN system.aggregate_function_combinators AS comb using name\r\n        WHERE \r\n          is_aggregate settings allow_experimental_analyzer=1;\r\n\r\nSELECT concat(func.name, comb.name) AS x\r\nFROM system.functions AS func\r\nINNER JOIN system.aggregate_function_combinators AS comb USING (name)\r\nWHERE is_aggregate\r\n\r\nQuery id: bdb88424-dbb8-45b6-b278-f074af7e69b3\r\n\r\n\r\n0 rows in set. Elapsed: 0.005 sec. \r\n\r\nReceived exception from server (version 23.5.1):\r\nCode: 49. DB::Exception: Received from localhost:9000. DB::Exception: Invalid number of columns in chunk pushed to OutputPort. Expected 3, found 13\r\nHeader: func.is_aggregate_2 UInt8 Const(size = 0, UInt8(size = 1)), func.name_0 String String(size = 0), comb.name_1 String String(size = 0)\r\nChunk:  Const(size = 0, UInt8(size = 1)) String(size = 0) UInt8(size = 0) String(size = 0) String(size = 0) Int8(size = 0) String(size = 0) String(size = 0) String(size = 0) String(size = 0) String(size = 0) String(size = 0) String(size = 0)\r\n. (LOGICAL_ERROR)\r\n```\r\nhttps://github.com/ClickHouse/ClickHouse/pull/50430#issuecomment-1576860893 can help explain why it fails\n",
  "hints_text": "",
  "created_at": "2023-07-07T12:21:40Z",
  "modified_files": [
    "src/Interpreters/ActionsDAG.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02812_bug_with_unused_join_columns.sql"
  ]
}