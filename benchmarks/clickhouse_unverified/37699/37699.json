{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 37699,
  "instance_id": "ClickHouse__ClickHouse-37699",
  "issue_numbers": [
    "37280"
  ],
  "base_commit": "f84b5a74ab1aa3ed57516e9e4ad219e4ab5100d6",
  "patch": "diff --git a/src/Access/ContextAccess.cpp b/src/Access/ContextAccess.cpp\nindex 46fdba9d65e6..89cdcc762348 100644\n--- a/src/Access/ContextAccess.cpp\n+++ b/src/Access/ContextAccess.cpp\n@@ -445,10 +445,11 @@ bool ContextAccess::checkAccessImplHelper(AccessFlags flags, const Args &... arg\n         const AccessFlags dictionary_ddl = AccessType::CREATE_DICTIONARY | AccessType::DROP_DICTIONARY;\n         const AccessFlags function_ddl = AccessType::CREATE_FUNCTION | AccessType::DROP_FUNCTION;\n         const AccessFlags table_and_dictionary_ddl = table_ddl | dictionary_ddl;\n+        const AccessFlags table_and_dictionary_and_function_ddl = table_ddl | dictionary_ddl | function_ddl;\n         const AccessFlags write_table_access = AccessType::INSERT | AccessType::OPTIMIZE;\n         const AccessFlags write_dcl_access = AccessType::ACCESS_MANAGEMENT - AccessType::SHOW_ACCESS;\n \n-        const AccessFlags not_readonly_flags = write_table_access | table_and_dictionary_ddl | write_dcl_access | AccessType::SYSTEM | AccessType::KILL_QUERY;\n+        const AccessFlags not_readonly_flags = write_table_access | table_and_dictionary_and_function_ddl | write_dcl_access | AccessType::SYSTEM | AccessType::KILL_QUERY;\n         const AccessFlags not_readonly_1_flags = AccessType::CREATE_TEMPORARY_TABLE;\n \n         const AccessFlags ddl_flags = table_ddl | dictionary_ddl | function_ddl;\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02315_readonly_create_function.reference b/tests/queries/0_stateless/02315_readonly_create_function.reference\nnew file mode 100644\nindex 000000000000..573541ac9702\n--- /dev/null\n+++ b/tests/queries/0_stateless/02315_readonly_create_function.reference\n@@ -0,0 +1,1 @@\n+0\ndiff --git a/tests/queries/0_stateless/02315_readonly_create_function.sh b/tests/queries/0_stateless/02315_readonly_create_function.sh\nnew file mode 100755\nindex 000000000000..70e27e9ede97\n--- /dev/null\n+++ b/tests/queries/0_stateless/02315_readonly_create_function.sh\n@@ -0,0 +1,8 @@\n+#!/usr/bin/env bash\n+\n+CURDIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CURDIR\"/../shell_config.sh\n+\n+$CLICKHOUSE_CLIENT --readonly 1 --query \"CREATE FUNCTION test_function AS (x) -> x + 1;\" 2>&1 | grep -q \"Code: 164\"\n+echo $?;\n",
  "problem_statement": "Users can create functions in the case of readonly.\nclickhouse version: 22.3.6.5\r\n\r\nusers.yaml :\r\n```\r\n  public_ro:\r\n    password: \"test\"\r\n    networks:\r\n      ip: '::/0'\r\n    profile: readonly\r\n    quota: default\r\n    allow_databases:\r\n      - database: public\r\n```\r\nexec result: \r\n```\r\nclickhouse-0-0.clickhouse-headless.default.svc.cluster.local :) create table test(test Uint32) engine=memory();\r\n\r\nCREATE TABLE test\r\n(\r\n    `test` Uint32\r\n)\r\nENGINE = memory\r\n\r\nQuery id: c976c324-efa1-418d-a6de-b615a9f8947d\r\n\r\n\r\n0 rows in set. Elapsed: 0.001 sec. \r\n\r\nReceived exception from server (version 22.3.6):\r\nCode: 164. DB::Exception: Received from localhost:9000. DB::Exception: public_ro: Cannot execute query in readonly mode. (READONLY)\r\n\r\nclickhouse-0-0.clickhouse-headless.default.svc.cluster.local :) create function test as a -> a*2;\r\n\r\nCREATE FUNCTION test AS a -> (a * 2)\r\n\r\nQuery id: b5b59b1c-5209-4de6-b521-9d6b50f5ce33\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.003 sec. \r\n\r\nclickhouse-0-0.clickhouse-headless.default.svc.cluster.local :) drop function test;\r\n\r\nDROP FUNCTION test\r\n\r\nQuery id: ee5f2061-4ff0-4627-bd3f-c7052406d484\r\n\r\nOk.\r\n\r\n0 rows in set. Elapsed: 0.001 sec. \r\n\r\n```\n",
  "hints_text": "",
  "created_at": "2022-05-31T15:25:37Z",
  "modified_files": [
    "src/Access/ContextAccess.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02315_readonly_create_function.reference",
    "b/tests/queries/0_stateless/02315_readonly_create_function.sh"
  ]
}