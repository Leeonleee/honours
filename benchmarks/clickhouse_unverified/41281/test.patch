diff --git a/tests/queries/0_stateless/02420_key_condition_actions_dag_bug_40599.reference b/tests/queries/0_stateless/02420_key_condition_actions_dag_bug_40599.reference
new file mode 100644
index 000000000000..8bd1af11bf28
--- /dev/null
+++ b/tests/queries/0_stateless/02420_key_condition_actions_dag_bug_40599.reference
@@ -0,0 +1,1 @@
+2000
diff --git a/tests/queries/0_stateless/02420_key_condition_actions_dag_bug_40599.sql b/tests/queries/0_stateless/02420_key_condition_actions_dag_bug_40599.sql
new file mode 100644
index 000000000000..4d2feacfde7a
--- /dev/null
+++ b/tests/queries/0_stateless/02420_key_condition_actions_dag_bug_40599.sql
@@ -0,0 +1,10 @@
+create table tba (event_id Int64, event_dt Int64) Engine =MergeTree order by event_id ;
+insert into tba select number%500, 20220822 from numbers(1e6);
+
+select count() from (
+   SELECT event_dt FROM (
+      select event_dt, 403 AS event_id from (
+         select event_dt from tba as tba
+         where event_id = 9 and ((tba.event_dt >= 20220822 and tba.event_dt <= 20220822))
+      )
+  ) tba WHERE tba.event_dt >= 20220822 and tba.event_dt <= 20220822 and event_id = 403 );
