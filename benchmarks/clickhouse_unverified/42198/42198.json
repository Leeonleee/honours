{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 42198,
  "instance_id": "ClickHouse__ClickHouse-42198",
  "issue_numbers": [
    "41647"
  ],
  "base_commit": "87b77094f002298f9f7aea7277fde3a5cfeed68b",
  "patch": "diff --git a/src/Storages/MergeTree/MergeTreeData.cpp b/src/Storages/MergeTree/MergeTreeData.cpp\nindex c9e9a45dc67e..0ba434137ddf 100644\n--- a/src/Storages/MergeTree/MergeTreeData.cpp\n+++ b/src/Storages/MergeTree/MergeTreeData.cpp\n@@ -5683,7 +5683,8 @@ std::optional<ProjectionCandidate> MergeTreeData::getQueryProcessingStageWithAgg\n {\n     const auto & metadata_snapshot = storage_snapshot->metadata;\n     const auto & settings = query_context->getSettingsRef();\n-    if (!settings.allow_experimental_projection_optimization || query_info.ignore_projections || query_info.is_projection_query)\n+    if (!settings.allow_experimental_projection_optimization || query_info.ignore_projections || query_info.is_projection_query\n+        || settings.aggregate_functions_null_for_empty /* projections don't work correctly with this setting */)\n         return std::nullopt;\n \n     // Currently projections don't support parallel replicas reading yet.\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02460_projections_and_aggregate_null_if_empty.reference b/tests/queries/0_stateless/02460_projections_and_aggregate_null_if_empty.reference\nnew file mode 100644\nindex 000000000000..54f97aaa2e65\n--- /dev/null\n+++ b/tests/queries/0_stateless/02460_projections_and_aggregate_null_if_empty.reference\n@@ -0,0 +1,1 @@\n+20220920\ndiff --git a/tests/queries/0_stateless/02460_projections_and_aggregate_null_if_empty.sh b/tests/queries/0_stateless/02460_projections_and_aggregate_null_if_empty.sh\nnew file mode 100755\nindex 000000000000..6e96b9b8afcd\n--- /dev/null\n+++ b/tests/queries/0_stateless/02460_projections_and_aggregate_null_if_empty.sh\n@@ -0,0 +1,9 @@\n+#!/usr/bin/env bash\n+# Tags: no-fasttest\n+# Tag no-fasttest: depends on bzip2\n+\n+CURDIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CURDIR\"/../shell_config.sh\n+\n+${CLICKHOUSE_LOCAL} --aggregate_functions_null_for_empty=1 --multiquery --query \"create table test_date (date Int32) ENGINE = MergeTree ORDER BY (date) as select 20220920; SELECT max(date) FROM test_date\";\n",
  "problem_statement": "select max(date) from test_date always return -127593672\n**Describe the unexpected behaviour**\r\nmax(date) and min(date) always return the same negative value: -127593672\r\n\r\n**How to reproduce**\r\nClickHouse version: Docker -- clickhouse/clickhouse-server:22.6.8.35-alpine\r\nArchitecture: linux/arm64\r\n\r\n```\r\nMySQL [test]> create table test_date (\r\n  date Int32,\r\n  hour Int32\r\n  ) ENGINE = MergeTree ORDER BY (date);\r\n    ->     ->     -> Query OK, 0 rows affected (0.01 sec)\r\n```\r\n```\r\nMySQL [test]> insert into test_date values(20220920, 1);\r\nQuery OK, 1 row affected (0.00 sec)\r\n```\r\n```\r\nMySQL [test]> select max(date) from test_date;\r\n+-----------------+\r\n| maxOrNull(date) |\r\n+-----------------+\r\n| -127593672      |\r\n+-----------------+\r\n1 row in set (0.00 sec)\r\n```\r\n```\r\nMySQL [test]> select max(hour) from test_date;\r\n+-----------------+\r\n| maxOrNull(hour) |\r\n+-----------------+\r\n| 1               |\r\n+-----------------+\r\n1 row in set (0.00 sec)\r\n```\r\n**Expected behavior**\r\nI expect it to return ``20220920``.\r\n\n",
  "hints_text": "If I include a filter in the query ``select max(date) from test_date where date > 1``, then it returns correct result. It only happens when ``date`` is an ``order by`` (i.e. index) column.\nAs I can see you use mysql client. \r\nCan you check the same with clickhouse-client ?\n> As I can see you use mysql client. Can you check the same with clickhouse-client ?\r\n\r\nIt does work with clickhouse-client.\r\n\r\n```\r\n2bf3dbc2cf67 :) select max(date) from test_date;\r\n\r\nSELECT max(date)\r\nFROM test_date\r\n\r\nQuery id: 16595191-9ef8-4479-82c8-4586efe3abfe\r\n\r\n\u250c\u2500maxOrNull(date)\u2500\u2510\r\n\u2502        20220920 \u2502\r\n```\nIt also **does not** work for port 8123 -- HTTP API Port for http requests. used by JDBC, ODBC and web interfaces.\n> It also **does not** work for port 8123 -- HTTP API Port for http requests. used by JDBC, ODBC and web interfaces.\r\n\r\nMake an example using curl and http api https://clickhouse.com/docs/en/interfaces/http/\nHi @den-crane I'm using JDBC library which returns wrong value. Using CURL does work:\r\n\r\n```\r\ncurl 'http://localhost:8123?query=SELECT%20MAX(date)%20FROM%20test.test_date'             \r\n20220920                                       \r\n```\r\n\r\nUsing MySQL client with this query does work:\r\n```\r\nselect max(toInt32(date)) from test_date;\r\n``` \nOpen an issue in JDBC repo https://github.com/ClickHouse/clickhouse-jdbc\nCould this be a timing issue where it could take time to build the cache? Though, it's strange that it works with CURL and clickhouse-client.\n>Could this be a timing issue where it could take time to build the cache? Though, it's strange that it works with CURL and clickhouse-client.\r\n\r\nNo, it cannot be. The most probably the error is IN your java code.\n> > Could this be a timing issue where it could take time to build the cache? Though, it's strange that it works with CURL and clickhouse-client.\r\n> \r\n> No, it cannot be. The most probably the error is IN your java code.\r\n\r\nThanks for looking into this issue and I can file a bug in JDBC repo, but it's also an issue with MySQL client.\nmysql wire protocol:\r\n\r\n```\r\nmysql> create table test_date (\r\n    ->   date Int32,\r\n    ->   hour Int32\r\n    ->   ) ENGINE = MergeTree ORDER BY (date);\r\nQuery OK, 0 rows affected (0.00 sec)\r\n\r\nmysql> insert into test_date values(20220920, 1);\r\nQuery OK, 1 row affected (0.00 sec)\r\n\r\nmysql> select max(date) from test_date;\r\n+-----------+\r\n| max(date) |\r\n+-----------+\r\n|  20220920 |\r\n+-----------+\r\n1 row in set (0.01 sec)\r\nRead 1 rows, 4.01 KiB in 0.0008502 sec., 1176 rows/sec., 4.60 MiB/sec.\r\n```\r\n\r\nno issue.\nThough `maxOrNull` --  you use `aggregate_functions_null_for_empty` setting.\nNo, it does not change anything\r\n\r\n`aggregate_functions_null_for_empty=1`\r\n\r\n```\r\nmysql> select max(date) from test_date;\r\n+-----------------+\r\n| maxOrNull(date) |\r\n+-----------------+\r\n| 20220920        |\r\n+-----------------+\r\n1 row in set (0.00 sec)\r\nRead 1 rows, 4.00 B in 0.001290521 sec., 774 rows/sec., 3.03 KiB/sec.\r\n\r\n```\nThat's strange. I'll take a look again to find the cause. It's definitely not Java code (we didn't change anything) and it doesn't work on python either. Thanks again for spending time on this. \nfiddle also use HTTP api and no issue https://fiddle.clickhouse.com/05803662-9b0e-46b3-be28-6682c498fe9f\nI'm finally able to reproduce with cURL:\r\n\r\n```\r\ncurl -v 'http://localhost:8123?query=select%20max(date)%20from%20test.test_date%20FORMAT%20TabSeparatedWithNamesAndTypes;'\r\n*   Trying 127.0.0.1:8123...\r\n* Connected to localhost (127.0.0.1) port 8123 (#0)\r\n> GET /?query=select%20max(date)%20from%20test.test_date%20FORMAT%20TabSeparatedWithNamesAndTypes; HTTP/1.1\r\n> Host: localhost:8123\r\n> User-Agent: curl/7.79.1\r\n> Accept: */*\r\n>\r\n* Mark bundle as not supporting multiuse\r\n< HTTP/1.1 200 OK\r\n< Date: Wed, 21 Sep 2022 20:02:45 GMT\r\n< Connection: Keep-Alive\r\n< Content-Type: text/tab-separated-values; charset=UTF-8\r\n< X-ClickHouse-Server-Display-Name: 2bf3dbc2cf67\r\n< Transfer-Encoding: chunked\r\n< X-ClickHouse-Query-Id: efb52ea2-aa79-4608-9715-e6aaaccea1e4\r\n< X-ClickHouse-Format: TabSeparatedWithNamesAndTypes\r\n< X-ClickHouse-Timezone: America/Los_Angeles\r\n< Keep-Alive: timeout=3\r\n< X-ClickHouse-Summary: {\"read_rows\":\"15\",\"read_bytes\":\"4216\",\"written_rows\":\"0\",\"written_bytes\":\"0\",\"total_rows_to_read\":\"0\"}\r\n<\r\nmaxOrNull(date)\r\nNullable(Int32)\r\n-127593672\r\n\r\n```\r\n\r\nThe query is: \r\n```\r\nselect max(date) from test.test_date\r\nFORMAT TabSeparatedWithNamesAndTypes;\r\n```\nCheck that you have only one table `test_date` and a database is correct.\r\n\r\nhttps://fiddle.clickhouse.com/f885df32-b466-49b6-ab0e-f2abe07701bf\r\nmax(date)\r\nInt32\r\n20220920\r\n\r\n\r\n```\r\ncurl -v 'http://localhost:8123?query=select%20max(date)%20from%20test_date%20FORMAT%20TabSeparatedWithNamesAndTypes;'\r\n*   Trying 127.0.0.1:8123...\r\n* TCP_NODELAY set\r\n* Connected to localhost (127.0.0.1) port 8123 (#0)\r\n> GET /?query=select%20max(date)%20from%20test_date%20FORMAT%20TabSeparatedWithNamesAndTypes; HTTP/1.1\r\n> Host: localhost:8123\r\n> User-Agent: curl/7.68.0\r\n> Accept: */*\r\n>\r\n* Mark bundle as not supporting multiuse\r\n< HTTP/1.1 200 OK\r\n< Date: Wed, 21 Sep 2022 20:14:39 GMT\r\n< Connection: Keep-Alive\r\n< Content-Type: text/tab-separated-values; charset=UTF-8\r\n< X-ClickHouse-Server-Display-Name: clickhouse\r\n< Transfer-Encoding: chunked\r\n< X-ClickHouse-Query-Id: 78e94951-7b79-4139-9c73-70a70b30cc05\r\n< X-ClickHouse-Format: TabSeparatedWithNamesAndTypes\r\n< X-ClickHouse-Timezone: Etc/UTC\r\n< Keep-Alive: timeout=3\r\n< X-ClickHouse-Summary: {\"read_rows\":\"1\",\"read_bytes\":\"4\",\"written_rows\":\"0\",\"written_bytes\":\"0\",\"total_rows_to_read\":\"1\",\"result_rows\":\"0\",\"result_bytes\":\"0\"}\r\n<\r\nmaxOrNull(date)\r\nNullable(Int32)\r\n20220920\r\n* Connection #0 to host localhost left intact\r\n* \r\n* \r\n```\nMay be you have more data in the table ?\r\n\r\nPlease share\r\n```\r\nselect max(date), count(),version() from test.test_date\r\nFORMAT TabSeparatedWithNamesAndTypes;\r\n\r\nselect name, value from system.settings where changed;\r\n```\nCheck other versions of CH.\nIt's combination of ``FORMAT TabSeparatedWithNamesAndTypes;`` and ``<aggregate_functions_null_for_empty>1</aggregate_functions_null_for_empty>``.\r\n\r\n```\r\ncurl 'http://localhost:8123?query=select%20max(date),%20count(),version()%20from%20test.test_date%20FORMAT%20TabSeparatedWithNamesAndTypes'\r\nmaxOrNull(date) count() version()\r\nNullable(Int32) UInt64  String\r\n128425880       1       22.6.8.35\r\n```\r\n\r\n```\r\nselect name, value from system.settings where changed;\r\n+------------------------------------+--------+\r\n| name                               | value  |\r\n+------------------------------------+--------+\r\n| load_balancing                     | random |\r\n| log_queries_min_query_duration_ms  | 3000   |\r\n| aggregate_functions_null_for_empty | 1      |\r\n+------------------------------------+--------+\r\n```\n```\r\n:) select max(date), count(),version() from test.test_date\r\n                             FORMAT TabSeparatedWithNamesAndTypes;\r\n\r\nSELECT\r\n    max(date),\r\n    count(),\r\n    version()\r\nFROM test.test_date\r\nFORMAT TabSeparatedWithNamesAndTypes\r\n\r\nQuery id: 35b26ea5-524e-4485-8901-26f644f62580\r\n\r\nmaxOrNull(date)\tcount()\tversion()\r\nNullable(Int32)\tUInt64\tString\r\n20220920\t1\t22.6.7.7\r\n\r\n1 row in set. Elapsed: 0.001 sec.\r\n\r\n\r\ncurl 'http://localhost:8123?query=select%20max(date),%20count(),version()%20from%20test.test_date%20FORMAT%20TabSeparatedWithNamesAndTypes'\r\nmaxOrNull(date)\tcount()\tversion()\r\nNullable(Int32)\tUInt64\tString\r\n20220920\t1\t22.6.7.7\r\n```\nI'll downgrade to ``22.6.7.7`` and try it out. \nRight\r\n\r\n```\r\nselect max(date), count(),version() from test.test_date\r\n                             FORMAT TabSeparatedWithNamesAndTypes;\r\n\r\nSELECT\r\n    max(date),\r\n    count(),\r\n    version()\r\nFROM test.test_date\r\nFORMAT TabSeparatedWithNamesAndTypes\r\n\r\nQuery id: 715543d8-5a3c-4e95-84a6-55a5e4d34209\r\n\r\nmaxOrNull(date)\tcount()\tversion()\r\nNullable(Int32)\tUInt64\tString\r\n128425880\t1\t22.6.8.35\r\n```\r\n\r\nNeed to restart CH with\r\n\r\n```\r\n cat /etc/clickhouse-server/users.d/xxx.xml\r\n<?xml version=\"1.0\"?>\r\n<clickhouse>\r\n\t<profiles>\r\n\t\t<default>\r\n\t\t\t<aggregate_functions_null_for_empty>1</aggregate_functions_null_for_empty>\r\n\t\t</default>\r\n\t</profiles>\r\n</clickhouse>\r\n```\nThank you so much for your help.\n```\r\ndrop table if exists test_date;\r\ncreate table test_date (date Int32,  hour Int32) ENGINE = MergeTree ORDER BY (date) as select 20220920, 1;\r\n\r\nSELECT  max(date),  version() FROM test_date\r\n\r\n\u250c\u2500max(date)\u2500\u252c\u2500version()\u2500\u2500\u2500\u2510\r\n\u2502  20220920 \u2502 22.9.1.2376 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n\r\n# cat /etc/clickhouse-server/users.d/xxx.xml\r\n<?xml version=\"1.0\"?>\r\n<clickhouse>\r\n\t<profiles>\r\n\t\t<default>\r\n\t\t\t<aggregate_functions_null_for_empty>1</aggregate_functions_null_for_empty>\r\n\t\t</default>\r\n\t</profiles>\r\n</clickhouse>\r\n\r\n# systemctl restart clickhouse-server\r\n\r\ndrop table if exists test_date;\r\ncreate table test_date (date Int32,  hour Int32) ENGINE = MergeTree ORDER BY (date) as select 20220920, 1;\r\n\r\nSELECT  max(date),  version() FROM test_date;\r\n\u250c\u2500maxOrNull(date)\u2500\u252c\u2500version()\u2500\u2500\u2500\u2510\r\n\u2502     -1092222096 \u2502 22.9.1.2376 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n\r\nSELECT  max(date),  version() FROM test_date settings allow_experimental_projection_optimization=1;\r\n\u250c\u2500maxOrNull(date)\u2500\u252c\u2500version()\u2500\u2500\u2500\u2510\r\n\u2502     -1092222096 \u2502 22.9.1.2376 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\nSELECT  max(date),  version() FROM test_date settings allow_experimental_projection_optimization=0;\r\n\u250c\u2500maxOrNull(date)\u2500\u252c\u2500version()\u2500\u2500\u2500\u2510\r\n\u2502        20220920 \u2502 22.9.1.2376 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\n\n@quangkevin you can disable allow_experimental_projection_optimization as a workaround.\ncc @amosbird https://github.com/ClickHouse/ClickHouse/issues/41647#issuecomment-1254211812\n```\r\nclickhouse-local --aggregate_functions_null_for_empty=1 -q 'create table test_date (date Int32) ENGINE = MergeTree ORDER BY (date) as select 20220920; SELECT  max(date),  version() FROM test_date';\r\n124754248\t22.3.9.19\r\n\r\nclickhouse-local --aggregate_functions_null_for_empty=0 -q 'create table test_date (date Int32) ENGINE = MergeTree ORDER BY (date) as select 20220920; SELECT  max(date),  version() FROM test_date';\r\n20220920\t22.3.9.19\r\n\r\nclickhouse-local --aggregate_functions_null_for_empty=1 -q 'create table test_date (date Int32) ENGINE = MergeTree ORDER BY (date) as select 20220920; SELECT  max(date),  version() FROM test_date';\r\n-579075216\t22.9.1.2376\r\n```\n@den-crane Do we need to simply disable projection optimization in case `aggregate_functions_null_for_empty` is enabled?",
  "created_at": "2022-10-09T03:31:58Z",
  "modified_files": [
    "src/Storages/MergeTree/MergeTreeData.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02460_projections_and_aggregate_null_if_empty.reference",
    "b/tests/queries/0_stateless/02460_projections_and_aggregate_null_if_empty.sh"
  ]
}