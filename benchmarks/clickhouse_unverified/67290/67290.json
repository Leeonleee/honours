{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 67290,
  "instance_id": "ClickHouse__ClickHouse-67290",
  "issue_numbers": [
    "67289"
  ],
  "base_commit": "b64c7814572c5245bb2cbd8d6aaab1b87f81c7fa",
  "patch": "diff --git a/programs/server/config.d/backups.xml b/programs/server/config.d/backups.xml\nnew file mode 100644\nindex 000000000000..382794e11234\n--- /dev/null\n+++ b/programs/server/config.d/backups.xml\n@@ -0,0 +1,13 @@\n+<clickhouse>\n+    <storage_configuration>\n+        <disks>\n+            <backups>\n+                <type>local</type>\n+                <path>/tmp/backups/</path>\n+            </backups>\n+        </disks>\n+    </storage_configuration>\n+    <backups>\n+        <allowed_disk>backups</allowed_disk>\n+    </backups>\n+</clickhouse>\ndiff --git a/programs/server/config.d/enable_keeper_map.xml b/programs/server/config.d/enable_keeper_map.xml\nnew file mode 120000\nindex 000000000000..47c361598826\n--- /dev/null\n+++ b/programs/server/config.d/enable_keeper_map.xml\n@@ -0,0 +1,1 @@\n+../../../tests/config/config.d/enable_keeper_map.xml\n\\ No newline at end of file\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02911_backup_restore_keeper_map.sh b/tests/queries/0_stateless/02911_backup_restore_keeper_map.sh\nindex ccdf52a6e23e..385583acbbe6 100755\n--- a/tests/queries/0_stateless/02911_backup_restore_keeper_map.sh\n+++ b/tests/queries/0_stateless/02911_backup_restore_keeper_map.sh\n@@ -11,11 +11,23 @@ $CLICKHOUSE_CLIENT -nm -q \"\n     CREATE TABLE $database_name.02911_backup_restore_keeper_map1 (key UInt64, value String) Engine=KeeperMap('/' || currentDatabase() || '/test02911') PRIMARY KEY key;\n     CREATE TABLE $database_name.02911_backup_restore_keeper_map2 (key UInt64, value String) Engine=KeeperMap('/' || currentDatabase() || '/test02911') PRIMARY KEY key; -- table using same Keeper path as 02911_backup_restore_keeper_map1\n     CREATE TABLE $database_name.02911_backup_restore_keeper_map3 (key UInt64, value String) Engine=KeeperMap('/' || currentDatabase() || '/test02911_different') PRIMARY KEY key;\n-\n-    INSERT INTO $database_name.02911_backup_restore_keeper_map2 SELECT number, 'test' || toString(number) FROM system.numbers LIMIT 5000;\n-    INSERT INTO $database_name.02911_backup_restore_keeper_map3 SELECT number, 'test' || toString(number) FROM system.numbers LIMIT 3000;\n \"\n \n+# KeeperMap table engine doesn't have internal retries for interaction with Keeper. Do it on our own, otherwise tests with overloaded server can be flaky.\n+while true\n+do\n+    $CLICKHOUSE_CLIENT -nm -q \"INSERT INTO $database_name.02911_backup_restore_keeper_map2 SELECT number, 'test' || toString(number) FROM system.numbers LIMIT 5000;\n+    \" | grep -q \"KEEPER_EXCEPTION\" && sleep 1 && continue\n+    break\n+done\n+\n+while true\n+do\n+    $CLICKHOUSE_CLIENT -nm -q \"INSERT INTO $database_name.02911_backup_restore_keeper_map3 SELECT number, 'test' || toString(number) FROM system.numbers LIMIT 3000;\n+    \" | grep -q \"KEEPER_EXCEPTION\" && sleep 1 && continue\n+    break\n+done\n+\n backup_path=\"$database_name\"\n for i in $(seq 1 3); do\n     $CLICKHOUSE_CLIENT -q \"SELECT count() FROM $database_name.02911_backup_restore_keeper_map$i;\"\n@@ -45,4 +57,4 @@ for i in $(seq 1 3); do\n     $CLICKHOUSE_CLIENT -q \"SELECT count() FROM $database_name.02911_backup_restore_keeper_map$i;\"\n done\n \n-$CLICKHOUSE_CLIENT -q \"DROP DATABASE $database_name SYNC;\"\n\\ No newline at end of file\n+$CLICKHOUSE_CLIENT -q \"DROP DATABASE $database_name SYNC;\"\n",
  "problem_statement": "Test `02911_backup_restore_keeper_map` has failed\nhttps://s3.amazonaws.com/clickhouse-test-reports/67279/3c4902d9d327bdf2e9d22606f163cd137edd4b49/stateless_tests__tsan__s3_storage__[2_4].html\n",
  "hints_text": "",
  "created_at": "2024-07-27T21:18:41Z",
  "modified_files": [
    "b/programs/server/config.d/backups.xml",
    "b/programs/server/config.d/enable_keeper_map.xml"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/02911_backup_restore_keeper_map.sh"
  ]
}