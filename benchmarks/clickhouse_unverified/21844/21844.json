{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 21844,
  "instance_id": "ClickHouse__ClickHouse-21844",
  "issue_numbers": [
    "13832"
  ],
  "base_commit": "89e79185a0f764e1009a061ba01ea4cb93704c55",
  "patch": "diff --git a/src/Interpreters/ExternalLoader.cpp b/src/Interpreters/ExternalLoader.cpp\nindex e1713c7cbbbe..5d47d39c3421 100644\n--- a/src/Interpreters/ExternalLoader.cpp\n+++ b/src/Interpreters/ExternalLoader.cpp\n@@ -817,7 +817,9 @@ class ExternalLoader::LoadingDispatcher : private boost::noncopyable\n \n             if (info->loading_id < min_id)\n                 startLoading(*info, forced_to_reload, *min_id);\n-            return false; /// wait for the next event\n+\n+            /// Wait for the next event if loading wasn't completed, and stop otherwise.\n+            return (info->state_id >= min_id);\n         };\n \n         if (timeout == WAIT)\n@@ -845,9 +847,10 @@ class ExternalLoader::LoadingDispatcher : private boost::noncopyable\n                 if (info.state_id >= min_id)\n                     continue;\n \n-                all_ready = false;\n                 if (info.loading_id < min_id)\n                     startLoading(info, forced_to_reload, *min_id);\n+\n+                all_ready &= (info.state_id >= min_id);\n             }\n             return all_ready;\n         };\n",
  "test_patch": "diff --git a/tests/integration/test_catboost_model_first_evaluate/__init__.py b/tests/integration/test_catboost_model_first_evaluate/__init__.py\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/tests/integration/test_catboost_model_first_evaluate/config/models_config.xml b/tests/integration/test_catboost_model_first_evaluate/config/models_config.xml\nnew file mode 100644\nindex 000000000000..eab1458031b7\n--- /dev/null\n+++ b/tests/integration/test_catboost_model_first_evaluate/config/models_config.xml\n@@ -0,0 +1,4 @@\n+<yandex>\n+    <catboost_dynamic_library_path>/etc/clickhouse-server/model/libcatboostmodel.so</catboost_dynamic_library_path>\n+    <models_config>/etc/clickhouse-server/model/model_config.xml</models_config>\n+</yandex>\ndiff --git a/tests/integration/test_catboost_model_first_evaluate/model/libcatboostmodel.so b/tests/integration/test_catboost_model_first_evaluate/model/libcatboostmodel.so\nnew file mode 100755\nindex 000000000000..388d9f887b46\nBinary files /dev/null and b/tests/integration/test_catboost_model_first_evaluate/model/libcatboostmodel.so differ\ndiff --git a/tests/integration/test_catboost_model_first_evaluate/model/model.bin b/tests/integration/test_catboost_model_first_evaluate/model/model.bin\nnew file mode 100644\nindex 000000000000..118e099d1760\nBinary files /dev/null and b/tests/integration/test_catboost_model_first_evaluate/model/model.bin differ\ndiff --git a/tests/integration/test_catboost_model_first_evaluate/model/model_config.xml b/tests/integration/test_catboost_model_first_evaluate/model/model_config.xml\nnew file mode 100644\nindex 000000000000..2c328167a943\n--- /dev/null\n+++ b/tests/integration/test_catboost_model_first_evaluate/model/model_config.xml\n@@ -0,0 +1,8 @@\n+<models>\n+    <model>\n+        <type>catboost</type>\n+        <name>titanic</name>\n+        <path>/etc/clickhouse-server/model/model.bin</path>\n+        <lifetime>0</lifetime>\n+    </model>\n+</models>\ndiff --git a/tests/integration/test_catboost_model_first_evaluate/test.py b/tests/integration/test_catboost_model_first_evaluate/test.py\nnew file mode 100644\nindex 000000000000..1c3723b9d06e\n--- /dev/null\n+++ b/tests/integration/test_catboost_model_first_evaluate/test.py\n@@ -0,0 +1,36 @@\n+import os\n+import sys\n+import time\n+\n+import pytest\n+\n+sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))\n+SCRIPT_DIR = os.path.dirname(os.path.realpath(__file__))\n+\n+from helpers.cluster import ClickHouseCluster\n+\n+cluster = ClickHouseCluster(__file__)\n+node = cluster.add_instance('node', stay_alive=True, main_configs=['config/models_config.xml'])\n+\n+\n+def copy_file_to_container(local_path, dist_path, container_id):\n+    os.system(\"docker cp {local} {cont_id}:{dist}\".format(local=local_path, cont_id=container_id, dist=dist_path))\n+\n+\n+@pytest.fixture(scope=\"module\")\n+def started_cluster():\n+    try:\n+        cluster.start()\n+\n+        copy_file_to_container(os.path.join(SCRIPT_DIR, 'model/.'), '/etc/clickhouse-server/model', node.docker_id)\n+        node.restart_clickhouse()\n+\n+        yield cluster\n+\n+    finally:\n+        cluster.shutdown()\n+\n+\n+def test(started_cluster):\n+    node.query(\"select modelEvaluate('titanic', 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11);\")\n+    \n",
  "problem_statement": "First modelEvaluate() call on a newly created CatBoost model deadlocks forever\nHello,\r\n\r\nso I'm working to integrate CatBoost model with our ClickHouse cluster. It appears that, whenever we create a new XML model file in the configured path, the **first** call to the new model never returns (this is true both of the HTTP interface as well as via clickhouse-client).\r\n\r\nIndependently from whether the locked statement gets cancelled, subsequent calls succeed immediately.\r\n\r\n```\r\n16e8bdb5bbb9 :) select version();\r\n\r\nSELECT version()\r\n\r\n\u250c\u2500version()\u2500\u2510\r\n\u2502 20.6.3.28 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 rows in set. Elapsed: 0.006 sec.\r\n```\r\n\r\nIs this known behavior? If it helps, my models look like this:\r\n\r\n```\r\n<models>\r\n    <model>\r\n        <type>catboost</type>\r\n        <name>ctr_predictor</name>\r\n        <path>/catboost/my_predictor</path>\r\n        <lifetime>0</lifetime>\r\n    </model>\r\n</models>\r\n```\n",
  "hints_text": "20.9.2.20 Clickhouse version has the same bug. Is there any workaround for this problem?\nObserving smth similar (20.3), but that doesn't seems like 'forever' in my case, may be it's realted to `lifetime` - i have it 600 sec.\r\n\r\n```\r\nquery:                SELECT modelEvaluate('predictDa_SbsFprFFBB2WLBGLG', 1, 2, 3, 4, 5, 6, 7, 8, 9)\r\nthread_ids:           [258]\r\nProfileEvents.Names:  ['Query','SelectQuery','ReadCompressedBytes','CompressedReadBufferBlocks','CompressedReadBufferBytes','IOBufferAllocs','IOBufferAllocBytes','ContextLock','RWLockAcquiredReadLocks']\r\nProfileEvents.Values: [1,1,36,1,10,1,89,8,1]\r\nelapsed:              269.666410887\r\nis_cancelled:         0\r\nread_rows:            0\r\nread_bytes:           0\r\ntotal_rows_approx:    0\r\nwritten_rows:         0\r\nwritten_bytes:        0\r\nmemory_usage:         0\r\npeak_memory_usage:    0\r\n```\r\n\r\n\r\nRelated stacktraces: \r\n```\r\nWITH arrayMap(x -> demangle(addressToSymbol(x)) || ' # ' || addressToLine(x)  , trace) AS all SELECT thread_id, query_id, arrayStringConcat(all, '\\n') AS res FROM system.stack_trace where res like '%ExternalLoader%'\\G\r\nRow 1:\r\n\u2500\u2500\u2500\u2500\u2500\u2500\r\nthread_id: 66\r\nquery_id:  \r\nres:       pthread_cond_timedwait # /lib/x86_64-linux-gnu/libpthread-2.27.so\r\nstd::__1::condition_variable::__do_timed_wait(std::__1::unique_lock<std::__1::mutex>&, std::__1::chrono::time_point<std::__1::chrono::system_clock, std::__1::chrono::duration<long long, std::__1::ratio<1l, 1000000000l> > >) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/src/condition_variable.cpp:75\r\nDB::ExternalLoader::PeriodicUpdater::doPeriodicUpdates() # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__mutex_base:468\r\nThreadFromGlobalPool::ThreadFromGlobalPool<void (DB::ExternalLoader::PeriodicUpdater::*)(), DB::ExternalLoader::PeriodicUpdater*>(void (DB::ExternalLoader::PeriodicUpdater::*&&)(), DB::ExternalLoader::PeriodicUpdater*&&)::'lambda'()::operator()() const # /build/obj-x86_64-linux-gnu/../src/Common/ThreadPool.h:159\r\nThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/atomic:856\r\nvoid* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()> >(void*) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:2615\r\nstart_thread # /lib/x86_64-linux-gnu/libpthread-2.27.so\r\nclone # /lib/x86_64-linux-gnu/libc-2.27.so\r\n\r\nRow 2:\r\n\u2500\u2500\u2500\u2500\u2500\u2500\r\nthread_id: 229\r\nquery_id:  \r\nres:       pthread_cond_timedwait # /lib/x86_64-linux-gnu/libpthread-2.27.so\r\nstd::__1::condition_variable::__do_timed_wait(std::__1::unique_lock<std::__1::mutex>&, std::__1::chrono::time_point<std::__1::chrono::system_clock, std::__1::chrono::duration<long long, std::__1::ratio<1l, 1000000000l> > >) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/src/condition_variable.cpp:75\r\nDB::ExternalLoader::PeriodicUpdater::doPeriodicUpdates() # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/__mutex_base:468\r\nThreadFromGlobalPool::ThreadFromGlobalPool<void (DB::ExternalLoader::PeriodicUpdater::*)(), DB::ExternalLoader::PeriodicUpdater*>(void (DB::ExternalLoader::PeriodicUpdater::*&&)(), DB::ExternalLoader::PeriodicUpdater*&&)::'lambda'()::operator()() const # /build/obj-x86_64-linux-gnu/../src/Common/ThreadPool.h:159\r\nThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/atomic:856\r\nvoid* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()> >(void*) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:2615\r\nstart_thread # /lib/x86_64-linux-gnu/libpthread-2.27.so\r\nclone # /lib/x86_64-linux-gnu/libc-2.27.so\r\n\r\nRow 3:\r\n\u2500\u2500\u2500\u2500\u2500\u2500\r\nthread_id: 245\r\nquery_id:  bf4d7f08-75a9-4cbb-bf30-8903b6862eba\r\nres:       pthread_cond_wait # /lib/x86_64-linux-gnu/libpthread-2.27.so\r\nstd::__1::condition_variable::wait(std::__1::unique_lock<std::__1::mutex>&) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/src/condition_variable.cpp:45\r\nDB::ExternalLoader::LoadingDispatcher::loadImpl(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::chrono::duration<long long, std::__1::ratio<1l, 1000l> >, bool, std::__1::unique_lock<std::__1::mutex>&) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/unordered_map:1278\r\nDB::ExternalLoader::LoadResult DB::ExternalLoader::tryLoad<DB::ExternalLoader::LoadResult, void>(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::chrono::duration<long long, std::__1::ratio<1l, 1000l> >) const # /build/obj-x86_64-linux-gnu/../src/Interpreters/ExternalLoader.cpp:556\r\nstd::__1::shared_ptr<DB::IExternalLoadable const> DB::ExternalLoader::load<std::__1::shared_ptr<DB::IExternalLoadable const>, void>(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) const # /build/obj-x86_64-linux-gnu/../src/Interpreters/ExternalLoader.cpp:1249\r\nDB::FunctionModelEvaluate::getReturnTypeImpl(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&) const # /usr/lib/debug/usr/bin/clickhouse\r\nDB::DefaultOverloadResolver::getReturnType(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&) const # /usr/lib/debug/usr/bin/clickhouse\r\nDB::FunctionOverloadResolverAdaptor::getReturnTypeWithoutLowCardinality(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&) const # /usr/lib/debug/usr/bin/clickhouse\r\nDB::FunctionOverloadResolverAdaptor::getReturnType(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&) const # /usr/lib/debug/usr/bin/clickhouse\r\nDB::FunctionOverloadResolverAdaptor::build(std::__1::vector<DB::ColumnWithTypeAndName, std::__1::allocator<DB::ColumnWithTypeAndName> > const&) const # /usr/lib/debug/usr/bin/clickhouse\r\nDB::ExpressionActions::addImpl(DB::ExpressionAction, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > >&) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/type_traits:3696\r\nDB::ExpressionActions::add(DB::ExpressionAction const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > >&) # /build/obj-x86_64-linux-gnu/../src/Interpreters/ExpressionActions.cpp:546\r\nDB::ScopeStack::addAction(DB::ExpressionAction const&) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:1549\r\nDB::ActionsMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) # /build/obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:768\r\nDB::InDepthNodeVisitor<DB::ActionsMatcher, true, std::__1::shared_ptr<DB::IAST> const>::visit(std::__1::shared_ptr<DB::IAST> const&) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:3826\r\nDB::ExpressionAnalyzer::getRootActions(std::__1::shared_ptr<DB::IAST> const&, bool, std::__1::shared_ptr<DB::ExpressionActions>&, bool) (.constprop.0) # /build/obj-x86_64-linux-gnu/../src/Interpreters/InDepthNodeVisitor.h:45\r\nDB::SelectQueryExpressionAnalyzer::appendSelect(DB::ExpressionActionsChain&, bool) # /build/obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:790\r\nDB::ExpressionAnalysisResult::ExpressionAnalysisResult(DB::SelectQueryExpressionAnalyzer&, bool, bool, bool, std::__1::shared_ptr<DB::FilterInfo> const&, DB::Block const&) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:662\r\nDB::InterpreterSelectQuery::getSampleBlockImpl(bool) # /build/obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.h:164\r\nDB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&)::'lambda'(bool)::operator()(bool) const # /build/obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:300\r\nDB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) # /build/obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:374\r\nDB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) # /build/obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:167\r\nDB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:1681\r\nDB::InterpreterFactory::get(std::__1::shared_ptr<DB::IAST>&, DB::Context&, DB::QueryProcessingStage::Enum) # /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:461\r\nDB::executeQueryImpl(char const*, char const*, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool, DB::ReadBuffer*, bool) # /build/obj-x86_64-linux-gnu/../src/Interpreters/executeQuery.cpp:308\r\nDB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool, bool) # /build/obj-x86_64-linux-gnu/../src/Interpreters/executeQuery.cpp:572\r\nDB::TCPHandler::runImpl() # /build/obj-x86_64-linux-gnu/../programs/server/TCPHandler.cpp:249\r\nDB::TCPHandler::run() # /build/obj-x86_64-linux-gnu/../programs/server/TCPHandler.cpp:1235\r\nPoco::Net::TCPServerConnection::start() # /build/obj-x86_64-linux-gnu/../contrib/poco/Net/src/TCPServerConnection.cpp:57\r\n```\r\n\r\nAnd in logs:\r\n```\r\n2021.01.06 16:19:30.487767 [ 245 ] {bf4d7f08-75a9-4cbb-bf30-8903b6862eba} <Debug> executeQuery: (from 127.0.0.1:57252) SELECT modelEvaluate('predictDa_SbsFprFFBB2WLBGLG', 1, 2, 3, 4, 5, 6, 7, 8, 9)\r\n2021.01.06 16:29:30.675116 [ 245 ] {bf4d7f08-75a9-4cbb-bf30-8903b6862eba} <Debug> MemoryTracker: Peak memory usage (total): 4.07 MiB.                                                                      \r\n2021.01.06 16:29:30.697031 [ 245 ] {bf4d7f08-75a9-4cbb-bf30-8903b6862eba} <Error> executeQuery: Code: 36, e.displayText() = DB::Exception: Number of columns is different with number of features: 9 vs 4 + 9 (version 20.3.19.4 (official build)) (from 127.0.0.1:57252) (in query: SELECT modelEvaluate('predictDa_SbsFprFFBB2WLBGLG', 1, 2, 3, 4, 5, 6, 7, 8, 9)), Stack trace (when copying this message, always include the lines below):\r\n                                                                                                                                                                                                           \r\n0. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Exception.cpp:27: Poco::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0xe19c620 in /usr/lib/debug/usr/bin/clickhouse                                                                                                                                                        \r\n1. /build/obj-x86_64-linux-gnu/../src/Common/Exception.cpp:29: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x856f71d in /usr/lib/debug/usr/bin/clickhouse                                                                                                                                                                           \r\n2. /build/obj-x86_64-linux-gnu/../src/Interpreters/CatBoostModel.cpp:125: DB::(anonymous namespace)::CatBoostModelImpl::evaluate(std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*> > const&) const @ 0xc50256c in /usr/lib/debug/usr/bin/clickhouse                                                                                                                                        \r\n3. /build/obj-x86_64-linux-gnu/../src/Interpreters/CatBoostModel.cpp:562: DB::CatBoostModel::evaluate(std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*> > const&) const @ 0xc4feb14 in /usr/lib/debug/usr/bin/clickhouse                                                                                                                                                                   \r\n4. DB::FunctionModelEvaluate::executeImpl(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long) @ 0x8a8543d in /usr/lib/debug/usr/bin/cli$khouse\r\n5. DB::ExecutableFunctionAdaptor::execute(DB::Block&, std::__1::vector<unsigned long, std::__1::allocator<unsigned long> > const&, unsigned long, unsigned long, bool) @ 0x8962331 in /usr/lib/debug/usr/b$n/clickhouse\r\n6. /build/obj-x86_64-linux-gnu/../src/Interpreters/ExpressionActions.cpp:205: DB::ExpressionAction::prepare(DB::Block&, DB::Settings const&, std::__1::unordered_set<std::__1::basic_string<char, std::__1$:char_traits<char>, std::__1::allocator<char> >, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, s$d::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > >&) @ 0xc626319 in /usr/lib/debug/us$/bin/clickhouse\r\n7. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:1635: DB::ExpressionActions::addImpl(DB::ExpressionAction, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std:$__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > >&) @ 0xc626e33 in /usr/lib/debug/usr/bin/clickhouse\r\n8. /build/obj-x86_64-linux-gnu/../src/Interpreters/ExpressionActions.cpp:546: DB::ExpressionActions::add(DB::ExpressionAction const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<$har>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > >&) @ 0xc6272bd in /usr/lib/debug/usr/bin/clickhouse\r\n9. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:1549: DB::ScopeStack::addAction(DB::ExpressionAction const&) @ 0xc82d84d in /usr/lib/debug/usr/bin/clickhouse\r\n10. /build/obj-x86_64-linux-gnu/../src/Interpreters/ActionsVisitor.cpp:768: DB::ActionsMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST> const&, DB::ActionsMatcher::Data&) @ 0xc83501$ in /usr/lib/debug/usr/bin/clickhouse\r\n11. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:3826: DB::InDepthNodeVisitor<DB::ActionsMatcher, true, std::__1::shared_ptr<DB::IAST> const>::visit(std::__1::shared_ptr<DB::IAST> const&$ @ 0xc824659 in /usr/lib/debug/usr/bin/clickhouse\r\n12. /build/obj-x86_64-linux-gnu/../src/Interpreters/InDepthNodeVisitor.h:45: DB::ExpressionAnalyzer::getRootActions(std::__1::shared_ptr<DB::IAST> const&, bool, std::__1::shared_ptr<DB::ExpressionAction$>&, bool) (.constprop.0) @ 0xc8171cb in /usr/lib/debug/usr/bin/clickhouse\r\n13. /build/obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.cpp:790: DB::SelectQueryExpressionAnalyzer::appendSelect(DB::ExpressionActionsChain&, bool) @ 0xc81897c in /usr/lib/debug/usr/bin/c$ickhouse\r\n14. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:662: DB::ExpressionAnalysisResult::ExpressionAnalysisResult(DB::SelectQueryExpressionAnalyzer&, bool, bool, bool, std::__1::shared_ptr<DB$:FilterInfo> const&, DB::Block const&) @ 0xc821185 in /usr/lib/debug/usr/bin/clickhouse\r\n15. /build/obj-x86_64-linux-gnu/../src/Interpreters/ExpressionAnalyzer.h:164: DB::InterpreterSelectQuery::getSampleBlockImpl(bool) @ 0xc657b4b in /usr/lib/debug/usr/bin/clickhouse\r\n16. /build/obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:300: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, std::__1$:shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1:$char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&)::'lambda'(bool)::operator()(bool) co$st @ 0xc6592fb in /usr/lib/debug/usr/bin/clickhouse\r\n17. /build/obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:374: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, std::__1$:shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1:$char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0xc659f7e in /usr/lib/debug/usr/bi$/clickhouse\r\n18. /build/obj-x86_64-linux-gnu/../src/Interpreters/InterpreterSelectQuery.cpp:167: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, DB::Sele$tQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>$ std::__1::allocator<char> > > > const&) @ 0xc65b539 in /usr/lib/debug/usr/bin/clickhouse\r\n19. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:1681: DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, DB:$SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<$har>, std::__1::allocator<char> > > > const&) @ 0xc866d76 in /usr/lib/debug/usr/bin/clickhouse\r\n20. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:461: DB::InterpreterFactory::get(std::__1::shared_ptr<DB::IAST>&, DB::Context&, DB::QueryProcessingStage::Enum) @ 0xc5d1274 in /usr/lib/d$bug/usr/bin/clickhouse\r\n21. /build/obj-x86_64-linux-gnu/../src/Interpreters/executeQuery.cpp:308: DB::executeQueryImpl(char const*, char const*, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool, DB::ReadBuffer*, bool) $ 0xca74d45 in /usr/lib/debug/usr/bin/clickhouse\r\n22. /build/obj-x86_64-linux-gnu/../src/Interpreters/executeQuery.cpp:572: DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, boo$, DB::QueryProcessingStage::Enum, bool, bool) @ 0xca77b31 in /usr/lib/debug/usr/bin/clickhouse\r\n23. /build/obj-x86_64-linux-gnu/../programs/server/TCPHandler.cpp:249: DB::TCPHandler::runImpl() @ 0x86514e9 in /usr/lib/debug/usr/bin/clickhouse\r\n24. /build/obj-x86_64-linux-gnu/../programs/server/TCPHandler.cpp:1235: DB::TCPHandler::run() @ 0x86524d0 in /usr/lib/debug/usr/bin/clickhouse\r\n25. /build/obj-x86_64-linux-gnu/../contrib/poco/Net/src/TCPServerConnection.cpp:57: Poco::Net::TCPServerConnection::start() @ 0xd8d80bb in /usr/lib/debug/usr/bin/clickhouse\r\n26. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/atomic:856: Poco::Net::TCPServerDispatcher::run() @ 0xd8d853d in /usr/lib/debug/usr/bin/clickhouse\r\n27. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/include/Poco/Mutex_STD.h:132: Poco::PooledThread::run() @ 0xe22a7d7 in /usr/lib/debug/usr/bin/clickhouse\r\n28. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/include/Poco/AutoPtr.h:205: Poco::ThreadImpl::runnableEntry(void*) @ 0xe2265cc in /usr/lib/debug/usr/bin/clickhouse\r\n29. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:2615: void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void* (*)(void*), Poco::ThreadImpl*> >(void*) @ 0xe227f6d in /usr/lib/debug/usr/bin/clickhouse\r\n30. start_thread @ 0x76db in /lib/x86_64-linux-gnu/libpthread-2.27.so\r\n31. clone @ 0x121a3f in /lib/x86_64-linux-gnu/libc-2.27.so\r\n\r\n2021.01.06 16:29:30.697235 [ 245 ] {bf4d7f08-75a9-4cbb-bf30-8903b6862eba} <Debug> MemoryTracker: Peak memory usage (for query): 0.00 B.\r\n2021.01.06 16:29:30.697257 [ 245 ] {} <Information> TCPHandler: Processed in 600.210 sec.\r\n```\r\n\r\nAs you can see the query take exactly 600 sec, that corresponds to lifetime value. \n20.10.5.10\r\nSame bug",
  "created_at": "2021-03-17T18:59:55Z",
  "modified_files": [
    "src/Interpreters/ExternalLoader.cpp"
  ],
  "modified_test_files": [
    "b/tests/integration/test_catboost_model_first_evaluate/config/models_config.xml",
    "b/tests/integration/test_catboost_model_first_evaluate/model/model_config.xml",
    "b/tests/integration/test_catboost_model_first_evaluate/test.py"
  ]
}