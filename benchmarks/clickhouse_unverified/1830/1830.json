{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 1830,
  "instance_id": "ClickHouse__ClickHouse-1830",
  "issue_numbers": [
    "195"
  ],
  "base_commit": "288c6c8406fba0edc503630490364ab1c1f4036d",
  "patch": "diff --git a/dbms/src/Interpreters/ExpressionAnalyzer.cpp b/dbms/src/Interpreters/ExpressionAnalyzer.cpp\nindex 8053bf029870..2da338bb5e5f 100644\n--- a/dbms/src/Interpreters/ExpressionAnalyzer.cpp\n+++ b/dbms/src/Interpreters/ExpressionAnalyzer.cpp\n@@ -1570,7 +1570,9 @@ void ExpressionAnalyzer::makeSetsForIndexImpl(const ASTPtr & node, const Block &\n             {\n                 try\n                 {\n-                    makeExplicitSet(func, sample_block, true);\n+                    ExpressionActionsPtr temp_actions = std::make_shared<ExpressionActions>(columns, settings);\n+                    getRootActions(func->arguments->children.at(0), true, false, temp_actions);\n+                    makeExplicitSet(func, temp_actions->getSampleBlock(), true);\n                 }\n                 catch (const Exception & e)\n                 {\n",
  "test_patch": "diff --git a/dbms/tests/queries/0_stateless/00563_complex_in_expression.reference b/dbms/tests/queries/0_stateless/00563_complex_in_expression.reference\nnew file mode 100644\nindex 000000000000..675e007d8d36\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00563_complex_in_expression.reference\n@@ -0,0 +1,2 @@\n+2018-01-29\t100\tkey\n+2018-01-29\t100\tkey\ndiff --git a/dbms/tests/queries/0_stateless/00563_complex_in_expression.sql b/dbms/tests/queries/0_stateless/00563_complex_in_expression.sql\nnew file mode 100644\nindex 000000000000..755244e42639\n--- /dev/null\n+++ b/dbms/tests/queries/0_stateless/00563_complex_in_expression.sql\n@@ -0,0 +1,9 @@\n+DROP TABLE IF EXISTS test.test;\n+\n+\n+CREATE TABLE test.test ( dt Date, site_id Int32, site_key String ) ENGINE = MergeTree(dt, (site_id, site_key, dt), 8192);\n+INSERT INTO test.test (dt,site_id, site_key) VALUES ('2018-1-29', 100, 'key');\n+SELECT * FROM test.test WHERE toInt32(site_id) IN (100);\n+SELECT * FROM test.test WHERE toInt32(site_id) IN (100,101);\n+\n+DROP TABLE IF EXISTS test.test;\n",
  "problem_statement": "Code: 1001, type: std::bad_cast, e.what() = std::bad_cast\n\u0415\u0441\u043b\u0438 \u0432\u044b\u043f\u043e\u043b\u043d\u0438\u0442\u044c \u0442\u0430\u043a\u043e\u0439 \u0437\u0430\u043f\u0440\u043e\u0441: \r\n\r\n```sql\r\nCREATE TABLE xxx\r\n(\r\n    dt Date, \r\n    site_id Int32, \r\n    site_key String\r\n) ENGINE = MergeTree(dt, (site_id, site_key, dt), 8192);\r\n;\r\nINSERT INTO xxx (dt,site_id, site_key) VALUES (now(), 100, 'key')\r\n;\r\nSELECT * FROM xxx WHERE toInt32(site_id) IN (100)\r\n```\r\n\r\n\u041e\u0442\u0432\u0435\u0442 \r\n`Code: 1001, type: std::bad_cast, e.what() = std::bad_cast`\r\n\r\n\u0410 \u0435\u0441\u043b\u0438 \u043e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c \r\n\r\n```sql\r\nSELECT * FROM xxx WHERE toInt32(site_id) IN (100,100)\r\n```\r\n\u0422\u043e \u0432\u0441\u0435 \u041e\u043a \n",
  "hints_text": "",
  "created_at": "2018-01-29T01:40:46Z",
  "modified_files": [
    "dbms/src/Interpreters/ExpressionAnalyzer.cpp"
  ],
  "modified_test_files": [
    "b/dbms/tests/queries/0_stateless/00563_complex_in_expression.reference",
    "b/dbms/tests/queries/0_stateless/00563_complex_in_expression.sql"
  ]
}