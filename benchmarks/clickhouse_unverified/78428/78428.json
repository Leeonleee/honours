{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 78428,
  "instance_id": "ClickHouse__ClickHouse-78428",
  "issue_numbers": [
    "77996"
  ],
  "base_commit": "18df3d6f1bf19fb70a3fee5cd22a39ab981b279a",
  "patch": "diff --git a/src/Storages/buildQueryTreeForShard.cpp b/src/Storages/buildQueryTreeForShard.cpp\nindex af1e306ff6f3..2a7b7303ff3a 100644\n--- a/src/Storages/buildQueryTreeForShard.cpp\n+++ b/src/Storages/buildQueryTreeForShard.cpp\n@@ -204,6 +204,8 @@ class DistributedProductModeRewriteInJoinVisitor : public InDepthQueryTreeVisito\n             const auto & distributed_storage_columns = table_node_typed.getStorageSnapshot()->metadata->getColumns();\n             auto storage = std::make_shared<StorageDummy>(resolved_remote_storage_id, distributed_storage_columns);\n             auto replacement_table_expression = std::make_shared<TableNode>(std::move(storage), getContext());\n+            if (auto table_expression_modifiers = table_node_typed.getTableExpressionModifiers())\n+                replacement_table_expression->setTableExpressionModifiers(*table_expression_modifiers);\n             replacement_map.emplace(table_node.get(), std::move(replacement_table_expression));\n         }\n         else if ((distributed_product_mode == DistributedProductMode::GLOBAL || getSettings()[Setting::prefer_global_in_and_join]) &&\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03400_distributed_final.reference b/tests/queries/0_stateless/03400_distributed_final.reference\nnew file mode 100644\nindex 000000000000..5a15d46d9f04\n--- /dev/null\n+++ b/tests/queries/0_stateless/03400_distributed_final.reference\n@@ -0,0 +1,4 @@\n+8888\tAlice\t50\t1\t8888\tAlice\t50\t1\n+8888\tAlice\t50\t1\t8888\tAlice\t50\t1\n+111\tJohn\t33\t2\t111\tJohn\t33\t2\n+111\tJohn\t33\t2\t111\tJohn\t33\t2\ndiff --git a/tests/queries/0_stateless/03400_distributed_final.sql b/tests/queries/0_stateless/03400_distributed_final.sql\nnew file mode 100644\nindex 000000000000..df6c24068853\n--- /dev/null\n+++ b/tests/queries/0_stateless/03400_distributed_final.sql\n@@ -0,0 +1,33 @@\n+DROP TABLE IF EXISTS 03400_users;\n+DROP TABLE IF EXISTS 03400_dist_users;\n+\n+CREATE TABLE 03400_users\n+(\n+    `uid` Int16,\n+    `name` String,\n+    `age` Int16,\n+    `version` UInt8\n+)\n+ENGINE = ReplacingMergeTree(version)\n+ORDER BY (uid, name);\n+\n+INSERT INTO 03400_users VALUES (111, 'John', 33, 1);\n+INSERT INTO 03400_users VALUES (111, 'John', 33, 2);\n+INSERT INTO 03400_users VALUES (8888, 'Alice', 50, 1);\n+\n+CREATE TABLE 03400_dist_users AS 03400_users\n+ENGINE = Distributed(test_cluster_two_shards, currentDatabase(), 03400_users);\n+\n+SET max_threads=1;\n+\n+SELECT *\n+FROM 03400_dist_users AS l\n+FINAL\n+LEFT JOIN\n+(\n+    SELECT *\n+    FROM 03400_dist_users AS d\n+    FINAL\n+) AS r ON l.uid = r.uid\n+ORDER BY l.version\n+SETTINGS distributed_product_mode = 'local';\n",
  "problem_statement": "distributed_product_mode = 'local' ignores FINAL with enabled analyzer\n```\ndrop table if exists users;\ndrop table if exists dist_users;\n\nCREATE TABLE users (uid Int16, name String, age Int16, version UInt8) ENGINE=ReplacingMergeTree(version) order by (uid, name);\n\nINSERT INTO users VALUES (111, 'John', 33, 1);\nINSERT INTO users VALUES (111, 'John', 33, 2);\nINSERT INTO users VALUES (8888, 'Alice', 50, 1);\n\ncreate table dist_users as users engine = Distributed(test_cluster_two_shards, currentDatabase(), users);\n\nset send_logs_level='trace';\nset send_logs_source_regexp='executeQuery';\nset enable_analyzer=0;\nset max_threads=1;\n\n\nselect * from dist_users l final left join (select * from dist_users d final) r on l.uid = r.uid settings distributed_product_mode = 'local';\n```\n\nResult (expected)\n\n```\n\nexecuteQuery:  SELECT `l`.`uid`, `l`.`name`, `l`.`age`, `l`.`version`, `r`.`uid`, `r`.`name`, `r`.`age`, `r`.`version` FROM `default`.`users` AS `l` FINAL ALL LEFT JOIN (SELECT * FROM `default`.`users` AS `d` FINAL) AS `r` ON `l`.`uid` = `r`.`uid` (stage: Complete)\n\n\n   \u250c\u2500\u2500uid\u2500\u252c\u2500name\u2500\u2500\u252c\u2500age\u2500\u252c\u2500version\u2500\u252c\u2500r.uid\u2500\u252c\u2500r.name\u2500\u252c\u2500r.age\u2500\u252c\u2500r.version\u2500\u2510\n1. \u2502 8888 \u2502 Alice \u2502  50 \u2502       1 \u2502  8888 \u2502 Alice  \u2502    50 \u2502         1 \u2502\n2. \u2502  111 \u2502 John  \u2502  33 \u2502       2 \u2502   111 \u2502 John   \u2502    33 \u2502         2 \u2502\n3. \u2502 8888 \u2502 Alice \u2502  50 \u2502       1 \u2502  8888 \u2502 Alice  \u2502    50 \u2502         1 \u2502\n4. \u2502  111 \u2502 John  \u2502  33 \u2502       2 \u2502   111 \u2502 John   \u2502    33 \u2502         2 \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n4 rows in set. Elapsed: 0.008 sec. \n```\n\nResult with analyzer (wrong)\n\n```\n\nset enable_analyzer=1;\n\nselect * from dist_users l final left join (select * from dist_users d final) r on l.uid = r.uid settings distributed_product_mode = 'local';\n\nexecuteQuery: SELECT `__table1`.`uid` AS `uid`, `__table1`.`name` AS `name`, `__table1`.`age` AS `age`, `__table1`.`version` AS `version`, `__table2`.`uid` AS `r.uid`, `__table2`.`name` AS `r.name`, `__table2`.`age` AS `r.age`, `__table2`.`version` AS `r.version` FROM `default`.`users` AS `__table1` FINAL ALL LEFT JOIN (SELECT `__table3`.`uid` AS `uid`, `__table3`.`name` AS `name`, `__table3`.`age` AS `age`, `__table3`.`version` AS `version` FROM `default`.`users` AS `__table3`) AS `__table2` ON `__table1`.`uid` = `__table2`.`uid` (stage: Complete)\n\n\n   \u250c\u2500\u2500uid\u2500\u252c\u2500name\u2500\u2500\u252c\u2500age\u2500\u252c\u2500version\u2500\u252c\u2500r.uid\u2500\u252c\u2500r.name\u2500\u252c\u2500r.age\u2500\u252c\u2500r.version\u2500\u2510\n1. \u2502 8888 \u2502 Alice \u2502  50 \u2502       1 \u2502  8888 \u2502 Alice  \u2502    50 \u2502         1 \u2502\n2. \u2502  111 \u2502 John  \u2502  33 \u2502       2 \u2502   111 \u2502 John   \u2502    33 \u2502         1 \u2502\n3. \u2502  111 \u2502 John  \u2502  33 \u2502       2 \u2502   111 \u2502 John   \u2502    33 \u2502         2 \u2502\n4. \u2502 8888 \u2502 Alice \u2502  50 \u2502       1 \u2502  8888 \u2502 Alice  \u2502    50 \u2502         1 \u2502\n5. \u2502  111 \u2502 John  \u2502  33 \u2502       2 \u2502   111 \u2502 John   \u2502    33 \u2502         1 \u2502\n6. \u2502  111 \u2502 John  \u2502  33 \u2502       2 \u2502   111 \u2502 John   \u2502    33 \u2502         2 \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n6 rows in set. Elapsed: 0.008 sec. \n\n\n```\n\nReason: FINAL is removed from the right part of JOIN for some reason.\n",
  "hints_text": "",
  "created_at": "2025-03-30T07:10:04Z",
  "modified_files": [
    "src/Storages/buildQueryTreeForShard.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/03400_distributed_final.reference",
    "b/tests/queries/0_stateless/03400_distributed_final.sql"
  ]
}