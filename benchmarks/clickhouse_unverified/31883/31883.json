{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 31883,
  "instance_id": "ClickHouse__ClickHouse-31883",
  "issue_numbers": [
    "31819"
  ],
  "base_commit": "d7939a3b61d4df0374c732117722bfc32b545c24",
  "patch": "diff --git a/src/Functions/EmptyImpl.h b/src/Functions/EmptyImpl.h\nindex c3117e0e52db..60daa66ea037 100644\n--- a/src/Functions/EmptyImpl.h\n+++ b/src/Functions/EmptyImpl.h\n@@ -58,7 +58,7 @@ struct EmptyImpl\n     static void uuid(const ColumnUUID::Container & container, size_t n, PaddedPODArray<UInt8> & res)\n     {\n         for (size_t i = 0; i < n; ++i)\n-            res[i] = negative ^ (container.data()->toUnderType() == 0);\n+            res[i] = negative ^ (container[i].toUnderType() == 0);\n     }\n };\n \n",
  "test_patch": "diff --git a/tests/queries/0_stateless/02124_empty_uuid.reference b/tests/queries/0_stateless/02124_empty_uuid.reference\nnew file mode 100644\nindex 000000000000..31c1ccfc7cae\n--- /dev/null\n+++ b/tests/queries/0_stateless/02124_empty_uuid.reference\n@@ -0,0 +1,4 @@\n+00000000-0000-0000-0000-000000000000\t1\n+992f6910-42b2-43cd-98bc-c812fbf9b683\t0\n+992f6910-42b2-43cd-98bc-c812fbf9b683\t0\n+00000000-0000-0000-0000-000000000000\t1\ndiff --git a/tests/queries/0_stateless/02124_empty_uuid.sql b/tests/queries/0_stateless/02124_empty_uuid.sql\nnew file mode 100644\nindex 000000000000..8dbfa3bae27c\n--- /dev/null\n+++ b/tests/queries/0_stateless/02124_empty_uuid.sql\n@@ -0,0 +1,7 @@\n+SELECT\n+    arrayJoin([toUUID('00000000-0000-0000-0000-000000000000'), toUUID('992f6910-42b2-43cd-98bc-c812fbf9b683')]) AS x,\n+    empty(x) AS emp;\n+\n+SELECT\n+    arrayJoin([toUUID('992f6910-42b2-43cd-98bc-c812fbf9b683'), toUUID('00000000-0000-0000-0000-000000000000')]) AS x,\n+    empty(x) AS emp;\n",
  "problem_statement": "incorrect results for empty() of UUID\n```sql\r\nCREATE TABLE some_table\r\n(\r\n    `date` DateTime,\r\n    `banner_id` UUID\r\n)\r\nENGINE = MergeTree\r\nPARTITION BY toYYYYMM(date)\r\nORDER BY date\r\n\r\n---- ALL ROWS ARE 0 = ALL EMPTY\r\ninsert into some_table select today()+rand()%4, toUUID('00000000-0000-0000-0000-000000000000')  \r\nfrom numbers(100);\r\n\r\nSELECT *\r\nFROM\r\n(\r\n    SELECT\r\n        banner_id,\r\n        empty(banner_id) AS empt\r\n    FROM some_table\r\n    LIMIT 10000000 -- to prevent pred. pushdown\r\n)\r\nWHERE (empt = 0) AND (banner_id = toUUID('00000000-0000-0000-0000-000000000000'));\r\n0 rows in set. Elapsed: 0.001 sec. ---- expected result. All OK.\r\n```\r\n\r\n```sql\r\n-- 1/13 of rows are empty\r\ninsert into some_table select today()+rand()%4, \r\n        if(rand(1)%13=0, toUUID('00000000-0000-0000-0000-000000000000'),  generateUUIDv4())  \r\nfrom numbers(100);\r\n\r\n\r\nSELECT *\r\nFROM\r\n(\r\n    SELECT\r\n        banner_id,\r\n        empty(banner_id) AS empt\r\n    FROM some_table\r\n    LIMIT 10000000  -- to prevent pred. pushdown\r\n)\r\nWHERE (empt = 0) AND (banner_id = toUUID('00000000-0000-0000-0000-000000000000'))\r\n\r\nQuery id: 533a2476-b4d6-4fcf-b13f-568cf6acba2f\r\n\r\n\u250c\u2500banner_id\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500empt\u2500\u2510\r\n\u2502 00000000-0000-0000-0000-000000000000 \u2502    0 \u2502\r\n\u2502 00000000-0000-0000-0000-000000000000 \u2502    0 \u2502\r\n\u2502 00000000-0000-0000-0000-000000000000 \u2502    0 \u2502\r\n\u2502 00000000-0000-0000-0000-000000000000 \u2502    0 \u2502\r\n\u2502 00000000-0000-0000-0000-000000000000 \u2502    0 \u2502\r\n\u2502 00000000-0000-0000-0000-000000000000 \u2502    0 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\r\n\r\nexpected result\r\n\r\n```\r\n0 rows in set. Elapsed: 0.001 sec.\r\n```\r\n\r\nempt column should be = 1 , because\r\n\r\n```\r\nSELECT empty(toUUID('00000000-0000-0000-0000-000000000000'))\r\n\u250c\u2500empty(toUUID('00000000-0000-0000-0000-000000000000'))\u2500\u2510\r\n\u2502                                                     1 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```\n",
  "hints_text": "Shorter example\r\n\r\n```sql\r\nSELECT\r\n    arrayJoin([toUUID('00000000-0000-0000-0000-000000000000'), toUUID('992f6910-42b2-43cd-98bc-c812fbf9b683')]) AS x,\r\n    empty(x) AS emp\r\n\u250c\u2500x\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500emp\u2500\u2510\r\n\u2502 00000000-0000-0000-0000-000000000000 \u2502   1 \u2502\r\n\u2502 992f6910-42b2-43cd-98bc-c812fbf9b683 \u2502   1 \u2502 expected 0\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\nSELECT\r\n    arrayJoin([toUUID('992f6910-42b2-43cd-98bc-c812fbf9b683'), toUUID('00000000-0000-0000-0000-000000000000')]) AS x,\r\n    empty(x) AS emp\r\n\r\n\u250c\u2500x\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500emp\u2500\u2510\r\n\u2502 992f6910-42b2-43cd-98bc-c812fbf9b683 \u2502   0 \u2502\r\n\u2502 00000000-0000-0000-0000-000000000000 \u2502   0 \u2502 expected 1\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2518\r\n```",
  "created_at": "2021-11-26T14:41:54Z",
  "modified_files": [
    "src/Functions/EmptyImpl.h"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/02124_empty_uuid.reference",
    "b/tests/queries/0_stateless/02124_empty_uuid.sql"
  ]
}