{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 19134,
  "instance_id": "ClickHouse__ClickHouse-19134",
  "issue_numbers": [
    "19095"
  ],
  "base_commit": "1b37d7716f76137e5a98010ac39e81317c7678a6",
  "patch": "diff --git a/src/Processors/Formats/Impl/ORCBlockInputFormat.cpp b/src/Processors/Formats/Impl/ORCBlockInputFormat.cpp\nindex 8bbf0fc089b8..7776a904f1cc 100644\n--- a/src/Processors/Formats/Impl/ORCBlockInputFormat.cpp\n+++ b/src/Processors/Formats/Impl/ORCBlockInputFormat.cpp\n@@ -28,7 +28,7 @@ Chunk ORCBlockInputFormat::generate()\n     Chunk res;\n     const Block & header = getPort().getHeader();\n \n-    if (in.eof())\n+    if (file_reader)\n         return res;\n \n     arrow::Status open_status = arrow::adapters::orc::ORCFileReader::Open(asArrowFile(in), arrow::default_memory_pool(), &file_reader);\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/00900_orc_load.reference b/tests/queries/0_stateless/00900_orc_load.reference\nindex fe79e37ee18c..04c72eccb173 100644\n--- a/tests/queries/0_stateless/00900_orc_load.reference\n+++ b/tests/queries/0_stateless/00900_orc_load.reference\n@@ -1,2 +1,4 @@\n 0\t0\t0\t0\t0\t2019-01-01\ttest1\n 2147483647\t-1\t9223372036854775806\t123.345345\t345345.3453451212\t2019-01-01\ttest2\n+0\t0\t0\t0\t0\t2019-01-01\ttest1\n+2147483647\t-1\t9223372036854775806\t123.345345\t345345.3453451212\t2019-01-01\ttest2\ndiff --git a/tests/queries/0_stateless/00900_orc_load.sh b/tests/queries/0_stateless/00900_orc_load.sh\nindex a0bacff43e58..aae752be3e99 100755\n--- a/tests/queries/0_stateless/00900_orc_load.sh\n+++ b/tests/queries/0_stateless/00900_orc_load.sh\n@@ -9,6 +9,7 @@ DATA_FILE=$CUR_DIR/data_orc/test.orc\n ${CLICKHOUSE_CLIENT} --query=\"DROP TABLE IF EXISTS orc_load\"\n ${CLICKHOUSE_CLIENT} --query=\"CREATE TABLE orc_load (int Int32, smallint Int8, bigint Int64, float Float32, double Float64, date Date, y String) ENGINE = Memory\"\n cat \"$DATA_FILE\"  | ${CLICKHOUSE_CLIENT} -q \"insert into orc_load format ORC\"\n+timeout 3 ${CLICKHOUSE_CLIENT} -q \"insert into orc_load format ORC\" < $DATA_FILE\n ${CLICKHOUSE_CLIENT} --query=\"select * from orc_load\"\n \n ${CLICKHOUSE_CLIENT} --query=\"drop table orc_load\"\n",
  "problem_statement": "Import from ORC doesn't finish\nI have an ORC file with 10 mln rows. I created a table with the same structure and executed `insert into <table> select * from file('<filename>', ORC, '<fields>')` . Rows were inserted, and `select count(1) from <table>` gave me 10 mln. But query didn't stop, and still is running. `select query, written_rows from system.processes` shows 700 mln inserted rows and counting.\r\n\r\n`CREATE TABLE t (a lot of ordinary fields) ENGINE = ReplicatedReplacingMergeTree('/clickhouse/tables/{shard}/t', '{replica}') PARTITION BY toYYYYMM(calday) ORDER BY (calday) SETTINGS index_granularity = 8192`\r\nclickhouse version 20.8.2.3.\r\n\r\n**Expected behavior**\r\nQuery is finished.\n",
  "hints_text": "Could you please share the file to reproduce the issue?\r\nYou can obfuscate data or send it privately to clickhouse-feedback@yandex-team.com\nSent to  clickhouse-feedback@yandex-team.com\nRepro:\r\n\r\n```sql\r\ncreate table t (number UInt64) engine = MergeTree order by number;\r\nselect number from numbers(10) into outfile 'out.orc' format ORC settings max_block_size = 5;\r\n```\r\nThis query cause infinite loop:\r\n\r\n```sh\r\n$ clickhouse client -q \"insert into t format ORC\" < ~/out.orc\r\n```\r\nData is inserted all the time:\r\n```\r\n:) select count() from t\r\n\r\nSELECT count()\r\nFROM t\r\n\r\nQuery id: ac95b92c-2307-4c2c-97ef-2d436b71521b\r\n\r\n\u250c\u2500count()\u2500\u2510\r\n\u2502 3145650 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n\r\n1 rows in set. Elapsed: 0.002 sec. \r\n\r\n :) select count() from t\r\n\r\nSELECT count()\r\nFROM t\r\n\r\nQuery id: 57bb9beb-8aa3-4132-8175-9242c74de50f\r\n\r\n\u250c\u2500count()\u2500\u2510\r\n\u2502 4194200 \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n```",
  "created_at": "2021-01-15T15:51:38Z",
  "modified_files": [
    "src/Processors/Formats/Impl/ORCBlockInputFormat.cpp"
  ],
  "modified_test_files": [
    "tests/queries/0_stateless/00900_orc_load.reference",
    "tests/queries/0_stateless/00900_orc_load.sh"
  ]
}