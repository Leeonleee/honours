{
  "repo": "ClickHouse/ClickHouse",
  "pull_number": 71140,
  "instance_id": "ClickHouse__ClickHouse-71140",
  "issue_numbers": [
    "71097"
  ],
  "base_commit": "a6fff970ac702f2a093ff5397d781cff68a99d9a",
  "patch": "diff --git a/src/Server/TCPHandler.cpp b/src/Server/TCPHandler.cpp\nindex 921c53b6bcb7..e7e4ae25a68c 100644\n--- a/src/Server/TCPHandler.cpp\n+++ b/src/Server/TCPHandler.cpp\n@@ -301,6 +301,9 @@ void TCPHandler::runImpl()\n     {\n         receiveHello();\n \n+        if (!default_database.empty())\n+            DatabaseCatalog::instance().assertDatabaseExists(default_database);\n+\n         /// In interserver mode queries are executed without a session context.\n         if (!is_interserver_mode)\n             session->makeSessionContext();\n",
  "test_patch": "diff --git a/tests/queries/0_stateless/03258_nonexistent_db.reference b/tests/queries/0_stateless/03258_nonexistent_db.reference\nnew file mode 100644\nindex 000000000000..825bae3beaa1\n--- /dev/null\n+++ b/tests/queries/0_stateless/03258_nonexistent_db.reference\n@@ -0,0 +1,2 @@\n+UNKNOWN_DATABASE\n+OK\ndiff --git a/tests/queries/0_stateless/03258_nonexistent_db.sh b/tests/queries/0_stateless/03258_nonexistent_db.sh\nnew file mode 100755\nindex 000000000000..847d692c440a\n--- /dev/null\n+++ b/tests/queries/0_stateless/03258_nonexistent_db.sh\n@@ -0,0 +1,7 @@\n+#!/usr/bin/env bash\n+\n+CURDIR=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n+# shellcheck source=../shell_config.sh\n+. \"$CURDIR\"/../shell_config.sh\n+\n+timeout 5 ${CLICKHOUSE_CLIENT_BINARY} --database \"nonexistent\" 2>&1 | grep -o \"UNKNOWN_DATABASE\" && echo \"OK\" || echo \"FAIL\"\n",
  "problem_statement": "Client should refuse to connect to a database that does not exist.\n**How to reproduce**\r\n\r\n```\r\nmilovidov@milovidov-pc:~$ clickhouse-client --database upyachka\r\nClickHouse client version 24.11.1.1.\r\nConnecting to database upyachka at localhost:9000 as user default.\r\nConnected to ClickHouse server version 24.11.1.\r\n\r\nCannot load data for command line suggestions: Code: 81. DB::Exception: Received from localhost:9000. DB::Exception: Database upyachka does not exist. (UNKNOWN_DATABASE) (version 24.11.1.1)\r\nmilovidov-pc :) Bye.\r\n```\n",
  "hints_text": "",
  "created_at": "2024-10-28T16:00:05Z",
  "modified_files": [
    "src/Server/TCPHandler.cpp"
  ],
  "modified_test_files": [
    "b/tests/queries/0_stateless/03258_nonexistent_db.reference",
    "b/tests/queries/0_stateless/03258_nonexistent_db.sh"
  ]
}