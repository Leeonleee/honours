{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 4506,
  "instance_id": "dragonflydb__dragonfly-4506",
  "issue_numbers": [
    "4505"
  ],
  "base_commit": "23af41ca070386c0fe55b070cca36fb32ed889eb",
  "patch": "diff --git a/helio b/helio\nindex 2ab4412b78af..54a854715599 160000\n--- a/helio\n+++ b/helio\n@@ -1,1 +1,1 @@\n-Subproject commit 2ab4412b78afbf7d3102b472fb0e6f70b194a535\n+Subproject commit 54a854715599ec724727ca09171f3b54d0855872\ndiff --git a/tools/packaging/debian/dragonfly.service b/tools/packaging/debian/dragonfly.service\nindex 0bb02994bb6d..593076eb1c03 100755\n--- a/tools/packaging/debian/dragonfly.service\n+++ b/tools/packaging/debian/dragonfly.service\n@@ -6,7 +6,7 @@ Documentation=\n [Service]\n Type=simple\n EnvironmentFile=-/etc/dragonfly/environment\n-ExecStart=/usr/bin/dragonfly --flagfile=/etc/dragonfly/dragonfly.conf\n+ExecStart=/usr/local/bin/dragonfly --flagfile=/etc/dragonfly/dragonfly.conf\n PIDFile=/var/run/dragonfly/dragonfly.pid\n TimeoutStopSec=infinity\n Restart=always\ndiff --git a/tools/packaging/rpm/dragonfly.spec b/tools/packaging/rpm/dragonfly.spec\nindex 6b6229ee3d4c..0e05e4270c80 100644\n--- a/tools/packaging/rpm/dragonfly.spec\n+++ b/tools/packaging/rpm/dragonfly.spec\n@@ -35,6 +35,8 @@ mv ./dragonfly-%{_arch} ./dragonfly\n %install\n mkdir -p %{buildroot}/usr/local/bin\n mkdir -p %{buildroot}/etc/dragonfly\n+mkdir -p %{buildroot}/var/log/dragonfly\n+mkdir -p %{buildroot}/var/lib/dragonfly\n \n install -m 755 ./dragonfly %{buildroot}/usr/local/bin/\n mkdir -p %{buildroot}/usr/lib/systemd/system\n",
  "test_patch": "diff --git a/src/server/rdb_test.cc b/src/server/rdb_test.cc\nindex 6a312357878d..8d1ad4029f36 100644\n--- a/src/server/rdb_test.cc\n+++ b/src/server/rdb_test.cc\n@@ -458,8 +458,8 @@ TEST_F(RdbTest, JsonTest) {\n class HllRdbTest : public RdbTest, public testing::WithParamInterface<string> {};\n \n TEST_P(HllRdbTest, Hll) {\n-  LOG(INFO) << \" max memory: \" << max_memory_limit\n-            << \" used_mem_current: \" << used_mem_current.load();\n+  LOG(ERROR) << \" max memory: \" << max_memory_limit\n+             << \" used_mem_current: \" << used_mem_current.load();\n   auto ec = LoadRdb(\"hll.rdb\");\n \n   ASSERT_FALSE(ec) << ec.message();\n",
  "problem_statement": "Problems with dragonfly service on Oracle Linux\n**Describe the bug**\n\n1. After installing Dragonfly from dragonfly.x86_64.rpm on OracleLinux, the service does not start. The reason for this issue is the dragonfly.service lists /usr/bin/dragonfly binary, but the correct path is /usr/local/bin/dragonfly.\n\n2. After fixing (1) and starting the service, any attempt to stop the service hangs indefinitely.  I believe this is due to the fact that the process does not react to SIGTERM, (only SIGKILL). Adding TimeoutStopSec=1 to the dragonfly.service resolves the issue, because systemctl uses SIGKILL after 1 sec. \n\n3. When I try to reboot the host, the problem (2) prevents the host from rebooting. I mean, at all. I have to power cycle the host. Adding TimeoutStopSec=1 to the dragonfly.service resolves this issue as well.\n\n**To Reproduce**\n\ndnf install dragonfly.x86_64.rpm\nsystemctl enable dragonfly\nsystemctl start dragonfly\nsystemctl stop dragonfly\nreboot\n\n**Environment**\n\nOracle Linux Server 9.5\nDragonfly Version: [1.26.1]\n\n\n",
  "hints_text": "Hello @vbickov .\n\nI tried to reproduce it on Amazon Linux.\n\nI confirm I am able to reproduce (1). Moreover, it seems that the process is not able to write the log files because `/var/log/dragonfly/` does not exist.\n\nI did not succeed to reproduce (2). this is what I see in the log (after I fixed the directories):\n```\nI20250126 06:10:24.629351  2762 accept_server.cc:25] Exiting on signal Terminated\nI20250126 06:10:24.630683  2763 listener_interface.cc:224] Listener stopped for port 6379\nW20250126 06:10:24.632566  2763 server_family.cc:983] Failed to perform snapshot Permission denied: Failed to create directories\n```\n\nDragonfly reacts to SIGTERM and SIGINT. You can see it by just running it directly via the terminal: \n`/usr/local/bin/dragonfly --logtostderr` and then sending these signals with `kill`\nok, I see the problem with Oracle Linux. interesting.\nok, found the problem. it's related to io_uring. You can workaround it by adding `--force_epoll` to `/etc/dragonfly/dragonfly.conf`\nAlso, found the root reason for deadlocking on exit. It will be fixed in 1.27",
  "created_at": "2025-01-26T07:40:44Z",
  "modified_files": [
    "helio",
    "tools/packaging/debian/dragonfly.service",
    "tools/packaging/rpm/dragonfly.spec"
  ],
  "modified_test_files": [
    "src/server/rdb_test.cc"
  ]
}