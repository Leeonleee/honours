{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 4283,
  "instance_id": "dragonflydb__dragonfly-4283",
  "issue_numbers": [
    "4167"
  ],
  "base_commit": "f428dc31be1e4757107c43b4a28e369507e60a22",
  "patch": "diff --git a/src/core/compact_object.cc b/src/core/compact_object.cc\nindex d6d4f43eaa4b..5c19a308457b 100644\n--- a/src/core/compact_object.cc\n+++ b/src/core/compact_object.cc\n@@ -305,9 +305,9 @@ pair<void*, bool> DefragSet(unsigned encoding, void* ptr, float ratio) {\n       return DefragIntSet((intset*)ptr, ratio);\n     }\n \n-    // StringMap supports re-allocation of it's internal nodes\n     case kEncodingStrMap2: {\n-      return DefragStrMap2((StringMap*)ptr, ratio);\n+      // Still not implemented\n+      return {ptr, false};\n     }\n \n     default:\n",
  "test_patch": "diff --git a/src/core/compact_object_test.cc b/src/core/compact_object_test.cc\nindex bff60e3f43b9..601936dfb62b 100644\n--- a/src/core/compact_object_test.cc\n+++ b/src/core/compact_object_test.cc\n@@ -16,6 +16,7 @@\n #include \"core/detail/bitpacking.h\"\n #include \"core/flat_set.h\"\n #include \"core/mi_memory_resource.h\"\n+#include \"core/string_set.h\"\n \n extern \"C\" {\n #include \"redis/intset.h\"\n@@ -575,6 +576,14 @@ TEST_F(CompactObjectTest, DefragHash) {\n   }\n }\n \n+TEST_F(CompactObjectTest, DefragSet) {\n+  // This is still not implemented\n+  StringSet* s = new StringSet();\n+  s->Add(\"str\");\n+  cobj_.InitRobj(OBJ_SET, kEncodingStrMap2, s);\n+  ASSERT_FALSE(cobj_.DefragIfNeeded(0.8));\n+}\n+\n TEST_F(CompactObjectTest, RawInterface) {\n   string str(50, 'a'), tmp, owned;\n   cobj_.SetString(str);\n",
  "problem_statement": "crash in dense set defragmentation\nSee below:\r\n\r\n```\r\n#3  0x00007ffff7c4526e in __GI_raise (sig=11) at ../sysdeps/posix/raise.c:26\r\n#4  0x00005555561da46e in absl::lts_20240116::AbslFailureSignalHandler(int, siginfo_t*, void*) ()\r\n#5  <signal handler called>\r\n#6  0x0000555555b362c3 in mi_slice_first (slice=0x65e19793ae006108) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/include/mimalloc/internal.h:471\r\n#7  _mi_segment_page_of (p=0x65e19793af000000, segment=<optimized out>) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/include/mimalloc/internal.h:486\r\n#8  _mi_ptr_page (p=0x65e19793af000000) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/include/mimalloc/internal.h:502\r\n#9  mi_heap_page_is_underutilized (heap=0x339c2110800, p=p@entry=0x65e19793af000000, ratio=0, ratio@entry=0.800000012) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/src/alloc.c:581\r\n#10 0x0000555555b33906 in zmalloc_page_is_underutilized (ptr=ptr@entry=0x65e19793af000000, ratio=ratio@entry=0.800000012) at ../src/redis/zmalloc_mi.c:179\r\n#11 0x0000555555a6192a in dfly::StringMap::ReallocIfNeeded (this=<optimized out>, obj=0x339c27d1a03, ratio=0.800000012) at ../src/core/string_map.cc:198\r\n#12 0x0000555555a61b02 in <lambda(auto:25*)>::operator()<dfly::DenseSet::DensePtr> (ptr=0x339c2188640, __closure=0x339f234d7c0) at ../src/core/string_map.cc:304\r\n#13 std::_Function_handler<void(dfly::DenseSet::DensePtr*), dfly::StringMap::iterator::ReallocIfNeeded(float)::<lambda(auto:25*)> >::_M_invoke(const std::_Any_data &, dfly::DenseSet::DensePtr *&&) (__functor=...,\r\n    __args#0=<optimized out>) at /usr/include/c++/9/bits/std_function.h:300\r\n#14 0x0000555555a47970 in std::function<void (dfly::DenseSet::DensePtr*)>::operator()(dfly::DenseSet::DensePtr*) const (__args#0=<optimized out>, this=0x7fffe8007f50) at /usr/include/c++/9/bits/std_function.h:688\r\n#15 dfly::DenseSet::IteratorBase::TraverseApply(dfly::DenseSet::DensePtr*, std::function<void (dfly::DenseSet::DensePtr*)>) (this=this@entry=0x7fffe8007fb0, ptr=<optimized out>, fun=...) at ../src/core/dense_set.cc:855\r\n#16 0x0000555555a61da0 in dfly::StringMap::iterator::ReallocIfNeeded (this=this@entry=0x7fffe8007fb0, ratio=ratio@entry=0.800000012) at ../src/core/string_map.cc:309\r\n#17 0x0000555555a414ee in dfly::(anonymous namespace)::DefragStrMap2 (ratio=0.800000012, sm=0x339c2401470) at ../src/core/compact_object.cc:157\r\n#18 dfly::(anonymous namespace)::DefragSet (ratio=0.800000012, ptr=0x339c2401470, encoding=<optimized out>) at ../src/core/compact_object.cc:220\r\n```\n",
  "hints_text": "More stack traces:\r\n```\r\n#3  0x00007ffff7c4526e in __GI_raise (sig=11) at ../sysdeps/posix/raise.c:26\r\n#4  0x00005555561da46e in absl::lts_20240116::AbslFailureSignalHandler(int, siginfo_t*, void*) ()\r\n#5  <signal handler called>\r\n#6  0x0000555555b362c3 in mi_slice_first (slice=0x6572012c28006dc8) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/include/mimalloc/internal.h:471\r\n#7  _mi_segment_page_of (p=0x6572012c29222c30, segment=<optimized out>) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/include/mimalloc/internal.h:486\r\n#8  _mi_ptr_page (p=0x6572012c29222c30) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/include/mimalloc/internal.h:502\r\n#9  mi_heap_page_is_underutilized (heap=0x3c1f0110000, p=p@entry=0x6572012c29222c30, ratio=0, ratio@entry=0.800000012) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/src/alloc.c:581\r\n#10 0x0000555555b33906 in zmalloc_page_is_underutilized (ptr=ptr@entry=0x6572012c29222c30, ratio=ratio@entry=0.800000012) at ../src/redis/zmalloc_mi.c:179\r\n#11 0x0000555555a6192a in dfly::StringMap::ReallocIfNeeded (this=<optimized out>, obj=0x3c21f2a9513, ratio=0.800000012) at ../src/core/string_map.cc:198\r\n#12 0x0000555555a61b02 in <lambda(auto:25*)>::operator()<dfly::DenseSet::DensePtr> (ptr=0x3c1f0181b50, __closure=0x3c27a529a20) at ../src/core/string_map.cc:304\r\n#13 std::_Function_handler<void(dfly::DenseSet::DensePtr*), dfly::StringMap::iterator::ReallocIfNeeded(float)::<lambda(auto:25*)> >::_M_invoke(const std::_Any_data &, dfly::DenseSet::DensePtr *&&) (__functor=...,\r\n    __args#0=<optimized out>) at /usr/include/c++/9/bits/std_function.h:300\r\n#14 0x0000555555a47970 in std::function<void (dfly::DenseSet::DensePtr*)>::operator()(dfly::DenseSet::DensePtr*) const (__args#0=<optimized out>, this=0x7fffe8007f50) at /usr/include/c++/9/bits/std_function.h:688\r\n#15 dfly::DenseSet::IteratorBase::TraverseApply(dfly::DenseSet::DensePtr*, std::function<void (dfly::DenseSet::DensePtr*)>) (this=this@entry=0x7fffe8007fb0, ptr=<optimized out>, fun=...) at ../src/core/dense_set.cc:855\r\n#16 0x0000555555a61da0 in dfly::StringMap::iterator::ReallocIfNeeded (this=this@entry=0x7fffe8007fb0, ratio=ratio@entry=0.800000012) at ../src/core/string_map.cc:309\r\n#17 0x0000555555a414ee in dfly::(anonymous namespace)::DefragStrMap2 (ratio=0.800000012, sm=0x3c27102e9f0) at ../src/core/compact_object.cc:157\r\n#18 dfly::(anonymous namespace)::DefragSet (ratio=0.800000012, ptr=0x3c27102e9f0, encoding=<optimized out>) at ../src/core/compact_object.cc:220\r\n#19 <lambda(auto:23)>::operator()<std::pair<void*, bool> (*)(unsigned int, void*, float)> (__closure=<synthetic pointer>, __closure=<synthetic pointer>, defrag_fun=<optimized out>) at ../src/core/compact_object.cc:460\r\n#20 dfly::detail::RobjWrapper::DefragIfNeeded (this=0x3c1f01b6450, ratio=ratio@entry=0.800000012) at ../src/core/compact_object.cc:473\r\n#21 0x0000555555a41ceb in dfly::CompactObj::DefragIfNeeded (this=<optimized out>, ratio=ratio@entry=0.800000012) at ../src/core/compact_object.cc:932\r\n#22 0x0000555555953978 in <lambda(dfly::PrimeIterator)>::operator() (__closure=<optimized out>, it=...) at ../src/server/engine_shard.cc:335\r\n#23 <lambda(const SegmentIterator&)>::operator() (it=..., it=..., this=<optimized out>) at ../src/core/dash.h:945\r\n```\r\n\r\n```\r\n#6  0x0000555555b362c3 in mi_slice_first (slice=0x130c7bee900026e8) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/include/mimalloc/internal.h:471\r\n#7  _mi_segment_page_of (p=0x130c7bee90657065, segment=<optimized out>) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/include/mimalloc/internal.h:486\r\n#8  _mi_ptr_page (p=0x130c7bee90657065) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/include/mimalloc/internal.h:502\r\n#9  mi_heap_page_is_underutilized (heap=0x4130c110800, p=p@entry=0x130c7bee90657065, ratio=0, ratio@entry=0.800000012) at /__w/dragonfly/dragonfly/build-release/third_party/mimalloc/src/alloc.c:581\r\n#10 0x0000555555b33906 in zmalloc_page_is_underutilized (ptr=ptr@entry=0x130c7bee90657065, ratio=ratio@entry=0.800000012) at ../src/redis/zmalloc_mi.c:179\r\n#11 0x0000555555a6192a in dfly::StringMap::ReallocIfNeeded (this=<optimized out>, obj=0x4130c7bd7b3, ratio=0.800000012) at ../src/core/string_map.cc:198\r\n#12 0x0000555555a61b02 in <lambda(auto:25*)>::operator()<dfly::DenseSet::DensePtr> (ptr=0x4130c699c50, __closure=0x41390d9c540) at ../src/core/string_map.cc:304\r\n#13 std::_Function_handler<void(dfly::DenseSet::DensePtr*), dfly::StringMap::iterator::ReallocIfNeeded(float)::<lambda(auto:25*)> >::_M_invoke(const std::_Any_data &, dfly::DenseSet::DensePtr *&&) (__functor=...,\r\n    __args#0=<optimized out>) at /usr/include/c++/9/bits/std_function.h:300\r\n#14 0x0000555555a47970 in std::function<void (dfly::DenseSet::DensePtr*)>::operator()(dfly::DenseSet::DensePtr*) const (__args#0=<optimized out>, this=0x7fffe8007f50) at /usr/include/c++/9/bits/std_function.h:688\r\n#15 dfly::DenseSet::IteratorBase::TraverseApply(dfly::DenseSet::DensePtr*, std::function<void (dfly::DenseSet::DensePtr*)>) (this=this@entry=0x7fffe8007fb0, ptr=<optimized out>, fun=...) at ../src/core/dense_set.cc:855\r\n#16 0x0000555555a61da0 in dfly::StringMap::iterator::ReallocIfNeeded (this=this@entry=0x7fffe8007fb0, ratio=ratio@entry=0.800000012) at ../src/core/string_map.cc:309\r\n#17 0x0000555555a414ee in dfly::(anonymous namespace)::DefragStrMap2 (ratio=0.800000012, sm=0x4130c65bf80) at ../src/core/compact_object.cc:157\r\n#18 dfly::(anonymous namespace)::DefragSet (ratio=0.800000012, ptr=0x4130c65bf80, encoding=<optimized out>) at ../src/core/compact_object.cc:220\r\n#19 <lambda(auto:23)>::operator()<std::pair<void*, bool> (*)(unsigned int, void*, float)> (__closure=<synthetic pointer>, __closure=<synthetic pointer>, defrag_fun=<optimized out>) at ../src/core/compact_object.cc:460\r\n#20 dfly::detail::RobjWrapper::DefragIfNeeded (this=0x4130c1b6474, ratio=ratio@entry=0.800000012) at ../src/core/compact_object.cc:473\r\n#21 0x0000555555a41ceb in dfly::CompactObj::DefragIfNeeded (this=<optimized out>, ratio=ratio@entry=0.800000012) at ../src/core/compact_object.cc:932\r\n#22 0x0000555555953978 in <lambda(dfly::PrimeIterator)>::operator() (__closure=<optimized out>, it=...) at ../src/server/engine_shard.cc:335\r\n#23 <lambda(const SegmentIterator&)>::operator() (it=..., it=..., this=<optimized out>) at ../src/core/dash.h:945\r\n```\r\n\nmy intuition is that a pointer passed to zmalloc_page_is_underutilized is invalid.\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]: *** SIGSEGV received at time=1733684363 on cpu 2 ***\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]: PC: @     0xaaaaaafe0630  (unknown)  mi_heap_page_is_underutilized\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]:     @     0xaaaaab58e924        480  absl::lts_20240116::AbslFailureSignalHandler()\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]:     @     0xfffff7ffb8f8       4960  (unknown)\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]:     @     0xaaaaaaf19564         16  dfly::StringMap::ReallocIfNeeded()\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]:     @     0xaaaaaaf198dc         96  dfly::StringMap::iterator::ReallocIfNeeded()\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]:     @     0xaaaaaaefaf00         32  dfly::detail::RobjWrapper::DefragIfNeeded()\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]:     @     0xaaaaaae2217c         96  dfly::EngineShard::DoDefrag()\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]:     @     0xaaaaaae22514        304  dfly::EngineShard::DefragTask()\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]:     @     0xaaaaab345aac        160  util::fb2::ProactorBase::RunOnIdleTasks()\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]:     @     0xaaaaab38c63c         80  util::fb2::UringProactor::MainLoop()\r\nDec 08 18:59:23 ip-10-12-6-201 dragonfly[1813]:     @     0xaaaaab34df28       1568  boost::context::detail::fiber_entry<>()\r\n\nSo it wasn't my PR :smile: \nHere is everything I know, mostly to arrange my thoughts, but also if anyone has any feedback or ideas feel free.\r\n\r\nI was able to acquire the coredump and loaded it to an ARM machine (like the production). I should say that despite it being and ARM machine, it's configured to run with little endian (like x64), I thought that we forgot to call `absl::little_endian::Store*` somewhere but that's not likely.\r\n\r\nAnyway, like Roman suspected above, indeed we pass an invalid pointer to `zmalloc_page_is_underutilized`. I'll use `?` to hide customer data, so that character represents a single character in the coredump.\r\n\r\nLooking into `StringMap::ReallocIfNeeded` (line 198, frame 10 in the core dump) we have:\r\n\r\n```\r\n(gdb) p key\r\n$53 = (sds) 0x5b2d1bd52c3 \"?????????????????????????????????????????????\"\r\n```\r\n\r\nThis is indeed a valid `sds`, as examining its header:\r\n\r\n```\r\n(gdb) x/3 key-3\r\n0x5b2d1bd52c0:  0x2c    0x2c    0x01\r\n```\r\n\r\nWhere `0x2c` is 44, the length of the string, the other `0x2c` is the capacity, and `0x01` is the encoding (single byte size).\r\n\r\nSo this data seems to be valid, and interestingly is has the same size as it has capacity. This is suspicious, as every allocation for key in string map calls `AllocSdsWithSpace()` (see `CreateEntry()`) with _at least_ 8 more bytes.\r\n\r\nAnyway, later we call `value_ptr = key + key_len + 1`. This is _supposed_ to be the pointer to the value, but in reality it's just an sds string:\r\n\r\n```\r\n(gdb) p value_ptr\r\n$55 = 0x5b2d1bd52f0 \"$,\\001{??????????????????????????????????}\"\r\n```\r\n\r\nWhere, again, `$`'s ASCII value is 36, the length of the string, and `,`'s ASCII value is 44, which is 36+8, meaning it's likely supposed to be a key in a string map (maybe not this key or even this map). I've kept the curly braces to show that this is likely also some pointer to a key, as this customer uses BullMQ and wraps queue names with curly braces.\r\n\r\nAnother interesting data point is that this string map (climbing up the frames) seems to have a vector of size 4 (`entries_`), but only the first one is used, so I think this means it only has a single entry.\r\n\r\nI've been trying for several hours to read the code and find a place where we might mistakenly override the key with invalid data, so far to no avail. I'll continue investigating.\n@chakaz  seems that you already made a great progress. We can write the self verification code at line 190 and 216 that calls `sdsavail` to ensure that key capacity space is indeed what we think it is. \n@romange what's the purpose of this verification code?\r\nIt won't crash, but it's too late in that we're already in a bad state (memory corruption), and could definitely crash later.\r\nPerhaps we should add verification code in places where they are likely to happen?\r\n\r\nBTW I'm not sure `sdsavail` would actually help here, because to my understanding `AllocSdsWithSpace()` allocates with mimalloc beyond what SDS is aware of (i.e. it tells sds that it has a size X but allocates with mimalloc/zmalloc X+8 or X+12)\noh, right, in this case seeing `0x2c    0x2c    0x01` is expected and we actually have not progressed to recognize the invalid state. The purpose of verification code is not necessary to prevent the crash but to provide us more information that we can not get from the coredump. I have not seen the coredump, lets sync tomorrow, because I do not understand what invalid pointer is passed to `zmalloc_page_is_underutilized` and what's its value. And all the pointers you mentioned here look valid.\nThe invalid pointer comes from:\r\n\r\n```\r\n(gdb) p value_ptr\r\n$55 = 0x5b2d1bd52f0 \"$,\\001{??????????????????????????????????}\"\r\n```\r\n\r\nHere:\r\n\r\nhttps://github.com/dragonflydb/dragonfly/blob/4428480a4eaea222d5c3284f641ce73c1b023771/src/core/string_map.cc#L188-L193\r\n\r\nThis is a value sds, but our code expects this to be the start of the `value_tag` with which we'll find `value`. So we try to parse `\"$,\\001{????` as an address (and remove `kValTtlBit` bit).",
  "created_at": "2024-12-10T08:00:30Z",
  "modified_files": [
    "src/core/compact_object.cc"
  ],
  "modified_test_files": [
    "src/core/compact_object_test.cc"
  ]
}