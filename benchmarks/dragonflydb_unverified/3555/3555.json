{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 3555,
  "instance_id": "dragonflydb__dragonfly-3555",
  "issue_numbers": [
    "3500"
  ],
  "base_commit": "c87fcedf1f88fe55b155f33b657dd577fbee4286",
  "patch": "diff --git a/src/core/search/indices.cc b/src/core/search/indices.cc\nindex 538d844b8759..a6d490e0caef 100644\n--- a/src/core/search/indices.cc\n+++ b/src/core/search/indices.cc\n@@ -85,8 +85,12 @@ void NumericIndex::Remove(DocId id, DocumentAccessor* doc, string_view field) {\n }\n \n vector<DocId> NumericIndex::Range(double l, double r) const {\n+  if (r < l)\n+    return {};\n+\n   auto it_l = entries_.lower_bound({l, 0});\n   auto it_r = entries_.lower_bound({r, numeric_limits<DocId>::max()});\n+  DCHECK_GE(it_r - it_l, 0);\n \n   vector<DocId> out;\n   for (auto it = it_l; it != it_r; ++it)\n",
  "test_patch": "diff --git a/src/server/search/search_family_test.cc b/src/server/search/search_family_test.cc\nindex 62d26319db45..0709ac3971bb 100644\n--- a/src/server/search/search_family_test.cc\n+++ b/src/server/search/search_family_test.cc\n@@ -433,15 +433,12 @@ TEST_F(SearchFamilyTest, Numbers) {\n \n   // Test negation of ranges:\n   EXPECT_THAT(Run({\"ft.search\", \"i1\", \"@i:[9 9] -@j:[1 10]\"}), AreDocIds(\"i9j0\"));\n+  EXPECT_THAT(Run({\"ft.search\", \"i1\", \"-@i:[0 9] -@j:[1 10]\"}), AreDocIds(\"i10j0\"));\n \n-  // TODO: Check on new algo\n-  // EXPECT_THAT(Run({\"ft.search\", \"i1\", \"-@i:[0 9] -@j:[1 10]\"}), AreDocIds(\"i10j0\"));\n-\n-  /*\n-  TODO: Breaks the parser\n-  EXPECT_THAT(Run({\"ft.search\", \"i1\", \"(@i:[1 3] ! @i:[2 2]) @j:[7 7]\"}),\n-              DocIds(vector<string>{\"i1j7\", \"i3j7\"}));\n-  */\n+  // Test empty range\n+  EXPECT_THAT(Run({\"ft.search\", \"i1\", \"@i:[9 1]\"}), AreDocIds());\n+  EXPECT_THAT(Run({\"ft.search\", \"i1\", \"@j:[5 0]\"}), AreDocIds());\n+  EXPECT_THAT(Run({\"ft.search\", \"i1\", \"@i:[7 1] @j:[6 2]\"}), AreDocIds());\n }\n \n TEST_F(SearchFamilyTest, TestLimit) {\n",
  "problem_statement": "Ram overflow error when querying number range\nstart: 1723161599\r\nend: 1723075200\r\n\r\nquery:\r\n\r\n`\"FT.SEARCH\" \"sales-orders-idx\" @createdAt:[1723161599 1723075200]\" \"LIMIT\" \"0\" \"2\"`\r\n\r\nwhen i query small number @createdAt[2 0] no error\r\n\r\n![image](https://github.com/user-attachments/assets/66fe98cd-92b1-40ab-b0b2-c6d92f78a833)\r\n\r\n\n",
  "hints_text": "",
  "created_at": "2024-08-24T08:08:35Z",
  "modified_files": [
    "src/core/search/indices.cc"
  ],
  "modified_test_files": [
    "src/server/search/search_family_test.cc"
  ]
}