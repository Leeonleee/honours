{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 4160,
  "instance_id": "dragonflydb__dragonfly-4160",
  "issue_numbers": [
    "3776"
  ],
  "base_commit": "7d6f745636cef7ee29ab40f7b20274581edd2f8d",
  "patch": "diff --git a/helio b/helio\nindex e6f69f118a1a..944be564ecd4 160000\n--- a/helio\n+++ b/helio\n@@ -1,1 +1,1 @@\n-Subproject commit e6f69f118a1af4d677d0ef8a2da3f0b50fcc7cef\n+Subproject commit 944be564ecd44865a9a057c09b5d4bbf7f6db772\ndiff --git a/src/core/compact_object.cc b/src/core/compact_object.cc\nindex cb884c425a86..846550c2c092 100644\n--- a/src/core/compact_object.cc\n+++ b/src/core/compact_object.cc\n@@ -46,9 +46,15 @@ constexpr XXH64_hash_t kHashSeed = 24061983;\n constexpr size_t kAlignSize = 8u;\n \n // Approximation since does not account for listpacks.\n-size_t QlMAllocSize(quicklist* ql) {\n-  size_t res = ql->len * sizeof(quicklistNode) + znallocx(sizeof(quicklist));\n-  return res + ql->count * 16;  // we account for each member 16 bytes.\n+size_t QlMAllocSize(quicklist* ql, bool slow) {\n+  size_t node_size = ql->len * sizeof(quicklistNode) + znallocx(sizeof(quicklist));\n+  if (slow) {\n+    for (quicklistNode* node = ql->head; node; node = node->next) {\n+      node_size += zmalloc_usable_size(node->entry);\n+    }\n+    return node_size;\n+  }\n+  return node_size + ql->count * 16;  // we account for each member 16 bytes.\n }\n \n inline void FreeObjSet(unsigned encoding, void* ptr, MemoryResource* mr) {\n@@ -291,7 +297,7 @@ static_assert(sizeof(CompactObj) == 18);\n \n namespace detail {\n \n-size_t RobjWrapper::MallocUsed() const {\n+size_t RobjWrapper::MallocUsed(bool slow) const {\n   if (!inner_obj_)\n     return 0;\n \n@@ -301,8 +307,8 @@ size_t RobjWrapper::MallocUsed() const {\n       return InnerObjMallocUsed();\n     case OBJ_LIST:\n       if (encoding_ == OBJ_ENCODING_QUICKLIST)\n-        return QlMAllocSize((quicklist*)inner_obj_);\n-      return ((QList*)inner_obj_)->MallocUsed();\n+        return QlMAllocSize((quicklist*)inner_obj_, slow);\n+      return ((QList*)inner_obj_)->MallocUsed(slow);\n     case OBJ_SET:\n       return MallocUsedSet(encoding_, inner_obj_);\n     case OBJ_HASH:\n@@ -1132,12 +1138,12 @@ void CompactObj::Free() {\n   memset(u_.inline_str, 0, kInlineLen);\n }\n \n-size_t CompactObj::MallocUsed() const {\n+size_t CompactObj::MallocUsed(bool slow) const {\n   if (!HasAllocated())\n     return 0;\n \n   if (taglen_ == ROBJ_TAG) {\n-    return u_.r_obj.MallocUsed();\n+    return u_.r_obj.MallocUsed(slow);\n   }\n \n   if (taglen_ == JSON_TAG) {\ndiff --git a/src/core/compact_object.h b/src/core/compact_object.h\nindex 9ea0fefe817e..910b5ffc1627 100644\n--- a/src/core/compact_object.h\n+++ b/src/core/compact_object.h\n@@ -37,7 +37,7 @@ class RobjWrapper {\n   RobjWrapper() : sz_(0), type_(0), encoding_(0) {\n   }\n \n-  size_t MallocUsed() const;\n+  size_t MallocUsed(bool slow) const;\n \n   uint64_t HashCode() const;\n   bool Equal(const RobjWrapper& ow) const;\n@@ -359,9 +359,9 @@ class CompactObj {\n   // Postcondition: The object is an in-memory string.\n   void Materialize(std::string_view str, bool is_raw);\n \n-  // In case this object a single blob, returns number of bytes allocated on heap\n-  // for that blob. Otherwise returns 0.\n-  size_t MallocUsed() const;\n+  // Returns the approximation of memory used by the object.\n+  // If slow is true, may use more expensive methods to calculate the precise size.\n+  size_t MallocUsed(bool slow = false) const;\n \n   // Resets the object to empty state (string).\n   void Reset();\ndiff --git a/src/core/qlist.cc b/src/core/qlist.cc\nindex 01fa2e93513a..b88568f6f5bd 100644\n--- a/src/core/qlist.cc\n+++ b/src/core/qlist.cc\n@@ -431,10 +431,17 @@ bool QList::Replace(long index, std::string_view elem) {\n   return false;\n }\n \n-size_t QList::MallocUsed() const {\n+size_t QList::MallocUsed(bool slow) const {\n   // Approximation since does not account for listpacks.\n-  size_t res = len_ * sizeof(quicklistNode) + znallocx(sizeof(quicklist));\n-  return res + count_ * 16;  // we account for each member 16 bytes.\n+  size_t node_size = len_ * sizeof(quicklistNode) + znallocx(sizeof(quicklist));\n+  if (slow) {\n+    for (quicklistNode* node = head_; node; node = node->next) {\n+      node_size += zmalloc_usable_size(node->entry);\n+    }\n+    return node_size;\n+  }\n+\n+  return node_size + count_ * 16;  // we account for each member 16 bytes.\n }\n \n void QList::Iterate(IterateFunc cb, long start, long end) const {\ndiff --git a/src/core/qlist.h b/src/core/qlist.h\nindex 19f0058e0110..d69ea9f56106 100644\n--- a/src/core/qlist.h\n+++ b/src/core/qlist.h\n@@ -103,7 +103,7 @@ class QList {\n   // Returns true if item was replaced, false if index is out of range.\n   bool Replace(long index, std::string_view elem);\n \n-  size_t MallocUsed() const;\n+  size_t MallocUsed(bool slow) const;\n \n   void Iterate(IterateFunc cb, long start, long end) const;\n \ndiff --git a/src/server/dfly_main.cc b/src/server/dfly_main.cc\nindex 5caa7cdc1bf9..513243948e01 100644\n--- a/src/server/dfly_main.cc\n+++ b/src/server/dfly_main.cc\n@@ -799,5 +799,9 @@ Usage: dragonfly [FLAGS]\n     unlink(pidfile_path.c_str());\n   }\n \n+  // Returns memory to OS.\n+  // This is a workaround for a bug in mi_malloc that may cause a crash on exit.\n+  mi_collect(true);\n+\n   return res;\n }\ndiff --git a/src/server/memory_cmd.cc b/src/server/memory_cmd.cc\nindex be8d168061ca..00d1cb88d372 100644\n--- a/src/server/memory_cmd.cc\n+++ b/src/server/memory_cmd.cc\n@@ -83,7 +83,8 @@ std::string MallocStatsCb(bool backing, unsigned tid) {\n }\n \n size_t MemoryUsage(PrimeIterator it) {\n-  return it->first.MallocUsed() + it->second.MallocUsed();\n+  size_t key_size = it->first.MallocUsed();\n+  return key_size + it->second.MallocUsed(true);\n }\n \n }  // namespace\n",
  "test_patch": "diff --git a/src/server/dragonfly_test.cc b/src/server/dragonfly_test.cc\nindex 0a1b131b419f..d2c97af93897 100644\n--- a/src/server/dragonfly_test.cc\n+++ b/src/server/dragonfly_test.cc\n@@ -768,6 +768,21 @@ TEST_F(DflyEngineTest, EvalBug2664) {\n   EXPECT_THAT(resp, DoubleArg(42.9));\n }\n \n+TEST_F(DflyEngineTest, MemoryUsage) {\n+  for (unsigned i = 0; i < 1000; ++i) {\n+    Run({\"rpush\", \"l1\", StrCat(\"val\", i)});\n+  }\n+\n+  for (unsigned i = 0; i < 1000; ++i) {\n+    Run({\"rpush\", \"l2\", StrCat(string('a', 200), i)});\n+  }\n+  auto resp = Run({\"memory\", \"usage\", \"l1\"});\n+  EXPECT_GT(*resp.GetInt(), 8000);\n+\n+  resp = Run({\"memory\", \"usage\", \"l2\"});\n+  EXPECT_GT(*resp.GetInt(), 100000);\n+}\n+\n // TODO: to test transactions with a single shard since then all transactions become local.\n // To consider having a parameter in dragonfly engine controlling number of shards\n // unconditionally from number of cpus. TO TEST BLPOP under multi for single/multi argument case.\n",
  "problem_statement": "test failed replication_test.py::test_take_over_counters\ninvestigate https://github.com/dragonflydb/dragonfly/actions/runs/10993785520/job/30521012937\r\n\n",
  "hints_text": "@adiholden do not assign this to @chakaz. It happens during shutdown and I think it's related to the one I am fixing\nwhoops was a hard crash. I did not see the traces \nIt's been a while since we opened this, perhaps it was already resolved. Let's optimistically close it, and reopen if needed.\n@chakaz I am pretty sure it was not, I saw it two week ago again.\nIndeed, also just now:\r\nhttps://github.com/dragonflydb/dragonfly/actions/runs/11763776680/job/32768184396#step:6:1067\nsucceeded to reproduce it. Got this stackl trace file:\r\n```\r\n#0  __pthread_kill_implementation (threadid=279096101982240, signo=signo@entry=6, no_tid=no_tid@entry=0)\r\n    at ./nptl/pthread_kill.c:44\r\n#1  0x0000fdd61f4c7690 in __pthread_kill_internal (signo=6, threadid=<optimized out>) at ./nptl/pthread_kill.c:78\r\n#2  0x0000fdd61f47cb3c in __GI_raise (sig=6) at ../sysdeps/posix/raise.c:26\r\n#3  0x0000b8c7e19c3730 in absl::lts_20240116::RaiseToDefaultHandler (signo=6)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/abseil_cpp-src/absl/debugging/failure_signal_handler.cc:77\r\n#4  0x0000b8c7e19c4268 in absl::lts_20240116::AbslFailureSignalHandler (signo=6, ucontext=0xfdd61fe8ee20)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/abseil_cpp-src/absl/debugging/failure_signal_handler.cc:393\r\n#5  <signal handler called>\r\n#6  __pthread_kill_implementation (threadid=279096101982240, signo=signo@entry=6, no_tid=no_tid@entry=0)\r\n    at ./nptl/pthread_kill.c:44\r\n#7  0x0000fdd61f4c7690 in __pthread_kill_internal (signo=6, threadid=<optimized out>) at ./nptl/pthread_kill.c:78\r\n#8  0x0000fdd61f47cb3c in __GI_raise (sig=sig@entry=6) at ../sysdeps/posix/raise.c:26\r\n#9  0x0000fdd61f467e00 in __GI_abort () at ./stdlib/abort.c:79\r\n#10 0x0000b8c7e19357f4 in glog_internal_namespace_::Mutex::Lock (this=0xb8c7e266fdd0 <google::log_mutex>)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/glog-src/src/base/mutex.h:272\r\n#11 0x0000b8c7e19358c4 in glog_internal_namespace_::MutexLock::MutexLock (this=0xffffeb8061c0,\r\n    mu=0xb8c7e266fdd0 <google::log_mutex>)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/glog-src/src/base/mutex.h:290\r\n#12 0x0000b8c7e1930b28 in google::LogMessage::Flush (this=0xffffeb806268)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/glog-src/src/logging.cc:1779\r\n#13 0x0000b8c7e19308d8 in google::LogMessage::~LogMessage (this=0xffffeb806268, __in_chrg=<optimized out>)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/glog-src/src/logging.cc:1727\r\n#14 0x0000b8c7e1821c0c in util::fb2::(anonymous namespace)::SigAction (signal=15)\r\n    at /home/dev/projects/dragonfly/helio/util/fibers/proactor_base.cc:53\r\n#15 <signal handler called>\r\n#16 0x0000fdd61f526fcc in __GI_madvise () at ../sysdeps/unix/syscall-template.S:120\r\n#17 0x0000b8c7e177d808 in unix_madvise (advice=4, size=size@entry=281474632807847, addr=addr@entry=0x568f8170000)\r\n--Type <RET> for more, q to quit, c to continue without paging--\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/prim/unix/prim.c:188\r\n#18 _mi_prim_decommit (start=start@entry=0x568f8170000, size=size@entry=32047104,\r\n    needs_recommit=needs_recommit@entry=0xffffeb8075a7)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/prim/unix/prim.c:401\r\n#19 0x0000b8c7e1772f14 in mi_os_decommit_ex (addr=addr@entry=0x568f8170000, size=size@entry=32047104,\r\n    needs_recommit=needs_recommit@entry=0xffffeb8075a7, tld_stats=<optimized out>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/os.c:426\r\n#20 0x0000b8c7e1774548 in _mi_os_purge_ex (stats=<optimized out>, allow_reset=true, size=32047104, p=0x568f8170000)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/os.c:476\r\n#21 _mi_os_purge_ex (stats=0xb8c7e26252c8 <tld_main+968>, allow_reset=true, size=32047104, p=0x568f8170000)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/os.c:466\r\n#22 _mi_os_purge (p=0x568f8170000, size=size@entry=32047104, stats=stats@entry=0xb8c7e26252c8 <tld_main+968>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/os.c:490\r\n#23 0x0000b8c7e17789c8 in mi_segment_purge (segment=segment@entry=0x568f8000000, p=p@entry=0x568f8170000 \"\",\r\n    size=size@entry=32047104, stats=stats@entry=0xb8c7e26252c8 <tld_main+968>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/segment.c:522\r\n#24 0x0000b8c7e1779b50 in mi_segment_purge (stats=0xb8c7e26252c8 <tld_main+968>, size=32047104, p=0x568f8170000 \"\",\r\n    segment=0x568f8000000) at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/segment.c:509\r\n#25 mi_segment_try_purge (segment=segment@entry=0x568f8000000, stats=0xb8c7e26252c8 <tld_main+968>, force=true)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/segment.c:592\r\n#26 0x0000b8c7e177b1e8 in mi_segment_try_purge (stats=<optimized out>, force=true, segment=0x568f8000000)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/segment.c:603\r\n#27 0x0000b8c7e176f74c in mi_heap_page_collect (arg2=0x0, arg_collect=<synthetic pointer>, page=0x568f8000948,\r\n    pq=0xb8c7e2624888 <_mi_heap_main+1408>, heap=0xb8c7e2624308 <_mi_heap_main>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/heap.c:101\r\n#28 mi_heap_visit_pages (arg2=0x0, arg1=<synthetic pointer>, fn=<optimized out>,\r\n    heap=0xb8c7e2624308 <_mi_heap_main>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/heap.c:46\r\n--Type <RET> for more, q to quit, c to continue without paging--\r\n#29 mi_heap_collect_ex (heap=0xb8c7e2624308 <_mi_heap_main>, collect=collect@entry=MI_FORCE)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/heap.c:159\r\n#30 0x0000b8c7e176f8a8 in mi_heap_collect (force=force@entry=true, heap=<optimized out>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/heap.c:180\r\n#31 0x0000b8c7e17703f0 in mi_process_done ()\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/init.c:638\r\n#32 mi_process_done () at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/init.c:622\r\n#33 0x0000fdd61f47f228 in __run_exit_handlers (status=0, listp=0xfdd61f5f0670 <__exit_funcs>,\r\n    run_list_atexit=run_list_atexit@entry=true, run_dtors=run_dtors@entry=true) at ./stdlib/exit.c:108\r\n#34 0x0000fdd61f47f30c in __GI_exit (status=<optimized out>) at ./stdlib/exit.c:138\r\n#35 0x0000fdd61f4684c8 in __libc_start_call_main (main=main@entry=0xb8c7e0d0e404 <main(int, char**)>,\r\n    argc=argc@entry=12, argv=argv@entry=0xffffeb8079d8) at ../sysdeps/nptl/libc_start_call_main.h:74\r\n#36 0x0000fdd61f468598 in __libc_start_main_impl (main=0xb8c7e0d0e404 <main(int, char**)>, argc=12,\r\n    argv=0xffffeb8079d8, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>,\r\n    stack_end=<optimized out>) at ../csu/libc-start.c:360\r\n#37 0x0000b8c7e0d094b0 in _start ()\r\n(gdb) bt\r\n#0  __pthread_kill_implementation (threadid=279096101982240, signo=signo@entry=6, no_tid=no_tid@entry=0)\r\n    at ./nptl/pthread_kill.c:44\r\n#1  0x0000fdd61f4c7690 in __pthread_kill_internal (signo=6, threadid=<optimized out>) at ./nptl/pthread_kill.c:78\r\n#2  0x0000fdd61f47cb3c in __GI_raise (sig=6) at ../sysdeps/posix/raise.c:26\r\n#3  0x0000b8c7e19c3730 in absl::lts_20240116::RaiseToDefaultHandler (signo=6)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/abseil_cpp-src/absl/debugging/failure_signal_handler.cc:77\r\n#4  0x0000b8c7e19c4268 in absl::lts_20240116::AbslFailureSignalHandler (signo=6, ucontext=0xfdd61fe8ee20)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/abseil_cpp-src/absl/debugging/failure_signal_handler.cc:393\r\n#5  <signal handler called>\r\n#6  __pthread_kill_implementation (threadid=279096101982240, signo=signo@entry=6, no_tid=no_tid@entry=0)\r\n    at ./nptl/pthread_kill.c:44\r\n#7  0x0000fdd61f4c7690 in __pthread_kill_internal (signo=6, threadid=<optimized out>) at ./nptl/pthread_kill.c:78\r\n#8  0x0000fdd61f47cb3c in __GI_raise (sig=sig@entry=6) at ../sysdeps/posix/raise.c:26\r\n#9  0x0000fdd61f467e00 in __GI_abort () at ./stdlib/abort.c:79\r\n#10 0x0000b8c7e19357f4 in glog_internal_namespace_::Mutex::Lock (this=0xb8c7e266fdd0 <google::log_mutex>)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/glog-src/src/base/mutex.h:272\r\n#11 0x0000b8c7e19358c4 in glog_internal_namespace_::MutexLock::MutexLock (this=0xffffeb8061c0,\r\n    mu=0xb8c7e266fdd0 <google::log_mutex>)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/glog-src/src/base/mutex.h:290\r\n#12 0x0000b8c7e1930b28 in google::LogMessage::Flush (this=0xffffeb806268)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/glog-src/src/logging.cc:1779\r\n#13 0x0000b8c7e19308d8 in google::LogMessage::~LogMessage (this=0xffffeb806268, __in_chrg=<optimized out>)\r\n    at /home/dev/projects/dragonfly/build-dbg/_deps/glog-src/src/logging.cc:1727\r\n#14 0x0000b8c7e1821c0c in util::fb2::(anonymous namespace)::SigAction (signal=15)\r\n    at /home/dev/projects/dragonfly/helio/util/fibers/proactor_base.cc:53\r\n#15 <signal handler called>\r\n#16 0x0000fdd61f526fcc in __GI_madvise () at ../sysdeps/unix/syscall-template.S:120\r\n#17 0x0000b8c7e177d808 in unix_madvise (advice=4, size=size@entry=281474632807847, addr=addr@entry=0x568f8170000)\r\n--Type <RET> for more, q to quit, c to continue without paging--\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/prim/unix/prim.c:188\r\n#18 _mi_prim_decommit (start=start@entry=0x568f8170000, size=size@entry=32047104,\r\n    needs_recommit=needs_recommit@entry=0xffffeb8075a7)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/prim/unix/prim.c:401\r\n#19 0x0000b8c7e1772f14 in mi_os_decommit_ex (addr=addr@entry=0x568f8170000, size=size@entry=32047104,\r\n    needs_recommit=needs_recommit@entry=0xffffeb8075a7, tld_stats=<optimized out>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/os.c:426\r\n#20 0x0000b8c7e1774548 in _mi_os_purge_ex (stats=<optimized out>, allow_reset=true, size=32047104, p=0x568f8170000)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/os.c:476\r\n#21 _mi_os_purge_ex (stats=0xb8c7e26252c8 <tld_main+968>, allow_reset=true, size=32047104, p=0x568f8170000)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/os.c:466\r\n#22 _mi_os_purge (p=0x568f8170000, size=size@entry=32047104, stats=stats@entry=0xb8c7e26252c8 <tld_main+968>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/os.c:490\r\n#23 0x0000b8c7e17789c8 in mi_segment_purge (segment=segment@entry=0x568f8000000, p=p@entry=0x568f8170000 \"\",\r\n    size=size@entry=32047104, stats=stats@entry=0xb8c7e26252c8 <tld_main+968>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/segment.c:522\r\n#24 0x0000b8c7e1779b50 in mi_segment_purge (stats=0xb8c7e26252c8 <tld_main+968>, size=32047104, p=0x568f8170000 \"\",\r\n    segment=0x568f8000000) at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/segment.c:509\r\n#25 mi_segment_try_purge (segment=segment@entry=0x568f8000000, stats=0xb8c7e26252c8 <tld_main+968>, force=true)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/segment.c:592\r\n#26 0x0000b8c7e177b1e8 in mi_segment_try_purge (stats=<optimized out>, force=true, segment=0x568f8000000)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/segment.c:603\r\n#27 0x0000b8c7e176f74c in mi_heap_page_collect (arg2=0x0, arg_collect=<synthetic pointer>, page=0x568f8000948,\r\n    pq=0xb8c7e2624888 <_mi_heap_main+1408>, heap=0xb8c7e2624308 <_mi_heap_main>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/heap.c:101\r\n#28 mi_heap_visit_pages (arg2=0x0, arg1=<synthetic pointer>, fn=<optimized out>,\r\n    heap=0xb8c7e2624308 <_mi_heap_main>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/heap.c:46\r\n--Type <RET> for more, q to quit, c to continue without paging--\r\n#29 mi_heap_collect_ex (heap=0xb8c7e2624308 <_mi_heap_main>, collect=collect@entry=MI_FORCE)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/heap.c:159\r\n#30 0x0000b8c7e176f8a8 in mi_heap_collect (force=force@entry=true, heap=<optimized out>)\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/heap.c:180\r\n#31 0x0000b8c7e17703f0 in mi_process_done ()\r\n    at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/init.c:638\r\n#32 mi_process_done () at /home/dev/projects/dragonfly/build-dbg/third_party/mimalloc/src/init.c:622\r\n#33 0x0000fdd61f47f228 in __run_exit_handlers (status=0, listp=0xfdd61f5f0670 <__exit_funcs>,\r\n    run_list_atexit=run_list_atexit@entry=true, run_dtors=run_dtors@entry=true) at ./stdlib/exit.c:108\r\n#34 0x0000fdd61f47f30c in __GI_exit (status=<optimized out>) at ./stdlib/exit.c:138\r\n#35 0x0000fdd61f4684c8 in __libc_start_call_main (main=main@entry=0xb8c7e0d0e404 <main(int, char**)>,\r\n    argc=argc@entry=12, argv=argv@entry=0xffffeb8079d8) at ../sysdeps/nptl/libc_start_call_main.h:74\r\n#36 0x0000fdd61f468598 in __libc_start_main_impl (main=0xb8c7e0d0e404 <main(int, char**)>, argc=12,\r\n    argv=0xffffeb8079d8, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>,\r\n    stack_end=<optimized out>) at ../csu/libc-start.c:360\r\n#37 0x0000b8c7e0d094b0 in _start ()\r\n```\r\n\r\n\nOpened https://github.com/romange/helio/pull/343/files though this is not the root cause.",
  "created_at": "2024-11-20T19:26:44Z",
  "modified_files": [
    "helio",
    "src/core/compact_object.cc",
    "src/core/compact_object.h",
    "src/core/qlist.cc",
    "src/core/qlist.h",
    "src/server/dfly_main.cc",
    "src/server/memory_cmd.cc"
  ],
  "modified_test_files": [
    "src/server/dragonfly_test.cc"
  ]
}