{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 5386,
  "instance_id": "dragonflydb__dragonfly-5386",
  "issue_numbers": [
    "5383"
  ],
  "base_commit": "04bcb94da9d25cdb18dc0535767afe7b7a2a857c",
  "patch": "diff --git a/src/core/sorted_map.cc b/src/core/sorted_map.cc\nindex 83cc971a577d..90af9b2a6c79 100644\n--- a/src/core/sorted_map.cc\n+++ b/src/core/sorted_map.cc\n@@ -688,6 +688,11 @@ size_t SortedMap::LexCount(const zlexrangespec& range) const {\n   if (score_tree->Size() == 0)\n     return 0;\n \n+  // Ranges that will always be zero - (+inf, anything) or (anything, -inf)\n+  if (range.min == cmaxstring || range.max == cminstring) {\n+    return 0;\n+  }\n+\n   uint32_t min_rank = 0;\n   detail::BPTreePath<ScoreSds> path;\n \n",
  "test_patch": "diff --git a/src/server/zset_family_test.cc b/src/server/zset_family_test.cc\nindex c239f3f21c95..ee32e2c7e9b8 100644\n--- a/src/server/zset_family_test.cc\n+++ b/src/server/zset_family_test.cc\n@@ -1185,6 +1185,18 @@ TEST_F(ZSetFamilyTest, Count) {\n \n   EXPECT_THAT(CheckedInt({\"zcount\", \"key\", \"-inf\", \"+inf\"}), 129);\n   EXPECT_THAT(CheckedInt({\"zlexcount\", \"key\", \"-\", \"+\"}), 129);\n+\n+  // Listpack object\n+  Run({\"ZADD\", \"short\", \"0\", \"A\"});\n+  EXPECT_THAT(CheckedInt({\"ZLEXCOUNT\", \"short\", \"-\", \"-\"}), 0);\n+  EXPECT_THAT(CheckedInt({\"ZLEXCOUNT\", \"short\", \"+\", \"+\"}), 0);\n+  EXPECT_THAT(CheckedInt({\"ZLEXCOUNT\", \"short\", \"+\", \"-\"}), 0);\n+\n+  // Sortedset object\n+  Run({\"ZADD\", \"long\", \"0\", \"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"});\n+  EXPECT_THAT(CheckedInt({\"ZLEXCOUNT\", \"long\", \"-\", \"-\"}), 0);\n+  EXPECT_THAT(CheckedInt({\"ZLEXCOUNT\", \"long\", \"+\", \"+\"}), 0);\n+  EXPECT_THAT(CheckedInt({\"ZLEXCOUNT\", \"long\", \"+\", \"-\"}), 0);\n }\n \n TEST_F(ZSetFamilyTest, RangeLimit) {\n",
  "problem_statement": "zset bugs\n## ZLEXCOUNT returns wrong result\n\nTo reproduce:\n```\nZADD A 0 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nZLEXCOUNT A - -\n```\n\nreturns 1 but should return 0.\n\nwhat's interesting, for shorted items (i.e. `AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`) , it returns 0.\n\n",
  "hints_text": "@romange it looks that you used wrong key (set is defined as `a` not `A`) for second issue (ZRANGEBYSCORE)\n\n```\n127.0.0.1:6379> SET A_SET FOO\nOK\n127.0.0.1:6379> ZRANGEBYSCORE A_SET 0 1\n(error) WRONGTYPE Operation against a key holding the wrong kind of value\n127.0.0.1:6379> ZRANGE A_SET 0.0 1 byscore\n(error) WRONGTYPE Operation against a key holding the wrong kind of value\n127.0.0.1:6379> \n```\n\nIf key is missing it returns empty array (same behavior as redis)\n\n```\n127.0.0.1:6379> ZRANGEBYSCORE MISSING_KEY 0 1\n(empty array)\n127.0.0.1:6379> ZRANGE MISSING_KEY 0.0 1 byscore\n(empty array)\n```\nupdated",
  "created_at": "2025-06-30T11:35:23Z",
  "modified_files": [
    "src/core/sorted_map.cc"
  ],
  "modified_test_files": [
    "src/server/zset_family_test.cc"
  ]
}