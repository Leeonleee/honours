{
  "repo": "dragonflydb/dragonfly",
  "pull_number": 3637,
  "instance_id": "dragonflydb__dragonfly-3637",
  "issue_numbers": [
    "3636"
  ],
  "base_commit": "2c32e5085c1e095e67c613e35f9831e3760a1d6d",
  "patch": "diff --git a/src/server/generic_family.cc b/src/server/generic_family.cc\nindex de42b278a4b9..2e53c492212b 100644\n--- a/src/server/generic_family.cc\n+++ b/src/server/generic_family.cc\n@@ -1184,9 +1184,10 @@ void GenericFamily::Sort(CmdArgList args, ConnectionContext* cntx) {\n                         });\n     } else {\n       std::sort(entries.begin(), entries.end(),\n-                [reversed, &entries](const auto& lhs, const auto& rhs) {\n-                  DCHECK(&rhs < &(*entries.end()) && &rhs >= &(*entries.begin()));\n-                  return bool(lhs.Cmp() < rhs.Cmp()) ^ reversed;\n+                [reversed, &entries](const auto& lhs, const auto& rhs) -> bool {\n+                  DCHECK((&rhs - entries.data()) >= 0);\n+                  DCHECK((&rhs - entries.data()) < int64_t(entries.size()));\n+                  return reversed ? rhs.Cmp() < lhs.Cmp() : lhs.Cmp() < rhs.Cmp();\n                 });\n     }\n \n",
  "test_patch": "diff --git a/src/server/generic_family_test.cc b/src/server/generic_family_test.cc\nindex 4c2406db7182..3aed8bae00c3 100644\n--- a/src/server/generic_family_test.cc\n+++ b/src/server/generic_family_test.cc\n@@ -481,6 +481,15 @@ TEST_F(GenericFamilyTest, Sort) {\n   ;\n }\n \n+TEST_F(GenericFamilyTest, SortBug3636) {\n+  Run({\"RPUSH\", \"foo\", \"1.100000023841858\", \"1.100000023841858\", \"1.100000023841858\", \"-15710\",\n+       \"1.100000023841858\", \"1.100000023841858\", \"1.100000023841858\", \"-15710\", \"-15710\",\n+       \"1.100000023841858\", \"-15710\", \"-15710\", \"-15710\", \"-15710\", \"1.100000023841858\", \"-15710\",\n+       \"-15710\"});\n+  auto resp = Run({\"SORT\", \"foo\", \"desc\", \"alpha\"});\n+  ASSERT_THAT(resp, ArrLen(17));\n+}\n+\n TEST_F(GenericFamilyTest, TimeNoKeys) {\n   auto resp = Run({\"time\"});\n   EXPECT_THAT(resp, ArrLen(2));\n",
  "problem_statement": "crash in SORT\n```\r\n\"RPUSH\" foo \"1.100000023841858\" \"1.100000023841858\" \"1.100000023841858\" \"-15710\" \"1.100000023841858\" \"1.100000023841858\" \"1.100000023841858\" \"-15710\" \"-15710\" \"1.100000023841858\" \"-15710\" \"-15710\" \"-15710\" \"-15710\" \"1.100000023841858\" \"-15710\" \"-15710\"\r\n\"RPUSH\" foo \"-15710\" \"1.100000023841858\" \"-15710\" \"1.100000023841858\" \"1.100000023841858\"\r\n\"RPUSH\" foo \"1.100000023841858\" \"1.100000023841858\"\r\n\"LINSERT\" foo \"BEFORE\" \"1.100000023841858\" \"-15710\"\r\n\"SORT\" foo \"desc\" \"alpha\"\r\n```\n",
  "hints_text": "",
  "created_at": "2024-09-03T10:55:10Z",
  "modified_files": [
    "src/server/generic_family.cc"
  ],
  "modified_test_files": [
    "src/server/generic_family_test.cc"
  ]
}